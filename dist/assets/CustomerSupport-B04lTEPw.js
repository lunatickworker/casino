import{r as a,j as e}from"./react-core-CwM-CeLv.js";import{s as r,I as $,S as M,p as B,q as F,r as K,t as j,m as O,C as H,e as P,B as C,i as b,L as l}from"./index-Cjgf7-0D.js";import{T as U}from"./textarea-a-twJe9s.js";import{A as V,f as z,a as W,b as G,c as J,d as Q}from"./AdminDialog-BhDtprfW.js";import{k as o}from"./vendor-CQn7sZ7L.js";import{C as X,K as Y,c as w,s as Z,an as ee}from"./lucide-icons-D2Y5yybo.js";import"./radix-ui-SX2QAG6c.js";import"./supabase-r6ABpEO8.js";function de({user:x}){const[D,y]=a.useState(!0),[f,q]=a.useState([]),[m,T]=a.useState("all"),[n,k]=a.useState(""),[i,N]=a.useState(null),[h,p]=a.useState(""),[A,g]=a.useState(!1);a.useEffect(()=>{const s=r.channel("customer-messages-realtime").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`receiver_id=eq.${x.id}`},async t=>{if(console.log("ğŸ”” ìƒˆ ë¬¸ì˜ ë„ì°©:",t),t.new.sender_type==="user"&&!t.new.parent_id){const{data:u}=await r.from("users").select("username").eq("id",t.new.sender_id).single(),v=u?.username||"ì‚¬ìš©ì",d=t.new.subject.replace(/^\[.+?\]\s*/,"");o.info("ìƒˆë¡œìš´ ë¬¸ì˜ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤",{description:`${v}: ${d}`,duration:5e3})}c()}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages"},t=>{console.log("ğŸ”” ë©”ì‹œì§€ ì—…ë°ì´íŠ¸:",t),c()}).subscribe();return()=>{r.removeChannel(s)}},[x.id]);const c=async()=>{try{y(!0);let s=r.from("messages").select("*").eq("receiver_type","partner").eq("receiver_id",x.id).eq("sender_type","user").is("parent_id",null);m!=="all"&&(s=s.eq("status",m)),n&&(s=s.or(`subject.ilike.%${n}%,content.ilike.%${n}%`));const{data:t,error:u}=await s.order("created_at",{ascending:!1});if(u)throw u;const v=await Promise.all((t||[]).map(async d=>{const{data:L}=await r.from("messages").select("*").eq("parent_id",d.id).order("created_at",{ascending:!0}),{data:I}=await r.from("users").select("username").eq("id",d.sender_id).single();return{...d,sender_username:I?.username||"ì•Œ ìˆ˜ ì—†ìŒ",replies:L||[]}}));q(v)}catch(s){console.error("ë©”ì‹œì§€ ì¡°íšŒ ì˜¤ë¥˜:",s),o.error("ë¬¸ì˜ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}finally{y(!1)}},E=async s=>{try{const{error:t}=await r.from("messages").update({status:"read",read_at:new Date().toISOString()}).eq("id",s);if(t)throw t}catch(t){console.error("ì½ìŒ ì²˜ë¦¬ ì˜¤ë¥˜:",t)}},R=async()=>{if(!i||!h.trim()){o.error("ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");return}try{const{error:s}=await r.from("messages").insert([{sender_type:"partner",sender_id:x.id,receiver_type:"user",receiver_id:i.sender_id,subject:`Re: ${i.subject}`,content:h.trim(),message_type:"normal",status:"unread",parent_id:i.id}]);if(s)throw s;const{error:t}=await r.from("messages").update({status:"replied"}).eq("id",i.id);if(t)throw t;o.success("ë‹µë³€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."),g(!1),p(""),N(null),c()}catch(s){console.error("ë‹µë³€ ë“±ë¡ ì˜¤ë¥˜:",s),o.error("ë‹µë³€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}};a.useEffect(()=>{c()},[m]),a.useEffect(()=>{const s=setTimeout(()=>{n!==void 0&&c()},300);return()=>clearTimeout(s)},[n]);const S=s=>{const t={unread:{label:"ë¯¸í™•ì¸",color:"bg-yellow-500/20 text-yellow-400 border-yellow-500/30"},read:{label:"í™•ì¸",color:"bg-blue-500/20 text-blue-400 border-blue-500/30"},replied:{label:"ë‹µë³€ì™„ë£Œ",color:"bg-green-500/20 text-green-400 border-green-500/30"}}[s]||{label:s,color:""};return e.jsx(C,{variant:"outline",className:t.color,children:t.label})},_=s=>{const t=s.match(/^\[(.+?)\]/);return t?t[1]:"ì¼ë°˜"};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-slate-100",children:"ê³ ê°ì„¼í„°"}),e.jsx("p",{className:"text-sm text-slate-400",children:"ì‚¬ìš©ì ë¬¸ì˜ë¥¼ í™•ì¸í•˜ê³  ë‹µë³€í•©ë‹ˆë‹¤."})]})}),e.jsxs("div",{className:"glass-card rounded-xl p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-6 pb-4 border-b border-slate-700/50",children:e.jsxs("div",{children:[e.jsxs("h2",{className:"text-slate-100 flex items-center gap-2",children:[e.jsx(X,{className:"h-5 w-5 text-blue-400"}),"ê³ ê° ë¬¸ì˜ ê´€ë¦¬"]}),e.jsxs("p",{className:"text-sm text-slate-400 mt-1",children:["ì´ ",f.length,"ê±´ì˜ ë¬¸ì˜"]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsx("div",{className:"flex-1 min-w-[200px]",children:e.jsxs("div",{className:"relative",children:[e.jsx(Y,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 h-4 w-4"}),e.jsx($,{placeholder:"ì œëª©, ë‚´ìš©ìœ¼ë¡œ ê²€ìƒ‰...",value:n,onChange:s=>k(s.target.value),className:"pl-9 input-premium"})]})}),e.jsxs(M,{value:m,onValueChange:T,children:[e.jsx(B,{className:"w-[140px]",children:e.jsx(F,{})}),e.jsxs(K,{children:[e.jsx(j,{value:"all",children:"ì „ì²´ ìƒíƒœ"}),e.jsx(j,{value:"unread",children:"ë¯¸í™•ì¸"}),e.jsx(j,{value:"read",children:"í™•ì¸"}),e.jsx(j,{value:"replied",children:"ë‹µë³€ì™„ë£Œ"})]})]})]}),D?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(O,{})}):f.length===0?e.jsxs("div",{className:"text-center py-12 text-slate-400",children:[e.jsx(w,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"ë¬¸ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤."})]}):e.jsx("div",{className:"space-y-3",children:f.map(s=>e.jsx(H,{className:"bg-slate-800/50 border-slate-700 hover:bg-slate-800/70 transition-colors",children:e.jsx(P,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(C,{variant:"secondary",className:"text-xs",children:_(s.subject)}),S(s.status),e.jsx("span",{className:"text-xs text-slate-500",children:new Date(s.created_at).toLocaleString("ko-KR")})]}),e.jsx("h3",{className:"text-slate-100",children:s.subject.replace(/^\[.+?\]\s*/,"")}),e.jsx("p",{className:"text-sm text-slate-400 line-clamp-2",children:s.content}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-500",children:[e.jsx(Z,{className:"h-3 w-3"}),e.jsx("span",{children:s.sender_username}),s.replies&&s.replies.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"mx-1",children:"â€¢"}),e.jsx(w,{className:"h-3 w-3"}),e.jsxs("span",{children:["ë‹µë³€ ",s.replies.length,"ê°œ"]})]})]})]}),e.jsxs(V,{open:A&&i?.id===s.id,onOpenChange:t=>{g(t),t?(N(s),p(""),s.status==="unread"&&E(s.id)):(N(null),p(""))},children:[e.jsx(z,{asChild:!0,children:e.jsxs(b,{size:"sm",variant:"outline",className:"shrink-0",children:[e.jsx(w,{className:"h-4 w-4 mr-2"}),s.replies&&s.replies.length>0?"ë‹µë³€ë³´ê¸°":"ë‹µë³€í•˜ê¸°"]})}),e.jsxs(W,{className:"max-w-3xl max-h-[80vh] overflow-y-auto",children:[e.jsxs(G,{children:[e.jsx(J,{children:"ë¬¸ì˜ ìƒì„¸ ë° ë‹µë³€"}),e.jsx(Q,{children:"ë¬¸ì˜ ë‚´ìš©ì„ í™•ì¸í•˜ê³  ë‹µë³€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx(l,{className:"text-slate-400",children:"ì‘ì„±ì"}),e.jsx("p",{className:"text-slate-100",children:s.sender_username})]}),e.jsxs("div",{children:[e.jsx(l,{className:"text-slate-400",children:"ì‘ì„±ì¼ì‹œ"}),e.jsx("p",{className:"text-slate-100",children:new Date(s.created_at).toLocaleString("ko-KR")})]}),e.jsxs("div",{children:[e.jsx(l,{className:"text-slate-400",children:"ë¶„ë¥˜"}),e.jsx("p",{className:"text-slate-100",children:_(s.subject)})]}),e.jsxs("div",{children:[e.jsx(l,{className:"text-slate-400",children:"ìƒíƒœ"}),e.jsx("div",{className:"mt-1",children:S(s.status)})]})]}),e.jsxs("div",{children:[e.jsx(l,{className:"text-slate-400",children:"ì œëª©"}),e.jsx("p",{className:"text-slate-100 mt-1",children:s.subject})]}),e.jsxs("div",{children:[e.jsx(l,{className:"text-slate-400",children:"ë¬¸ì˜ ë‚´ìš©"}),e.jsx("div",{className:"p-4 bg-slate-900/50 border border-slate-700 rounded-lg mt-2",children:e.jsx("p",{className:"text-sm text-slate-200 whitespace-pre-wrap",children:s.content})})]}),s.replies&&s.replies.length>0&&e.jsxs("div",{children:[e.jsx(l,{className:"text-slate-400",children:"ë‹µë³€ ë‚´ì—­"}),e.jsx("div",{className:"space-y-2 mt-2",children:s.replies.map(t=>e.jsxs("div",{className:"p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg",children:[e.jsx("p",{className:"text-sm text-slate-200 whitespace-pre-wrap",children:t.content}),e.jsx("div",{className:"mt-2 text-xs text-slate-500",children:new Date(t.created_at).toLocaleString("ko-KR")})]},t.id))})]}),e.jsxs("div",{children:[e.jsx(l,{htmlFor:"response",className:"text-slate-400",children:s.replies&&s.replies.length>0?"ì¶”ê°€ ë‹µë³€":"ë‹µë³€ ì‘ì„±"}),e.jsx(U,{id:"response",placeholder:"ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...",value:h,onChange:t=>p(t.target.value),rows:5,className:"mt-2"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(b,{variant:"outline",onClick:()=>g(!1),children:"ì·¨ì†Œ"}),e.jsxs(b,{onClick:R,disabled:!h.trim(),children:[e.jsx(ee,{className:"h-4 w-4 mr-2"}),"ë‹µë³€ ë“±ë¡"]})]})]})]})]})]})})},s.id))})]})]})]})}export{de as CustomerSupport,de as default};
