import{k as re,ax as le,r,s as m,t as n,j as e,C as q,a as R,b as W,d as M,e as P,a7 as K,a8 as z,E as u,I as g,w as j,S as ne,x as ce,y as ie,z as oe,D as de,Q as me,B as he,az as xe,ay as ue,R as be}from"./index-DHLZKrSC.js";import{T as pe}from"./textarea-D3JOUlRQ.js";import{D as ge,f as je,a as we,b as fe,c as Ne,d as ye}from"./dialog-HEtsMRxu.js";import{T as O}from"./triangle-alert-CDjjtVAU.js";import{C as ve}from"./circle-alert-CfjAz5vG.js";import{C as _e}from"./clock-DJz0fDvN.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=[["path",{d:"M5 12h14",key:"1ays0h"}]],Q=re("minus",Ce);function Ee({user:t,onRouteChange:Se}){const{sendMessage:U}=le(),[b,w]=r.useState(""),[o,S]=r.useState(""),[h,k]=r.useState(""),[d,D]=r.useState(""),[f,I]=r.useState(""),[p,T]=r.useState(""),[B,F]=r.useState(!1),[H,V]=r.useState([]),[X,G]=r.useState(!0),[x,J]=r.useState(0),[c,E]=r.useState(!1),[Y,N]=r.useState(!1),[Z]=r.useState([5e4,1e5,3e5,5e5,1e6]),ee=["국민은행","신한은행","우리은행","KB국민은행","KEB하나은행","농협은행","기업은행","새마을금고","신협","우체국","카카오뱅크","토스뱅크","케이뱅크"],y=async()=>{try{const{data:s,error:a}=await m.from("transactions").select("*").eq("user_id",t.id).eq("transaction_type","withdrawal").in("status",["pending","approved"]).limit(1);if(a)throw a;s&&s.length>0?(E(!0),n.warning("진행 중인 출금 신청이 있어 새로운 출금을 신청할 수 없습니다.")):E(!1)}catch(s){console.error("출금 상태 확인 오류:",s)}},v=async()=>{try{const{data:s,error:a}=await m.from("transactions").select("*").eq("user_id",t.id).eq("transaction_type","withdrawal").order("created_at",{ascending:!1}).limit(10);if(a)throw a;V(s||[])}catch(s){console.error("출금 내역 조회 오류:",s),n.error("출금 내역을 불러오는데 실패했습니다.")}finally{G(!1)}},_=async()=>{try{const{data:s,error:a}=await m.from("users").select("balance").eq("id",t.id).single();if(a)throw a;J(parseFloat(s.balance)||0)}catch(s){console.error("잔고 조회 오류:",s)}},se=async()=>{if(!b||!o||!h||!d||!p){n.error("모든 필수 항목을 입력해주세요.");return}const s=parseFloat(b);if(s<1e4){n.error("최소 출금 금액은 10,000원입니다.");return}if(await _(),s>x){n.error(`출금 가능 금액이 부족합니다.
현재 잔고: ${x.toLocaleString()}원`);return}F(!0);try{const{data:a,error:l}=await m.rpc("user_login",{p_username:t.username,p_password:p});if(l||!a||a.length===0)throw new Error("비밀번호가 올바르지 않습니다.");const $={user_id:t.id,partner_id:t.referrer_id||null,transaction_type:"withdrawal",amount:s,status:"pending",balance_before:x,balance_after:x,bank_name:o,bank_account:h,bank_holder:d,memo:f||null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};console.log("💸 출금 신청 데이터:",{...$,user_info:{id:t.id,username:t.username,referrer_id:t.referrer_id}});const{data:C,error:L}=await m.from("transactions").insert([$]).select().single();if(L)throw L;await U("withdrawal_request",{transaction_id:C.id,user_id:t.id,username:t.username,nickname:t.nickname,amount:s,bank_name:o,bank_account:h,bank_holder:d,memo:f||null,subject:`${t.nickname}님의 출금 신청`,reference_type:"transaction",reference_id:C.id},3)&&console.log("✅ 출금 요청 알림이 관리자에게 전송되었습니다."),await m.from("activity_logs").insert([{actor_type:"user",actor_id:t.id,action:"withdrawal_request",target_type:"transaction",target_id:C.id,details:{amount:s,bank_name:o,bank_holder:d}}]),n.success(`출금 신청이 완료되었습니다.
관리자 승인 후 계좌로 송금됩니다.`,{duration:4e3}),w(""),S(""),k(""),D(""),I(""),T(""),N(!1),await Promise.all([v(),y()])}catch(a){console.error("❌ 출금 신청 오류:",a),n.error(a.message||"출금 신청 중 오류가 발생했습니다.")}finally{F(!1)}},ae=s=>{switch(s){case"pending":return{color:"bg-yellow-500",textColor:"text-yellow-400",icon:_e,label:"승인대기"};case"approved":return{color:"bg-blue-500",textColor:"text-blue-400",icon:be,label:"처리중"};case"completed":return{color:"bg-green-500",textColor:"text-green-400",icon:ue,label:"완료"};case"rejected":return{color:"bg-red-500",textColor:"text-red-400",icon:xe,label:"거절"};default:return{color:"bg-gray-500",textColor:"text-slate-400",icon:ve,label:"알 수 없음"}}},i=s=>new Intl.NumberFormat("ko-KR").format(s),te=s=>new Date(s).toLocaleString("ko-KR"),A=parseFloat(b)||0;return r.useEffect(()=>{y(),v(),_();const s=m.channel(`withdrawal_updates_${t.id}`).on("postgres_changes",{event:"*",schema:"public",table:"transactions",filter:`user_id=eq.${t.id}`},a=>{if(console.log("🔄 출금 상태 업데이트 수신:",a),a.eventType==="UPDATE"||a.eventType==="INSERT"){const l=a.new;l.transaction_type==="withdrawal"&&(v(),y(),l.status==="completed"?(_(),n.success(`출금이 완료되었습니다!
금액: ₩${i(l.amount)}`,{duration:5e3})):l.status==="rejected"?n.error(`출금 신청이 거절되었습니다.
금액: ₩${i(l.amount)}`,{duration:5e3}):l.status==="approved"&&n.info(`출금이 승인되었습니다. 처리 중입니다.
금액: ₩${i(l.amount)}`,{duration:4e3}))}}).subscribe();return()=>{s.unsubscribe()}},[t.id]),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"출금 신청"}),e.jsx("p",{className:"text-slate-400 mt-1",children:"안전하고 빠른 출금 서비스를 제공합니다"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-slate-400",children:"현재 잔고"}),e.jsxs("p",{className:"text-xl font-bold text-green-400",children:["₩",i(x)]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(q,{className:"bg-slate-800/50 border-slate-700",children:[e.jsxs(R,{children:[e.jsxs(W,{className:"text-white flex items-center gap-2",children:[e.jsx(Q,{className:"w-5 h-5"}),"출금 신청"]}),e.jsx(M,{className:"text-slate-400",children:"출금할 금액과 계좌 정보를 입력하세요"})]}),e.jsxs(P,{className:"space-y-4",children:[c&&e.jsxs(K,{className:"border-yellow-600 bg-yellow-900/20",children:[e.jsx(O,{className:"h-4 w-4 text-yellow-400"}),e.jsx(z,{className:"text-yellow-300",children:"진행 중인 출금 신청이 있어 새로운 출금을 신청할 수 없습니다."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(u,{htmlFor:"amount",className:"text-slate-300",children:"출금 금액 *"}),e.jsx(g,{id:"amount",type:"number",placeholder:"출금할 금액을 입력하세요",value:b,onChange:s=>w(s.target.value),className:"bg-slate-700/50 border-slate-600 text-white",disabled:c}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:Z.map(s=>e.jsx(j,{variant:"outline",size:"sm",onClick:()=>w(s.toString()),className:"text-xs border-slate-600 text-slate-300 hover:bg-slate-700",disabled:c,children:i(s)},s))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"bank",className:"text-slate-300",children:"은행 선택 *"}),e.jsxs(ne,{value:o,onValueChange:S,disabled:c,children:[e.jsx(ce,{className:"bg-slate-700/50 border-slate-600 text-white",children:e.jsx(ie,{placeholder:"은행을 선택하세요"})}),e.jsx(oe,{className:"bg-slate-800 border-slate-700",children:ee.map(s=>e.jsx(de,{value:s,className:"text-white",children:s},s))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"accountNumber",className:"text-slate-300",children:"계좌번호 *"}),e.jsx(g,{id:"accountNumber",placeholder:"'-' 없이 숫자만 입력",value:h,onChange:s=>k(s.target.value.replace(/[^0-9]/g,"")),className:"bg-slate-700/50 border-slate-600 text-white",disabled:c})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(u,{htmlFor:"accountHolder",className:"text-slate-300",children:"예금주명 *"}),e.jsx(g,{id:"accountHolder",placeholder:"계좌의 예금주명을 입력하세요",value:d,onChange:s=>D(s.target.value),className:"bg-slate-700/50 border-slate-600 text-white",disabled:c})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(u,{htmlFor:"memo",className:"text-slate-300",children:"메모 (선택)"}),e.jsx(pe,{id:"memo",placeholder:"추가 요청사항이 있으시면 입력하세요",value:f,onChange:s=>I(s.target.value),className:"bg-slate-700/50 border-slate-600 text-white",rows:3,disabled:c})]})]}),e.jsxs(K,{className:"border-red-600 bg-red-900/20",children:[e.jsx(O,{className:"h-4 w-4 text-red-400"}),e.jsx(z,{className:"text-red-300",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{children:"• 최소 출금액: 10,000원"}),e.jsx("p",{children:"• 출금 신청 시 게임 이용이 제한됩니다"}),e.jsx("p",{children:"• 예금주명은 회원 본인과 일치해야 합니다"}),e.jsx("p",{children:"• 출금 처리 시간: 평일 기준 1-3시간"})]})})]}),e.jsxs(ge,{open:Y,onOpenChange:N,children:[e.jsx(je,{asChild:!0,children:e.jsxs(j,{disabled:c||!b||!o||!h||!d,className:"w-full bg-blue-600 hover:bg-blue-700 text-white py-3",children:[e.jsx(Q,{className:"w-4 h-4 mr-2"}),"출금 신청하기"]})}),e.jsxs(we,{className:"bg-slate-800 border-slate-700 text-white",children:[e.jsxs(fe,{children:[e.jsx(Ne,{children:"출금 신청 확인"}),e.jsx(ye,{className:"text-slate-400",children:"출금 신청 정보를 확인하고 최종 승인해주세요."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 bg-slate-700/50 rounded-lg space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"출금 금액:"}),e.jsxs("span",{children:["₩",i(A)]})]}),e.jsxs("div",{className:"flex justify-between text-sm text-slate-400",children:[e.jsx("span",{children:"출금 후 잔액:"}),e.jsxs("span",{children:["₩",i(x-A)]})]})]}),e.jsxs("div",{className:"p-4 bg-slate-700/50 rounded-lg",children:[e.jsx("p",{className:"text-sm text-slate-300",children:"출금 계좌 정보"}),e.jsxs("p",{children:[o," ",h]}),e.jsxs("p",{children:["예금주: ",d]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"confirmPassword",className:"text-slate-300",children:"비밀번호 확인 *"}),e.jsx(g,{id:"confirmPassword",type:"password",placeholder:"비밀번호를 입력하세요",value:p,onChange:s=>T(s.target.value),className:"bg-slate-700/50 border-slate-600 text-white"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{variant:"outline",onClick:()=>N(!1),className:"flex-1",children:"취소"}),e.jsx(j,{onClick:se,disabled:B||!p,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:B?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"처리중..."]}):"출금 신청"})]})]})]})]})]})]}),e.jsxs(q,{className:"bg-slate-800/50 border-slate-700",children:[e.jsxs(R,{children:[e.jsxs(W,{className:"text-white flex items-center gap-2",children:[e.jsx(me,{className:"w-5 h-5"}),"최근 출금 내역"]}),e.jsx(M,{className:"text-slate-400",children:"최근 10개의 출금 신청 내역을 확인할 수 있습니다"})]}),e.jsx(P,{children:X?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-400"})}):H.length===0?e.jsx("div",{className:"text-center py-8 text-slate-400",children:"출금 내역이 없습니다"}):e.jsx("div",{className:"space-y-3",children:H.map(s=>{const a=ae(s.status),l=a.icon;return e.jsxs("div",{className:"p-4 bg-slate-700/30 rounded-lg border border-slate-600/50",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(l,{className:`w-4 h-4 ${a.textColor}`}),e.jsx(he,{variant:"outline",className:`${a.color} text-white border-none`,children:a.label})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-semibold text-white",children:["₩",i(s.amount)]}),e.jsx("p",{className:"text-xs text-slate-400",children:te(s.created_at)})]})]}),e.jsxs("div",{className:"text-sm text-slate-400 space-y-1",children:[e.jsxs("p",{children:[s.bank_name," ",s.bank_account]}),e.jsxs("p",{children:["예금주: ",s.bank_holder]}),s.memo&&e.jsx("p",{className:"text-slate-500",children:s.memo})]})]},s.id)})})})]})]})]})}export{Ee as UserWithdraw};
