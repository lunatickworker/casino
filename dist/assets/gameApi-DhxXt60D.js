const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DBZ0Cn5g.js","assets/index-lVTNIJQg.css"])))=>i.map(i=>d[i]);
import{k as T,s as p,a2 as x,_ as U}from"./index-DBZ0Cn5g.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const z=[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]],K=T("star",z);async function I(){const{data:r,error:n}=await p.from("game_providers").select("*").eq("status","active").order("type",{ascending:!0}).order("name",{ascending:!0});if(n)throw console.error("제공사 조회 오류:",n),n;console.log(`🎮 제공사 조회 결과: ${r?.length||0}개`);const i=r?.filter(t=>t.type==="slot").length||0,e=r?.filter(t=>t.type==="casino").length||0;if(console.log(`  📊 슬롯: ${i}개, 카지노: ${e}개`),i<30||e<10){console.log("⚠️ 제공사 데이터가 부족합니다. 자동 초기화를 시도합니다..."),await O();const{data:t,error:l}=await p.from("game_providers").select("*").eq("status","active").order("type",{ascending:!0}).order("name",{ascending:!0});if(!l&&t){const a=t.filter(s=>s.type==="slot").length,d=t.filter(s=>s.type==="casino").length;return console.log(`✅ 재조회 결과 - 슬롯: ${a}개, 카지노: ${d}개`),t}}return r||[]}async function L(r,n){let i,e;if(typeof r=="string"?(i=r,e=n||{}):e=r||{},console.log("🔍 getGames 호출:",{partnerId:i,filters:e}),i){const{data:s,error:m}=await p.rpc("get_games_with_partner_settings",{p_partner_id:i,p_game_type:e?.type||null,p_provider_id:e?.provider_id?parseInt(e.provider_id.toString()):null,p_search_term:e?.search||null,p_limit:1e4,p_offset:0});if(m)throw console.error("파트너별 게임 목록 조회 오류:",m),m;return console.log("✅ 파트너별 게임 조회 완료:",s?.length||0),(s||[]).map(c=>({id:c.id,provider_id:c.provider_id,name:c.name,type:c.type,status:c.custom_status||c.status,image_url:c.image_url,demo_available:c.demo_available,is_featured:c.custom_is_featured!==null&&c.custom_is_featured!==void 0?c.custom_is_featured:c.is_featured,priority:c.custom_priority!==null&&c.custom_priority!==void 0?c.custom_priority:c.priority,rtp:c.rtp,play_count:c.play_count,created_at:c.created_at,updated_at:c.updated_at,provider_name:c.provider_name}))}let t=p.from("games").select(`
      id,
      provider_id,
      name,
      type,
      status,
      image_url,
      demo_available,
      is_featured,
      priority,
      rtp,
      play_count,
      created_at,
      updated_at,
      game_providers!inner(
        id,
        name,
        type
      )
    `);e?.type&&(t=t.eq("type",e.type),t=t.eq("game_providers.type",e.type),console.log("🔍 타입 필터 적용:",e.type)),e?.provider_id&&(t=t.eq("provider_id",e.provider_id),console.log("🔍 제공사 필터 적용:",e.provider_id)),e?.search&&(t=t.ilike("name",`%${e.search}%`),console.log("🔍 검색 필터 적용:",e.search)),e?.status&&(t=t.eq("status",e.status),console.log("🔍 상태 필터 적용:",e.status)),e?.type==="casino"?t=t.order("provider_id"):t=t.order("name");const{data:l,error:a}=await t;if(a)throw console.error("게임 조회 오류:",a),a;console.log(`🔍 DB에서 조회된 ${e?.type||"전체"} 게임:`,{총개수:l?.length||0,샘플:l?.slice(0,3)});const d=(l||[]).map(s=>({id:s.id,provider_id:s.provider_id,name:s.name,type:s.type,status:s.status,image_url:s.image_url,demo_available:s.demo_available,is_featured:s.is_featured||!1,priority:s.priority||0,rtp:s.rtp,play_count:s.play_count||0,created_at:s.created_at,updated_at:s.updated_at,provider_name:s.game_providers?.name||"알 수 없음"}));return console.log(`🔍 최종 ${e?.type||"전체"} 게임 수:`,d.length),d}async function N(r,n){const{error:i}=await p.from("games").update({status:n,updated_at:new Date().toISOString()}).eq("id",r);if(i)throw console.error("게임 상태 업데이트 오류:",i),i}async function C(r,n){console.log(`🚀 Provider ${r} 동기화 시작`);const i=Date.now();let e=[];if(n&&n.length>0)e=n,console.log(`📥 제공된 게임 데이터 사용 - 총 ${e.length}개 게임`);else{console.log(`📡 Provider ${r} API 호출 시작`);const{investApi:_}=await U(async()=>{const{investApi:o}=await import("./index-DBZ0Cn5g.js").then(u=>u.a$);return{investApi:o}},__vite__mapDeps([0,1])),{data:g,error:f}=await p.from("partners").select("opcode, secret_key").eq("level",1).order("created_at",{ascending:!0}).limit(1).maybeSingle();if(f||!g)throw console.error("❌ 시스템 관리자 정보 조회 실패:",f),new Error("시스템 관리자 정보를 찾을 수 없습니다.");try{const o=await _.getGameList(g.opcode,r,g.secret_key);if(o.error)if(console.error(`❌ Provider ${r} API 호출 실패:`,o.error),o.error.includes("게임 목록이 없습니다")||o.error.includes("지원하지 않는")||o.error.includes("잘못된 signature")||o.error.includes("provider not found")||o.status===404||o.status===400)console.log(`⚠️ Provider ${r}는 게임 리스트가 없거나 지원하지 않는 제공사입니다.`),e=[];else throw new Error(o.error);else if(o.data?.RESULT===!0&&Array.isArray(o.data?.DATA))e=o.data.DATA,console.log(`✅ Provider ${r} API 응답: ${e.length}개 게임 (이미 image_url 정규화됨)`);else if(o.data?.RESULT===!1){const u=o.data?.message||"알 수 없는 오류";if(console.log(`⚠️ Provider ${r} API 응답: 게임 리스트 없음 - ${u}`),u.includes("게임이 없습니다")||u.includes("no games")||u.includes("empty")||u.includes("없음"))e=[];else throw new Error(`API 오류: ${u}`)}else console.log(`⚠️ Provider ${r} 예상치 못한 응답 형식:`,o.data),e=[]}catch(o){console.error(`❌ Provider ${r} API 호출 중 오류:`,o),e=[]}}console.log(`📊 동기화할 게임 수: ${e.length}개`);const{data:t,error:l}=await p.from("game_providers").select("type").eq("id",r).maybeSingle();if(l||!t)throw console.error("제공사 조회 오류:",l),new Error(`제공사(ID: ${r}) 정보를 찾을 수 없습니다.`);const a=t.type,{data:d,error:s}=await p.from("games").select("id").eq("provider_id",r);if(s)throw console.error("기존 게임 조회 오류:",s),s;const m=new Set(d?.map(_=>_.id)||[]);console.log(`📊 기존 게임 ${m.size}개 확인됨`);const c=[],P=new Date().toISOString(),A=100;for(let _=0;_<e.length;_+=A){const f=e.slice(_,_+A).map((o,u)=>{const D=parseInt(o.id||o.game_id||o.gameId||o.ID);if(!D||isNaN(D))return null;let b="";o.game_title&&typeof o.game_title=="string"&&o.game_title.trim()?b=o.game_title.trim():o.name&&typeof o.name=="string"&&o.name.trim()?b=o.name.trim():o.game_name&&typeof o.game_name=="string"&&o.game_name.trim()?b=o.game_name.trim():o.gameName&&typeof o.gameName=="string"&&o.gameName.trim()?b=o.gameName.trim():o.title&&typeof o.title=="string"&&o.title.trim()?b=o.title.trim():b=`Game ${D}`;const $=o.image_url||null,k=!!(o.demo_available||o.demoAvailable||o.demo);return{id:D,provider_id:r,name:b,type:a,status:"visible",image_url:$?String($):null,demo_available:k,created_at:P,updated_at:P,isExisting:m.has(D)}}).filter(o=>o!==null);c.push(...f)}console.log(`✅ 처리된 게임 수: ${c.length}개`);const h=c.filter(_=>!_.isExisting),y=c.filter(_=>_.isExisting);console.log(`📈 신규 게임: ${h.length}개, 업데이트 대상: ${y.length}개`);let E=0,w=0;if(h.length>0){const _=h.map(({isExisting:f,...o})=>o),g=500;for(let f=0;f<_.length;f+=g){const o=_.slice(f,f+g),{error:u}=await p.from("games").insert(o);if(u)throw console.error(`게임 추가 오류 (청크 ${Math.floor(f/g)+1}):`,u),u}E=h.length,console.log(`✅ ${E}개 신규 게임 추가 완료`)}if(y.length>0){for(let g=0;g<y.length;g+=100){const o=y.slice(g,g+100).map(async D=>{const{isExisting:b,...$}=D,{error:k}=await p.from("games").update({name:$.name,image_url:$.image_url,demo_available:$.demo_available,updated_at:$.updated_at}).eq("id",$.id).eq("provider_id",r);return k?(console.error(`게임 ${$.id} 업데이트 오류:`,k),!1):!0}),u=await Promise.all(o);w+=u.filter(Boolean).length}console.log(`✅ ${w}개 기존 게임 업데이트 완료`)}const S=((Date.now()-i)/1e3).toFixed(1),G={newGames:E,updatedGames:w,totalGames:c.length};return console.log(`🎯 Provider ${r} 동기화 완료 (${S}초):`,G),G}async function O(){console.log("🔧 게임 제공사 데이터 초기화 시작...");const n=[{id:1,name:"마이크로게이밍",type:"slot"},{id:17,name:"플레이앤고",type:"slot"},{id:20,name:"CQ9 게이밍",type:"slot"},{id:21,name:"제네시스 게이밍",type:"slot"},{id:22,name:"하바네로",type:"slot"},{id:23,name:"게임아트",type:"slot"},{id:27,name:"플레이텍",type:"slot"},{id:38,name:"블루프린트",type:"slot"},{id:39,name:"부운고",type:"slot"},{id:40,name:"드라군소프트",type:"slot"},{id:41,name:"엘크 스튜디오",type:"slot"},{id:47,name:"드림테크",type:"slot"},{id:51,name:"칼람바 게임즈",type:"slot"},{id:52,name:"모빌롯",type:"slot"},{id:53,name:"노리밋 시티",type:"slot"},{id:55,name:"OMI 게이밍",type:"slot"},{id:56,name:"원터치",type:"slot"},{id:59,name:"플레이슨",type:"slot"},{id:60,name:"푸쉬 게이밍",type:"slot"},{id:61,name:"퀵스핀",type:"slot"},{id:62,name:"RTG 슬롯",type:"slot"},{id:63,name:"리볼버 게이밍",type:"slot"},{id:65,name:"슬롯밀",type:"slot"},{id:66,name:"스피어헤드",type:"slot"},{id:70,name:"썬더킥",type:"slot"},{id:72,name:"우후 게임즈",type:"slot"},{id:74,name:"릴렉스 게이밍",type:"slot"},{id:75,name:"넷엔트",type:"slot"},{id:76,name:"레드타이거",type:"slot"},{id:87,name:"PG소프트",type:"slot"},{id:88,name:"플레이스타",type:"slot"},{id:90,name:"빅타임게이밍",type:"slot"},{id:300,name:"프라그마틱 플레이",type:"slot"},{id:410,name:"에볼루션 게이밍",type:"casino"},{id:77,name:"마이크로 게이밍",type:"casino"},{id:2,name:"Vivo 게이밍",type:"casino"},{id:30,name:"아시아 게이밍",type:"casino"},{id:78,name:"프라그마틱플레이",type:"casino"},{id:86,name:"섹시게이밍",type:"casino"},{id:11,name:"비비아이엔",type:"casino"},{id:28,name:"드림게임",type:"casino"},{id:89,name:"오리엔탈게임",type:"casino"},{id:91,name:"보타",type:"casino"},{id:44,name:"이주기",type:"casino"},{id:85,name:"플레이텍 라이브",type:"casino"},{id:0,name:"제네럴 카지노",type:"casino"}].map(t=>({id:t.id,name:t.name,type:t.type,status:"active",created_at:new Date().toISOString(),updated_at:new Date().toISOString()})),i=20;let e=0;for(let t=0;t<n.length;t+=i){const l=n.slice(t,t+i),{error:a}=await p.from("game_providers").upsert(l,{onConflict:"id",ignoreDuplicates:!1});a?console.error(`제공사 배치 ${Math.floor(t/i)+1} 삽입 오류:`,a):e+=l.length}console.log(`✅ 제공사 데이터 초기화 완료: ${e}개 처리`)}async function R(){console.log("🎰 카지노 로비 게임 초기화 시작");const{data:r,error:n}=await p.from("game_providers").select("id, name").eq("type","casino");if(n){console.error("카지노 제공사 조회 오류:",n);return}if(!r||r.length===0){console.log("카지노 제공사가 없습니다.");return}const i=[{id:41e4,provider_id:410,name:"에볼루션 게이밍 로비"},{id:77060,provider_id:77,name:"마이크로 게이밍 로비"},{id:2029,provider_id:2,name:"Vivo 게이밍 로비"},{id:3e4,provider_id:30,name:"아시아 게이밍 로비"},{id:78001,provider_id:78,name:"프라그마틱플레이 로비"},{id:86001,provider_id:86,name:"섹시게이밍 로비"},{id:11e3,provider_id:11,name:"비비아이엔 로비"},{id:28e3,provider_id:28,name:"드림게임 로비"},{id:89e3,provider_id:89,name:"오리엔탈게임 로비"},{id:91e3,provider_id:91,name:"보타 로비"},{id:44006,provider_id:44,name:"이주기 로비"},{id:85036,provider_id:85,name:"플레이텍 라이브 로비"},{id:0,provider_id:0,name:"제네럴 카지노 로비"}],{data:e}=await p.from("games").select("id").eq("type","casino"),t=new Set(e?.map(a=>a.id)||[]),l=i.filter(a=>!t.has(a.id)&&r.some(d=>d.id===a.provider_id));if(l.length>0){const a=l.map(s=>({id:s.id,provider_id:s.provider_id,name:s.name,type:"casino",status:"visible",demo_available:!1,created_at:new Date().toISOString(),updated_at:new Date().toISOString()})),{error:d}=await p.from("games").insert(a);d?console.error("카지노 로비 게임 추가 오류:",d):console.log(`✅ ${l.length}개 카지노 로비 게임 추가 완료`)}else console.log("✅ 카지노 로비 게임이 이미 모두 존재합니다.")}async function B(r,n,i,e,t,l,a,d){const{data:s,error:m}=await p.rpc("save_game_sync_result",{p_provider_id:r,p_opcode:n,p_sync_type:i,p_games_added:e,p_games_updated:t,p_games_removed:l,p_error_message:a,p_sync_duration:d});if(m)throw console.error("동기화 결과 저장 오류:",m),m;return s}async function M(r,n,i,e,t=50,l=0){const{data:a,error:d}=await p.rpc("get_user_visible_games",{p_user_id:r,p_game_type:n,p_provider_id:i,p_search_term:e,p_limit:t,p_offset:l});if(d)throw console.error("사용자 게임 목록 조회 오류:",d),d;return a||[]}async function V(r,n,i,e,t){const{data:l,error:a}=await p.rpc("update_game_status_for_partner",{p_partner_id:r,p_game_id:n,p_status:i,p_priority:e,p_is_featured:t});if(a)throw console.error("게임 상태 업데이트 오류:",a),a;return l}async function q(r,n){try{console.log("🎮 게임 실행 요청 시작:",{userId:r,gameId:n,userIdType:typeof r}),console.log("🔍 사용자 정보 조회 시작:",{userId:r,userIdType:typeof r});const{data:i,error:e}=await p.from("users").select("username, balance").eq("id",r).single();if(console.log("🔍 사용자 조회 결과:",{userData:i,userError:e}),e)throw console.error("❌ 사용자 조회 오류:",{error:e,message:e.message,details:e.details,hint:e.hint,code:e.code}),new Error(`사용자 정보 조회 실패: ${e.message}`);if(!i)throw console.error("❌ 사용자 데이터 없음:",{userId:r}),new Error("사용자 정보를 찾을 수 없습니다.");console.log("🔍 OPCODE 정보 조회 시작:",{userId:r});const{data:t,error:l}=await p.rpc("get_user_opcode_info",{user_id:r});console.log("🔍 OPCODE 조회 결과:",{opcodeData:t,opcodeError:l});let a,d,s;if(l||!t||!t.success){console.error("❌ OPCODE 조회 실패:",t?.error||l?.message),console.log("🔄 시스템 관리자 OPCODE로 fallback");const{data:S,error:G}=await p.from("partners").select("opcode, secret_key").eq("level",1).order("created_at",{ascending:!0}).limit(1).maybeSingle();if(G||!S)throw new Error("시스템 OPCODE 정보를 찾을 수 없습니다. 관리자에게 문의하세요.");a=S.opcode,d=S.secret_key,s="153b28230ef1c40c11ff526e9da93e2b"}else a=t.opcode,d=t.secret_key,s=t.api_token;const{username:m,balance:c}=i;if(!a||!d||!s)throw new Error("게임 실행에 필요한 API 정보가 부족합니다. 관리자에게 문의하세요.");console.log("📊 API 호출 정보:",{username:m,balance:c,opcode:a,secret_key:d?"***"+d.slice(-4):"null",token:s?"***"+s.slice(-4):"null"});const{data:P,error:A}=await p.from("games").select("id, name, external_game_id").eq("id",n).maybeSingle();if(A||!P)throw new Error("게임 정보를 찾을 수 없습니다.");let h=P.external_game_id;(!h||h===null||h==="")&&(h=P.id),console.log("🎮 investApi.launchGame 호출:",{opcode:a,username:m,token:s?"***"+s.slice(-4):"null",gameId:h,secret_key:d?"***"+d.slice(-4):"null"});const y=await x.launchGame(a,m,s,h,d);if(console.log("🎮 investApi.launchGame 결과:",y),!y.success)throw new Error(y.error||"게임 실행에 실패했습니다.");const E=y.data?.game_url||y.data?.url||y.data?.launch_url||"";if(!E)throw console.error("❌ 게임 URL을 찾을 수 없음:",y),new Error(y.error||"게임 실행 URL을 받지 못했습니다.");console.log("✅ 게임 URL 획득:",E),console.log("💾 게임 세션 저장 시작:",{userId:r,gameId:n,opcode:a,balance:c});const{data:w,error:v}=await p.rpc("save_game_launch_session",{p_user_id:r,p_game_id:n,p_opcode:a,p_launch_url:E,p_session_token:y.data?.token||null,p_balance_before:c||0});if(v){if(console.error("❌ 게임 세션 저장 오류:",v),console.error("❌ 오류 상세:",{code:v.code,message:v.message,details:v.details,hint:v.hint}),v.message&&v.message.includes("30초"))return{success:!1,error:v.message,sessionId:null}}else if(w==null)console.error("⚠️ 게임 세션 저장 실패: sessionId가 null입니다!"),console.error("⚠️ 함수가 에러를 반환하지 않았지만 세션 ID가 null입니다."),console.error("⚠️ Supabase 로그를 확인하세요: https://nzuzzmaiuybzyndptaba.supabase.co/project/_/logs/postgres-logs");else if(console.log("✅ 게임 세션 저장 성공! Session ID:",w),typeof window.startSessionMonitor=="function")try{window.startSessionMonitor(w,r),console.log("🎯 세션 모니터링 시작 요청 완료")}catch(S){console.error("⚠️ 세션 모니터링 시작 오류:",S)}return{success:!0,launchUrl:E,sessionId:w||null}}catch(i){console.error("❌ 게임 실행 오류:",i);const e=i instanceof Error?i.message:"게임 실행 중 오류가 발생했습니다.";return console.error("📝 반환할 오류 메시지:",e),{success:!1,error:e,sessionId:null}}finally{console.log("🔚 게임 실행 프로세스 종료")}}async function j(r){console.log("🔄 모든 제공사 게임 동기화 시작");const n=[];try{const{data:i,error:e}=await p.from("game_providers").select("id, name, type").eq("type","slot").eq("status","active");if(e)throw e;const t=r||"system_admin";for(const s of i||[])try{console.log(`🎮 ${s.name} (ID: ${s.id}) 동기화 시작`);const m=await C(s.id);n.push({providerId:s.id,providerName:s.name,gamesAdded:m.newGames||0,gamesUpdated:m.updatedGames||0}),await new Promise(c=>setTimeout(c,1e3))}catch(m){console.error(`❌ ${s.name} 동기화 실패:`,m),n.push({providerId:s.id,providerName:s.name,gamesAdded:0,gamesUpdated:0,error:m instanceof Error?m.message:"알 수 없는 오류"})}const l=n.reduce((s,m)=>s+m.gamesAdded,0),a=n.reduce((s,m)=>s+m.gamesUpdated,0),d=n.filter(s=>s.error).length;return console.log("✅ 전체 동기화 완료"),console.log(`📊 결과: 신규 ${l}개, 업데이트 ${a}개, 실패 ${d}개`),{success:d===0,results:n}}catch(i){return console.error("❌ 전체 동기화 실패:",i),{success:!1,results:n}}}async function F(r,n,i,e,t,l){try{const{data:a,error:d}=await p.rpc("save_game_session",{p_session_id:r,p_user_id:n,p_username:i,p_game_id:e,p_provider_id:t,p_launch_url:l||null});return d?(console.error("❌ 게임 세션 저장 실패:",d),null):(console.log("✅ 게임 세션 저장 완료:",a),a)}catch(a){return console.error("❌ 게임 세션 저장 오류:",a),null}}async function Q(r,n,i){try{const{data:e,error:t}=await p.rpc("update_game_session_status",{p_session_id:r,p_status:n,p_ended_at:i||null});return t?(console.error("❌ 게임 세션 상태 업데이트 실패:",t),!1):(console.log("✅ 게임 세션 상태 업데이트 완료:",{sessionId:r,status:n}),e)}catch(e){return console.error("❌ 게임 세션 상태 업데이트 오류:",e),!1}}async function H(r,n,i=0,e=!0,t){try{const{data:l,error:a}=await p.rpc("log_game_sync",{p_sync_type:r,p_provider_id:n||null,p_records_count:i,p_success:e,p_error_message:t||null});return a?(console.error("❌ 게임 동기화 로그 기록 실패:",a),null):l}catch(l){return console.error("❌ 게임 동기화 로그 기록 오류:",l),null}}const W={getProviders:I,getGames:L,updateGameStatus:N,syncGamesFromAPI:C,initializeGameProviders:O,initializeCasinoLobbyGames:R,saveSyncResult:B,getUserVisibleGames:M,updateGameStatusForPartner:V,generateGameLaunchUrl:q,launchGame:q,syncAllProviderGames:j,saveGameSession:F,updateGameSessionStatus:Q,logGameSync:H};export{K as S,W as g};
