import{s as _}from"./index-Cn1S8-JW.js";import"./react-core-CwM-CeLv.js";import"./vendor-CQn7sZ7L.js";import"./radix-ui-SX2QAG6c.js";import"./lucide-icons-wLPRtdhM.js";import"./supabase-r6ABpEO8.js";async function d(a){const t=[],{data:e}=await _.from("users").select("id").eq("referrer_id",a);e&&t.push(...e.map(o=>o.id));const{data:n}=await _.from("partners").select("id").eq("parent_id",a);if(n)for(const o of n){const i=await d(o.id);t.push(...i)}return t}async function u(a,t,e){if(a.length===0)return{totalBetAmount:0,totalLossAmount:0};const{data:n,error:o}=await _.from("game_records").select("bet_amount, win_amount").in("user_id",a).gte("created_at",t).lte("created_at",e);if(o)return console.error("베팅 데이터 조회 오류:",o),{totalBetAmount:0,totalLossAmount:0};if(!n)return{totalBetAmount:0,totalLossAmount:0};const i=n.reduce((r,s)=>r+(s.bet_amount||0),0),l=n.reduce((r,s)=>{const m=(s.bet_amount||0)-(s.win_amount||0);return r+(m>0?m:0)},0);return{totalBetAmount:i,totalLossAmount:l}}async function w(a,t,e){if(a.length===0)return 0;const{data:n,error:o}=await _.from("transactions").select("amount").in("user_id",a).eq("transaction_type","withdrawal").eq("status","approved").gte("created_at",t).lte("created_at",e);return o?(console.error("출금 데이터 조회 오류:",o),0):n?n.reduce((i,l)=>i+(l.amount||0),0):0}async function h(a,t,e,n){try{const o=await d(a);if(o.length===0)return{partner_id:a,partner_username:t.username,partner_nickname:t.nickname,partner_level:t.level,commission_rolling:t.commission_rolling,commission_losing:t.commission_losing,withdrawal_fee:t.withdrawal_fee,total_bet_amount:0,total_loss_amount:0,total_withdrawal_amount:0,rolling_commission:0,losing_commission:0,withdrawal_commission:0,total_commission:0};const{totalBetAmount:i,totalLossAmount:l}=await u(o,e,n),r=await w(o,e,n),s=i*(t.commission_rolling/100),m=l*(t.commission_losing/100),c=r*(t.withdrawal_fee/100),g=s+m+c;return{partner_id:a,partner_username:t.username,partner_nickname:t.nickname,partner_level:t.level,commission_rolling:t.commission_rolling,commission_losing:t.commission_losing,withdrawal_fee:t.withdrawal_fee,total_bet_amount:i,total_loss_amount:l,total_withdrawal_amount:r,rolling_commission:s,losing_commission:m,withdrawal_commission:c,total_commission:g}}catch(o){return console.error("파트너 커미션 계산 실패:",o),{partner_id:a,partner_username:t.username,partner_nickname:t.nickname,partner_level:t.level,commission_rolling:t.commission_rolling,commission_losing:t.commission_losing,withdrawal_fee:t.withdrawal_fee,total_bet_amount:0,total_loss_amount:0,total_withdrawal_amount:0,rolling_commission:0,losing_commission:0,withdrawal_commission:0,total_commission:0}}}async function R(a,t,e){try{const{data:n,error:o}=await _.from("partners").select("id, username, nickname, level, commission_rolling, commission_losing, withdrawal_fee").eq("parent_id",a).order("level").order("nickname");if(o)return console.error("하위 파트너 조회 오류:",o),[];if(!n||n.length===0)return[];const i=[];for(const l of n){const r=await h(l.id,l,t,e);i.push(r)}return i}catch(n){return console.error("하위 파트너 커미션 계산 실패:",n),[]}}async function f(a,t,e,n){try{const o=await d(a);if(o.length===0)return{rolling:0,losing:0,withdrawal:0,total:0};const{totalBetAmount:i,totalLossAmount:l}=await u(o,e,n),r=await w(o,e,n),s=i*(t.rolling/100),m=l*(t.losing/100),c=r*(t.withdrawal/100);return{rolling:s,losing:m,withdrawal:c,total:s+m+c}}catch(o){return console.error("내 수입 계산 실패:",o),{rolling:0,losing:0,withdrawal:0,total:0}}}async function y(a,t,e){try{const{data:n,error:o}=await _.from("partners").select("id, nickname, commission_rolling, commission_losing, withdrawal_fee").eq("parent_id",a);if(o)return console.error("하위 파트너 조회 오류:",o),{totalRolling:0,totalLosing:0,totalWithdrawal:0,total:0,details:[]};if(!n||n.length===0)return{totalRolling:0,totalLosing:0,totalWithdrawal:0,total:0,details:[]};const i=[];let l=0,r=0,s=0;for(const m of n){const c=await p(m,t,e);i.push(c),l+=c.rolling_payment,r+=c.losing_payment,s+=c.withdrawal_payment}return{totalRolling:l,totalLosing:r,totalWithdrawal:s,total:l+r+s,details:i}}catch(n){return console.error("파트너 지급 계산 실패:",n),{totalRolling:0,totalLosing:0,totalWithdrawal:0,total:0,details:[]}}}async function p(a,t,e){try{const n=await d(a.id);if(n.length===0)return{partner_id:a.id,partner_nickname:a.nickname,rolling_payment:0,losing_payment:0,withdrawal_payment:0,total_payment:0};const{totalBetAmount:o,totalLossAmount:i}=await u(n,t,e),l=await w(n,t,e),r=o*(a.commission_rolling/100),s=i*(a.commission_losing/100),m=l*(a.withdrawal_fee/100);return{partner_id:a.id,partner_nickname:a.nickname,rolling_payment:r,losing_payment:s,withdrawal_payment:m,total_payment:r+s+m}}catch(n){return console.error("파트너 지급 계산 실패:",n),{partner_id:a.id,partner_nickname:a.nickname,rolling_payment:0,losing_payment:0,withdrawal_payment:0,total_payment:0}}}async function b(a,t,e,n){try{const o=await f(a,t,e,n),i=await y(a,e,n);return{myRollingIncome:o.rolling,myLosingIncome:o.losing,myWithdrawalIncome:o.withdrawal,myTotalIncome:o.total,partnerRollingPayments:i.totalRolling,partnerLosingPayments:i.totalLosing,partnerWithdrawalPayments:i.totalWithdrawal,partnerTotalPayments:i.total,netRollingProfit:o.rolling-i.totalRolling,netLosingProfit:o.losing-i.totalLosing,netWithdrawalProfit:o.withdrawal-i.totalWithdrawal,netTotalProfit:o.total-i.total}}catch(o){return console.error("통합 정산 계산 실패:",o),{myRollingIncome:0,myLosingIncome:0,myWithdrawalIncome:0,myTotalIncome:0,partnerRollingPayments:0,partnerLosingPayments:0,partnerWithdrawalPayments:0,partnerTotalPayments:0,netRollingProfit:0,netLosingProfit:0,netWithdrawalProfit:0,netTotalProfit:0}}}async function v(a,t,e){if(a.length===0)return 0;const{data:n,error:o}=await _.from("transactions").select("amount").eq("transaction_type","deposit").eq("status","pending").in("user_id",a).gte("created_at",t).lte("created_at",e);return o?(console.error("만충금 조회 오류:",o),0):n?n.reduce((i,l)=>i+Number(l.amount),0):0}export{R as calculateChildPartnersCommission,b as calculateIntegratedSettlement,f as calculateMyIncome,h as calculatePartnerCommission,y as calculatePartnerPayments,v as calculatePendingDeposits,u as getBettingStats,d as getDescendantUserIds,w as getWithdrawalAmount};
