const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/opcodeHelper-D5ZqS5_Q.js","assets/index-BWgbPZ4l.js","assets/index-CUdUpqiT.css"])))=>i.map(i=>d[i]);
import{r as c,j as s,s as g,t as n,w as L,E as M,I as U,L as G,_ as H,aF as V,B as O}from"./index-BWgbPZ4l.js";import{D as W}from"./DataTable-CvK3ZY2w.js";import{C}from"./circle-alert-CD25byVy.js";import{C as Y}from"./cloud-download-Bqgf9oir.js";import{D as q}from"./download-DjFKNym8.js";import"./search-BHxVGLMF.js";function te({user:f}){const[y,b]=c.useState(!1),[w,j]=c.useState(!1),[v,N]=c.useState([]),[_,F]=c.useState(""),[A,R]=c.useState(0),[S,k]=c.useState(null);if(f.level>2)return s.jsx("div",{className:"flex items-center justify-center h-64",children:s.jsxs("div",{className:"text-center space-y-4",children:[s.jsx(C,{className:"h-12 w-12 text-yellow-500 mx-auto"}),s.jsx("p",{className:"text-muted-foreground",children:"ë² íŒ… ë‚´ì—­ ê´€ë¦¬ëŠ” ëŒ€ë³¸ì‚¬ ì´ìƒë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤."})]})});c.useEffect(()=>{u()},[]),c.useEffect(()=>{const e=g.channel("game-records-changes").on("postgres_changes",{event:"*",schema:"public",table:"game_records"},i=>{console.log("ğŸ® game_records í…Œì´ë¸” ë³€ê²½ ê°ì§€:",i),u()}).subscribe();return()=>{g.removeChannel(e)}},[]);const u=async()=>{try{b(!0),console.log("ğŸ“Š ì „ì²´ ë² íŒ… ë‚´ì—­ ì¡°íšŒ ì‹œì‘...");const{data:e,error:i,count:r}=await g.from("game_records").select(`
          id,
          external_txid,
          user_id,
          username,
          game_id,
          provider_id,
          bet_amount,
          win_amount,
          balance_before,
          balance_after,
          played_at,
          games(name),
          game_providers(name),
          users!game_records_user_id_fkey(
            referrer_id,
            referrer:partners!users_referrer_id_fkey(nickname)
          )
        `,{count:"exact"}).order("played_at",{ascending:!1}).limit(1e3);if(i)throw console.error("âŒ ì¡°íšŒ ì˜¤ë¥˜:",i),n.error("ë² íŒ… ë‚´ì—­ ì¡°íšŒ ì˜¤ë¥˜",{description:`${i.message}`}),i;console.log("âœ… ì¡°íšŒ ê²°ê³¼:",{count:r,dataLength:e?.length,sampleData:e?.slice(0,2)});const l=(e||[]).map(a=>({id:a.id,external_txid:a.external_txid||0,user_id:a.user_id,username:a.username||"Unknown",referrer_nickname:a.users?.referrer?.nickname||"-",game_name:a.games?.name||`Game ${a.game_id}`,provider_name:a.game_providers?.name||`Provider ${a.provider_id}`,bet_amount:parseFloat(a.bet_amount||0),win_amount:parseFloat(a.win_amount||0),balance_before:parseFloat(a.balance_before||0),balance_after:parseFloat(a.balance_after||0),played_at:a.played_at,profit_loss:parseFloat(a.win_amount||0)-parseFloat(a.bet_amount||0)}));N(l),R(r||0),l.length===0?n.warning("âš ï¸ ë² íŒ… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤",{description:'"ë² íŒ…ë‚´ì—­ê°€ì ¸ì˜¤ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë°ì´í„°ë¥¼ ë™ê¸°í™”í•˜ì„¸ìš”.'}):n.success(`âœ… ${l.length}ê±´ ì¡°íšŒ ì™„ë£Œ (ì „ì²´ ${r}ê±´)`)}catch(e){console.error("âŒ ë² íŒ… ë‚´ì—­ ì¡°íšŒ ì˜¤ë¥˜:",e),n.error("ë² íŒ… ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨",{description:e instanceof Error?e.message:"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}),N([])}finally{b(!1)}},I=async()=>{try{j(!0);const{getAdminOpcode:e,isMultipleOpcode:i}=await H(async()=>{const{getAdminOpcode:t,isMultipleOpcode:p}=await import("./opcodeHelper-D5ZqS5_Q.js");return{getAdminOpcode:t,isMultipleOpcode:p}},__vite__mapDeps([0,1,2]));let r,l;try{const t=await e(f);if(i(t)){if(t.opcodes.length===0){n.error("ë“±ë¡ëœ ëŒ€ë³¸ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.");return}const p=t.opcodes[0];r=p.opcode,l=p.secretKey,n.info(`${p.partnerName}ì˜ OPCODEë¡œ ë™ê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.`,{description:`ì´ ${t.opcodes.length}ê°œì˜ ëŒ€ë³¸ì‚¬ ì¤‘ ì²« ë²ˆì§¸`})}else r=t.opcode,l=t.secretKey,console.log(`âœ… ${f.partner_type} - ${t.partnerName} OPCODE ì‚¬ìš©`)}catch(t){n.error("OPCODE ì¡°íšŒ ì‹¤íŒ¨",{description:t.message});return}const a=new Date,$=a.getFullYear().toString(),D=(a.getMonth()+1).toString();console.log("ğŸ“¥ ë² íŒ… ë‚´ì—­ API í˜¸ì¶œ:",{year:$,month:D,opcode:r});const x=await V(r,$,D,0,4e3,l);if(x.error){n.error("API í˜¸ì¶œ ì˜¤ë¥˜",{description:x.error});return}const d=x.data?.DATA||[];if(!Array.isArray(d)||d.length===0){n.info("ê°€ì ¸ì˜¬ ë² íŒ… ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."),k(new Date().toISOString());return}console.log("âœ… API ì‘ë‹µ:",{ë ˆì½”ë“œìˆ˜:d.length,ìƒ˜í”Œ:d[0]});const T=d.map(t=>({txid:t.txid?.toString()||t.id?.toString(),username:t.username||t.user_id,provider_id:t.provider_id||Math.floor((t.game_id||0)/1e3),game_id:t.game_id?.toString()||"0",game_name:t.game_name||"Unknown",bet_amount:parseFloat(t.bet_amount||t.bet||0),win_amount:parseFloat(t.win_amount||t.win||0),profit_loss:parseFloat(t.profit_loss||t.win_loss||(t.win_amount||t.win||0)-(t.bet_amount||t.bet||0)),currency:t.currency||"KRW",status:t.status||"completed",round_id:t.round_id,session_id:t.session_id,game_start_time:t.game_start_time||t.start_time,game_end_time:t.game_end_time||t.end_time||t.played_at||t.created_at})),{data:K,error:h}=await g.rpc("save_betting_records_from_api",{p_records:T});if(h){console.error("âŒ ì €ì¥ í•¨ìˆ˜ í˜¸ì¶œ ì‹¤íŒ¨:",h),n.error("ë² íŒ… ë‚´ì—­ ì €ì¥ ì‹¤íŒ¨",{description:h.message});return}const o=K?.[0]||{saved_count:0,skipped_count:0,error_count:0,errors:[]};console.log("âœ… ì €ì¥ ê²°ê³¼:",o);const E=new Date().toISOString();k(E),o.saved_count>0?(n.success(`ë² íŒ… ë‚´ì—­ ${o.saved_count}ê±´ ì €ì¥ ì™„ë£Œ`,{description:`ë™ê¸°í™” ì‹œê°„: ${E}${o.skipped_count>0?` (ì¤‘ë³µ ${o.skipped_count}ê±´ ìŠ¤í‚µ)`:""}`}),u()):o.skipped_count>0&&n.info(`ëª¨ë“  ë°ì´í„°ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤ (${o.skipped_count}ê±´)`),o.error_count>0&&o.errors&&o.errors.length>0&&(console.warn("âš ï¸ ì¼ë¶€ ì €ì¥ ì˜¤ë¥˜:",o.errors),n.warning(`${o.error_count}ê±´ ì €ì¥ ì‹¤íŒ¨`,{description:`ì„±ê³µ: ${o.saved_count}ê±´, ìŠ¤í‚µ: ${o.skipped_count}ê±´
ì²« ë²ˆì§¸ ì—ëŸ¬: ${o.errors[0]}`}))}catch(e){console.error("âŒ ë² íŒ… ë™ê¸°í™” ì˜¤ë¥˜:",e),n.error("ë² íŒ… ë‚´ì—­ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨",{description:e instanceof Error?e.message:"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"})}finally{j(!1)}},B=()=>{try{const e=[["ì‚¬ìš©ì","ì†Œì†","ê²Œì„ëª…","ì œê³µì‚¬","ë² íŒ…ì•¡","ë‹¹ì²¨ì•¡","ì†ìµ","í”Œë ˆì´ ì‹œê°„"].join(","),...m.map(a=>[a.username,a.referrer_nickname,`"${a.game_name}"`,a.provider_name,a.bet_amount,a.win_amount,a.profit_loss,a.played_at].join(","))].join(`
`),i=new Blob(["\uFEFF"+e],{type:"text/csv;charset=utf-8;"}),r=document.createElement("a"),l=URL.createObjectURL(i);r.setAttribute("href",l),r.setAttribute("download",`betting_${new Date().toISOString().split("T")[0]}.csv`),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r),n.success("ë² íŒ… ë‚´ì—­ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ")}catch(e){console.error("ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:",e),n.error("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨")}};c.useEffect(()=>{u()},[]);const m=_?v.filter(e=>e.username.toLowerCase().includes(_.toLowerCase())):v,P=[{key:"username",title:"ì‚¬ìš©ì"},{key:"referrer_nickname",title:"ì†Œì†",render:e=>s.jsx(O,{variant:"outline",className:"bg-slate-800/50 border-slate-600",children:e})},{key:"game_name",title:"ê²Œì„ëª…",render:e=>s.jsx("span",{className:"max-w-[200px] truncate",title:e,children:e})},{key:"provider_name",title:"ì œê³µì‚¬",render:e=>s.jsx(O,{variant:"secondary",children:e})},{key:"bet_amount",title:"ë² íŒ…ì•¡",render:e=>s.jsxs("span",{className:"font-mono text-blue-600",children:["â‚©",e.toLocaleString()]})},{key:"win_amount",title:"ë‹¹ì²¨ì•¡",render:e=>s.jsxs("span",{className:`font-mono ${e>0?"text-green-600":"text-gray-500"}`,children:["â‚©",e.toLocaleString()]})},{key:"profit_loss",title:"ì†ìµ",render:e=>s.jsxs("span",{className:`font-mono ${e>0?"text-green-600":"text-red-600"}`,children:[e>0?"+":"","â‚©",e.toLocaleString()]})},{key:"played_at",title:"í”Œë ˆì´ ì‹œê°„",render:e=>e?new Date(e).toISOString().replace("T"," ").substring(0,19):"-"}];return s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"space-y-1",children:[s.jsx("h1",{className:"text-2xl font-bold text-slate-100",children:"ë² íŒ… ë‚´ì—­ ê´€ë¦¬"}),s.jsxs("p",{className:"text-sm text-slate-400",children:["ì¡°íšŒ: ",m.length,"ê±´ / ì „ì²´: ",A,"ê±´",S&&s.jsxs("span",{className:"ml-4 text-green-400",children:["ë§ˆì§€ë§‰ ë™ê¸°í™”: ",new Date(S).toLocaleString("ko-KR")]})]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(L,{onClick:I,disabled:w,className:"btn-premium-primary",children:[s.jsx(Y,{className:"h-4 w-4 mr-2"}),w?"ê°€ì ¸ì˜¤ëŠ” ì¤‘...":"ë² íŒ…ë‚´ì—­ê°€ì ¸ì˜¤ê¸°"]}),s.jsxs(L,{onClick:B,disabled:y||m.length===0,variant:"outline",className:"border-slate-600 hover:bg-slate-700",children:[s.jsx(q,{className:"h-4 w-4 mr-2"}),"ë‹¤ìš´ë¡œë“œ"]})]})]}),s.jsx("div",{className:"glass-card rounded-xl p-6",children:s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"flex items-center justify-between mb-6 pb-4 border-b border-slate-700/50",children:s.jsxs("div",{children:[s.jsx(M,{className:"text-slate-300",children:"ì‚¬ìš©ìëª… ê²€ìƒ‰"}),s.jsx(U,{placeholder:"ì‚¬ìš©ìëª… ì…ë ¥...",value:_,onChange:e=>F(e.target.value),className:"input-premium max-w-xs"})]})}),y?s.jsx("div",{className:"flex justify-center py-12",children:s.jsx(G,{})}):m.length>0?s.jsx(W,{columns:P,data:m,enableSearch:!1}):s.jsxs("div",{className:"text-center py-12 text-slate-400",children:[s.jsx(C,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),s.jsx("p",{children:"ì¡°íšŒëœ ë² íŒ… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤."}),s.jsx("p",{className:"text-sm mt-2",children:_?"ê²€ìƒ‰ ì¡°ê±´ì„ ë³€ê²½í•´ë³´ì„¸ìš”.":'"ë² íŒ…ë‚´ì—­ê°€ì ¸ì˜¤ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë°ì´í„°ë¥¼ ë™ê¸°í™”í•˜ì„¸ìš”.'})]})]})})]})}export{te as BettingManagement};
