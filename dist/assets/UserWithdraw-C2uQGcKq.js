import{r,j as e}from"./react-core-CwM-CeLv.js";import{K as re,s as x,C as L,a as W,b as R,d as K,e as P,V as z,W as M,L as b,I as w,i as g,S as le,p as ne,q as ce,r as ie,t as oe,B as de}from"./index-B-OPgV84.js";import{T as me}from"./textarea-B58kONDf.js";import{D as xe,f as he,a as ue,b as be,c as ge,d as pe}from"./dialog-CzVROrzc.js";import{k as c}from"./vendor-CQn7sZ7L.js";import{aD as O,z as V,d as je,ad as we,o as fe,n as Ne,R as ve,t as ye}from"./lucide-icons-D2Y5yybo.js";import"./radix-ui-SX2QAG6c.js";import"./supabase-r6ABpEO8.js";function Ae({user:t,onRouteChange:_e}){const{sendMessage:U}=re(),[h,p]=r.useState(""),[o,S]=r.useState(""),[u,k]=r.useState(""),[d,D]=r.useState(""),[f,I]=r.useState(""),[j,T]=r.useState(""),[B,F]=r.useState(!1),[H,Q]=r.useState([]),[X,G]=r.useState(!0),[m,J]=r.useState(0),[n,A]=r.useState(!1),[Y,N]=r.useState(!1),[Z]=r.useState([1e3,3e3,5e3,1e4,3e4,5e4,1e5,3e5,5e5,1e6]),ee=["국민은행","신한은행","우리은행","KB국민은행","KEB하나은행","농협은행","기업은행","새마을금고","신협","우체국","카카오뱅크","토스뱅크","케이뱅크"],v=async()=>{try{const{data:s,error:a}=await x.from("transactions").select("*").eq("user_id",t.id).eq("transaction_type","withdrawal").in("status",["pending","approved"]).limit(1);if(a)throw a;s&&s.length>0?(A(!0),c.warning("진행 중인 출금 신청이 있어 새로운 출금을 신청할 수 없습니다.")):A(!1)}catch(s){console.error("출금 상태 확인 오류:",s)}},y=async()=>{try{const{data:s,error:a}=await x.from("transactions").select("*").eq("user_id",t.id).eq("transaction_type","withdrawal").order("created_at",{ascending:!1}).limit(10);if(a)throw a;Q(s||[])}catch(s){console.error("출금 내역 조회 오류:",s),c.error("출금 내역을 불러오는데 실패했습니다.")}finally{G(!1)}},_=async()=>{try{const{data:s,error:a}=await x.from("users").select("balance").eq("id",t.id).single();if(a)throw a;J(parseFloat(s.balance)||0)}catch(s){console.error("잔고 조회 오류:",s)}},se=async()=>{if(!h||!o||!u||!d||!j){c.error("모든 필수 항목을 입력해주세요.");return}const s=parseFloat(h);if(s<1e4){c.error("최소 출금액은 10,000원입니다.");return}if(await _(),s>m){c.error(`출금 가능 금액이 부족합니다.
현재 잔고: ${m.toLocaleString()}원`);return}F(!0);try{const{data:a,error:l}=await x.rpc("user_login",{p_username:t.username,p_password:j});if(l||!a||a.length===0)throw new Error("비밀번호가 올바르지 않습니다.");const $={user_id:t.id,partner_id:t.referrer_id||null,transaction_type:"withdrawal",amount:s,status:"pending",balance_before:m,balance_after:m,bank_name:o,bank_account:u,bank_holder:d,memo:f||null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};console.log("💸 출금 신청 데이터:",{...$,user_info:{id:t.id,username:t.username,referrer_id:t.referrer_id}});const{data:C,error:q}=await x.from("transactions").insert([$]).select().single();if(q)throw q;await U("withdrawal_request",{transaction_id:C.id,user_id:t.id,username:t.username,nickname:t.nickname,amount:s,bank_name:o,bank_account:u,bank_holder:d,memo:f||null,subject:`${t.nickname}님의 출금 신청`,reference_type:"transaction",reference_id:C.id},3)&&console.log("✅ 출금 요청 알림이 관리자에게 전송되었습니다."),await x.from("activity_logs").insert([{actor_type:"user",actor_id:t.id,action:"withdrawal_request",target_type:"transaction",target_id:C.id,details:{amount:s,bank_name:o,bank_holder:d}}]),c.success(`출금 신청이 완료되었습니다.
관리자 승인 후 계좌로 송금됩니다.`,{duration:4e3}),p(""),S(""),k(""),D(""),I(""),T(""),N(!1),await Promise.all([y(),v()])}catch(a){console.error("❌ 출금 신청 오류:",a),c.error(a.message||"출금 신청 중 오류가 발생했습니다.")}finally{F(!1)}},ae=s=>{switch(s){case"pending":return{color:"bg-yellow-500",textColor:"text-yellow-400",icon:ye,label:"승인대기"};case"approved":return{color:"bg-blue-500",textColor:"text-blue-400",icon:ve,label:"처리중"};case"completed":return{color:"bg-green-500",textColor:"text-green-400",icon:Ne,label:"완료"};case"rejected":return{color:"bg-red-500",textColor:"text-red-400",icon:fe,label:"거절"};default:return{color:"bg-gray-500",textColor:"text-slate-400",icon:we,label:"알 수 없음"}}},i=s=>new Intl.NumberFormat("ko-KR").format(s),te=s=>new Date(s).toLocaleString("ko-KR"),E=parseFloat(h)||0;return r.useEffect(()=>{v(),y(),_();const s=x.channel(`withdrawal_updates_${t.id}`).on("postgres_changes",{event:"*",schema:"public",table:"transactions",filter:`user_id=eq.${t.id}`},a=>{if(console.log("🔄 출금 상태 업데이트 수신:",a),a.eventType==="UPDATE"||a.eventType==="INSERT"){const l=a.new;l.transaction_type==="withdrawal"&&(y(),v(),l.status==="completed"?(_(),c.success(`출금이 완료되었습니다!
금액: ₩${i(l.amount)}`,{duration:5e3})):l.status==="rejected"?c.error(`출금 신청이 거절되었습니다.
금액: ₩${i(l.amount)}`,{duration:5e3}):l.status==="approved"&&c.info(`출금이 승인되었습니다. 처리 중입니다.
금액: ₩${i(l.amount)}`,{duration:4e3}))}}).subscribe();return()=>{s.unsubscribe()}},[t.id]),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"출금 신청"}),e.jsx("p",{className:"text-slate-400 mt-1",children:"안전하고 빠른 출금 서비스를 제공합니다"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-slate-400",children:"현재 잔고"}),e.jsxs("p",{className:"text-xl font-bold text-green-400",children:["₩",i(m)]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(L,{className:"bg-slate-800/50 border-slate-700",children:[e.jsxs(W,{children:[e.jsxs(R,{className:"text-white flex items-center gap-2",children:[e.jsx(O,{className:"w-5 h-5"}),"출금 신청"]}),e.jsx(K,{className:"text-slate-400",children:"출금할 금액과 계좌 정보를 입력하세요"})]}),e.jsxs(P,{className:"space-y-4",children:[n&&e.jsxs(z,{className:"border-yellow-600 bg-yellow-900/20",children:[e.jsx(V,{className:"h-4 w-4 text-yellow-400"}),e.jsx(M,{className:"text-yellow-300",children:"진행 중인 출금 신청이 있어 새로운 출금을 신청할 수 없습니다."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(b,{htmlFor:"amount",className:"text-slate-300",children:"출금 금액 *"}),e.jsx(w,{id:"amount",type:"text",placeholder:"출금할 금액을 입력하세요",value:h,onChange:s=>{const a=s.target.value.replace(/[^0-9]/g,"");p(a)},className:"bg-slate-700/50 border-slate-600 text-white",disabled:n}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[Z.map(s=>e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>{const a=parseInt(h)||0;p((a+s).toString())},className:"text-xs border-slate-600 text-slate-300 hover:bg-slate-700",disabled:n,children:["+",i(s)]},s)),e.jsx(g,{variant:"outline",size:"sm",onClick:()=>p(m.toString()),className:"text-xs border-green-600 text-green-400 hover:bg-green-900/20",disabled:n,children:"전액출금"}),e.jsx(g,{variant:"outline",size:"sm",onClick:()=>p(""),className:"text-xs border-red-600 text-red-400 hover:bg-red-900/20",disabled:n,children:"삭제"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"bank",className:"text-slate-300",children:"은행 선택 *"}),e.jsxs(le,{value:o,onValueChange:S,disabled:n,children:[e.jsx(ne,{className:"bg-slate-700/50 border-slate-600 text-white",children:e.jsx(ce,{placeholder:"은행을 선택하세요"})}),e.jsx(ie,{className:"bg-slate-800 border-slate-700",children:ee.map(s=>e.jsx(oe,{value:s,className:"text-white",children:s},s))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"accountNumber",className:"text-slate-300",children:"계좌번호 *"}),e.jsx(w,{id:"accountNumber",placeholder:"'-' 없이 숫자만 입력",value:u,onChange:s=>k(s.target.value.replace(/[^0-9]/g,"")),className:"bg-slate-700/50 border-slate-600 text-white",disabled:n})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(b,{htmlFor:"accountHolder",className:"text-slate-300",children:"예금주명 *"}),e.jsx(w,{id:"accountHolder",placeholder:"계좌의 예금주명을 입력하세요",value:d,onChange:s=>D(s.target.value),className:"bg-slate-700/50 border-slate-600 text-white",disabled:n})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(b,{htmlFor:"memo",className:"text-slate-300",children:"메모 (선택)"}),e.jsx(me,{id:"memo",placeholder:"추가 요청사항이 있으시면 입력하세요",value:f,onChange:s=>I(s.target.value),className:"bg-slate-700/50 border-slate-600 text-white",rows:3,disabled:n})]})]}),e.jsxs(z,{className:"border-red-600 bg-red-900/20",children:[e.jsx(V,{className:"h-4 w-4 text-red-400"}),e.jsx(M,{className:"text-red-300",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{children:"• 최소 출금액: 10,000원"}),e.jsx("p",{children:"• 출금 신청 시 게임 이용이 제한됩니다"}),e.jsx("p",{children:"• 예금주명은 회원 본인과 일치해야 합니다"}),e.jsx("p",{children:"• 출금 처리 시간: 평일 기준 1-3시간"})]})})]}),e.jsxs(xe,{open:Y,onOpenChange:N,children:[e.jsx(he,{asChild:!0,children:e.jsxs(g,{disabled:n||!h||!o||!u||!d,className:"w-full bg-blue-600 hover:bg-blue-700 text-white py-3",children:[e.jsx(O,{className:"w-4 h-4 mr-2"}),"출금 신청하기"]})}),e.jsxs(ue,{className:"bg-slate-800 border-slate-700 text-white",children:[e.jsxs(be,{children:[e.jsx(ge,{children:"출금 신청 확인"}),e.jsx(pe,{className:"text-slate-400",children:"출금 신청 정보를 확인하고 최종 승인해주세요."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 bg-slate-700/50 rounded-lg space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"출금 금액:"}),e.jsxs("span",{children:["₩",i(E)]})]}),e.jsxs("div",{className:"flex justify-between text-sm text-slate-400",children:[e.jsx("span",{children:"출금 후 잔액:"}),e.jsxs("span",{children:["₩",i(m-E)]})]})]}),e.jsxs("div",{className:"p-4 bg-slate-700/50 rounded-lg",children:[e.jsx("p",{className:"text-sm text-slate-300",children:"출금 계좌 정보"}),e.jsxs("p",{children:[o," ",u]}),e.jsxs("p",{children:["예금주: ",d]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"confirmPassword",className:"text-slate-300",children:"비밀번호 확인 *"}),e.jsx(w,{id:"confirmPassword",type:"password",placeholder:"비밀번호를 입력하세요",value:j,onChange:s=>T(s.target.value),className:"bg-slate-700/50 border-slate-600 text-white"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{variant:"outline",onClick:()=>N(!1),className:"flex-1",children:"취소"}),e.jsx(g,{onClick:se,disabled:B||!j,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:B?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"처리중..."]}):"출금 신청"})]})]})]})]})]})]}),e.jsxs(L,{className:"bg-slate-800/50 border-slate-700",children:[e.jsxs(W,{children:[e.jsxs(R,{className:"text-white flex items-center gap-2",children:[e.jsx(je,{className:"w-5 h-5"}),"최근 출금 내역"]}),e.jsx(K,{className:"text-slate-400",children:"최근 10개의 출금 신청 내역을 확인할 수 있습니다"})]}),e.jsx(P,{children:X?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-400"})}):H.length===0?e.jsx("div",{className:"text-center py-8 text-slate-400",children:"출금 내역이 없습니다"}):e.jsx("div",{className:"space-y-3",children:H.map(s=>{const a=ae(s.status),l=a.icon;return e.jsxs("div",{className:"p-4 bg-slate-700/30 rounded-lg border border-slate-600/50",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(l,{className:`w-4 h-4 ${a.textColor}`}),e.jsx(de,{variant:"outline",className:`${a.color} text-white border-none`,children:a.label})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-semibold text-white",children:["₩",i(s.amount)]}),e.jsx("p",{className:"text-xs text-slate-400",children:te(s.created_at)})]})]}),e.jsxs("div",{className:"text-sm text-slate-400 space-y-1",children:[e.jsxs("p",{children:[s.bank_name," ",s.bank_account]}),e.jsxs("p",{children:["예금주: ",s.bank_holder]}),s.memo&&e.jsx("p",{className:"text-slate-500",children:s.memo})]})]},s.id)})})})]})]})]})}export{Ae as UserWithdraw};
