import{k as Z,r as l,s as m,j as e,C as v,a as H,b as M,w as c,X as ee,e as _,I as se,aM as E,L as te,B as O,b1 as ae,$ as ne,H as R,t as le}from"./index-DuEcnhwm.js";import{D as ie,a as re,b as ce,c as oe,d as de}from"./dialog-BlSexbtz.js";import{C as me,a as xe}from"./collapsible-ByBOKHiD.js";import{S as he}from"./search-DyNhXeLR.js";import{C as $}from"./calendar-C1fb4yjl.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=[["path",{d:"M12 17v5",key:"bb1du9"}],["path",{d:"M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z",key:"1nkz8b"}]],pe=Z("pin",ue);function ve({user:f,onRouteChange:fe}){const[y,C]=l.useState([]),[g,h]=l.useState([]),[u,B]=l.useState(""),[J,S]=l.useState(!0),[r,q]=l.useState(null),[A,k]=l.useState(!1),[F,Q]=l.useState([]),[U,D]=l.useState([]),[o,V]=l.useState(1),[j,K]=l.useState(1),N=10,p=async(s=1)=>{try{S(!0);const t=(s-1)*N,{data:a,error:n,count:x}=await m.from("announcements").select(`
          *,
          partners (
            nickname
          )
        `,{count:"exact"}).eq("status","active").in("target_type",["users","all"]).order("is_pinned",{ascending:!1}).order("created_at",{ascending:!1}).range(t,t+N-1);if(n)throw n;const b=a?.map(d=>d.id)||[],{data:i}=await m.from("announcement_reads").select("announcement_id").eq("user_id",f.id).in("announcement_id",b),Y=i?.map(d=>d.announcement_id)||[],z=a?.map(d=>({...d,is_read:Y.includes(d.id)}))||[];C(z),h(z),K(Math.ceil((x||0)/N)),V(s)}catch(t){console.error("공지사항 조회 오류:",t),le.error("공지사항을 불러오는데 실패했습니다.")}finally{S(!1)}},L=async()=>{try{const{data:s,error:t}=await m.from("announcements").select("id, title, content, created_at").eq("status","active").eq("is_popup",!0).in("target_type",["users","all"]).order("created_at",{ascending:!1});if(t)throw t;const a=JSON.parse(localStorage.getItem("hidden_popups_today")||"[]"),n=new Date().toDateString(),x=a.filter(i=>i.date===n).map(i=>i.id),b=(s||[]).filter(i=>!x.includes(i.id)).map(i=>({...i,hide_today:!1}));D(b)}catch(s){console.error("팝업 공지사항 조회 오류:",s)}},T=s=>{if(B(s),!s.trim()){h(y);return}const t=y.filter(a=>a.title.toLowerCase().includes(s.toLowerCase())||a.content.toLowerCase().includes(s.toLowerCase()));h(t)},W=async s=>{if(q(s),k(!0),!s.is_read)try{await m.from("announcement_reads").insert([{announcement_id:s.id,user_id:f.id}]),await m.from("announcements").update({view_count:s.view_count+1}).eq("id",s.id),C(t=>t.map(a=>a.id===s.id?{...a,is_read:!0,view_count:a.view_count+1}:a)),h(t=>t.map(a=>a.id===s.id?{...a,is_read:!0,view_count:a.view_count+1}:a))}catch(t){console.error("읽음 처리 오류:",t)}},I=s=>{Q(t=>t.includes(s)?t.filter(a=>a!==s):[...t,s])},w=(s,t=!1)=>{if(D(a=>a.filter(n=>n.id!==s)),t){const a=JSON.parse(localStorage.getItem("hidden_popups_today")||"[]"),n=new Date().toDateString(),x=[...a,{id:s,date:n}];localStorage.setItem("hidden_popups_today",JSON.stringify(x))}},P=s=>new Date(s).toLocaleString("ko-KR"),X=s=>{const t=new Date,a=new Date(s),n=Math.floor((t.getTime()-a.getTime())/(1e3*60*60));return n<1?"방금 전":n<24?`${n}시간 전`:`${Math.floor(n/24)}일 전`},G=(s,t=100)=>s.length<=t?s:s.substring(0,t)+"...";return l.useEffect(()=>{p(),L();const s=m.channel("announcement_updates").on("postgres_changes",{event:"*",schema:"public",table:"announcements"},()=>{p(o),L()}).subscribe();return()=>s.unsubscribe()},[f.id]),e.jsxs("div",{className:"space-y-6",children:[U.map(s=>e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",children:e.jsxs(v,{className:"w-full max-w-md lg:max-w-lg bg-slate-800 border-slate-700 relative",children:[e.jsx(H,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(M,{className:"text-lg text-white pr-8",children:s.title}),e.jsx(c,{variant:"ghost",size:"sm",onClick:()=>w(s.id),className:"absolute top-2 right-2 w-8 h-8 p-0 text-slate-400 hover:text-white",children:e.jsx(ee,{className:"w-4 h-4"})})]})}),e.jsxs(_,{className:"space-y-4",children:[e.jsx("div",{className:"text-slate-300 text-sm max-h-60 overflow-y-auto",dangerouslySetInnerHTML:{__html:s.content}}),e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-slate-700",children:[e.jsx("span",{className:"text-xs text-slate-500",children:P(s.created_at)}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{variant:"outline",size:"sm",onClick:()=>w(s.id,!0),children:"오늘 하루 보지 않기"}),e.jsx(c,{size:"sm",onClick:()=>w(s.id),className:"bg-blue-600 hover:bg-blue-700",children:"확인"})]})]})]})]})},s.id)),e.jsx("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"공지사항"}),e.jsx("p",{className:"text-slate-400",children:"중요한 안내사항을 확인하세요"})]})}),e.jsx(v,{className:"bg-slate-800/50 border-slate-700",children:e.jsx(_,{className:"p-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(he,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4"}),e.jsx(se,{placeholder:"공지사항 제목이나 내용으로 검색...",value:u,onChange:s=>T(s.target.value),className:"pl-10 bg-slate-700/50 border-slate-600 text-white"})]})})}),e.jsxs(v,{className:"bg-slate-800/50 border-slate-700",children:[e.jsx(H,{children:e.jsxs(M,{className:"flex items-center text-white",children:[e.jsx(E,{className:"w-5 h-5 mr-2 text-blue-400"}),"공지사항 (",g.length,")"]})}),e.jsx(_,{children:J?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(te,{})}):g.length>0?e.jsxs("div",{className:"space-y-4",children:[g.map(s=>{const t=F.includes(s.id);return e.jsx("div",{className:"p-4 bg-slate-700/30 rounded-lg hover:bg-slate-700/50 transition-colors",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`w-2 h-2 rounded-full mt-2 flex-shrink-0 ${s.is_read?"bg-slate-500":"bg-blue-400"}`}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3 mb-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[s.is_pinned&&e.jsxs(O,{className:"bg-red-500 text-white text-xs",children:[e.jsx(pe,{className:"w-3 h-3 mr-1"}),"고정"]}),s.is_popup&&e.jsx(O,{className:"bg-purple-500 text-white text-xs",children:"팝업"})]}),e.jsx("h3",{className:`font-medium cursor-pointer hover:text-blue-400 transition-colors ${s.is_read?"text-slate-300":"text-white"}`,onClick:()=>W(s),children:s.title})]}),e.jsx(c,{variant:"ghost",size:"sm",onClick:()=>I(s.id),className:"flex-shrink-0 w-8 h-8 p-0",children:t?e.jsx(ae,{className:"w-4 h-4"}):e.jsx(ne,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-slate-500 mb-2",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx($,{className:"w-3 h-3"}),X(s.created_at)]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(R,{className:"w-3 h-3"}),s.view_count.toLocaleString()]}),s.partners?.nickname&&e.jsxs("span",{children:["관리자: ",s.partners.nickname]})]}),e.jsx(me,{open:t,onOpenChange:()=>I(s.id),children:e.jsx(xe,{children:e.jsx("div",{className:"text-slate-300 text-sm mt-3 p-3 bg-slate-600/30 rounded border-l-4 border-blue-500",dangerouslySetInnerHTML:{__html:s.content}})})}),!t&&e.jsx("p",{className:"text-slate-400 text-sm",children:G(s.content.replace(/<[^>]*>/g,""))})]})]})},s.id)}),j>1&&e.jsxs("div",{className:"flex justify-center gap-2 pt-4",children:[e.jsx(c,{variant:"outline",size:"sm",onClick:()=>p(o-1),disabled:o<=1,children:"이전"}),e.jsxs("span",{className:"flex items-center px-3 text-slate-300",children:[o," / ",j]}),e.jsx(c,{variant:"outline",size:"sm",onClick:()=>p(o+1),disabled:o>=j,children:"다음"})]})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(E,{className:"w-16 h-16 text-slate-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-medium text-white mb-2",children:u?"검색 결과가 없습니다":"공지사항이 없습니다"}),e.jsx("p",{className:"text-slate-400 mb-4",children:u?"다른 검색어로 시도해보세요.":"새로운 공지사항이 등록되면 알려드리겠습니다."}),u&&e.jsx(c,{variant:"outline",onClick:()=>T(""),children:"전체 공지사항 보기"})]})})]}),e.jsx(ie,{open:A,onOpenChange:k,children:e.jsx(re,{className:"max-w-2xl bg-slate-800 border-slate-700 text-white max-h-[80vh] overflow-y-auto",children:r&&e.jsxs(e.Fragment,{children:[e.jsxs(ce,{children:[e.jsx(oe,{className:"text-xl",children:r.title}),e.jsx(de,{className:"text-slate-400",children:"공지사항 내용을 확인하실 수 있습니다."}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-slate-400 pt-2",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx($,{className:"w-4 h-4"}),P(r.created_at)]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(R,{className:"w-4 h-4"}),"조회 ",r.view_count.toLocaleString()]}),r.partners?.nickname&&e.jsxs("span",{children:["작성자: ",r.partners.nickname]})]})]}),e.jsx("div",{className:"pt-4",children:e.jsx("div",{className:"prose prose-invert max-w-none text-slate-300",dangerouslySetInnerHTML:{__html:r.content}})})]})})})]})}export{ve as UserNotice};
