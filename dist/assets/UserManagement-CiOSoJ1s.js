const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-Cn1S8-JW.js","assets/react-core-CwM-CeLv.js","assets/vendor-CQn7sZ7L.js","assets/radix-ui-SX2QAG6c.js","assets/lucide-icons-wLPRtdhM.js","assets/supabase-r6ABpEO8.js","assets/index-BVHCjfv2.css"])))=>i.map(i=>d[i]);
import{r as x,j as e}from"./react-core-CwM-CeLv.js";import{C as K,e as V,L as H,I as W,i as k,s as m,B as N,T as ze,j as Ge,k as ie,l as ce,m as te,n as qe,o as Ke,S as Le,p as Te,q as Pe,r as Ie,t as de,v as Ee,w as Ve,x as Ye,y as Je,z as Xe,A as Qe}from"./index-Cn1S8-JW.js";import{D as Ze}from"./DataTable-CjdfiZ7Q.js";import{A as ye,a as _e,b as Se,c as ke,d as Ce,e as Fe}from"./AdminDialog-qdCOZfhu.js";import{k as d}from"./vendor-CQn7sZ7L.js";import{_ as Be}from"./supabase-r6ABpEO8.js";import{b as De,s as we,W as Ne,G as ve,x as pe,A as He,t as $e,T as es,y as ss,v as ts,z as as,w as rs,F as ns,P as ls,U as os,J as Me,K as is,N as cs,O as Ue,k as ds,X as ms,m as xs,u as Oe,Q as Re}from"./lucide-icons-wLPRtdhM.js";import{M as ge}from"./MetricCard-CBRAhT7E.js";import{F as us}from"./ForceTransactionModal-DN0l0vJ3.js";import"./radix-ui-SX2QAG6c.js";import"./textarea-DcWc96jr.js";import"./popover-KcKD6lRl.js";import"./command-D1kDSEeZ.js";import"./dialog-CE9i0HK9.js";function hs({userId:l}){const[f,I]=x.useState(""),[v,C]=x.useState(""),[u,y]=x.useState(!1),U=async()=>{if(!f||!v){d.error("비밀번호를 입력해주세요.");return}if(f.length<4){d.error("비밀번호는 최소 4자 이상이어야 합니다.");return}if(f!==v){d.error("비밀번호가 일치하지 않습니다.");return}try{y(!0);const{error:g}=await m.from("users").update({password_hash:f,updated_at:new Date().toISOString()}).eq("id",l);if(g)throw g;d.success("비밀번호가 변경되었습니다."),I(""),C("")}catch(g){console.error("비밀번호 변경 오류:",g),d.error("비밀번호 변경에 실패했습니다.")}finally{y(!1)}};return e.jsxs("div",{children:[e.jsxs("h3",{className:"flex items-center gap-2 mb-3",children:[e.jsx(De,{className:"h-3.5 w-3.5 text-red-400"}),e.jsx("span",{className:"text-xs",children:"비밀번호 변경"})]}),e.jsx(K,{className:"bg-white/5 border-white/10",children:e.jsxs(V,{className:"p-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"newPassword",className:"text-xs",children:"새 비밀번호"}),e.jsx(W,{id:"newPassword",type:"password",value:f,onChange:g=>I(g.target.value),placeholder:"새 비밀번호 입력 (최소 4자)",className:"bg-white/5 border-white/10 text-xs h-9"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"confirmPassword",className:"text-xs",children:"비밀번호 확인"}),e.jsx(W,{id:"confirmPassword",type:"password",value:v,onChange:g=>C(g.target.value),placeholder:"비밀번호 재입력",className:"bg-white/5 border-white/10 text-xs h-9"})]})]}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx(k,{onClick:U,disabled:u||!f||!v,className:"bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white px-4 py-2 text-xs h-9",children:u?"변경 중...":"비밀번호 변경"})})]})})]})}function ps({user:l,isOpen:f,onClose:I}){const[v,C]=x.useState("basic"),[u,y]=x.useState(!1),[U,g]=x.useState([]),[me,ae]=x.useState([]),[D,xe]=x.useState(null),[p,fe]=x.useState({totalDeposit:0,totalWithdraw:0,totalBets:0,totalWinAmount:0,accountAge:0,lastActivity:"",gameCount:0,winRate:0}),[E,X]=x.useState(1e8),[Q,ue]=x.useState(null),[Y,Z]=x.useState(!1),re=async()=>{try{y(!0);const{data:t}=await m.from("transactions").select("transaction_type, amount, status").eq("user_id",l.id),n=(t||[]).filter(w=>w.transaction_type==="deposit"&&w.status==="approved").reduce((w,S)=>w+(S.amount||0),0),j=(t||[]).filter(w=>w.transaction_type==="withdrawal"&&w.status==="approved").reduce((w,S)=>w+(S.amount||0),0),{data:b}=await m.from("game_records").select("bet_amount, win_amount").eq("user_id",l.id),z=(b||[]).reduce((w,S)=>w+(S.bet_amount||0),0),R=(b||[]).reduce((w,S)=>w+(S.win_amount||0),0),P=b?.length||0,F=(b||[]).filter(w=>(w.win_amount||0)>(w.bet_amount||0)).length,L=P>0?F/P*100:0,B=Math.floor((Date.now()-new Date(l.created_at).getTime())/(1e3*60*60*24)),{data:oe}=await m.from("game_launch_sessions").select("launched_at").eq("user_id",l.id).order("launched_at",{ascending:!1}).limit(1).single();fe({totalDeposit:n,totalWithdraw:j,totalBets:z,totalWinAmount:R,accountAge:B,lastActivity:oe?.launched_at||l.created_at,gameCount:P,winRate:L})}catch(t){console.error("통계 계산 오류:",t)}finally{y(!1)}},J=async()=>{try{y(!0);const{data:t,error:n}=await m.from("transactions").select("*").eq("user_id",l.id).order("created_at",{ascending:!1}).limit(100);if(n)throw n;g(t||[])}catch(t){console.error("입출금 내역 조회 오류:",t),d.error("입출금 내역을 불러오는데 실패했습니다.")}finally{y(!1)}},ne=async()=>{try{y(!0);const{data:t,error:n}=await m.from("game_records").select("*").eq("user_id",l.id).order("played_at",{ascending:!1}).limit(100);if(n)throw n;ae(t||[])}catch(t){console.error("베팅 내역 조회 오류:",t),d.error("베팅 내역을 불러오는데 실패했습니다.")}finally{y(!1)}},_=async()=>{try{y(!0);const{data:t}=await m.from("game_records").select("*").eq("user_id",l.id).order("played_at",{ascending:!1}).limit(500);if(!t||t.length===0){xe(null);return}const n=new Map;t.forEach(r=>{const c=`${r.game_id}_${r.game_title||""}`;n.has(c)||n.set(c,{gameName:r.game_title||`게임 ${r.game_id}`,providerName:r.provider_name||"",count:0,totalBet:0,totalWin:0,wins:0});const h=n.get(c);h.count++,h.totalBet+=r.bet_amount||0,h.totalWin+=r.win_amount||0,(r.win_amount||0)>(r.bet_amount||0)&&h.wins++});const j=Array.from(n.values()).sort((r,c)=>c.count-r.count).slice(0,5).map(r=>({game:r.gameName,provider:r.providerName,count:r.count,winRate:r.count>0?r.wins/r.count*100:0,netProfit:r.totalWin-r.totalBet})),b=new Array(24).fill(0);t.forEach(r=>{const c=new Date(r.played_at).getHours();b[c]++});const z=b.indexOf(Math.max(...b)),P=(b.slice(22).reduce((r,c)=>r+c,0)+b.slice(0,6).reduce((r,c)=>r+c,0))/t.length*100,F=t.map(r=>r.bet_amount||0),L=F.reduce((r,c)=>r+c,0)/t.length,B=Math.max(...F),oe=t.reduce((r,c)=>r+(c.bet_amount||0),0),S=t.reduce((r,c)=>r+(c.win_amount||0),0)-oe,q=t.filter(r=>(r.win_amount||0)>(r.bet_amount||0)).length/t.length*100;let T=0;L>1e5?T+=3:L>5e4?T+=2:L>1e4&&(T+=1),B>5e5?T+=3:B>2e5?T+=2:B>5e4&&(T+=1),S<-1e6?T+=3:S<-5e5?T+=2:S<-1e5&&(T+=1),t.length>500&&(T+=1);const s=T>=6?"HIGH":T>=3?"MEDIUM":"LOW",a=[];if(j.length>0){const r=j[0],c=(r.count/t.length*100).toFixed(1);a.push(`💎 가장 선호하는 게임은 "${r.game}"로, 전체 플레이의 ${c}%를 차지합니다.`),r.winRate>60?a.push(`✅ "${r.game}"에서 ${r.winRate.toFixed(1)}%의 높은 승률을 기록 중입니다.`):r.winRate<40&&a.push(`⚠️ "${r.game}"에서 ${r.winRate.toFixed(1)}%의 낮은 승률로, 전략 개선이 필요합니다.`)}a.push(`🕐 주로 ${z}시에 가장 활발한 활동을 보입니다.`),P>40&&a.push(`🌙 야간 시간대(22시~6시) 플레이 비율이 ${P.toFixed(1)}%로 높습니다.`),q>55?a.push(`📈 전체 승률 ${q.toFixed(1)}%로 평균 이상의 우수한 성과를 보입니다.`):q<45?a.push(`📉 전체 승률 ${q.toFixed(1)}%로 게임 전략 재검토가 필요합니다.`):a.push(`📊 전체 승률 ${q.toFixed(1)}%로 평균적인 수준입니다.`),S>0?a.push(`💰 총 ${Math.abs(S).toLocaleString()}원의 수익을 달성했습니다.`):a.push(`💸 총 ${Math.abs(S).toLocaleString()}원의 손실이 발생했습니다.`),L>5e4&&a.push(`⚡ 평균 베팅액이 ${L.toLocaleString()}원으로 고액 베팅 성향입니다.`),B/L>10&&a.push("📊 베팅 금액 변동성이 높아 일관된 베팅 전략이 필요합니다.");let i="";s==="HIGH"?i="공격적 고위험 플레이어":s==="MEDIUM"?q>50?i="적극적 안정형 플레이어":i="도전적 중위험 플레이어":L<1e4?i="보수적 저위험 플레이어":i="신중한 안정형 플레이어",xe({topGames:j,peakHour:z,nightPlayRatio:P,avgBet:L,maxBet:B,totalBets:t.length,winRate:q,netProfit:S,riskLevel:s,userType:i,insights:a})}catch(t){console.error("패턴 분석 오류:",t),d.error("패턴 분석에 실패했습니다.")}finally{y(!1)}},he=async()=>{try{Z(!0);const{md5Hash:t}=await Be(async()=>{const{md5Hash:L}=await import("./index-Cn1S8-JW.js").then(B=>B._);return{md5Hash:L}},__vite__mapDeps([0,1,2,3,4,5,6])),{data:n,error:j}=await m.from("partners").select("opcode, secret_key").eq("id",l.referrer_id).single();if(j||!n?.opcode||!n?.secret_key){d.error("파트너 API 설정을 찾을 수 없습니다."),console.error("Partner data error:",j,n);return}const b=t(n.opcode+n.secret_key),R=await(await fetch("https://vi8282.com/proxy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:"https://api.invest-ho.com/api/game/limit",method:"GET",headers:{"Content-Type":"application/json"},body:{opcode:n.opcode,signature:b}})})).json(),F=(R.DATA||R).limit||1e8;ue(F),X(F)}catch(t){console.error("에볼루션 설정 조회 오류:",t),d.error("설정을 불러오는데 실패했습니다.")}finally{Z(!1)}},be=async()=>{try{Z(!0);const{md5Hash:t}=await Be(async()=>{const{md5Hash:P}=await import("./index-Cn1S8-JW.js").then(F=>F._);return{md5Hash:P}},__vite__mapDeps([0,1,2,3,4,5,6])),{data:n,error:j}=await m.from("partners").select("opcode, secret_key").eq("id",l.referrer_id).single();if(j||!n?.opcode||!n?.secret_key){d.error("파트너 API 설정을 찾을 수 없습니다.");return}const b=t(n.opcode+n.secret_key),R=await(await fetch("https://vi8282.com/proxy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:"https://api.invest-ho.com/api/game/limit",method:"PUT",headers:{"Content-Type":"application/json"},body:{opcode:n.opcode,users:[l.username],limit:E,signature:b}})})).json();R.RESULT===!0||R.result===!0?(d.success("설정이 저장되었습니다."),ue(E)):d.error("설정 저장에 실패했습니다.")}catch(t){console.error("에볼루션 설정 저장 오류:",t),d.error("설정을 저장하는데 실패했습니다.")}finally{Z(!1)}};x.useEffect(()=>{!f||!l||(v==="basic"?re():v==="transactions"?J():v==="betting"?ne():v==="pattern"?_():v==="evolution"&&he())},[v,f,l]);const $=t=>`₩${t.toLocaleString()}`,le=t=>{const n=new Date(t);return`${n.getFullYear()}.${String(n.getMonth()+1).padStart(2,"0")}.${String(n.getDate()).padStart(2,"0")}`},ee=t=>{const n=new Date(t);return`${n.getFullYear()}.${String(n.getMonth()+1).padStart(2,"0")}.${String(n.getDate()).padStart(2,"0")} ${String(n.getHours()).padStart(2,"0")}:${String(n.getMinutes()).padStart(2,"0")}`},O=t=>{switch(t){case"approved":case"completed":return e.jsx(N,{className:"bg-green-500/20 text-green-400 border-green-500/30 text-xs",children:"승인"});case"pending":return e.jsx(N,{className:"bg-yellow-500/20 text-yellow-400 border-yellow-500/30 text-xs",children:"대기"});case"rejected":return e.jsx(N,{className:"bg-red-500/20 text-red-400 border-red-500/30 text-xs",children:"거절"});default:return e.jsx(N,{className:"text-xs",children:t})}};return l?e.jsx(ye,{open:f,onOpenChange:I,children:e.jsxs(_e,{className:"!max-w-[2400px] w-[98vw] max-h-[92vh] overflow-hidden glass-card border border-white/10 p-0",children:[e.jsxs(Se,{className:"border-b border-white/10 pb-3 pt-4 px-6",children:[e.jsxs(ke,{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-9 h-9 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center",children:e.jsx(we,{className:"h-4 w-4 text-white"})}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:l.nickname}),e.jsxs("span",{className:"text-muted-foreground text-sm",children:["(",l.username,")"]}),l.status==="active"?e.jsx(N,{className:"bg-green-500/20 text-green-400 border-green-500/30 text-xs",children:"활성"}):l.status==="suspended"?e.jsx(N,{className:"bg-red-500/20 text-red-400 border-red-500/30 text-xs",children:"정지"}):e.jsx(N,{className:"bg-yellow-500/20 text-yellow-400 border-yellow-500/30 text-xs",children:"대기"}),l.is_online&&e.jsx(N,{className:"bg-green-500/20 text-green-400 border-green-500/30 text-xs",children:"접속중"})]})})]}),e.jsx(Ce,{className:"text-xs text-muted-foreground mt-0.5 pl-12",children:"회원의 상세 정보, 입출금 내역, 베팅 내역 및 AI 게임 패턴 분석을 확인할 수 있습니다."})]}),e.jsxs(ze,{value:v,onValueChange:C,className:"w-full px-6",children:[e.jsx("div",{className:"bg-slate-800/30 rounded-xl p-1.5 border border-slate-700/40",children:e.jsxs(Ge,{className:"bg-transparent h-auto p-0 border-0 gap-2 w-full grid grid-cols-5",children:[e.jsxs(ie,{value:"basic",className:"bg-transparent text-slate-400 rounded-lg px-4 py-2.5 data-[state=active]:bg-gradient-to-br data-[state=active]:from-blue-500/20 data-[state=active]:to-cyan-500/10 data-[state=active]:text-white data-[state=active]:shadow-lg data-[state=active]:shadow-blue-500/20 data-[state=active]:border data-[state=active]:border-blue-400/30 transition-all duration-200",children:[e.jsx(we,{className:"h-3 w-3 mr-1.5"}),"기본정보"]}),e.jsxs(ie,{value:"transactions",className:"bg-transparent text-slate-400 rounded-lg px-4 py-2.5 data-[state=active]:bg-gradient-to-br data-[state=active]:from-green-500/20 data-[state=active]:to-emerald-500/10 data-[state=active]:text-white data-[state=active]:shadow-lg data-[state=active]:shadow-green-500/20 data-[state=active]:border data-[state=active]:border-green-400/30 transition-all duration-200",children:[e.jsx(Ne,{className:"h-3 w-3 mr-1.5"}),"입출금내역"]}),e.jsxs(ie,{value:"betting",className:"bg-transparent text-slate-400 rounded-lg px-4 py-2.5 data-[state=active]:bg-gradient-to-br data-[state=active]:from-purple-500/20 data-[state=active]:to-pink-500/10 data-[state=active]:text-white data-[state=active]:shadow-lg data-[state=active]:shadow-purple-500/20 data-[state=active]:border data-[state=active]:border-purple-400/30 transition-all duration-200",children:[e.jsx(ve,{className:"h-3 w-3 mr-1.5"}),"베팅내역"]}),e.jsxs(ie,{value:"pattern",className:"bg-transparent text-slate-400 rounded-lg px-4 py-2.5 data-[state=active]:bg-gradient-to-br data-[state=active]:from-orange-500/20 data-[state=active]:to-amber-500/10 data-[state=active]:text-white data-[state=active]:shadow-lg data-[state=active]:shadow-orange-500/20 data-[state=active]:border data-[state=active]:border-orange-400/30 transition-all duration-200",children:[e.jsx(pe,{className:"h-3 w-3 mr-1.5"}),"AI 게임패턴"]}),e.jsxs(ie,{value:"evolution",className:"bg-transparent text-slate-400 rounded-lg px-4 py-2.5 data-[state=active]:bg-gradient-to-br data-[state=active]:from-red-500/20 data-[state=active]:to-rose-500/10 data-[state=active]:text-white data-[state=active]:shadow-lg data-[state=active]:shadow-red-500/20 data-[state=active]:border data-[state=active]:border-red-400/30 transition-all duration-200",children:[e.jsx(De,{className:"h-3 w-3 mr-1.5"}),"에볼루션 설정"]})]})}),e.jsx(ce,{value:"basic",className:"max-h-[calc(92vh-140px)] overflow-y-auto pr-2 pt-3",children:u?e.jsx(te,{}):e.jsxs("div",{className:"space-y-4 p-4",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"flex items-center gap-2 mb-3",children:[e.jsx(we,{className:"h-3.5 w-3.5 text-blue-400"}),e.jsx("span",{className:"text-xs",children:"기본 정보"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-6 gap-y-2.5",children:[e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"아이디"}),e.jsx("span",{className:"text-xs font-mono",children:l.username})]}),e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"닉네임"}),e.jsx("span",{className:"text-xs",children:l.nickname})]}),e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"가입일"}),e.jsx("span",{className:"text-xs",children:le(l.created_at)})]}),e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"가입 경과"}),e.jsxs("span",{className:"text-xs",children:[p.accountAge,"일"]})]}),e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"은행"}),e.jsx("span",{className:"text-xs",children:l.bank_name||"-"})]}),e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"계좌번호"}),e.jsx("span",{className:"text-xs font-mono",children:l.bank_account||"-"})]})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"flex items-center gap-2 mb-3",children:[e.jsx(Ne,{className:"h-3.5 w-3.5 text-emerald-400"}),e.jsx("span",{className:"text-xs",children:"잔고 정보"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-6 gap-y-2.5",children:[e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"보유금"}),e.jsx("span",{className:"text-xs font-mono",children:$(l.balance||0)})]}),e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"포인트"}),e.jsx("span",{className:"text-xs font-mono",children:$(l.points||0)})]}),e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"총 입금"}),e.jsx("span",{className:"text-xs font-mono text-blue-400",children:$(p.totalDeposit)})]}),e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"총 출금"}),e.jsx("span",{className:"text-xs font-mono text-pink-400",children:$(p.totalWithdraw)})]}),e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 rounded-lg bg-gradient-to-r from-white/10 to-white/5 border border-white/20",children:[e.jsx("span",{className:"text-xs",children:"순 입출금"}),e.jsx("span",{className:`text-xs font-mono ${p.totalDeposit-p.totalWithdraw>=0?"text-green-400":"text-red-400"}`,children:$(p.totalDeposit-p.totalWithdraw)})]}),e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 rounded-lg bg-gradient-to-r from-white/10 to-white/5 border border-white/20",children:[e.jsx("span",{className:"text-xs",children:"게임 손익"}),e.jsxs("span",{className:`text-xs font-mono ${p.totalWinAmount-p.totalBets>=0?"text-green-400":"text-red-400"}`,children:[p.totalWinAmount-p.totalBets>=0?"+":"",$(p.totalWinAmount-p.totalBets)]})]})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"flex items-center gap-2 mb-3",children:[e.jsx(He,{className:"h-3.5 w-3.5 text-amber-400"}),e.jsx("span",{className:"text-xs",children:"베팅 통계"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-6 gap-y-2.5",children:[e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"게임 플레이"}),e.jsxs("span",{className:"text-xs font-mono",children:[p.gameCount,"회"]})]}),e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"승률"}),e.jsxs("span",{className:`text-xs font-mono ${p.winRate>50?"text-green-400":"text-red-400"}`,children:[p.winRate.toFixed(1),"%"]})]}),e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"총 베팅액"}),e.jsx("span",{className:"text-xs font-mono",children:$(p.totalBets)})]}),e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"총 당첨액"}),e.jsx("span",{className:"text-xs font-mono",children:$(p.totalWinAmount)})]})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"flex items-center gap-2 mb-3",children:[e.jsx($e,{className:"h-3.5 w-3.5 text-purple-400"}),e.jsx("span",{className:"text-xs",children:"활동 정보"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-6 gap-y-2.5",children:[e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"최근 활동"}),e.jsx("span",{className:"text-xs",children:ee(p.lastActivity)})]}),e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"추천인"}),e.jsx("span",{className:"text-xs",children:l.referrer?.username||"-"})]}),l.memo&&e.jsxs("div",{className:"col-span-2 py-2 px-3 rounded-lg bg-white/5 border border-white/10",children:[e.jsx("span",{className:"text-xs text-muted-foreground block mb-1",children:"메모"}),e.jsx("span",{className:"text-xs",children:l.memo})]})]})]}),e.jsx(hs,{userId:l.id})]})}),e.jsx(ce,{value:"transactions",className:"max-h-[calc(92vh-140px)] overflow-y-auto pr-2 pt-3",children:u?e.jsx(te,{}):U.length===0?e.jsxs("div",{className:"text-center py-12 glass-card rounded-xl",children:[e.jsx(Ne,{className:"h-12 w-12 text-muted-foreground mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-muted-foreground text-xs",children:"입출금 내역이 없습니다."})]}):e.jsx("div",{className:"glass-card rounded-xl overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"border-b border-white/10",children:e.jsxs("tr",{className:"bg-white/5",children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs",children:"구분"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs",children:"상태"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs",children:"일시"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs",children:"메모"}),e.jsx("th",{className:"px-3 py-2 text-right text-xs",children:"금액"})]})}),e.jsx("tbody",{children:U.map(t=>e.jsxs("tr",{className:"border-b border-white/5 hover:bg-white/5 transition-colors",children:[e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:`p-1 rounded-lg ${t.transaction_type==="deposit"?"bg-green-500/20":"bg-red-500/20"}`,children:t.transaction_type==="deposit"?e.jsx(es,{className:"h-3 w-3 text-green-400"}):e.jsx(ss,{className:"h-3 w-3 text-red-400"})}),e.jsx("span",{className:"text-xs",children:t.transaction_type==="deposit"?"입금":"출금"})]})}),e.jsx("td",{className:"px-3 py-2",children:O(t.status)}),e.jsx("td",{className:"px-3 py-2 text-muted-foreground text-xs",children:ee(t.created_at)}),e.jsx("td",{className:"px-3 py-2 text-muted-foreground text-xs max-w-xs truncate",children:t.notes||"-"}),e.jsx("td",{className:"px-3 py-2 text-right",children:e.jsxs("span",{className:`font-mono text-xs ${t.transaction_type==="deposit"?"text-green-400":"text-red-400"}`,children:[t.transaction_type==="deposit"?"+":"-",$(t.amount)]})})]},t.id))})]})})})}),e.jsx(ce,{value:"betting",className:"max-h-[calc(92vh-140px)] overflow-y-auto pr-2 pt-3",children:u?e.jsx(te,{}):me.length===0?e.jsxs("div",{className:"text-center py-12 glass-card rounded-xl",children:[e.jsx(ve,{className:"h-12 w-12 text-muted-foreground mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-muted-foreground text-xs",children:"베팅 내역이 없습니다."})]}):e.jsx("div",{className:"glass-card rounded-xl overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"border-b border-white/10",children:e.jsxs("tr",{className:"bg-white/5",children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs",children:"게임"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs",children:"프로바이더"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs",children:"일시"}),e.jsx("th",{className:"px-3 py-2 text-right text-xs",children:"베팅"}),e.jsx("th",{className:"px-3 py-2 text-right text-xs",children:"당첨"}),e.jsx("th",{className:"px-3 py-2 text-right text-xs",children:"손익"})]})}),e.jsx("tbody",{children:me.map(t=>{const n=(t.win_amount||0)>(t.bet_amount||0),j=(t.win_amount||0)-(t.bet_amount||0);return e.jsxs("tr",{className:"border-b border-white/5 hover:bg-white/5 transition-colors",children:[e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:`p-1 rounded-lg ${n?"bg-green-500/20":"bg-red-500/20"}`,children:e.jsx(ve,{className:`h-3 w-3 ${n?"text-green-400":"text-red-400"}`})}),e.jsx("span",{className:"text-xs",children:t.game_title||`게임 ID: ${t.game_id}`})]})}),e.jsx("td",{className:"px-3 py-2 text-muted-foreground text-xs",children:t.provider_name||`프로바이더 ${t.provider_id}`}),e.jsx("td",{className:"px-3 py-2 text-muted-foreground text-xs",children:ee(t.played_at)}),e.jsx("td",{className:"px-3 py-2 text-right font-mono text-xs",children:$(t.bet_amount||0)}),e.jsx("td",{className:"px-3 py-2 text-right font-mono text-xs",children:$(t.win_amount||0)}),e.jsx("td",{className:"px-3 py-2 text-right",children:e.jsxs("span",{className:`font-mono text-xs ${n?"text-green-400":"text-red-400"}`,children:[j>=0?"+":"",$(j)]})})]},t.id)})})]})})})}),e.jsx(ce,{value:"pattern",className:"space-y-3 max-h-[calc(92vh-140px)] overflow-y-auto pr-2 pt-3",children:u?e.jsx(te,{}):D?e.jsxs("div",{className:"grid gap-3",children:[e.jsxs("div",{className:"grid gap-3 grid-cols-4",children:[e.jsx(K,{className:"glass-card metric-gradient-purple",children:e.jsxs(V,{className:"pt-3 pb-3 px-4",children:[e.jsxs("div",{className:"flex items-center gap-1.5 mb-2",children:[e.jsx(ts,{className:"h-3 w-3 text-white"}),e.jsx("h3",{className:"text-xs text-white",children:"사용자 성향"})]}),e.jsx("p",{className:"text-sm font-bold text-white mb-1",children:D.userType}),e.jsx("p",{className:"text-xs text-white/80",children:"베팅 패턴 종합 분석"})]})}),e.jsx(K,{className:"glass-card",children:e.jsxs(V,{className:"pt-3 pb-3 px-4",children:[e.jsxs("div",{className:"flex items-center gap-1.5 mb-2",children:[e.jsx(as,{className:"h-3 w-3 text-yellow-400"}),e.jsx("h3",{className:"text-xs",children:"리스크 분석"})]}),e.jsx(N,{className:`text-xs px-2 py-0.5 mb-1.5 ${D.riskLevel==="HIGH"?"bg-red-500/20 text-red-400 border-red-500/30":D.riskLevel==="MEDIUM"?"bg-yellow-500/20 text-yellow-400 border-yellow-500/30":"bg-green-500/20 text-green-400 border-green-500/30"}`,children:D.riskLevel==="HIGH"?"고위험":D.riskLevel==="MEDIUM"?"중위험":"저위험"}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["평균: ",e.jsx("span",{className:"font-mono",children:$(D.avgBet)})]})]})}),e.jsx(K,{className:"glass-card",children:e.jsxs(V,{className:"pt-3 pb-3 px-4",children:[e.jsxs("div",{className:"flex items-center gap-1.5 mb-2",children:[e.jsx(rs,{className:"h-3 w-3 text-cyan-400"}),e.jsx("h3",{className:"text-xs",children:"베팅 통계"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"총 베팅"}),e.jsxs("span",{className:"text-xs font-mono",children:[D.totalBets,"회"]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"승률"}),e.jsxs("span",{className:`text-xs font-mono ${D.winRate>50?"text-green-400":"text-red-400"}`,children:[D.winRate.toFixed(1),"%"]})]})]})]})}),e.jsx(K,{className:"glass-card",children:e.jsxs(V,{className:"pt-3 pb-3 px-4",children:[e.jsxs("div",{className:"flex items-center gap-1.5 mb-2",children:[e.jsx($e,{className:"h-3 w-3 text-orange-400"}),e.jsx("h3",{className:"text-xs",children:"시간 패턴"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"피크"}),e.jsxs("span",{className:"text-xs font-mono",children:[D.peakHour,"시"]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"야간"}),e.jsxs("span",{className:"text-xs font-mono",children:[D.nightPlayRatio.toFixed(1),"%"]})]})]})]})})]}),e.jsx(K,{className:"glass-card",children:e.jsxs(V,{className:"pt-3 pb-3 px-4",children:[e.jsxs("div",{className:"flex items-center gap-1.5 mb-2 pb-2 border-b border-white/10",children:[e.jsx(ns,{className:"h-3 w-3 text-yellow-400"}),e.jsx("h3",{className:"text-xs",children:"선호 게임 TOP 5"})]}),e.jsx("div",{className:"grid grid-cols-5 gap-2",children:D.topGames.map((t,n)=>e.jsxs("div",{className:"p-2 rounded-lg bg-white/5 hover:bg-white/10 transition-colors",children:[e.jsxs(N,{className:"bg-blue-500/20 text-blue-400 border-blue-500/30 text-xs px-1.5 py-0.5 mb-1.5",children:[n+1,"위"]}),e.jsx("p",{className:"text-xs mb-0.5 truncate",children:t.game}),e.jsx("p",{className:"text-xs text-muted-foreground mb-1.5 truncate",children:t.provider}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsxs("p",{className:"font-mono text-xs",children:[t.count,"회"]}),e.jsxs("p",{className:`text-xs ${t.winRate>50?"text-green-400":"text-red-400"}`,children:["승률 ",t.winRate.toFixed(1),"%"]})]})]},n))})]})}),e.jsx(K,{className:"glass-card",children:e.jsxs(V,{className:"pt-3 pb-3 px-4",children:[e.jsxs("div",{className:"flex items-center gap-1.5 mb-2 pb-2 border-b border-white/10",children:[e.jsx(pe,{className:"h-3 w-3 text-purple-400"}),e.jsx("h3",{className:"text-xs",children:"AI 분석 인사이트"})]}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:D.insights.map((t,n)=>e.jsxs("div",{className:"flex items-start gap-1.5 p-2 rounded-lg bg-purple-500/10 border border-purple-500/20 hover:bg-purple-500/15 transition-colors",children:[e.jsx(pe,{className:"h-3 w-3 text-purple-400 mt-0.5 flex-shrink-0"}),e.jsx("p",{className:"text-xs leading-relaxed",children:t})]},n))})]})})]}):e.jsxs("div",{className:"text-center py-12 glass-card rounded-xl",children:[e.jsx(pe,{className:"h-12 w-12 text-muted-foreground mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-muted-foreground text-xs mb-2",children:"분석할 베팅 데이터가 부족합니다."})]})}),e.jsx(ce,{value:"evolution",className:"max-h-[calc(92vh-140px)] overflow-y-auto pr-2 pt-3",children:Y?e.jsx(te,{}):e.jsx("div",{className:"space-y-4 p-4",children:e.jsx(K,{className:"glass-card",children:e.jsxs(V,{className:"pt-6 pb-6 px-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4 pb-3 border-b border-white/10",children:[e.jsx(De,{className:"h-4 w-4 text-red-400"}),e.jsx("h3",{className:"text-sm",children:"에볼루션 최대배팅금 설정"})]}),e.jsxs("div",{className:"space-y-4",children:[Q!==null&&e.jsx("div",{className:"p-4 rounded-lg bg-blue-500/10 border border-blue-500/30",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs text-slate-400",children:"현재 설정"}),e.jsxs("span",{className:"font-mono text-blue-400",children:[Q.toLocaleString(),"원"]})]})}),e.jsxs("div",{className:"p-4 rounded-lg bg-slate-800/30 border border-slate-700",children:[e.jsx("div",{className:"text-xs text-slate-400 mb-2",children:"회원 아이디"}),e.jsx("div",{className:"font-mono text-white",children:l.username})]}),e.jsxs("div",{children:[e.jsx(H,{className:"text-xs text-slate-400 mb-2",children:"최대배팅금액"}),e.jsx(W,{type:"number",value:E,onChange:t=>{const n=parseInt(t.target.value)||0;X(n)},className:"bg-slate-800/50 border-slate-700 text-white font-mono",placeholder:"금액 입력"}),e.jsxs("p",{className:"text-xs text-slate-500 mt-1.5",children:[E.toLocaleString(),"원"]})]}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:[{value:1e5,label:"1십만"},{value:5e5,label:"5십만"},{value:1e6,label:"1백만"},{value:5e6,label:"5백만"},{value:1e7,label:"1천만"},{value:5e7,label:"5천만"},{value:1e8,label:"10천만"}].map(t=>e.jsx(k,{variant:"outline",size:"sm",onClick:()=>X(n=>n+t.value),className:"bg-slate-800/50 border-slate-700 hover:bg-slate-700 text-xs font-mono",children:t.label},t.value))}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(k,{variant:"outline",onClick:()=>X(Q||1e8),className:"flex-1 border-slate-700 text-slate-300 hover:bg-slate-700/50",children:"초기화"}),e.jsx(k,{onClick:be,disabled:Y,className:"flex-1 bg-gradient-to-r from-red-500 to-rose-600 hover:from-red-600 hover:to-rose-700",children:Y?"저장 중...":"저장"})]})]})]})})})})]})]})}):null}const gs={1:"시스템관리자",2:"대본사",3:"본사",4:"부본사",5:"총판",6:"매장",7:"사용자"};function fs(){const{authState:l}=qe(),[f,I]=x.useState(null),[v,C]=x.useState(!0);return x.useEffect(()=>{(async()=>{if(!l.user?.id){C(!1);return}try{const{data:y,error:U}=await m.from("partners").select("level").eq("id",l.user.id).maybeSingle();U?(console.error("사용자 레벨 확인 오류:",U),I(null)):y?I(y.level||null):(console.log("파트너가 아닙니다. 일반 사용자로 판단합니다."),I(7))}catch(y){console.error("사용자 레벨 확인 실패:",y),I(null)}finally{C(!1)}})()},[l.user?.id]),{userLevel:f,loading:v,isSystemAdmin:f===1,canManageUsers:f&&f<=6,getLevelName:u=>gs[u]||"알 수 없음"}}const bs=["KB국민은행","신한은행","우리은행","하나은행","농협은행","IBK기업은행","부산은행","대구은행","광주은행","전북은행","경남은행","제주은행","SC제일은행","HSBC은행","KDB산업은행","NH농협은행","신협중앙회","우체국예금보험","새마을금고","카카오뱅크","케이뱅크","토스뱅크"];function Ps(){const{authState:l}=qe(),{lastMessage:f,connected:I,sendMessage:v}=Ke();fs();const[C,u]=x.useState([]),[y,U]=x.useState(!0),[g,me]=x.useState(""),[ae,D]=x.useState("all"),[xe,p]=x.useState(!1),[fe,E]=x.useState(!1),[X,Q]=x.useState(!1),[ue,Y]=x.useState(!1),[Z,re]=x.useState("deposit"),[J,ne]=x.useState(null),[_,he]=x.useState(null),[be,$]=x.useState(null),[le,ee]=x.useState(!1),[O,t]=x.useState(null),[n,j]=x.useState({username:"",nickname:"",password:"",bank_name:"",bank_account:"",memo:""}),b=async(s=!1)=>{try{s||U(!0);let a=[];if(l.user?.level===1){const{data:r,error:c}=await m.from("users").select(`
            *,
            balance_sync_call_count,
            balance_sync_started_at,
            referrer:partners!referrer_id(
              id,
              username,
              level,
              opcode,
              secret_key,
              api_token
            )
          `).order("created_at",{ascending:!1});if(c)throw c;u(r||[]);return}else{const{data:r}=await m.rpc("get_hierarchical_partners",{p_partner_id:l.user?.id});a=[l.user?.id||"",...r?.map(c=>c.id)||[]]}const{data:o,error:i}=await m.from("users").select(`
          *,
          balance_sync_call_count,
          balance_sync_started_at,
          referrer:partners!referrer_id(
            id,
            username,
            level,
            opcode,
            secret_key,
            api_token
          )
        `).in("referrer_id",a).order("created_at",{ascending:!1});if(i)throw i;u(o||[])}catch(a){console.error("❌ 회원 목록 조회 실패:",a),s||d.error("회원 목록을 불러오는데 실패했습니다."),u([])}finally{s||U(!1)}};x.useEffect(()=>{b()},[l.user?.id,l.user?.level]),x.useEffect(()=>{const s=m.channel("users-changes").on("postgres_changes",{event:"*",schema:"public",table:"users"},a=>{console.log("👥 users 테이블 변경 감지:",a),b(!0)}).subscribe();return()=>{m.removeChannel(s)}},[]),x.useEffect(()=>{(f?.type==="user_balance_updated"||f?.type==="user_updated")&&(console.log("🔔 사용자 업데이트 알림 수신:",f),b(!0))},[f]);const z=async()=>{if(!n.username||!n.password){d.error("아이디와 비밀번호는 필수입니다.");return}try{if(console.log("👤 새 회원 생성 시작:",n.username),!l.user?.opcode||!l.user?.secret_key){d.error("OPCODE 정보가 없습니다. 상위 파트너에게 문의하세요.");return}console.log("🌐 외부 API 계정 생성 요청:",{opcode:l.user.opcode,username:n.username});const s=await Ee(l.user.opcode,n.username,l.user.secret_key);if(s.error){console.error("❌ 외부 API 계정 생성 실패:",s.error),d.error(`외부 API 계정 생성 실패: ${s.error}`);return}console.log("✅ 외부 API 계정 생성 성공:",s.data);const{data:a,error:o}=await m.from("users").insert({username:n.username,nickname:n.nickname||n.username,password_hash:n.password,bank_name:n.bank_name||null,bank_account:n.bank_account||null,memo:n.memo||null,referrer_id:l.user?.id,status:"active",balance:0,points:0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(o){console.error("❌ 회원 생성 DB 오류:",o),d.error(`DB 저장 실패: ${o.message}`);return}console.log("✅ DB 회원 생성 완료:",a),d.success(`회원 ${n.username}이 성공적으로 생성되었습니다.`),p(!1),j({username:"",nickname:"",password:"",bank_name:"",bank_account:"",memo:""}),await b()}catch(s){console.error("❌ 회원 생성 전체 오류:",s),d.error(s.message||"회원 생성에 실패했습니다.")}},R=async(s,a)=>{const o=C.find(i=>i.id===s);if(!o){d.error("사용자 정보를 찾을 수 없습니다.");return}u(i=>i.map(r=>r.id===s?{...r,status:"active",updated_at:new Date().toISOString()}:r));try{t(s),console.log("✅ 회원 승인 처리 시작:",a);const i=o.referrer?.opcode||"",r=o.referrer?.secret_key||"";if(!i||!r)console.warn("⚠️ 파트너 API 설정이 없어 외부 API 동기화 스킵");else{console.log("🌐 외부 API 서버에 계정 생성 요청:",{opcode:i,username:a});const h=await Ee(i,a,r);if(h.error){u(A=>A.map(M=>M.id===s?{...M,status:"pending"}:M)),d.error(`외부 API 동기화 실패: ${h.error}`),console.error("❌ 외부 API 계정 생성 실패:",h.error);return}console.log("✅ 외부 API 계정 생성 성공:",h.data)}const{error:c}=await m.from("users").update({status:"active",updated_at:new Date().toISOString()}).eq("id",s);if(c)throw u(h=>h.map(A=>A.id===s?{...A,status:"pending"}:A)),console.error("❌ 회원 승인 DB 오류:",c),c;d.success(`회원 ${a}이 승인되었습니다. (외부 API 동기화 완료)`)}catch(i){console.error("회원 승인 실패:",i),d.error(i.message||"회원 승인에 실패했습니다.")}finally{t(null)}},P=async(s,a)=>{const o=C.find(i=>i.id===s);u(i=>i.filter(r=>r.id!==s));try{t(s),console.log("❌ 회원 가입 거절:",a);const{error:i}=await m.from("users").update({status:"blocked",memo:(o?.memo||"")+" [가입 거절됨]",updated_at:new Date().toISOString()}).eq("id",s);if(i)throw o&&u(r=>[...r,o]),console.error("❌ 회원 거절 오류:",i),i;d.success(`회원 ${a}의 가입이 거절되었습니다.`)}catch(i){console.error("회원 거절 실패:",i),d.error(i.message||"회원 거절에 실패했습니다.")}finally{t(null)}},F=async()=>{if(!_)return;const s=_;u(a=>a.filter(o=>o.id!==_.id)),E(!1);try{ee(!0),console.log("🗑️ 회원 삭제 처리:",_.username);const{error:a}=await m.from("user_sessions").delete().eq("user_id",_.id);a&&console.warn("⚠️ 게임 세션 삭제 중 오류:",a);const{error:o}=await m.from("message_queue").delete().eq("sender_id",_.id);o&&console.warn("⚠️ 메��지 큐 (발송자) 삭제 중 오류:",o);const{error:i}=await m.from("message_queue").delete().eq("target_id",_.id);i&&console.warn("⚠️ 메시지 큐 (수신자) 삭제 중 오류:",i);const{error:r}=await m.from("notifications").delete().eq("recipient_id",_.id);r&&console.warn("⚠️ 알림 삭제 중 오류:",r);const{error:c}=await m.from("realtime_notifications").delete().eq("recipient_id",_.id);c&&console.warn("⚠️ 실시간 알림 삭제 중 오류:",c);const{error:h}=await m.from("transactions").delete().eq("user_id",_.id);if(h){console.error("❌ 트랜잭션 삭제 중 오류:",h),u(se=>[...se,s]),d.error("회원의 거래 내역 삭제에 실패했습니다."),E(!0);return}const{error:A}=await m.from("game_records").delete().eq("user_id",_.id);A&&console.warn("⚠️ 게임 기록 삭제 중 오류:",A);const{error:M}=await m.from("users").delete().eq("id",_.id);if(M)throw u(se=>[...se,s]),console.error("❌ 회원 삭제 오류:",M),M;console.log("✅ 회원 삭제 완료:",_.username),d.success(`회원 ${_.username}이 삭제되었습니다.`),he(null)}catch(a){console.error("회원 삭제 실패:",a),d.error(a.message||"회원 삭제에 실패했습니다."),E(!0)}finally{ee(!1)}},L=async s=>{try{t(s.targetId);const a=C.find(We=>We.id===s.targetId);if(!a){d.error("사용자를 찾을 수 없습니다.");return}if(console.log(`💰 강제 ${s.type==="deposit"?"입금":"출금"} 처리 시작:`,a.username,s.amount),!l.user){d.error("로그인 정보가 없습니다.");return}const{data:o,error:i}=await m.from("partners").select("balance, level, nickname, partner_type").eq("id",l.user.id).single();if(i||!o){d.error("관리자 정보를 찾을 수 없습니다.");return}const r=o.level===1;if(s.type==="deposit"&&!r&&o.balance<s.amount){d.error(`관리자 보유금이 부족합니다. (현재: ${o.balance.toLocaleString()}원)`);return}const c=await Ve(l.user);if(!c){d.error("관리자 API 설정을 찾을 수 없습니다."),console.error("❌ opcodeConfig가 없습니다. partners 테이블에 opcode, api_token, secret_key를 설정하세요.");return}const h=Ye(c)?c.opcodes[0]:c;if(!h){d.error("사용 가능한 OPCODE가 없습니다.");return}const A=s.type==="deposit"?await Je(a.username,s.amount,h.opcode,h.token,h.secretKey):await Xe(a.username,s.amount,h.opcode,h.token,h.secretKey);if(!A.success||A.error){d.error(`API ${s.type==="deposit"?"입금":"출금"} 실패: ${A.error||"알 수 없는 오류"}`),console.error(`API ${s.type==="deposit"?"입금":"출금"} 실패:`,A.error);return}console.log(`✅ API ${s.type==="deposit"?"입금":"출금"} 성공:`,A.data);const M=Qe(A.data,a.username);console.log("💰 실제 잔고:",M);const{error:se}=await m.from("transactions").insert({user_id:a.id,partner_id:l.user?.id,transaction_type:s.type==="deposit"?"admin_deposit":"admin_withdrawal",amount:s.amount,status:"completed",processed_by:l.user?.id,memo:s.memo||`[관리자 강제 ${s.type==="deposit"?"입금":"출금"}] ${l.user?.username}`,balance_before:a.balance||0,balance_after:M,external_response:A.data});if(se)throw se;const{error:Ae}=await m.from("users").update({balance:M,updated_at:new Date().toISOString()}).eq("id",a.id);if(Ae)throw Ae;let G=o.balance;s.type==="deposit"?(G=o.balance-s.amount,await m.from("partners").update({balance:G,updated_at:new Date().toISOString()}).eq("id",l.user.id),await m.from("partner_balance_logs").insert({partner_id:l.user.id,balance_before:o.balance,balance_after:G,amount:-s.amount,transaction_type:"withdrawal",from_partner_id:l.user.id,to_partner_id:null,processed_by:l.user.id,memo:`[회원 강제입금] ${a.username}에게 ${s.amount.toLocaleString()}원 입금${s.memo?`: ${s.memo}`:""}`}),console.log(`💸 관리자 보유금 차감: ${o.balance.toLocaleString()}원 → ${G.toLocaleString()}원`)):(G=o.balance+s.amount,await m.from("partners").update({balance:G,updated_at:new Date().toISOString()}).eq("id",l.user.id),await m.from("partner_balance_logs").insert({partner_id:l.user.id,balance_before:o.balance,balance_after:G,amount:s.amount,transaction_type:"deposit",from_partner_id:null,to_partner_id:l.user.id,processed_by:l.user.id,memo:`[회원 강제출금] ${a.username}으로부터 ${s.amount.toLocaleString()}원 회수${s.memo?`: ${s.memo}`:""}`}),console.log(`💰 관리자 보유금 증가: ${o.balance.toLocaleString()}원 → ${G.toLocaleString()}원`)),I&&v&&(v({type:"user_balance_updated",data:{userId:a.id,amount:s.amount,type:s.type}}),v({type:"partner_balance_updated",data:{partnerId:l.user.id,amount:s.type==="deposit"?-s.amount:s.amount,type:s.type==="deposit"?"withdrawal":"deposit"}})),d.success(`${a.username}님에게서 ${s.amount.toLocaleString()}원이 ${s.type==="deposit"?"입금":"출금"}되었습니다.`),await b()}catch(a){throw console.error("강제 입출금 처리 실패:",a),d.error(a.message||"강제 입출금 처리에 실패했습니다."),a}finally{t(null)}},B=s=>{ne(s),re("deposit"),Y(!0)},oe=s=>{ne(s),re("withdrawal"),Y(!0)},w=async s=>{if(!s)return;const a=s.status==="suspended",o=a?"active":"suspended",i=a?(s.memo||"").replace(/\s*\[차단됨.*?\]/g,""):(s.memo||"")+" [차단됨: 관리자 조치]";u(r=>r.map(c=>c.id===s.id?{...c,status:o,memo:i,updated_at:new Date().toISOString()}:c));try{t(s.id),console.log("🚫 회원 차단/해제:",s.username,o);const{error:r}=await m.from("users").update({status:o,memo:i,updated_at:new Date().toISOString()}).eq("id",s.id);if(r)throw u(c=>c.map(h=>h.id===s.id?{...h,status:s.status,memo:s.memo}:h)),r;d.success(`${s.username}님이 ${a?"차단 해제":"차단"}되었습니다.`)}catch(r){console.error("회원 차단/해제 실패:",r),d.error(r.message||"회원 차단/해제에 실패했습니다.")}finally{t(null)}},S=async s=>{if(!s)return;const a=s.status==="blocked";a||u(o=>o.filter(i=>i.id!==s.id));try{if(t(s.id),console.log("🚨 블랙리스트 처리:",s.username),a){const{data:o,error:i}=await m.rpc("remove_user_from_blacklist_simple",{p_user_id:s.id,p_admin_id:l.user?.id});if(i)throw i;const r=Array.isArray(o)?o[0]:o;if(!r.success)throw new Error(r.error);d.success(`${s.username}님이 블랙리스트에서 해제되었습니다.`)}else{const{data:o,error:i}=await m.rpc("add_user_to_blacklist_simple",{p_user_id:s.id,p_admin_id:l.user?.id,p_reason:"관리자 조치"});if(i)throw u(c=>[...c,s]),i;const r=Array.isArray(o)?o[0]:o;if(!r.success)throw u(c=>[...c,s]),new Error(r.error);d.success(`${s.username}님이 블랙리스트에 추가되었습니다.`)}}catch(o){console.error("블랙리스트 처리 실패:",o),d.error(o.message||"블랙리스트 처리에 실패했습니다.")}finally{t(null)}};x.useEffect(()=>{f?.type==="user_registered"&&(console.log("🔔 새 회원 가입 알림 수신"),b(),d.info("새로운 회원 가입 신청이 있습니다."))},[f,b]);const je=C.filter(s=>{if(s.status==="blocked")return!1;const a=g===""||s.username?.toLowerCase().includes(g.toLowerCase())||s.nickname?.toLowerCase().includes(g.toLowerCase())||s.email?.toLowerCase().includes(g.toLowerCase())||s.phone?.includes(g)||s.bank_name?.toLowerCase().includes(g.toLowerCase())||s.bank_account?.includes(g)||s.balance?.toString().includes(g)||s.points?.toString().includes(g)||s.memo?.toLowerCase().includes(g.toLowerCase()),o=ae==="all"||s.status===ae;return a&&o}),q=C.filter(s=>s.status==="pending").slice(0,5),T=[{key:"username",header:"아이디"},{key:"nickname",header:"닉네임"},{key:"referrer_info",header:"소속",cell:s=>e.jsx("span",{className:"text-sm text-slate-300",children:s.referrer?s.referrer.username:"미지정"})},{key:"status",header:"상태",cell:s=>s.status==="active"?e.jsx(N,{className:"px-3 py-1 bg-gradient-to-r from-emerald-500/20 to-teal-500/20 text-emerald-400 border border-emerald-500/50 rounded-full shadow-[0_0_10px_rgba(16,185,129,0.5)]",children:"● 승인됨"}):s.status==="pending"?e.jsx(N,{className:"px-3 py-1 bg-gradient-to-r from-orange-500/20 to-amber-500/20 text-orange-400 border border-orange-500/50 rounded-full shadow-[0_0_10px_rgba(251,146,60,0.5)]",children:"● 대기중"}):s.status==="suspended"?e.jsx(N,{className:"px-3 py-1 bg-gradient-to-r from-slate-500/20 to-gray-500/20 text-slate-400 border border-slate-500/50 rounded-full shadow-[0_0_10px_rgba(100,116,139,0.5)]",children:"● 차단됨"}):null},{key:"balance",header:"보유금",cell:s=>e.jsxs("span",{className:"font-mono font-semibold text-cyan-400",children:[(s.balance||0).toLocaleString(),"원"]})},{key:"points",header:"포인트",cell:s=>e.jsxs("span",{className:"font-mono font-semibold text-purple-400",children:[(s.points||0).toLocaleString(),"P"]})},{key:"vip_level",header:"레벨",cell:s=>{const a=s.vip_level||0;return a===0?e.jsx(N,{className:"px-3 py-1 bg-slate-700/50 text-slate-300 border border-slate-600/50 rounded-full",children:"○ Silver"}):a===1?e.jsx(N,{className:"px-3 py-1 bg-gradient-to-r from-yellow-500/20 to-amber-500/20 text-yellow-400 border border-yellow-500/50 rounded-full shadow-[0_0_10px_rgba(234,179,8,0.5)]",children:"⚡ Gold"}):a===2?e.jsx(N,{className:"px-3 py-1 bg-gradient-to-r from-orange-500/20 to-red-500/20 text-orange-400 border border-orange-500/50 rounded-full shadow-[0_0_10px_rgba(251,146,60,0.5)]",children:"⚡ Bronze"}):e.jsx(N,{className:"px-3 py-1 bg-gradient-to-r from-purple-500/20 to-pink-500/20 text-purple-400 border border-purple-500/50 rounded-full shadow-[0_0_10px_rgba(168,85,247,0.5)]",children:"⚡ VIP"})}},{key:"created_at",header:"가입일",cell:s=>{const a=new Date(s.created_at),o=a.getFullYear(),i=a.getMonth()+1,r=a.getDate();return e.jsxs("span",{className:"text-slate-400 text-sm",children:[o,". ",i,". ",r,"."]})}},{key:"last_login_at",header:"최근접속",cell:s=>{if(!s.last_login_at)return e.jsx("span",{className:"text-slate-500 text-sm",children:"미접속"});const a=new Date(s.last_login_at),o=a.getFullYear(),i=a.getMonth()+1,r=a.getDate();return e.jsxs("span",{className:"text-slate-400 text-sm",children:[o,". ",i,". ",r,"."]})}},{key:"is_online",header:"접속",cell:s=>s.is_online?e.jsx(N,{className:"bg-gradient-to-r from-green-500 to-emerald-500 text-white border-0 animate-pulse",children:"● 온라인"}):e.jsx(N,{className:"bg-slate-600 text-slate-300 border-0",children:"○ 오프라인"})},{key:"created_at_old",header:"가입일",cell:s=>new Date(s.created_at).toLocaleDateString("ko-KR")},{key:"actions",header:"관리",cell:s=>s.status==="pending"?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(k,{size:"sm",onClick:()=>R(s.id,s.username),disabled:O===s.id,className:"btn-premium-success",children:O===s.id?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):e.jsxs(e.Fragment,{children:[e.jsx(ds,{className:"h-4 w-4 mr-1"}),"승인"]})}),e.jsx(k,{size:"sm",onClick:()=>P(s.id,s.username),disabled:O===s.id,className:"btn-premium-danger",children:O===s.id?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):e.jsxs(e.Fragment,{children:[e.jsx(ms,{className:"h-4 w-4 mr-1"}),"거절"]})})]}):e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(k,{size:"sm",variant:"outline",onClick:()=>{$(s),Q(!0)},title:"상세 정보",children:e.jsx(xs,{className:"h-4 w-4"})}),e.jsx(k,{size:"sm",variant:"outline",onClick:()=>B(s),className:"text-green-600 hover:text-green-700",title:"입금",children:e.jsx(Oe,{className:"h-4 w-4"})}),e.jsx(k,{size:"sm",variant:"outline",onClick:()=>oe(s),className:"text-red-600 hover:text-red-700",title:"출금",children:e.jsx(Oe,{className:"h-4 w-4"})}),e.jsx(k,{size:"sm",variant:"outline",onClick:()=>w(s),disabled:O===s.id,className:s.status==="suspended"?"text-blue-600 hover:text-blue-700":"text-orange-600 hover:text-orange-700",title:s.status==="suspended"?"차단 해제":"차단",children:O===s.id?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-current"}):s.status==="suspended"?e.jsx(Me,{className:"h-4 w-4"}):e.jsx(Re,{className:"h-4 w-4"})}),e.jsx(k,{size:"sm",variant:"outline",onClick:()=>S(s),disabled:O===s.id,className:"text-red-800 hover:text-red-900",title:"블랙리스트 추가",children:O===s.id?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-current"}):e.jsx(Re,{className:"h-4 w-4"})}),e.jsx(k,{size:"sm",variant:"outline",onClick:()=>{he(s),E(!0)},className:"text-red-600 hover:text-red-700",title:"회원 삭제",children:e.jsx(Ue,{className:"h-4 w-4"})})]})}];return y?e.jsx(te,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-100",children:"회원 관리"}),e.jsx("p",{className:"text-sm text-slate-400",children:"시스템에 등록된 회원들을 관리합니다."})]}),e.jsxs(k,{onClick:()=>p(!0),className:"btn-premium-primary",children:[e.jsx(ls,{className:"h-4 w-4 mr-2"}),"새 회원 생성"]})]}),e.jsxs("div",{className:"grid gap-5 md:grid-cols-2 lg:grid-cols-4",children:[e.jsx(ge,{title:"전체 회원",value:C.length.toLocaleString(),subtitle:"↑ 등록 회원 수",icon:os,color:"purple"}),e.jsx(ge,{title:"승인대기",value:q.length.toLocaleString(),subtitle:"대기 중인 회원",icon:$e,color:"amber"}),e.jsx(ge,{title:"활성 회원",value:C.filter(s=>s.status==="active").length.toLocaleString(),subtitle:"정상 활동 회원",icon:Me,color:"green"}),e.jsx(ge,{title:"온라인",value:C.filter(s=>s.is_online).length.toLocaleString(),subtitle:"실시간 접속자",icon:He,color:"cyan"})]}),e.jsxs("div",{className:"glass-card rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6 pb-4 border-b border-slate-700/50",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-slate-100 mb-1",children:"회원 목록"}),e.jsxs("p",{className:"text-sm text-slate-400",children:["총 ",je.length.toLocaleString(),"명의 회원을 관리하고 있습니다"]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"relative w-96",children:[e.jsx(is,{className:"absolute left-3 top-2.5 h-4 w-4 text-slate-400"}),e.jsx(W,{placeholder:"아이디, 닉네임, 이메일, 전화번호, 은행정보, 잔고, 포인트, 메모 검색",className:"pl-10 input-premium",value:g,onChange:s=>me(s.target.value)})]}),e.jsxs(Le,{value:ae,onValueChange:D,children:[e.jsxs(Te,{className:"w-[160px] input-premium",children:[e.jsx(cs,{className:"h-4 w-4 mr-2"}),e.jsx(Pe,{placeholder:"상태 필터"})]}),e.jsxs(Ie,{className:"bg-slate-800 border-slate-700",children:[e.jsx(de,{value:"all",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-slate-500"}),"전체"]})}),e.jsx(de,{value:"pending",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-amber-500"}),"승인대기"]})}),e.jsx(de,{value:"active",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-emerald-500"}),"활성"]})}),e.jsx(de,{value:"suspended",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-slate-500"}),"차단"]})})]})]})]})]}),e.jsx(Ze,{columns:T,data:je,searchable:!1,emptyMessage:g?"검색 결과가 없습니다.":"등록된 회원이 없습니다."})]}),e.jsx(ye,{open:xe,onOpenChange:p,children:e.jsxs(_e,{className:"sm:max-w-[500px] bg-slate-900/90 backdrop-blur-md border-slate-700/60 shadow-2xl shadow-blue-500/20",children:[e.jsxs(Se,{children:[e.jsx(ke,{className:"text-xl text-slate-100 bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent",children:"새 회원 생성"}),e.jsx(Ce,{className:"text-slate-400",children:"새로운 회원을 시스템에 등록합니다. 외부 API와 연동됩니다."})]}),e.jsxs("div",{className:"grid gap-5 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"username",className:"text-right text-slate-300",children:"아이디"}),e.jsx(W,{id:"username",value:n.username,onChange:s=>j(a=>({...a,username:s.target.value})),className:"col-span-3 input-premium focus:border-blue-500/60 focus:ring-2 focus:ring-blue-500/20",placeholder:"회원 아이디 입력"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"nickname",className:"text-right text-slate-300",children:"닉네임"}),e.jsx(W,{id:"nickname",value:n.nickname,onChange:s=>j(a=>({...a,nickname:s.target.value})),className:"col-span-3 input-premium focus:border-blue-500/60 focus:ring-2 focus:ring-blue-500/20",placeholder:"회원 닉네임 입력"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"password",className:"text-right text-slate-300",children:"비밀번호"}),e.jsx(W,{id:"password",type:"password",value:n.password,onChange:s=>j(a=>({...a,password:s.target.value})),className:"col-span-3 input-premium focus:border-blue-500/60 focus:ring-2 focus:ring-blue-500/20",placeholder:"초기 비밀번호 입력"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{className:"text-right text-slate-300",children:"은행명"}),e.jsxs(Le,{value:n.bank_name||void 0,onValueChange:s=>j(a=>({...a,bank_name:s})),children:[e.jsx(Te,{className:"col-span-3 input-premium focus:border-blue-500/60 focus:ring-2 focus:ring-blue-500/20",children:e.jsx(Pe,{placeholder:"은행 선택"})}),e.jsx(Ie,{className:"bg-slate-800 border-slate-700",children:bs.map(s=>e.jsx(de,{value:s,className:"text-slate-200 focus:bg-slate-700 focus:text-slate-100",children:s},s))})]})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"bank_account",className:"text-right text-slate-300",children:"계좌번호"}),e.jsx(W,{id:"bank_account",value:n.bank_account,onChange:s=>j(a=>({...a,bank_account:s.target.value})),className:"col-span-3 input-premium focus:border-blue-500/60 focus:ring-2 focus:ring-blue-500/20",placeholder:"계좌번호 입력"})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(H,{htmlFor:"memo",className:"text-right text-slate-300",children:"메모"}),e.jsx(W,{id:"memo",value:n.memo,onChange:s=>j(a=>({...a,memo:s.target.value})),className:"col-span-3 input-premium focus:border-blue-500/60 focus:ring-2 focus:ring-blue-500/20",placeholder:"관리자 메모"})]})]}),e.jsxs(Fe,{className:"gap-3",children:[e.jsx(k,{type:"button",variant:"outline",onClick:()=>p(!1),className:"bg-slate-800/50 border-slate-700 text-slate-300 hover:bg-slate-700 hover:text-slate-100",children:"취소"}),e.jsx(k,{type:"submit",onClick:z,className:"btn-premium-primary",children:"회원 생성"})]})]})}),e.jsx(ye,{open:fe,onOpenChange:E,children:e.jsxs(_e,{className:"sm:max-w-[425px] bg-slate-900/90 backdrop-blur-md border-slate-700/60 shadow-2xl shadow-red-500/20",children:[e.jsxs(Se,{children:[e.jsx(ke,{className:"text-xl text-slate-100",children:"회원 삭제 확인"}),e.jsxs(Ce,{className:"text-slate-400",children:['정말로 회원 "',_?.username,'"을(를) 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.']})]}),e.jsxs(Fe,{className:"gap-3",children:[e.jsx(k,{variant:"outline",onClick:()=>E(!1),disabled:le,className:"bg-slate-800/50 border-slate-700 text-slate-300 hover:bg-slate-700 hover:text-slate-100",children:"취소"}),e.jsx(k,{onClick:F,disabled:le,className:"btn-premium-danger",children:le?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"삭제 중..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ue,{className:"h-4 w-4 mr-2"}),"영구 삭제"]})})]})]})}),e.jsx(us,{open:ue,onOpenChange:s=>{Y(s),s||ne(null)},type:Z,targetType:"user",selectedTarget:J?{id:J.id,username:J.username,nickname:J.nickname,balance:J.balance||0}:null,onSubmit:L,onTypeChange:re}),e.jsx(ps,{user:be,isOpen:X,onClose:()=>{Q(!1),$(null)}})]})}export{Ps as UserManagement,Ps as default};
