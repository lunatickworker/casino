import{r as c,j as n}from"./react-core-CwM-CeLv.js";import{s as l,m as H,S as U,p as V,q as W,r as K,t as x,I as Y,i as $,U as G,B as X}from"./index-Cv1OAUNC.js";import{D as J}from"./DataTable-DkDQVBov.js";import{k as p}from"./vendor-CQn7sZ7L.js";import{M as S}from"./MetricCard-bDMY2zrh.js";import{d as _,R as Q,a5 as Z}from"./lucide-icons-wLPRtdhM.js";import"./radix-ui-SX2QAG6c.js";import"./supabase-r6ABpEO8.js";function ie({user:u}){const[F,C]=c.useState(!1),[w,L]=c.useState(!1),[k,B]=c.useState([]),[h,M]=c.useState("all"),[f,A]=c.useState(""),R=a=>{if(!a)return"-";const e=new Date(a),t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0"),i=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0"),m=String(e.getSeconds()).padStart(2,"0");return`${t}ë…„${r}ì›”${s}ì¼ ${i}:${o}:${m}`},E=a=>{const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),e.getDate());switch(a){case"today":return{start:t.toISOString(),end:e.toISOString()};case"week":const r=new Date(t);return r.setDate(t.getDate()-7),{start:r.toISOString(),end:e.toISOString()};case"month":const s=new Date(t);return s.setMonth(t.getMonth()-1),{start:s.toISOString(),end:e.toISOString()};default:return null}},O=async()=>{try{console.log("ğŸ”„ ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì‹œì‘"),L(!0),await G(u),await new Promise(a=>setTimeout(a,1e3)),await b(),p.success("ë² íŒ… ë‚´ì—­ì´ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.")}catch(a){console.error("âŒ ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:",a),p.error("ìƒˆë¡œê³ ì¹¨ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}finally{L(!1)}},b=async()=>{try{console.log("ğŸ”„ ë² íŒ… ë°ì´í„° ë¡œë“œ ì‹œì‘");const a=E(h);let e=[];if(u.level===1){const{data:i}=await l.from("partners").select("id");e=i?.map(o=>o.id)||[]}else{e=[u.id];const{data:i}=await l.from("partners").select("id").eq("parent_id",u.id),o=i?.map(m=>m.id)||[];if(e.push(...o),o.length>0){const{data:m}=await l.from("partners").select("id").in("parent_id",o),v=m?.map(j=>j.id)||[];if(e.push(...v),v.length>0){const{data:j}=await l.from("partners").select("id").in("parent_id",v),y=j?.map(N=>N.id)||[];if(e.push(...y),y.length>0){const{data:N}=await l.from("partners").select("id").in("parent_id",y),D=N?.map(I=>I.id)||[];if(e.push(...D),D.length>0){const{data:I}=await l.from("partners").select("id").in("parent_id",D),q=I?.map(z=>z.id)||[];e.push(...q)}}}}}console.log("ğŸ‘¥ í•˜ìœ„ íŒŒíŠ¸ë„ˆ ID ê°œìˆ˜:",e.length);let t=l.from("game_records").select("*");if(u.level===1)e.length>0&&(t=t.in("partner_id",e)),console.log("ğŸ” ì‹œìŠ¤í…œê´€ë¦¬ì: ëª¨ë“  íŒŒíŠ¸ë„ˆ ë°ì´í„° ì¡°íšŒ");else{const{data:i}=await l.from("users").select("id").in("referrer_id",e),o=i?.map(m=>m.id)||[];if(console.log("ğŸ‘¤ í•˜ìœ„ íšŒì› ID ê°œìˆ˜:",o.length),o.length>0)t=t.in("user_id",o);else{console.log("âš ï¸ í•˜ìœ„ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤."),B([]);return}}a&&(t=t.gte("played_at",a.start).lte("played_at",a.end)),t=t.order("played_at",{ascending:!1}).order("external_txid",{ascending:!1}).limit(1e3);const{data:r,error:s}=await t;if(s)throw console.error("âŒ ë² íŒ… ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:",s),s;console.log("âœ… ë² íŒ… ë°ì´í„° ë¡œë“œ ì„±ê³µ:",r?.length||0,"ê±´"),r&&r.length>0&&console.log("ğŸ“‹ ì²« ë²ˆì§¸ ë ˆì½”ë“œ:",r[0]),B(r||[])}catch(a){console.error("âŒ ë² íŒ… ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:",a),p.error("ë² íŒ… ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}},P=()=>{try{const a=[["TX ID","ì‚¬ìš©ì","ê²Œì„ëª…","ì œê³µì‚¬","ë² íŒ…ì•¡","ë‹¹ì²¨ì•¡","ë² íŒ…ì „ê¸ˆì•¡","ë² íŒ…í›„ê¸ˆì•¡","ì†ìµ","í”Œë ˆì´ ì‹œê°„"].join(","),...d.map(s=>{const i=parseFloat(s.win_amount?.toString()||"0")-parseFloat(s.bet_amount?.toString()||"0");return[s.external_txid,s.username,s.game_title||`Game ${s.game_id}`,s.provider_name||`Provider ${s.provider_id}`,s.bet_amount,s.win_amount,s.balance_before,s.balance_after,i,R(s.played_at)].join(",")})].join(`
`),e=new Blob(["\uFEFF"+a],{type:"text/csv;charset=utf-8;"}),t=document.createElement("a"),r=URL.createObjectURL(e);t.setAttribute("href",r),t.setAttribute("download",`betting_history_${h}_${new Date().toISOString().split("T")[0]}.csv`),t.style.visibility="hidden",document.body.appendChild(t),t.click(),document.body.removeChild(t),p.success("ë² íŒ… ë‚´ì—­ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ")}catch(a){console.error("ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:",a),p.error("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨")}};c.useEffect(()=>{C(!0),b().finally(()=>C(!1))},[h]),c.useEffect(()=>{console.log("ğŸ”Œ Realtime êµ¬ë… ì‹œì‘");const a=l.channel("betting-realtime").on("postgres_changes",{event:"INSERT",schema:"public",table:"game_records"},e=>{console.log("ğŸ² ì‹ ê·œ ë² íŒ… ë°ì´í„° ê°ì§€:",e),b()}).subscribe(e=>{console.log("ğŸ“¡ Realtime êµ¬ë… ìƒíƒœ:",e)});return()=>{console.log("ğŸ”Œ Realtime êµ¬ë… í•´ì œ"),l.removeChannel(a)}},[]);const d=c.useMemo(()=>k.filter(a=>{if(!f)return!0;const e=f.toLowerCase();return a.username?.toLowerCase().includes(e)||a.game_title?.toLowerCase().includes(e)||a.provider_name?.toLowerCase().includes(e)||a.external_txid?.toString().includes(e)}),[k,f]),g=c.useMemo(()=>{if(d.length>0){const a=d.reduce((t,r)=>t+parseFloat(r.bet_amount?.toString()||"0"),0),e=d.reduce((t,r)=>t+parseFloat(r.win_amount?.toString()||"0"),0);return{totalBets:d.length,totalBetAmount:a,totalWinAmount:e,netProfit:e-a}}else return{totalBets:0,totalBetAmount:0,totalWinAmount:0,netProfit:0}},[d]),T=[{key:"username",header:"ì‚¬ìš©ì",render:(a,e)=>n.jsx("span",{className:"text-blue-300 font-medium",children:e?.username})},{key:"game_title",header:"ê²Œì„ëª…",render:(a,e)=>n.jsx("span",{className:"text-slate-200",children:e?.game_title||"Korean Speed Baccarat A"})},{key:"provider",header:"ê²Œì„ì‚¬",render:(a,e)=>n.jsx(X,{variant:"secondary",className:"bg-indigo-500/20 text-indigo-300 border-indigo-400/30",children:e?.provider_name||"Evolution"})},{key:"bet_amount",header:"ë² íŒ…ì•¡",render:(a,e)=>{const t=Number(e?.bet_amount||0);return t===0?n.jsx("span",{className:"text-slate-500",children:"ë°°íŒ…ì¤‘"}):n.jsxs("span",{className:"text-orange-400 font-semibold",children:["â‚©",t.toLocaleString()]})}},{key:"win_amount",header:"ë‹¹ì²¨ì•¡",render:(a,e)=>{const t=Number(e?.win_amount||0);return t===0?n.jsx("span",{className:"text-slate-500",children:"ë°°íŒ…ì¤‘"}):n.jsxs("span",{className:"text-emerald-400 font-semibold",children:["â‚©",t.toLocaleString()]})}},{key:"balance_before",header:"ë² íŒ…ì „ì”ì•¡",render:(a,e)=>n.jsxs("span",{className:"text-slate-300",children:["â‚©",Number(e?.balance_before||0).toLocaleString()]})},{key:"balance_after",header:"ë² íŒ…í›„ê¸ˆì•¡",render:(a,e)=>n.jsxs("span",{className:"text-slate-300",children:["â‚©",Number(e?.balance_after||0).toLocaleString()]})},{key:"profit",header:"ì†ìµ",render:(a,e)=>{if(!e)return n.jsx("span",{children:"-"});const t=Number(e.win_amount||0)-Number(e.bet_amount||0),r=t>0?"text-green-400":t<0?"text-red-400":"text-slate-400",s=t>0?"bg-green-500/10":t<0?"bg-red-500/10":"";return n.jsxs("span",{className:`${r} ${s} px-2 py-1 rounded font-bold`,children:[t>0?"+":"","â‚©",t.toLocaleString()]})}},{key:"played_at",header:"í”„ë¡œë°”ì´ë” ì‹œê°„",render:(a,e)=>n.jsx("span",{className:"text-xs text-slate-400",children:R(e?.played_at)})}];return F?n.jsx(H,{}):n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[n.jsx(S,{title:"ì´ ë² íŒ… ìˆ˜",value:g.totalBets.toLocaleString(),icon:_,color:"purple"}),n.jsx(S,{title:"ì´ ë² íŒ…ì•¡",value:`â‚©${g.totalBetAmount.toLocaleString()}`,icon:_,color:"red"}),n.jsx(S,{title:"ì´ ë‹¹ì²¨ì•¡",value:`â‚©${g.totalWinAmount.toLocaleString()}`,icon:_,color:"green"}),n.jsx(S,{title:"ìˆœì†ìµ",value:`â‚©${g.netProfit.toLocaleString()}`,icon:_,color:g.netProfit>=0?"green":"red"})]}),n.jsxs("div",{className:"flex flex-col md:flex-row gap-4 items-center justify-between",children:[n.jsxs("div",{className:"flex gap-2 items-center w-full md:w-auto flex-wrap",children:[n.jsxs(U,{value:h,onValueChange:M,children:[n.jsx(V,{className:"w-[140px]",children:n.jsx(W,{placeholder:"ê¸°ê°„ ì„ íƒ"})}),n.jsxs(K,{children:[n.jsx(x,{value:"all",children:"ì „ì²´"}),n.jsx(x,{value:"today",children:"ì˜¤ëŠ˜"}),n.jsx(x,{value:"week",children:"ìµœê·¼ 7ì¼"}),n.jsx(x,{value:"month",children:"ìµœê·¼ 30ì¼"})]})]}),n.jsx(Y,{placeholder:"ì‚¬ìš©ìëª…, ê²Œì„ëª… ê²€ìƒ‰...",value:f,onChange:a=>A(a.target.value),className:"w-full md:w-[250px]"})]}),n.jsxs("div",{className:"flex gap-2",children:[n.jsxs($,{onClick:O,variant:"outline",size:"sm",disabled:w,children:[n.jsx(Q,{className:`h-4 w-4 mr-2 ${w?"animate-spin":""}`}),w?"ìƒˆë¡œê³ ì¹¨ ì¤‘...":"ìƒˆë¡œê³ ì¹¨"]}),n.jsxs($,{onClick:P,variant:"outline",size:"sm",children:[n.jsx(Z,{className:"h-4 w-4 mr-2"}),"CSV ë‹¤ìš´ë¡œë“œ"]})]})]}),n.jsx(J,{data:d,columns:T,emptyMessage:"ë² íŒ… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.",enableSearch:!1,pageSize:20})]})}export{ie as BettingHistory};
