import{r as c,s as l,j as n,L as V,Y as x,S as W,x as Y,y as q,z as K,D as S,I as U,w as $,R as G,t as p,aI as X,B as J}from"./index-DuEcnhwm.js";import{D as Q}from"./DataTable-B36ocgWm.js";import{M as _}from"./MetricCard-C8dgoA9F.js";import{D as Z}from"./download-BTwMXtJW.js";import"./search-DyNhXeLR.js";function re({user:u}){const[F,L]=c.useState(!1),[w,C]=c.useState(!1),[k,B]=c.useState([]),[h,M]=c.useState("all"),[f,A]=c.useState(""),R=a=>{if(!a)return"-";const e=new Date(a),t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0"),i=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0"),m=String(e.getSeconds()).padStart(2,"0");return`${t}년${r}월${s}일 ${i}:${o}:${m}`},E=a=>{const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),e.getDate());switch(a){case"today":return{start:t.toISOString(),end:e.toISOString()};case"week":const r=new Date(t);return r.setDate(t.getDate()-7),{start:r.toISOString(),end:e.toISOString()};case"month":const s=new Date(t);return s.setMonth(t.getMonth()-1),{start:s.toISOString(),end:e.toISOString()};default:return null}},O=async()=>{try{console.log("🔄 강제 새로고침 시작"),C(!0),await X(u),await new Promise(a=>setTimeout(a,1e3)),await b(),p.success("베팅 내역이 갱신되었습니다.")}catch(a){console.error("❌ 강제 새로고침 오류:",a),p.error("새로고침에 실패했습니다.")}finally{C(!1)}},b=async()=>{try{console.log("🔄 베팅 데이터 로드 시작");const a=E(h);let e=[];if(u.level===1){const{data:i}=await l.from("partners").select("id");e=i?.map(o=>o.id)||[]}else{e=[u.id];const{data:i}=await l.from("partners").select("id").eq("parent_id",u.id),o=i?.map(m=>m.id)||[];if(e.push(...o),o.length>0){const{data:m}=await l.from("partners").select("id").in("parent_id",o),v=m?.map(j=>j.id)||[];if(e.push(...v),v.length>0){const{data:j}=await l.from("partners").select("id").in("parent_id",v),y=j?.map(N=>N.id)||[];if(e.push(...y),y.length>0){const{data:N}=await l.from("partners").select("id").in("parent_id",y),D=N?.map(I=>I.id)||[];if(e.push(...D),D.length>0){const{data:I}=await l.from("partners").select("id").in("parent_id",D),z=I?.map(H=>H.id)||[];e.push(...z)}}}}}console.log("👥 하위 파트너 ID 개수:",e.length);let t=l.from("game_records").select("*");if(u.level===1)e.length>0&&(t=t.in("partner_id",e)),console.log("🔍 시스템관리자: 모든 파트너 데이터 조회");else{const{data:i}=await l.from("users").select("id").in("referrer_id",e),o=i?.map(m=>m.id)||[];if(console.log("👤 하위 회원 ID 개수:",o.length),o.length>0)t=t.in("user_id",o);else{console.log("⚠️ 하위 회원이 없습니다."),B([]);return}}a&&(t=t.gte("played_at",a.start).lte("played_at",a.end)),t=t.order("played_at",{ascending:!1}).order("external_txid",{ascending:!1}).limit(1e3);const{data:r,error:s}=await t;if(s)throw console.error("❌ 베팅 데이터 로드 실패:",s),s;console.log("✅ 베팅 데이터 로드 성공:",r?.length||0,"건"),r&&r.length>0&&console.log("📋 첫 번째 레코드:",r[0]),B(r||[])}catch(a){console.error("❌ 베팅 데이터 로드 오류:",a),p.error("베팅 데이터를 불러오는데 실패했습니다.")}},P=()=>{try{const a=[["TX ID","사용자","게임명","제공사","베팅액","당첨액","베팅전금액","베팅후금액","손익","플레이 시간"].join(","),...d.map(s=>{const i=parseFloat(s.win_amount?.toString()||"0")-parseFloat(s.bet_amount?.toString()||"0");return[s.external_txid,s.username,s.game_title||`Game ${s.game_id}`,s.provider_name||`Provider ${s.provider_id}`,s.bet_amount,s.win_amount,s.balance_before,s.balance_after,i,R(s.played_at)].join(",")})].join(`
`),e=new Blob(["\uFEFF"+a],{type:"text/csv;charset=utf-8;"}),t=document.createElement("a"),r=URL.createObjectURL(e);t.setAttribute("href",r),t.setAttribute("download",`betting_history_${h}_${new Date().toISOString().split("T")[0]}.csv`),t.style.visibility="hidden",document.body.appendChild(t),t.click(),document.body.removeChild(t),p.success("베팅 내역 다운로드 완료")}catch(a){console.error("다운로드 오류:",a),p.error("다운로드 실패")}};c.useEffect(()=>{L(!0),b().finally(()=>L(!1))},[h]),c.useEffect(()=>{console.log("🔌 Realtime 구독 시작");const a=l.channel("betting-realtime").on("postgres_changes",{event:"INSERT",schema:"public",table:"game_records"},e=>{console.log("🎲 신규 베팅 데이터 감지:",e),b()}).subscribe(e=>{console.log("📡 Realtime 구독 상태:",e)});return()=>{console.log("🔌 Realtime 구독 해제"),l.removeChannel(a)}},[]);const d=c.useMemo(()=>k.filter(a=>{if(!f)return!0;const e=f.toLowerCase();return a.username?.toLowerCase().includes(e)||a.game_title?.toLowerCase().includes(e)||a.provider_name?.toLowerCase().includes(e)||a.external_txid?.toString().includes(e)}),[k,f]),g=c.useMemo(()=>{if(d.length>0){const a=d.reduce((t,r)=>t+parseFloat(r.bet_amount?.toString()||"0"),0),e=d.reduce((t,r)=>t+parseFloat(r.win_amount?.toString()||"0"),0);return{totalBets:d.length,totalBetAmount:a,totalWinAmount:e,netProfit:e-a}}else return{totalBets:0,totalBetAmount:0,totalWinAmount:0,netProfit:0}},[d]),T=[{key:"username",header:"사용자",render:(a,e)=>n.jsx("span",{className:"text-blue-300 font-medium",children:e?.username})},{key:"game_title",header:"게임명",render:(a,e)=>n.jsx("span",{className:"text-slate-200",children:e?.game_title||"Korean Speed Baccarat A"})},{key:"provider",header:"게임사",render:(a,e)=>n.jsx(J,{variant:"secondary",className:"bg-indigo-500/20 text-indigo-300 border-indigo-400/30",children:e?.provider_name||"Evolution"})},{key:"bet_amount",header:"베팅액",render:(a,e)=>{const t=Number(e?.bet_amount||0);return t===0?n.jsx("span",{className:"text-slate-500",children:"배팅중"}):n.jsxs("span",{className:"text-orange-400 font-semibold",children:["₩",t.toLocaleString()]})}},{key:"win_amount",header:"당첨액",render:(a,e)=>{const t=Number(e?.win_amount||0);return t===0?n.jsx("span",{className:"text-slate-500",children:"배팅중"}):n.jsxs("span",{className:"text-emerald-400 font-semibold",children:["₩",t.toLocaleString()]})}},{key:"balance_before",header:"베팅전잔액",render:(a,e)=>n.jsxs("span",{className:"text-slate-300",children:["₩",Number(e?.balance_before||0).toLocaleString()]})},{key:"balance_after",header:"베팅후금액",render:(a,e)=>n.jsxs("span",{className:"text-slate-300",children:["₩",Number(e?.balance_after||0).toLocaleString()]})},{key:"profit",header:"손익",render:(a,e)=>{if(!e)return n.jsx("span",{children:"-"});const t=Number(e.win_amount||0)-Number(e.bet_amount||0),r=t>0?"text-green-400":t<0?"text-red-400":"text-slate-400",s=t>0?"bg-green-500/10":t<0?"bg-red-500/10":"";return n.jsxs("span",{className:`${r} ${s} px-2 py-1 rounded font-bold`,children:[t>0?"+":"","₩",t.toLocaleString()]})}},{key:"played_at",header:"프로바이더 시간",render:(a,e)=>n.jsx("span",{className:"text-xs text-slate-400",children:R(e?.played_at)})}];return F?n.jsx(V,{}):n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[n.jsx(_,{title:"총 베팅 수",value:g.totalBets.toLocaleString(),icon:x,color:"purple"}),n.jsx(_,{title:"총 베팅액",value:`₩${g.totalBetAmount.toLocaleString()}`,icon:x,color:"red"}),n.jsx(_,{title:"총 당첨액",value:`₩${g.totalWinAmount.toLocaleString()}`,icon:x,color:"green"}),n.jsx(_,{title:"순손익",value:`₩${g.netProfit.toLocaleString()}`,icon:x,color:g.netProfit>=0?"green":"red"})]}),n.jsxs("div",{className:"flex flex-col md:flex-row gap-4 items-center justify-between",children:[n.jsxs("div",{className:"flex gap-2 items-center w-full md:w-auto flex-wrap",children:[n.jsxs(W,{value:h,onValueChange:M,children:[n.jsx(Y,{className:"w-[140px]",children:n.jsx(q,{placeholder:"기간 선택"})}),n.jsxs(K,{children:[n.jsx(S,{value:"all",children:"전체"}),n.jsx(S,{value:"today",children:"오늘"}),n.jsx(S,{value:"week",children:"최근 7일"}),n.jsx(S,{value:"month",children:"최근 30일"})]})]}),n.jsx(U,{placeholder:"사용자명, 게임명 검색...",value:f,onChange:a=>A(a.target.value),className:"w-full md:w-[250px]"})]}),n.jsxs("div",{className:"flex gap-2",children:[n.jsxs($,{onClick:O,variant:"outline",size:"sm",disabled:w,children:[n.jsx(G,{className:`h-4 w-4 mr-2 ${w?"animate-spin":""}`}),w?"새로고침 중...":"새로고침"]}),n.jsxs($,{onClick:P,variant:"outline",size:"sm",children:[n.jsx(Z,{className:"h-4 w-4 mr-2"}),"CSV 다운로드"]})]})]}),n.jsx(Q,{data:d,columns:T,emptyMessage:"베팅 기록이 없습니다.",enableSearch:!1,pageSize:20})]})}export{re as BettingHistory};
