const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-Cn1S8-JW.js","assets/react-core-CwM-CeLv.js","assets/vendor-CQn7sZ7L.js","assets/radix-ui-SX2QAG6c.js","assets/lucide-icons-wLPRtdhM.js","assets/supabase-r6ABpEO8.js","assets/index-BVHCjfv2.css","assets/settlementCalculator-CXm0QBDJ.js"])))=>i.map(i=>d[i]);
import{_ as te}from"./supabase-r6ABpEO8.js";import{r as h,j as e}from"./react-core-CwM-CeLv.js";import{n as Ps,o as Ds,s as u,m as Ye,i as S,T as Is,j as $s,k as Je,l as Ne,C as B,a as V,b as R,d as ke,e as H,I as y,S as Se,p as Ce,q as Pe,r as De,t as C,B as L,L as g}from"./index-Cn1S8-JW.js";import{A as Ie,a as $e,b as Te,c as Fe,d as Le,e as Ae}from"./AdminDialog-qdCOZfhu.js";import{k as o}from"./vendor-CQn7sZ7L.js";import{M as F}from"./MetricCard-CBRAhT7E.js";import{PartnerTransactions as Ts}from"./PartnerTransactions-x-XFBrYf.js";import{F as Fs}from"./ForceTransactionModal-DN0l0vJ3.js";import{g as Qe,h as Xe,f as E,a5 as Ls,P as As,S as z,m as Ze,K as Es,T as Os,u as re,U as es,a6 as ss,O as ts,a7 as Ms,a8 as qs}from"./lucide-icons-wLPRtdhM.js";import"./radix-ui-SX2QAG6c.js";import"./DataTable-CjdfiZ7Q.js";import"./textarea-DcWc96jr.js";import"./popover-KcKD6lRl.js";import"./command-D1kDSEeZ.js";import"./dialog-CE9i0HK9.js";const K={system_admin:"시스템관리자",head_office:"대본사",main_office:"본사",sub_office:"부본사",distributor:"총판",store:"매장"},Y={system_admin:"bg-purple-500",head_office:"bg-red-500",main_office:"bg-orange-500",sub_office:"bg-yellow-500",distributor:"bg-blue-500",store:"bg-green-500"},Bs={active:"bg-green-500",inactive:"bg-gray-500",blocked:"bg-red-500"},Vs={active:"활성",inactive:"비활성",blocked:"차단"};function rt(){const{authState:r}=Ps(),{connected:J,sendMessage:O}=Ds(),[b,ae]=h.useState([]),[G,M]=h.useState(!0),[ne,rs]=h.useState(""),[ie,as]=h.useState("all"),[le,ns]=h.useState("all"),[j,oe]=h.useState(null),[is,Q]=h.useState(!1),[ls,X]=h.useState(!1),[os,Z]=h.useState(!1),[N,ce]=h.useState(null),[de,ee]=h.useState(""),[me,Ee]=h.useState(!1),[Oe,cs]=h.useState(!1),[ue,ds]=h.useState("hierarchy"),[ms,us]=h.useState({}),[se,Me]=h.useState([]),[hs,he]=h.useState(new Set),[qe,Be]=h.useState(!1),[pe,Ve]=h.useState(""),[xe,ps]=h.useState({rolling:.5,losing:5,fee:1}),[xs,fe]=h.useState(!1),[fs,ge]=h.useState("deposit"),[W,_e]=h.useState(null),[f,je]=h.useState(null),[n,x]=h.useState({username:"",nickname:"",password:"",partner_type:"head_office",parent_id:"",opcode:"",secret_key:"",api_token:"",commission_rolling:.5,commission_losing:5,withdrawal_fee:0}),Re=async s=>{try{const{data:t,error:a}=await u.from("partners").select("commission_rolling, commission_losing, withdrawal_fee, partner_type, nickname").eq("id",s).maybeSingle();return a?(console.error("파트너 커미션 조회 오류:",a),null):t?{rolling:t.commission_rolling||100,losing:t.commission_losing||100,fee:t.withdrawal_fee||100,nickname:t.nickname}:null}catch(t){return console.error("파트너 커미션 조회 실패:",t),null}},He=async()=>{if(!r.user?.id)return;const s=await Re(r.user.id);s&&je(s)},Ke=async()=>{try{const{data:s,error:t}=await u.from("system_settings").select("setting_key, setting_value").in("setting_key",["default_rolling_commission","default_losing_commission","default_withdrawal_fee"]);if(t){console.error("시스템 기본 커미션 로드 오류:",t);return}if(s&&s.length>0){const a={rolling:.5,losing:5,fee:1};s.forEach(i=>{i.setting_key==="default_rolling_commission"?a.rolling=parseFloat(i.setting_value)||.5:i.setting_key==="default_losing_commission"?a.losing=parseFloat(i.setting_value)||5:i.setting_key==="default_withdrawal_fee"&&(a.fee=parseFloat(i.setting_value)||1)}),ps(a),x(i=>({...i,commission_rolling:a.rolling,commission_losing:a.losing,withdrawal_fee:a.fee}))}}catch(s){console.error("시스템 기본 커미션 로드 실패:",s)}};h.useEffect(()=>{r.user?.id&&(Ke(),He(),U(),ve())},[r.user?.id]),h.useEffect(()=>{if(!r.user?.id)return;console.log("✅ Realtime 구독: partners.balance 변경 감지");const s=u.channel("partner_balance_changes").on("postgres_changes",{event:"UPDATE",schema:"public",table:"partners"},t=>{const a=t.old.balance,i=t.new.balance;a!==i&&(console.log(`💰 보유금 변경: ${a} → ${i}`),ae(d=>d.map(l=>l.id===t.new.id?{...l,balance:i}:l)))}).subscribe();return()=>{u.removeChannel(s)}},[r.user?.id]);const U=async()=>{try{if(M(!0),console.log("🔍 [파트너 조회] authState.user:",{id:r.user?.id,username:r.user?.username,level:r.user?.level,partner_type:r.user?.partner_type}),!r.user?.id){console.error("❌ [파트너 조회] 로그인된 사용자가 없습니다"),o.error("로그인 정보가 없습니다. 다시 로그인해주세요."),ae([]),M(!1);return}let s=u.from("partners").select(`
          *,
          parent:parent_id (
            nickname
          )
        `).order("level",{ascending:!0}).order("created_at",{ascending:!1});const t=r.user.level===1;console.log(`🔍 [파트너 조회] 시스템 관리자 여부: ${t}`);const{data:a,error:i}=t?await s:await u.rpc("get_hierarchical_partners",{p_partner_id:r.user.id});if(console.log("📊 [파트너 조회] 결과:",{데이터개수:a?.length||0,에러:i?.message||"null"}),i)throw i;const d=await Promise.all((a||[]).map(async l=>{const{count:_}=await u.from("partners").select("*",{count:"exact"}).eq("parent_id",l.id),{count:c}=await u.from("users").select("*",{count:"exact"}).eq("referrer_id",l.id),p=l.balance||0;return{...l,parent_nickname:l.parent?.nickname||"-",child_count:_||0,user_count:c||0,balance:p}}));ae(d)}catch(s){console.error("파트너 목록 조회 오류:",s),o.error("파트너 목록을 불러오는데 실패했습니다.")}finally{M(!1)}},Ge=(s,t,a,i)=>{if(i==="head_office")return s!==100||t!==100||a!==100?(o.error("대본사의 커미션은 100%로 고정됩니다."),!1):!0;if(f){if(s>f.rolling)return o.error(`롤링 커미션은 상위 파트너(${f.rolling}%)를 초과할 수 없습니다.`),!1;if(t>f.losing)return o.error(`루징 커미션은 상위 파트너(${f.losing}%)를 초과할 수 없습니다.`),!1;if(a>f.fee)return o.error(`환전 수수료는 상위 파트너(${f.fee}%)를 초과할 수 없습니다.`),!1}return!0},gs=async()=>{try{if(M(!0),!n.username.trim()){o.error("아이디를 입력해주세요.");return}if(!n.nickname.trim()){o.error("닉네임을 입력해주세요.");return}if(!n.password.trim()){o.error("비밀번호를 입력해주세요.");return}if(!bs(n.partner_type)){o.error("해당 등급의 파트너를 생성할 권한이 없습니다.");return}if(r.user?.level!==1){const w=await ye(n.partner_type);if(w.hasGap){o.error(w.message,{duration:5e3});return}if(!w.directParentId){o.error(`${K[n.partner_type]}의 상위 조직을 찾을 수 없습니다.`);return}}let s=n.commission_rolling,t=n.commission_losing,a=n.withdrawal_fee;if(n.partner_type==="head_office"&&(s=100,t=100,a=100),!Ge(s,t,a,n.partner_type))return;const i=be(n.partner_type);let d=r.user?.id||null;if(r.user?.level!==1){const w=await ye(n.partner_type);w.directParentId&&(d=w.directParentId)}const{data:l,error:_}=await u.rpc("hash_password",{password:n.password});if(_){console.error("❌ 비밀번호 해시 오류:",_),o.error("비밀번호 처리 중 오류가 발생했습니다.");return}let c="",p="",v="";if(n.partner_type==="head_office")c=n.opcode,p=n.secret_key,v=n.api_token,console.log("🔑 [대본사 생성] formData의 opcode/token 사용:",c);else{console.log("🔍 [하위 파트너 생성] 상위 파트너에서 API 설정 조회 시작");let w=d,m=0;const $=10;for(;w&&m<$;){const{data:D,error:ze}=await u.from("partners").select("opcode, secret_key, api_token, parent_id, partner_type, nickname").eq("id",w).single();if(ze)throw console.error("❌ 상위 파트너 조회 오류:",ze),new Error("상위 파트너 조회 실패");if(console.log(`  📊 Depth ${m}: ${D.partner_type} (${D.nickname})`),D.opcode&&D.secret_key&&D.api_token){c=D.opcode,p=D.secret_key,v=D.api_token,console.log(`✅ API 설정 발견: ${D.partner_type}에서 조회 완료 (영구 사용)`);break}w=D.parent_id,m++}if(!c||!p||!v){o.error("상위 파트너에서 API 설정(opcode/secret_key/token)을 찾을 수 없습니다.");return}}const k=n.username.replace(/^btn_/,"");console.log("📡 [POST /api/account] 외부 API 계정 생성 호출:",{opcode:c,username:k,partner_type:n.partner_type});const{createAccount:T}=await te(async()=>{const{createAccount:w}=await import("./index-Cn1S8-JW.js").then(m=>m._);return{createAccount:w}},__vite__mapDeps([0,1,2,3,4,5,6])),q=await T(c,k,p);if(console.log("📊 [POST /api/account] API 응답:",q),q.error){console.error("❌ 외부 API 계정 생성 실패:",q.error),o.error(`파트너 생성 실패: ${q.error}`);return}console.log("✅ 외부 API 계정 생성 성공");const I={username:n.username,nickname:n.nickname,password_hash:l,partner_type:n.partner_type,level:i,parent_id:d,commission_rolling:s,commission_losing:t,withdrawal_fee:a,status:"active"};console.log("📝 파트너 생성 데이터:",{username:I.username,partner_type:I.partner_type,level:I.level,parent_id:I.parent_id,current_user:r.user?.username,current_user_level:r.user?.level}),I.opcode=c,I.secret_key=p,I.api_token=v,console.log("💾 [DB 저장] API 설정 저장:",{has_opcode:!!c,has_secret_key:!!p,has_api_token:!!v,partner_type:n.partner_type});const{data:P,error:A}=await u.from("partners").insert([I]).select().single();if(A){console.error("❌ 파트너 생성 DB 오류:",A),o.error("파트너 생성 중 데이터베이스 오류가 발생했습니다.");return}console.log("✅ 파트너 생성 성공:",{id:P.id,username:P.username,partner_type:P.partner_type,level:P.level,parent_id:P.parent_id}),o.success("파트너가 성공적으로 생성되었습니다."),Q(!1),Ue(),J&&O&&O({type:"partner_created",data:{partner:P}}),U()}catch(s){console.error("파트너 생성 오류:",s),o.error("파트너 생성에 실패했습니다.")}finally{M(!1)}},_s=async()=>{if(j)try{if(M(!0),!Ge(n.commission_rolling,n.commission_losing,n.withdrawal_fee,j.partner_type))return;const s={nickname:n.nickname,commission_rolling:n.commission_rolling,commission_losing:n.commission_losing,withdrawal_fee:n.withdrawal_fee,updated_at:new Date().toISOString()};n.password&&n.password.trim()!==""&&(s.password_hash=n.password),j.partner_type==="head_office"&&(s.opcode=n.opcode,s.secret_key=n.secret_key,s.api_token=n.api_token);const{error:t}=await u.from("partners").update(s).eq("id",j.id);if(t)throw t;o.success("파트너 정보가 수정되었습니다."),X(!1),oe(null),J&&O&&O({type:"partner_updated",data:{partnerId:j.id,updates:s}}),U()}catch(s){console.error("파트너 수정 오류:",s),o.error("파트너 수정에 실패했습니다.")}finally{M(!1)}},js=async()=>{if(N){if(de!==N.username){o.error("삭제 확인을 위해 파트너 아이디를 정확히 입력해주세요.");return}try{Ee(!0);const{count:s}=await u.from("partners").select("*",{count:"exact",head:!0}).eq("parent_id",N.id);if(s&&s>0){o.error(`하위 파트너가 ${s}명 존재하여 삭제할 수 없습니다. 하위 파트너를 먼저 삭제해주세요.`);return}const{count:t}=await u.from("users").select("*",{count:"exact",head:!0}).eq("referrer_id",N.id);if(t&&t>0){o.error(`관리 중인 회원이 ${t}명 존재하여 삭제할 수 없습니다. 회원을 먼저 다른 파트너로 이동하거나 삭제해주세요.`);return}const{error:a}=await u.from("partners").delete().eq("id",N.id);if(a)throw a;o.success(`${N.nickname} 파트너가 삭제되었습니다.`,{duration:3e3,icon:"🗑️"}),J&&O&&O({type:"partner_deleted",data:{partnerId:N.id}}),Z(!1),ce(null),ee(""),U()}catch(s){console.error("파트너 삭제 오류:",s),o.error("파트너 삭제에 실패했습니다.")}finally{Ee(!1)}}},vs=async s=>{if(r.user?.id)try{console.log("💰 [파트너 강제 입출금] 시작:",s);const{data:t,error:a}=await u.from("partners").select("*").eq("id",s.targetId).single();if(a||!t){o.error("파트너 정보를 찾을 수 없습니다.");return}const{data:i,error:d}=await u.from("partners").select("balance, level, nickname, partner_type").eq("id",r.user.id).single();if(d||!i){o.error("관리자 정보를 찾을 수 없습니다.");return}const l=i.level===1;if(s.type==="withdrawal"&&t.balance<s.amount){o.error(`파트너의 보유금이 부족합니다. (현재: ${t.balance.toLocaleString()}원)`);return}if(s.type==="deposit"&&!l&&i.balance<s.amount){o.error(`관리자 보유금이 부족합니다. (현재: ${i.balance.toLocaleString()}원)`);return}const{getAdminOpcode:_,isMultipleOpcode:c}=await te(async()=>{const{getAdminOpcode:m,isMultipleOpcode:$}=await import("./index-Cn1S8-JW.js").then(D=>D.$);return{getAdminOpcode:m,isMultipleOpcode:$}},__vite__mapDeps([0,1,2,3,4,5,6]));let p,v,k,T;try{const m=await _(t);if(c(m)){if(m.opcodes.length===0)throw new Error("사용 가능한 OPCODE가 없습니다.");p=m.opcodes[0].opcode,v=m.opcodes[0].secretKey,k=m.opcodes[0].token;const{data:$}=await u.from("partners").select("username").eq("id",m.opcodes[0].partnerId).single();T=$?.username?.replace(/^btn_/,"")||""}else p=m.opcode,v=m.secretKey,k=m.token,T=t.username.replace(/^btn_/,"")}catch(m){o.error(`API 설정 조회 실패: ${m.message}`);return}console.log("📡 [파트너 강제 입출금] API 호출:",{type:s.type,amount:s.amount,apiUsername:T,opcode:p});const{depositToAccount:q,withdrawFromAccount:I}=await te(async()=>{const{depositToAccount:m,withdrawFromAccount:$}=await import("./index-Cn1S8-JW.js").then(D=>D._);return{depositToAccount:m,withdrawFromAccount:$}},__vite__mapDeps([0,1,2,3,4,5,6]));let P;try{s.type==="deposit"?P=await q(p,T,k,s.amount,v):P=await I(p,T,k,s.amount,v)}catch(m){o.error(`API 호출 실패: ${m.message}`);return}if(console.log("📊 [파트너 강제 입출금] API 응답:",P),P.error){o.error(`외부 API 오류: ${P.error}`);return}if(P.data){const m=P.data;if(m.RESULT===!1){const $=m.DATA?.message||m.message||"외부 API 처리 실패";o.error(`외부 API 오류: ${$}`);return}if(m.is_text&&m.text_response){const $=m.text_response.toLowerCase();if($.includes("error")||$.includes("실패")||$.includes("초과")){o.error(`외부 API 오류: ${m.text_response}`);return}}}o.success(`외부 계정에 ${s.amount.toLocaleString()}원을 ${s.type==="deposit"?"입금":"출금"}했습니다.`);let A=i.balance,w=t.balance;s.type==="deposit"?(A=i.balance-s.amount,await u.from("partners").update({balance:A,updated_at:new Date().toISOString()}).eq("id",r.user.id),w=t.balance+s.amount,await u.from("partners").update({balance:w,updated_at:new Date().toISOString()}).eq("id",s.targetId),await u.from("partner_balance_logs").insert({partner_id:r.user.id,balance_before:i.balance,balance_after:A,amount:-s.amount,transaction_type:"withdrawal",from_partner_id:r.user.id,to_partner_id:s.targetId,processed_by:r.user.id,memo:`[강제입금] ${t.nickname}에게 ${s.amount.toLocaleString()}원 입금${s.memo?`: ${s.memo}`:""}`}),await u.from("partner_balance_logs").insert({partner_id:s.targetId,balance_before:t.balance,balance_after:w,amount:s.amount,transaction_type:"deposit",from_partner_id:r.user.id,to_partner_id:s.targetId,processed_by:r.user.id,memo:`[강제입금] ${i.nickname}으로부터 ${s.amount.toLocaleString()}원 입금${s.memo?`: ${s.memo}`:""}`})):(w=t.balance-s.amount,await u.from("partners").update({balance:w,updated_at:new Date().toISOString()}).eq("id",s.targetId),A=i.balance+s.amount,await u.from("partners").update({balance:A,updated_at:new Date().toISOString()}).eq("id",r.user.id),await u.from("partner_balance_logs").insert({partner_id:s.targetId,balance_before:t.balance,balance_after:w,amount:-s.amount,transaction_type:"withdrawal",from_partner_id:s.targetId,to_partner_id:r.user.id,processed_by:r.user.id,memo:`[강제출금] ${i.nickname}에게 ${s.amount.toLocaleString()}원 출금${s.memo?`: ${s.memo}`:""}`}),await u.from("partner_balance_logs").insert({partner_id:r.user.id,balance_before:i.balance,balance_after:A,amount:s.amount,transaction_type:"deposit",from_partner_id:s.targetId,to_partner_id:r.user.id,processed_by:r.user.id,memo:`[강제출금] ${t.nickname}으로부터 ${s.amount.toLocaleString()}원 회수${s.memo?`: ${s.memo}`:""}`})),o.success(`${t.nickname}에게 ${s.amount.toLocaleString()}원을 ${s.type==="deposit"?"입금":"출금"}했습니다.`),J&&O&&O({type:"partner_balance_updated",data:{partnerId:s.targetId,amount:s.amount,type:s.type}}),U()}catch(t){console.error("❌ [파트너 강제 입출금] 오류:",t),o.error(`${s.type==="deposit"?"입금":"출금"} 처리 중 오류가 발생했습니다.`)}},ve=async()=>{try{if(!r.user)return;const s=new Date().toISOString().split("T")[0],{data:t}=await u.from("transactions").select("transaction_type, amount").eq("partner_id",r.user.id).gte("created_at",s),a=new Date,i=new Date(a.getFullYear(),a.getMonth(),1),d=new Date(a.getFullYear(),a.getMonth()+1,0,23,59,59),{calculateIntegratedSettlement:l}=await te(async()=>{const{calculateIntegratedSettlement:c}=await import("./settlementCalculator-CXm0QBDJ.js");return{calculateIntegratedSettlement:c}},__vite__mapDeps([7,0,1,2,3,4,5,6])),_=await l(r.user.id,{rolling:r.user.commission_rolling||0,losing:r.user.commission_losing||0,withdrawal:r.user.withdrawal_fee||0},i.toISOString(),d.toISOString());us({todayDeposits:t?.filter(c=>c.transaction_type==="deposit").reduce((c,p)=>c+Number(p.amount),0)||0,todayWithdrawals:t?.filter(c=>c.transaction_type==="withdrawal").reduce((c,p)=>c+Number(p.amount),0)||0,monthlyCommission:Math.round(_.netTotalProfit)}),await ys()}catch(s){console.error("대시보드 데이터 조회 오류:",s)}},ys=async()=>{try{if(!r.user)return;const s=b.map(l=>l.id);if((r.user.level===1?s:[r.user.id,...s]).length===0){Me([]);return}const a=new Map;(r.user.level===1?b:[r.user,...b]).forEach(l=>{const _=l.partner_type;a.has(_)||a.set(_,{level:l.level,type:l.partner_type,typeName:K[l.partner_type],partnerIds:[]}),a.get(_).partnerIds.push(l.id)});const d=await Promise.all(Array.from(a.values()).map(async l=>{const{data:_}=await u.from("users").select("balance").in("referrer_id",l.partnerIds),c=_?.reduce((p,v)=>p+(v.balance||0),0)||0;return{level:l.level,type:l.type,typeName:l.typeName,partnerCount:l.partnerIds.length,usersBalance:c}}));d.sort((l,_)=>l.level-_.level),Me(d)}catch(s){console.error("레벨별 분포 조회 오류:",s)}},ye=async s=>{if(!r.user)return{hasGap:!0,missingLevels:[],directParentId:null,message:"사용자 정보가 없습니다."};const t=r.user.level,a=be(s);if(t===1)return{hasGap:!1,missingLevels:[],directParentId:r.user.id,message:""};if(a===t+1)return{hasGap:!1,missingLevels:[],directParentId:r.user.id,message:""};const i=[];let d=null;for(let c=t+1;c<a;c++){const{data:p,error:v}=await u.from("partners").select("id, level, partner_type, nickname").eq("level",c).eq("status","active");if(v){console.error(`레벨 ${c} 파트너 조회 오류:`,v);continue}const{data:k,error:T}=await u.rpc("get_hierarchical_partners",{p_partner_id:r.user.id});if(T){console.error("계층 파트너 조회 오류:",T),i.push(c);continue}(k||[]).filter(I=>I.level===c&&I.status==="active").length===0&&i.push(c)}if(i.length===0){const c=a-1,{data:p}=await u.rpc("get_hierarchical_partners",{p_partner_id:r.user.id}),v=(p||[]).filter(k=>k.level===c&&k.status==="active");v.length>0&&(d=v.sort((k,T)=>new Date(T.created_at).getTime()-new Date(k.created_at).getTime())[0].id)}const l={2:"대본사",3:"본사",4:"부본사",5:"총판",6:"매장"};let _="";if(i.length>0){const c=i.map(p=>l[p]||`Level ${p}`).join(", ");_=`⚠️ ${K[s]}을(를) 생성하려면 먼저 중간 계층(${c})을 생성해야 합니다.`}return{hasGap:i.length>0,missingLevels:i,directParentId:d,message:_}},bs=s=>{if(!r.user)return!1;const t=r.user.level,a=be(s);return t===1?!0:t===2?a>2:a>t},be=s=>({system_admin:1,head_office:2,main_office:3,sub_office:4,distributor:5,store:6})[s],Ue=()=>{x({username:"",nickname:"",password:"",partner_type:"head_office",parent_id:"",opcode:"",secret_key:"",api_token:"",commission_rolling:xe.rolling,commission_losing:xe.losing,withdrawal_fee:xe.fee})},ws=s=>{x({username:s.username,nickname:s.nickname,password:"",partner_type:s.partner_type,parent_id:s.parent_id||"",opcode:s.opcode||"",secret_key:s.secret_key||"",api_token:s.api_token||"",commission_rolling:s.commission_rolling,commission_losing:s.commission_losing,withdrawal_fee:s.withdrawal_fee})},Ns=s=>{const t=new Map,a=[];return s.forEach(i=>{t.set(i.id,{...i,children:[]})}),s.forEach(i=>{const d=t.get(i.id);if(d)if(i.parent_id&&t.has(i.parent_id)){const l=t.get(i.parent_id);l&&l.children&&l.children.push(d)}else a.push(d)}),a},ks=s=>{he(t=>{const a=new Set(t);return a.has(s)?a.delete(s):a.add(s),a})},Ss=()=>{if(qe)he(new Set),Be(!1);else{const s=new Set,t=a=>{a.forEach(i=>{i.children&&i.children.length>0&&(s.add(i.id),t(i.children))})};t(we),he(s),Be(!0)}},Cs=b.filter(s=>{const t=s.username.toLowerCase().includes(ne.toLowerCase())||s.nickname.toLowerCase().includes(ne.toLowerCase()),a=ie==="all"||s.partner_type===ie,i=le==="all"||s.status===le;return t&&a&&i}),we=Ns(Cs),We=(s,t)=>{const a=hs.has(s.id),i=s.children&&s.children.length>0,d=t*24;return e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 p-2.5 rounded-lg hover:bg-slate-800/50 transition-colors border border-slate-700/30 bg-slate-800/20 min-w-[1200px]",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-[130px] flex-shrink-0",style:{paddingLeft:`${d}px`},children:[e.jsx("button",{onClick:()=>i&&ks(s.id),className:`flex items-center justify-center w-5 h-5 rounded transition-colors flex-shrink-0 ${i?"hover:bg-slate-700 text-slate-300 cursor-pointer":"invisible"}`,children:i&&(a?e.jsx(Qe,{className:"h-3 w-3"}):e.jsx(Xe,{className:"h-3 w-3"}))}),e.jsx("span",{className:"font-medium text-white text-sm truncate",children:s.username})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("div",{className:"min-w-[90px] flex-shrink-0",children:e.jsx("span",{className:"text-slate-300 text-sm truncate",children:s.nickname})}),e.jsx("div",{className:"min-w-[85px] flex-shrink-0",children:e.jsx(L,{className:`${Y[s.partner_type]} text-white text-xs`,children:K[s.partner_type]})}),e.jsx("div",{className:"min-w-[60px] flex-shrink-0",children:e.jsx(L,{className:`${Bs[s.status]} text-white text-xs`,children:Vs[s.status]})}),e.jsx("div",{className:"min-w-[110px] text-right flex-shrink-0",children:e.jsxs("span",{className:"font-mono text-green-400 text-sm",children:[s.balance.toLocaleString(),"원"]})}),e.jsx("div",{className:"min-w-[170px] flex-shrink-0",children:e.jsxs("div",{className:"flex items-center gap-1 text-xs",children:[e.jsxs(L,{variant:"outline",className:"bg-green-500/10 text-green-400 border-green-500/30 text-xs px-1",children:["R:",s.commission_rolling,"%"]}),e.jsxs(L,{variant:"outline",className:"bg-orange-500/10 text-orange-400 border-orange-500/30 text-xs px-1",children:["L:",s.commission_losing,"%"]}),e.jsxs(L,{variant:"outline",className:"bg-blue-500/10 text-blue-400 border-blue-500/30 text-xs px-1",children:["F:",s.withdrawal_fee,"%"]})]})}),e.jsxs("div",{className:"flex items-center gap-1.5 min-w-[110px] flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(E,{className:"h-3 w-3 text-slate-400"}),e.jsx("span",{className:"text-xs text-slate-400",children:s.child_count||0})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(es,{className:"h-3 w-3 text-slate-400"}),e.jsx("span",{className:"text-xs text-slate-400",children:s.user_count||0})]})]}),e.jsx("div",{className:"min-w-[120px] flex-shrink-0",children:s.last_login_at?(()=>{const l=new Date(s.last_login_at),_=l.getFullYear(),c=String(l.getMonth()+1).padStart(2,"0"),p=String(l.getDate()).padStart(2,"0"),v=String(l.getHours()).padStart(2,"0"),k=String(l.getMinutes()).padStart(2,"0");return e.jsx("span",{className:"text-xs text-slate-400",children:`${_}/${c}/${p} ${v}:${k}`})})():e.jsx("span",{className:"text-xs text-slate-600",children:"-"})})]}),e.jsxs("div",{className:"flex items-center gap-1.5 w-[240px] flex-shrink-0",children:[(r.user?.level===1&&s.partner_type==="head_office"||s.parent_id===r.user?.id&&s.partner_type!=="head_office")&&e.jsxs(e.Fragment,{children:[e.jsx(S,{variant:"outline",size:"sm",onClick:()=>{_e(s),ge("deposit"),fe(!0)},className:"bg-green-500/10 border-green-500/50 text-green-400 hover:bg-green-500/20 flex-shrink-0",title:r.user?.level===1&&s.partner_type==="head_office"?"입금":"보유금 지급",children:e.jsx(re,{className:"h-4 w-4"})}),e.jsx(S,{variant:"outline",size:"sm",onClick:()=>{_e(s),ge("withdrawal"),fe(!0)},className:"bg-orange-500/10 border-orange-500/50 text-orange-400 hover:bg-orange-500/20 flex-shrink-0",title:r.user?.level===1&&s.partner_type==="head_office"?"출금":"보유금 회수",children:e.jsx(Ms,{className:"h-4 w-4"})})]}),e.jsx(S,{variant:"outline",size:"sm",onClick:()=>{oe(s),ws(s),X(!0)},className:"bg-blue-500/10 border-blue-500/50 text-blue-400 hover:bg-blue-500/20 flex-shrink-0",children:e.jsx(qs,{className:"h-3 w-3"})}),e.jsx(S,{variant:"outline",size:"sm",onClick:()=>{o.info(`${s.nickname} 파트너의 상세 정보를 확인합니다.`)},className:"bg-slate-700/50 border-slate-600 text-slate-300 hover:bg-slate-700 flex-shrink-0",children:e.jsx(Ze,{className:"h-3 w-3"})}),s.partner_type!=="system_admin"&&e.jsx(S,{variant:"outline",size:"sm",onClick:()=>{ce(s),ee(""),Z(!0)},className:"bg-red-500/10 border-red-500/50 text-red-400 hover:bg-red-500/20 flex-shrink-0",children:e.jsx(ts,{className:"h-3 w-3"})})]})]}),a&&i&&e.jsx("div",{className:"mt-1 space-y-1",children:s.children.map(l=>We(l,t+1))})]},s.id)};return h.useEffect(()=>{Ke(),He(),U(),ve()},[]),h.useEffect(()=>{ue==="dashboard"&&ve()},[ue]),G&&b.length===0?e.jsx(Ye,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-100",children:"파트너 관리"}),e.jsx("p",{className:"text-sm text-slate-400",children:r.user?.nickname})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(S,{onClick:Ss,variant:"outline",className:"border-blue-500/30 bg-blue-500/10 text-blue-300 hover:bg-blue-500/20 hover:border-blue-400/50",children:qe?e.jsxs(e.Fragment,{children:[e.jsx(Qe,{className:"h-4 w-4 mr-2"}),"접기"]}):e.jsxs(e.Fragment,{children:[e.jsx(Xe,{className:"h-4 w-4 mr-2"}),"펼쳐보기"]})}),e.jsxs(S,{onClick:()=>cs(!Oe),variant:"outline",className:"border-slate-700 text-slate-300 hover:bg-slate-700/50",children:[e.jsx(E,{className:"h-4 w-4 mr-2"}),Oe?"목록 보기":"계층 보기"]}),e.jsxs(S,{variant:"outline",className:"border-slate-700 text-slate-300 hover:bg-slate-700/50",children:[e.jsx(Ls,{className:"h-4 w-4 mr-2"}),"내보내기"]}),e.jsxs(S,{onClick:()=>Q(!0),children:[e.jsx(As,{className:"h-4 w-4 mr-2"}),"파트너 생성"]})]})]}),e.jsxs("div",{className:"grid gap-5 md:grid-cols-4",children:[e.jsx(F,{title:"전체 하위 파트너",value:b.filter(s=>s.id!==r.user?.id).length.toLocaleString(),subtitle:"관리 중인 파트너",icon:E,color:"purple"}),r.user?.level===2&&e.jsx(F,{title:"본사",value:b.filter(s=>s.id!==r.user?.id&&s.partner_type==="main_office").length.toLocaleString(),subtitle:"본사 파트너",icon:z,color:"red"}),r.user?.level===3&&e.jsx(F,{title:"부본사",value:b.filter(s=>s.id!==r.user?.id&&s.partner_type==="sub_office").length.toLocaleString(),subtitle:"부본사 파트너",icon:z,color:"red"}),r.user?.level===4&&e.jsx(F,{title:"총판",value:b.filter(s=>s.id!==r.user?.id&&s.partner_type==="distributor").length.toLocaleString(),subtitle:"총판 파트너",icon:z,color:"red"}),r.user?.level===2&&e.jsx(F,{title:"부본사/총판/매장",value:b.filter(s=>s.id!==r.user?.id&&(s.partner_type==="sub_office"||s.partner_type==="distributor"||s.partner_type==="store")).length.toLocaleString(),subtitle:"하위 파트너",icon:E,color:"orange"}),r.user?.level===3&&e.jsx(F,{title:"총판/매장",value:b.filter(s=>s.id!==r.user?.id&&(s.partner_type==="distributor"||s.partner_type==="store")).length.toLocaleString(),subtitle:"하위 파트너",icon:E,color:"orange"}),r.user?.level===4&&e.jsx(F,{title:"매장",value:b.filter(s=>s.id!==r.user?.id&&s.partner_type==="store").length.toLocaleString(),subtitle:"매장 파트너",icon:E,color:"orange"}),r.user?.level===5&&e.jsxs(e.Fragment,{children:[e.jsx(F,{title:"매장",value:b.filter(s=>s.id!==r.user?.id&&s.partner_type==="store").length.toLocaleString(),subtitle:"매장 파트너",icon:z,color:"red"}),e.jsx(F,{title:"-",value:"0",subtitle:"하위 없음",icon:E,color:"orange"})]}),(r.user?.level===1||r.user?.level===6)&&e.jsxs(e.Fragment,{children:[e.jsx(F,{title:"대본사",value:b.filter(s=>s.id!==r.user?.id&&s.partner_type==="head_office").length.toLocaleString(),subtitle:"대본사 파트너",icon:z,color:"red"}),e.jsx(F,{title:"본사/부본사",value:b.filter(s=>s.id!==r.user?.id&&(s.partner_type==="main_office"||s.partner_type==="sub_office")).length.toLocaleString(),subtitle:"중간 파트너",icon:E,color:"orange"})]}),e.jsx(F,{title:"활성 파트너",value:b.filter(s=>s.id!==r.user?.id&&s.status==="active").length.toLocaleString(),subtitle:"정상 운영 중",icon:Ze,color:"green"})]}),e.jsxs(Is,{value:ue,onValueChange:ds,className:"space-y-6",children:[e.jsx("div",{className:"bg-slate-800/30 rounded-xl p-1.5 border border-slate-700/40",children:e.jsxs($s,{className:"bg-transparent h-auto p-0 border-0 gap-2 w-full grid grid-cols-2",children:[e.jsx(Je,{value:"hierarchy",className:"bg-transparent text-slate-400 rounded-lg px-6 py-3 data-[state=active]:bg-gradient-to-br data-[state=active]:from-blue-500/20 data-[state=active]:to-cyan-500/10 data-[state=active]:text-white data-[state=active]:shadow-lg data-[state=active]:shadow-blue-500/20 data-[state=active]:border data-[state=active]:border-blue-400/30 transition-all duration-200",children:"파트너 계층 관리"}),e.jsx(Je,{value:"dashboard",className:"bg-transparent text-slate-400 rounded-lg px-6 py-3 data-[state=active]:bg-gradient-to-br data-[state=active]:from-purple-500/20 data-[state=active]:to-pink-500/10 data-[state=active]:text-white data-[state=active]:shadow-lg data-[state=active]:shadow-purple-500/20 data-[state=active]:border data-[state=active]:border-purple-400/30 transition-all duration-200",children:"파트너 대시보드"})]})}),e.jsx(Ne,{value:"hierarchy",className:"space-y-4",children:e.jsxs(B,{className:"bg-slate-900/40 border-slate-700/50 backdrop-blur",children:[e.jsxs(V,{children:[e.jsx(R,{className:"text-white",children:"파트너 계층 관리"}),e.jsx(ke,{className:"text-slate-400",children:"7단계 권한 체계의 파트너를 관리합니다."})]}),e.jsxs(H,{children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(Es,{className:"absolute left-2 top-2.5 h-4 w-4 text-slate-400"}),e.jsx(y,{placeholder:"아이디 또는 닉네임으로 검색...",className:"pl-8 bg-slate-800/50 border-slate-700 text-white",value:ne,onChange:s=>rs(s.target.value)})]})}),e.jsxs(Se,{value:ie,onValueChange:as,children:[e.jsx(Ce,{className:"w-[180px] bg-slate-800/50 border-slate-700 text-white",children:e.jsx(Pe,{placeholder:"파트너 등급"})}),e.jsxs(De,{children:[e.jsx(C,{value:"all",children:"전체 등급"}),e.jsx(C,{value:"head_office",children:"대본사"}),e.jsx(C,{value:"main_office",children:"본사"}),e.jsx(C,{value:"sub_office",children:"부본사"}),e.jsx(C,{value:"distributor",children:"총판"}),e.jsx(C,{value:"store",children:"매장"})]})]}),e.jsxs(Se,{value:le,onValueChange:ns,children:[e.jsx(Ce,{className:"w-[180px] bg-slate-800/50 border-slate-700 text-white",children:e.jsx(Pe,{placeholder:"상태 필터"})}),e.jsxs(De,{children:[e.jsx(C,{value:"all",children:"전체 상태"}),e.jsx(C,{value:"active",children:"활성"}),e.jsx(C,{value:"inactive",children:"비활성"}),e.jsx(C,{value:"blocked",children:"차단"})]})]})]}),e.jsx("div",{className:"mb-3 px-3 py-2 bg-slate-800/50 rounded-lg border border-slate-700/30",children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"min-w-[130px] flex-shrink-0",children:e.jsx("div",{className:"text-xs font-medium text-slate-400",children:"아이디"})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("div",{className:"min-w-[90px] text-xs font-medium text-slate-400",children:"닉네임"}),e.jsx("div",{className:"min-w-[85px] text-xs font-medium text-slate-400",children:"등급"}),e.jsx("div",{className:"min-w-[60px] text-xs font-medium text-slate-400",children:"상태"}),e.jsx("div",{className:"min-w-[110px] text-xs font-medium text-slate-400 text-right",children:"보유금"}),e.jsx("div",{className:"min-w-[170px] text-xs font-medium text-slate-400",children:"커미션"}),e.jsx("div",{className:"min-w-[110px] text-xs font-medium text-slate-400",children:"하위/회원"}),e.jsx("div",{className:"min-w-[120px] text-xs font-medium text-slate-400",children:"최근 접속"})]}),e.jsx("div",{className:"w-[240px] text-xs font-medium text-slate-400 text-center flex-shrink-0",children:"관리"})]})}),G?e.jsx(Ye,{}):we.length===0?e.jsx("div",{className:"text-center py-12 text-slate-400",children:"파트너가 없습니다."}):e.jsx("div",{className:"space-y-1 overflow-x-auto",children:we.map(s=>We(s,0))})]})]})}),e.jsx(Ne,{value:"transactions",className:"space-y-4",children:e.jsx(Ts,{})}),e.jsx(Ne,{value:"dashboard",className:"space-y-4",children:e.jsxs(B,{className:"bg-slate-900/40 border-slate-700/50 backdrop-blur",children:[e.jsxs(V,{children:[e.jsxs(R,{className:"flex items-center gap-2 text-white",children:[e.jsx(Os,{className:"h-5 w-5"}),"파트너 대시보드"]}),e.jsx(ke,{className:"text-slate-400",children:"파트너별 성과 및 수익 현황을 확인합니다."})]}),e.jsxs(H,{children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-3 mb-6",children:[e.jsxs(B,{children:[e.jsxs(V,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(R,{className:"text-sm font-medium",children:"이번달 순수익"}),e.jsx(re,{className:"h-4 w-4 text-green-500"})]}),e.jsxs(H,{children:[e.jsxs("div",{className:"text-2xl font-bold text-green-600",children:[(ms.monthlyCommission||0).toLocaleString(),"원"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"내 수입 - 하위 파트너 지급"})]})]}),e.jsxs(B,{children:[e.jsxs(V,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(R,{className:"text-sm font-medium",children:"총 파트너 수"}),e.jsx(E,{className:"h-4 w-4 text-blue-500"})]}),e.jsxs(H,{children:[e.jsxs("div",{className:"text-2xl font-bold text-blue-600",children:[b.length.toLocaleString(),"개"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"+2 new this month"})]})]}),e.jsxs(B,{children:[e.jsxs(V,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(R,{className:"text-sm font-medium",children:"활성 회원 수"}),e.jsx(es,{className:"h-4 w-4 text-purple-500"})]}),e.jsxs(H,{children:[e.jsxs("div",{className:"text-2xl font-bold text-purple-600",children:[b.reduce((s,t)=>s+(t.user_count||0),0).toLocaleString(),"명"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"+5% from last month"})]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs(B,{children:[e.jsx(V,{children:e.jsx(R,{className:"text-lg",children:"상위 성과 파트너"})}),e.jsx(H,{children:e.jsx("div",{className:"space-y-3",children:b.filter(s=>s.partner_type!=="system_admin").sort((s,t)=>(t.user_count||0)-(s.user_count||0)).slice(0,5).map((s,t)=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(L,{className:`${Y[s.partner_type]} text-white`,children:["#",t+1]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.nickname}),e.jsx("p",{className:"text-sm text-muted-foreground",children:K[s.partner_type]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-medium",children:[s.user_count||0,"명"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"관리 회원"})]})]},s.id))})})]}),e.jsxs(B,{children:[e.jsxs(V,{children:[e.jsx(R,{className:"text-lg",children:"파트너 레벨별 분포"}),e.jsx(ke,{className:"text-xs",children:"각 레벨 파트너들이 보유한 사용자들의 총 보유금"})]}),e.jsx(H,{children:e.jsx("div",{className:"space-y-4",children:se.length>0?e.jsxs(e.Fragment,{children:[se.map(s=>{const t=Math.max(...se.map(i=>i.usersBalance),1),a=Math.round(s.usersBalance/t*100);return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(L,{className:`${Y[s.type]} text-white text-xs`,children:["LV.",s.level]}),e.jsx("span",{className:"text-sm font-medium",children:s.typeName}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",s.partnerCount,"개)"]})]}),e.jsxs("span",{className:"text-sm font-medium text-blue-600",children:["₩",s.usersBalance.toLocaleString()]})]}),e.jsx("div",{className:"w-full bg-slate-800/40 rounded-full h-3 overflow-hidden",children:e.jsx("div",{className:`h-3 rounded-full transition-all duration-500 ${Y[s.type]}`,style:{width:`${Math.max(a,2)}%`}})})]},s.type)}),e.jsx("div",{className:"pt-3 border-t border-slate-700/50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-slate-300",children:"총 사용자 보유금"}),e.jsxs("span",{className:"text-sm font-bold text-emerald-400",children:["₩",se.reduce((s,t)=>s+t.usersBalance,0).toLocaleString()]})]})})]}):e.jsx("div",{className:"text-center py-8 text-muted-foreground text-sm",children:"하위 파트너가 없습니다"})})})]})]})]})]})})]}),e.jsx(Ie,{open:is,onOpenChange:Q,children:e.jsxs($e,{className:"sm:max-w-[600px] max-h-[80vh] overflow-y-auto",children:[e.jsxs(Te,{children:[e.jsx(Fe,{children:"새 파트너 생성"}),e.jsx(Le,{children:"새로운 파트너를 시스템에 등록합니다."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"username",children:"아이디"}),e.jsx(y,{id:"username",value:n.username,onChange:s=>x(t=>({...t,username:s.target.value})),placeholder:"파트너 아이디 입력"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"nickname",children:"닉네임"}),e.jsx(y,{id:"nickname",value:n.nickname,onChange:s=>x(t=>({...t,nickname:s.target.value})),placeholder:"파트너 닉네임 입력"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"password",children:"비밀번호"}),e.jsx(y,{id:"password",type:"password",value:n.password,onChange:s=>x(t=>({...t,password:s.target.value})),placeholder:"초기 비밀번호 입력"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"partner_type",children:"파트너 등급"}),e.jsxs(Se,{value:n.partner_type,onValueChange:async s=>{if(x(t=>({...t,partner_type:s})),r.user?.level!==1){const t=await ye(s);if(Ve(t.message),t.directParentId&&!t.hasGap){const a=await Re(t.directParentId);a&&(je(a),console.log(`✅ ${K[s]} 상위 파트너 커미션 로드:`,a))}}else s==="head_office"&&je({rolling:100,losing:100,fee:100,nickname:"시스템"})},children:[e.jsx(Ce,{children:e.jsx(Pe,{})}),e.jsxs(De,{children:[r.user?.level===1&&e.jsx(C,{value:"head_office",children:"대본사"}),r.user?.level===2&&e.jsx(C,{value:"main_office",children:"본사"}),r.user?.level===3&&e.jsx(C,{value:"sub_office",children:"부본사"}),r.user?.level===4&&e.jsx(C,{value:"distributor",children:"총판"}),r.user?.level===5&&e.jsx(C,{value:"store",children:"매장"})]})]}),pe&&e.jsx("div",{className:"p-3 bg-red-50 dark:bg-red-900/10 rounded-lg border border-red-200 dark:border-red-800",children:e.jsx("p",{className:"text-xs text-red-700 dark:text-red-300",children:pe})})]})]}),n.partner_type==="head_office"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(g,{htmlFor:"opcode",className:"flex items-center gap-2",children:[e.jsx(ss,{className:"h-4 w-4"}),"OPCODE"]}),e.jsx(y,{id:"opcode",value:n.opcode,onChange:s=>x(t=>({...t,opcode:s.target.value})),placeholder:"외부 API OPCODE 입력"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"secret_key",children:"Secret Key"}),e.jsx(y,{id:"secret_key",value:n.secret_key,onChange:s=>x(t=>({...t,secret_key:s.target.value})),placeholder:"비밀 키 입력"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"api_token",children:"API Token"}),e.jsx(y,{id:"api_token",value:n.api_token,onChange:s=>x(t=>({...t,api_token:s.target.value})),placeholder:"API 토큰 입력"})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(g,{className:"flex items-center gap-2",children:[e.jsx(re,{className:"h-4 w-4 text-green-500"}),"커미션 설정"]}),n.partner_type!=="head_office"&&f&&e.jsxs(L,{variant:"outline",className:"text-xs",children:["상위 한도: ",f.rolling,"% / ",f.losing,"%"]})]}),n.partner_type==="head_office"?e.jsx("div",{className:"p-3 bg-purple-50 dark:bg-purple-900/10 rounded-lg border border-purple-200 dark:border-purple-800",children:e.jsxs("p",{className:"text-xs text-purple-700 dark:text-purple-300",children:["🏢 ",e.jsx("strong",{children:"대본사"}),"는 최상위 파트너로 커미션이 자동으로 ",e.jsx("strong",{children:"100%"}),"로 설정됩니다."]})}):e.jsx("div",{className:"p-3 bg-blue-50 dark:bg-blue-900/10 rounded-lg border border-blue-200 dark:border-blue-800",children:e.jsx("p",{className:"text-xs text-blue-700 dark:text-blue-300",children:"💡 커미션은 상위 파트너의 요율을 초과할 수 없습니다. 계층 구조에 따라 하위로 갈수록 낮아집니다."})}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"commission_rolling",children:"롤링 커미션 (%)"}),e.jsx(y,{id:"commission_rolling",type:"text",step:"0.1",min:"0",max:n.partner_type==="head_office"?100:f?.rolling||100,value:n.partner_type==="head_office"?100:n.commission_rolling,onChange:s=>{if(n.partner_type==="head_office")return;const t=s.target.value;if(t===""){x(d=>({...d,commission_rolling:0}));return}const a=parseFloat(t);if(isNaN(a))return;const i=f?.rolling||100;if(a>i){o.error(`롤링 커미션은 상위 한도(${i}%)를 초과할 수 없습니다.`);return}x(d=>({...d,commission_rolling:a}))},disabled:n.partner_type==="head_office",className:n.partner_type==="head_office"?"bg-muted":""}),e.jsx("p",{className:"text-xs text-muted-foreground",children:n.partner_type==="head_office"?"대본사 고정값":"회원 총 베팅액 × 커미션 요율"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"commission_losing",children:"루징 커미션 (%)"}),e.jsx(y,{id:"commission_losing",type:"text",step:"0.1",min:"0",max:n.partner_type==="head_office"?100:f?.losing||100,value:n.partner_type==="head_office"?100:n.commission_losing,onChange:s=>{if(n.partner_type==="head_office")return;const t=s.target.value;if(t===""){x(d=>({...d,commission_losing:0}));return}const a=parseFloat(t);if(isNaN(a))return;const i=f?.losing||100;if(a>i){o.error(`루징 커미션은 상위 한도(${i}%)를 초과할 수 없습니다.`);return}x(d=>({...d,commission_losing:a}))},disabled:n.partner_type==="head_office",className:n.partner_type==="head_office"?"bg-muted":""}),e.jsx("p",{className:"text-xs text-muted-foreground",children:n.partner_type==="head_office"?"대본사 고정값":"회원 순손실액 × 커미션 요율"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"withdrawal_fee",children:"환전 수수료 (%)"}),e.jsx(y,{id:"withdrawal_fee",type:"text",step:"0.1",min:"0",max:n.partner_type==="head_office"?100:f?.fee||100,value:n.partner_type==="head_office"?100:n.withdrawal_fee,onChange:s=>{if(n.partner_type==="head_office")return;const t=s.target.value;if(t===""){x(d=>({...d,withdrawal_fee:0}));return}const a=parseFloat(t);if(isNaN(a))return;const i=f?.fee||100;if(a>i){o.error(`환전 수수료는 상위 한도(${i}%)를 초과할 수 없습니다.`);return}x(d=>({...d,withdrawal_fee:a}))},disabled:n.partner_type==="head_office",className:n.partner_type==="head_office"?"bg-muted":""}),e.jsx("p",{className:"text-xs text-muted-foreground",children:n.partner_type==="head_office"?"대본사 고정값":"환전 금액에 적용되는 수수료"})]})]})]})]}),e.jsxs(Ae,{children:[e.jsx(S,{variant:"outline",onClick:()=>{Q(!1),Ue(),Ve("")},children:"취소"}),e.jsx(S,{onClick:gs,disabled:G||!!pe&&r.user?.level!==1,children:G?"생성 중...":"파트너 생성"})]})]})}),e.jsx(Ie,{open:ls,onOpenChange:X,children:e.jsxs($e,{className:"sm:max-w-[600px] max-h-[80vh] overflow-y-auto",children:[e.jsxs(Te,{children:[e.jsx(Fe,{children:"파트너 정보 수정"}),e.jsx(Le,{children:"파트너의 정보를 수정합니다."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"edit_username",children:"아이디"}),e.jsx(y,{id:"edit_username",value:n.username,disabled:!0,className:"bg-muted"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"edit_nickname",children:"닉네임"}),e.jsx(y,{id:"edit_nickname",value:n.nickname,onChange:s=>x(t=>({...t,nickname:s.target.value}))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"edit_password",children:"비밀번호 (변경시에만 입력)"}),e.jsx(y,{id:"edit_password",type:"password",value:n.password,onChange:s=>x(t=>({...t,password:s.target.value})),placeholder:"비밀번호를 변경하려면 입력하세요"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"비밀번호를 변경하지 않으려면 비워두세요"})]}),j?.partner_type==="head_office"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(g,{htmlFor:"edit_opcode",className:"flex items-center gap-2",children:[e.jsx(ss,{className:"h-4 w-4"}),"OPCODE"]}),e.jsx(y,{id:"edit_opcode",value:n.opcode,onChange:s=>x(t=>({...t,opcode:s.target.value}))})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"edit_secret_key",children:"Secret Key"}),e.jsx(y,{id:"edit_secret_key",value:n.secret_key,onChange:s=>x(t=>({...t,secret_key:s.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"edit_api_token",children:"API Token"}),e.jsx(y,{id:"edit_api_token",value:n.api_token,onChange:s=>x(t=>({...t,api_token:s.target.value}))})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(g,{className:"flex items-center gap-2",children:[e.jsx(re,{className:"h-4 w-4 text-green-500"}),"커미션 설정"]}),j?.partner_type!=="head_office"&&f&&e.jsxs(L,{variant:"outline",className:"text-xs",children:["상위 한도: ",f.rolling,"% / ",f.losing,"% / ",f.fee,"%"]})]}),j?.partner_type==="head_office"?e.jsx("div",{className:"p-3 bg-purple-50 dark:bg-purple-900/10 rounded-lg border border-purple-200 dark:border-purple-800",children:e.jsxs("p",{className:"text-xs text-purple-700 dark:text-purple-300",children:["🏢 ",e.jsx("strong",{children:"대본사"}),"는 최상위 파트너로 커미션이 ",e.jsx("strong",{children:"100%"}),"로 고정됩니다."]})}):e.jsx("div",{className:"p-3 bg-amber-50 dark:bg-amber-900/10 rounded-lg border border-amber-200 dark:border-amber-800",children:e.jsx("p",{className:"text-xs text-amber-700 dark:text-amber-300",children:"⚠️ 커미션 변경 시 정산에 즉시 반영되며, 상위 파트너 요율을 초과할 수 없습니다."})}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"edit_commission_rolling",children:"롤링 커미션 (%)"}),e.jsx(y,{id:"edit_commission_rolling",type:"number",step:"0.1",min:"0",max:j?.partner_type==="head_office"?100:f?.rolling||100,value:n.commission_rolling,onChange:s=>x(t=>({...t,commission_rolling:parseFloat(s.target.value)||0})),disabled:j?.partner_type==="head_office",className:j?.partner_type==="head_office"?"bg-muted":""}),e.jsx("p",{className:"text-xs text-muted-foreground",children:j?.partner_type==="head_office"?"대본사 고정값":"회원 총 베팅액 × 커미션 요율"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"edit_commission_losing",children:"루징 커미션 (%)"}),e.jsx(y,{id:"edit_commission_losing",type:"number",step:"0.1",min:"0",max:j?.partner_type==="head_office"?100:f?.losing||100,value:n.commission_losing,onChange:s=>x(t=>({...t,commission_losing:parseFloat(s.target.value)||0})),disabled:j?.partner_type==="head_office",className:j?.partner_type==="head_office"?"bg-muted":""}),e.jsx("p",{className:"text-xs text-muted-foreground",children:j?.partner_type==="head_office"?"대본사 고정값":"회원 순손실액 × 커미션 요율"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{htmlFor:"edit_withdrawal_fee",children:"환전 수수료 (%)"}),e.jsx(y,{id:"edit_withdrawal_fee",type:"number",step:"0.1",min:"0",max:j?.partner_type==="head_office"?100:f?.fee||100,value:n.withdrawal_fee,onChange:s=>x(t=>({...t,withdrawal_fee:parseFloat(s.target.value)||0})),disabled:j?.partner_type==="head_office",className:j?.partner_type==="head_office"?"bg-muted":""}),e.jsx("p",{className:"text-xs text-muted-foreground",children:j?.partner_type==="head_office"?"대본사 고정값":"환전 금액에 적용되는 수수료"})]})]})]})]}),e.jsxs(Ae,{children:[e.jsx(S,{variant:"outline",onClick:()=>{X(!1),oe(null)},children:"취소"}),e.jsx(S,{onClick:_s,disabled:G,children:G?"수정 중...":"수정 완료"})]})]})}),e.jsx(Fs,{open:xs,onOpenChange:s=>{fe(s),s||_e(null)},type:fs,targetType:"partner",selectedTarget:W?{id:W.id,username:W.username,nickname:W.nickname,balance:W.balance||0}:null,onSubmit:vs,onTypeChange:ge}),e.jsx(Ie,{open:os,onOpenChange:Z,children:e.jsxs($e,{className:"sm:max-w-[500px]",children:[e.jsxs(Te,{children:[e.jsx(Fe,{className:"text-red-600",children:"⚠️ 파트너 삭제 확인"}),e.jsx(Le,{children:"이 작업은 되돌릴 수 없습니다. 삭제하려면 아래에 파트너 아이디를 입력해주세요."})]}),N&&e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsx("div",{className:"p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"파트너"}),e.jsxs("span",{className:"font-medium",children:[N.nickname," (",N.username,")"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"등급"}),e.jsx(L,{className:`${Y[N.partner_type]} text-white`,children:K[N.partner_type]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"하위 파트너"}),e.jsxs("span",{className:"font-medium",children:[N.child_count||0,"명"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"관리 회원"}),e.jsxs("span",{className:"font-medium",children:[N.user_count||0,"명"]})]})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(g,{htmlFor:"delete-confirm",className:"text-red-600",children:["삭제 확인: ",e.jsx("span",{className:"font-mono",children:N.username})," 입력"]}),e.jsx(y,{id:"delete-confirm",value:de,onChange:s=>ee(s.target.value),placeholder:"파트너 아이디를 정확히 입력하세요",className:"border-red-300 focus:border-red-500"})]}),e.jsx("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 p-3 rounded-lg border border-yellow-200 dark:border-yellow-800",children:e.jsxs("p",{className:"text-sm text-yellow-800 dark:text-yellow-200",children:[e.jsx("strong",{children:"주의:"})," 하위 파트너나 관리 회원이 있으면 삭제할 수 없습니다."]})})]}),e.jsxs(Ae,{children:[e.jsx(S,{variant:"outline",onClick:()=>{Z(!1),ce(null),ee("")},disabled:me,children:"취소"}),e.jsx(S,{variant:"destructive",onClick:js,disabled:me||de!==N?.username,children:me?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"삭제 중..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ts,{className:"h-4 w-4 mr-2"}),"삭제"]})})]})]})})]})}export{rt as PartnerManagement,rt as default};
