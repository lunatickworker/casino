import{r as l,j as e}from"./react-core-CwM-CeLv.js";import{s as m,C as v,a as E,b as H,i as c,e as _,I as Z,m as ee,B as M}from"./index-Zxf-w_JS.js";import{D as se,a as te,b as ae,c as ne,d as le}from"./dialog-ChmZB66N.js";import{C as re,a as ie}from"./collapsible-Bk9eB6pG.js";import{k as ce}from"./vendor-CQn7sZ7L.js";import{X as oe,K as de,B,aD as me,l as xe,g as he,ab as O,m as R}from"./lucide-icons-wLPRtdhM.js";import"./radix-ui-SX2QAG6c.js";import"./supabase-r6ABpEO8.js";function _e({user:f,onRouteChange:ue}){const[y,C]=l.useState([]),[g,h]=l.useState([]),[u,$]=l.useState(""),[J,S]=l.useState(!0),[i,q]=l.useState(null),[F,D]=l.useState(!1),[K,Q]=l.useState([]),[U,k]=l.useState([]),[o,W]=l.useState(1),[j,X]=l.useState(1),N=10,p=async(s=1)=>{try{S(!0);const t=(s-1)*N,{data:a,error:n,count:x}=await m.from("announcements").select(`
          *,
          partners (
            nickname
          )
        `,{count:"exact"}).eq("status","active").in("target_type",["users","all"]).order("is_pinned",{ascending:!1}).order("created_at",{ascending:!1}).range(t,t+N-1);if(n)throw n;const b=a?.map(d=>d.id)||[],{data:r}=await m.from("announcement_reads").select("announcement_id").eq("user_id",f.id).in("announcement_id",b),Y=r?.map(d=>d.announcement_id)||[],z=a?.map(d=>({...d,is_read:Y.includes(d.id)}))||[];C(z),h(z),X(Math.ceil((x||0)/N)),W(s)}catch(t){console.error("공지사항 조회 오류:",t),ce.error("공지사항을 불러오는데 실패했습니다.")}finally{S(!1)}},T=async()=>{try{const{data:s,error:t}=await m.from("announcements").select("id, title, content, created_at").eq("status","active").eq("is_popup",!0).in("target_type",["users","all"]).order("created_at",{ascending:!1});if(t)throw t;const a=JSON.parse(localStorage.getItem("hidden_popups_today")||"[]"),n=new Date().toDateString(),x=a.filter(r=>r.date===n).map(r=>r.id),b=(s||[]).filter(r=>!x.includes(r.id)).map(r=>({...r,hide_today:!1}));k(b)}catch(s){console.error("팝업 공지사항 조회 오류:",s)}},L=s=>{if($(s),!s.trim()){h(y);return}const t=y.filter(a=>a.title.toLowerCase().includes(s.toLowerCase())||a.content.toLowerCase().includes(s.toLowerCase()));h(t)},A=async s=>{if(q(s),D(!0),!s.is_read)try{await m.from("announcement_reads").insert([{announcement_id:s.id,user_id:f.id}]),await m.from("announcements").update({view_count:s.view_count+1}).eq("id",s.id),C(t=>t.map(a=>a.id===s.id?{...a,is_read:!0,view_count:a.view_count+1}:a)),h(t=>t.map(a=>a.id===s.id?{...a,is_read:!0,view_count:a.view_count+1}:a))}catch(t){console.error("읽음 처리 오류:",t)}},P=s=>{Q(t=>t.includes(s)?t.filter(a=>a!==s):[...t,s])},w=(s,t=!1)=>{if(k(a=>a.filter(n=>n.id!==s)),t){const a=JSON.parse(localStorage.getItem("hidden_popups_today")||"[]"),n=new Date().toDateString(),x=[...a,{id:s,date:n}];localStorage.setItem("hidden_popups_today",JSON.stringify(x))}},I=s=>new Date(s).toLocaleString("ko-KR"),G=s=>{const t=new Date,a=new Date(s),n=Math.floor((t.getTime()-a.getTime())/(1e3*60*60));return n<1?"방금 전":n<24?`${n}시간 전`:`${Math.floor(n/24)}일 전`},V=(s,t=100)=>s.length<=t?s:s.substring(0,t)+"...";return l.useEffect(()=>{p(),T();const s=m.channel("announcement_updates").on("postgres_changes",{event:"*",schema:"public",table:"announcements"},()=>{p(o),T()}).subscribe();return()=>s.unsubscribe()},[f.id]),e.jsxs("div",{className:"space-y-6",children:[U.map(s=>e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50",children:e.jsxs(v,{className:"w-full max-w-md lg:max-w-lg bg-slate-800 border-slate-700 relative",children:[e.jsx(E,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(H,{className:"text-lg text-white pr-8",children:s.title}),e.jsx(c,{variant:"ghost",size:"sm",onClick:()=>w(s.id),className:"absolute top-2 right-2 w-8 h-8 p-0 text-slate-400 hover:text-white",children:e.jsx(oe,{className:"w-4 h-4"})})]})}),e.jsxs(_,{className:"space-y-4",children:[e.jsx("div",{className:"text-slate-300 text-sm max-h-60 overflow-y-auto",dangerouslySetInnerHTML:{__html:s.content}}),e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t border-slate-700",children:[e.jsx("span",{className:"text-xs text-slate-500",children:I(s.created_at)}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{variant:"outline",size:"sm",onClick:()=>w(s.id,!0),children:"오늘 하루 보지 않기"}),e.jsx(c,{size:"sm",onClick:()=>w(s.id),className:"bg-blue-600 hover:bg-blue-700",children:"확인"})]})]})]})]})},s.id)),e.jsx("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"공지사항"}),e.jsx("p",{className:"text-slate-400",children:"중요한 안내사항을 확인하세요"})]})}),e.jsx(v,{className:"bg-slate-800/50 border-slate-700",children:e.jsx(_,{className:"p-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(de,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4"}),e.jsx(Z,{placeholder:"공지사항 제목이나 내용으로 검색...",value:u,onChange:s=>L(s.target.value),className:"pl-10 bg-slate-700/50 border-slate-600 text-white"})]})})}),e.jsxs(v,{className:"bg-slate-800/50 border-slate-700",children:[e.jsx(E,{children:e.jsxs(H,{className:"flex items-center text-white",children:[e.jsx(B,{className:"w-5 h-5 mr-2 text-blue-400"}),"공지사항 (",g.length,")"]})}),e.jsx(_,{children:J?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(ee,{})}):g.length>0?e.jsxs("div",{className:"space-y-4",children:[g.map(s=>{const t=K.includes(s.id);return e.jsx("div",{className:"p-4 bg-slate-700/30 rounded-lg hover:bg-slate-700/50 transition-colors",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`w-2 h-2 rounded-full mt-2 flex-shrink-0 ${s.is_read?"bg-slate-500":"bg-blue-400"}`}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3 mb-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[s.is_pinned&&e.jsxs(M,{className:"bg-red-500 text-white text-xs",children:[e.jsx(me,{className:"w-3 h-3 mr-1"}),"고정"]}),s.is_popup&&e.jsx(M,{className:"bg-purple-500 text-white text-xs",children:"팝업"})]}),e.jsx("h3",{className:`font-medium cursor-pointer hover:text-blue-400 transition-colors ${s.is_read?"text-slate-300":"text-white"}`,onClick:()=>A(s),children:s.title})]}),e.jsx(c,{variant:"ghost",size:"sm",onClick:()=>P(s.id),className:"flex-shrink-0 w-8 h-8 p-0",children:t?e.jsx(xe,{className:"w-4 h-4"}):e.jsx(he,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-slate-500 mb-2",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(O,{className:"w-3 h-3"}),G(s.created_at)]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(R,{className:"w-3 h-3"}),s.view_count.toLocaleString()]}),s.partners?.nickname&&e.jsxs("span",{children:["관리자: ",s.partners.nickname]})]}),e.jsx(re,{open:t,onOpenChange:()=>P(s.id),children:e.jsx(ie,{children:e.jsx("div",{className:"text-slate-300 text-sm mt-3 p-3 bg-slate-600/30 rounded border-l-4 border-blue-500",dangerouslySetInnerHTML:{__html:s.content}})})}),!t&&e.jsx("p",{className:"text-slate-400 text-sm",children:V(s.content.replace(/<[^>]*>/g,""))})]})]})},s.id)}),j>1&&e.jsxs("div",{className:"flex justify-center gap-2 pt-4",children:[e.jsx(c,{variant:"outline",size:"sm",onClick:()=>p(o-1),disabled:o<=1,children:"이전"}),e.jsxs("span",{className:"flex items-center px-3 text-slate-300",children:[o," / ",j]}),e.jsx(c,{variant:"outline",size:"sm",onClick:()=>p(o+1),disabled:o>=j,children:"다음"})]})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(B,{className:"w-16 h-16 text-slate-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-medium text-white mb-2",children:u?"검색 결과가 없습니다":"공지사항이 없습니다"}),e.jsx("p",{className:"text-slate-400 mb-4",children:u?"다른 검색어로 시도해보세요.":"새로운 공지사항이 등록되면 알려드리겠습니다."}),u&&e.jsx(c,{variant:"outline",onClick:()=>L(""),children:"전체 공지사항 보기"})]})})]}),e.jsx(se,{open:F,onOpenChange:D,children:e.jsx(te,{className:"max-w-2xl bg-slate-800 border-slate-700 text-white max-h-[80vh] overflow-y-auto",children:i&&e.jsxs(e.Fragment,{children:[e.jsxs(ae,{children:[e.jsx(ne,{className:"text-xl",children:i.title}),e.jsx(le,{className:"text-slate-400",children:"공지사항 내용을 확인하실 수 있습니다."}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-slate-400 pt-2",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(O,{className:"w-4 h-4"}),I(i.created_at)]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(R,{className:"w-4 h-4"}),"조회 ",i.view_count.toLocaleString()]}),i.partners?.nickname&&e.jsxs("span",{children:["작성자: ",i.partners.nickname]})]})]}),e.jsx("div",{className:"pt-4",children:e.jsx("div",{className:"prose prose-invert max-w-none text-slate-300",dangerouslySetInnerHTML:{__html:i.content}})})]})})})]})}export{_e as UserNotice};
