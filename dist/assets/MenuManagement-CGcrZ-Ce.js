import{k as J,r as c,j as e,aG as A,Y as K,R as f,B as u,w as M,S as U,x as W,y as X,z as Z,D as ee,aP as se,ay as j,H as te,a0 as ae,s as x,t as l}from"./index-DxPzcoqH.js";import{S as re}from"./switch-D4pQqwaH.js";import{C as G}from"./circle-alert-mcz1CrVD.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=[["path",{d:"M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z",key:"zw3jo"}],["path",{d:"M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12",key:"1wduqc"}],["path",{d:"M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17",key:"kqbvx6"}]],R=J("layers",le);function me({user:m}){const[h,b]=c.useState([]),[o,I]=c.useState(""),[O,_]=c.useState(null),[p,w]=c.useState([]),[g,N]=c.useState([]),[y,C]=c.useState(!1),[k,$]=c.useState(!1),[T,L]=c.useState(!1),[ne,V]=c.useState(new Set),E=async()=>{try{if(C(!0),m.level===1){const{data:s,error:t}=await x.from("partners").select("id, username, nickname, level, status").eq("status","active").order("level",{ascending:!0}).order("nickname",{ascending:!0});if(t)throw t;b(s||[]),(!s||s.length===0)&&l.warning("활성화된 파트너가 없습니다.")}else{const{data:s,error:t}=await x.rpc("get_hierarchical_partners",{p_partner_id:m.id});if(t){console.error("하위 파트너 조회 실패:",t);const{data:a,error:r}=await x.from("partners").select("id, username, nickname, level, status").eq("status","active").eq("parent_id",m.id).order("level",{ascending:!0}).order("nickname",{ascending:!0});r?(console.error("직접 하위 조회도 실패:",r),b([])):(b(a||[]),(!a||a.length===0)&&l.warning("관리할 수 있는 파트너가 없습니다."))}else{const a=(s||[]).filter(r=>r.status==="active");b(a),console.log("✅ 계층 파트너 조회 완료:",{total:a.length,by_level:a.reduce((r,n)=>(r[n.level]=(r[n.level]||0)+1,r),{})}),a.length===0&&l.warning("관리할 수 있는 파트너가 없습니다.")}}}catch(s){console.error("파트너 목록 로드 실패:",s),l.error("파트너 목록을 불러오는데 실패했습니다.")}finally{C(!1)}},q=async()=>{try{const{data:s,error:t,count:a}=await x.from("menu_permissions").select("*",{count:"exact"}).eq("is_visible",!0).order("display_order",{ascending:!0}).order("menu_name",{ascending:!0});if(console.log("메뉴 권한 조회 결과:",{success:!t,count:a,dataLength:s?.length,error:t}),t){console.error("메뉴 권한 목록 로드 에러:",t),t.code==="PGRST116"||t.message?.includes("permission")?l.error("메뉴 데이터 접근 권한이 없습니다."):l.error(`메뉴 권한 목록을 불러오는데 실패했습니다: ${t.message}`),w([]);return}w(s||[]),!s||s.length===0?l.warning("메뉴 권한 데이터가 없습니다. DB 스키마(205번)를 실행해주세요.",{description:"Supabase SQL Editor에서 database/205_menu-management-schema.sql 파일을 실행하세요."}):console.log(`✅ 메뉴 권한 ${s.length}개 로드 성공`)}catch(s){console.error("메뉴 권한 목록 로드 실패:",s),l.error("메뉴 권한 목록을 불러오는데 실패했습니다."),w([])}},S=async s=>{if(!s){N([]),_(null);return}try{$(!0);const t=h.find(i=>i.id===s);_(t||null);const{data:a,error:r}=await x.from("partner_menu_permissions").select(`
          *,
          menu_permission:menu_permissions(*)
        `).eq("partner_id",s);if(r)throw r;if(!t){l.error("선택된 파트너 정보를 찾을 수 없습니다.");return}const d=p.filter(i=>!a?.some(v=>v.menu_permission_id===i.id));if(d.length>0){const i=d.map(F=>({partner_id:s,menu_permission_id:F.id,is_enabled:!0})),{error:v}=await x.from("partner_menu_permissions").insert(i);v&&console.error("기본 메뉴 권한 생성 실패:",v)}const{data:P,error:D}=await x.from("partner_menu_permissions").select(`
          *,
          menu_permission:menu_permissions(*)
        `).eq("partner_id",s);if(D)throw D;const z=(P||[]).map(i=>({...i,menu_permission:Array.isArray(i.menu_permission)?i.menu_permission[0]:i.menu_permission}));N(z);const Y=new Set(z.map(i=>i.menu_permission?.parent_menu||"기본 메뉴").filter(Boolean));V(Y)}catch(t){console.error("파트너 메뉴 권한 로드 실패:",t),l.error("파트너 메뉴 권한을 불러오는데 실패했습니다."),N([])}finally{$(!1)}},H=async(s,t)=>{try{L(!0);const a=s.menu_permission?.menu_name||"메뉴";if(console.log("🔧 메뉴 권한 업데이트 시작:",{menu_name:a,pmp_id:s.id,menu_permission_id:s.menu_permission_id,current_enabled:s.is_enabled,new_enabled:t,has_menu_permission:!!s.menu_permission}),!s.id){console.error("❌ PMP ID가 없습니다:",s),l.error(`${a}: ID가 없어 업데이트할 수 없습니다.`);return}if(!s.menu_permission_id){console.error("❌ menu_permission_id가 없습니다:",s),l.error(`${a}: menu_permission_id가 없어 업데이트할 수 없습니다.`);return}const{error:r}=await x.from("partner_menu_permissions").update({is_enabled:t,updated_at:new Date().toISOString()}).eq("id",s.id);if(r)throw console.error("❌ DB 업데이트 실패:",{menu_name:a,error_code:r.code,error_message:r.message,error_details:r.details}),r;console.log("✅ DB 업데이트 성공:",{menu_name:a,new_enabled:t}),N(n=>n.map(d=>d.id===s.id?{...d,is_enabled:t}:d)),l.success(`${a} ${t?"활성화":"비활성화"} 완료`,{description:`메뉴 권한이 성공적으로 ${t?"활성화":"비활성화"}되었습니다.`})}catch(a){const r=s.menu_permission?.menu_name||"메뉴";console.error("❌ 메뉴 권한 업데이트 실패:",a),l.error(`${r} 업데이트 실패: ${a.message||"알 수 없는 오류"}`)}finally{L(!1)}};c.useEffect(()=>{E(),q()},[m.id]),c.useEffect(()=>{if(o&&p.length>0){const s=h.find(t=>t.id===o);_(s||null),S(o)}},[o,p,h]);const Q=g.reduce((s,t)=>{const a=t.menu_permission?.parent_menu||"기본 메뉴";return s[a]||(s[a]=[]),s[a].push(t),s},{}),B=s=>{switch(s){case 1:return"badge-premium-danger";case 2:return"badge-premium-primary";case 3:return"badge-premium-success";default:return"badge-premium-warning"}};return e.jsxs("div",{className:"h-full flex flex-col overflow-hidden p-4 space-y-3",children:[e.jsx("div",{className:"flex items-center justify-between px-4 py-2 rounded-lg bg-slate-900/50 border border-blue-500/30 flex-shrink-0",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-blue-500/20 to-blue-600/20 border border-blue-400/30",children:e.jsx(A,{className:"h-5 w-5 text-blue-400"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-slate-100",children:"메뉴 관리"}),e.jsx("p",{className:"text-xs text-slate-400",children:m.nickname})]})]})}),e.jsxs("div",{className:"glass-card p-3 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"h-4 w-4 text-blue-400"}),e.jsx("span",{className:"text-sm text-slate-200",children:m.level===1?"대본사 선택":"파트너 선택"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[y&&e.jsx(f,{className:"h-3 w-3 animate-spin text-blue-400"}),e.jsxs(u,{variant:"outline",className:"border-blue-400/30 text-blue-300 text-xs h-5",children:[e.jsx(R,{className:"h-3 w-3 mr-1"}),h.length,"개"]})]})]}),e.jsx("div",{children:y?e.jsxs("div",{className:"flex items-center justify-center py-4 border border-slate-700/50 rounded-lg bg-slate-900/30",children:[e.jsx(f,{className:"h-4 w-4 animate-spin mr-2 text-blue-400"}),e.jsx("span",{className:"text-sm text-slate-300",children:"로딩 중..."})]}):h.length===0?e.jsxs("div",{className:"text-center py-6 border border-slate-700/50 rounded-lg bg-slate-900/30",children:[e.jsx(G,{className:"h-8 w-8 mx-auto mb-2 text-slate-500"}),e.jsx("p",{className:"text-sm text-slate-300 mb-2",children:"활성화된 조직이 없습니다"}),e.jsxs(M,{onClick:E,variant:"outline",size:"sm",children:[e.jsx(f,{className:"h-3 w-3 mr-1"}),"다시 시도"]})]}):e.jsxs(U,{value:o,onValueChange:I,disabled:y,children:[e.jsx(W,{className:"w-full input-premium h-9 text-sm",children:e.jsx(X,{placeholder:m.level===1?"메뉴를 관리할 대본사를 선택하세요":"메뉴를 관리할 파트너를 선택하세요"})}),e.jsx(Z,{className:"bg-slate-900 border-slate-700",children:h.sort((s,t)=>s.level!==t.level?s.level-t.level:s.nickname.localeCompare(t.nickname)).map(s=>{const t=Math.max(0,s.level-2),a=t>0?`${t*1.5}rem`:"0";return e.jsx(ee,{value:s.id,className:"text-slate-200 focus:bg-slate-800 py-1",style:{paddingLeft:`calc(0.5rem + ${a})`},children:e.jsxs("div",{className:"flex items-center gap-2",children:[t>0&&e.jsx("span",{className:"text-slate-600 text-xs",children:"└─".repeat(1)}),e.jsxs(u,{className:`${B(s.level)} text-xs h-4`,children:["L",s.level]}),e.jsx("span",{className:"text-sm",children:s.nickname}),e.jsxs("span",{className:"text-slate-400 text-xs",children:["(",s.username,")"]})]})},s.id)})})]})})]}),o&&e.jsxs("div",{className:"glass-card flex flex-col flex-1 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 border-b border-slate-700/50 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-4 w-4 text-emerald-400"}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-sm text-slate-200",children:[O?.nickname," 메뉴 노출 설정"]}),e.jsx("p",{className:"text-xs text-slate-400",children:"활성화된 메뉴만 사이드바에 표시"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(u,{variant:"outline",className:"border-emerald-400/30 text-emerald-300 text-xs h-5",children:[e.jsx(j,{className:"h-3 w-3 mr-1"}),g.filter(s=>s.is_enabled).length,"/",g.length]}),e.jsxs(M,{onClick:()=>S(o),variant:"outline",size:"sm",disabled:k,className:"border-blue-400/30 hover:bg-blue-500/10 h-7 text-xs px-2",children:[e.jsx(f,{className:`h-3 w-3 mr-1 ${k?"animate-spin":""}`}),"새로고침"]})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-3",children:k?e.jsxs("div",{className:"flex flex-col items-center justify-center py-8",children:[e.jsx("div",{className:"loading-premium mb-4"}),e.jsx("span",{className:"text-sm text-slate-300",children:"메뉴 권한을 불러오는 중..."})]}):g.length===0?e.jsxs("div",{className:"text-center py-8 border border-slate-700/50 rounded-lg bg-slate-900/30",children:[e.jsx(G,{className:"h-12 w-12 mx-auto mb-3 text-slate-500"}),e.jsx("p",{className:"text-sm text-slate-300 mb-2",children:"메뉴 데이터가 없습니다"}),e.jsx("p",{className:"text-xs text-slate-400 mb-3",children:p.length===0?"menu_permissions 테이블에 기본 메뉴 데이터가 없습니다.":"해당 파트너에게 할당 가능한 메뉴가 없거나 데이터를 불러올 수 없습니다."}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsxs("div",{className:"text-xs text-slate-500",children:[e.jsxs("p",{children:["• 기본 메뉴: ",p.length,"개"]}),e.jsxs("p",{children:["• 파트너 메뉴: ",g.length,"개"]})]}),p.length===0&&e.jsxs("div",{className:"bg-amber-500/10 border border-amber-500/30 rounded-lg p-3 text-left",children:[e.jsx("p",{className:"text-xs text-amber-300 mb-1",children:"⚠️ 조치 필요"}),e.jsx("p",{className:"text-xs text-slate-400",children:"205_menu-management-schema.sql 실행 필요"})]})]}),e.jsxs(M,{onClick:()=>{q(),S(o)},variant:"outline",size:"sm",className:"btn-premium-primary",children:[e.jsx(f,{className:"h-3 w-3 mr-1"}),"다시 시도"]})]}):e.jsx("div",{className:"space-y-1.5",children:Object.entries(Q).map(([s,t])=>{const a=t.filter(r=>r.is_enabled).length;return e.jsxs("div",{className:"glass-card border-slate-700/50",children:[e.jsxs("div",{className:"px-3 py-1.5 bg-slate-800/50 border-b border-slate-700/50 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{className:"h-3 w-3 text-blue-400"}),e.jsx("h4",{className:"text-xs text-slate-200",children:s}),e.jsxs(u,{variant:"outline",className:"border-slate-600/50 text-slate-400 text-[10px] h-4 px-1",children:[t.length,"개"]})]}),e.jsxs(u,{className:`text-[10px] h-4 px-1 ${a===t.length?"badge-premium-success":a>0?"badge-premium-warning":"badge-premium-danger"}`,children:[a," / ",t.length," 활성"]})]}),e.jsx("div",{className:"grid grid-cols-2 lg:grid-cols-3 gap-2 p-2",children:t.sort((r,n)=>{const d=r.menu_permission?.display_order??999,P=n.menu_permission?.display_order??999;return d-P}).map(r=>{const n=r.menu_permission;return n?e.jsxs("div",{className:`
                                px-2 py-1.5 rounded-lg border transition-all
                                ${r.is_enabled?"bg-emerald-500/5 border-emerald-500/30 hover:bg-emerald-500/10":"bg-slate-800/20 border-slate-700/30 hover:bg-slate-800/40"}
                              `,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-1.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5 flex-1 min-w-0",children:[r.is_enabled?e.jsx(te,{className:"h-3 w-3 text-emerald-400 flex-shrink-0 mt-0.5"}):e.jsx(ae,{className:"h-3 w-3 text-slate-500 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-0.5",children:[e.jsx("span",{className:"text-xs text-slate-200 truncate",children:n.menu_name}),e.jsxs(u,{className:`text-[8px] px-1 py-0 h-3 flex-shrink-0 ${B(n.partner_level)}`,children:["L",n.partner_level]})]}),e.jsx("p",{className:"text-[9px] text-slate-400 truncate",children:n.menu_path})]})]}),e.jsx(re,{checked:r.is_enabled,disabled:T,onCheckedChange:d=>H(r,d),className:"flex-shrink-0 scale-75"})]}),r.is_enabled&&e.jsx("div",{className:"flex items-center justify-end",children:e.jsx(u,{className:"badge-premium-success text-[9px] h-3.5 px-1",children:"활성"})})]},r.id):null})})]},s)})})})]}),!o&&e.jsx("div",{className:"glass-card flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center max-w-md px-4 space-y-3",children:[e.jsx("div",{className:"p-4 rounded-xl bg-gradient-to-br from-blue-500/10 to-blue-600/5 border border-blue-400/20 inline-block",children:e.jsx(A,{className:"h-12 w-12 text-blue-400"})}),e.jsx("h3",{className:"text-lg text-slate-200",children:m.level===1?"대본사를 선택하세요":"파트너를 선택하세요"}),e.jsxs("p",{className:"text-xs text-slate-400",children:["위에서 ",m.level===1?"대본사":"파트너","를 선택하면 해당 조직의 메뉴 노출 설정을 관리할 수 있습니다."]}),e.jsxs("div",{className:"pt-4 space-y-2 text-left",children:[e.jsxs("div",{className:"flex items-start gap-3 text-sm text-slate-400",children:[e.jsx(j,{className:"h-5 w-5 text-emerald-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:"활성화된 메뉴만 표시"})]}),e.jsxs("div",{className:"flex items-start gap-3 text-sm text-slate-400",children:[e.jsx(j,{className:"h-5 w-5 text-emerald-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:"메뉴별 활성화/비활성화 설정"})]}),e.jsxs("div",{className:"flex items-start gap-3 text-sm text-slate-400",children:[e.jsx(j,{className:"h-5 w-5 text-emerald-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:"레벨에 맞는 메뉴만 선택 가능"})]}),e.jsxs("div",{className:"flex items-start gap-3 text-sm text-slate-400",children:[e.jsx(j,{className:"h-5 w-5 text-emerald-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:"실시간 사이드바 반영"})]})]})]})})]})}export{me as MenuManagement};
