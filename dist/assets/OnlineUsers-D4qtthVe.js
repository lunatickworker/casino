import{r as i,j as t}from"./react-core-CwM-CeLv.js";import{B as q,i as h,D as fe,s as m,E as R,F as U}from"./index-Cjgf7-0D.js";import{D as he}from"./DataTable-Cv2AQ19s.js";import{k as l}from"./vendor-CQn7sZ7L.js";import{A as K,a as G,b as V,c as F,d as H,e as Q}from"./AdminDialog-BhDtprfW.js";import{M as k}from"./MetricCard-BPAAhMVT.js";import{a1 as ge,a2 as _e,R as W,a3 as Y,U as pe,u as xe,i as be,t as ve}from"./lucide-icons-D2Y5yybo.js";import"./radix-ui-SX2QAG6c.js";import"./supabase-r6ABpEO8.js";const Se={1:"마이크로게이밍",17:"플레이앤고",20:"CQ9 게이밍",21:"제네시스 게이밍",22:"하바네로",23:"게임아트",27:"플레이텍",38:"블루프린트",39:"부운고",40:"드라군소프트",41:"엘크 스튜디오",47:"드림테크",51:"칼람바 게임즈",52:"모빌롯",53:"노리밋 시티",55:"OMI 게이밍",56:"원터치",59:"플레이슨",60:"푸쉬 게이밍",61:"퀵스핀",62:"RTG 슬롯",63:"리볼버 게이밍",65:"슬롯밀",66:"스피어헤드",70:"썬더킥",72:"우후 게임즈",74:"릴렉스 게이밍",75:"넷엔트",76:"레드타이거",87:"PG소프트",88:"플레이스타",90:"빅타임게이밍",300:"프라그마틱 플레이",410:"에볼루션 게이밍",77:"마이크로게이밍 라이브",2:"Vivo 게이밍",30:"아시아 게이밍",78:"프라그마틱 플레이 라이브",86:"섹시게이밍",11:"비비아이엔",28:"드림게임",89:"오리엔탈게임",91:"보타",44:"이주기",85:"플레이텍 라이브",0:"제네럴 카지노"},ye={41e4:"에볼루션 라이브카지노",77060:"마이크로게이밍 라이브카지노",2029:"Vivo 라이브카지노",3e4:"아시아게이밍 라이브카지노",78001:"프라그마틱 라이브카지노",86001:"섹시게이밍 라이브카지노",11e3:"비비아이엔 라이브카지노",28e3:"드림게임 라이브카지노",89e3:"오리엔탈게임 라이브카지노",91e3:"보타 라이브카지노",44006:"이주기 라이브카지노",85036:"플레이텍 라이브카지노",0:"제네럴 라이브카지노"};function Oe({user:f}){const[c,J]=i.useState([]),[N,M]=i.useState(!0),[I,A]=i.useState(!1),[v,$]=i.useState(null),[X,S]=i.useState(!1),[O,B]=i.useState(null),[je,Z]=i.useState(0),[d,y]=i.useState(new Set),[ee,j]=i.useState(!1);i.useEffect(()=>{const e=setInterval(()=>Z(s=>s+1),1e3);return()=>clearInterval(e)},[]);const p=async(e=!1)=>{try{!e&&N?M(!0):A(!0);const s=new Date,r=new Date(s.getTime()-6e4);console.log("🕐 세션 자동 종료 체크:",{현재시간:s.toISOString(),기준시간_60초전:r.toISOString()});const{data:n,error:o}=await fe.from("game_launch_sessions").update({status:"auto_ended",ended_at:s.toISOString()}).eq("status","active").lt("last_activity_at",r.toISOString()).select("id, user_id, last_activity_at");if(o)console.error("❌ 세션 자동 종료 오류:",o);else if(n&&n.length>0){console.log(`✅ ${n.length}개 세션 자동 종료:`,n.map(a=>({id:a.id,user_id:a.user_id,마지막활동:a.last_activity_at,경과시간_초:Math.floor((s.getTime()-new Date(a.last_activity_at).getTime())/1e3)})));for(const a of n)await ae(a.user_id)}let g=m.from("game_launch_sessions").select(`
          id,
          session_id,
          user_id,
          game_id,
          balance_before,
          launched_at,
          last_activity_at,
          users!inner(
            id,
            username,
            nickname,
            balance,
            ip_address,
            device_info,
            referrer_id
          )
        `).eq("status","active").order("last_activity_at",{ascending:!1});if(f.partner_type!=="시스템관리자"){const{data:a}=await m.from("partners").select("id").or(`parent_id.eq.${f.id},id.eq.${f.id}`),x=a?.map(b=>b.id)||[f.id];g=g.in("users.referrer_id",x)}const{data:w,error:E}=await g;if(E)throw E;const P=[...new Set((w||[]).map(a=>a.game_id).filter(Boolean))];let z={};if(P.length>0){const{data:a}=await m.from("games").select("id, name, provider_id, game_providers(name)").in("id",P);a&&(z=Object.fromEntries(a.map(x=>[x.id,x])))}const ue=(w||[]).map(a=>{const x=a.users.ip_address||"-";let b="PC";if(a.users.device_info){const _=a.users.device_info;if(_.device==="Mobile"||_.device==="mobile")b="Mobile";else if(_.platform){const u=String(_.platform).toLowerCase();(u.includes("android")||u.includes("iphone")||u.includes("ipad")||u.includes("mobile"))&&(b="Mobile")}else if(_.userAgent){const u=String(_.userAgent).toLowerCase();(u.includes("mobile")||u.includes("android")||u.includes("iphone")||u.includes("ipad"))&&(b="Mobile")}}const L=Math.floor(a.game_id/1e3),me=Se[L]||`Provider ${L}`;let C=ye[a.game_id];return C||(C=z[a.game_id]?.name||`Game ${a.game_id}`),{id:a.id,session_id:a.session_id,user_id:a.users.id,username:a.users.username,nickname:a.users.nickname||a.users.username,game_name:C,provider_name:me,balance_before:Number(a.balance_before)||0,current_balance:Number(a.users.balance)||0,device_type:b,ip_address:x,launched_at:a.launched_at,last_activity_at:a.last_activity_at}});J(ue)}catch(s){console.error("세션 로드 오류:",s),l.error("세션 로드 실패")}finally{M(!1),A(!1)}};i.useEffect(()=>{console.log("🔄 OnlineUsers 30초 타이머 시작"),p();const e=setInterval(()=>{console.log("⏰ 30초 경과 - 세션 자동 종료 체크 실행"),p()},3e4);return()=>{console.log("🛑 OnlineUsers 30초 타이머 종료"),clearInterval(e)}},[f.id,f.partner_type]),i.useEffect(()=>{const e=async()=>{try{const r=new Date(Date.now()-144e5).toISOString(),{data:n,error:o}=await m.from("game_launch_sessions").delete().in("status",["auto_ended","ended","force_ended"]).lt("ended_at",r).select("id");o?console.error("세션 정리 오류:",o):n&&n.length>0&&console.log(`🗑️ ${n.length}개 오래된 세션 삭제 (4시간 경과)`)}catch(r){console.error("세션 정리 실행 오류:",r)}};e();const s=setInterval(e,3600*1e3);return()=>clearInterval(s)},[]);const se=e=>{const s=new Date(e).getTime(),r=Date.now(),n=Math.max(0,r-s);if(isNaN(n))return"0분";const o=Math.floor(n/1e3/60);if(o<60)return`${o}분`;const g=Math.floor(o/60),w=o%60;return`${g}시간 ${w}분`},te=async e=>{try{B(e.user_id);const s=await R(f.id);if(!s){l.error("API 설정을 찾을 수 없습니다");return}const r=await U(s.opcode,e.username,s.token,s.secret_key);r&&r.success&&typeof r.balance=="number"?(await m.from("users").update({balance:r.balance}).eq("id",e.user_id),l.success("보유금 동기화 완료"),p()):l.error(r?.error||"보유금 조회 실패")}catch(s){console.error("보유금 동기화 오류:",s),l.error("보유금 동기화 실패")}finally{B(null)}},ae=async e=>{try{const s=await R(f.id);if(!s){console.error("세션 종료 시 API 설정을 찾을 수 없습니다");return}const r=await m.from("users").select("username").eq("id",e).single();if(!r.data){console.error("세션 종료 시 사용자 정보를 찾을 수 없습니다");return}const n=await U(s.opcode,r.data.username,s.token,s.secret_key);n&&n.success&&typeof n.balance=="number"?(await m.from("users").update({balance:n.balance}).eq("id",e),console.log(`세션 종료 시 보유금 동기화 완료: ${e}`)):console.error(n?.error||"세션 종료 시 보유금 조회 실패")}catch(s){console.error("세션 종료 시 보유금 동기화 오류:",s)}},re=async()=>{if(v)try{const{error:e}=await m.from("game_launch_sessions").update({status:"force_ended",ended_at:new Date().toISOString()}).eq("id",v.id);if(e){console.error("세션 종료 오류:",e),l.error(`세션 종료 실패: ${e.message}`);return}l.success("세션 강제 종료 완료"),S(!1),$(null),await p()}catch(e){console.error("강제 종료 오류:",e),l.error("강제 종료 실패")}},ne=async()=>{if(d.size!==0)try{const e=Array.from(d),{error:s}=await m.from("game_launch_sessions").update({status:"force_ended",ended_at:new Date().toISOString()}).in("id",e);if(s){console.error("일괄 종료 오류:",s),l.error(`일괄 종료 실패: ${s.message}`);return}l.success(`${d.size}개 세션 강제 종료 완료`),j(!1),y(new Set),await p()}catch(e){console.error("일괄 강제 종료 오류:",e),l.error("일괄 강제 종료 실패")}},oe=e=>{y(s=>{const r=new Set(s);return r.has(e)?r.delete(e):r.add(e),r})},ie=()=>{d.size===c.length?y(new Set):y(new Set(c.map(e=>e.id)))},ce=c.length,le=c.reduce((e,s)=>e+s.current_balance,0),D=c.reduce((e,s)=>e+(s.current_balance-s.balance_before),0);let T=0;if(c.length>0){const e=Date.now(),s=c.reduce((r,n)=>{const o=new Date(n.launched_at).getTime(),g=Math.max(0,e-o);return r+g/1e3/60},0);T=Math.floor(s/c.length)}const de=[{key:"checkbox",header:t.jsx("input",{type:"checkbox",checked:d.size===c.length&&c.length>0,onChange:ie,className:"w-4 h-4 rounded border-slate-600 bg-slate-700 text-purple-500 focus:ring-purple-500 focus:ring-offset-slate-900"}),render:(e,s)=>t.jsx("input",{type:"checkbox",checked:d.has(s.id),onChange:()=>oe(s.id),className:"w-4 h-4 rounded border-slate-600 bg-slate-700 text-purple-500 focus:ring-purple-500 focus:ring-offset-slate-900"})},{key:"username",header:"사용자",sortable:!0},{key:"nickname",header:"닉네임",sortable:!0},{key:"game_name",header:"게임",sortable:!0,render:(e,s)=>t.jsxs("div",{className:"space-y-1",children:[t.jsx("div",{className:"text-slate-200",children:e}),t.jsx(q,{variant:"outline",className:"bg-emerald-500/10 text-emerald-400 border-emerald-500/30",children:s.provider_name})]})},{key:"balance_before",header:"게임 시작금",sortable:!0,render:e=>t.jsxs("span",{className:"font-mono text-slate-300",children:["₩",e.toLocaleString()]})},{key:"current_balance",header:"변경 보유금",sortable:!0,render:(e,s)=>{const r=e-s.balance_before,n=r>=0?"text-emerald-400":"text-red-400",o=r>=0?"+":"";return t.jsxs("div",{className:"space-y-1",children:[t.jsxs("div",{className:"font-mono text-slate-200",children:["₩",e.toLocaleString()]}),r!==0&&t.jsxs("div",{className:`text-xs font-mono ${n}`,children:[o,"₩",r.toLocaleString()]})]})}},{key:"device_type",header:"접속경로",render:e=>t.jsxs(q,{variant:e==="Mobile"?"default":"secondary",className:"gap-1",children:[e==="Mobile"?t.jsx(ge,{className:"w-3 h-3"}):t.jsx(_e,{className:"w-3 h-3"}),e]})},{key:"ip_address",header:"IP 주소",sortable:!0,render:e=>t.jsx("span",{className:"text-slate-300 font-mono text-xs",children:e})},{key:"launched_at",header:"접속 시간",render:e=>t.jsx("span",{className:"text-slate-300",children:se(e)})},{key:"actions",header:"관리",render:(e,s)=>t.jsxs("div",{className:"flex items-center gap-2 justify-center",children:[t.jsx(h,{variant:"ghost",size:"sm",onClick:()=>te(s),disabled:O===s.user_id,className:"text-slate-400 hover:text-slate-200",children:t.jsx(W,{className:`w-3 h-3 ${O===s.user_id?"animate-spin":""}`})}),t.jsx(h,{variant:"ghost",size:"sm",onClick:()=>{$(s),S(!0)},className:"bg-red-500/10 text-red-400 hover:bg-red-500/20 hover:text-red-300",children:t.jsx(Y,{className:"w-3 h-3"})})]})}];return t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"text-2xl font-bold text-slate-100",children:"온라인 현황"}),t.jsx("p",{className:"text-sm text-slate-400 mt-1",children:"실시간 게임 사용자 관리"})]}),t.jsxs("div",{className:"flex items-center gap-3",children:[d.size>0&&t.jsxs(h,{variant:"destructive",onClick:()=>j(!0),className:"bg-red-500/10 text-red-400 hover:bg-red-500/20 hover:text-red-300 border border-red-500/30",children:[t.jsx(Y,{className:"w-4 h-4 mr-2"}),"선택한 게임 종료 (",d.size,")"]}),t.jsxs(h,{onClick:()=>p(!0),disabled:N||I,children:[t.jsx(W,{className:`w-4 h-4 mr-2 ${I?"animate-spin":""}`}),"새로고침"]})]})]}),t.jsxs("div",{className:"grid gap-5 md:grid-cols-2 lg:grid-cols-4",children:[t.jsx(k,{title:"온라인 사용자",value:`${ce}명`,subtitle:"실시간 접속자",icon:pe,color:"purple"}),t.jsx(k,{title:"총 게임 보유금",value:`₩${le.toLocaleString()}`,subtitle:"게임 내 총 잔고",icon:xe,color:"amber"}),t.jsx(k,{title:"총 손익",value:`₩${D.toLocaleString()}`,subtitle:D>=0?"↑ 사용자 이익":"↓ 사용자 손실",icon:be,color:D>=0?"green":"red"}),t.jsx(k,{title:"평균 세션",value:`${T}분`,subtitle:"평균 접속 시간",icon:ve,color:"cyan"})]}),t.jsx(he,{data:c,columns:de,loading:N,emptyMessage:"현재 온라인 사용자가 없습니다"}),t.jsx(K,{open:X,onOpenChange:S,children:t.jsxs(G,{children:[t.jsxs(V,{children:[t.jsx(F,{children:"세션 강제 종료"}),t.jsxs(H,{children:[v?.username,"(",v?.nickname,") 님의 세션을 강제 종료하시겠습니까?"]})]}),t.jsxs(Q,{children:[t.jsx(h,{variant:"outline",onClick:()=>S(!1),children:"취소"}),t.jsx(h,{variant:"destructive",onClick:re,children:"강제 종료"})]})]})}),t.jsx(K,{open:ee,onOpenChange:j,children:t.jsxs(G,{children:[t.jsxs(V,{children:[t.jsx(F,{children:"선택한 게임 일괄 종료"}),t.jsxs(H,{children:["선택한 ",d.size,"개의 게임 세션을 모두 강제 종료하시겠습니까?"]})]}),t.jsxs(Q,{children:[t.jsx(h,{variant:"outline",onClick:()=>j(!1),children:"취소"}),t.jsxs(h,{variant:"destructive",onClick:ne,children:[d.size,"개 강제 종료"]})]})]})})]})}export{Oe as OnlineUsers};
