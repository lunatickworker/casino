import{v as G,r as n,j as e,L as V,a9 as z,aa as U,a8 as N,T as k,U as H,a3 as L,C as W,a as Y,b as J,e as K,E as Q,S as X,x as Z,y as ee,z as te,D as f,w as ae,R as se,c as re,B as F,s as S,t as y}from"./index-5VwzyDkW.js";import{D as ne}from"./DataTable-4wEQnOdr.js";import{M as d}from"./MetricCard-C0tW78RF.js";import{T as le}from"./triangle-alert-C98kHEOk.js";import"./search-CYltF_Pd.js";function ge({user:_}){const{lastMessage:p,sendMessage:oe}=G(),[j,w]=n.useState(!0),[v,b]=n.useState(!1),[I,M]=n.useState([]),[m,T]=n.useState("month"),[l,O]=n.useState({totalCommission:0,dailyAverage:0,monthlyGrowth:0,activePartners:0,totalBetVolume:0,avgCommissionRate:0}),[D,R]=n.useState({lastSync:new Date,isSync:!0,errorCount:0}),g=async(t=!1)=>{try{t&&w(!0);const a=h(m);let s=S.from("settlements").select(`
          *,
          partner:partners!settlements_partner_id_fkey(id, nickname, level, commission_rolling, commission_losing)
        `).gte("created_at",a.start).lte("created_at",a.end);_.level>1&&(s=s.eq("partner_id",_.id));const{data:o,error:c}=await s.order("created_at",{ascending:!1});if(c)throw c;M(o||[]),o&&await $(o),await C()}catch(a){console.error("데이터 로드 실패:",a),y.error("데이터를 불러오는데 실패했습니다.")}finally{t&&w(!1)}},$=async t=>{const a=t.filter(r=>r.status==="completed").reduce((r,i)=>r+parseFloat(i.commission_amount.toString()),0),s=t.reduce((r,i)=>r+parseFloat(i.total_bet_amount.toString()),0),o=new Set(t.map(r=>r.partner_id)).size,c=t.length>0?t.reduce((r,i)=>r+parseFloat(i.commission_rate.toString()),0)/t.length:0,u=Math.max(1,Math.ceil((new Date().getTime()-new Date(h(m).start).getTime())/(1440*60*1e3))),q=a/u,B=new Date(new Date(h(m).start).getTime()-u*24*60*60*1e3),{data:E}=await S.from("settlements").select("commission_amount").gte("created_at",B.toISOString()).lt("created_at",h(m).start),x=E?.reduce((r,i)=>r+parseFloat(i.commission_amount.toString()),0)||0,P=x>0?(a-x)/x*100:0;O({totalCommission:a,dailyAverage:q,monthlyGrowth:P,activePartners:o,totalBetVolume:s,avgCommissionRate:c})},C=async()=>{try{const{data:t}=await S.from("api_sync_logs").select("*").eq("sync_type","settlement").order("created_at",{ascending:!1}).limit(1);if(t&&t.length>0){const a=t[0];R({lastSync:new Date(a.created_at),isSync:a.status==="success",errorCount:a.status==="error"?1:0})}}catch(t){console.error("동기화 상태 업데이트 실패:",t)}},h=t=>{const a=new Date,s=new Date(a.getFullYear(),a.getMonth(),a.getDate());switch(t){case"week":const o=new Date(s);return o.setDate(s.getDate()-7),{start:o.toISOString(),end:a.toISOString()};case"month":const c=new Date(s);return c.setMonth(s.getMonth()-1),{start:c.toISOString(),end:a.toISOString()};case"quarter":const u=new Date(s);return u.setMonth(s.getMonth()-3),{start:u.toISOString(),end:a.toISOString()};default:return{start:c.toISOString(),end:a.toISOString()}}},A=async()=>{try{b(!0);const{data:t,error:a}=await S.rpc("sync_external_settlement_data");if(a)throw a;y.success("새로고침이 완료되었습니다."),await g(!1)}catch(t){console.error("새로고침 실패:",t),y.error("새로고침에 실패했습니다.")}finally{b(!1)}};return n.useEffect(()=>{g(!0)},[]),n.useEffect(()=>{j||g(!1)},[m]),n.useEffect(()=>{if(p)switch(p.type){case"settlement_sync":g(!1);break;case"api_sync_complete":C();break}},[p]),j?e.jsx(V,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-100",children:"통합정산내역"}),e.jsx("p",{className:"text-sm text-slate-400",children:"모든 정산 데이터 통합 관리 및 분석"})]})}),!D.isSync&&e.jsxs(z,{children:[e.jsx(le,{className:"h-4 w-4"}),e.jsxs(U,{children:["외부 API와 동기화 중 오류가 발생했습니다. 마지막 동기화: ",D.lastSync.toLocaleString()]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-5",children:[e.jsx(d,{title:"총 수수료",value:`₩${l.totalCommission.toLocaleString()}`,subtitle:"누적 수수료",icon:N,color:"green"}),e.jsx(d,{title:"일일 평균",value:`₩${l.dailyAverage.toLocaleString()}`,subtitle:"평균 수수료",icon:k,color:"blue"}),e.jsx(d,{title:"월별 성장률",value:`${l.monthlyGrowth.toFixed(1)}%`,subtitle:l.monthlyGrowth>=0?"↑ 증가":"↓ 감소",icon:k,color:l.monthlyGrowth>=0?"green":"red"}),e.jsx(d,{title:"활성 파트너",value:`${l.activePartners}개`,subtitle:"운영 중",icon:H,color:"orange"}),e.jsx(d,{title:"총 베팅량",value:`₩${l.totalBetVolume.toLocaleString()}`,subtitle:"누적 베팅",icon:L,color:"purple"}),e.jsx(d,{title:"평균 수수료율",value:`${l.avgCommissionRate.toFixed(2)}%`,subtitle:"전체 평균",icon:N,color:"pink"})]}),e.jsxs(W,{children:[e.jsx(Y,{children:e.jsxs(J,{className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-5 w-5"}),"통합 정산 내역"]})}),e.jsx(K,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"text-slate-300 whitespace-nowrap",children:"기간"}),e.jsxs(X,{value:m,onValueChange:T,children:[e.jsx(Z,{className:"w-32",children:e.jsx(ee,{})}),e.jsxs(te,{children:[e.jsx(f,{value:"week",children:"최근 7일"}),e.jsx(f,{value:"month",children:"최근 30일"}),e.jsx(f,{value:"quarter",children:"최근 90일"})]})]})]}),e.jsxs(ae,{onClick:A,disabled:v,size:"sm",className:"btn-premium-primary",children:[e.jsx(se,{className:re("h-4 w-4 mr-2",v&&"animate-spin")}),"새로고침"]})]}),e.jsx(ne,{enableSearch:!1,columns:[{header:"파트너",cell:t=>e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:t.partner?.nickname}),e.jsxs("p",{className:"text-sm text-slate-500",children:["레벨 ",t.partner?.level]})]})},{key:"settlement_type",header:"정산 타입",cell:t=>e.jsx(F,{variant:t.settlement_type==="rolling"?"default":"secondary",children:t.settlement_type==="rolling"?"롤링":"루징"})},{key:"total_bet_amount",header:"총 베팅",cell:t=>`₩${parseFloat(t.total_bet_amount).toLocaleString()}`},{key:"total_win_amount",header:"총 당첨",cell:t=>`₩${parseFloat(t.total_win_amount).toLocaleString()}`},{key:"commission_amount",header:"수수료",cell:t=>e.jsxs("span",{className:"font-semibold text-green-600",children:["₩",parseFloat(t.commission_amount).toLocaleString()]})},{key:"auto_calculated",header:"자동 처리",cell:t=>e.jsx(F,{variant:t.auto_calculated?"default":"outline",children:t.auto_calculated?"자동":"수동"})},{key:"processed_at",header:"처리일",cell:t=>t.processed_at?new Date(t.processed_at).toLocaleString():"-"}],data:I})]})})]})]})}export{ge as IntegratedSettlement,ge as default};
