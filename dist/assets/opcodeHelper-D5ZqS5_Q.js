import{s as a}from"./index-BWgbPZ4l.js";async function y(e){if(console.log("🔍 getAdminOpcode 호출:",{id:e.id,username:e.username,partner_type:e.partner_type,level:e.level,opcode:e.opcode,has_opcode:!!e.opcode,has_secret_key:!!e.secret_key,has_token:!!e.token,has_api_token:!!e.api_token}),e.partner_type==="system_admin"){const o=[],n=e.token||e.api_token;e.opcode&&e.secret_key&&n?(o.push({opcode:e.opcode,secretKey:e.secret_key,token:n,partnerId:e.id,partnerName:e.name||e.nickname||"시스템관리자"}),console.log("✅ 시스템관리자 본인 OPCODE 추가:",e.opcode)):console.warn("⚠️ 시스템관리자 OPCODE 정보 불완전:",{opcode:e.opcode,secret_key:e.secret_key?"***":null,token:n?"***":null});const{data:c,error:r}=await a.from("partners").select("id, username, nickname, opcode, secret_key, api_token").eq("partner_type","head_office").not("opcode","is",null).not("secret_key","is",null).not("api_token","is",null);if(r&&console.error("❌ 대본사 OPCODE 조회 오류:",r),c&&c.length>0&&(c.forEach(t=>{o.push({opcode:t.opcode,secretKey:t.secret_key,token:t.api_token,partnerId:t.id,partnerName:t.nickname||t.username||`대본사-${t.id.slice(0,8)}`})}),console.log(`✅ 대본사 OPCODE ${c.length}개 추가`)),o.length===0)throw new Error("사용 가능한 OPCODE가 없습니다. 시스템관리자 또는 대본사에 OPCODE를 설정해주세요.");return console.log(`📊 시스템관리자 총 ${o.length}개 OPCODE 사용 가능`),{opcodes:o,isSystemAdmin:!0}}if(e.partner_type==="head_office"){const o=e.token||e.api_token;if(!e.opcode||!e.secret_key||!o)throw new Error("대본사 계정에 OPCODE/Token이 설정되지 않았습니다.");return console.log("✅ 대본사 OPCODE 조회:",e.opcode),{opcode:e.opcode,secretKey:e.secret_key,token:o,partnerId:e.id,partnerName:e.nickname||e.username||"내 조직"}}const _=e.parent_chain||[];if(_.length===0){if(console.log("🔍 parent_chain 없음, parent_id로 대본사 찾기 시작:",{admin_id:e.id,admin_username:e.username,admin_type:e.partner_type,parent_id:e.parent_id}),!e.parent_id)throw new Error(`${e.partner_type}는 상위 파트너가 필요합니다. parent_id가 설정되지 않았습니다.`);let o=e.parent_id,n=0;const c=10;for(;o&&n<c;){console.log(`🔍 [시도 ${n+1}] 파트너 조회:`,o);const{data:r,error:t}=await a.from("partners").select("id, nickname, username, partner_type, level, opcode, secret_key, api_token, parent_id").eq("id",o).single();if(console.log(`📊 [시도 ${n+1}] 조회 결과:`,{found:!!r,error:t?.message,partner_type:r?.partner_type,level:r?.level,has_opcode:!!r?.opcode,has_secret_key:!!r?.secret_key,has_api_token:!!r?.api_token,parent_id:r?.parent_id}),t)throw console.error("❌ 상위 파트너 조회 DB 오류:",t),new Error(`상위 파트너 조회 실패: ${t.message}`);if(!r)throw new Error(`상위 파트너를 찾을 수 없습니다 (ID: ${o})`);if(r.partner_type==="head_office"){const p=r.api_token;if(!r.opcode||!r.secret_key||!p)throw console.error("❌ 대본사 OPCODE 정보 부족:",{partner_id:r.id,username:r.username,has_opcode:!!r.opcode,has_secret_key:!!r.secret_key,has_api_token:!!p}),new Error(`상위 대본사(${r.username})에 OPCODE/Token이 설정되지 않았습니다.`);return console.log("✅ 상위 대본사 OPCODE 조회 성공:",{partner_id:r.id,username:r.username,opcode:r.opcode}),{opcode:r.opcode,secretKey:r.secret_key,token:p,partnerId:r.id,partnerName:r.nickname||r.username||"상위 대본사"}}console.log(`⬆️ [시도 ${n+1}] ${r.partner_type}는 대본사 아님, 상위로 이동`),o=r.parent_id||null,n++}throw n>=c?new Error("상위 대본사 조회 시도 횟수 초과 (최대 10회)"):new Error("상위 대본사를 찾을 수 없습니다. 파트너 계층 구조를 확인해주세요.")}const k=_[0],{data:s,error:l}=await a.from("partners").select("id, nickname, opcode, secret_key, api_token").eq("id",k).single();if(l||!s)throw console.error("상위 대본사 조회 오류:",l),new Error("상위 대본사 정보를 찾을 수 없습니다.");const i=s.api_token;if(!s.opcode||!s.secret_key||!i)throw new Error("상위 대본사에 OPCODE/Token이 설정되지 않았습니다.");return console.log("✅ 상위 대본사 OPCODE 조회 (parent_chain):",s.opcode),{opcode:s.opcode,secretKey:s.secret_key,token:i,partnerId:s.id,partnerName:s.nickname||"상위 대본사"}}function u(e){return"opcodes"in e&&"isSystemAdmin"in e}export{y as getAdminOpcode,u as isMultipleOpcode};
