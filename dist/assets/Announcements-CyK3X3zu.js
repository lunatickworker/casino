import{j as e,r as n}from"./react-core-CwM-CeLv.js";import{o as ee,s as m,i as j,L as x,I as h,S as f,p as N,q as D,r as _,t as r,B as y,m as se}from"./index-B-OPgV84.js";import{T as ae}from"./textarea-B58kONDf.js";import{D as te}from"./DataTable-Cfqx9Gu8.js";import{A as le,f as re,a as ie,b as ce,c as ne,d as de}from"./AdminDialog-DoQjEojI.js";import{S as oe}from"./switch-BS5eCNSS.js";import{k as d}from"./vendor-CQn7sZ7L.js";import{B as A,P as xe,ao as P,ab as me,X as ue,ag as he,ap as pe,K as ge,m as je,a8 as be,O as ve}from"./lucide-icons-D2Y5yybo.js";import"./radix-ui-SX2QAG6c.js";import"./supabase-r6ABpEO8.js";function Te({user:b}){if(b.level>5)return e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx(A,{className:"h-12 w-12 text-yellow-500 mx-auto"}),e.jsx("p",{className:"text-muted-foreground",children:"공지사항 관리는 총판 이상만 접근 가능합니다."})]})});const[U,I]=n.useState(!0),[F,q]=n.useState(!1),[V,L]=n.useState([]),[w,z]=n.useState("all"),[C,O]=n.useState("all"),[p,G]=n.useState(""),[M,S]=n.useState(!1),[u,E]=n.useState(null),[l,c]=n.useState({title:"",content:"",image_url:"",is_popup:!1,target_audience:"users",target_level:"",status:"active",display_order:0,start_date:"",end_date:""}),[T,k]=n.useState(null),{sendMessage:$}=ee();n.useEffect(()=>{const s=m.channel("announcements-changes").on("postgres_changes",{event:"*",schema:"public",table:"announcements"},a=>{console.log("🔔 공지사항 테이블 변경 감지:",a),v()}).subscribe();return()=>{m.removeChannel(s)}},[]);const K=async s=>{if(!s)return null;const a=s.name.split(".").pop(),o=`announcements/${`${b.id}_${Date.now()}.${a}`}`;try{q(!0);const{data:t,error:g}=await m.storage.from("public").upload(o,s,{cacheControl:"3600",upsert:!1});if(g)throw g;const{data:{publicUrl:Z}}=m.storage.from("public").getPublicUrl(o);return Z}catch(t){return console.error("이미지 업로드 오류:",t),d.error("이미지 업로드에 실패했습니다."),null}finally{q(!1)}},R=async s=>{const a=s.target.files?.[0];if(!a)return;if(a.size>5*1024*1024){d.error("이미지 크기는 5MB 이하여야 합니다.");return}if(!a.type.startsWith("image/")){d.error("이미지 파일만 업로드 가능합니다.");return}const i=await K(a);i&&(k(i),c(o=>({...o,image_url:i})),d.success("이미지가 업로드되었습니다."))},W=()=>{k(null),c(s=>({...s,image_url:""}))},v=async()=>{try{I(!0);let s=m.from("announcements").select(`
          *,
          partners!announcements_partner_id_fkey(username)
        `);b.level>1&&(s=s.eq("partner_id",b.id)),w!=="all"&&(s=s.eq("status",w)),C!=="all"&&(s=s.eq("target_audience",C)),p&&(s=s.or(`title.ilike.%${p}%,content.ilike.%${p}%`));const{data:a,error:i}=await s.order("display_order",{ascending:!1}).order("created_at",{ascending:!1});if(i)throw i;const o=(a||[]).map(t=>({id:t.id,partner_id:t.partner_id,partner_username:t.partners?.username||"알 수 없음",title:t.title,content:t.content,image_url:t.image_url,is_popup:t.is_popup,target_audience:t.target_audience,target_level:t.target_level,status:t.status,display_order:t.display_order,view_count:t.view_count,start_date:t.start_date,end_date:t.end_date,created_at:t.created_at,updated_at:t.updated_at}));L(o)}catch(s){console.error("공지사항 조회 오류:",s),d.error("공지사항을 불러오는데 실패했습니다.")}finally{I(!1)}},H=async()=>{if(!l.title.trim()||!l.content.trim()){d.error("제목과 내용을 입력해주세요.");return}try{const s={...l,partner_id:b.id,target_level:l.target_level?parseInt(l.target_level):null,start_date:l.start_date||new Date().toISOString(),end_date:l.end_date||null};let a;if(u?a=await m.from("announcements").update(s).eq("id",u.id).select():a=await m.from("announcements").insert([s]).select(),a.error)throw a.error;d.success(u?"공지사항이 수정되었습니다.":"공지사항이 등록되었습니다."),!u&&$&&$("new_announcement",{title:l.title,target_audience:l.target_audience,is_popup:l.is_popup}),B(),S(!1),v()}catch(s){console.error("공지사항 저장 오류:",s),d.error("공지사항 저장에 실패했습니다.")}},J=async s=>{if(confirm("정말 삭제하시겠습니까?"))try{const{error:a}=await m.from("announcements").delete().eq("id",s);if(a)throw a;d.success("공지사항이 삭제되었습니다."),v()}catch(a){console.error("공지사항 삭제 오류:",a),d.error("공지사항 삭제에 실패했습니다.")}},X=async(s,a)=>{try{const{error:i}=await m.from("announcements").update({status:a}).eq("id",s);if(i)throw i;L(t=>t.map(g=>g.id===s?{...g,status:a}:g));const o={active:"활성",inactive:"비활성",draft:"임시저장"}[a]||a;d.success(`공지사항 상태가 "${o}"로 변경되었습니다.`)}catch(i){console.error("공지사항 상태 변경 오류:",i),d.error("공지사항 상태 변경에 실패했습니다.")}},B=()=>{c({title:"",content:"",image_url:"",is_popup:!1,target_audience:"users",target_level:"",status:"active",display_order:0,start_date:"",end_date:""}),k(null),E(null)},Q=s=>{c({title:s.title,content:s.content,image_url:s.image_url||"",is_popup:s.is_popup,target_audience:s.target_audience,target_level:s.target_level?.toString()||"",status:s.status,display_order:s.display_order,start_date:s.start_date?s.start_date.split("T")[0]:"",end_date:s.end_date?s.end_date.split("T")[0]:""}),k(s.image_url||null),E(s),S(!0)};n.useEffect(()=>{v()},[w,C]),n.useEffect(()=>{const s=setTimeout(()=>{p!==void 0&&v()},300);return()=>clearTimeout(s)},[p]);const Y=[{key:"title",title:"제목",render:(s,a)=>e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s}),e.jsxs("div",{className:"flex gap-1 mt-1",children:[a.is_popup&&e.jsx(y,{variant:"destructive",className:"text-xs",children:"팝업"}),a.target_audience==="partners"&&e.jsx(y,{variant:"secondary",className:"text-xs",children:"관리자"}),a.target_level&&e.jsxs(y,{variant:"outline",className:"text-xs",children:["Level ",a.target_level]})]})]})},{key:"target_audience",title:"대상",render:s=>{const a={all:"전체",users:"사용자",partners:"관리자"};return e.jsx(y,{variant:"outline",children:a[s]||s})}},{key:"status",title:"상태",render:(s,a)=>{const i={active:{label:"활성",color:"bg-green-100 text-green-800"},inactive:{label:"비활성",color:"bg-gray-100 text-gray-800"},draft:{label:"임시저장",color:"bg-yellow-100 text-yellow-800"}},o=i[s]||i.draft;return e.jsxs(f,{value:s,onValueChange:t=>X(a.id,t),children:[e.jsx(N,{className:`w-auto h-7 ${o.color}`,children:e.jsx("span",{children:o.label})}),e.jsxs(_,{children:[e.jsx(r,{value:"active",children:"활성"}),e.jsx(r,{value:"inactive",children:"비활성"}),e.jsx(r,{value:"draft",children:"임시저장"})]})]})}},{key:"view_count",title:"조회수",render:s=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(je,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:s.toLocaleString()})]})},{key:"partner_username",title:"작성자",render:s=>e.jsx("span",{className:"text-sm",children:s})},{key:"created_at",title:"작성일",render:s=>new Date(s).toLocaleDateString("ko-KR")},{key:"actions",title:"관리",render:(s,a)=>e.jsxs("div",{className:"flex gap-1",children:[e.jsx(j,{size:"sm",variant:"outline",onClick:()=>Q(a),className:"h-8 px-2",children:e.jsx(be,{className:"h-4 w-4"})}),e.jsx(j,{size:"sm",variant:"outline",onClick:()=>J(a.id),className:"h-8 px-2 text-red-600 hover:text-red-700",children:e.jsx(ve,{className:"h-4 w-4"})})]})}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-100",children:"공지사항"}),e.jsx("p",{className:"text-sm text-slate-400",children:"사용자 및 관리자 대상 공지사항을 작성하고 관리합니다."})]}),e.jsxs(le,{open:M,onOpenChange:s=>{S(s),s||B()},children:[e.jsx(re,{asChild:!0,children:e.jsxs(j,{className:"btn-premium-primary",children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),"공지사항 작성"]})}),e.jsxs(ie,{className:"!max-w-[min(1000px,90vw)] w-[90vw] max-h-[85vh] overflow-hidden glass-card p-0 flex flex-col",children:[e.jsxs(ce,{className:"pb-5 border-b border-slate-700/50 bg-gradient-to-r from-blue-500/10 to-purple-500/10 px-8 pt-6 rounded-t-lg bg-slate-900 backdrop-blur-xl flex-shrink-0",children:[e.jsxs(ne,{className:"flex items-center gap-3 text-2xl text-slate-50",children:[e.jsx("div",{className:"p-2.5 bg-blue-500/20 rounded-lg",children:e.jsx(A,{className:"h-7 w-7 text-blue-400"})}),u?"공지사항 수정":"새 공지사항 작성"]}),e.jsx(de,{className:"text-slate-300 mt-2 text-base",children:u?"공지사항 내용을 수정합니다.":"새로운 공지사항을 작성하고 사용자에게 전달합니다."})]}),e.jsxs("div",{className:"px-8 py-6 space-y-6 overflow-y-auto flex-1",children:[e.jsxs("div",{className:"space-y-4 p-5 border border-slate-700/50 rounded-xl bg-gradient-to-br from-slate-900/50 to-slate-800/30 shadow-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"h-1 w-8 bg-blue-500 rounded-full"}),e.jsx("h4",{className:"font-semibold text-slate-100",children:"기본 정보"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs(x,{htmlFor:"title",className:"text-slate-200 flex items-center gap-2",children:[e.jsx(P,{className:"h-3.5 w-3.5 text-blue-400"}),"제목 *"]}),e.jsx(h,{id:"title",value:l.title,onChange:s=>c(a=>({...a,title:s.target.value})),placeholder:"공지사항 제목을 입력하세요",className:"input-premium h-11 text-base border-slate-600 focus:border-blue-500 bg-slate-800/50"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(x,{className:"text-slate-200",children:"상태"}),e.jsxs(f,{value:l.status,onValueChange:s=>c(a=>({...a,status:s})),children:[e.jsx(N,{className:"h-11 bg-slate-800/50 border-slate-600 hover:border-blue-500 transition-colors",children:e.jsx(D,{})}),e.jsxs(_,{className:"bg-slate-900 border-slate-700",children:[e.jsx(r,{value:"active",children:"✅ 활성"}),e.jsx(r,{value:"inactive",children:"⏸️ 비활성"}),e.jsx(r,{value:"draft",children:"📝 임시저장"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx(x,{className:"text-slate-200",children:"대상"}),e.jsxs(f,{value:l.target_audience,onValueChange:s=>c(a=>({...a,target_audience:s})),children:[e.jsx(N,{className:"h-11 bg-slate-800/50 border-slate-600 hover:border-blue-500 transition-colors",children:e.jsx(D,{})}),e.jsxs(_,{className:"bg-slate-900 border-slate-700",children:[e.jsx(r,{value:"all",children:"👥 전체"}),e.jsx(r,{value:"users",children:"👤 사용자"}),e.jsx(r,{value:"partners",children:"🤝 관리자"})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(x,{className:"text-slate-200",children:"대상 레벨"}),e.jsx(h,{type:"number",min:"1",max:"6",value:l.target_level,onChange:s=>c(a=>({...a,target_level:s.target.value})),placeholder:"특정 레벨만 (1-6)",className:"input-premium h-11 bg-slate-800/50 border-slate-600 focus:border-blue-500"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(x,{className:"text-slate-200",children:"표시 순서"}),e.jsx(h,{type:"number",value:l.display_order,onChange:s=>c(a=>({...a,display_order:parseInt(s.target.value)||0})),className:"input-premium h-11 bg-slate-800/50 border-slate-600 focus:border-blue-500"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 pt-3 border-t border-slate-700/30",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs(x,{className:"text-slate-200 flex items-center gap-2",children:[e.jsx(me,{className:"h-3.5 w-3.5 text-blue-400"}),"시작일"]}),e.jsx(h,{type:"date",value:l.start_date,onChange:s=>c(a=>({...a,start_date:s.target.value})),className:"input-premium h-11 bg-slate-800/50 border-slate-600 focus:border-blue-500"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(x,{className:"text-slate-200",children:"종료일"}),e.jsx(h,{type:"date",value:l.end_date,onChange:s=>c(a=>({...a,end_date:s.target.value})),placeholder:"선택사항",className:"input-premium h-11 bg-slate-800/50 border-slate-600 focus:border-blue-500"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-slate-800/30 rounded-lg border border-slate-700/50",children:[e.jsx(oe,{id:"is_popup",checked:l.is_popup,onCheckedChange:s=>c(a=>({...a,is_popup:s}))}),e.jsx(x,{htmlFor:"is_popup",className:"text-slate-200 cursor-pointer",children:"팝업으로 표시"})]})]}),e.jsxs("div",{className:"space-y-4 p-5 border border-slate-700/50 rounded-xl bg-gradient-to-br from-slate-900/50 to-slate-800/30 shadow-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"h-1 w-8 bg-green-500 rounded-full"}),e.jsx("h4",{className:"font-semibold text-slate-100",children:"공지사항 내용"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs(x,{htmlFor:"content",className:"text-slate-200 flex items-center gap-2",children:[e.jsx(P,{className:"h-3.5 w-3.5 text-green-400"}),"내용 *"]}),e.jsx(ae,{id:"content",value:l.content,onChange:s=>c(a=>({...a,content:s.target.value})),placeholder:`공지사항 내용을 입력하세요

• 공지사항 내용을 상세히 작성하세요
• 필요시 이미지를 첨부할 수 있습니다`,rows:8,className:"input-premium bg-slate-800/50 border-slate-600 focus:border-green-500 resize-none text-base leading-relaxed"}),e.jsx("div",{className:"p-3 bg-slate-800/50 rounded-lg border border-slate-700/50",children:e.jsxs("p",{className:"text-xs text-slate-400",children:["💡 ",e.jsx("strong",{className:"text-slate-300",children:"작성 팁:"})," 명확하고 간결하게 작성하세요"]})})]})]}),e.jsxs("div",{className:"space-y-4 p-5 border border-slate-700/50 rounded-xl bg-gradient-to-br from-slate-900/50 to-slate-800/30 shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-1 w-8 bg-purple-500 rounded-full"}),e.jsx("h4",{className:"font-semibold text-slate-100",children:"이미지 첨부"})]}),T&&e.jsxs(j,{type:"button",variant:"ghost",size:"sm",onClick:W,className:"h-8 text-xs text-red-400 hover:text-red-300 hover:bg-red-500/10",children:[e.jsx(ue,{className:"h-4 w-4 mr-1"}),"제거"]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"p-3 bg-blue-500/10 border border-blue-500/20 rounded-lg",children:e.jsxs("p",{className:"text-xs text-blue-300 flex items-center gap-2",children:[e.jsx(he,{className:"h-3.5 w-3.5"}),"최대 5MB, JPG/PNG/GIF 형식"]})}),T?e.jsx("div",{className:"space-y-3",children:e.jsxs("div",{className:"relative border-2 border-slate-600 rounded-xl overflow-hidden bg-slate-900 shadow-xl",children:[e.jsx("div",{className:"p-4 flex items-center justify-center",children:e.jsx("img",{src:T,alt:"업로드된 이미지",className:"max-w-full max-h-60 object-contain rounded"})}),e.jsx("div",{className:"absolute top-2 right-2",children:e.jsx(y,{variant:"secondary",className:"bg-green-500/90 text-white",children:"미리보기"})})]})}):e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(x,{htmlFor:"image",className:"flex-1 flex items-center justify-center h-24 border-2 border-dashed border-slate-600 rounded-xl cursor-pointer hover:border-purple-500 hover:bg-purple-500/5 transition-all bg-slate-800/30 group",children:e.jsxs("div",{className:"flex items-center gap-3 text-slate-300",children:[e.jsx("div",{className:"p-3 bg-slate-700/50 rounded-full group-hover:bg-purple-500/20 transition-colors",children:e.jsx(pe,{className:"h-6 w-6 text-slate-400 group-hover:text-purple-400 transition-colors"})}),e.jsx("span",{children:"클릭하여 이미지 업로드"})]})}),e.jsx(h,{id:"image",type:"file",accept:"image/*",onChange:R,disabled:F,className:"hidden"}),F&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-slate-400",children:[e.jsx("div",{className:"loading-premium w-4 h-4"}),"업로드 중..."]})]})]})]})]}),e.jsxs("div",{className:"flex gap-4 pt-6 border-t border-slate-700/50 px-8 pb-6 bg-slate-900 backdrop-blur-xl flex-shrink-0",children:[e.jsxs(j,{onClick:H,disabled:!l.title.trim()||!l.content.trim(),className:"btn-premium-primary flex items-center gap-3 flex-1 h-12 text-base shadow-lg shadow-blue-500/20 hover:shadow-blue-500/40 transition-all",children:[e.jsx(A,{className:"h-5 w-5"}),u?"수정":"등록"]}),e.jsx(j,{onClick:()=>S(!1),variant:"outline",className:"border-slate-600 hover:bg-slate-700/50 h-12 px-8 text-base",children:"취소"})]})]})]})]}),e.jsxs("div",{className:"glass-card rounded-xl p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-6 pb-4 border-b border-slate-700/50",children:e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-semibold text-slate-100 flex items-center gap-2",children:[e.jsx(A,{className:"h-5 w-5 text-blue-400"}),"공지사항 목록"]}),e.jsx("p",{className:"text-sm text-slate-400 mt-1",children:"작성된 공지사항을 관리하고 대상별로 분류할 수 있습니다."})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsx("div",{className:"flex-1 min-w-[200px]",children:e.jsxs("div",{className:"relative",children:[e.jsx(ge,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 h-4 w-4"}),e.jsx(h,{placeholder:"제목, 내용으로 검색...",value:p,onChange:s=>G(s.target.value),className:"pl-9 input-premium"})]})}),e.jsxs(f,{value:w,onValueChange:z,children:[e.jsx(N,{className:"w-[120px] bg-slate-800/50 border-slate-600",children:e.jsx(D,{})}),e.jsxs(_,{children:[e.jsx(r,{value:"all",children:"전체 상태"}),e.jsx(r,{value:"active",children:"활성"}),e.jsx(r,{value:"inactive",children:"비활성"}),e.jsx(r,{value:"draft",children:"임시저장"})]})]}),e.jsxs(f,{value:C,onValueChange:O,children:[e.jsx(N,{className:"w-[120px] bg-slate-800/50 border-slate-600",children:e.jsx(D,{})}),e.jsxs(_,{children:[e.jsx(r,{value:"all",children:"전체 대상"}),e.jsx(r,{value:"users",children:"사용자"}),e.jsx(r,{value:"partners",children:"관리자"})]})]})]}),U?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(se,{})}):e.jsx(te,{data:V,columns:Y,enableSearch:!1})]})]})]})}export{Te as Announcements,Te as default};
