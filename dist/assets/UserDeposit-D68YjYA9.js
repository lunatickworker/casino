import{ax as W,r as n,s as x,t as l,j as e,W as X,C as A,a as F,b as T,Q as $,e as q,E as i,I as N,w as _,S as J,x as Y,y as Z,z as ee,D as se,a7 as te,a8 as ae,L as re,B as ne,az as le,ay as ce,R as ie}from"./index-DHLZKrSC.js";import{T as oe}from"./textarea-D3JOUlRQ.js";import{I as de}from"./info-Bn9fJqEX.js";import{P as me}from"./plus-Co1dk4Al.js";import{A as xe}from"./arrow-up-right-BJ4TjU8d.js";import{C as ue}from"./circle-alert-CfjAz5vG.js";import{C as he}from"./clock-DJz0fDvN.js";function ve({user:a,onRouteChange:M}){const{sendMessage:R}=W(),[o,h]=n.useState(""),[d,w]=n.useState(""),[u,v]=n.useState(""),[m,y]=n.useState(""),[p,S]=n.useState(""),[C,k]=n.useState(!1),[B,E]=n.useState([]),[H,D]=n.useState(!0),[L,G]=n.useState([]),[z]=n.useState([5e4,1e5,3e5,5e5,1e6]),[b,K]=n.useState(0),P=async()=>{try{G([{bank_name:"국민은행",account_number:"123456-78-901234",holder_name:"GMS카지노",is_active:!0},{bank_name:"신한은행",account_number:"110-456-789012",holder_name:"GMS카지노",is_active:!0},{bank_name:"우리은행",account_number:"1002-987-654321",holder_name:"GMS카지노",is_active:!0},{bank_name:"KB은행",account_number:"123-456789-01-234",holder_name:"GMS카지노",is_active:!0}])}catch(s){console.error("은행 계좌 조회 오류:",s)}},j=async()=>{try{D(!0);const{data:s,error:t}=await x.from("transactions").select("*").eq("user_id",a.id).eq("transaction_type","deposit").order("created_at",{ascending:!1}).limit(10);if(t)throw t;E(s||[])}catch(s){console.error("입금 내역 조회 오류:",s),l.error("입금 내역을 불러오는데 실패했습니다.")}finally{D(!1)}},g=async()=>{try{const{data:s,error:t}=await x.from("users").select("balance").eq("id",a.id).single();if(t)throw t;K(parseFloat(s.balance)||0)}catch(s){console.error("잔고 조회 오류:",s)}},Q=async s=>{if(s.preventDefault(),!o||!d||!u||!m){l.error("모든 필수 항목을 입력해주세요.");return}const t=parseFloat(o);if(t<1e4){l.error("최소 입금 금액은 10,000원입니다.");return}if(t>1e7){l.error("최대 입금 금액은 10,000,000원입니다.");return}k(!0);try{await g();const r={user_id:a.id,partner_id:a.referrer_id||null,transaction_type:"deposit",amount:t,status:"pending",balance_before:b,balance_after:b,bank_name:d,bank_account:u,bank_holder:m,memo:p.trim()||null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};console.log("💰 입금 신청 데이터:",{...r,user_info:{id:a.id,username:a.username,referrer_id:a.referrer_id}});const{data:f,error:I}=await x.from("transactions").insert([r]).select().single();if(I)throw I;await R("deposit_request",{transaction_id:f.id,user_id:a.id,username:a.username,nickname:a.nickname,amount:t,bank_name:d,bank_account:u,depositor_name:m,memo:p.trim()||null,subject:`${a.nickname}님의 입금 신청`,reference_type:"transaction",reference_id:f.id},3)&&console.log("✅ 입금 요청 알림이 관리자에게 전송되었습니다."),await x.from("activity_logs").insert([{actor_type:"user",actor_id:a.id,action:"deposit_request",target_type:"transaction",target_id:f.id,details:{amount:t,bank_name:d,depositor_name:m}}]),h(""),w(""),v(""),y(""),S(""),await j(),l.success(`입금 신청이 완료되었습니다.
관리자 승인 후 잔고에 반영됩니다.`,{duration:4e3})}catch(r){console.error("❌ 입금 신청 오류:",r),l.error(r.message||"입금 신청 중 오류가 발생했습니다.")}finally{k(!1)}},U=s=>{h(s.toString())},O=s=>{switch(s){case"pending":return{color:"bg-yellow-500",textColor:"text-yellow-400",icon:he,label:"승인대기"};case"approved":return{color:"bg-blue-500",textColor:"text-blue-400",icon:ie,label:"처리중"};case"completed":return{color:"bg-green-500",textColor:"text-green-400",icon:ce,label:"완료"};case"rejected":return{color:"bg-red-500",textColor:"text-red-400",icon:le,label:"거절"};default:return{color:"bg-slate-500",textColor:"text-slate-400",icon:ue,label:"알 수 없음"}}},c=s=>new Intl.NumberFormat("ko-KR").format(s),V=s=>new Date(s).toLocaleString("ko-KR");return n.useEffect(()=>{P(),j(),g();const s=x.channel(`deposit_updates_${a.id}`).on("postgres_changes",{event:"*",schema:"public",table:"transactions",filter:`user_id=eq.${a.id}`},t=>{if(console.log("🔄 입금 상태 업데이트 수신:",t),t.eventType==="UPDATE"||t.eventType==="INSERT"){const r=t.new;r.transaction_type==="deposit"&&(j(),r.status==="completed"?(g(),l.success(`입금이 완료되었습니다!
금액: ₩${c(r.amount)}`,{duration:5e3})):r.status==="rejected"?l.error(`입금 신청이 거절되었습니다.
금액: ₩${c(r.amount)}`,{duration:5e3}):r.status==="approved"&&l.info(`입금이 승인되었습니다. 처리 중입니다.
금액: ₩${c(r.amount)}`,{duration:4e3}))}}).subscribe();return()=>s.unsubscribe()},[a.id]),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"입금 신청"}),e.jsx("p",{className:"text-slate-400",children:"안전하고 빠른 입금 서비스를 이용하세요"})]}),e.jsxs("div",{className:"flex items-center gap-4 bg-slate-800/50 rounded-lg px-4 py-2",children:[e.jsx(X,{className:"w-5 h-5 text-green-400"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-slate-300",children:"현재 보유금"}),e.jsxs("div",{className:"text-lg font-bold text-green-400",children:["₩",c(b)]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsxs(A,{className:"bg-slate-800/50 border-slate-700",children:[e.jsx(F,{children:e.jsxs(T,{className:"flex items-center text-white",children:[e.jsx($,{className:"w-5 h-5 mr-2 text-green-400"}),"입금 신청"]})}),e.jsx(q,{children:e.jsxs("form",{onSubmit:Q,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"amount",className:"text-slate-300",children:"입금 금액 *"}),e.jsx(N,{id:"amount",type:"text",placeholder:"금액을 입력하세요",value:o,onChange:s=>{const t=s.target.value.replace(/[^0-9]/g,"");h(t)},className:"bg-slate-700/50 border-slate-600 text-white text-lg"}),o&&e.jsxs("p",{className:"text-sm text-slate-400",children:["₩",c(parseInt(o)||0)]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{className:"text-slate-300",children:"빠른 선택"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:z.map(s=>e.jsxs(_,{type:"button",variant:"outline",size:"sm",onClick:()=>U(s),className:"whitespace-nowrap",children:[c(s),"원"]},s))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"bank",className:"text-slate-300",children:"입금 은행 *"}),e.jsxs(J,{value:d,onValueChange:w,children:[e.jsx(Y,{className:"bg-slate-700/50 border-slate-600 text-white",children:e.jsx(Z,{placeholder:"입금할 은행을 선택하세요"})}),e.jsx(ee,{className:"bg-slate-800 border-slate-700",children:L.map(s=>e.jsx(se,{value:s.bank_name,children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:s.bank_name}),e.jsxs("span",{className:"text-sm text-slate-400",children:[s.account_number," (",s.holder_name,")"]})]})},s.bank_name))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"accountNumber",className:"text-slate-300",children:"입금자 계좌번호 *"}),e.jsx(N,{id:"accountNumber",type:"text",placeholder:"입금에 사용할 계좌번호를 입력하세요",value:u,onChange:s=>v(s.target.value),className:"bg-slate-700/50 border-slate-600 text-white"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"depositorName",className:"text-slate-300",children:"입금자명 *"}),e.jsx(N,{id:"depositorName",type:"text",placeholder:"실제 입금하실 분의 성함을 입력하세요",value:m,onChange:s=>y(s.target.value),className:"bg-slate-700/50 border-slate-600 text-white"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"memo",className:"text-slate-300",children:"메모 (선택)"}),e.jsx(oe,{id:"memo",placeholder:"추가 요청사항이 있으시면 입력하세요",value:p,onChange:s=>S(s.target.value),className:"bg-slate-700/50 border-slate-600 text-white",rows:3})]}),e.jsxs(te,{className:"border-yellow-600 bg-yellow-900/20",children:[e.jsx(de,{className:"h-4 w-4 text-yellow-400"}),e.jsx(ae,{className:"text-yellow-300",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{children:"• 최소 입금액: 10,000원 | 최대 입금액: 10,000,000원"}),e.jsx("p",{children:"• 입금자명과 계좌 소유자명이 일치해야 합니다"}),e.jsx("p",{children:"• 승인까지 평균 5-10분 소요됩니다"}),e.jsx("p",{children:"• 문의사항은 고객센터를 이용해주세요"})]})})]}),e.jsx(_,{type:"submit",disabled:C,className:"w-full bg-green-600 hover:bg-green-700 text-white py-3",children:C?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"신청 처리 중..."]}):e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"w-4 h-4 mr-2"}),"입금 신청하기"]})})]})})]})}),e.jsx("div",{children:e.jsxs(A,{className:"bg-slate-800/50 border-slate-700",children:[e.jsx(F,{children:e.jsxs(T,{className:"flex items-center text-white",children:[e.jsx(xe,{className:"w-5 h-5 mr-2 text-blue-400"}),"최근 입금 내역"]})}),e.jsx(q,{children:H?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(re,{})}):B.length>0?e.jsxs("div",{className:"space-y-4",children:[B.map(s=>{const t=O(s.status),r=t.icon;return e.jsxs("div",{className:"p-4 bg-slate-700/30 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(r,{className:`w-4 h-4 ${t.textColor}`}),e.jsx(ne,{className:`${t.color} text-white`,children:t.label})]}),e.jsxs("span",{className:"text-lg font-bold text-white",children:["₩",c(s.amount)]})]}),e.jsxs("div",{className:"space-y-1 text-sm text-slate-400",children:[e.jsxs("p",{children:[s.bank_name," ",s.bank_account]}),e.jsx("p",{children:V(s.created_at)}),s.memo&&e.jsxs("p",{className:"text-slate-300",children:["메모: ",s.memo]})]})]},s.id)}),e.jsx(_,{variant:"outline",onClick:()=>M("/user/profile"),className:"w-full",children:"전체 내역 보기"})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx($,{className:"w-12 h-12 text-slate-600 mx-auto mb-3"}),e.jsx("p",{className:"text-slate-400",children:"입금 내역이 없습니다"})]})})]})})]})]})}export{ve as UserDeposit};
