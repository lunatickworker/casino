const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/Dashboard-BopLuZLR.js","assets/react-core-CwM-CeLv.js","assets/MetricCard-CBRAhT7E.js","assets/vendor-CQn7sZ7L.js","assets/radix-ui-SX2QAG6c.js","assets/settlementCalculator-CXm0QBDJ.js","assets/lucide-icons-wLPRtdhM.js","assets/supabase-r6ABpEO8.js","assets/UserManagement-CiOSoJ1s.js","assets/DataTable-CjdfiZ7Q.js","assets/AdminDialog-qdCOZfhu.js","assets/ForceTransactionModal-DN0l0vJ3.js","assets/textarea-DcWc96jr.js","assets/popover-KcKD6lRl.js","assets/command-D1kDSEeZ.js","assets/dialog-CE9i0HK9.js","assets/BlacklistManagement-AM83kVK6.js","assets/PointManagement-CARxtFu4.js","assets/OnlineUsers-ByHgS6Fx.js","assets/PartnerConnectionStatus-CAPDXiEM.js","assets/PartnerManagement-DmPmPTzt.js","assets/PartnerTransactions-x-XFBrYf.js","assets/PartnerCreation-BXi1bJFP.js","assets/CommissionSettlement-_nvmZs-3.js","assets/calendar-BOz8gIIL.js","assets/IntegratedSettlement-CMQpjvqX.js","assets/TransactionManagement-BUfK4uLs.js","assets/TransactionApprovalManager-ChN5QjSx.js","assets/EnhancedGameManagement-BAbIZXTB.js","assets/gameApi-BHu3aNHh.js","assets/BettingManagement-Dv4lY0Md.js","assets/BettingHistory-CKxpIe8f.js","assets/CallCycle-BwbaTtVv.js","assets/switch-rGnr8z3c.js","assets/CustomerSupport-qN3iQBWC.js","assets/Announcements-BzqpDivw.js","assets/MessageCenter-DklucLSR.js","assets/SystemSettings-BaHMw7R_.js","assets/BannerManagement-BZ2QQaKm.js","assets/MenuManagement-CJ5prQoB.js","assets/ApiTester-KJmkVxEz.js","assets/AutoSyncMonitor-CG7fdLLX.js","assets/UserCasino-BSg2hq7O.js","assets/ImageWithFallback-B0TTlR8N.js","assets/UserSlot-CV3hTWM4.js","assets/UserDeposit-Ce6MN_vK.js","assets/UserWithdraw-NQF69HbZ.js","assets/UserNotice-Dg0c_RqK.js","assets/collapsible-Bk9eB6pG.js","assets/UserSupport-BsARpDU5.js","assets/UserProfile-Ivarh59_.js","assets/UserBettingHistory-CMHQ8mLH.js"])))=>i.map(i=>d[i]);
import{j as t,r as p,c as be,f as dr}from"./react-core-CwM-CeLv.js";import{z as ur,T as mr,t as St,i as At,j as Pe,k as D}from"./vendor-CQn7sZ7L.js";import{S as kt,b as pr,d as fr,e as gr,T as hr,f as xr,g as br,A as _r,h as wr,F as yr,i as Et,j as vr,k as jr,l as Nr,I as Sr,m as Ar,n as kr,L as Er,o as Ir,p as Cr,q as Dr,r as Tr,s as Or,V as Pr,t as Br,v as $r,w as Mr,x as Rr,y as Lr,z as Ur,B as zr,D as Fr,E as It,G as qr,H as Vr,J as Gr,K as Wr,M as Kr,N as Hr,Q as Yr}from"./radix-ui-SX2QAG6c.js";import{L as le,S as Ct,a as ce,R as it,M as Jr,I as Xr,b as K,A as G,c as J,B as Be,C as lt,T as ne,G as _e,d as Q,D as Se,e as xe,f as oe,U as de,g as $e,h as Qr,W as Dt,i as Zr,j as Te,k as ea,l as ta,E as ct,m as dt,n as ra,o as aa,p as ut,q as Tt,H as sa,r as Ot,s as mt}from"./lucide-icons-wLPRtdhM.js";import{c as Pt,_ as P}from"./supabase-r6ABpEO8.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const d of document.querySelectorAll('link[rel="modulepreload"]'))n(d);new MutationObserver(d=>{for(const m of d)if(m.type==="childList")for(const l of m.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function a(d){const m={};return d.integrity&&(m.integrity=d.integrity),d.referrerPolicy&&(m.referrerPolicy=d.referrerPolicy),d.crossOrigin==="use-credentials"?m.credentials="include":d.crossOrigin==="anonymous"?m.credentials="omit":m.credentials="same-origin",m}function n(d){if(d.ep)return;d.ep=!0;const m=a(d);fetch(d.href,m)}})();if(typeof window<"u"&&typeof console<"u"){const e=console.warn,r=console.error;console.warn=function(...a){const n=a[0];typeof n=="string"&&(n.includes("Multiple GoTrueClient instances")||n.includes("GoTrueClient"))||e.apply(console,a)},console.error=function(...a){const n=a[0];typeof n=="string"&&n.includes("Multiple GoTrueClient instances")||r.apply(console,a)}}const pt=({...e})=>{const{theme:r="system"}=ur();return t.jsx(mr,{theme:r,className:"toaster group",style:{"--normal-bg":"var(--popover)","--normal-text":"var(--popover-foreground)","--normal-border":"var(--border)"},...e})};function O(...e){return St(At(e))}function Me({className:e,...r}){return t.jsx("div",{"data-slot":"card",className:O("glass-card rounded-xl flex flex-col gap-6",e),...r})}function Re({className:e,...r}){return t.jsx("div",{"data-slot":"card-header",className:O("@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6 pt-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",e),...r})}function Le({className:e,...r}){return t.jsx("h4",{"data-slot":"card-title",className:O("leading-none text-slate-100",e),...r})}function Bt({className:e,...r}){return t.jsx("p",{"data-slot":"card-description",className:O("text-slate-400 text-sm",e),...r})}function Ue({className:e,...r}){return t.jsx("div",{"data-slot":"card-content",className:O("px-6 [&:last-child]:pb-6",e),...r})}const ze=Pe("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-white hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",outline:"border bg-background text-foreground hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2 has-[>svg]:px-3",sm:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",lg:"h-10 rounded-md px-6 has-[>svg]:px-4",icon:"size-9 rounded-md"}},defaultVariants:{variant:"default",size:"default"}}),U=p.forwardRef(({className:e,variant:r,size:a,asChild:n=!1,...d},m)=>{const l=n?kt:"button";return t.jsx(l,{"data-slot":"button",className:O(ze({variant:r,size:a,className:e})),ref:m,...d})});U.displayName="Button";function z({className:e,type:r,...a}){return t.jsx("input",{type:r,"data-slot":"input",className:O("file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border px-3 py-1 text-base bg-input-background transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm","focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]","aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",e),...a})}function F({className:e,...r}){return t.jsx(pr,{"data-slot":"label",className:O("flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",e),...r})}function Y(...e){return St(At(e))}function te(e){return new Intl.NumberFormat("ko-KR",{style:"currency",currency:"KRW",minimumFractionDigits:0}).format(e)}function ft(e){return new Intl.NumberFormat("ko-KR").format(e)}function Zs(e){return{1:"시스템관리자",2:"대본사",3:"본사",4:"부본사",5:"총판",6:"매장"}[e]||"알 수 없음"}const W={get:e=>{try{const r=localStorage.getItem(e);return r?JSON.parse(r):null}catch{return null}},set:(e,r)=>{try{localStorage.setItem(e,JSON.stringify(r))}catch{}},remove:e=>{try{localStorage.removeItem(e)}catch{}}};function na({size:e="md",className:r,text:a}){const n={sm:"h-4 w-4",md:"h-6 w-6",lg:"h-8 w-8"};return t.jsxs("div",{className:Y("flex items-center justify-center gap-2",r),children:[t.jsx(le,{className:Y("animate-spin",n[e])}),a&&t.jsx("span",{className:"text-sm text-muted-foreground",children:a})]})}function oa({children:e}){return t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(le,{className:"h-4 w-4 animate-spin"}),e]})}const $t="nzuzzmaiuybzyndptaba",ia="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56dXp6bWFpdXlienluZHB0YWJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyMDM5NDMsImV4cCI6MjA3NDc3OTk0M30.XLuJJG-KhlmRrFYsIZsF_iINbJ9iWPhJ3q4Cby1_WJU",la=`https://${$t}.supabase.co`,ca=ia;let Ae=null;const da=()=>(Ae||(Ae=Pt(la,ca,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1,storageKey:"sb-gms-main-client",storage:{getItem:e=>{try{return localStorage.getItem(e)}catch{return null}},setItem:(e,r)=>{try{localStorage.setItem(e,r)}catch{}},removeItem:e=>{try{localStorage.removeItem(e)}catch{}}}},db:{schema:"public"},global:{headers:{"X-Client-Info":"gms-main-client"}}})),Ae),j=da(),Mt=p.createContext(null);function ve(){const e=p.useContext(Mt);if(!e)throw new Error("useAuth must be used within AuthProvider");return e}function ua(){const[e,r]=p.useState({isAuthenticated:!1,user:null,token:null});p.useEffect(()=>{const l=W.get("auth_token"),s=W.get("auth_user");l&&s&&typeof s.level=="number"&&r({isAuthenticated:!0,user:s,token:l})},[]);const a=async(l,s)=>{try{const{data:i,error:o}=await j.rpc("partner_login",{p_username:l,p_password:s});if(o)return console.error("로그인 RPC 오류:",o),{success:!1,error:`로그인 오류: ${o.message||"알 수 없는 오류"}`};if(!i||i.length===0)return console.error("로그인 실패: 사용자 데이터 없음"),{success:!1,error:"아이디 또는 비밀번호가 올바르지 않습니다."};const u=i[0],x={id:u.id,username:u.username,nickname:u.nickname,partner_type:u.partner_type,level:u.level,parent_id:u.parent_id||void 0,status:u.status,balance:u.balance,opcode:u.opcode||void 0,secret_key:u.secret_key||void 0,api_token:u.api_token||void 0,commission_rolling:u.commission_rolling,commission_losing:u.commission_losing,withdrawal_fee:u.withdrawal_fee,last_login_at:u.last_login_at,created_at:u.created_at};console.log("✅ 파트너 로그인 성공:",{id:x.id,username:x.username,partner_type:x.partner_type,level:x.level,has_opcode:!!x.opcode,has_secret_key:!!x.secret_key,has_api_token:!!x.api_token});const b={isAuthenticated:!0,user:x,token:`partner-token-${x.id}`};return r(b),W.set("auth_token",b.token),W.set("auth_user",x),{success:!0}}catch(i){return console.error("Login error:",i),{success:!1,error:"로그인 중 오류가 발생했습니다."}}};return{authState:e,login:a,logout:()=>{r({isAuthenticated:!1,user:null,token:null}),W.remove("auth_token"),W.remove("auth_user")},quickLogin:async()=>await a("smcdev11","smcdev11!"),checkAuth:async()=>{const l=W.get("auth_token"),s=W.get("auth_user");l&&s&&typeof s.level=="number"&&r({isAuthenticated:!0,user:s,token:l})}}}function ma({onLoginSuccess:e}){const[r,a]=p.useState(""),[n,d]=p.useState(""),[m,l]=p.useState(!1),{login:s}=ve(),i=async o=>{if(o.preventDefault(),!r.trim()||!n.trim()){D.error("아이디와 비밀번호를 입력해주세요.");return}l(!0);try{const u=await s(r.trim(),n);u.success?(D.success("로그인되었습니다."),e()):D.error(u.error||"로그인에 실패했습니다.")}catch{D.error("로그인 중 오류가 발생했습니다.")}finally{l(!1)}};return t.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4",children:t.jsxs(Me,{className:"w-full max-w-md bg-slate-800/50 border-slate-700 shadow-2xl",children:[t.jsxs(Re,{className:"space-y-1 text-center",children:[t.jsx("div",{className:"flex justify-center mb-4",children:t.jsx(Ct,{className:"h-12 w-12 text-blue-400"})}),t.jsx(Le,{className:"text-2xl font-bold text-white",children:"GMS 관리자"}),t.jsx(Bt,{className:"text-slate-400",children:"게임 관리 시스템"})]}),t.jsx(Ue,{children:t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"space-y-1",children:[t.jsx("h3",{className:"text-white",children:"관리자 로그인"}),t.jsx("p",{className:"text-sm text-slate-400",children:"계정 정보를 입력하여 로그인하세요"})]}),t.jsxs("form",{onSubmit:i,className:"space-y-4",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx(F,{htmlFor:"username",className:"text-white",children:"아이디"}),t.jsx(z,{id:"username",type:"text",value:r,onChange:o=>a(o.target.value),placeholder:"관리자 아이디를 입력하세요",className:"bg-slate-700/50 border-slate-600 text-white placeholder:text-slate-400",disabled:m})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(F,{htmlFor:"password",className:"text-white",children:"비밀번호"}),t.jsx(z,{id:"password",type:"password",value:n,onChange:o=>d(o.target.value),placeholder:"비밀번호를 입력하세요",className:"bg-slate-700/50 border-slate-600 text-white placeholder:text-slate-400",disabled:m})]}),t.jsx(U,{type:"submit",disabled:m,className:"w-full bg-slate-700 hover:bg-slate-600",children:m?t.jsx(oa,{children:"로그인"}):"로그인"})]})]})}),t.jsxs("div",{className:"px-6 pb-6 text-center text-xs text-slate-500 space-y-1",children:[t.jsx("p",{children:"GMS v1.0 | 통합 게임 관리 시스템"}),t.jsx("p",{children:"7단계 권한 체계 | 실시간 데이터 동기화"})]})]})})}const ke=768;function pa(){const[e,r]=p.useState(void 0);return p.useEffect(()=>{const a=window.matchMedia(`(max-width: ${ke-1}px)`),n=()=>{r(window.innerWidth<ke)};return a.addEventListener("change",n),r(window.innerWidth<ke),()=>a.removeEventListener("change",n)},[]),!!e}function H({delayDuration:e=0,...r}){return t.jsx(fr,{"data-slot":"tooltip-provider",delayDuration:e,...r})}function re({...e}){return t.jsx(H,{children:t.jsx(gr,{"data-slot":"tooltip",...e})})}function ae({...e}){return t.jsx(hr,{"data-slot":"tooltip-trigger",...e})}function se({className:e,sideOffset:r=0,children:a,...n}){return t.jsx(xr,{children:t.jsxs(br,{"data-slot":"tooltip-content",sideOffset:r,className:O("bg-primary text-primary-foreground animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-fit origin-(--radix-tooltip-content-transform-origin) rounded-md px-3 py-1.5 text-xs text-balance",e),...n,children:[a,t.jsx(_r,{className:"bg-primary fill-primary z-50 size-2.5 translate-y-[calc(-50%_-_2px)] rotate-45 rounded-[2px]"})]})})}const fa="sidebar_state",ga=3600*24*7,ha="16rem",xa="3rem",ba="b",_a=p.createContext(null);function wa({defaultOpen:e=!0,open:r,onOpenChange:a,className:n,style:d,children:m,...l}){const s=pa(),[i,o]=p.useState(!1),[u,x]=p.useState(e),b=r??u,N=p.useCallback(c=>{const g=typeof c=="function"?c(b):c;a?a(g):x(g),document.cookie=`${fa}=${g}; path=/; max-age=${ga}`},[a,b]),w=p.useCallback(()=>s?o(c=>!c):N(c=>!c),[s,N,o]);p.useEffect(()=>{const c=g=>{g.key===ba&&(g.metaKey||g.ctrlKey)&&(g.preventDefault(),w())};return window.addEventListener("keydown",c),()=>window.removeEventListener("keydown",c)},[w]);const y=b?"expanded":"collapsed",h=p.useMemo(()=>({state:y,open:b,setOpen:N,isMobile:s,openMobile:i,setOpenMobile:o,toggleSidebar:w}),[y,b,N,s,i,o,w]);return t.jsx(_a.Provider,{value:h,children:t.jsx(H,{delayDuration:0,children:t.jsx("div",{"data-slot":"sidebar-wrapper",style:{"--sidebar-width":ha,"--sidebar-width-icon":xa,...d},className:O("group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full",n),...l,children:m})})})}const gt={"/admin/dashboard":ce,"/admin/realtime":G,"/admin/users":de,"/admin/user-management":de,"/admin/blacklist":Ct,"/admin/points":ne,"/admin/online":G,"/admin/online-users":G,"/admin/online-status":G,"/admin/logs":Se,"/admin/head-office":oe,"/admin/partners/master":oe,"/admin/partners":oe,"/admin/partner-hierarchy":oe,"/admin/partner-transactions":Q,"/admin/partners/transactions":Q,"/admin/partner-online":G,"/admin/partners/status":G,"/admin/partner-dashboard":ce,"/admin/partners/dashboard":ce,"/admin/settlement":xe,"/admin/commission-settlement":xe,"/admin/settlement/commission":xe,"/admin/integrated-settlement":Se,"/admin/settlement/integrated":Se,"/admin/transactions":Q,"/admin/transaction-approval":Q,"/admin/games":_e,"/admin/game-lists":_e,"/admin/betting":ne,"/admin/betting-history":ne,"/admin/betting-management":ne,"/admin/call-cycle":it,"/admin/communication":J,"/admin/customer-service":lt,"/admin/support":lt,"/admin/announcements":Be,"/admin/messages":J,"/admin/settings":K,"/admin/system-settings":K,"/admin/system":G,"/admin/system-info":G,"/admin/api-tester":K,"/admin/banners":Xr,"/admin/menu-management":Jr,"/admin/auto-sync-monitor":it},ya=e=>{const r=e.toLowerCase();return r.includes("회원")?de:r.includes("파트너")?oe:r.includes("정산")||r.includes("거래")?xe:r.includes("게임")?_e:r.includes("커뮤")||r.includes("메시지")?J:r.includes("시스템")||r.includes("설정")?K:K};function va({user:e,className:r,onNavigate:a,currentRoute:n}){const[d,m]=p.useState([]),[l,s]=p.useState([]),[i,o]=p.useState(!0);p.useEffect(()=>{u()},[e.id]);const u=async()=>{if(e?.id){o(!0);try{const{data:w,error:y}=await j.rpc("get_partner_enabled_menus",{p_partner_id:e.id}),h={id:"dashboard",title:"대시보드",icon:ce,path:"/admin/dashboard",minLevel:6};if(y||!w||w.length===0)s([h]);else{const g=x(w),k=g.some(v=>v.path==="/admin/dashboard");s(k?g:[h,...g])}}catch{s([{id:"dashboard",title:"대시보드",icon:ce,path:"/admin/dashboard",minLevel:6}])}finally{o(!1)}}},x=w=>{const y=w.reduce((v,A)=>{const _=A.parent_menu||"root";return v[_]||(v[_]=[]),v[_].push(A),v},{}),h=(y.root||[]).sort((v,A)=>v.display_order-A.display_order),c={};Object.keys(y).forEach(v=>{if(v!=="root"){const A=y[v];c[v]=Math.min(...A.map(_=>_.display_order))}});const g=[];h.forEach(v=>{g.push({type:"single",order:v.display_order,item:{id:v.menu_id,title:v.menu_name,icon:gt[v.menu_path]||K,path:v.menu_path,minLevel:6}})});const k=new Set;return Object.keys(y).forEach(v=>{if(v!=="root"&&!k.has(v)){k.add(v);const _=y[v].sort((f,S)=>f.display_order-S.display_order).map(f=>({id:f.menu_id,title:f.menu_name,icon:gt[f.menu_path]||K,path:f.menu_path,minLevel:6,parent_menu:f.parent_menu||void 0}));g.push({type:"group",order:c[v]||999,item:{id:`group-${v}`,title:v,icon:ya(v),minLevel:6,children:_}})}}),g.sort((v,A)=>v.order-A.order).map(v=>v.item)},b=w=>{m(y=>y.includes(w)?y.filter(h=>h!==w):[...y,w])},N=(w,y=0)=>{const h=w.children&&w.children.length>0,c=d.includes(w.id),g=n===w.path,k=w.icon;return t.jsxs("div",{children:[t.jsxs("button",{onClick:()=>{h?b(w.id):w.path&&a&&a(w.path)},className:Y("w-full flex items-center gap-2 px-3 py-2.5 rounded-lg transition-all duration-200","text-sm group relative",g?"bg-gradient-to-r from-blue-600/20 to-purple-600/20 text-white border border-blue-500/30":"text-slate-300 hover:bg-slate-800/50 hover:text-white",y>0&&"ml-4"),children:[t.jsx(k,{className:Y("w-4 h-4 flex-shrink-0",g?"text-blue-400":"text-slate-400 group-hover:text-blue-400")}),t.jsx("span",{className:"flex-1 text-left truncate overflow-hidden text-ellipsis whitespace-nowrap",children:w.title}),h&&(c?t.jsx($e,{className:"w-4 h-4 text-slate-400 flex-shrink-0"}):t.jsx(Qr,{className:"w-4 h-4 text-slate-400 flex-shrink-0"}))]}),h&&c&&t.jsx("div",{className:"ml-2 mt-1 space-y-1",children:w.children.map(v=>N(v,y+1))})]},w.id)};return t.jsxs("div",{className:Y("flex flex-col h-full bg-[#0f1419] overflow-hidden",r),children:[t.jsx("div",{className:"p-4 border-b border-slate-700/50 flex-shrink-0",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center flex-shrink-0",children:t.jsx("span",{className:"text-white font-bold text-lg",children:"G"})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("h1",{className:"text-white font-bold truncate",children:"GMS"}),t.jsx("p",{className:"text-xs text-slate-400 truncate",children:e.nickname})]})]})}),t.jsx("div",{className:"flex-1 overflow-y-auto overflow-x-hidden p-3 space-y-1",children:i?t.jsxs("div",{className:"text-center py-8",children:[t.jsx("div",{className:"loading-premium mx-auto"}),t.jsx("p",{className:"text-xs text-slate-400 mt-2",children:"메뉴 로딩 중..."})]}):l.map(w=>N(w))}),t.jsx("div",{className:"p-3 border-t border-slate-700/50 flex-shrink-0",children:t.jsx("button",{onClick:()=>{window.history.pushState({},"","/user"),window.dispatchEvent(new Event("popstate"))},className:"w-full text-xs text-slate-500 hover:text-slate-300 text-center truncate transition-colors cursor-pointer",children:"GMS v1.0"})})]})}const ja=Pe("inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",secondary:"border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",destructive:"border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",outline:"text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground"}},defaultVariants:{variant:"default"}});function Rt({className:e,variant:r,asChild:a=!1,...n}){const d=a?kt:"span";return t.jsx(d,{"data-slot":"badge",className:O(ja({variant:r}),e),...n})}function Na({className:e,...r}){return t.jsx(wr,{"data-slot":"avatar",className:O("relative flex size-10 shrink-0 overflow-hidden rounded-full",e),...r})}function Sa({className:e,...r}){return t.jsx(yr,{"data-slot":"avatar-fallback",className:O("bg-muted flex size-full items-center justify-center rounded-full",e),...r})}function Lt({...e}){return t.jsx(vr,{"data-slot":"dropdown-menu",...e})}const Fe=p.forwardRef(({...e},r)=>t.jsx(Et,{ref:r,"data-slot":"dropdown-menu-trigger",...e}));Fe.displayName=Et.displayName;function Ut({className:e,sideOffset:r=4,...a}){return t.jsx(jr,{children:t.jsx(Nr,{"data-slot":"dropdown-menu-content",sideOffset:r,className:O("bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md",e),...a})})}function ie({className:e,inset:r,variant:a="default",...n}){return t.jsx(Sr,{"data-slot":"dropdown-menu-item","data-inset":r,"data-variant":a,className:O("focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",e),...n})}function Aa({className:e,...r}){return t.jsx(Ar,{"data-slot":"dropdown-menu-separator",className:O("bg-border -mx-1 my-1 h-px",e),...r})}function zt(e){const r=new TextEncoder().encode(e),a=(c,g)=>c<<g|c>>>32-g,n=(c,g)=>{const k=(c&65535)+(g&65535);return(c>>16)+(g>>16)+(k>>16)<<16|k&65535},d=r.length,m=(d+8>>6)+1,l=new Array(m*16);for(let c=0;c<m*16;c++)l[c]=0;for(let c=0;c<d;c++)l[c>>2]|=r[c]<<c%4*8;l[d>>2]|=128<<d%4*8,l[m*16-2]=d*8;let s=1732584193,i=4023233417,o=2562383102,u=271733878;const x=(c,g,k,v,A,_)=>n(a(n(n(g,c),n(v,_)),A),k),b=(c,g,k,v,A,_,f)=>x(g&k|~g&v,c,g,A,_,f),N=(c,g,k,v,A,_,f)=>x(g&v|k&~v,c,g,A,_,f),w=(c,g,k,v,A,_,f)=>x(g^k^v,c,g,A,_,f),y=(c,g,k,v,A,_,f)=>x(k^(g|~v),c,g,A,_,f);for(let c=0;c<m*16;c+=16){const g=s,k=i,v=o,A=u;s=b(s,i,o,u,l[c],7,3614090360),u=b(u,s,i,o,l[c+1],12,3905402710),o=b(o,u,s,i,l[c+2],17,606105819),i=b(i,o,u,s,l[c+3],22,3250441966),s=b(s,i,o,u,l[c+4],7,4118548399),u=b(u,s,i,o,l[c+5],12,1200080426),o=b(o,u,s,i,l[c+6],17,2821735955),i=b(i,o,u,s,l[c+7],22,4249261313),s=b(s,i,o,u,l[c+8],7,1770035416),u=b(u,s,i,o,l[c+9],12,2336552879),o=b(o,u,s,i,l[c+10],17,4294925233),i=b(i,o,u,s,l[c+11],22,2304563134),s=b(s,i,o,u,l[c+12],7,1804603682),u=b(u,s,i,o,l[c+13],12,4254626195),o=b(o,u,s,i,l[c+14],17,2792965006),i=b(i,o,u,s,l[c+15],22,1236535329),s=N(s,i,o,u,l[c+1],5,4129170786),u=N(u,s,i,o,l[c+6],9,3225465664),o=N(o,u,s,i,l[c+11],14,643717713),i=N(i,o,u,s,l[c],20,3921069994),s=N(s,i,o,u,l[c+5],5,3593408605),u=N(u,s,i,o,l[c+10],9,38016083),o=N(o,u,s,i,l[c+15],14,3634488961),i=N(i,o,u,s,l[c+4],20,3889429448),s=N(s,i,o,u,l[c+9],5,568446438),u=N(u,s,i,o,l[c+14],9,3275163606),o=N(o,u,s,i,l[c+3],14,4107603335),i=N(i,o,u,s,l[c+8],20,1163531501),s=N(s,i,o,u,l[c+13],5,2850285829),u=N(u,s,i,o,l[c+2],9,4243563512),o=N(o,u,s,i,l[c+7],14,1735328473),i=N(i,o,u,s,l[c+12],20,2368359562),s=w(s,i,o,u,l[c+5],4,4294588738),u=w(u,s,i,o,l[c+8],11,2272392833),o=w(o,u,s,i,l[c+11],16,1839030562),i=w(i,o,u,s,l[c+14],23,4259657740),s=w(s,i,o,u,l[c+1],4,2763975236),u=w(u,s,i,o,l[c+4],11,1272893353),o=w(o,u,s,i,l[c+7],16,4139469664),i=w(i,o,u,s,l[c+10],23,3200236656),s=w(s,i,o,u,l[c+13],4,681279174),u=w(u,s,i,o,l[c],11,3936430074),o=w(o,u,s,i,l[c+3],16,3572445317),i=w(i,o,u,s,l[c+6],23,76029189),s=w(s,i,o,u,l[c+9],4,3654602809),u=w(u,s,i,o,l[c+12],11,3873151461),o=w(o,u,s,i,l[c+15],16,530742520),i=w(i,o,u,s,l[c+2],23,3299628645),s=y(s,i,o,u,l[c],6,4096336452),u=y(u,s,i,o,l[c+7],10,1126891415),o=y(o,u,s,i,l[c+14],15,2878612391),i=y(i,o,u,s,l[c+5],21,4237533241),s=y(s,i,o,u,l[c+12],6,1700485571),u=y(u,s,i,o,l[c+3],10,2399980690),o=y(o,u,s,i,l[c+10],15,4293915773),i=y(i,o,u,s,l[c+1],21,2240044497),s=y(s,i,o,u,l[c+8],6,1873313359),u=y(u,s,i,o,l[c+15],10,4264355552),o=y(o,u,s,i,l[c+6],15,2734768916),i=y(i,o,u,s,l[c+13],21,1309151649),s=y(s,i,o,u,l[c+4],6,4149444226),u=y(u,s,i,o,l[c+11],10,3174756917),o=y(o,u,s,i,l[c+2],15,718787259),i=y(i,o,u,s,l[c+9],21,3951481745),s=n(s,g),i=n(i,k),o=n(o,v),u=n(u,A)}const h=c=>{let g="";for(let k=0;k<=3;k++)g+=(c>>k*8&255).toString(16).padStart(2,"0");return g};return h(s)+h(i)+h(o)+h(u)}const ka="https://api.invest-ho.com",Ee="https://vi8282.com/proxy";function M(e,r){const a=e.join("")+r,n=zt(a);return console.log("🔐 Signature 생성:",{params:e,secretKey:"***"+r.slice(-4),combined_string_preview:a.substring(0,100)+(a.length>100?"...":""),combined_length:a.length,signature:n,validation:`md5(${e.join(" + ")} + secretKey)`,exact_formula:`md5("${e.join('" + "')}" + "***${r.slice(-4)}")`}),n}async function R(e,r="GET",a,n=2){let d=null;for(let l=0;l<=n;l++){l>0&&(console.log(`🔄 재시도 ${l}/${n}...`),await new Promise(s=>setTimeout(s,Math.min(1e3*Math.pow(2,l-1),5e3))));try{const s=`${ka}${e}`,i={url:s,method:r,headers:{"Content-Type":"application/json"},body:a};l===0&&console.log("🌐 Proxy 서버 호출:",{proxy_url:Ee,target_url:s,method:r,opcode:a?.opcode||"N/A"});const o=new AbortController,u=setTimeout(()=>o.abort(),3e4),x=await fetch(Ee,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json, text/plain, */*"},body:JSON.stringify(i),signal:o.signal,mode:"cors",credentials:"omit"});if(clearTimeout(u),console.log("📡 Proxy 응답 상태:",{status:x.status,statusText:x.statusText,ok:x.ok,contentType:x.headers.get("content-type")}),!x.ok){let w="";try{w=await x.text()}catch{w=`응답 읽기 실패 (${x.status})`}console.error("❌ Proxy 서버 오류:",w);try{await j.from("api_sync_logs").insert({opcode:a?.opcode||"N/A",api_endpoint:e,sync_type:r,status:"error",error_message:`HTTP ${x.status}: ${w}`,response_data:{http_status:x.status}})}catch(y){console.warn("⚠️ api_sync_logs 기록 실패:",y)}if(x.status>=500&&l<n){d=new Error(`서버 오류 (${x.status}): ${w}`);continue}return{data:null,error:`API 호출 실패 (${x.status}): ${w}`,status:x.status}}let b;const N=await x.text();if(l===0&&console.log("📄 Raw 응답:",N.substring(0,500)+(N.length>500?"...":"")),!N.trim()){if(console.warn("⚠️ 빈 응답 수신"),l<n){d=new Error("빈 응답을 받았습니다");continue}return{data:null,error:"빈 응답을 받았습니다",status:x.status}}try{b=JSON.parse(N),b&&typeof b=="object"?b.DATA!==void 0&&b.DATA!==null&&!Array.isArray(b.DATA)&&typeof b.DATA!="object"&&(console.warn("⚠️ DATA 필드가 예상하지 못한 타입:",typeof b.DATA),b.DATA=[]):(console.warn("⚠️ 파싱된 결과가 객체가 아님:",typeof b),b={data:b,is_fallback:!0})}catch{console.log("📝 JSON 파싱 실패, 텍스트로 처리:",N),b={text_response:N,is_text:!0}}console.log("✅ Proxy 응답 파싱 완료:",{type:typeof b,isArray:Array.isArray(b),keys:typeof b=="object"?Object.keys(b):null});try{await j.from("api_sync_logs").insert({opcode:a?.opcode||"N/A",api_endpoint:e,sync_type:r,status:"success",error_message:null,response_data:b})}catch(w){console.warn("⚠️ api_sync_logs 기록 실패:",w)}return{data:b,error:null,status:x.status}}catch(s){if(d=s,s instanceof Error){if(s.name==="AbortError"){if(console.error("❌ API 호출 타임아웃"),l<n)continue;return{data:null,error:"API 호출 타임아웃 (30초). Proxy 서버가 응답하지 않습니다.",status:408}}if(s.message.includes("Failed to fetch")||s.message.includes("fetch")){if(console.error("❌ 네트워크 오류:",s.message),l<n)continue;return{data:null,error:`Proxy 서버(${Ee})에 연결할 수 없습니다. 네트워크 연결을 확인하세요.`,status:0}}}if(console.error("❌ Invest API 호출 오류:",s),l<n)continue}}const m=d instanceof Error?d.message:"알 수 없는 오류";console.error("❌ 모든 재시도 실패:",m);try{await j.from("api_sync_logs").insert({opcode:a?.opcode||"N/A",api_endpoint:e,sync_type:r,status:"error",error_message:`재시도 ${n}회 실패: ${m}`,response_data:null})}catch(l){console.warn("⚠️ api_sync_logs 기록 실패:",l)}return{data:null,error:`API 호출 실패 (재시도 ${n}회): ${m}`,status:500}}async function Ft(e,r,a){const n=M([e,r],a);return await R("/api/account","POST",{opcode:e,username:r,signature:n})}async function qe(e,r,a,n){const d=M([e,r,a],n);return await R("/api/account/balance","GET",{opcode:e,username:r,token:a,signature:d})}async function Ve(e,r){const a=M([e],r);return await R("/api/account/balance","PATCH",{opcode:e,signature:a})}async function Ge(e,r,a,n,d){const m=Math.floor(n),l=M([e,r,a,m.toString()],d);return console.log("💰 입금 API 호출 준비:",{opcode:e,username:r,token:"***"+a.slice(-4),amount:m,signature_params:[e,r,a,m.toString()].join(" + "),signature:l}),await R("/api/account/balance","POST",{opcode:e,username:r,token:a,amount:m,signature:l})}async function We(e,r,a,n,d){const m=Math.floor(n),l=M([e,r,a,m.toString()],d);return console.log("💸 출금 API 호출 준비:",{opcode:e,username:r,token:"***"+a.slice(-4),amount:m,signature_params:[e,r,a,m.toString()].join(" + "),signature:l}),await R("/api/account/balance","PUT",{opcode:e,username:r,token:a,amount:m,signature:l})}async function Ke(e,r,a,n){try{if(!e||!r||!a||!n){const s=[];return e||s.push("opcode"),r||s.push("username"),a||s.push("api_token"),n||s.push("secret_key"),console.error("❌ [보유금 조회] 필수 파라미터 누락:",{opcode:e,username:r,hasToken:!!a,hasSecretKey:!!n,missing:s}),(!a||!n)&&(console.error(`💡 해결 방법: partners 테이블에서 opcode='${e}'인 레코드에 다음 값을 설정하세요:`),console.error("   - api_token: Invest API에서 발급받은 토큰"),console.error("   - secret_key: Invest API에서 발급받은 시크릿 키"),console.error(`SQL 예시: UPDATE partners SET api_token = 'YOUR_TOKEN', secret_key = 'YOUR_SECRET' WHERE opcode = '${e}';`)),{success:!1,error:`필수 파라미터 누락: ${s.join(", ")}`}}const d=M([e,r,a],n);console.log("💰 보유금 조회 API 호출:",{opcode:e,username:r,token:"***"+a.slice(-4)});const m=await R("/api/account/balance","GET",{opcode:e,username:r,token:a,signature:d});if(m.error)return console.error("❌ [보유금 조회] API 오류:",m.error),{success:!1,error:m.error};console.log("📊 [보유금 조회] API 응답:",m.data);let l;return m.data&&(m.data.balance!==void 0&&m.data.balance!==null?l=Number(m.data.balance):m.data.amount!==void 0&&m.data.amount!==null?l=Number(m.data.amount):m.data.DATA?.balance!==void 0&&m.data.DATA.balance!==null?l=Number(m.data.DATA.balance):m.data.DATA?.amount!==void 0&&m.data.DATA.amount!==null?l=Number(m.data.DATA.amount):m.data.current_balance!==void 0&&m.data.current_balance!==null&&(l=Number(m.data.current_balance))),l!==void 0&&!isNaN(l)?(console.log(`✅ [보유금 조회] 성공: ${r} = ${l}원`),{success:!0,balance:l}):(console.error("❌ [보유금 조회] 응답에서 잔고를 찾을 수 없음:",m.data),{success:!1,error:"보유금 정보를 찾을 수 없습니다"})}catch(d){return console.error("❌ [보유금 조회] 오류:",d),{success:!1,error:d instanceof Error?d.message:"알 수 없는 오류"}}}async function qt(e,r){try{console.log(`🔍 [getUserBalance] partners 테이블 조회 시작: opcode=${e}`);const{data:a,error:n}=await j.from("partners").select("api_token, secret_key, opcode, username").eq("opcode",e).single();return console.log("🔍 [getUserBalance] 조회 결과:",{partner:a,configError:n,hasApiToken:!!a?.api_token,hasSecretKey:!!a?.secret_key}),n||!a?(console.error("❌ [보유금 조회] partners 조회 실패:",{opcode:e,error:n,errorCode:n?.code,errorMessage:n?.message,errorDetails:n?.details}),{success:!1,error:`API 설정을 찾을 수 없습니다 (opcode: ${e})`}):!a.api_token||!a.secret_key?(console.error("❌ [보유금 조회] API 설정 불완전:",{opcode:e,username:a.username,hasApiToken:!!a.api_token,hasSecretKey:!!a.secret_key,apiTokenLength:a.api_token?.length||0,secretKeyLength:a.secret_key?.length||0}),{success:!1,error:"API 설정이 불완전합니다"}):await Ke(e,r,a.api_token,a.secret_key)}catch(a){return console.error("❌ [보유금 조회] 오류:",a),{success:!1,error:a instanceof Error?a.message:"알 수 없는 오류"}}}async function Vt(e,r,a,n,d){if(!a||!n||!d)return console.error("❌ depositBalance: opcode, token, secretKey 필수 파라미터 누락"),{success:!1,error:"opcode, token, secretKey는 필수입니다. opcodeHelper.getAdminOpcode()로 조회하세요.",data:null};const m=await Ge(a,e,n,r,d);return{success:!m.error,error:m.error,data:m.data}}async function Gt(e,r,a,n,d){if(!a||!n||!d)return console.error("❌ withdrawBalance: opcode, token, secretKey 필수 파라미터 누락"),{success:!1,error:"opcode, token, secretKey는 필수입니다. opcodeHelper.getAdminOpcode()로 조회하세요.",data:null};const m=await We(a,e,n,r,d);return{success:!m.error,error:m.error,data:m.data}}async function Wt(e,r,a,n,d){const m=M([e,r,a,n],d);return await R("/api/account/balance","VIEW",{opcode:e,username:r,date_from:a,date_to:n,signature:m})}async function je(e,r){const a=M([e],r);return console.log("📊 기본정보 조회 API 호출:",{opcode:e,secretKey:"***"+r.slice(-4),signature:a}),await R("/api/info","GET",{opcode:e,signature:a})}function Ea(e){if(e.game_image&&typeof e.game_image=="string"&&e.game_image.trim()){const a=e.game_image.trim();if(a.startsWith("http")||a.startsWith("//"))return a}const r=["image_url","imageUrl","img_url","thumbnail"];for(const a of r){const n=e[a];if(n&&typeof n=="string"&&n.trim()){const d=n.trim();if(d.startsWith("http")||d.startsWith("//"))return d}}return null}async function Kt(e,r,a){const n=M([e,r.toString()],a);console.log(`📡 게임 리스트 API 호출 시작 - Provider ID: ${r}`);const d=await R("/api/game/lists","GET",{opcode:e,provider_id:r,signature:n});if(d.data&&!d.error&&Array.isArray(d.data?.DATA)){const m=d.data.DATA[0];console.log(`📊 Provider ${r} API 응답:`,{총게임수:d.data.DATA.length,샘플게임:m?{전체필드:Object.keys(m),game_image:m.game_image,game_title:m.game_title||m.name}:null}),d.data.DATA=d.data.DATA.map(i=>{const o=Ea(i);return{...i,image_url:o||i.image_url||null}});const l=d.data.DATA.filter(i=>i.image_url).length,s=d.data.DATA.length-l;console.log(`✅ Provider ${r} 이미지 정규화:`,{총게임:d.data.DATA.length,이미지있음:l,이미지없음:s})}return d}async function Ht(e,r,a,n,d){console.log("🎮 게임 실행 API 호출:",{opcode:e,username:r,gameId:n,endpoint:"/api/game/launch"});const m=M([e,r,a,n.toString()],d),l=await R("/api/game/launch","POST",{opcode:e,username:r,token:a,game:n,signature:m});if(console.log("🎮 게임 실행 API 응답:",{success:!l.error,data:l.data,error:l.error}),l.error)return{success:!1,error:l.error,data:null};let s="";const i=l.data;if(i){if(i.is_text&&i.text_response){const o=i.text_response.match(/https?:\/\/[^\s<>"]+/);s=o?o[0]:""}else if(!i.is_text)s=i.game_url||i.url||i.launch_url||i.gameUrl||i.DATA?.game_url||i.DATA?.url||"";else if(typeof i=="string"){const o=i.match(/https?:\/\/[^\s<>"]+/);s=o?o[0]:""}}if(!s){let o="게임 실행 URL을 받지 못했습니다.";return i&&!i.is_text&&typeof i=="object"&&(i.RESULT===!1&&(o=i.DATA?.message||i.message||o),i.code===0&&i.message&&(o=i.message)),{success:!1,error:o,data:i}}return{success:!0,error:null,data:{game_url:s,url:s,launch_url:s}}}async function He(e,r,a,n,d=1e3,m){const l=M([e,r,a,n.toString()],m);return console.log("📊 getGameHistory 호출:",{opcode:e,year:r,month:a,index:n,limit:d,signature_formula:`md5(${e} + ${r} + ${a} + ${n} + ***${m.slice(-4)})`,signature:l}),await R("/api/game/historyindex","GET",{opcode:e,year:r,month:a,index:n,limit:d,signature:l})}async function Yt(e,r,a,n){const d=M([e,r,a.toString()],n);return await R("/api/game/detail","GET",{opcode:e,yyyymm:r,txid:a,signature:d})}const we={SLOT:{1:"마이크로게이밍",17:"플레이앤고",20:"CQ9 게이밍",21:"제네시스 게이밍",22:"하바네로",23:"게임아트",27:"플레이텍",38:"블루프린트",39:"부운고",40:"드라군소프트",41:"엘크 스튜디오",47:"드림테크",51:"칼람바 게임즈",52:"모빌롯",53:"노리밋 시티",55:"OMI 게이밍",56:"원터치",59:"플레이슨",60:"푸쉬 게이밍",61:"퀵스핀",62:"RTG 슬롯",63:"리볼버 게이밍",65:"슬롯밀",66:"스피어헤드",70:"썬더킥",72:"우후 게임즈",74:"릴렉스 게이밍",75:"넷엔트",76:"레드타이거",87:"PG소프트",88:"플레이스타",90:"빅타임게이밍",300:"프라그마틱 플레이"},CASINO:{41e4:"에볼루션 게이밍",77060:"마이크로 게이밍",2029:"Vivo 게이밍",3e4:"아시아 게이밍",78001:"프라그마틱플레이",86001:"섹시게이밍",11e3:"비비아이엔",28e3:"드림게임",89e3:"오리엔탈게임",91e3:"보타",44006:"이주기",85036:"플레이텍 라이브",0:"제네럴 카지노"}};function Jt(e){return Math.floor(e/1e3)}function Xt(e,r=!0){return(r?we.SLOT:we.CASINO)[e]||`Unknown Provider (${e})`}function Ye(e){if(!e)return{isValid:!1,error:"API 응답이 없습니다"};if(e.is_text&&e.text_response){const r=e.text_response.includes("http"),a=e.text_response.toLowerCase().includes("error");if(r&&!a)return{isValid:!0};if(a)return{isValid:!1,error:`API 오류: ${e.text_response.substring(0,200)}`};if(/balance|amount|success/i.test(e.text_response))return{isValid:!0}}if(!e.is_text){if(e.RESULT===!1){const r=e.DATA?.message||e.message||"처리에 실패했습니다";return r.includes("게임기록이 존재하지 않습니다")||r.includes("기록이 존재하지 않습니다")||r.includes("no data")||e.code===400?{isValid:!0,isNoData:!0,error:r}:{isValid:!1,error:r}}if(e.error_code||e.ERROR){const r=e.error_code||e.ERROR;return{isValid:!1,error:{1001:"OPCODE가 유효하지 않습니다",1002:"서명(Signature)이 올바르지 않습니다",1003:"사용자를 찾을 수 없습니다",1004:"잔고가 부족합니다",1005:"게임을 찾을 수 없습니다",1006:"제공사를 찾을 수 없습니다",2001:"API 서버 내부 오류",2002:"데이터베이스 연결 오류",3001:"요청 파라미터 오류"}[r]||`API 오류 (${r}): ${e.message||"알 수 없는 오류"}`}}if(e.RESULT===!0||e.success===!0||e.DATA)return{isValid:!0}}return{isValid:!0}}function Qt(e,r){if(!e)return 0;if(console.log("💰 잔고 추출 시도:",{response:typeof e,username:r}),e.is_text&&e.text_response){const n=e.text_response.match(/\d+(?:\.\d+)?/g);if(n&&n.length>0){const d=n.map(l=>parseFloat(l)),m=Math.max(...d);return console.log("📊 텍스트에서 추출된 잔고:",m),m}}if(!e.is_text){if(!e||typeof e!="object")return console.warn("⚠️ 유효하지 않은 JSON 응답:",e),0;try{if(e.balance!==void 0&&e.balance!==null){const a=parseFloat(e.balance);if(!isNaN(a))return a}if(e.amount!==void 0&&e.amount!==null){const a=parseFloat(e.amount);if(!isNaN(a))return a}if(e.current_balance!==void 0&&e.current_balance!==null){const a=parseFloat(e.current_balance);if(!isNaN(a))return a}}catch(a){return console.error("❌ JSON 잔고 파싱 오류:",a),0}if(e.DATA)try{if(Array.isArray(e.DATA)){if(r)try{const a=e.DATA.find(n=>n?.username===r);if(a){if(a.balance!==void 0&&a.balance!==null){const n=parseFloat(a.balance);if(!isNaN(n))return n}if(a.amount!==void 0&&a.amount!==null){const n=parseFloat(a.amount);if(!isNaN(n))return n}if(a.current_balance!==void 0&&a.current_balance!==null){const n=parseFloat(a.current_balance);if(!isNaN(n))return n}}}catch(a){return console.warn("⚠️ 배열 검색 중 오류:",a),0}else if(e.DATA[0]){const a=e.DATA[0];if(a.balance!==void 0&&a.balance!==null){const n=parseFloat(a.balance);if(!isNaN(n))return n}if(a.amount!==void 0&&a.amount!==null){const n=parseFloat(a.amount);if(!isNaN(n))return n}if(a.current_balance!==void 0&&a.current_balance!==null){const n=parseFloat(a.current_balance);if(!isNaN(n))return n}}}if(typeof e.DATA=="object"){if(e.DATA.balance!==void 0&&e.DATA.balance!==null){const a=parseFloat(e.DATA.balance);if(!isNaN(a))return a}if(e.DATA.amount!==void 0&&e.DATA.amount!==null){const a=parseFloat(e.DATA.amount);if(!isNaN(a))return a}if(e.DATA.current_balance!==void 0&&e.DATA.current_balance!==null){const a=parseFloat(e.DATA.current_balance);if(!isNaN(a))return a}if(Array.isArray(e.DATA.users)&&r)try{const a=e.DATA.users.find(n=>n?.username===r);if(a){if(a.balance!==void 0&&a.balance!==null){const n=parseFloat(a.balance);if(!isNaN(n))return n}if(a.amount!==void 0&&a.amount!==null){const n=parseFloat(a.amount);if(!isNaN(n))return n}if(a.current_balance!==void 0&&a.current_balance!==null){const n=parseFloat(a.current_balance);if(!isNaN(n))return n}}}catch(a){return console.warn("⚠️ users 배열 검색 중 오류:",a),0}}}catch(a){return console.error("❌ DATA 블록 파싱 오류:",a),0}if(Array.isArray(e)&&r)try{const a=e.find(n=>n?.username===r);if(a){if(a.balance!==void 0&&a.balance!==null){const n=parseFloat(a.balance);if(!isNaN(n))return n}if(a.amount!==void 0&&a.amount!==null){const n=parseFloat(a.amount);if(!isNaN(n))return n}if(a.current_balance!==void 0&&a.current_balance!==null){const n=parseFloat(a.current_balance);if(!isNaN(n))return n}}}catch(a){return console.warn("⚠️ 직접 배열 검색 중 오류:",a),0}}return console.log("⚠️ 잔고를 찾을 수 없음, 0 반환"),0}async function Je(e){const{data:r,error:a}=await j.from("partners").select("opcode, secret_key, api_token").eq("id",e).single();if(a||!r)throw new Error("파트너 API 설정을 찾을 수 없습니다.");if(!r.opcode||!r.secret_key||!r.api_token)throw new Error("파트너 API 설정이 불완전합니다.");return{opcode:r.opcode,secret_key:r.secret_key,token:r.api_token}}async function Zt(e,r="GET",a,n=3,d=1e3){let m=null;for(let l=1;l<=n;l++)try{const s=await R(e,r,a),i=Ye(s.data);return i.isValid?s:{data:null,error:i.error,status:s.status}}catch(s){m=s instanceof Error?s.message:"알 수 없는 오류",l<n&&(console.warn(`API 호출 실패 (시도 ${l}/${n}), ${d}ms 후 재시도:`,m),await new Promise(i=>setTimeout(i,d*l)))}return{data:null,error:`API 호출 실패 (${n}회 시도 후): ${m}`,status:500}}async function er(e,r=5,a=1e3){const n=[];for(let d=0;d<e.length;d+=r){const m=e.slice(d,d+r);(await Promise.allSettled(m.map(s=>s()))).forEach((s,i)=>{s.status==="fulfilled"?n.push(s.value):(console.error(`배치 API 호출 실패 (인덱스 ${d+i}):`,s.reason),n.push(null))}),d+r<e.length&&await new Promise(s=>setTimeout(s,a))}return n}const Xe=new Map;function tr(e,r,a){Xe.set(e,{opcode:e,secretKey:r,token:a})}function rr(e){return Xe.get(e)}function ar(){Xe.clear()}const Qe={createAccount:Ft,getAccountBalance:qe,getAllAccountBalances:Ve,depositToAccount:Ge,withdrawFromAccount:We,getAccountHistory:Wt,getInfo:je,getGameList:Kt,launchGame:Ht,getGameHistory:He,getGameDetail:Yt,getUserBalance:qt,getApiConfig:Je,depositBalance:Vt,withdrawBalance:Gt,generateSignature:M,createSignature:M,callInvestApi:R,callInvestApiWithRetry:Zt,validateApiResponse:Ye,extractBalanceFromResponse:Qt,batchApiCalls:er,cacheOpcodeConfig:tr,getCachedOpcodeConfig:rr,clearOpcodeConfigCache:ar,getProviderIdFromGameId:Jt,getProviderName:Xt,GAME_PROVIDERS:we},Ia=Object.freeze(Object.defineProperty({__proto__:null,GAME_PROVIDERS:we,batchApiCalls:er,cacheOpcodeConfig:tr,callInvestApi:R,callInvestApiWithRetry:Zt,clearOpcodeConfigCache:ar,createAccount:Ft,depositBalance:Vt,depositToAccount:Ge,extractBalanceFromResponse:Qt,generateSignature:M,getAccountBalance:qe,getAccountHistory:Wt,getAllAccountBalances:Ve,getApiConfig:Je,getCachedOpcodeConfig:rr,getGameDetail:Yt,getGameHistory:He,getGameList:Kt,getInfo:je,getProviderIdFromGameId:Jt,getProviderName:Xt,getUserBalance:qt,getUserBalanceWithConfig:Ke,investApi:Qe,launchGame:Ht,md5Hash:zt,validateApiResponse:Ye,withdrawBalance:Gt,withdrawFromAccount:We},Symbol.toStringTag,{value:"Module"})),sr=p.createContext(null);function Ca(){const e=p.useContext(sr);if(!e)throw new Error("useBalance must be used within BalanceProvider");return e}function Da({user:e,children:r}){const[a,n]=p.useState(0),[d,m]=p.useState(!1),[l,s]=p.useState(null),[i,o]=p.useState(null),u=p.useRef(!1);p.useCallback(async()=>{if(e?.id){console.log("💾 [Balance] DB에서 초기 보유금 로드:",{partner_id:e.id,nickname:e.nickname,level:e.level});try{const{data:N,error:w}=await j.from("partners").select("balance").eq("id",e.id).single();if(w){console.error("❌ [Balance] DB 조회 실패:",w),s(w.message);return}const y=N?.balance||0;console.log("✅ [Balance] DB 로드 완료:",y),n(y),o(new Date),s(null)}catch(N){console.error("❌ [Balance] DB 조회 오류:",N),s(N.message||"DB 조회 오류")}}},[e]);const x=p.useCallback(async()=>{if(!e?.id)return;let N,w,y;try{const{getAdminOpcode:h,isMultipleOpcode:c}=await P(async()=>{const{getAdminOpcode:k,isMultipleOpcode:v}=await Promise.resolve().then(()=>Ma);return{getAdminOpcode:k,isMultipleOpcode:v}},void 0);console.log("🔍 [Balance] 상위 대본사 opcode 조회 시작");const g=await h(e);if(c(g)){if(g.opcodes.length===0){const k="사용 가능한 OPCODE가 없습니다. 시스템 관리자에게 문의하세요.";throw new Error(k)}N=g.opcodes[0].opcode,w=g.opcodes[0].secretKey,y=g.opcodes[0].token,console.log("✅ [Balance] 시스템관리자 - 첫 번째 opcode 사용:",N)}else N=g.opcode,w=g.secretKey,y=g.token,console.log("✅ [Balance] 상위 대본사 opcode 조회 성공:",N)}catch(h){console.error("❌ [Balance] opcode 조회 실패:",h);const c=`상위 대본사 API 설정 조회 실패: ${h.message}`;s(c),D.error(c,{duration:5e3});return}if(u.current){console.log("⏳ [Balance] 이미 동기화 중...");return}u.current=!0,m(!0);try{const h=e.level===1||e.level===2,c=h?"/api/info":"/api/account/balance";console.log(`📡 [Balance] API ${c} 호출 시작:`,{partner_id:e.id,level:e.level,opcode:N});const g=Date.now();let k;if(h)k=await je(N,w);else{const{getAllAccountBalances:S}=await P(async()=>{const{getAllAccountBalances:E}=await Promise.resolve().then(()=>Ia);return{getAllAccountBalances:E}},void 0);k=await S(N,w)}const v=Date.now()-g;if(await j.from("api_sync_logs").insert({opcode:N,api_endpoint:c,sync_type:"manual_balance_sync",status:k.error?"failed":"success",request_data:{opcode:N,partner_id:e.id,partner_nickname:e.nickname},response_data:k.error?{error:k.error}:k.data,duration_ms:v,error_message:k.error||null}),k.error){console.error("❌ [Balance] API 호출 실패:",k.error),s(k.error),D.error(`API 동기화 실패: ${k.error}`);return}const A=k.data;let _=0;if(console.log("📊 [Balance] API 응답:",JSON.stringify(A,null,2)),h){if(A){if(typeof A=="object"&&!A.is_text)A.RESULT===!0&&A.DATA?_=parseFloat(A.DATA.balance||0):A.balance!==void 0&&(_=parseFloat(A.balance||0));else if(A.is_text&&A.text_response){const S=A.text_response.match(/balance["'\s:]+(\\d+\\.?\\d*)/i);S&&(_=parseFloat(S[1]))}}}else if(A&&typeof A=="object"&&!A.is_text)if(A.RESULT===!0&&Array.isArray(A.DATA)){const S=A.DATA.find(E=>E.username===e.nickname);if(S)_=parseFloat(S.balance||0),console.log("✅ [Balance] API 응답에서 username 찾음:",{username:e.nickname,balance:_});else{console.log("⚠️ [Balance] API 응답에 username 없음 - DB에서 현재 보유금 조회:",{username:e.nickname,total_records:A.DATA.length});const{data:E}=await j.from("partners").select("balance").eq("id",e.id).single();if(E){const C=E.balance||0;n(C),o(new Date),console.log("✅ [Balance] DB에서 현재 보유금 조회 완료:",C)}return}}else A.balance!==void 0&&(_=parseFloat(A.balance||0));console.log("💰 [Balance] 파싱된 보유금:",_);const{error:f}=await j.from("partners").update({balance:_,updated_at:new Date().toISOString()}).eq("id",e.id);if(f)console.error("❌ [Balance] DB 업데이트 실패:",f),s(f.message),D.error("보유금 업데이트 실패");else{console.log("✅ [Balance] DB 업데이트 완료");const S=a;S!==_&&await j.from("partner_balance_logs").insert({partner_id:e.id,balance_before:S,balance_after:_,amount:_-S,transaction_type:"admin_adjustment",processed_by:e.id,memo:`API ${c} 동기화`}),n(_),o(new Date),s(null),console.log("✅ [Balance] 화면 업데이트 완료:",_),D.success(`보유금 동기화 완료: ₩${_.toLocaleString()}`)}}catch(h){console.error("❌ [Balance] API 동기화 오류:",h),s(h.message||"API 동기화 오류"),D.error(`동기화 오류: ${h.message}`)}finally{u.current=!1,m(!1)}},[e,a]),b=p.useCallback(async()=>{e?.id&&await x()},[e,x]);return p.useEffect(()=>{e?.id&&(console.log("🔄 [Balance] 초기화:",{partner_id:e.id,nickname:e.nickname,level:e.level,has_opcode:!!e.opcode,has_secret_key:!!e.secret_key}),console.log("📡 [Balance] 로그인 시 자동 동기화 시작 (상위 대본사 opcode 사용)"),x())},[e?.id]),p.useEffect(()=>{if(!e?.id)return;console.log("🔔 [Balance] Realtime 구독 시작:",e.id);const N=j.channel(`partner_balance_${e.id}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"partners",filter:`id=eq.${e.id}`},w=>{const y=parseFloat(w.new?.balance)||0,h=parseFloat(w.old?.balance)||0;if(console.log("💰 [Balance] Realtime 업데이트 감지:",{old:h,new:y,change:y-h}),n(y),o(new Date),s(null),h!==0&&Math.abs(y-h)>.01){const c=y-h,g=c>0?`+₩${c.toLocaleString()}`:`-₩${Math.abs(c).toLocaleString()}`;D.info(`보유금 변경: ${g} (현재: ₩${y.toLocaleString()})`)}}).subscribe();return()=>{console.log("🔕 [Balance] Realtime 구독 해제:",e.id),j.removeChannel(N)}},[e?.id]),t.jsx(sr.Provider,{value:{balance:a,loading:d,error:l,lastSyncTime:i,syncBalance:b},children:r})}function Ta({user:e,wsConnected:r,onToggleSidebar:a,onRouteChange:n,currentRoute:d}){const{logout:m}=ve(),{balance:l,loading:s,error:i,lastSyncTime:o}=Ca();if(!e)return t.jsx("div",{className:"w-full px-6 py-3.5 h-[72px] flex items-center border-b border-slate-200 bg-white/95",children:t.jsx("div",{className:"flex items-center justify-between w-full",children:t.jsx("div",{className:"flex items-center gap-4",children:t.jsx("span",{className:"text-sm text-muted-foreground",children:"로딩 중..."})})})});const[u,x]=p.useState({total_users:0,total_balance:0,daily_deposit:0,daily_withdrawal:0,daily_net_deposit:0,casino_betting:0,slot_betting:0,total_betting:0,online_users:0,pending_approvals:0,pending_messages:0,pending_deposits:0,pending_withdrawals:0}),[b,N]=p.useState(0);p.useEffect(()=>{const g=async()=>{try{console.log("📊 헤더 통계 조회 시작 (계층 필터링):",{id:e.id,level:e.level});const _=new Date,f=540*60*1e3,S=new Date(_.getTime()+f),E=new Date(S.getFullYear(),S.getMonth(),S.getDate()),C=new Date(E.getTime()-f).toISOString();let I=[];if(e.level===1){const{data:L}=await j.from("users").select("id");I=L?.map(q=>q.id)||[],console.log("🔑 [시스템관리자] 전체 사용자 조회:",I.length)}else{const{data:L,error:q}=await j.rpc("get_hierarchical_partners",{p_partner_id:e.id});q&&console.error("❌ 하위 파트너 조회 실패:",q);const st=[e.id,...L?.map(ee=>ee.id)||[]];console.log("🔑 [조회 대상 파트너] 총",st.length,"개:",{자신:e.id,하위파트너수:L?.length||0});const{data:he,error:nt}=await j.from("users").select("id, username, referrer_id").in("referrer_id",st);if(nt&&console.error("❌ 소속 사용자 조회 실패:",nt),I=he?.map(ee=>ee.id)||[],console.log("🔑 [소속 사용자] 총",I.length,"명",I.length===0?"(정상: 아직 사용자가 없음)":""),he&&he.length>0){const ee=he.reduce((Ne,ot)=>(Ne[ot.referrer_id]=(Ne[ot.referrer_id]||0)+1,Ne),{});console.log("📊 [파트너별 사용자 분포]:",ee)}}if(I.length===0){console.log("ℹ️ 소속된 사용자가 없습니다. 0으로 통계를 초기화합니다."),x(L=>({...L,daily_deposit:0,daily_withdrawal:0,daily_net_deposit:0,online_users:0,pending_approvals:0,pending_messages:0,pending_deposits:0,pending_withdrawals:0})),N(0);return}const{data:T,error:B}=await j.from("transactions").select("amount").in("transaction_type",["deposit","admin_deposit"]).eq("status","completed").gte("created_at",C).in("user_id",I);B&&console.error("❌ 입금 조회 실패:",B);const $=T?.reduce((L,q)=>L+Number(q.amount),0)||0,{data:V,error:Z}=await j.from("transactions").select("amount").in("transaction_type",["withdrawal","admin_withdrawal"]).eq("status","completed").gte("created_at",C).in("user_id",I);Z&&console.error("❌ 출금 조회 실패:",Z);const X=V?.reduce((L,q)=>L+Number(q.amount),0)||0,{count:pe}=await j.from("users").select("id",{count:"exact",head:!0}).eq("is_online",!0).in("id",I),fe=I.length,{count:ge}=await j.from("users").select("id",{count:"exact",head:!0}).eq("status","pending").in("id",I),{count:et}=await j.from("messages").select("id",{count:"exact",head:!0}).in("status",["unread","read"]).eq("message_type","normal").eq("receiver_type","partner").is("parent_id",null),{count:tt}=await j.from("transactions").select("id",{count:"exact",head:!0}).eq("transaction_type","deposit").eq("status","pending").in("user_id",I),{count:rt}=await j.from("transactions").select("id",{count:"exact",head:!0}).eq("transaction_type","withdrawal").eq("status","pending").in("user_id",I),{data:cr}=await j.from("users").select("balance").in("id",I),at=cr?.reduce((L,q)=>L+Number(q.balance||0),0)||0;console.log("💰 헤더 입출금 (계층 필터링):",{총잔고:at,입금:$,출금:X,순입출금:$-X,온라인:pe||0,전체회원:fe||0,소속사용자수:I.length}),console.log("🔔 헤더 실시간 알림 (직접 계산):",{가입승인:ge||0,고객문의:et||0,입금요청:tt||0,출금요청:rt||0}),x(L=>({...L,total_balance:at,daily_deposit:$,daily_withdrawal:X,daily_net_deposit:$-X,online_users:pe||0,pending_approvals:ge||0,pending_messages:et||0,pending_deposits:tt||0,pending_withdrawals:rt||0})),N(fe||0),console.log("✅ 헤더 통계 업데이트 완료 (계층 필터링 적용)")}catch(_){console.error("❌ 헤더 통계 로드 실패:",_)}};g(),console.log("🔔 헤더 Realtime 구독 시작:",e.id);const k=j.channel("header_transactions").on("postgres_changes",{event:"*",schema:"public",table:"transactions"},_=>{if(console.log("💰 [헤더 알림] transactions 변경 감지:",_.eventType),g(),_.eventType==="INSERT"&&_.new){const f=_.new;f.status==="pending"&&(f.transaction_type==="deposit"?D.info("새로운 입금 요청이 있습니다.",{description:`금액: ₩${Number(f.amount).toLocaleString()} | 회원: ${f.user_id}`,duration:1e4,action:{label:"확인",onClick:()=>{n&&n("/admin/transactions#deposit-request")}}}):f.transaction_type==="withdrawal"&&D.warning("새로운 출금 요청이 있습니다.",{description:`금액: ₩${Number(f.amount).toLocaleString()} | 회원: ${f.user_id}`,duration:1e4,action:{label:"확인",onClick:()=>{n&&n("/admin/transactions#withdrawal-request")}}}))}}).subscribe(),v=j.channel("header_users").on("postgres_changes",{event:"*",schema:"public",table:"users"},_=>{console.log("🔔 [헤더 알림] users 변경 감지 (가입승인):",_.eventType),g(),_.eventType==="INSERT"&&_.new&&_.new.status==="pending"&&D.info("새로운 가입 신청이 있습니다.",{description:`회원 아이디: ${_.new.username}`,duration:8e3})}).subscribe(),A=j.channel("header_messages").on("postgres_changes",{event:"*",schema:"public",table:"messages"},_=>{if(console.log("🔔 [헤더 알림] messages 변경 감지 (고객문의):",_.eventType),g(),_.eventType==="INSERT"&&_.new){const f=_.new;f.message_type==="normal"&&f.sender_type==="user"&&f.receiver_type==="partner"&&!f.parent_id&&D.info("새로운 고객 문의가 있습니다.",{description:`제목: ${f.subject||"문의"}`,duration:8e3,action:{label:"확인",onClick:()=>{n&&n("/admin/customer-service")}}})}}).subscribe();return()=>{console.log("🔕 헤더 Realtime 구독 해제"),j.removeChannel(k),j.removeChannel(v),j.removeChannel(A)}},[e.id]);const[w,y]=p.useState({all_betting:0,large_betting:0,high_win:0,suspicious:0});p.useEffect(()=>{const g=j.channel("betting_alerts").on("postgres_changes",{event:"INSERT",schema:"public",table:"game_records"},k=>{const v=k.new;y(_=>({..._,all_betting:_.all_betting+1})),v.bet_amount&&parseFloat(v.bet_amount)>=1e5&&(y(_=>({..._,large_betting:_.large_betting+1})),D.warning(`대량 베팅 발생: ${te(parseFloat(v.bet_amount))}`,{duration:5e3,action:{label:"확인",onClick:()=>{n&&n("/admin/online-users")}}})),v.win_amount&&parseFloat(v.win_amount)>=5e5&&(y(_=>({..._,high_win:_.high_win+1})),D.info(`고액 당첨 발생: ${te(parseFloat(v.win_amount))}`,{duration:5e3,action:{label:"확인",onClick:()=>{n&&n("/admin/online-users")}}}));const A=v.win_amount&&v.bet_amount?parseFloat(v.win_amount)/parseFloat(v.bet_amount):0;A>10&&(y(_=>({..._,suspicious:_.suspicious+1})),D.error(`의심 패턴 감지: 승률 ${(A*100).toFixed(0)}%`,{duration:5e3,action:{label:"확인",onClick:()=>{n&&n("/admin/online-users")}}}))}).subscribe();return()=>{j.removeChannel(g)}},[n]);const h=()=>{m(),D.success("로그아웃되었습니다.")},c=()=>{n&&(n("/admin/online-users"),y({all_betting:0,large_betting:0,high_win:0,suspicious:0}),D.info("온라인 사용자 현황 페이지로 이동합니다."))};return t.jsx("div",{className:"w-full border-b border-slate-800/50 bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900",children:t.jsx("div",{className:"px-6 py-3",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:`px-3 py-1.5 rounded-lg bg-gradient-to-br from-purple-500/20 to-violet-500/20 border border-purple-500/30 hover:scale-102 transition-all ${s?"animate-pulse":""}`,children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Dt,{className:"h-4 w-4 text-purple-400"}),t.jsxs("div",{children:[t.jsx("div",{className:"text-[9px] text-purple-300 font-medium",children:"보유금"}),t.jsx("div",{className:"text-sm font-bold text-white",children:s?"...":te(l||0)})]})]})}),t.jsx("div",{className:"px-3 py-1.5 rounded-lg bg-gradient-to-br from-cyan-500/20 to-blue-500/20 border border-cyan-500/30 hover:scale-102 transition-all cursor-pointer",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(ne,{className:"h-4 w-4 text-cyan-400"}),t.jsxs("div",{children:[t.jsx("div",{className:"text-[9px] text-cyan-300 font-medium",children:"총 입금"}),t.jsx("div",{className:"text-sm font-bold text-white",children:te(u.daily_deposit)})]})]})}),t.jsx("div",{className:"px-3 py-1.5 rounded-lg bg-gradient-to-br from-orange-500/20 to-red-500/20 border border-orange-500/30 hover:scale-102 transition-all cursor-pointer",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Zr,{className:"h-4 w-4 text-orange-400"}),t.jsxs("div",{children:[t.jsx("div",{className:"text-[9px] text-orange-300 font-medium",children:"총 출금"}),t.jsx("div",{className:"text-sm font-bold text-white",children:te(u.daily_withdrawal)})]})]})}),t.jsx("div",{className:"px-3 py-1.5 rounded-lg bg-gradient-to-br from-slate-500/20 to-gray-500/20 border border-slate-500/30 hover:scale-102 transition-all cursor-pointer",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(de,{className:"h-4 w-4 text-slate-400"}),t.jsxs("div",{children:[t.jsx("div",{className:"text-[9px] text-slate-300 font-medium",children:"총 회원"}),t.jsx("div",{className:"text-sm font-bold text-white",children:ft(b)})]})]})}),t.jsx("div",{className:"px-3 py-1.5 rounded-lg bg-gradient-to-br from-emerald-500/20 to-teal-500/20 border border-emerald-500/30 hover:scale-102 transition-all cursor-pointer",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(de,{className:"h-4 w-4 text-emerald-400"}),t.jsxs("div",{children:[t.jsx("div",{className:"text-[9px] text-emerald-300 font-medium",children:"온라인"}),t.jsxs("div",{className:"text-sm font-bold text-white",children:[ft(u.online_users),"명"]})]})]})})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(H,{children:t.jsxs(re,{children:[t.jsx(ae,{asChild:!0,children:t.jsxs("div",{className:"px-2 py-1.5 rounded-lg bg-gradient-to-br from-cyan-500/20 to-blue-500/20 border border-cyan-500/30 hover:scale-105 transition-all cursor-pointer min-w-[60px]",onClick:()=>n?.("/admin/users"),children:[t.jsx("div",{className:"text-[9px] text-cyan-300 font-medium text-center",children:"가입승인"}),t.jsx("div",{className:"text-base font-bold text-white text-center",children:u.pending_approvals})]})}),t.jsx(se,{children:"가입승인 대기 중"})]})}),t.jsx(H,{children:t.jsxs(re,{children:[t.jsx(ae,{asChild:!0,children:t.jsxs("div",{className:"px-2 py-1.5 rounded-lg bg-gradient-to-br from-purple-500/20 to-pink-500/20 border border-purple-500/30 hover:scale-105 transition-all cursor-pointer min-w-[60px]",onClick:()=>n?.("/admin/customer-service"),children:[t.jsx("div",{className:"text-[9px] text-purple-300 font-medium text-center",children:"고객문의"}),t.jsx("div",{className:"text-base font-bold text-white text-center",children:u.pending_messages})]})}),t.jsx(se,{children:"고객문의 대기 중"})]})}),t.jsx(H,{children:t.jsxs(re,{children:[t.jsx(ae,{asChild:!0,children:t.jsxs("div",{className:"px-2 py-1.5 rounded-lg bg-gradient-to-br from-emerald-500/20 to-teal-500/20 border border-emerald-500/30 hover:scale-105 transition-all cursor-pointer min-w-[60px]",onClick:()=>n?.("/admin/transactions#deposit-request"),children:[t.jsx("div",{className:"text-[9px] text-emerald-300 font-medium text-center",children:"입금요청"}),t.jsx("div",{className:"text-base font-bold text-white text-center",children:u.pending_deposits})]})}),t.jsx(se,{children:"입금요청 대기 중"})]})}),t.jsx(H,{children:t.jsxs(re,{children:[t.jsx(ae,{asChild:!0,children:t.jsxs("div",{className:"px-2 py-1.5 rounded-lg bg-gradient-to-br from-orange-500/20 to-red-500/20 border border-orange-500/30 hover:scale-105 transition-all cursor-pointer min-w-[60px]",onClick:()=>n?.("/admin/transactions#withdrawal-request"),children:[t.jsx("div",{className:"text-[9px] text-orange-300 font-medium text-center",children:"출금요청"}),t.jsx("div",{className:"text-base font-bold text-white text-center",children:u.pending_withdrawals})]})}),t.jsx(se,{children:"출금요청 대기 중"})]})}),t.jsx("div",{className:"w-px h-8 bg-slate-700"}),t.jsx(H,{children:t.jsxs(re,{children:[t.jsx(ae,{asChild:!0,children:t.jsxs(U,{variant:"ghost",size:"sm",className:"relative h-9 w-9 p-0 hover:bg-slate-700",onClick:c,children:[t.jsx(Be,{className:"h-5 w-5 text-slate-300"}),w.large_betting+w.high_win+w.suspicious>0&&t.jsx(Rt,{className:"absolute -top-1 -right-1 h-5 min-w-[20px] px-1 rounded-full text-[10px] bg-rose-500 hover:bg-rose-600 animate-pulse border-0",children:w.large_betting+w.high_win+w.suspicious>99?"99+":w.large_betting+w.high_win+w.suspicious})]})}),t.jsx(se,{children:t.jsxs("div",{className:"space-y-1 text-xs",children:[t.jsxs("p",{children:["고배팅: ",w.large_betting,"건"]}),t.jsxs("p",{children:["고당첨: ",w.high_win,"건"]}),t.jsxs("p",{children:["의심패턴: ",w.suspicious,"건"]})]})})]})}),t.jsx("div",{className:"w-px h-8 bg-slate-700"}),t.jsxs(Lt,{children:[t.jsx(Fe,{asChild:!0,children:t.jsx(U,{variant:"ghost",size:"sm",className:"h-9 w-9 p-0 rounded-full hover:bg-slate-700",children:t.jsx(Na,{className:"h-8 w-8",children:t.jsx(Sa,{className:"bg-gradient-to-br from-cyan-500 to-blue-500 text-white font-semibold text-sm",children:e.nickname.charAt(0).toUpperCase()})})})}),t.jsxs(Ut,{align:"end",className:"w-48 bg-slate-800 border-slate-700",children:[t.jsxs("div",{className:"px-2 py-2 border-b border-slate-700",children:[t.jsx("p",{className:"text-sm font-semibold text-slate-100",children:e.nickname}),t.jsx("p",{className:"text-xs text-slate-400",children:e.username}),t.jsx("p",{className:"text-xs text-slate-500 mt-0.5",children:"관리자 계정"})]}),t.jsxs(ie,{onClick:h,className:"text-rose-400 cursor-pointer hover:bg-slate-700",children:[t.jsx(Te,{className:"h-4 w-4 mr-2"}),"로그아웃"]})]})]})]})]})})})}const Oa=`https://${$t}.supabase.co`,Pa="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56dXp6bWFpdXlienluZHB0YWJhIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1OTIwMzk0MywiZXhwIjoyMDc0Nzc5OTQzfQ.ITQXw1UhEdqMvTNcWFi1WJVO4npUDCCG7G96EkjQMhI";let Ie=null;const Ce={},Ba=()=>(Ie||(Ie=Pt(Oa,Pa,{auth:{persistSession:!1,autoRefreshToken:!1,detectSessionInUrl:!1,storageKey:"sb-admin-service-role-key",storage:{getItem:e=>Ce[e]||null,setItem:(e,r)=>{Ce[e]=r},removeItem:e=>{delete Ce[e]}}},db:{schema:"public"},global:{headers:{"X-Client-Info":"gms-service-role-admin"}}})),Ie),$a=Ba();async function ue(e){if(console.log("🔍 getAdminOpcode 호출:",{id:e.id,username:e.username,partner_type:e.partner_type,level:e.level,opcode:e.opcode,has_opcode:!!e.opcode,has_secret_key:!!e.secret_key,has_token:!!e.token,has_api_token:!!e.api_token}),e.partner_type==="system_admin"){const l=[],s=e.token||e.api_token;e.opcode&&e.secret_key&&s?(l.push({opcode:e.opcode,secretKey:e.secret_key,token:s,partnerId:e.id,partnerName:e.name||e.nickname||"시스템관리자"}),console.log("✅ 시스템관리자 본인 OPCODE 추가:",e.opcode)):console.warn("⚠️ 시스템관리자 OPCODE 정보 불완전:",{opcode:e.opcode,secret_key:e.secret_key?"***":null,token:s?"***":null});let i=null,o=null;try{const u=await j.from("partners").select("id, username, nickname, opcode, secret_key, api_token").eq("partner_type","head_office").not("opcode","is",null).not("secret_key","is",null).not("api_token","is",null);i=u.data,o=u.error,o&&console.error("❌ 대본사 OPCODE 조회 오류:",{message:o.message,details:o.details,hint:o.hint,code:o.code})}catch(u){console.error("❌ ❌ 대본사 OPCODE 조회 오류:",{message:u.message||String(u),stack:u.stack,type:u.constructor.name})}if(i&&i.length>0&&(i.forEach(u=>{l.push({opcode:u.opcode,secretKey:u.secret_key,token:u.api_token,partnerId:u.id,partnerName:u.nickname||u.username||`대본사-${u.id.slice(0,8)}`})}),console.log(`✅ 대본사 OPCODE ${i.length}개 추가`)),l.length===0)throw new Error("사용 가능한 OPCODE가 없습니다. 시스템관리자 또는 대본사에 OPCODE를 설정해주세요.");return console.log(`📊 시스템관리자 총 ${l.length}개 OPCODE 사용 가능`),{opcodes:l,isSystemAdmin:!0}}if(e.partner_type==="head_office"){const l=e.token||e.api_token;if(!e.opcode||!e.secret_key||!l)throw new Error("대본사 계정에 OPCODE/Token이 설정되지 않았습니다.");return console.log("✅ 대본사 OPCODE 조회:",e.opcode),{opcode:e.opcode,secretKey:e.secret_key,token:l,partnerId:e.id,partnerName:e.nickname||e.username||"내 조직"}}const r=e.parent_chain||[];if(r.length===0){if(console.log("🔍 parent_chain 없음, parent_id로 대본사 찾기 시작:",{admin_id:e.id,admin_username:e.username,admin_type:e.partner_type,parent_id:e.parent_id}),!e.parent_id)throw new Error(`${e.partner_type}는 상위 파트너가 필요합니다. parent_id가 설정되지 않았습니다.`);let l=e.parent_id,s=0;const i=10;for(;l&&s<i;){console.log(`🔍 [시도 ${s+1}] 파트너 조회:`,l);const{data:o,error:u}=await j.from("partners").select("id, nickname, username, partner_type, level, opcode, secret_key, api_token, parent_id").eq("id",l).single();if(console.log(`📊 [시도 ${s+1}] 조회 결과:`,{found:!!o,error:u?.message,partner_type:o?.partner_type,level:o?.level,has_opcode:!!o?.opcode,has_secret_key:!!o?.secret_key,has_api_token:!!o?.api_token,parent_id:o?.parent_id}),u)throw console.error("❌ 상위 파트너 조회 DB 오류:",u),new Error(`상위 파트너 조회 실패: ${u.message}`);if(!o)throw new Error(`상위 파트너를 찾을 수 없습니다 (ID: ${l})`);if(o.partner_type==="head_office"){const x=o.api_token;if(!o.opcode||!o.secret_key||!x)throw console.error("❌ 대본사 OPCODE 정보 부족:",{partner_id:o.id,username:o.username,has_opcode:!!o.opcode,has_secret_key:!!o.secret_key,has_api_token:!!x}),new Error(`상위 대본사(${o.username})에 OPCODE/Token이 설정되지 않았습니다.`);return console.log("✅ 상위 대본사 OPCODE 조회 성공:",{partner_id:o.id,username:o.username,opcode:o.opcode}),{opcode:o.opcode,secretKey:o.secret_key,token:x,partnerId:o.id,partnerName:o.nickname||o.username||"상위 대본사"}}console.log(`⬆️ [시도 ${s+1}] ${o.partner_type}는 대본사 아님, 상위로 이동`),l=o.parent_id||null,s++}throw s>=i?new Error("상위 대본사 조회 시도 횟수 초과 (최대 10회)"):new Error("상위 대본사를 찾을 수 없습니다. 파트너 계층 구조를 확인해주세요.")}const a=r[0],{data:n,error:d}=await j.from("partners").select("id, nickname, opcode, secret_key, api_token").eq("id",a).single();if(d||!n)throw console.error("상위 대본사 조회 오류:",d),new Error("상위 대본사 정보를 찾을 수 없습니다.");const m=n.api_token;if(!n.opcode||!n.secret_key||!m)throw new Error("상위 대본사에 OPCODE/Token이 설정되지 않았습니다.");return console.log("✅ 상위 대본사 OPCODE 조회 (parent_chain):",n.opcode),{opcode:n.opcode,secretKey:n.secret_key,token:m,partnerId:n.id,partnerName:n.nickname||"상위 대본사"}}function me(e){return"opcodes"in e&&"isSystemAdmin"in e}const Ma=Object.freeze(Object.defineProperty({__proto__:null,getAdminOpcode:ue,isMultipleOpcode:me},Symbol.toStringTag,{value:"Module"})),Oe=async e=>{try{console.log("🔍 [SESSION-AUTO-END] 비활성 세션 확인 시작");const r=new Date(Date.now()-6e4).toISOString(),{data:a,error:n}=await $a.from("game_launch_sessions").update({status:"auto_ended",ended_at:new Date().toISOString()}).eq("status","active").lt("last_activity_at",r).select("id, user_id, session_id, last_activity_at");if(n){console.error("❌ [SESSION-AUTO-END] 오류:",n);return}if(a&&a.length>0){console.log(`🔄 [SESSION-AUTO-END] ${a.length}개 세션 auto_ended`);for(const o of a)console.log(`   📍 세션 ID: ${o.session_id}, User: ${o.user_id}, 마지막 활동: ${o.last_activity_at}`),await La(o.user_id,e)}else console.log("✅ [SESSION-AUTO-END] 종료할 비활성 세션 없음");return}catch(r){console.error("❌ [SESSION-CHECK] 무활동 세션 확인 오류:",r)}},ye=async(e,r,a,n,d)=>{try{console.log(`📡 [BETTING-SYNC] OPCODE ${e} 처리 시작`);const{data:m}=await j.from("game_records").select("external_txid").eq("partner_id",a).order("external_txid",{ascending:!1}).limit(1).single(),l=m?.external_txid||0;console.log(`📍 [BETTING-SYNC] OPCODE ${e} 마지막 id (index): ${l}`);const s=await He(e,n,d,l,4e3,r);if(s.error||!s.data){console.log(`⚠️ [BETTING-SYNC] OPCODE ${e} API 실패`);return}let i=[];if(s.data.DATA&&Array.isArray(s.data.DATA)?i=s.data.DATA:Array.isArray(s.data)&&(i=s.data),i.length===0){console.log(`ℹ️ [BETTING-SYNC] OPCODE ${e} 새로운 데이터 없음`);return}if(console.log(`📊 [BETTING-SYNC] OPCODE ${e}: ${i.length}건 (id ${l} 이후)`),i.length>0){const c=i.map(v=>typeof v.id=="number"?v.id:parseInt(v.id||"0",10)),g=Math.max(...c),k=Math.min(...c);console.log(`   📍 id 범위: ${k} ~ ${g} (unique 값)`)}const{data:o}=await j.from("users").select("id, username, referrer_id"),u=new Map;o&&o.forEach(c=>{u.set(c.username,{id:c.id,referrer_id:c.referrer_id})}),console.log(`   👥 전체 회원 수: ${u.size}명`);let x=0,b=0;const N=[...i].sort((c,g)=>{const k=typeof c.id=="number"?c.id:parseInt(c.id||"0",10);return(typeof g.id=="number"?g.id:parseInt(g.id||"0",10))-k});let w=0,y=0,h=0;for(const c of N)try{const g=c.username;if(!g){w++;continue}const k=u.get(g);if(!k){y++;continue}const v=c.id;if(!v){h++;continue}const A=typeof v=="number"?v:parseInt(v.toString(),10);if(isNaN(A)){h++;continue}const _=parseFloat(c.bet||c.bet_amount||"0"),f=parseFloat(c.win||c.win_amount||"0"),S=parseFloat(c.balance||c.balance_after||"0"),E=S-(f-_),I=(c.create_at||c.played_at||c.created_at||new Date().toISOString()).replace(/[+-]\d{2}:\d{2}$/,"").replace("Z",""),B=new Date(new Date(I).getTime()+540*60*1e3).toISOString().replace("Z","+09:00"),{error:$}=await j.from("game_records").insert({partner_id:a,external_txid:A,username:g,user_id:k.id,game_id:c.game_id||c.game,provider_id:c.provider_id||Math.floor((c.game_id||c.game||41e4)/1e3),game_title:c.game_title||null,provider_name:c.provider_name||null,bet_amount:_,win_amount:f,balance_before:E,balance_after:S,played_at:B});$?$.code==="23505"?b++:console.error(`   ❌ INSERT 실패 (external_txid: ${A}):`,$):x++}catch(g){console.error("   ❌ 레코드 처리 오류:",g)}if((w>0||y>0||h>0)&&console.log(`   ⚠️ 건너뛴 데이터: username 없음 ${w}건, user 매칭 실패 ${y}건, id 없음 ${h}건`),console.log(`✅ [BETTING-SYNC] OPCODE ${e} 완료: 성공 ${x}건, 중복 ${b}건`),x>0){console.log(`   💾 신규 베팅 ${x}건이 DB에 저장되었습니다.`);const{data:c,error:g}=await j.from("game_records").select("id, external_txid, username, partner_id").eq("partner_id",a).order("external_txid",{ascending:!1}).limit(3);!g&&c&&c.length>0?console.log(`   🔍 DB 확인: 최근 저장된 ${c.length}건`,c):g?console.error("   ❌ DB 확인 오류:",g):console.warn(`   ⚠️ DB에서 데이터를 찾을 수 없습니다! partner_id: ${a}`),await Oe(a)}}catch(m){console.error(`❌ [BETTING-SYNC] OPCODE ${e} 오류:`,m)}};async function en(e){const r=new Date,a=r.getFullYear().toString(),n=(r.getMonth()+1).toString();console.log("🔄 [BETTING-FORCE-SYNC] 강제 동기화 시작",{year:a,month:n});try{const d=await ue(e);if(me(d)){const m=new Map;for(const l of d.opcodes)m.has(l.opcode)||m.set(l.opcode,l);for(const[,l]of m)await ye(l.opcode,l.secretKey,l.partnerId,a,n)}else await ye(d.opcode,d.secretKey,d.partnerId,a,n);console.log("✅ [BETTING-FORCE-SYNC] 강제 동기화 완료")}catch(d){throw console.error("❌ [BETTING-FORCE-SYNC] 오류:",d),d}}function Ra({user:e}){const r=p.useRef(!1),a=p.useRef(null),n=async()=>{if(!r.current)try{r.current=!0;const d=new Date,m=d.getFullYear().toString(),l=(d.getMonth()+1).toString();console.log("🎲 [BETTING-SYNC] 시작",{year:m,month:l});const s=await ue(e);if(me(s)){const i=new Map;for(const o of s.opcodes)i.has(o.opcode)||i.set(o.opcode,o);for(const[,o]of i)await ye(o.opcode,o.secretKey,o.partnerId,m,l)}else await ye(s.opcode,s.secretKey,s.partnerId,m,l);console.log("✅ [BETTING-SYNC] 완료")}catch(d){console.error("❌ [BETTING-SYNC] 오류:",d)}finally{r.current=!1}};return p.useEffect(()=>(console.log("🎯 [BETTING-SYNC] 자동 동기화 시작"),a.current&&(clearInterval(a.current),a.current=null),n(),Oe(e.id),a.current=setInterval(()=>{console.log("⏰ [BETTING-SYNC] 30초 타이머 실행:",new Date().toISOString()),n(),Oe(e.id)},3e4),()=>{console.log("🛑 [BETTING-SYNC] 자동 동기화 중지"),a.current&&(clearInterval(a.current),a.current=null)}),[]),null}const La=async(e,r)=>{try{console.log(`🔄 [BALANCE-SYNC] 세션 종료 시 사용자 보유금 동기화 시작: user_id=${e}`);const{data:a,error:n}=await j.from("users").select("username").eq("id",e).single();if(n||!a){console.error(`❌ [BALANCE-SYNC] 사용자 정보 없음: user_id=${e}`);return}const d=await Je(r);if(!d){console.error(`❌ [BALANCE-SYNC] API 설정 정보 없음: partner_id=${r}`);return}const m=await Ke(d.opcode,a.username,d.token,d.secret_key);if(!m.success||m.balance===void 0){console.error(`❌ [BALANCE-SYNC] 사용자 보유금 조회 실패: ${m.error}`);return}const l=m.balance;console.log(`   📍 사용자 보유금: ${l}`);const{error:s}=await j.from("users").update({balance:l}).eq("id",e);s?console.error(`❌ [BALANCE-SYNC] 보유금 업데이트 실패: user_id=${e}, partner_id=${r}`,s):console.log(`✅ [BALANCE-SYNC] 보유금 업데이트 성공: user_id=${e}, partner_id=${r}`)}catch(a){console.error(`❌ [BALANCE-SYNC] 오류: user_id=${e}, partner_id=${r}`,a)}};function Ua({user:e}){const r=p.useRef(!1),a=p.useRef(0),n=p.useRef(null),d=p.useRef(!1),m=p.useRef(0),l=p.useRef(null);return p.useEffect(()=>{const s=async()=>{const o=Date.now(),u=o-m.current;if(u<25e3){console.log("⏸️ [OnlineBalanceSync] 너무 빠른 호출 방지:",{timeSinceLastSync:Math.floor(u/1e3)+"초"});return}if(d.current){console.log("⏸️ [OnlineBalanceSync] 이미 동기화 중...");return}try{d.current=!0,m.current=o,console.log("🟢 [OnlineBalanceSync] 온라인 사용자 동기화 시작:",{timestamp:new Date().toISOString()});const x=await ue(e);let b,N,w;if(me(x)){if(x.opcodes.length===0){console.error("❌ [OnlineBalanceSync] 사용 가능한 OPCODE 없음");return}b=x.opcodes[0].opcode,N=x.opcodes[0].secretKey,w=x.opcodes[0].token||""}else b=x.opcode,N=x.secretKey,w=x.token||"";const{data:y,error:h}=await j.from("users").select("id, username, balance").eq("is_online",!0);if(h){console.error("❌ [OnlineBalanceSync] 온라인 사용자 조회 실패:",h);return}if(!y||y.length===0){console.log("ℹ️ [OnlineBalanceSync] 온라인 사용자 없음");return}console.log(`📊 [OnlineBalanceSync] ${y.length}명의 온라인 사용자 발견`);let c=0,g=0;for(const k of y){const v=k.username;if(!v||!w){console.warn("⚠️ [OnlineBalanceSync] username 또는 token 없음:",{username:v});continue}try{const A=await qe(b,v,w,N);if(A.error){console.error(`❌ [OnlineBalanceSync] API 호출 실패 (${v}):`,A.error);continue}const _=A.data;let f=0;if(_){if(typeof _=="object"&&!_.is_text)_.RESULT===!0&&_.DATA?f=parseFloat(_.DATA.balance||0):_.balance!==void 0&&(f=parseFloat(_.balance||0));else if(_.is_text&&_.text_response){const I=_.text_response.match(/balance[\\"'\\s:]+(\\d+\\.?\\d*)/i);I&&(f=parseFloat(I[1]))}}const{data:S}=await j.from("users").select("balance_sync_call_count").eq("username",v).single(),C=(S?.balance_sync_call_count||0)+1;console.log(`✅ [OnlineBalanceSync] 보유금 업데이트 (${v}):`,{new_balance:f,call_count:C,will_logout:C>=60}),C>=60?(console.log(`🚪 [OnlineBalanceSync] 30분 경과 (60회 호출) - 강제 로그아웃 (${v}):`,{call_count:C,duration:"30분"}),await j.from("users").update({balance:f,is_online:!1,balance_sync_call_count:0,updated_at:new Date().toISOString()}).eq("username",v),g++):await j.from("users").update({balance:f,balance_sync_call_count:C,updated_at:new Date().toISOString()}).eq("username",v),c++}catch(A){console.error(`❌ [OnlineBalanceSync] 처리 오류 (${v}):`,A)}}console.log("✅ [OnlineBalanceSync] 온라인 사용자 동기화 완료:",{total_online:y.length,success_count:c,logout_count:g})}catch(x){console.error("❌ [OnlineBalanceSync] 동기화 오류:",x)}finally{d.current=!1}};console.log("🟢 [OnlineBalanceSync] 온라인 사용자 동기화 시작 (30초 간격, 10초 후 시작)"),l.current&&(clearInterval(l.current),l.current=null);const i=setTimeout(()=>{s(),l.current=setInterval(()=>{console.log("⏰ [OnlineBalanceSync] 30초 타이머 실행:",new Date().toISOString()),s()},3e4)},1e4);return()=>{console.log("🛑 [OnlineBalanceSync] 동기화 중지"),clearTimeout(i),l.current&&(clearInterval(l.current),l.current=null)}},[]),p.useEffect(()=>{const s=async()=>{const i=Date.now(),o=i-a.current;if(o<25e3){console.log("⏸️ [BalanceSync] 너무 빠른 호출 방지:",{timeSinceLastSync:Math.floor(o/1e3)+"초"});return}if(r.current){console.log("⏸️ [BalanceSync] 이미 동기화 중...");return}try{r.current=!0,a.current=i,console.log("🔄 [BalanceSync] 자동 동기화 시작:",{partner_id:e.id,username:e.username,level:e.level,timestamp:new Date().toISOString()});const u=await ue(e);let x,b,N;if(me(u)){if(u.opcodes.length===0){console.error("❌ [BalanceSync] 사용 가능한 OPCODE 없음");return}x=u.opcodes[0].opcode,b=u.opcodes[0].secretKey,N=u.opcodes[0].partnerId}else x=u.opcode,b=u.secretKey,N=u.partnerId;if(e.level===1){console.log("📡 [BalanceSync] GET /api/info 호출 (level 1)");const y=await je(x,b);if(y.error){console.error("❌ [BalanceSync] API 호출 실패:",y.error);return}const h=y.data;let c=0;if(h){if(typeof h=="object"&&!h.is_text)h.RESULT===!0&&h.DATA?c=parseFloat(h.DATA.balance||0):h.balance!==void 0&&(c=parseFloat(h.balance||0));else if(h.is_text&&h.text_response){const g=h.text_response.match(/balance[\"'\s:]+(\\d+\\.?\\d*)/i);g&&(c=parseFloat(g[1]))}}await j.from("partners").update({balance:c,updated_at:new Date().toISOString()}).eq("id",N),console.log("✅ [BalanceSync] 보유금 동기화 완료:",{partner_id:N,new_balance:c})}else{console.log("📡 [BalanceSync] PATCH /api/account/balance 호출 (level 2~7)");const y=await Ve(x,b);if(y.error){console.error("❌ [BalanceSync] API 호출 실패:",y.error);return}const h=y.data;let c=[];if(h&&typeof h=="object"&&!h.is_text&&(h.RESULT===!0&&h.DATA&&Array.isArray(h.DATA)?c=h.DATA:Array.isArray(h)&&(c=h)),c.length===0){console.log("ℹ️ [BalanceSync] 업데이트할 잔고 데이터 없음");return}console.log(`📊 [BalanceSync] ${c.length}건의 잔고 정보 수신`);let g=0,k=0,v=0;for(const A of c){const _=A.username||A.user_id||A.id,f=parseFloat(A.balance||A.amount||0);if(!_||_===""){v++;continue}const{data:S,error:E}=await j.from("users").update({balance:f,updated_at:new Date().toISOString()}).eq("username",_).select("id");!E&&S&&S.length>0&&g++;const{data:C,error:I}=await j.from("partners").update({balance:f,updated_at:new Date().toISOString()}).eq("username",_).select("id");!I&&C&&C.length>0&&k++}console.log("✅ [BalanceSync] 잔고 동기화 완료:",{total_records:c.length,users_updated:g,partners_updated:k,skipped_no_username:v})}}catch(u){console.error("❌ [BalanceSync] 동기화 오류:",u)}finally{r.current=!1}};return console.log("🎯 [BalanceSync] 자동 동기화 시작 (30초 간격):",{partner_id:e.id,username:e.username,timestamp:new Date().toISOString()}),n.current&&(clearInterval(n.current),n.current=null),s(),n.current=setInterval(()=>{console.log("⏰ [BalanceSync] 30초 타이머 실행:",new Date().toISOString()),s()},3e4),()=>{console.log("🛑 [BalanceSync] 자동 동기화 중지:",{partner_id:e.id,timestamp:new Date().toISOString()}),n.current&&(clearInterval(n.current),n.current=null)}},[]),null}function za({children:e}){const r=ua();return t.jsx(Mt.Provider,{value:r,children:e})}const nr=p.createContext(null);function Ze(){const e=p.useContext(nr);if(!e)throw new Error("useWebSocketContext must be used within a WebSocketProvider");return e}const ht=be.memo(({children:e})=>{const r=p.useRef(null),a=p.useRef(),n=p.useRef(),d=p.useRef(),m=p.useRef(0),l=999,s=p.useRef(!1),i=p.useRef(!0),o=p.useRef(new Set),u=3e4,[x,b]=p.useState(!1),[N,w]=p.useState([]),[y,h]=p.useState(null),[c,g]=p.useState("disconnected"),k=p.useCallback(()=>{i.current&&(n.current&&clearTimeout(n.current),n.current=window.setTimeout(()=>{if(i.current)if(r.current?.readyState===WebSocket.OPEN)try{r.current.send(JSON.stringify({type:"ping",timestamp:new Date().toISOString()})),console.log("💓 Heartbeat ping 전송"),k()}catch(E){console.error("❌ Heartbeat 전송 실패:",E),i.current&&A()}else console.log("🔄 Heartbeat 체크: 연결 끊김 감지"),i.current&&A()},u))},[]),v=p.useCallback(()=>{n.current&&(clearTimeout(n.current),n.current=void 0)},[]),A=p.useCallback(()=>{if(i.current){if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"){console.log("🔧 로컬 개발 환경 - WebSocket 오프라인 모드 (모든 기능 정상 작동)"),g("disconnected"),b(!1);return}if(!(s.current||r.current?.readyState===WebSocket.OPEN)){if(m.current>=l){console.warn("WebSocket 최대 재연결 시도 초과"),g("disconnected");return}s.current=!0,g("connecting"),d.current&&clearTimeout(d.current),r.current&&(r.current.close(),r.current=null);try{const E="wss://vi8282.com/ws";console.log("🔌 WebSocket 서버 연결 시도:",E);const C=new WebSocket(E);r.current=C,d.current=window.setTimeout(()=>{i.current&&C.readyState===WebSocket.CONNECTING&&(console.log("⚠️ WebSocket 서버 응답 없음 - 오프라인 모드로 전환 (모든 기능 정상 작동)"),C.close(),s.current=!1,g("disconnected"),m.current=l)},5e3),C.onopen=()=>{if(i.current){console.log("✅ WebSocket 서버에 성공적으로 연결되었습니다"),d.current&&clearTimeout(d.current),s.current=!1,b(!0),g("connected"),m.current=0,k();try{const I={type:"auth",data:{client_type:"admin",timestamp:new Date().toISOString()},timestamp:new Date().toISOString()};C.send(JSON.stringify(I))}catch(I){console.error("⚠️ WebSocket 인증 메시지 전송 실패:",I)}}},C.onmessage=I=>{try{if(typeof I.data!="string"||!I.data.trim())return;let T;try{const B=JSON.parse(I.data);if(typeof B=="object"&&B!==null){if(T={type:B.type||"unknown",data:B.data||B,timestamp:B.timestamp||new Date().toISOString()},B.type==="pong")return}else throw new Error("Invalid JSON structure")}catch{T={type:"text",data:I.data,timestamp:new Date().toISOString()}}if(w(B=>[...B.slice(-49),T]),h(T),T.type==="pong"){console.log("💓 Heartbeat pong 수신");return}o.current.size>0&&o.current.forEach(B=>{try{B(T)}catch($){console.error("⚠️ WebSocket 메시지 핸들러 오류:",$)}}),T.type==="balance_update"&&typeof window<"u"&&window.updateUserBalance&&T.data?.new_balance&&window.updateUserBalance(T.data.new_balance),T.type==="partner_balance_updated"&&console.log("💰 [WebSocket] 파트너 보유금 업데이트 감지:",T.data),["game_session_start","game_session_end","balance_update"].includes(T.type)&&typeof window<"u"&&window.gameMonitorMessageHandler&&window.gameMonitorMessageHandler(T),T.type==="force_close_game"&&typeof window<"u"&&((window.openGameWindows||[]).forEach($=>{$&&!$.closed&&$.close()}),window.gameTab&&!window.gameTab.closed&&window.gameTab.close(),T.data?.message&&typeof window<"u"&&window.showToast&&window.showToast("error",T.data.message),console.log("🚫 게임 강제 종료:",T.data))}catch(T){console.error("WebSocket 메시지 처리 오류:",T)}},C.onclose=I=>{if(i.current)if(m.current===0&&console.log("WebSocket 서버에 연결할 수 없습니다 - 오프라인 모드로 전환됩니다."),d.current&&clearTimeout(d.current),v(),s.current=!1,b(!1),g("disconnected"),I.code!==1e3&&I.code!==1001&&i.current){const $=Math.min(2e3*Math.pow(1.5,m.current),3e4);console.log(`🔄 WebSocket 재연결 시도 (${m.current+1}회) - ${Math.round($/1e3)}초 후`),a.current=window.setTimeout(()=>{i.current&&(m.current+=1,A())},$)}else(I.code===1e3||I.code===1001)&&(console.log("✅ WebSocket 정상 종료"),g("disconnected"))},C.onerror=I=>{i.current&&(console.log("⚠️ WebSocket 에러 발생 - Realtime으로 백업 작동 중"),s.current=!1,g("error"))}}catch(E){console.error("❌ WebSocket 연결 실패:",E),s.current=!1,g("error"),i.current&&(a.current=window.setTimeout(()=>{i.current&&(m.current+=1,A())},5e3))}}}},[k]),_=p.useCallback(()=>{v(),a.current&&(clearTimeout(a.current),a.current=void 0),n.current&&(clearTimeout(n.current),n.current=void 0),d.current&&(clearTimeout(d.current),d.current=void 0),r.current&&(r.current.close(1e3,"Manual disconnect"),r.current=null),s.current=!1,b(!1),g("disconnected"),m.current=0},[v]),f=p.useCallback((E,C)=>{if(r.current?.readyState===WebSocket.OPEN){const I={type:E,data:C,timestamp:new Date().toISOString()};try{return r.current.send(JSON.stringify(I)),!0}catch(T){return console.error("메시지 전송 실패:",T),!1}}return!1},[]);p.useEffect(()=>(i.current=!0,A(),()=>{i.current=!1,v(),a.current&&clearTimeout(a.current),n.current&&clearTimeout(n.current),d.current&&clearTimeout(d.current),r.current&&(r.current.close(1e3,"Component unmount"),r.current=null)}),[A,v]),p.useEffect(()=>{const E=()=>{i.current&&document.visibilityState==="visible"&&!x&&!s.current&&(console.log("📱 페이지 활성화 - WebSocket 재연결 시도"),m.current=0,A())},C=()=>{i.current&&!x&&!s.current&&(console.log("🌐 네트워크 복구 - WebSocket 재연결 시도"),m.current=0,A())},I=()=>{i.current&&(console.log("📡 네트워크 연결 끊김 - 오프라인 모드"),g("disconnected"),r.current&&r.current.close())};return document.addEventListener("visibilitychange",E),window.addEventListener("online",C),window.addEventListener("offline",I),()=>{document.removeEventListener("visibilitychange",E),window.removeEventListener("online",C),window.removeEventListener("offline",I)}},[x,A]);const S=be.useMemo(()=>({connected:x,messages:N,sendMessage:f,connect:A,disconnect:_,lastMessage:y,connectionState:c}),[x,N,f,A,_,y,c]);return t.jsx(nr.Provider,{value:S,children:e})});function Fa({children:e,currentRoute:r,onNavigate:a}){const{authState:n}=ve(),{connected:d}=Ze(),[m,l]=p.useState(!0);if(!n.user)return t.jsx("div",{className:"min-h-screen flex items-center justify-center bg-[#0a0e1a]",children:t.jsxs("div",{className:"text-center space-y-4",children:[t.jsx("div",{className:"loading-premium mx-auto"}),t.jsx("p",{className:"text-slate-300",children:"로딩 중..."})]})});const s=n.user;return t.jsxs(wa,{children:[t.jsx(Ra,{user:s}),t.jsx(Ua,{user:s}),t.jsxs("div",{className:"h-screen flex w-full overflow-hidden bg-[#0a0e1a]",children:[t.jsx("div",{className:Y("fixed left-0 top-0 h-screen transition-all duration-300 z-40","bg-[#0f1419]/95 backdrop-blur-xl border-r border-slate-700/50 shadow-xl",m?"w-64":"w-16"),children:t.jsx(va,{user:s,onNavigate:a,currentRoute:r,className:"h-full"})}),t.jsxs("div",{className:Y("flex-1 flex flex-col h-screen overflow-hidden transition-all duration-300",m?"ml-64":"ml-16"),children:[t.jsx("header",{className:"sticky top-0 z-30 bg-[#0f1419]/90 backdrop-blur-lg border-b border-slate-700/50 shadow-sm",children:t.jsx(Ta,{user:s,wsConnected:d,onToggleSidebar:()=>l(!m),onRouteChange:a,currentRoute:r})}),t.jsx("main",{className:"flex-1 p-6 overflow-y-auto bg-[#0a0e1a]",children:t.jsx("div",{className:"max-w-[1600px] mx-auto space-y-6",children:e})})]})]})]})}const De=p.lazy(()=>P(()=>import("./Dashboard-BopLuZLR.js"),__vite__mapDeps([0,1,2,3,4,5,6,7])).then(e=>({default:e.Dashboard}))),qa=p.lazy(()=>P(()=>import("./UserManagement-CiOSoJ1s.js"),__vite__mapDeps([8,1,9,6,10,4,3,7,2,11,12,13,14,15])).then(e=>({default:e.UserManagement}))),Va=p.lazy(()=>P(()=>import("./BlacklistManagement-AM83kVK6.js"),__vite__mapDeps([16,1,3,4,2,6,7])).then(e=>({default:e.BlacklistManagement}))),Ga=p.lazy(()=>P(()=>import("./PointManagement-CARxtFu4.js"),__vite__mapDeps([17,7,1,3,4,9,6,10,12,14,15,13,2])).then(e=>({default:e.PointManagement}))),Wa=p.lazy(()=>P(()=>import("./OnlineUsers-ByHgS6Fx.js"),__vite__mapDeps([18,1,9,6,3,4,10,2,7])).then(e=>({default:e.OnlineUsers}))),xt=p.lazy(()=>P(()=>import("./PartnerConnectionStatus-CAPDXiEM.js"),__vite__mapDeps([19,1,9,6,2,3,4,7])).then(e=>({default:e.PartnerConnectionStatus}))),Ka=p.lazy(()=>P(()=>import("./PartnerManagement-DmPmPTzt.js"),__vite__mapDeps([20,7,1,3,4,10,2,21,9,6,11,12,13,14,15])).then(e=>({default:e.PartnerManagement}))),Ha=p.lazy(()=>P(()=>import("./PartnerCreation-BXi1bJFP.js"),__vite__mapDeps([22,1,12,9,6,3,4,7])).then(e=>({default:e.PartnerCreation}))),Ya=p.lazy(()=>P(()=>import("./PartnerTransactions-x-XFBrYf.js"),__vite__mapDeps([21,1,9,6,3,4,2,7])).then(e=>({default:e.PartnerTransactions}))),Ja=p.lazy(()=>P(()=>import("./CommissionSettlement-_nvmZs-3.js"),__vite__mapDeps([23,1,13,4,3,24,6,2,5,7])).then(e=>({default:e.CommissionSettlement}))),Xa=p.lazy(()=>P(()=>import("./IntegratedSettlement-CMQpjvqX.js"),__vite__mapDeps([25,1,13,4,3,24,6,2,5,7])).then(e=>({default:e.IntegratedSettlement}))),Qa=p.lazy(()=>P(()=>import("./TransactionManagement-BUfK4uLs.js"),__vite__mapDeps([26,1,12,10,4,3,14,15,6,13,9,2,7])).then(e=>({default:e.TransactionManagement}))),Za=p.lazy(()=>P(()=>import("./TransactionApprovalManager-ChN5QjSx.js"),__vite__mapDeps([27,1,15,4,3,6,7])).then(e=>({default:e.TransactionApprovalManager}))),es=p.lazy(()=>P(()=>import("./EnhancedGameManagement-BAbIZXTB.js"),__vite__mapDeps([28,1,9,6,3,4,29,7,2])).then(e=>({default:e.EnhancedGameManagement}))),ts=p.lazy(()=>P(()=>import("./BettingManagement-Dv4lY0Md.js"),__vite__mapDeps([30,7,1,3,4,9,6])).then(e=>({default:e.BettingManagement}))),bt=p.lazy(()=>P(()=>import("./BettingHistory-CKxpIe8f.js"),__vite__mapDeps([31,1,9,6,3,4,2,7])).then(e=>({default:e.BettingHistory}))),rs=p.lazy(()=>P(()=>import("./CallCycle-BwbaTtVv.js"),__vite__mapDeps([32,1,33,4,3,6,7])).then(e=>({default:e.CallCycle}))),as=p.lazy(()=>P(()=>import("./CustomerSupport-qN3iQBWC.js"),__vite__mapDeps([34,1,12,10,4,3,6,7])).then(e=>({default:e.CustomerSupport}))),ss=p.lazy(()=>P(()=>import("./Announcements-BzqpDivw.js"),__vite__mapDeps([35,1,12,9,6,10,4,3,33,7])).then(e=>({default:e.Announcements}))),ns=p.lazy(()=>P(()=>import("./MessageCenter-DklucLSR.js"),__vite__mapDeps([36,1,12,9,6,10,4,3,7])).then(e=>({default:e.MessageCenter}))),_t=p.lazy(()=>P(()=>import("./SystemSettings-BaHMw7R_.js"),__vite__mapDeps([37,7,1,3,4,33,6])).then(e=>({default:e.SystemSettings}))),os=p.lazy(()=>P(()=>import("./BannerManagement-BZ2QQaKm.js"),__vite__mapDeps([38,1,12,9,6,10,4,3,2,7])).then(e=>({default:e.BannerManagement}))),is=p.lazy(()=>P(()=>import("./MenuManagement-CJ5prQoB.js"),__vite__mapDeps([39,1,33,4,3,6,7])).then(e=>({default:e.MenuManagement}))),ls=p.lazy(()=>P(()=>import("./ApiTester-KJmkVxEz.js"),__vite__mapDeps([40,1,3,4,6,7])).then(e=>({default:e.ApiTester}))),cs=p.lazy(()=>P(()=>import("./AutoSyncMonitor-CG7fdLLX.js"),__vite__mapDeps([41,1,4,3,2,6,7])).then(e=>({default:e.AutoSyncMonitor})));function ds({currentRoute:e,user:r}){const a=()=>{switch(e){case"/admin/dashboard":case"/admin/realtime":return t.jsx(De,{user:r});case"/admin/users":case"/admin/user-management":return t.jsx(qa,{});case"/admin/blacklist":return t.jsx(Va,{});case"/admin/points":return t.jsx(Ga,{});case"/admin/online":case"/admin/online-users":return t.jsx(Wa,{user:r});case"/admin/online-status":return t.jsx(xt,{user:r});case"/admin/logs":return t.jsx(bt,{user:r});case"/admin/head-office":case"/admin/partners/master":return t.jsx(Ha,{user:r});case"/admin/partners":case"/admin/partner-hierarchy":return t.jsx(Ka,{});case"/admin/partner-transactions":case"/admin/partners/transactions":return t.jsx(Ya,{});case"/admin/partner-online":case"/admin/partners/status":case"/admin/partner-connection-status":return t.jsx(xt,{user:r});case"/admin/partner-dashboard":case"/admin/partners/dashboard":return t.jsx(De,{user:r});case"/admin/settlement":case"/admin/commission-settlement":case"/admin/settlement/commission":return t.jsx(Ja,{user:r});case"/admin/integrated-settlement":case"/admin/settlement/integrated":return t.jsx(Xa,{user:r});case"/admin/transactions":return t.jsx(Qa,{user:r});case"/admin/transaction-approval":return t.jsx(Za,{user:r});case"/admin/games":case"/admin/game-lists":return t.jsx(es,{user:r});case"/admin/betting":case"/admin/betting-history":return t.jsx(bt,{user:r});case"/admin/betting-management":return t.jsx(ts,{user:r});case"/admin/call-cycle":return t.jsx(rs,{user:r});case"/admin/communication":case"/admin/customer-service":case"/admin/support":return t.jsx(as,{user:r});case"/admin/announcements":return t.jsx(ss,{user:r});case"/admin/messages":return t.jsx(ns,{user:r});case"/admin/settings":case"/admin/system-settings":return t.jsx(_t,{user:r});case"/admin/system":case"/admin/system-info":return t.jsx(_t,{user:r,initialTab:"info"});case"/admin/api-tester":return t.jsx(ls,{user:r});case"/admin/banners":return t.jsx(os,{user:r});case"/admin/menu-management":return t.jsx(is,{user:r});case"/admin/auto-sync-monitor":return t.jsx(cs,{});default:return t.jsx(De,{user:r})}};return t.jsx(p.Suspense,{fallback:t.jsx(na,{size:"lg",text:"페이지를 불러오는 중...",className:"min-h-screen"}),children:a()})}const us=Pe("relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",{variants:{variant:{default:"bg-card text-card-foreground",destructive:"text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90"}},defaultVariants:{variant:"default"}});function ms({className:e,variant:r,...a}){return t.jsx("div",{"data-slot":"alert",role:"alert",className:O(us({variant:r}),e),...a})}function ps({className:e,...r}){return t.jsx("div",{"data-slot":"alert-description",className:O("text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",e),...r})}function fs({className:e,...r}){return t.jsx(kr,{"data-slot":"tabs",className:O("flex flex-col gap-2",e),...r})}function gs({className:e,...r}){return t.jsx(Er,{"data-slot":"tabs-list",className:O("bg-muted text-muted-foreground inline-flex h-9 w-fit items-center justify-center rounded-xl p-[3px] flex",e),...r})}function wt({className:e,...r}){return t.jsx(Ir,{"data-slot":"tabs-trigger",className:O("data-[state=active]:bg-card dark:data-[state=active]:text-foreground focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30 text-foreground dark:text-muted-foreground inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 rounded-xl border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",e),...r})}function yt({className:e,...r}){return t.jsx(Cr,{"data-slot":"tabs-content",className:O("flex-1 outline-none",e),...r})}function hs({...e}){return t.jsx(Dr,{"data-slot":"select",...e})}function xs({...e}){return t.jsx(Pr,{"data-slot":"select-value",...e})}function bs({className:e,size:r="default",children:a,...n}){return t.jsxs(Tr,{"data-slot":"select-trigger","data-size":r,className:O("border-input data-[placeholder]:text-muted-foreground [&_svg:not([class*='text-'])]:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 dark:hover:bg-input/50 flex w-full items-center justify-between gap-2 rounded-md border bg-input-background px-3 py-2 text-sm whitespace-nowrap transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 data-[size=default]:h-9 data-[size=sm]:h-8 *:data-[slot=select-value]:line-clamp-1 *:data-[slot=select-value]:flex *:data-[slot=select-value]:items-center *:data-[slot=select-value]:gap-2 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",e),...n,children:[a,t.jsx(Or,{asChild:!0,children:t.jsx($e,{className:"size-4 opacity-50"})})]})}function _s({className:e,children:r,position:a="popper",...n}){return t.jsx(Br,{children:t.jsxs($r,{"data-slot":"select-content",className:O("bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 relative z-50 max-h-(--radix-select-content-available-height) min-w-[8rem] origin-(--radix-select-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border shadow-md",a==="popper"&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",e),position:a,...n,children:[t.jsx(ys,{}),t.jsx(Mr,{className:O("p-1",a==="popper"&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)] scroll-my-1"),children:r}),t.jsx(vs,{})]})})}function ws({className:e,children:r,...a}){return t.jsxs(Rr,{"data-slot":"select-item",className:O("focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex w-full cursor-default items-center gap-2 rounded-sm py-1.5 pr-8 pl-2 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 *:[span]:last:flex *:[span]:last:items-center *:[span]:last:gap-2",e),...a,children:[t.jsx("span",{className:"absolute right-2 flex size-3.5 items-center justify-center",children:t.jsx(Lr,{children:t.jsx(ea,{className:"size-4"})})}),t.jsx(Ur,{children:r})]})}function ys({className:e,...r}){return t.jsx(zr,{"data-slot":"select-scroll-up-button",className:O("flex cursor-default items-center justify-center py-1",e),...r,children:t.jsx(ta,{className:"size-4"})})}function vs({className:e,...r}){return t.jsx(Fr,{"data-slot":"select-scroll-down-button",className:O("flex cursor-default items-center justify-center py-1",e),...r,children:t.jsx($e,{className:"size-4"})})}const js=()=>typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const r=Math.random()*16|0;return(e==="x"?r:r&3|8).toString(16)});function Ns({onLoginSuccess:e}){const[r,a]=p.useState("login"),[n,d]=p.useState({username:"",password:""}),[m,l]=p.useState({username:"",nickname:"",password:"",email:"",phone:"",bank_name:"",bank_account:"",bank_holder:"",referrer_username:""}),[s,i]=p.useState(!1),[o,u]=p.useState(!1),[x,b]=p.useState(null),[N,w]=p.useState([]),[y,h]=p.useState({status:"idle",message:""});p.useEffect(()=>{(async()=>{try{const{data:f,error:S}=await j.from("banks").select("*").eq("is_active",!0).order("bank_name");if(S)throw S;w(f||[])}catch(f){console.error("은행 목록 로드 오류:",f)}})()},[]);const c=_=>{const{name:f,value:S}=_.target;d(E=>({...E,[f]:S})),x&&b(null)},g=_=>{const{name:f,value:S}=_.target;l(E=>({...E,[f]:S})),x&&b(null)},k=async _=>{if(!_.trim()){h({status:"idle",message:""});return}h({status:"checking",message:"확인 중..."});try{const{data:f,error:S}=await j.from("users").select("id").eq("nickname",_.trim()).limit(1);if(S)throw S;f&&f.length>0?h({status:"unavailable",message:"이미 사용 중인 닉네임입니다."}):h({status:"available",message:"사용 가능한 닉네임입니다."})}catch(f){console.error("닉네임 체크 오류:",f),h({status:"unavailable",message:"확인 중 오류가 발생했습니다."})}},v=async _=>{if(_.preventDefault(),!n.username.trim()||!n.password.trim()){b("아이디와 비밀번호를 모두 입력해주세요.");return}i(!0),b(null);try{console.log("🔐 사용자 로그인 시도:",n.username.trim());const{data:f,error:S}=await j.rpc("user_login",{p_username:n.username.trim(),p_password:n.password});if(console.log("🔐 로그인 RPC 응답:",{data:f,error:S}),S)throw console.error("❌ 로그인 RPC 에러:",S),S;if(!f||f.length===0){console.warn("⚠️ 로그인 실패: 사용자를 찾을 수 없거나 비밀번호가 일치하지 않음"),b("아이디 또는 비밀번호가 올바르지 않습니다.");return}const E=f[0];if(console.log("✅ 로그인 성공:",{username:E.username,nickname:E.nickname,status:E.status,vip_level:E.vip_level}),E.status==="blocked"){console.warn("⚠️ 차단된 계정:",E.username),b("차단된 계정입니다. 고객센터에 문의해주세요.");return}if(E.status==="pending"){console.warn("⚠️ 승인 대기 중인 계정:",E.username),b("승인 대기 중인 계정입니다. 잠시 후 다시 시도해주세요.");return}const C=navigator.userAgent.toLowerCase();let I="PC";(C.includes("mobile")||C.includes("android")||C.includes("iphone")||C.includes("ipod")||C.includes("blackberry")||C.includes("windows phone")||C.includes("iemobile")||C.includes("opera mini")||C.includes("ipad")||C.includes("tablet"))&&(I="Mobile");const T={user_id:E.id,session_token:js(),ip_address:null,device_info:{userAgent:navigator.userAgent,platform:navigator.platform,language:navigator.language,device:I}},{error:B}=await j.from("user_sessions").insert([T]);B&&console.error("세션 생성 오류:",B),await j.from("users").update({is_online:!0,last_login_at:new Date().toISOString(),device_info:T.device_info}).eq("id",E.id),await j.from("activity_logs").insert([{actor_type:"user",actor_id:E.id,action:"login",details:{username:E.username,login_time:new Date().toISOString()}}]),localStorage.setItem("user_session",JSON.stringify(E)),D.success(`${E.nickname}님, 환영합니다!`),e(E)}catch(f){console.error("로그인 오류:",f),b(f.message||"로그인 중 오류가 발생했습니다."),D.error("로그인에 실패했습니다.")}finally{i(!1)}},A=async _=>{if(_.preventDefault(),!m.username.trim()){b("아이디를 입력해주세요.");return}if(!m.nickname.trim()){b("닉네임을 입력해주세요.");return}if(y.status!=="available"){b("닉네임 중복 확인을 완료해주세요.");return}if(!m.password.trim()){b("비밀번호를 입력해주세요.");return}if(!m.referrer_username.trim()){b("추천인을 입력해주세요.");return}i(!0),b(null);try{const{data:f,error:S}=await j.from("partners").select("id").eq("username",m.referrer_username.trim()).maybeSingle();if(S){console.error("추천인 조회 에러:",S),b("추천인 조회 중 오류가 발생했습니다.");return}if(!f){b("존재하지 않는 추천인입니다.");return}const{data:E,error:C}=await j.from("users").insert([{username:m.username.trim(),nickname:m.nickname.trim(),password_hash:m.password,email:m.email.trim()||null,phone:m.phone.trim()||null,bank_name:m.bank_name||null,bank_account:m.bank_account.trim()||null,bank_holder:m.bank_holder.trim()||null,referrer_id:f.id,status:"pending",balance:0,points:0}]).select("id, username").single();if(C){C.code==="23505"?C.message.includes("username")?b("이미 사용 중인 아이디입니다."):C.message.includes("nickname")?b("이미 사용 중인 닉네임입니다."):b("중복된 정보가 있습니다."):b(C.message||"회원가입에 실패했습니다.");return}if(!E){b("회원가입 처리 중 오류가 발생했습니다.");return}try{console.log("🔗 Invest API 계정 생성 시도:",m.username.trim());const{data:I,error:T}=await j.rpc("get_user_opcode",{user_id:E.id});if(T)console.error("❌ OPCODE 정보 조회 실패:",T),D.warning("회원가입은 완료되었지만 게임 계정 연동에 실패했습니다. 관리자에게 문의해주세요.");else if(!I||I.length===0)console.error("❌ OPCODE 정보를 찾을 수 없음 (모든 상위 파트너 확인 완료)"),D.warning("회원가입은 완료되었지만 게임 계정 연동에 실패했습니다. 관리자에게 문의해주세요.");else{const{opcode:B,secret_key:$}=I[0];console.log("✅ OPCODE 정보 조회 성공:",{opcode:B});const V=await Qe.createAccount(B,m.username.trim(),$);V.error?(console.error("❌ Invest API 계정 생성 실패:",V.error),D.warning("회원가입은 완료되었지만 게임 계정 연동에 실패했습니다. 관리자에게 문의해주세요.")):(console.log("✅ Invest API 계정 생성 성공:",V.data),await j.from("activity_logs").insert([{actor_type:"user",actor_id:E.id,action:"api_account_creation",details:{username:m.username.trim(),success:!0,api_response:V.data}}]),D.success("회원가입 및 게임 계정이 성공적으로 생성되었습니다!"))}}catch(I){console.error("❌ Invest API 계정 생성 예외:",I);try{await j.from("activity_logs").insert([{actor_type:"user",actor_id:E.id,action:"api_account_creation",details:{username:m.username.trim(),success:!1,error:I instanceof Error?I.message:"알 수 없는 오류"}}])}catch(T){console.error("로그 기록 실패:",T)}D.warning("회원가입은 완료되었지만 게임 계정 연동에 실패했습니다. 관리자에게 문의해주세요.")}a("login"),d(I=>({...I,username:m.username})),l({username:"",nickname:"",password:"",email:"",phone:"",bank_name:"",bank_account:"",bank_holder:"",referrer_username:""}),h({status:"idle",message:""})}catch(f){console.error("회원가입 오류:",f),b(f.message||"회원가입 중 오류가 발생했습니다."),D.error("회원가입에 실패했습니다.")}finally{i(!1)}};return t.jsx("div",{className:"min-h-screen flex items-center justify-center casino-gradient-bg p-4",children:t.jsxs("div",{className:"w-full max-w-md",children:[t.jsxs("div",{className:"text-center mb-8",children:[t.jsx("h1",{className:"text-5xl font-bold gold-text neon-glow mb-2 tracking-wide",children:"VIP CASINO"}),t.jsx("p",{className:"text-yellow-300/80 text-lg tracking-wider",children:"LUXURY GAMING EXPERIENCE"})]}),t.jsxs(Me,{className:"luxury-card border-2 border-yellow-600/40 shadow-2xl backdrop-blur-sm",children:[t.jsxs(Re,{className:"space-y-1 pb-4",children:[t.jsx(Le,{className:"text-2xl text-center gold-text neon-glow",children:"VIP 로그인"}),t.jsx(Bt,{className:"text-center text-yellow-300/80",children:"VIP 계정으로 로그인하세요"})]}),t.jsxs(Ue,{className:"space-y-4",children:[t.jsxs(fs,{value:r,onValueChange:a,className:"w-full",children:[t.jsxs(gs,{className:"grid w-full grid-cols-2 bg-black/50 mb-6 border border-yellow-600/30",children:[t.jsx(wt,{value:"login",className:"text-yellow-200 data-[state=active]:bg-gradient-to-r data-[state=active]:from-yellow-600 data-[state=active]:to-amber-600 data-[state=active]:text-white data-[state=active]:font-bold data-[state=active]:shadow-lg",children:"VIP 로그인"}),t.jsx(wt,{value:"register",className:"text-yellow-200 data-[state=active]:bg-gradient-to-r data-[state=active]:from-yellow-600 data-[state=active]:to-amber-600 data-[state=active]:text-white data-[state=active]:font-bold data-[state=active]:shadow-lg",children:"VIP 가입"})]}),t.jsx(yt,{value:"login",className:"space-y-4",children:t.jsxs("form",{onSubmit:v,className:"space-y-4",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx(F,{htmlFor:"login-username",className:"text-yellow-300 font-semibold",children:"VIP 아이디"}),t.jsx(z,{id:"login-username",name:"username",type:"text",placeholder:"VIP 아이디를 입력하세요",value:n.username,onChange:c,disabled:s,className:"bg-black/50 border-yellow-600/30 text-white placeholder:text-yellow-200/50 focus:border-yellow-500 focus:ring-yellow-500/20"})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(F,{htmlFor:"login-password",className:"text-slate-300",children:"비밀번호"}),t.jsxs("div",{className:"relative",children:[t.jsx(z,{id:"login-password",name:"password",type:o?"text":"password",placeholder:"비밀번호를 입력하세요",value:n.password,onChange:c,disabled:s,className:"bg-slate-700/50 border-slate-600 text-white placeholder:text-slate-400 focus:border-blue-500 pr-10"}),t.jsx("button",{type:"button",onClick:()=>u(!o),className:"absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-300",children:o?t.jsx(ct,{className:"w-4 h-4"}):t.jsx(dt,{className:"w-4 h-4"})})]})]}),t.jsx(U,{type:"submit",disabled:s,className:"w-full bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-600 hover:to-orange-700 text-white py-3",children:s?t.jsxs(t.Fragment,{children:[t.jsx(le,{className:"w-4 h-4 mr-2 animate-spin"}),"로그인 중..."]}):"로그인"})]})}),t.jsx(yt,{value:"register",className:"space-y-4",children:t.jsxs("form",{onSubmit:A,className:"space-y-4",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsxs(F,{htmlFor:"register-username",className:"text-slate-300",children:["아이디 ",t.jsx("span",{className:"text-red-400",children:"*"})]}),t.jsx(z,{id:"register-username",name:"username",type:"text",placeholder:"아이디를 입력하세요",value:m.username,onChange:g,disabled:s,className:"bg-slate-700/50 border-slate-600 text-white placeholder:text-slate-400 focus:border-blue-500"})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs(F,{htmlFor:"register-nickname",className:"text-slate-300",children:["닉네임 ",t.jsx("span",{className:"text-red-400",children:"*"})]}),t.jsxs("div",{className:"relative",children:[t.jsx(z,{id:"register-nickname",name:"nickname",type:"text",placeholder:"닉네임을 입력하세요",value:m.nickname,onChange:_=>{g(_),_.target.value.trim()&&k(_.target.value)},disabled:s,className:"bg-slate-700/50 border-slate-600 text-white placeholder:text-slate-400 focus:border-blue-500 pr-10"}),y.status==="checking"&&t.jsx(le,{className:"absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 animate-spin text-slate-400"}),y.status==="available"&&t.jsx(ra,{className:"absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-green-400"}),y.status==="unavailable"&&t.jsx(aa,{className:"absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-red-400"})]}),y.message&&t.jsx("p",{className:`text-sm ${y.status==="available"?"text-green-400":"text-red-400"}`,children:y.message})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs(F,{htmlFor:"register-password",className:"text-slate-300",children:["비밀번호 ",t.jsx("span",{className:"text-red-400",children:"*"})]}),t.jsxs("div",{className:"relative",children:[t.jsx(z,{id:"register-password",name:"password",type:o?"text":"password",placeholder:"비밀번호를 입력하세요",value:m.password,onChange:g,disabled:s,className:"bg-slate-700/50 border-slate-600 text-white placeholder:text-slate-400 focus:border-blue-500 pr-10"}),t.jsx("button",{type:"button",onClick:()=>u(!o),className:"absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-300",children:o?t.jsx(ct,{className:"w-4 h-4"}):t.jsx(dt,{className:"w-4 h-4"})})]})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx(F,{htmlFor:"register-email",className:"text-slate-300",children:"이메일"}),t.jsx(z,{id:"register-email",name:"email",type:"email",placeholder:"이메일을 입력하세요",value:m.email,onChange:g,disabled:s,className:"bg-slate-700/50 border-slate-600 text-white placeholder:text-slate-400 focus:border-blue-500"})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(F,{htmlFor:"register-phone",className:"text-slate-300",children:"연락처"}),t.jsx(z,{id:"register-phone",name:"phone",type:"tel",placeholder:"연락처를 입력하세요",value:m.phone,onChange:g,disabled:s,className:"bg-slate-700/50 border-slate-600 text-white placeholder:text-slate-400 focus:border-blue-500"})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(F,{className:"text-slate-300",children:"은행 정보"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2",children:[t.jsxs(hs,{value:m.bank_name,onValueChange:_=>l(f=>({...f,bank_name:_})),children:[t.jsx(bs,{className:"bg-slate-700/50 border-slate-600 text-white",children:t.jsx(xs,{placeholder:"은행 선택"})}),t.jsx(_s,{className:"bg-slate-700 border-slate-600",children:N.map(_=>t.jsx(ws,{value:_.bank_name,className:"text-white",children:_.bank_name},_.id))})]}),t.jsx(z,{name:"bank_account",placeholder:"계좌번호",value:m.bank_account,onChange:g,disabled:s,className:"bg-slate-700/50 border-slate-600 text-white placeholder:text-slate-400 focus:border-blue-500"}),t.jsx(z,{name:"bank_holder",placeholder:"예금주명",value:m.bank_holder,onChange:g,disabled:s,className:"bg-slate-700/50 border-slate-600 text-white placeholder:text-slate-400 focus:border-blue-500"})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs(F,{htmlFor:"register-referrer",className:"text-slate-300",children:["추천인 ",t.jsx("span",{className:"text-red-400",children:"*"})]}),t.jsx(z,{id:"register-referrer",name:"referrer_username",type:"text",placeholder:"추천인 아이디를 입력하세요",value:m.referrer_username,onChange:g,disabled:s,className:"bg-slate-700/50 border-slate-600 text-white placeholder:text-slate-400 focus:border-blue-500"})]}),t.jsx(U,{type:"submit",disabled:s||y.status!=="available",className:"w-full bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-600 hover:to-orange-700 text-white py-3",children:s?t.jsxs(t.Fragment,{children:[t.jsx(le,{className:"w-4 h-4 mr-2 animate-spin"}),"회원가입 중..."]}):"회원가입"})]})})]}),x&&t.jsx(ms,{className:"border-red-600 bg-red-900/20",children:t.jsx(ps,{className:"text-red-400",children:x})})]})]}),t.jsxs("div",{className:"text-center mt-8 text-sm text-slate-400",children:[t.jsx("p",{children:"© 2025 GMS Casino. All rights reserved."}),t.jsx("p",{className:"mt-2 text-slate-500",children:"안전하고 공정한 게임 환경을 제공합니다."})]})]})})}function Ss({...e}){return t.jsx(qr,{"data-slot":"alert-dialog",...e})}function As({...e}){return t.jsx(Yr,{"data-slot":"alert-dialog-portal",...e})}const or=p.forwardRef(({className:e,...r},a)=>t.jsx(It,{ref:a,"data-slot":"alert-dialog-overlay",className:O("data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",e),...r}));or.displayName=It.displayName;function ks({className:e,...r}){return t.jsxs(As,{children:[t.jsx(or,{}),t.jsx(Vr,{"data-slot":"alert-dialog-content",className:O("bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",e),...r})]})}function Es({className:e,...r}){return t.jsx("div",{"data-slot":"alert-dialog-header",className:O("flex flex-col gap-2 text-center sm:text-left",e),...r})}function Is({className:e,...r}){return t.jsx("div",{"data-slot":"alert-dialog-footer",className:O("flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",e),...r})}function Cs({className:e,...r}){return t.jsx(Gr,{"data-slot":"alert-dialog-title",className:O("text-lg font-semibold",e),...r})}function Ds({className:e,...r}){return t.jsx(Wr,{"data-slot":"alert-dialog-description",className:O("text-muted-foreground text-sm",e),...r})}function Ts({className:e,...r}){return t.jsx(Hr,{className:O(ze(),e),...r})}function Os({className:e,...r}){return t.jsx(Kr,{className:O(ze({variant:"outline"}),e),...r})}function Ps(){const e=Ze();return{connected:e.connected,messages:e.messages,sendMessage:e.sendMessage,connect:e.connect,disconnect:e.disconnect,lastMessage:e.lastMessage,connectionState:e.connectionState}}const vt=[{path:"/user/casino",label:"카지노",icon:_e},{path:"/user/slot",label:"슬롯",icon:Tt},{path:"/user/betting-history",label:"베팅내역",icon:sa},{path:"/user/deposit",label:"입금신청",icon:Q},{path:"/user/withdraw",label:"출금신청",icon:Ot},{path:"/user/notice",label:"공지사항",icon:J},{path:"/user/support",label:"고객센터",icon:J},{path:"/user/profile",label:"내정보",icon:K}];function Bs({user:e,currentRoute:r,onRouteChange:a,onLogout:n}){const[d,m]=p.useState({balance:0,points:0}),[l,s]=p.useState(0),[i,o]=p.useState(!1);Ps();const u=async()=>{try{const{data:h,error:c}=await j.from("users").select("balance, points").eq("id",e.id).single();if(c)throw c;h&&m({balance:parseFloat(h.balance)||0,points:parseFloat(h.points)||0})}catch(h){console.error("잔고 조회 오류:",h)}};p.useEffect(()=>{u(),console.log("🔔 보유금 실시간 구독 시작:",e.id);const h=j.channel(`user_balance_unified_${e.id}`).on("postgres_changes",{event:"UPDATE",schema:"public",table:"users",filter:`id=eq.${e.id}`},c=>{console.log("💰 [users 테이블] 보유금 변경 감지:",c);const g=c.new;m({balance:parseFloat(g.balance)||0,points:parseFloat(g.points)||0})}).on("postgres_changes",{event:"*",schema:"public",table:"transactions",filter:`user_id=eq.${e.id}`},c=>{console.log("💳 [transactions 테이블] 입출금 이벤트 감지:",c),u()}).subscribe();return()=>{console.log("🔕 보유금 실시간 구독 해제:",e.id),j.removeChannel(h)}},[e.id]);const x=async()=>{if(d.points<=0){D.error("전환할 포인트가 없습니다.");return}try{const h=d.points,{error:c}=await j.from("users").update({points:0,balance:d.balance+h}).eq("id",e.id);if(c)throw c;await j.from("point_transactions").insert([{user_id:e.id,transaction_type:"convert_to_balance",amount:h,points_before:d.points,points_after:0,memo:"포인트를 보유금으로 전환"}]),await j.from("transactions").insert([{user_id:e.id,transaction_type:"point_conversion",amount:h,status:"completed",balance_before:d.balance,balance_after:d.balance+h,memo:"포인트 전환"}]),await u(),o(!1),D.success(`${h.toLocaleString()}P가 보유금으로 전환되었습니다.`)}catch(h){console.error("포인트 전환 오류:",h),D.error(h.message||"포인트 전환 중 오류가 발생했습니다.")}},b=async()=>{try{const{count:h,error:c}=await j.from("messages").select("*",{count:"exact",head:!0}).eq("receiver_type","user").eq("receiver_id",e.id).eq("status","unread");if(c)throw c;s(h||0)}catch(h){console.error("읽지 않은 메시지 수 조회 오류:",h)}};p.useEffect(()=>{b(),typeof window<"u"&&(window.updateUserBalance=c=>{m(g=>({...g,balance:c}))});const h=j.channel("user_message_updates").on("postgres_changes",{event:"*",schema:"public",table:"messages",filter:`receiver_id=eq.${e.id}`},()=>{b()}).subscribe();return()=>{h.unsubscribe()}},[e.id]);const N=h=>new Intl.NumberFormat("ko-KR").format(h),y=(h=>h>=5?{label:"DIAMOND",color:"bg-purple-600"}:h>=4?{label:"PLATINUM",color:"bg-gray-400"}:h>=3?{label:"GOLD",color:"bg-yellow-500"}:h>=2?{label:"SILVER",color:"bg-gray-300"}:h>=1?{label:"BRONZE",color:"bg-orange-400"}:{label:"MEMBER",color:"bg-slate-500"})(e.vip_level||0);return t.jsxs(t.Fragment,{children:[t.jsxs("header",{className:"fixed top-0 left-0 right-0 z-50 bg-black/90 backdrop-blur-md border-b border-yellow-600/30 shadow-2xl",children:[t.jsx("div",{className:"absolute top-0 left-0 right-0 h-0.5 bg-gradient-to-r from-transparent via-yellow-500 to-transparent opacity-60"}),t.jsx("div",{className:"container mx-auto px-3 sm:px-4 max-w-full",children:t.jsxs("div",{className:"flex items-center justify-between h-20 lg:h-20 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 flex-shrink-0",children:[t.jsxs("button",{onClick:()=>{window.history.pushState({},"","/admin"),window.dispatchEvent(new Event("popstate"))},className:"relative w-14 h-14 sm:w-16 sm:h-16 rounded-xl overflow-hidden golden-border cursor-pointer hover:opacity-80 transition-opacity",children:[t.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-yellow-500 via-red-600 to-yellow-500"}),t.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:t.jsx(ut,{className:"w-8 h-8 sm:w-9 sm:h-9 text-white drop-shadow-lg relative z-10"})})]}),t.jsxs("div",{className:"hidden sm:block",children:[t.jsx("div",{className:"text-2xl sm:text-3xl gold-text neon-glow tracking-wide",children:"VIP CASINO"}),t.jsx("div",{className:"text-sm sm:text-base text-yellow-400 tracking-widest uppercase",children:"LUXURY EXPERIENCE"})]})]}),t.jsx("nav",{className:"hidden lg:flex items-center space-x-3 flex-shrink-0",children:vt.map(h=>{const c=h.icon,g=r===h.path;return t.jsxs(U,{variant:"ghost",onClick:()=>a(h.path),className:`
                      relative px-4 lg:px-6 py-3 lg:py-3.5 transition-all duration-300 whitespace-nowrap
                      ${g?"bg-gradient-to-r from-yellow-600 to-red-600 text-white shadow-lg shadow-yellow-500/50 border border-yellow-400/50":"text-yellow-200/80 hover:text-yellow-100 hover:bg-yellow-900/20 border border-transparent hover:border-yellow-600/30"}
                    `,children:[t.jsx(c,{className:`w-5 h-5 lg:w-6 lg:h-6 mr-2.5 ${g?"drop-shadow-lg":""}`}),t.jsx("span",{className:"text-base lg:text-lg",children:h.label}),g&&t.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-0.5 bg-gradient-to-r from-transparent via-yellow-300 to-transparent"})]},h.path)})}),t.jsxs("div",{className:"hidden lg:flex items-center space-x-2 lg:space-x-3 flex-shrink-0",children:[t.jsxs("div",{className:"flex items-center space-x-2 lg:space-x-3 luxury-card rounded-xl px-2 lg:px-4 py-2 lg:py-2.5",children:[t.jsxs("div",{className:"flex items-center space-x-1 lg:space-x-2 group cursor-pointer",children:[t.jsx("div",{className:"p-1 lg:p-1.5 rounded-lg bg-gradient-to-br from-green-500 to-emerald-600 shadow-lg shadow-green-500/30",children:t.jsx(Dt,{className:"w-3 h-3 lg:w-4 lg:h-4 text-white"})}),t.jsxs("div",{className:"text-right",children:[t.jsx("div",{className:"text-[10px] text-yellow-400/70 tracking-wide",children:"BALANCE"}),t.jsxs("div",{className:"text-sm text-green-400",children:["₩",N(d.balance)]})]})]}),t.jsx("div",{className:"w-px h-8 lg:h-10 bg-gradient-to-b from-transparent via-yellow-600/50 to-transparent"}),t.jsxs("button",{onClick:()=>o(!0),className:"flex items-center space-x-1 lg:space-x-2 cursor-pointer group hover:scale-105 transition-transform",children:[t.jsx("div",{className:"p-1 lg:p-1.5 rounded-lg bg-gradient-to-br from-yellow-500 to-amber-600 shadow-lg shadow-yellow-500/30",children:t.jsx(Tt,{className:"w-3 h-3 lg:w-4 lg:h-4 text-white"})}),t.jsxs("div",{className:"text-right",children:[t.jsx("div",{className:"text-[10px] text-yellow-400/70 tracking-wide",children:"POINTS"}),t.jsxs("div",{className:"text-sm text-yellow-400",children:[N(d.points),"P"]})]})]})]}),t.jsxs(Lt,{children:[t.jsx(Fe,{asChild:!0,children:t.jsxs(U,{variant:"ghost",className:"flex items-center space-x-2 text-yellow-100 hover:text-white hover:bg-yellow-900/20 border border-transparent hover:border-yellow-600/30 luxury-card px-3 py-2 min-w-0",children:[t.jsxs("div",{className:"flex items-center space-x-2 min-w-0",children:[t.jsxs(Rt,{className:`vip-badge ${y.color} text-white px-2.5 py-1 border border-yellow-400/30`,children:[t.jsx(ut,{className:"w-3 h-3 mr-1 drop-shadow-lg"}),t.jsx("span",{className:"tracking-wide text-sm",children:y.label})]}),t.jsx("span",{className:"text-yellow-100 text-sm truncate max-w-20",children:e.nickname})]}),t.jsx(mt,{className:"w-4 h-4 flex-shrink-0"})]})}),t.jsxs(Ut,{className:"w-56 luxury-card border-yellow-600/30",align:"end",children:[t.jsxs(ie,{onClick:()=>a("/user/profile"),className:"text-yellow-100 hover:text-white hover:bg-yellow-900/30 cursor-pointer",children:[t.jsx(mt,{className:"w-4 h-4 mr-2"}),"내 정보"]}),t.jsxs(ie,{onClick:()=>a("/user/deposit"),className:"text-green-400 hover:text-green-300 hover:bg-green-900/30 cursor-pointer",children:[t.jsx(Q,{className:"w-4 h-4 mr-2"}),"입금신청"]}),t.jsxs(ie,{onClick:()=>a("/user/withdraw"),className:"text-red-400 hover:text-red-300 hover:bg-red-900/30 cursor-pointer",children:[t.jsx(Ot,{className:"w-4 h-4 mr-2"}),"출금신청"]}),t.jsx(Aa,{className:"bg-yellow-600/30"}),t.jsxs(ie,{onClick:n,className:"text-red-400 hover:text-red-300 hover:bg-red-900/30 cursor-pointer",children:[t.jsx(Te,{className:"w-4 h-4 mr-2"}),"로그아웃"]})]})]})]}),t.jsxs("div",{className:"lg:hidden flex items-center gap-1.5 sm:gap-2 flex-shrink-0",children:[t.jsx(U,{variant:"ghost",size:"sm",onClick:()=>a("/user/support"),className:"p-1.5 sm:p-2 text-yellow-100 hover:text-white hover:bg-yellow-900/20",children:t.jsx(J,{className:"w-8 h-8 sm:w-9 sm:h-9"})}),t.jsx(U,{variant:"ghost",size:"sm",onClick:()=>a("/user/notice"),className:"p-1.5 sm:p-2 text-yellow-100 hover:text-white hover:bg-yellow-900/20",children:t.jsx(Be,{className:"w-8 h-8 sm:w-9 sm:h-9"})}),t.jsxs("div",{className:"flex flex-col items-end px-2 py-1.5 rounded-lg bg-black/40",children:[t.jsx("div",{className:"text-sm sm:text-base text-yellow-400/70 tracking-wide",children:"보유금"}),t.jsxs("div",{className:"text-lg sm:text-xl text-green-400 whitespace-nowrap",children:["₩",N(d.balance)]})]}),t.jsxs("button",{onClick:()=>o(!0),className:"flex flex-col items-end px-2 py-1.5 rounded-lg bg-black/40 hover:bg-yellow-900/20 transition-colors",children:[t.jsx("div",{className:"text-sm sm:text-base text-yellow-400/70 tracking-wide",children:"포인트"}),t.jsxs("div",{className:"text-lg sm:text-xl text-yellow-400 whitespace-nowrap",children:[N(d.points),"P"]})]}),t.jsx(U,{variant:"ghost",size:"sm",onClick:n,className:"p-1.5 sm:p-2 text-red-400 hover:text-red-300 hover:bg-red-900/20",children:t.jsx(Te,{className:"w-8 h-8 sm:w-9 sm:h-9"})})]})]})})]}),t.jsxs("div",{className:"lg:hidden fixed bottom-0 left-0 right-0 z-50 bg-black/95 backdrop-blur-md border-t border-yellow-600/30 shadow-2xl overflow-hidden",children:[t.jsx("div",{className:"absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-yellow-500 to-transparent"}),t.jsx("div",{className:"flex items-center justify-around py-4 px-1 safe-area-bottom overflow-y-hidden",children:vt.slice(0,5).map(h=>{const c=h.icon,g=r===h.path;return t.jsxs(U,{variant:"ghost",size:"sm",onClick:()=>a(h.path),className:`
                  flex flex-col items-center justify-center gap-1.5 px-1 py-6 relative flex-1                  
                  ${g?"text-yellow-400":"text-yellow-200/70 hover:text-yellow-100"}
                `,children:[t.jsx(c,{className:`w-11 h-11 sm:w-11 sm:h-11 flex-shrink-0 ${g?"drop-shadow-[0_0_12px_rgba(250,204,21,1)]":""}`}),t.jsx("span",{className:`text-sm sm:text-sm leading-tight text-center ${g?"neon-glow":""} whitespace-nowrap px-1`,children:h.label}),g&&t.jsx("div",{className:"absolute top-0 left-1/2 transform -translate-x-1/2 w-12 h-1.5 bg-gradient-to-r from-transparent via-yellow-400 to-transparent rounded-full"})]},h.path)})})]}),t.jsx(Ss,{open:i,onOpenChange:o,children:t.jsxs(ks,{className:"bg-slate-800 border-slate-700",children:[t.jsxs(Es,{children:[t.jsx(Cs,{className:"text-white",children:"포인트 전환"}),t.jsx(Ds,{className:"text-slate-300",children:d.points>0?t.jsxs(t.Fragment,{children:["보유하신 ",t.jsxs("span",{className:"text-yellow-400 font-bold",children:[N(d.points),"P"]}),"를 보유금으로 전환하시겠습니까?"]}):t.jsx("span",{className:"text-slate-400",children:"전환 가능한 포인트가 없습니다."})})]}),t.jsxs(Is,{children:[t.jsx(Os,{className:"bg-slate-700 text-white hover:bg-slate-600 border-slate-600",children:d.points>0?"취소":"확인"}),d.points>0&&t.jsx(Ts,{onClick:x,className:"bg-blue-600 text-white hover:bg-blue-700",children:"전환하기"})]})]})})]})}function $s({userId:e}){const[r,a]=p.useState(null),[n,d]=p.useState(!1),m=async()=>{try{const{data:s,error:i}=await j.from("messages").select("*").eq("receiver_type","user").eq("receiver_id",e).eq("sender_type","partner").eq("status","unread").is("parent_id",null).order("created_at",{ascending:!1}).limit(1).single();if(i&&i.code!=="PGRST116"){console.error("메시지 조회 오류:",i);return}s&&(a(s),d(!0))}catch(s){console.error("메시지 확인 오류:",s)}};p.useEffect(()=>{console.log("🔔 사용자 메시지 팝업 실시간 구독 시작:",e),m();const s=j.channel("user_message_popup").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`receiver_id=eq.${e}`},i=>{console.log("📨 새 메시지 도착:",i);const o=i.new;o.sender_type==="partner"&&o.receiver_type==="user"&&!o.parent_id&&(a(o),d(!0))}).subscribe();return()=>{console.log("🔕 사용자 메시지 팝업 구독 해제"),j.removeChannel(s)}},[e]);const l=async()=>{if(r)try{const{error:s}=await j.from("messages").update({status:"read",read_at:new Date().toISOString()}).eq("id",r.id);if(s)throw s;D.success("메시지를 확인했습니다."),d(!1),a(null),setTimeout(()=>{m()},500)}catch(s){console.error("메시지 읽음 처리 오류:",s),D.error("메시지 처리 중 오류가 발생했습니다.")}};return!n||!r?null:t.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/70 backdrop-blur-sm animate-in fade-in duration-300",children:t.jsxs(Me,{className:"w-full max-w-lg mx-4 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 border-2 border-yellow-500/50 shadow-2xl shadow-yellow-500/20",children:[t.jsx(Re,{className:"border-b border-yellow-500/30 bg-gradient-to-r from-yellow-600/20 to-red-600/20",children:t.jsx("div",{className:"flex items-center justify-between",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-yellow-500 to-amber-600 shadow-lg",children:t.jsx(J,{className:"w-6 h-6 text-white"})}),t.jsxs("div",{children:[t.jsx(Le,{className:"text-xl text-white font-bold",children:"📢 관리자 메시지"}),t.jsx("p",{className:"text-xs text-yellow-300 mt-1",children:new Date(r.created_at).toLocaleString("ko-KR")})]})]})})}),t.jsxs(Ue,{className:"pt-6 pb-6",children:[t.jsxs("div",{className:"mb-4",children:[t.jsx("div",{className:"text-sm text-yellow-400 font-medium mb-2",children:"제목"}),t.jsx("div",{className:"text-lg text-white font-semibold bg-slate-800/50 p-3 rounded-lg border border-slate-700",children:r.subject})]}),t.jsxs("div",{className:"mb-6",children:[t.jsx("div",{className:"text-sm text-yellow-400 font-medium mb-2",children:"내용"}),t.jsx("div",{className:"text-base text-slate-200 bg-slate-800/50 p-4 rounded-lg border border-slate-700 min-h-[120px] whitespace-pre-wrap",children:r.content})]}),t.jsx("div",{className:"flex justify-end",children:t.jsx(U,{onClick:l,className:"bg-gradient-to-r from-yellow-600 to-red-600 hover:from-yellow-700 hover:to-red-700 text-white font-bold px-8 py-6 text-lg shadow-lg shadow-yellow-500/30 border border-yellow-400/50",children:"확인"})}),t.jsx("div",{className:"mt-4 p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg",children:t.jsx("p",{className:"text-xs text-blue-300 text-center",children:"💡 메시지를 확인하시려면 '확인' 버튼을 눌러주세요."})})]})]})})}function Ms({user:e,currentRoute:r,onRouteChange:a,onLogout:n,children:d}){const m=p.useRef(new Set);p.useEffect(()=>(window.forceCloseGameWindow=s=>{const i=window.gameWindows,o=i?.get(s);return o&&!o.closed?(o.close(),i.delete(s),!0):!1},()=>{delete window.forceCloseGameWindow}),[]);const l=async s=>{if(m.current.has(s)){console.log(`⚠️ [보유금 동기화] 이미 진행 중: 세션 ${s}`);return}try{m.current.add(s),console.log(`💰 [보유금 동기화] 시작: 세션 ${s}`),console.log(`🔍 [보유금 동기화] 세션 조회 시작: sessionId=${s}`);const{data:i,error:o}=await j.from("game_launch_sessions").select(`
          user_id,
          users(
            username,
            referrer_id,
            partners:referrer_id(opcode, api_token, secret_key, username)
          )
        `).eq("id",s).single();if(console.log("🔍 [보유금 동기화] 세션 조회 결과:",{session:i,sessionError:o,hasUsers:!!i?.users}),o||!i||!i.users){console.error("❌ [보유금 동기화] 세션 조회 실패:",{sessionId:s,error:o,errorCode:o?.code,errorMessage:o?.message});return}const u=i.users.username,x=i.users.partners;if(console.log("🔍 [보유금 동기화] 파싱된 데이터:",{username:u,partner:x,referrer_id:i.users.referrer_id}),!u){console.error("❌ [보유금 동기화] username 없음");return}if(!x||!x.opcode){console.error("❌ [보유금 동기화] partner 정보 없음",{username:u,sessionId:s,referrer_id:i.users.referrer_id,partner:x});return}if(!x.api_token||!x.secret_key){console.error("❌ [보유금 동기화] API 설정 불완전",{opcode:x.opcode,hasApiToken:!!x.api_token,hasSecretKey:!!x.secret_key,apiTokenLength:x.api_token?.length||0,secretKeyLength:x.secret_key?.length||0}),console.error(`💡 해결 방법: partners 테이블에서 opcode='${x.opcode}'인 레코드에 api_token과 secret_key를 설정하세요.`),console.error(`SQL: UPDATE partners SET api_token = 'YOUR_TOKEN', secret_key = 'YOUR_SECRET' WHERE opcode = '${x.opcode}';`);return}console.log(`💰 [보유금 조회] API 호출: ${u} (opcode: ${x.opcode})`);const b=await Qe.getUserBalanceWithConfig(x.opcode,u,x.api_token,x.secret_key);if(b.success&&b.balance!==void 0){const{error:N}=await j.from("users").update({balance:b.balance,last_synced_at:new Date().toISOString()}).eq("id",i.user_id);N?console.error("❌ [보유금 동기화] DB 업데이트 실패:",N):console.log(`✅ [보유금 동기화] 완료: ${u} = ${b.balance}원`)}else console.error("❌ [보유금 동기화] API 조회 실패:",b.error)}catch(i){console.error("❌ [보유금 동기화] 오류:",i)}finally{m.current.delete(s)}};return p.useEffect(()=>{if(!e?.id)return;console.log("🚀 [세션 감지] 시작");const s=j.channel("user_session_monitor").on("postgres_changes",{event:"UPDATE",schema:"public",table:"game_launch_sessions",filter:`user_id=eq.${e.id}`},async i=>{const{new:o,old:u}=i;u?.status==="active"&&["ended","force_ended","auto_ended"].includes(o.status)&&(console.log("🛑 [세션 종료]",o.id,o.status),window.forceCloseGameWindow?.(o.id)&&o.status==="force_ended"?D.error("관리자에 의해 게임이 종료되었습니다."):o.status==="auto_ended"&&D.info("4분간 베팅이 없어 게임이 종료되었습니다."),await l(o.id))}).subscribe();return()=>{j.removeChannel(s)}},[e?.id]),p.useEffect(()=>(window.syncBalanceAfterGame=async s=>{try{console.log("🔄 [게임창 닫힘] 세션 종료:",s);const{error:i}=await j.from("game_launch_sessions").update({status:"ended",ended_at:new Date().toISOString()}).eq("id",s).eq("status","active");if(i){console.error("❌ [세션 종료 오류]:",i);return}await l(s)}catch(i){console.error("❌ [게임창 닫힘 오류]:",i)}},()=>{delete window.syncBalanceAfterGame,m.current.clear()}),[e.id]),t.jsxs("div",{className:"min-h-screen casino-gradient-bg overflow-x-hidden",children:[t.jsx("div",{className:"absolute top-0 left-0 right-0 h-96 bg-gradient-to-b from-yellow-500/10 via-red-500/5 to-transparent pointer-events-none"}),t.jsx(Bs,{user:e,currentRoute:r,onRouteChange:a,onLogout:n}),t.jsx($s,{userId:e.id}),t.jsx("main",{className:"relative pb-32 lg:pb-4 pt-20 lg:pt-20 overflow-x-hidden",children:t.jsx("div",{className:"container mx-auto px-3 sm:px-4 lg:px-6 py-6 relative z-10 max-w-full",children:d})}),t.jsx("div",{className:"fixed bottom-0 left-0 right-0 h-32 bg-gradient-to-t from-black/50 to-transparent pointer-events-none z-0"})]})}const jt=p.lazy(()=>P(()=>import("./UserCasino-BSg2hq7O.js"),__vite__mapDeps([42,1,43,6,3,4,29,7])).then(e=>({default:e.UserCasino}))),Rs=p.lazy(()=>P(()=>import("./UserSlot-CV3hTWM4.js"),__vite__mapDeps([44,1,43,6,3,4,29,7])).then(e=>({default:e.UserSlot}))),Ls=p.lazy(()=>P(()=>import("./UserDeposit-Ce6MN_vK.js"),__vite__mapDeps([45,1,12,3,4,6,7])).then(e=>({default:e.UserDeposit}))),Us=p.lazy(()=>P(()=>import("./UserWithdraw-NQF69HbZ.js"),__vite__mapDeps([46,1,12,15,4,3,6,7])).then(e=>({default:e.UserWithdraw}))),zs=p.lazy(()=>P(()=>import("./UserNotice-Dg0c_RqK.js"),__vite__mapDeps([47,1,15,4,3,6,48,7])).then(e=>({default:e.UserNotice}))),Fs=p.lazy(()=>P(()=>import("./UserSupport-BsARpDU5.js"),__vite__mapDeps([49,1,12,15,4,3,6,48,7])).then(e=>({default:e.UserSupport}))),qs=p.lazy(()=>P(()=>import("./UserProfile-Ivarh59_.js"),__vite__mapDeps([50,1,15,4,3,6,7])).then(e=>({default:e.UserProfile}))),Vs=p.lazy(()=>P(()=>import("./UserBettingHistory-CMHQ8mLH.js"),__vite__mapDeps([51,1,3,4,6,7])).then(e=>({default:e.UserBettingHistory}))),Gs=()=>t.jsx("div",{className:"flex items-center justify-center p-8",children:t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-400"})}),ir=p.memo(({currentRoute:e,user:r,onRouteChange:a})=>{const n=()=>{switch(e){case"/user/casino":return t.jsx(jt,{user:r,onRouteChange:a});case"/user/slot":return t.jsx(Rs,{user:r,onRouteChange:a});case"/user/deposit":return t.jsx(Ls,{user:r,onRouteChange:a});case"/user/withdraw":return t.jsx(Us,{user:r,onRouteChange:a});case"/user/notice":return t.jsx(zs,{user:r,onRouteChange:a});case"/user/support":return t.jsx(Fs,{user:r,onRouteChange:a});case"/user/profile":return t.jsx(qs,{user:r,onRouteChange:a});case"/user/betting-history":return t.jsx(Vs,{user:r});default:return t.jsx(jt,{user:r,onRouteChange:a})}};return t.jsx(p.Suspense,{fallback:t.jsx(Gs,{}),children:n()})});ir.displayName="UserRoutes";const lr=p.createContext(null);function tn(){const e=p.useContext(lr);if(!e)throw new Error("useMessageQueue must be used within a MessageQueueProvider");return e}const Nt=be.memo(({children:e,userType:r,userId:a})=>{const{sendMessage:n,lastMessage:d}=Ze(),[m,l]=p.useState([]),[s,i]=p.useState([]),[o,u]=p.useState(0),[x,b]=p.useState(!1),[N,w]=p.useState(null),y=p.useCallback(async()=>{if(r==="admin")try{const{data:f,error:S}=await j.from("message_queue").select("*").eq("status","pending").lte("scheduled_at",new Date().toISOString()).order("priority",{ascending:!0}).order("created_at",{ascending:!0}).limit(50);if(S)throw S;l(f||[])}catch(f){console.error("대기 메시지 조회 실패:",f)}},[r]),h=p.useCallback(async()=>{try{const{data:f,error:S}=await j.from("realtime_notifications").select("*").eq("recipient_type",r).eq("recipient_id",a).order("created_at",{ascending:!1}).limit(20);if(S)throw S;i(f||[]);const E=(f||[]).filter(C=>C.status!=="read").length;u(E)}catch(f){console.error("알림 조회 실패:",f)}},[r,a]),c=p.useCallback(async(f,S,E=5)=>{try{if(!f||typeof f!="string")return console.error("Invalid message type:",f),!1;const C=f.includes("request")?"admin":"user",I=S.target_user_id||a,{data:T,error:B}=await j.rpc("add_to_message_queue",{p_message_type:f,p_sender_type:r,p_sender_id:a,p_target_type:C,p_target_id:I,p_subject:S.subject||`${f} 메시지`,p_message_data:S,p_reference_type:S.reference_type||null,p_reference_id:S.reference_id||null,p_priority:E});if(B)throw B;return n(f,{...S,queue_id:T,sender:{type:r,id:a},timestamp:new Date().toISOString()}),!0}catch(C){return console.error("메시지 전송 실패:",C),!1}},[r,a,n]),g=p.useCallback(async()=>{if(!(r!=="admin"||x)){b(!0);try{const{data:f,error:S}=await j.rpc("process_message_queue");if(S)throw S;const E=f?.[0]?.processed_count||0;E>0&&(D.success(`${E}개의 메시지를 처리했습니다.`),await y(),await h()),w(new Date)}catch(f){console.error("메시지 처리 실패:",f),D.error("메시지 처리 중 오류가 발생했습니다.")}finally{b(!1)}}},[r,x,y,h]),k=p.useCallback(async f=>{try{const{error:S}=await j.rpc("mark_notification_as_read",{p_notification_id:f,p_recipient_id:a});if(S)throw S;i(E=>E.map(C=>C.id===f?{...C,status:"read",read_at:new Date().toISOString()}:C)),u(E=>Math.max(0,E-1))}catch(S){console.error("알림 읽음 처리 실패:",S)}},[a]),v=p.useCallback(async()=>{try{const f=s.filter(S=>S.status!=="read");for(const S of f)await k(S.id);D.success("모든 알림을 확인했습니다.")}catch(f){console.error("알림 일괄 처리 실패:",f),D.error("알림 처리 중 오류가 발생했습니다.")}},[s,k]);p.useEffect(()=>{if(!d)return;let f,S;if(d.type&&typeof d.type=="object"&&d.type.type)f=d.type.type,S=d.type.data||d.data||{};else if(typeof d.type=="string")f=d.type,S=d.data||{};else{console.error("Invalid message structure received:",d);return}if(!f||typeof f!="string"){console.error("Invalid message type received:",{messageType:f,messageData:S,lastMessage:d});return}if(console.log("📨 WebSocket 메시지 수신 (정규화됨):",{type:f,data:S}),(f.includes("request")||f.includes("approved")||f.includes("rejected")||f.includes("processed")||f.includes("completed"))&&(r==="admin"&&f.includes("request")||r==="user"&&(S.target_user_id===a||S.username===a))){const C=f.includes("request"),I=f.includes("approved")||f.includes("completed")||f.includes("processed")&&S.action==="approve"?"success":f.includes("rejected")||f.includes("processed")&&S.action==="reject"?"error":"info",T=f.includes("deposit")?"입금 알림":f.includes("withdrawal")?"출금 알림":f.includes("transaction_processed")?"거래 처리 알림":"거래 알림";let B="";if(f==="transaction_processed"){const{action:$,amount:V,newBalance:Z,processedBy:X}=S,pe=$==="approve"?"승인":"거절",fe=V?`₩${Number(V).toLocaleString()}`:"",ge=Z!==void 0?`잔고: ₩${Number(Z).toLocaleString()}`:"";B=`${pe}되었습니다. ${fe} ${ge} (처리자: ${X||"시스템"})`}I==="success"?D.success(T,{description:B||S.message||"처리가 완료되었습니다."}):I==="error"?D.error(T,{description:B||S.message||"요청이 거절되었습니다."}):D.info(T,{description:B||S.message||"새로운 요청이 있습니다.",duration:C?8e3:4e3}),setTimeout(()=>{h(),r==="admin"&&y()},500)}},[d,r,a,h,y]),p.useEffect(()=>{const f=j.channel("user-notifications").on("postgres_changes",{event:"*",schema:"public",table:"realtime_notifications",filter:`recipient_type=eq.${r}`},E=>{E.new&&E.new.recipient_id===a&&h()}).subscribe();let S=null;return r==="admin"&&(S=j.channel("admin-message-queue").on("postgres_changes",{event:"*",schema:"public",table:"message_queue"},()=>{y()}).subscribe()),()=>{f.unsubscribe(),S&&S.unsubscribe()}},[r,a,h,y]),p.useEffect(()=>{h(),r==="admin"&&y()},[h,y,r]),p.useEffect(()=>{if(r!=="admin")return;const f=setInterval(()=>{m.length>0&&!x&&g()},6e4);return()=>clearInterval(f)},[r,m.length,x,g]);const A={pendingMessages:m,sendMessage:c,processMessages:g,notifications:s,unreadCount:o,markAsRead:k,clearAllNotifications:v,isProcessing:x,lastProcessed:N},_=be.useMemo(()=>A,[m,c,g,s,o,k,v,x,N]);return t.jsx(lr.Provider,{value:_,children:e})});function Ws(){const{authState:e,logout:r}=ve(),[,a]=p.useState({});p.useEffect(()=>{const o=()=>a({});return window.addEventListener("popstate",o),()=>window.removeEventListener("popstate",o)},[]);const n=o=>{window.history.pushState({},"",o),a({})},d=window.location.pathname;if(d==="/"||d==="")return window.history.replaceState({},"","/user"),window.location.pathname="/user",null;const m=d.startsWith("/user"),l=d.startsWith("/admin");if(m){const o=d,u=localStorage.getItem("user_session");let x=null;try{u&&(x=JSON.parse(u))}catch(w){console.error("사용자 세션 파싱 오류:",w),localStorage.removeItem("user_session")}const b=!!x,N=async()=>{if(!x?.id){localStorage.removeItem("user_session"),window.history.replaceState({},"","/user"),a({});return}try{console.log("🔓 사용자 로그아웃 처리 시작:",x.id);const{error:w}=await j.from("users").update({is_online:!1,updated_at:new Date().toISOString()}).eq("id",x.id);w?console.error("❌ is_online 업데이트 오류:",w):console.log("✅ is_online = false 업데이트 완료");const{error:y}=await j.from("user_sessions").update({is_active:!1,logout_at:new Date().toISOString()}).eq("user_id",x.id).eq("is_active",!0);y?console.error("❌ user_sessions 종료 오류:",y):console.log("✅ user_sessions 종료 완료"),console.log("ℹ️ game_launch_sessions는 게임창 닫힘 시에만 종료됨 (로그아웃 시 유지)"),await j.from("activity_logs").insert([{actor_type:"user",actor_id:x.id,action:"logout",details:{username:x.username,logout_time:new Date().toISOString()}}]),console.log("✅ 로그아웃 처리 완료")}catch(w){console.error("❌ 로그아웃 처리 오류:",w)}finally{localStorage.removeItem("user_session"),window.history.replaceState({},"","/user"),a({})}};return t.jsxs(t.Fragment,{children:[b?t.jsx(ht,{children:t.jsx(Nt,{userType:"user",userId:x.id,children:t.jsx(Ms,{user:x,currentRoute:o,onRouteChange:n,onLogout:N,children:t.jsx(ir,{currentRoute:o,user:x,onRouteChange:n})})})}):t.jsx(Ns,{onLoginSuccess:w=>{localStorage.setItem("user_session",JSON.stringify(w)),window.history.replaceState({},"","/user/casino"),a({})}}),t.jsx(pt,{position:"top-right"})]})}const s=l&&d!=="/admin"&&d!=="/admin/"?d:"/admin/dashboard",i=e.isAuthenticated&&e.user;return t.jsxs(t.Fragment,{children:[i?t.jsx(ht,{children:t.jsx(Da,{user:e.user,children:t.jsx(Nt,{userType:"admin",userId:e.user.id,children:t.jsx(Fa,{currentRoute:s,onNavigate:n,children:t.jsx(ds,{currentRoute:s,user:e.user})})})})}):t.jsx(ma,{onLoginSuccess:()=>{window.history.replaceState({},"","/admin/dashboard"),a({})}}),t.jsx(pt,{position:"top-right"})]})}function Ks(){return t.jsx(za,{children:t.jsx(Ws,{})})}dr.createRoot(document.getElementById("root")).render(t.jsx(Ks,{}));export{Ma as $,Qt as A,Rt as B,Me as C,$a as D,Je as E,Ke as F,Qe as G,O as H,z as I,ze as J,tn as K,F as L,Ps as M,Lt as N,Fe as O,Ut as P,ie as Q,He as R,hs as S,fs as T,en as U,ms as V,ps as W,we as X,M as Y,R as Z,Ia as _,Re as a,Le as b,Y as c,Bt as d,Ue as e,ft as f,Zs as g,te as h,U as i,gs as j,wt as k,yt as l,na as m,ve as n,Ze as o,bs as p,xs as q,_s as r,j as s,ws as t,Ca as u,Ft as v,ue as w,me as x,Vt as y,Gt as z};
