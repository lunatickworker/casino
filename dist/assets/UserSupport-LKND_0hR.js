import{k as Y,r as n,s as u,t as m,j as e,w as h,E as w,S as I,x as L,y as T,z as $,D as p,I as E,C as F,e as R,a as ee,b as se,aL as O,L as te,B,l as y,b1 as ae,$ as le,aA as re}from"./index-DuEcnhwm.js";import{T as ne}from"./textarea-DBQhSv6D.js";import{D as ie,f as ce,a as oe,b as de,c as xe,d as he}from"./dialog-BlSexbtz.js";import{C as ue,b as me,a as pe}from"./collapsible-ByBOKHiD.js";import{P as A}from"./plus-CMxSp9_h.js";import{S as je}from"./send-78vZmhjh.js";import{S as be}from"./search-DyNhXeLR.js";import{C as fe}from"./calendar-C1fb4yjl.js";import{C as ge}from"./clock-CHydOgIN.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=[["path",{d:"M7.9 20A9 9 0 1 0 4 16.1L2 22Z",key:"vv11sd"}]],H=Y("message-circle",Ne),U=[{value:"deposit",label:"입금 문의"},{value:"withdrawal",label:"출금 문의"},{value:"game",label:"게임 문의"},{value:"account",label:"계정 문의"},{value:"bonus",label:"보너스 문의"},{value:"technical",label:"기술 문의"},{value:"other",label:"기타 문의"}];function Te({user:l,onRouteChange:ve}){const[f,C]=n.useState([]),[g,N]=n.useState([]),[V,S]=n.useState(!0),[_,D]=n.useState(!1),[z,j]=n.useState(!1),[x,M]=n.useState(""),[c,k]=n.useState("all"),[P,Q]=n.useState([]),[i,b]=n.useState({category:"",subject:"",content:""}),[we,ye]=n.useState({}),v=async()=>{try{S(!0);const{data:s,error:t}=await u.from("messages").select("*").or(`sender_id.eq.${l.id},receiver_id.eq.${l.id}`).order("created_at",{ascending:!1});if(t)throw t;const a={},r=[];(s||[]).forEach(d=>{d.parent_id?(a[d.parent_id]||(a[d.parent_id]=[]),a[d.parent_id].push(d)):r.push(d)});const o=r.map(d=>({...d,replies:a[d.id]||[]}));C(o),N(o)}catch(s){console.error("문의 내역 조회 오류:",s),m.error("문의 내역을 불러오는데 실패했습니다.")}finally{S(!1)}},K=async s=>{if(s.preventDefault(),!i.category||!i.subject.trim()||!i.content.trim()){m.error("모든 필수 항목을 입력해주세요.");return}D(!0);try{const t={sender_type:"user",sender_id:l.id,receiver_type:"partner",receiver_id:l.referrer_id,subject:`[${U.find(o=>o.value===i.category)?.label}] ${i.subject}`,content:i.content,message_type:"normal",status:"unread"},{data:a,error:r}=await u.from("messages").insert([t]).select().single();if(r)throw r;await u.from("activity_logs").insert([{actor_type:"user",actor_id:l.id,action:"inquiry_submit",target_type:"message",target_id:a.id,details:{category:i.category,subject:i.subject}}]),b({category:"",subject:"",content:""}),j(!1),v(),m.success("문의가 등록되었습니다. 빠른 시일 내에 답변드리겠습니다.")}catch(t){console.error("문의 등록 오류:",t),m.error(t.message||"문의 등록 중 오류가 발생했습니다.")}finally{D(!1)}},W=async s=>{try{await u.from("messages").update({status:"read",read_at:new Date().toISOString()}).eq("id",s).eq("receiver_id",l.id),C(t=>t.map(a=>a.id===s?{...a,status:"read",read_at:new Date().toISOString()}:a)),N(t=>t.map(a=>a.id===s?{...a,status:"read",read_at:new Date().toISOString()}:a))}catch(t){console.error("읽음 처리 오류:",t)}},Z=s=>{Q(a=>a.includes(s)?a.filter(r=>r!==s):[...a,s]);const t=f.find(a=>a.id===s);t&&t.receiver_id===l.id&&t.status==="unread"&&W(s)},G=()=>{let s=f;c!=="all"&&(s=s.filter(t=>c==="waiting"?t.sender_id===l.id&&t.status!=="replied":c==="replied"?t.replies&&t.replies.length>0:c==="unread"?t.receiver_id===l.id&&t.status==="unread":t.status===c)),x.trim()&&(s=s.filter(t=>t.subject.toLowerCase().includes(x.toLowerCase())||t.content.toLowerCase().includes(x.toLowerCase()))),N(s)},J=s=>s.sender_id===l.id?s.replies&&s.replies.length>0?{color:"bg-green-500",textColor:"text-green-400",icon:re,label:"답변완료"}:{color:"bg-yellow-500",textColor:"text-yellow-400",icon:ge,label:"답변대기"}:s.status==="unread"?{color:"bg-blue-500",textColor:"text-blue-400",icon:H,label:"새 답변"}:{color:"bg-slate-500",textColor:"text-slate-400",icon:H,label:"답변"},q=s=>new Date(s).toLocaleString("ko-KR"),X=s=>{const t=new Date,a=new Date(s),r=Math.floor((t.getTime()-a.getTime())/(1e3*60*60));return r<1?"방금 전":r<24?`${r}시간 전`:`${Math.floor(r/24)}일 전`};return n.useEffect(()=>{v();const s=u.channel("support_messages").on("postgres_changes",{event:"*",schema:"public",table:"messages",filter:`receiver_id=eq.${l.id}`},t=>{t.eventType==="INSERT"&&(v(),m.info("새로운 답변이 도착했습니다."))}).subscribe();return()=>s.unsubscribe()},[l.id]),n.useEffect(()=>{G()},[f,x,c]),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"고객센터"}),e.jsx("p",{className:"text-slate-400",children:"궁금한 사항을 문의해주세요. 빠르게 답변드리겠습니다."})]}),e.jsxs(ie,{open:z,onOpenChange:j,children:[e.jsx(ce,{asChild:!0,children:e.jsxs(h,{className:"bg-green-600 hover:bg-green-700",children:[e.jsx(A,{className:"w-4 h-4 mr-2"}),"새 문의하기"]})}),e.jsxs(oe,{className:"max-w-2xl bg-slate-800 border-slate-700 text-white",children:[e.jsxs(de,{children:[e.jsx(xe,{children:"새 문의 작성"}),e.jsx(he,{className:"text-slate-400",children:"문의 사항을 작성하시면 관리자가 확인 후 답변드립니다."})]}),e.jsxs("form",{onSubmit:K,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"category",className:"text-slate-300",children:"문의 유형 *"}),e.jsxs(I,{value:i.category,onValueChange:s=>b(t=>({...t,category:s})),children:[e.jsx(L,{className:"bg-slate-700/50 border-slate-600 text-white",children:e.jsx(T,{placeholder:"문의 유형을 선택하세요"})}),e.jsx($,{className:"bg-slate-800 border-slate-700",children:U.map(s=>e.jsx(p,{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"subject",className:"text-slate-300",children:"제목 *"}),e.jsx(E,{id:"subject",placeholder:"문의 제목을 입력하세요",value:i.subject,onChange:s=>b(t=>({...t,subject:s.target.value})),className:"bg-slate-700/50 border-slate-600 text-white"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"content",className:"text-slate-300",children:"내용 *"}),e.jsx(ne,{id:"content",placeholder:"문의 내용을 자세히 작성해주세요",value:i.content,onChange:s=>b(t=>({...t,content:s.target.value})),className:"bg-slate-700/50 border-slate-600 text-white min-h-32"})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(h,{type:"button",variant:"outline",onClick:()=>j(!1),className:"flex-1",children:"취소"}),e.jsx(h,{type:"submit",disabled:_,className:"flex-1 bg-green-600 hover:bg-green-700",children:_?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"등록 중..."]}):e.jsxs(e.Fragment,{children:[e.jsx(je,{className:"w-4 h-4 mr-2"}),"문의 등록"]})})]})]})]})]})]}),e.jsx(F,{className:"bg-slate-800/50 border-slate-700",children:e.jsx(R,{className:"p-4",children:e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(be,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4"}),e.jsx(E,{placeholder:"제목이나 내용으로 검색...",value:x,onChange:s=>M(s.target.value),className:"pl-10 bg-slate-700/50 border-slate-600 text-white"})]})}),e.jsxs(I,{value:c,onValueChange:k,children:[e.jsx(L,{className:"w-48 bg-slate-700/50 border-slate-600 text-white",children:e.jsx(T,{})}),e.jsxs($,{className:"bg-slate-800 border-slate-700",children:[e.jsx(p,{value:"all",children:"전체"}),e.jsx(p,{value:"waiting",children:"답변대기"}),e.jsx(p,{value:"replied",children:"답변완료"}),e.jsx(p,{value:"unread",children:"읽지않음"})]})]})]})})}),e.jsxs(F,{className:"bg-slate-800/50 border-slate-700",children:[e.jsx(ee,{children:e.jsxs(se,{className:"flex items-center text-white",children:[e.jsx(O,{className:"w-5 h-5 mr-2 text-blue-400"}),"문의 내역 (",g.length,")"]})}),e.jsx(R,{children:V?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(te,{})}):g.length>0?e.jsx("div",{className:"space-y-4",children:g.map(s=>{const t=J(s),a=t.icon,r=P.includes(s.id);return e.jsx("div",{className:"p-4 bg-slate-700/30 rounded-lg",children:e.jsxs(ue,{open:r,onOpenChange:()=>Z(s.id),children:[e.jsx(me,{asChild:!0,children:e.jsxs("div",{className:"flex items-start justify-between cursor-pointer hover:bg-slate-700/50 p-2 -m-2 rounded",children:[e.jsxs("div",{className:"flex items-start gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:`w-2 h-2 rounded-full mt-2 flex-shrink-0 ${s.receiver_id===l.id&&s.status==="unread"?"bg-blue-400":"bg-slate-500"}`}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(a,{className:`w-4 h-4 ${t.textColor}`}),e.jsx(B,{className:`${t.color} text-white text-xs`,children:t.label}),s.replies&&s.replies.length>0&&e.jsxs(B,{variant:"outline",className:"text-xs",children:[s.replies.length,"개 답변"]})]}),e.jsx("h3",{className:"font-medium text-white truncate",children:s.subject}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-slate-500 mt-1",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(fe,{className:"w-3 h-3"}),X(s.created_at)]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(y,{className:"w-3 h-3"}),s.sender_id===l.id?"내 문의":"관리자 답변"]})]})]})]}),e.jsx(h,{variant:"ghost",size:"sm",className:"flex-shrink-0",children:r?e.jsx(ae,{className:"w-4 h-4"}):e.jsx(le,{className:"w-4 h-4"})})]})}),e.jsx(pe,{children:e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{className:"p-4 bg-slate-600/30 rounded border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(y,{className:"w-4 h-4 text-blue-400"}),e.jsx("span",{className:"text-sm font-medium text-blue-400",children:s.sender_id===l.id?l.nickname:"관리자"}),e.jsx("span",{className:"text-xs text-slate-500",children:q(s.created_at)})]}),e.jsx("div",{className:"text-slate-300 text-sm whitespace-pre-wrap",children:s.content})]}),s.replies&&s.replies.map(o=>e.jsxs("div",{className:"p-4 bg-slate-600/30 rounded border-l-4 border-green-500 ml-8",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(y,{className:"w-4 h-4 text-green-400"}),e.jsx("span",{className:"text-sm font-medium text-green-400",children:o.sender_id===l.id?l.nickname:"관리자"}),e.jsx("span",{className:"text-xs text-slate-500",children:q(o.created_at)})]}),e.jsx("div",{className:"text-slate-300 text-sm whitespace-pre-wrap",children:o.content})]},o.id))]})})]})},s.id)})}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(O,{className:"w-16 h-16 text-slate-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-medium text-white mb-2",children:x||c!=="all"?"검색 결과가 없습니다":"문의 내역이 없습니다"}),e.jsx("p",{className:"text-slate-400 mb-4",children:x||c!=="all"?"검색 조건을 변경해보세요.":"궁금한 사항이 있으시면 언제든 문의해주세요."}),x||c!=="all"?e.jsx(h,{variant:"outline",onClick:()=>{M(""),k("all")},children:"전체 문의 보기"}):e.jsxs(h,{onClick:()=>j(!0),className:"bg-green-600 hover:bg-green-700",children:[e.jsx(A,{className:"w-4 h-4 mr-2"}),"첫 문의하기"]})]})})]})]})}export{Te as UserSupport};
