import{s as _}from"./index-B-OPgV84.js";import"./react-core-CwM-CeLv.js";import"./vendor-CQn7sZ7L.js";import"./radix-ui-SX2QAG6c.js";import"./lucide-icons-D2Y5yybo.js";import"./supabase-r6ABpEO8.js";async function d(a){const o=[],e=[a];let n=[a];for(let t=0;t<5&&n.length!==0;t++){const{data:i}=await _.from("partners").select("id").in("parent_id",n);if(i&&i.length>0){const l=i.map(r=>r.id);e.push(...l),n=l}else break}if(e.length>0){const{data:t}=await _.from("users").select("id").in("referrer_id",e);t&&o.push(...t.map(i=>i.id))}return o}async function u(a,o,e){if(a.length===0)return{totalBetAmount:0,totalLossAmount:0};const{data:n,error:t}=await _.from("game_records").select("bet_amount, win_amount").in("user_id",a).gte("played_at",o).lte("played_at",e);if(t)return console.error("베팅 데이터 조회 오류:",t),{totalBetAmount:0,totalLossAmount:0};if(!n||n.length===0)return{totalBetAmount:0,totalLossAmount:0};let i=0,l=0;for(const r of n){const s=r.bet_amount||0,m=r.win_amount||0;i+=s;const c=s-m;c>0&&(l+=c)}return{totalBetAmount:i,totalLossAmount:l}}async function g(a,o,e){if(a.length===0)return 0;const{data:n,error:t}=await _.from("transactions").select("amount").in("user_id",a).eq("transaction_type","withdrawal").eq("status","approved").gte("created_at",o).lte("created_at",e);return t?(console.error("출금 데이터 조회 오류:",t),0):n?n.reduce((i,l)=>i+(l.amount||0),0):0}async function h(a,o,e,n){try{const t=await d(a);if(t.length===0)return{partner_id:a,partner_username:o.username,partner_nickname:o.nickname,partner_level:o.level,commission_rolling:o.commission_rolling,commission_losing:o.commission_losing,withdrawal_fee:o.withdrawal_fee,total_bet_amount:0,total_loss_amount:0,total_withdrawal_amount:0,rolling_commission:0,losing_commission:0,withdrawal_commission:0,total_commission:0};const{totalBetAmount:i,totalLossAmount:l}=await u(t,e,n),r=await g(t,e,n),s=i*(o.commission_rolling/100),m=l*(o.commission_losing/100),c=r*(o.withdrawal_fee/100),w=s+m+c;return{partner_id:a,partner_username:o.username,partner_nickname:o.nickname,partner_level:o.level,commission_rolling:o.commission_rolling,commission_losing:o.commission_losing,withdrawal_fee:o.withdrawal_fee,total_bet_amount:i,total_loss_amount:l,total_withdrawal_amount:r,rolling_commission:s,losing_commission:m,withdrawal_commission:c,total_commission:w}}catch(t){return console.error("파트너 커미션 계산 실패:",t),{partner_id:a,partner_username:o.username,partner_nickname:o.nickname,partner_level:o.level,commission_rolling:o.commission_rolling,commission_losing:o.commission_losing,withdrawal_fee:o.withdrawal_fee,total_bet_amount:0,total_loss_amount:0,total_withdrawal_amount:0,rolling_commission:0,losing_commission:0,withdrawal_commission:0,total_commission:0}}}async function v(a,o,e){try{const{data:n,error:t}=await _.from("partners").select("id, username, nickname, level, commission_rolling, commission_losing, withdrawal_fee").eq("parent_id",a).order("level").order("nickname");if(t)return console.error("하위 파트너 조회 오류:",t),[];if(!n||n.length===0)return[];const i=n.map(r=>h(r.id,r,o,e));return await Promise.all(i)}catch(n){return console.error("하위 파트너 커미션 계산 실패:",n),[]}}async function f(a,o,e,n){try{const t=await d(a);if(t.length===0)return{rolling:0,losing:0,withdrawal:0,total:0};const{totalBetAmount:i,totalLossAmount:l}=await u(t,e,n),r=await g(t,e,n),s=i*(o.rolling/100),m=l*(o.losing/100),c=r*(o.withdrawal/100);return{rolling:s,losing:m,withdrawal:c,total:s+m+c}}catch(t){return console.error("내 수입 계산 실패:",t),{rolling:0,losing:0,withdrawal:0,total:0}}}async function y(a,o,e){try{const{data:n,error:t}=await _.from("partners").select("id, nickname, commission_rolling, commission_losing, withdrawal_fee").eq("parent_id",a);if(t)return console.error("하위 파트너 조회 오류:",t),{totalRolling:0,totalLosing:0,totalWithdrawal:0,total:0,details:[]};if(!n||n.length===0)return{totalRolling:0,totalLosing:0,totalWithdrawal:0,total:0,details:[]};const i=n.map(c=>p(c,o,e)),l=await Promise.all(i);let r=0,s=0,m=0;for(const c of l)r+=c.rolling_payment,s+=c.losing_payment,m+=c.withdrawal_payment;return{totalRolling:r,totalLosing:s,totalWithdrawal:m,total:r+s+m,details:l}}catch(n){return console.error("파트너 지급 계산 실패:",n),{totalRolling:0,totalLosing:0,totalWithdrawal:0,total:0,details:[]}}}async function p(a,o,e){try{const n=await d(a.id);if(n.length===0)return{partner_id:a.id,partner_nickname:a.nickname,rolling_payment:0,losing_payment:0,withdrawal_payment:0,total_payment:0};const{totalBetAmount:t,totalLossAmount:i}=await u(n,o,e),l=await g(n,o,e),r=t*(a.commission_rolling/100),s=i*(a.commission_losing/100),m=l*(a.withdrawal_fee/100);return{partner_id:a.id,partner_nickname:a.nickname,rolling_payment:r,losing_payment:s,withdrawal_payment:m,total_payment:r+s+m}}catch(n){return console.error("파트너 지급 계산 실패:",n),{partner_id:a.id,partner_nickname:a.nickname,rolling_payment:0,losing_payment:0,withdrawal_payment:0,total_payment:0}}}async function b(a,o,e,n){try{const t=await f(a,o,e,n),i=await y(a,e,n);return{myRollingIncome:t.rolling,myLosingIncome:t.losing,myWithdrawalIncome:t.withdrawal,myTotalIncome:t.total,partnerRollingPayments:i.totalRolling,partnerLosingPayments:i.totalLosing,partnerWithdrawalPayments:i.totalWithdrawal,partnerTotalPayments:i.total,netRollingProfit:t.rolling-i.totalRolling,netLosingProfit:t.losing-i.totalLosing,netWithdrawalProfit:t.withdrawal-i.totalWithdrawal,netTotalProfit:t.total-i.total}}catch(t){return console.error("통합 정산 계산 실패:",t),{myRollingIncome:0,myLosingIncome:0,myWithdrawalIncome:0,myTotalIncome:0,partnerRollingPayments:0,partnerLosingPayments:0,partnerWithdrawalPayments:0,partnerTotalPayments:0,netRollingProfit:0,netLosingProfit:0,netWithdrawalProfit:0,netTotalProfit:0}}}async function R(a,o,e){if(a.length===0)return 0;const{data:n,error:t}=await _.from("transactions").select("amount").eq("transaction_type","deposit").eq("status","pending").in("user_id",a).gte("created_at",o).lte("created_at",e);return t?(console.error("만충금 조회 오류:",t),0):n?n.reduce((i,l)=>i+Number(l.amount),0):0}export{v as calculateChildPartnersCommission,b as calculateIntegratedSettlement,f as calculateMyIncome,h as calculatePartnerCommission,y as calculatePartnerPayments,R as calculatePendingDeposits,u as getBettingStats,d as getDescendantUserIds,g as getWithdrawalAmount};
