import{r as n,j as e}from"./react-core-CwM-CeLv.js";import{s as u,m as h,l as w,S as k,p as I,q as E,r as L,t as m,I as $,C as F,e as R,a as Z,b as ee,L as se,B as O}from"./index-B_UTQDGv.js";import{T as te}from"./textarea-DFPvBWH6.js";import{D as ae,f as le,a as re,b as ne,c as ie,d as ce}from"./dialog-DIaN7ysW.js";import{C as oe,b as de,a as xe}from"./collapsible-Bk9eB6pG.js";import{k as p}from"./vendor-CQn7sZ7L.js";import{P as B,an as he,K as ue,c as H,ab as me,s as y,l as pe,g as je,n as be,t as fe,aE as U}from"./lucide-icons-wLPRtdhM.js";import"./radix-ui-SX2QAG6c.js";import"./supabase-r6ABpEO8.js";const V=[{value:"deposit",label:"입금 문의"},{value:"withdrawal",label:"출금 문의"},{value:"game",label:"게임 문의"},{value:"account",label:"계정 문의"},{value:"bonus",label:"보너스 문의"},{value:"technical",label:"기술 문의"},{value:"other",label:"기타 문의"}];function ke({user:l,onRouteChange:ge}){const[f,C]=n.useState([]),[g,N]=n.useState([]),[K,S]=n.useState(!0),[_,D]=n.useState(!1),[P,j]=n.useState(!1),[x,q]=n.useState(""),[c,M]=n.useState("all"),[Q,z]=n.useState([]),[i,b]=n.useState({category:"",subject:"",content:""}),[Ne,ve]=n.useState({}),v=async()=>{try{S(!0);const{data:s,error:t}=await u.from("messages").select("*").or(`sender_id.eq.${l.id},receiver_id.eq.${l.id}`).order("created_at",{ascending:!1});if(t)throw t;const a={},r=[];(s||[]).forEach(d=>{d.parent_id?(a[d.parent_id]||(a[d.parent_id]=[]),a[d.parent_id].push(d)):r.push(d)});const o=r.map(d=>({...d,replies:a[d.id]||[]}));C(o),N(o)}catch(s){console.error("문의 내역 조회 오류:",s),p.error("문의 내역을 불러오는데 실패했습니다.")}finally{S(!1)}},A=async s=>{if(s.preventDefault(),!i.category||!i.subject.trim()||!i.content.trim()){p.error("모든 필수 항목을 입력해주세요.");return}D(!0);try{const t={sender_type:"user",sender_id:l.id,receiver_type:"partner",receiver_id:l.referrer_id,subject:`[${V.find(o=>o.value===i.category)?.label}] ${i.subject}`,content:i.content,message_type:"normal",status:"unread"},{data:a,error:r}=await u.from("messages").insert([t]).select().single();if(r)throw r;await u.from("activity_logs").insert([{actor_type:"user",actor_id:l.id,action:"inquiry_submit",target_type:"message",target_id:a.id,details:{category:i.category,subject:i.subject}}]),b({category:"",subject:"",content:""}),j(!1),v(),p.success("문의가 등록되었습니다. 빠른 시일 내에 답변드리겠습니다.")}catch(t){console.error("문의 등록 오류:",t),p.error(t.message||"문의 등록 중 오류가 발생했습니다.")}finally{D(!1)}},W=async s=>{try{await u.from("messages").update({status:"read",read_at:new Date().toISOString()}).eq("id",s).eq("receiver_id",l.id),C(t=>t.map(a=>a.id===s?{...a,status:"read",read_at:new Date().toISOString()}:a)),N(t=>t.map(a=>a.id===s?{...a,status:"read",read_at:new Date().toISOString()}:a))}catch(t){console.error("읽음 처리 오류:",t)}},G=s=>{z(a=>a.includes(s)?a.filter(r=>r!==s):[...a,s]);const t=f.find(a=>a.id===s);t&&t.receiver_id===l.id&&t.status==="unread"&&W(s)},J=()=>{let s=f;c!=="all"&&(s=s.filter(t=>c==="waiting"?t.sender_id===l.id&&t.status!=="replied":c==="replied"?t.replies&&t.replies.length>0:c==="unread"?t.receiver_id===l.id&&t.status==="unread":t.status===c)),x.trim()&&(s=s.filter(t=>t.subject.toLowerCase().includes(x.toLowerCase())||t.content.toLowerCase().includes(x.toLowerCase()))),N(s)},X=s=>s.sender_id===l.id?s.replies&&s.replies.length>0?{color:"bg-green-500",textColor:"text-green-400",icon:be,label:"답변완료"}:{color:"bg-yellow-500",textColor:"text-yellow-400",icon:fe,label:"답변대기"}:s.status==="unread"?{color:"bg-blue-500",textColor:"text-blue-400",icon:U,label:"새 답변"}:{color:"bg-slate-500",textColor:"text-slate-400",icon:U,label:"답변"},T=s=>new Date(s).toLocaleString("ko-KR"),Y=s=>{const t=new Date,a=new Date(s),r=Math.floor((t.getTime()-a.getTime())/(1e3*60*60));return r<1?"방금 전":r<24?`${r}시간 전`:`${Math.floor(r/24)}일 전`};return n.useEffect(()=>{v();const s=u.channel("support_messages").on("postgres_changes",{event:"*",schema:"public",table:"messages",filter:`receiver_id=eq.${l.id}`},t=>{t.eventType==="INSERT"&&(v(),p.info("새로운 답변이 도착했습니다."))}).subscribe();return()=>s.unsubscribe()},[l.id]),n.useEffect(()=>{J()},[f,x,c]),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"고객센터"}),e.jsx("p",{className:"text-slate-400",children:"궁금한 사항을 문의해주세요. 빠르게 답변드리겠습니다."})]}),e.jsxs(ae,{open:P,onOpenChange:j,children:[e.jsx(le,{asChild:!0,children:e.jsxs(h,{className:"bg-green-600 hover:bg-green-700",children:[e.jsx(B,{className:"w-4 h-4 mr-2"}),"새 문의하기"]})}),e.jsxs(re,{className:"max-w-2xl bg-slate-800 border-slate-700 text-white",children:[e.jsxs(ne,{children:[e.jsx(ie,{children:"새 문의 작성"}),e.jsx(ce,{className:"text-slate-400",children:"문의 사항을 작성하시면 관리자가 확인 후 답변드립니다."})]}),e.jsxs("form",{onSubmit:A,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"category",className:"text-slate-300",children:"문의 유형 *"}),e.jsxs(k,{value:i.category,onValueChange:s=>b(t=>({...t,category:s})),children:[e.jsx(I,{className:"bg-slate-700/50 border-slate-600 text-white",children:e.jsx(E,{placeholder:"문의 유형을 선택하세요"})}),e.jsx(L,{className:"bg-slate-800 border-slate-700",children:V.map(s=>e.jsx(m,{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"subject",className:"text-slate-300",children:"제목 *"}),e.jsx($,{id:"subject",placeholder:"문의 제목을 입력하세요",value:i.subject,onChange:s=>b(t=>({...t,subject:s.target.value})),className:"bg-slate-700/50 border-slate-600 text-white"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"content",className:"text-slate-300",children:"내용 *"}),e.jsx(te,{id:"content",placeholder:"문의 내용을 자세히 작성해주세요",value:i.content,onChange:s=>b(t=>({...t,content:s.target.value})),className:"bg-slate-700/50 border-slate-600 text-white min-h-32"})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(h,{type:"button",variant:"outline",onClick:()=>j(!1),className:"flex-1",children:"취소"}),e.jsx(h,{type:"submit",disabled:_,className:"flex-1 bg-green-600 hover:bg-green-700",children:_?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"등록 중..."]}):e.jsxs(e.Fragment,{children:[e.jsx(he,{className:"w-4 h-4 mr-2"}),"문의 등록"]})})]})]})]})]})]}),e.jsx(F,{className:"bg-slate-800/50 border-slate-700",children:e.jsx(R,{className:"p-4",children:e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(ue,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4"}),e.jsx($,{placeholder:"제목이나 내용으로 검색...",value:x,onChange:s=>q(s.target.value),className:"pl-10 bg-slate-700/50 border-slate-600 text-white"})]})}),e.jsxs(k,{value:c,onValueChange:M,children:[e.jsx(I,{className:"w-48 bg-slate-700/50 border-slate-600 text-white",children:e.jsx(E,{})}),e.jsxs(L,{className:"bg-slate-800 border-slate-700",children:[e.jsx(m,{value:"all",children:"전체"}),e.jsx(m,{value:"waiting",children:"답변대기"}),e.jsx(m,{value:"replied",children:"답변완료"}),e.jsx(m,{value:"unread",children:"읽지않음"})]})]})]})})}),e.jsxs(F,{className:"bg-slate-800/50 border-slate-700",children:[e.jsx(Z,{children:e.jsxs(ee,{className:"flex items-center text-white",children:[e.jsx(H,{className:"w-5 h-5 mr-2 text-blue-400"}),"문의 내역 (",g.length,")"]})}),e.jsx(R,{children:K?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(se,{})}):g.length>0?e.jsx("div",{className:"space-y-4",children:g.map(s=>{const t=X(s),a=t.icon,r=Q.includes(s.id);return e.jsx("div",{className:"p-4 bg-slate-700/30 rounded-lg",children:e.jsxs(oe,{open:r,onOpenChange:()=>G(s.id),children:[e.jsx(de,{asChild:!0,children:e.jsxs("div",{className:"flex items-start justify-between cursor-pointer hover:bg-slate-700/50 p-2 -m-2 rounded",children:[e.jsxs("div",{className:"flex items-start gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:`w-2 h-2 rounded-full mt-2 flex-shrink-0 ${s.receiver_id===l.id&&s.status==="unread"?"bg-blue-400":"bg-slate-500"}`}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(a,{className:`w-4 h-4 ${t.textColor}`}),e.jsx(O,{className:`${t.color} text-white text-xs`,children:t.label}),s.replies&&s.replies.length>0&&e.jsxs(O,{variant:"outline",className:"text-xs",children:[s.replies.length,"개 답변"]})]}),e.jsx("h3",{className:"font-medium text-white truncate",children:s.subject}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-slate-500 mt-1",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(me,{className:"w-3 h-3"}),Y(s.created_at)]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(y,{className:"w-3 h-3"}),s.sender_id===l.id?"내 문의":"관리자 답변"]})]})]})]}),e.jsx(h,{variant:"ghost",size:"sm",className:"flex-shrink-0",children:r?e.jsx(pe,{className:"w-4 h-4"}):e.jsx(je,{className:"w-4 h-4"})})]})}),e.jsx(xe,{children:e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{className:"p-4 bg-slate-600/30 rounded border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(y,{className:"w-4 h-4 text-blue-400"}),e.jsx("span",{className:"text-sm font-medium text-blue-400",children:s.sender_id===l.id?l.nickname:"관리자"}),e.jsx("span",{className:"text-xs text-slate-500",children:T(s.created_at)})]}),e.jsx("div",{className:"text-slate-300 text-sm whitespace-pre-wrap",children:s.content})]}),s.replies&&s.replies.map(o=>e.jsxs("div",{className:"p-4 bg-slate-600/30 rounded border-l-4 border-green-500 ml-8",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(y,{className:"w-4 h-4 text-green-400"}),e.jsx("span",{className:"text-sm font-medium text-green-400",children:o.sender_id===l.id?l.nickname:"관리자"}),e.jsx("span",{className:"text-xs text-slate-500",children:T(o.created_at)})]}),e.jsx("div",{className:"text-slate-300 text-sm whitespace-pre-wrap",children:o.content})]},o.id))]})})]})},s.id)})}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(H,{className:"w-16 h-16 text-slate-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-medium text-white mb-2",children:x||c!=="all"?"검색 결과가 없습니다":"문의 내역이 없습니다"}),e.jsx("p",{className:"text-slate-400 mb-4",children:x||c!=="all"?"검색 조건을 변경해보세요.":"궁금한 사항이 있으시면 언제든 문의해주세요."}),x||c!=="all"?e.jsx(h,{variant:"outline",onClick:()=>{q(""),M("all")},children:"전체 문의 보기"}):e.jsxs(h,{onClick:()=>j(!0),className:"bg-green-600 hover:bg-green-700",children:[e.jsx(B,{className:"w-4 h-4 mr-2"}),"첫 문의하기"]})]})})]})]})}export{ke as UserSupport};
