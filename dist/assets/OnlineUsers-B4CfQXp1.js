import{k as b,r as i,s as d,j as a,Q as S,w as _,t as p,B as T,R as I,V as B}from"./index-BWgbPZ4l.js";import{D as U}from"./DataTable-CvK3ZY2w.js";import{A as P,a as q,b as z,c as F,d as O,e as V}from"./AdminDialog-CYGxI-kp.js";import{M as j}from"./MetricCard-CsQsoRGz.js";import{M as K}from"./monitor-DauK2UbF.js";import{C as H}from"./clock-BQI8X08V.js";import"./search-BHxVGLMF.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q=[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]],W=b("map-pin",Q);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=[["path",{d:"M12 2v10",key:"mnfbl"}],["path",{d:"M18.4 6.6a9 9 0 1 1-12.77.04",key:"obofu9"}]],J=b("power",G);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=[["rect",{width:"14",height:"20",x:"5",y:"2",rx:"2",ry:"2",key:"1yt0o3"}],["path",{d:"M12 18h.01",key:"mhygvu"}]],Y=b("smartphone",X);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]],ee=b("wifi",Z);function oe({user:v}){const[o,w]=i.useState([]),[E,D]=i.useState(!0),[h,y]=i.useState(null),[$,g]=i.useState(!1),t=i.useRef(null),m=async()=>{try{D(!0);const{data:e,error:r}=await d.rpc("get_active_game_sessions",{p_user_id:null,p_admin_partner_id:v.id});if(r)throw r;w(e||[])}catch(e){console.error("온라인 세션 로드 오류:",e),p.error("온라인 현황을 불러올 수 없습니다")}finally{D(!1)}},C=async e=>{try{console.log("💰 사용자 보유금 동기화 시작:",e.username);const{data:r,error:n}=await d.from("users").select("referrer_id, username").eq("id",e.user_id).single();if(n||!r)throw new Error(`사용자 정보를 찾을 수 없습니다: ${n?.message||"알 수 없음"}`);if(!r.referrer_id)throw new Error("소속 파트너 정보(referrer_id)가 없습니다");const{data:l,error:u}=await d.from("partners").select("opcode, secret_key, api_token").eq("id",r.referrer_id).single();if(u||!l)throw new Error(`파트너 정보를 찾을 수 없습니다: ${u?.message||"알 수 없음"}`);if(!l.opcode||!l.secret_key||!l.api_token)throw new Error("파트너의 API 설정이 없습니다");const N=await B(l.opcode,r.username,l.api_token,l.secret_key);if(N.error)throw new Error(`API 호출 실패: ${N.error}`);let c=0;const s=N.data;if(s){if(typeof s=="object"&&!s.is_text)s.RESULT===!0&&s.DATA?c=parseFloat(s.DATA.balance||s.DATA.users_balance||0):s.balance!==void 0?c=parseFloat(s.balance||0):s.DATA?.balance!==void 0&&(c=parseFloat(s.DATA.balance||0));else if(s.is_text&&s.text_response){const f=s.text_response.match(/balance["'\s:]+(\\d+\\.?\\d*)/i);f&&(c=parseFloat(f[1]))}}const{error:A}=await d.from("users").update({balance:c,updated_at:new Date().toISOString()}).eq("id",e.user_id);if(A)throw new Error(`DB 업데이트 실패: ${A.message}`);console.log("✅ 보유금 동기화 완료:",{username:r.username,oldBalance:e.current_balance,newBalance:c,diff:c-e.current_balance}),w(f=>{const R=f.map(k=>k.session_id===e.session_id?{...k,current_balance:c}:k);return console.log("💾 로컬 상태 업데이트 완료 - 새 보유금:",c),R}),p.success(`${e.username} 보유금 동기화 완료: ₩${c.toLocaleString()}`)}catch(r){console.error("❌ 보유금 동기화 오류:",r),p.error(`보유금 동기화 실패: ${r.message||"알 수 없는 오류"}`)}},M=async()=>{if(h)try{const{error:e}=await d.from("game_launch_sessions").update({status:"ended",ended_at:new Date().toISOString()}).eq("id",h.session_id);if(e)throw console.error("❌ game_launch_sessions 종료 오류:",e),e;p.success(`${h.username} 사용자를 강제 종료했습니다`),g(!1),y(null),await m()}catch(e){console.error("강제 종료 오류:",e),p.error(`강제 종료 실패: ${e.message||"알 수 없는 오류"}`)}};i.useEffect(()=>{m();const e=setInterval(m,3e4);return()=>clearInterval(e)},[v.id]),i.useEffect(()=>{console.log("🔔 Realtime 구독 시작: game_launch_sessions, users, game_records");const e=d.channel("online-sessions-realtime").on("postgres_changes",{event:"*",schema:"public",table:"game_launch_sessions"},r=>{console.log("🔔 game_launch_sessions 변경 감지:",r),t.current&&clearTimeout(t.current),t.current=setTimeout(()=>{m()},500)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"users"},r=>{console.log("🔔 users 변경 감지:",r);const n=r.new;n&&n.id&&n.balance!==void 0&&(console.log(`💰 사용자 ${n.username} 보유금 Realtime 업데이트: ${n.balance}`),w(l=>l.map(u=>u.user_id===n.id?{...u,current_balance:n.balance}:u))),t.current&&clearTimeout(t.current),t.current=setTimeout(()=>{m()},1e3)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"game_records"},r=>{console.log("🔔 game_records INSERT 감지:",r),t.current&&clearTimeout(t.current),t.current=setTimeout(()=>{m()},500)}).subscribe();return()=>{console.log("🔕 Realtime 구독 해제"),d.removeChannel(e),t.current&&clearTimeout(t.current)}},[v.id]);const L=[{header:"사용자",cell:e=>a.jsxs("div",{className:"flex flex-col gap-1",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{children:e.username}),a.jsx(T,{variant:"outline",className:"text-xs",children:e.nickname})]}),a.jsx("span",{className:"text-xs text-muted-foreground",children:e.partner_nickname})]})},{header:"게임",cell:e=>a.jsxs("div",{className:"flex flex-col gap-1",children:[a.jsx("span",{children:e.game_name||"알 수 없음"}),a.jsx("span",{className:"text-xs text-muted-foreground",children:e.provider_name||""})]})},{header:"시작 보유금",cell:e=>a.jsxs("span",{children:["₩",e.balance_before.toLocaleString()]})},{header:"현재 보유금",cell:e=>a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("span",{className:e.current_balance>e.balance_before?"text-green-500":e.current_balance<e.balance_before?"text-red-500":"",children:["₩",e.current_balance.toLocaleString()]}),a.jsx(_,{size:"sm",variant:"outline",onClick:()=>C(e),children:a.jsx(I,{className:"w-3 h-3"})})]})},{header:"VIP",cell:e=>a.jsxs(T,{variant:"secondary",children:["LV.",e.vip_level]})},{header:"접속 정보",cell:e=>a.jsxs("div",{className:"flex flex-col gap-1 text-xs",children:[a.jsxs("div",{className:"flex items-center gap-1",children:[e.device_type==="mobile"?a.jsx(Y,{className:"w-3 h-3"}):a.jsx(K,{className:"w-3 h-3"}),a.jsx("span",{children:e.device_type==="mobile"?"모바일":"PC"})]}),a.jsxs("div",{className:"flex items-center gap-1 text-muted-foreground",children:[a.jsx(W,{className:"w-3 h-3"}),a.jsx("span",{children:e.ip_address})]})]})},{header:"시작 시간",cell:e=>a.jsxs("div",{className:"flex flex-col gap-1 text-xs",children:[a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(H,{className:"w-3 h-3"}),a.jsx("span",{children:new Date(e.launched_at).toLocaleString()})]}),a.jsxs("span",{className:"text-muted-foreground",children:["최종: ",new Date(e.last_activity).toLocaleTimeString()]})]})},{header:"관리",cell:e=>a.jsxs(_,{size:"sm",variant:"destructive",onClick:()=>{y(e),g(!0)},children:[a.jsx(J,{className:"w-3 h-3 mr-1"}),"강제종료"]})}],x=o.reduce((e,r)=>e+(r.current_balance-r.balance_before),0);return a.jsxs("div",{className:"space-y-6",children:[a.jsx("div",{className:"flex items-center justify-between",children:a.jsxs("div",{children:[a.jsx("h2",{className:"text-2xl",children:"온라인 현황"}),a.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"실시간 게임 중인 사용자 현황 (UserLayout에서 자동 동기화)"})]})}),a.jsxs("div",{className:"grid gap-5 md:grid-cols-2 lg:grid-cols-4",children:[a.jsx(j,{title:"온라인 서버",value:o.length.toLocaleString(),subtitle:"실시간 게임 세션",icon:ee,color:"purple"}),a.jsx(j,{title:"총 게임 보유금",value:`₩${o.reduce((e,r)=>e+r.current_balance,0).toLocaleString()}`,subtitle:"전체 사용자 보유금",icon:S,color:"pink"}),a.jsx(j,{title:"시작 대비 변동",value:`₩${x.toLocaleString()}`,subtitle:x>0?"↑ 증가":x<0?"↓ 감소":"변동 없음",icon:S,color:x>0?"green":x<0?"red":"cyan"}),a.jsx(j,{title:"경고 보유금",value:o.length>0?`₩${Math.round(o.reduce((e,r)=>e+r.current_balance,0)/o.length).toLocaleString()}`:"₩0",subtitle:"평균 사용자 보유금",icon:S,color:"amber"})]}),E?a.jsx("div",{className:"flex items-center justify-center py-12",children:a.jsxs("div",{className:"text-center space-y-2",children:[a.jsx("div",{className:"w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto"}),a.jsx("p",{className:"text-sm text-muted-foreground",children:"로딩 중..."})]})}):a.jsx(U,{data:o,columns:L,emptyMessage:"현재 게임 중인 사용자가 없습니다"}),a.jsx(P,{open:$,onOpenChange:g,children:a.jsxs(q,{children:[a.jsxs(z,{children:[a.jsx(F,{children:"사용자 강제 종료"}),a.jsxs(O,{children:[h?.username," 사용자를 강제로 로그아웃시키겠습니까?",a.jsx("br",{}),a.jsxs("span",{className:"text-xs text-muted-foreground mt-2 block",children:["현재 게임: ",h?.game_name]})]})]}),a.jsxs(V,{children:[a.jsx(_,{variant:"outline",onClick:()=>{g(!1),y(null)},children:"취소"}),a.jsx(_,{variant:"destructive",onClick:M,children:"강제 종료"})]})]})})]})}export{oe as OnlineUsers};
