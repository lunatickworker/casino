import{r as c,j as e}from"./react-core-CwM-CeLv.js";import{B as p,i as C,S as X,p as Y,q as Z,r as ee,t as se,s as x}from"./index-BFLxYssb.js";import{S as re}from"./switch-MNE__dVI.js";import{k as i}from"./vendor-CQn7sZ7L.js";import{b as z,f as te,R as j,as as G,ad as O,M as ae,n as b,m as ne,E as le}from"./lucide-icons-wLPRtdhM.js";import"./radix-ui-SX2QAG6c.js";import"./supabase-r6ABpEO8.js";function pe({user:m}){const[f,_]=c.useState([]),[o,T]=c.useState(""),[V,w]=c.useState(null),[u,y]=c.useState([]),[g,N]=c.useState([]),[S,E]=c.useState(!1),[k,q]=c.useState(!1),[Q,B]=c.useState(!1),[ie,F]=c.useState(new Set),L=async()=>{try{if(E(!0),m.level===1){const{data:s,error:r}=await x.from("partners").select("id, username, nickname, level, status").eq("status","active").order("level",{ascending:!0}).order("nickname",{ascending:!0});if(r)throw r;_(s||[]),(!s||s.length===0)&&i.warning("í™œì„±í™”ëœ íŒŒíŠ¸ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤.")}else{const{data:s,error:r}=await x.rpc("get_hierarchical_partners",{p_partner_id:m.id});if(r){console.error("í•˜ìœ„ íŒŒíŠ¸ë„ˆ ì¡°íšŒ ì‹¤íŒ¨:",r);const{data:t,error:a}=await x.from("partners").select("id, username, nickname, level, status").eq("status","active").eq("parent_id",m.id).order("level",{ascending:!0}).order("nickname",{ascending:!0});a?(console.error("ì§ì ‘ í•˜ìœ„ ì¡°íšŒë„ ì‹¤íŒ¨:",a),_([])):(_(t||[]),(!t||t.length===0)&&i.warning("ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” íŒŒíŠ¸ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤."))}else{const t=(s||[]).filter(a=>a.status==="active");_(t),console.log("âœ… ê³„ì¸µ íŒŒíŠ¸ë„ˆ ì¡°íšŒ ì™„ë£Œ:",{total:t.length,by_level:t.reduce((a,l)=>(a[l.level]=(a[l.level]||0)+1,a),{})}),t.length===0&&i.warning("ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” íŒŒíŠ¸ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤.")}}}catch(s){console.error("íŒŒíŠ¸ë„ˆ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:",s),i.error("íŒŒíŠ¸ë„ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}finally{E(!1)}},D=async()=>{try{const{data:s,error:r,count:t}=await x.from("menu_permissions").select("*",{count:"exact"}).eq("is_visible",!0).order("display_order",{ascending:!0}).order("menu_name",{ascending:!0});if(console.log("ë©”ë‰´ ê¶Œí•œ ì¡°íšŒ ê²°ê³¼:",{success:!r,count:t,dataLength:s?.length,error:r}),r){console.error("ë©”ë‰´ ê¶Œí•œ ëª©ë¡ ë¡œë“œ ì—ëŸ¬:",r),r.code==="PGRST116"||r.message?.includes("permission")?i.error("ë©”ë‰´ ë°ì´í„° ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."):i.error(`ë©”ë‰´ ê¶Œí•œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${r.message}`),y([]);return}y(s||[]),!s||s.length===0?i.warning("ë©”ë‰´ ê¶Œí•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. DB ìŠ¤í‚¤ë§ˆ(205ë²ˆ)ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.",{description:"Supabase SQL Editorì—ì„œ database/205_menu-management-schema.sql íŒŒì¼ì„ ì‹¤í–‰í•˜ì„¸ìš”."}):console.log(`âœ… ë©”ë‰´ ê¶Œí•œ ${s.length}ê°œ ë¡œë“œ ì„±ê³µ`)}catch(s){console.error("ë©”ë‰´ ê¶Œí•œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:",s),i.error("ë©”ë‰´ ê¶Œí•œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."),y([])}},P=async s=>{if(!s){N([]),w(null);return}try{q(!0);const r=f.find(n=>n.id===s);if(w(r||null),!r){i.error("ì„ íƒëœ íŒŒíŠ¸ë„ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");return}let t=u;if(m.level!==1&&r.parent_id){const{data:n,error:h}=await x.from("partner_menu_permissions").select(`
            menu_permission_id,
            is_enabled,
            menu_permission:menu_permissions(*)
          `).eq("partner_id",r.parent_id).eq("is_enabled",!0);if(h)console.error("ìƒìœ„ íŒŒíŠ¸ë„ˆ ë©”ë‰´ ì¡°íšŒ ì˜¤ë¥˜:",h);else if(n&&n.length>0){const v=new Set(n.map($=>$.menu_permission_id));t=u.filter($=>v.has($.id))}}const{data:a,error:l}=await x.from("partner_menu_permissions").select(`
          *,
          menu_permission:menu_permissions(*)
        `).eq("partner_id",s);if(l)throw l;const d=t.filter(n=>!a?.some(h=>h.menu_permission_id===n.id));if(d.length>0){const n=d.map(v=>({partner_id:s,menu_permission_id:v.id,is_enabled:r.level<=v.partner_level})),{error:h}=await x.from("partner_menu_permissions").insert(n);h&&console.error("ê¸°ë³¸ ë©”ë‰´ ê¶Œí•œ ìƒì„± ì‹¤íŒ¨:",h)}const{data:M,error:I}=await x.from("partner_menu_permissions").select(`
          *,
          menu_permission:menu_permissions(*)
        `).eq("partner_id",s);if(I)throw I;const K=(M||[]).map(n=>({...n,menu_permission:Array.isArray(n.menu_permission)?n.menu_permission[0]:n.menu_permission})),U=new Set(t.map(n=>n.id)),R=K.filter(n=>U.has(n.menu_permission_id));N(R);const W=new Set(R.map(n=>n.menu_permission?.parent_menu||"ê¸°ë³¸ ë©”ë‰´").filter(Boolean));F(W)}catch(r){console.error("íŒŒíŠ¸ë„ˆ ë©”ë‰´ ê¶Œí•œ ë¡œë“œ ì‹¤íŒ¨:",r),i.error("íŒŒíŠ¸ë„ˆ ë©”ë‰´ ê¶Œí•œì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."),N([])}finally{q(!1)}},H=async(s,r)=>{try{B(!0);const t=s.menu_permission?.menu_name||"ë©”ë‰´";if(console.log("ğŸ”§ ë©”ë‰´ ê¶Œí•œ ì—…ë°ì´íŠ¸ ì‹œì‘:",{menu_name:t,pmp_id:s.id,menu_permission_id:s.menu_permission_id,current_enabled:s.is_enabled,new_enabled:r,has_menu_permission:!!s.menu_permission}),!s.id){console.error("âŒ PMP IDê°€ ì—†ìŠµë‹ˆë‹¤:",s),i.error(`${t}: IDê°€ ì—†ì–´ ì—…ë°ì´íŠ¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);return}if(!s.menu_permission_id){console.error("âŒ menu_permission_idê°€ ì—†ìŠµë‹ˆë‹¤:",s),i.error(`${t}: menu_permission_idê°€ ì—†ì–´ ì—…ë°ì´íŠ¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);return}const{error:a}=await x.from("partner_menu_permissions").update({is_enabled:r,updated_at:new Date().toISOString()}).eq("id",s.id);if(a)throw console.error("âŒ DB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:",{menu_name:t,error_code:a.code,error_message:a.message,error_details:a.details}),a;console.log("âœ… DB ì—…ë°ì´íŠ¸ ì„±ê³µ:",{menu_name:t,new_enabled:r}),N(l=>l.map(d=>d.id===s.id?{...d,is_enabled:r}:d)),i.success(`${t} ${r?"í™œì„±í™”":"ë¹„í™œì„±í™”"} ì™„ë£Œ`,{description:`ë©”ë‰´ ê¶Œí•œì´ ì„±ê³µì ìœ¼ë¡œ ${r?"í™œì„±í™”":"ë¹„í™œì„±í™”"}ë˜ì—ˆìŠµë‹ˆë‹¤.`})}catch(t){const a=s.menu_permission?.menu_name||"ë©”ë‰´";console.error("âŒ ë©”ë‰´ ê¶Œí•œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:",t),i.error(`${a} ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${t.message||"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}`)}finally{B(!1)}};c.useEffect(()=>{L(),D()},[m.id]),c.useEffect(()=>{if(o&&u.length>0){const s=f.find(r=>r.id===o);w(s||null),P(o)}},[o,u,f]);const J=g.reduce((s,r)=>{const t=r.menu_permission?.parent_menu||"ê¸°ë³¸ ë©”ë‰´";return s[t]||(s[t]=[]),s[t].push(r),s},{}),A=s=>{switch(s){case 1:return"badge-premium-danger";case 2:return"badge-premium-primary";case 3:return"badge-premium-success";default:return"badge-premium-warning"}};return e.jsxs("div",{className:"h-full flex flex-col overflow-hidden p-4 space-y-3",children:[e.jsx("div",{className:"flex items-center justify-between px-4 py-2 rounded-lg bg-slate-900/50 border border-blue-500/30 flex-shrink-0",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-blue-500/20 to-blue-600/20 border border-blue-400/30",children:e.jsx(z,{className:"h-5 w-5 text-blue-400"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-slate-100",children:"ë©”ë‰´ ê´€ë¦¬"}),e.jsx("p",{className:"text-xs text-slate-400",children:m.nickname})]})]})}),e.jsxs("div",{className:"glass-card p-3 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(te,{className:"h-4 w-4 text-blue-400"}),e.jsx("span",{className:"text-sm text-slate-200",children:m.level===1?"ëŒ€ë³¸ì‚¬ ì„ íƒ":"íŒŒíŠ¸ë„ˆ ì„ íƒ"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[S&&e.jsx(j,{className:"h-3 w-3 animate-spin text-blue-400"}),e.jsxs(p,{variant:"outline",className:"border-blue-400/30 text-blue-300 text-xs h-5",children:[e.jsx(G,{className:"h-3 w-3 mr-1"}),f.length,"ê°œ"]})]})]}),e.jsx("div",{children:S?e.jsxs("div",{className:"flex items-center justify-center py-4 border border-slate-700/50 rounded-lg bg-slate-900/30",children:[e.jsx(j,{className:"h-4 w-4 animate-spin mr-2 text-blue-400"}),e.jsx("span",{className:"text-sm text-slate-300",children:"ë¡œë”© ì¤‘..."})]}):f.length===0?e.jsxs("div",{className:"text-center py-6 border border-slate-700/50 rounded-lg bg-slate-900/30",children:[e.jsx(O,{className:"h-8 w-8 mx-auto mb-2 text-slate-500"}),e.jsx("p",{className:"text-sm text-slate-300 mb-2",children:"í™œì„±í™”ëœ ì¡°ì§ì´ ì—†ìŠµë‹ˆë‹¤"}),e.jsxs(C,{onClick:L,variant:"outline",size:"sm",children:[e.jsx(j,{className:"h-3 w-3 mr-1"}),"ë‹¤ì‹œ ì‹œë„"]})]}):e.jsxs(X,{value:o,onValueChange:T,disabled:S,children:[e.jsx(Y,{className:"w-full input-premium h-9 text-sm",children:e.jsx(Z,{placeholder:m.level===1?"ë©”ë‰´ë¥¼ ê´€ë¦¬í•  ëŒ€ë³¸ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”":"ë©”ë‰´ë¥¼ ê´€ë¦¬í•  íŒŒíŠ¸ë„ˆë¥¼ ì„ íƒí•˜ì„¸ìš”"})}),e.jsx(ee,{className:"bg-slate-900 border-slate-700",children:f.sort((s,r)=>s.level!==r.level?s.level-r.level:s.nickname.localeCompare(r.nickname)).map(s=>{const r=Math.max(0,s.level-2),t=r>0?`${r*1.5}rem`:"0";return e.jsx(se,{value:s.id,className:"text-slate-200 focus:bg-slate-800 py-1",style:{paddingLeft:`calc(0.5rem + ${t})`},children:e.jsxs("div",{className:"flex items-center gap-2",children:[r>0&&e.jsx("span",{className:"text-slate-600 text-xs",children:"â””â”€".repeat(1)}),e.jsxs(p,{className:`${A(s.level)} text-xs h-4`,children:["L",s.level]}),e.jsx("span",{className:"text-sm",children:s.nickname}),e.jsxs("span",{className:"text-slate-400 text-xs",children:["(",s.username,")"]})]})},s.id)})})]})})]}),o&&e.jsxs("div",{className:"glass-card flex flex-col flex-1 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 border-b border-slate-700/50 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"h-4 w-4 text-emerald-400"}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-sm text-slate-200",children:[V?.nickname," ë©”ë‰´ ë…¸ì¶œ ì„¤ì •"]}),e.jsx("p",{className:"text-xs text-slate-400",children:"í™œì„±í™”ëœ ë©”ë‰´ë§Œ ì‚¬ì´ë“œë°”ì— í‘œì‹œ"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(p,{variant:"outline",className:"border-emerald-400/30 text-emerald-300 text-xs h-5",children:[e.jsx(b,{className:"h-3 w-3 mr-1"}),g.filter(s=>s.is_enabled).length,"/",g.length]}),e.jsxs(C,{onClick:()=>P(o),variant:"outline",size:"sm",disabled:k,className:"border-blue-400/30 hover:bg-blue-500/10 h-7 text-xs px-2",children:[e.jsx(j,{className:`h-3 w-3 mr-1 ${k?"animate-spin":""}`}),"ìƒˆë¡œê³ ì¹¨"]})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-3",children:k?e.jsxs("div",{className:"flex flex-col items-center justify-center py-8",children:[e.jsx("div",{className:"loading-premium mb-4"}),e.jsx("span",{className:"text-sm text-slate-300",children:"ë©”ë‰´ ê¶Œí•œì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."})]}):g.length===0?e.jsxs("div",{className:"text-center py-8 border border-slate-700/50 rounded-lg bg-slate-900/30",children:[e.jsx(O,{className:"h-12 w-12 mx-auto mb-3 text-slate-500"}),e.jsx("p",{className:"text-sm text-slate-300 mb-2",children:"ë©”ë‰´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤"}),e.jsx("p",{className:"text-xs text-slate-400 mb-3",children:u.length===0?"menu_permissions í…Œì´ë¸”ì— ê¸°ë³¸ ë©”ë‰´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.":"í•´ë‹¹ íŒŒíŠ¸ë„ˆì—ê²Œ í• ë‹¹ ê°€ëŠ¥í•œ ë©”ë‰´ê°€ ì—†ê±°ë‚˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ï¿½ï¿½ï¿½ìŠµë‹ˆë‹¤."}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsxs("div",{className:"text-xs text-slate-500",children:[e.jsxs("p",{children:["â€¢ ê¸°ë³¸ ë©”ë‰´: ",u.length,"ê°œ"]}),e.jsxs("p",{children:["â€¢ íŒŒíŠ¸ë„ˆ ë©”ë‰´: ",g.length,"ê°œ"]})]}),u.length===0&&e.jsxs("div",{className:"bg-amber-500/10 border border-amber-500/30 rounded-lg p-3 text-left",children:[e.jsx("p",{className:"text-xs text-amber-300 mb-1",children:"âš ï¸ ì¡°ì¹˜ í•„ìš”"}),e.jsx("p",{className:"text-xs text-slate-400",children:"205_menu-management-schema.sql ì‹¤í–‰ í•„ìš”"})]})]}),e.jsxs(C,{onClick:()=>{D(),P(o)},variant:"outline",size:"sm",className:"btn-premium-primary",children:[e.jsx(j,{className:"h-3 w-3 mr-1"}),"ë‹¤ì‹œ ì‹œë„"]})]}):e.jsx("div",{className:"space-y-1.5",children:Object.entries(J).map(([s,r])=>{const t=r.filter(a=>a.is_enabled).length;return e.jsxs("div",{className:"glass-card border-slate-700/50",children:[e.jsxs("div",{className:"px-3 py-1.5 bg-slate-800/50 border-b border-slate-700/50 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-3 w-3 text-blue-400"}),e.jsx("h4",{className:"text-xs text-slate-200",children:s}),e.jsxs(p,{variant:"outline",className:"border-slate-600/50 text-slate-400 text-[10px] h-4 px-1",children:[r.length,"ê°œ"]})]}),e.jsxs(p,{className:`text-[10px] h-4 px-1 ${t===r.length?"badge-premium-success":t>0?"badge-premium-warning":"badge-premium-danger"}`,children:[t," / ",r.length," í™œì„±"]})]}),e.jsx("div",{className:"grid grid-cols-2 lg:grid-cols-3 gap-2 p-2",children:r.sort((a,l)=>{const d=a.menu_permission?.display_order??999,M=l.menu_permission?.display_order??999;return d-M}).map(a=>{const l=a.menu_permission;return l?e.jsxs("div",{className:`
                                px-2 py-1.5 rounded-lg border transition-all
                                ${a.is_enabled?"bg-emerald-500/5 border-emerald-500/30 hover:bg-emerald-500/10":"bg-slate-800/20 border-slate-700/30 hover:bg-slate-800/40"}
                              `,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-1.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5 flex-1 min-w-0",children:[a.is_enabled?e.jsx(ne,{className:"h-3 w-3 text-emerald-400 flex-shrink-0 mt-0.5"}):e.jsx(le,{className:"h-3 w-3 text-slate-500 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-0.5",children:[e.jsx("span",{className:"text-xs text-slate-200 truncate",children:l.menu_name}),e.jsxs(p,{className:`text-[8px] px-1 py-0 h-3 flex-shrink-0 ${A(l.partner_level)}`,children:["L",l.partner_level]})]}),e.jsx("p",{className:"text-[9px] text-slate-400 truncate",children:l.menu_path})]})]}),e.jsx(re,{checked:a.is_enabled,disabled:Q,onCheckedChange:d=>H(a,d),className:"flex-shrink-0 scale-75"})]}),a.is_enabled&&e.jsx("div",{className:"flex items-center justify-end",children:e.jsx(p,{className:"badge-premium-success text-[9px] h-3.5 px-1",children:"í™œì„±"})})]},a.id):null})})]},s)})})})]}),!o&&e.jsx("div",{className:"glass-card flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center max-w-md px-4 space-y-3",children:[e.jsx("div",{className:"p-4 rounded-xl bg-gradient-to-br from-blue-500/10 to-blue-600/5 border border-blue-400/20 inline-block",children:e.jsx(z,{className:"h-12 w-12 text-blue-400"})}),e.jsx("h3",{className:"text-lg text-slate-200",children:m.level===1?"ëŒ€ë³¸ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”":"íŒŒíŠ¸ë„ˆë¥¼ ì„ íƒí•˜ì„¸ìš”"}),e.jsxs("p",{className:"text-xs text-slate-400",children:["ìœ„ì—ì„œ ",m.level===1?"ëŒ€ë³¸ì‚¬":"íŒŒíŠ¸ë„ˆ","ë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ì¡°ì§ì˜ ë©”ë‰´ ë…¸ì¶œ ì„¤ì •ì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."]}),e.jsxs("div",{className:"pt-4 space-y-2 text-left",children:[e.jsxs("div",{className:"flex items-start gap-3 text-sm text-slate-400",children:[e.jsx(b,{className:"h-5 w-5 text-emerald-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:"í™œì„±í™”ëœ ë©”ë‰´ë§Œ í‘œì‹œ"})]}),e.jsxs("div",{className:"flex items-start gap-3 text-sm text-slate-400",children:[e.jsx(b,{className:"h-5 w-5 text-emerald-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:"ë©”ë‰´ë³„ í™œì„±í™”/ë¹„í™œì„±í™” ì„¤ì •"})]}),e.jsxs("div",{className:"flex items-start gap-3 text-sm text-slate-400",children:[e.jsx(b,{className:"h-5 w-5 text-emerald-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:"ë ˆë²¨ì— ë§ëŠ” ë©”ë‰´ë§Œ ì„ íƒ ê°€ëŠ¥"})]}),e.jsxs("div",{className:"flex items-start gap-3 text-sm text-slate-400",children:[e.jsx(b,{className:"h-5 w-5 text-emerald-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:"ì‹¤ì‹œê°„ ì‚¬ì´ë“œë°” ë°˜ì˜"})]})]})]})})]})}export{pe as MenuManagement};
