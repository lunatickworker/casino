import{r as c,j as e}from"./react-core-CwM-CeLv.js";import{B as p,i as C,S as X,p as Y,q as Z,r as ee,t as se,s as x}from"./index-BFLxYssb.js";import{S as re}from"./switch-MNE__dVI.js";import{k as i}from"./vendor-CQn7sZ7L.js";import{b as z,f as te,R as j,as as G,ad as O,M as ae,n as b,m as ne,E as le}from"./lucide-icons-wLPRtdhM.js";import"./radix-ui-SX2QAG6c.js";import"./supabase-r6ABpEO8.js";function pe({user:m}){const[f,_]=c.useState([]),[o,T]=c.useState(""),[V,w]=c.useState(null),[u,y]=c.useState([]),[g,N]=c.useState([]),[S,E]=c.useState(!1),[k,q]=c.useState(!1),[Q,B]=c.useState(!1),[ie,F]=c.useState(new Set),L=async()=>{try{if(E(!0),m.level===1){const{data:s,error:r}=await x.from("partners").select("id, username, nickname, level, status").eq("status","active").order("level",{ascending:!0}).order("nickname",{ascending:!0});if(r)throw r;_(s||[]),(!s||s.length===0)&&i.warning("활성화된 파트너가 없습니다.")}else{const{data:s,error:r}=await x.rpc("get_hierarchical_partners",{p_partner_id:m.id});if(r){console.error("하위 파트너 조회 실패:",r);const{data:t,error:a}=await x.from("partners").select("id, username, nickname, level, status").eq("status","active").eq("parent_id",m.id).order("level",{ascending:!0}).order("nickname",{ascending:!0});a?(console.error("직접 하위 조회도 실패:",a),_([])):(_(t||[]),(!t||t.length===0)&&i.warning("관리할 수 있는 파트너가 없습니다."))}else{const t=(s||[]).filter(a=>a.status==="active");_(t),console.log("✅ 계층 파트너 조회 완료:",{total:t.length,by_level:t.reduce((a,l)=>(a[l.level]=(a[l.level]||0)+1,a),{})}),t.length===0&&i.warning("관리할 수 있는 파트너가 없습니다.")}}}catch(s){console.error("파트너 목록 로드 실패:",s),i.error("파트너 목록을 불러오는데 실패했습니다.")}finally{E(!1)}},D=async()=>{try{const{data:s,error:r,count:t}=await x.from("menu_permissions").select("*",{count:"exact"}).eq("is_visible",!0).order("display_order",{ascending:!0}).order("menu_name",{ascending:!0});if(console.log("메뉴 권한 조회 결과:",{success:!r,count:t,dataLength:s?.length,error:r}),r){console.error("메뉴 권한 목록 로드 에러:",r),r.code==="PGRST116"||r.message?.includes("permission")?i.error("메뉴 데이터 접근 권한이 없습니다."):i.error(`메뉴 권한 목록을 불러오는데 실패했습니다: ${r.message}`),y([]);return}y(s||[]),!s||s.length===0?i.warning("메뉴 권한 데이터가 없습니다. DB 스키마(205번)를 실행해주세요.",{description:"Supabase SQL Editor에서 database/205_menu-management-schema.sql 파일을 실행하세요."}):console.log(`✅ 메뉴 권한 ${s.length}개 로드 성공`)}catch(s){console.error("메뉴 권한 목록 로드 실패:",s),i.error("메뉴 권한 목록을 불러오는데 실패했습니다."),y([])}},P=async s=>{if(!s){N([]),w(null);return}try{q(!0);const r=f.find(n=>n.id===s);if(w(r||null),!r){i.error("선택된 파트너 정보를 찾을 수 없습니다.");return}let t=u;if(m.level!==1&&r.parent_id){const{data:n,error:h}=await x.from("partner_menu_permissions").select(`
            menu_permission_id,
            is_enabled,
            menu_permission:menu_permissions(*)
          `).eq("partner_id",r.parent_id).eq("is_enabled",!0);if(h)console.error("상위 파트너 메뉴 조회 오류:",h);else if(n&&n.length>0){const v=new Set(n.map($=>$.menu_permission_id));t=u.filter($=>v.has($.id))}}const{data:a,error:l}=await x.from("partner_menu_permissions").select(`
          *,
          menu_permission:menu_permissions(*)
        `).eq("partner_id",s);if(l)throw l;const d=t.filter(n=>!a?.some(h=>h.menu_permission_id===n.id));if(d.length>0){const n=d.map(v=>({partner_id:s,menu_permission_id:v.id,is_enabled:r.level<=v.partner_level})),{error:h}=await x.from("partner_menu_permissions").insert(n);h&&console.error("기본 메뉴 권한 생성 실패:",h)}const{data:M,error:I}=await x.from("partner_menu_permissions").select(`
          *,
          menu_permission:menu_permissions(*)
        `).eq("partner_id",s);if(I)throw I;const K=(M||[]).map(n=>({...n,menu_permission:Array.isArray(n.menu_permission)?n.menu_permission[0]:n.menu_permission})),U=new Set(t.map(n=>n.id)),R=K.filter(n=>U.has(n.menu_permission_id));N(R);const W=new Set(R.map(n=>n.menu_permission?.parent_menu||"기본 메뉴").filter(Boolean));F(W)}catch(r){console.error("파트너 메뉴 권한 로드 실패:",r),i.error("파트너 메뉴 권한을 불러오는데 실패했습니다."),N([])}finally{q(!1)}},H=async(s,r)=>{try{B(!0);const t=s.menu_permission?.menu_name||"메뉴";if(console.log("🔧 메뉴 권한 업데이트 시작:",{menu_name:t,pmp_id:s.id,menu_permission_id:s.menu_permission_id,current_enabled:s.is_enabled,new_enabled:r,has_menu_permission:!!s.menu_permission}),!s.id){console.error("❌ PMP ID가 없습니다:",s),i.error(`${t}: ID가 없어 업데이트할 수 없습니다.`);return}if(!s.menu_permission_id){console.error("❌ menu_permission_id가 없습니다:",s),i.error(`${t}: menu_permission_id가 없어 업데이트할 수 없습니다.`);return}const{error:a}=await x.from("partner_menu_permissions").update({is_enabled:r,updated_at:new Date().toISOString()}).eq("id",s.id);if(a)throw console.error("❌ DB 업데이트 실패:",{menu_name:t,error_code:a.code,error_message:a.message,error_details:a.details}),a;console.log("✅ DB 업데이트 성공:",{menu_name:t,new_enabled:r}),N(l=>l.map(d=>d.id===s.id?{...d,is_enabled:r}:d)),i.success(`${t} ${r?"활성화":"비활성화"} 완료`,{description:`메뉴 권한이 성공적으로 ${r?"활성화":"비활성화"}되었습니다.`})}catch(t){const a=s.menu_permission?.menu_name||"메뉴";console.error("❌ 메뉴 권한 업데이트 실패:",t),i.error(`${a} 업데이트 실패: ${t.message||"알 수 없는 오류"}`)}finally{B(!1)}};c.useEffect(()=>{L(),D()},[m.id]),c.useEffect(()=>{if(o&&u.length>0){const s=f.find(r=>r.id===o);w(s||null),P(o)}},[o,u,f]);const J=g.reduce((s,r)=>{const t=r.menu_permission?.parent_menu||"기본 메뉴";return s[t]||(s[t]=[]),s[t].push(r),s},{}),A=s=>{switch(s){case 1:return"badge-premium-danger";case 2:return"badge-premium-primary";case 3:return"badge-premium-success";default:return"badge-premium-warning"}};return e.jsxs("div",{className:"h-full flex flex-col overflow-hidden p-4 space-y-3",children:[e.jsx("div",{className:"flex items-center justify-between px-4 py-2 rounded-lg bg-slate-900/50 border border-blue-500/30 flex-shrink-0",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-blue-500/20 to-blue-600/20 border border-blue-400/30",children:e.jsx(z,{className:"h-5 w-5 text-blue-400"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-slate-100",children:"메뉴 관리"}),e.jsx("p",{className:"text-xs text-slate-400",children:m.nickname})]})]})}),e.jsxs("div",{className:"glass-card p-3 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(te,{className:"h-4 w-4 text-blue-400"}),e.jsx("span",{className:"text-sm text-slate-200",children:m.level===1?"대본사 선택":"파트너 선택"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[S&&e.jsx(j,{className:"h-3 w-3 animate-spin text-blue-400"}),e.jsxs(p,{variant:"outline",className:"border-blue-400/30 text-blue-300 text-xs h-5",children:[e.jsx(G,{className:"h-3 w-3 mr-1"}),f.length,"개"]})]})]}),e.jsx("div",{children:S?e.jsxs("div",{className:"flex items-center justify-center py-4 border border-slate-700/50 rounded-lg bg-slate-900/30",children:[e.jsx(j,{className:"h-4 w-4 animate-spin mr-2 text-blue-400"}),e.jsx("span",{className:"text-sm text-slate-300",children:"로딩 중..."})]}):f.length===0?e.jsxs("div",{className:"text-center py-6 border border-slate-700/50 rounded-lg bg-slate-900/30",children:[e.jsx(O,{className:"h-8 w-8 mx-auto mb-2 text-slate-500"}),e.jsx("p",{className:"text-sm text-slate-300 mb-2",children:"활성화된 조직이 없습니다"}),e.jsxs(C,{onClick:L,variant:"outline",size:"sm",children:[e.jsx(j,{className:"h-3 w-3 mr-1"}),"다시 시도"]})]}):e.jsxs(X,{value:o,onValueChange:T,disabled:S,children:[e.jsx(Y,{className:"w-full input-premium h-9 text-sm",children:e.jsx(Z,{placeholder:m.level===1?"메뉴를 관리할 대본사를 선택하세요":"메뉴를 관리할 파트너를 선택하세요"})}),e.jsx(ee,{className:"bg-slate-900 border-slate-700",children:f.sort((s,r)=>s.level!==r.level?s.level-r.level:s.nickname.localeCompare(r.nickname)).map(s=>{const r=Math.max(0,s.level-2),t=r>0?`${r*1.5}rem`:"0";return e.jsx(se,{value:s.id,className:"text-slate-200 focus:bg-slate-800 py-1",style:{paddingLeft:`calc(0.5rem + ${t})`},children:e.jsxs("div",{className:"flex items-center gap-2",children:[r>0&&e.jsx("span",{className:"text-slate-600 text-xs",children:"└─".repeat(1)}),e.jsxs(p,{className:`${A(s.level)} text-xs h-4`,children:["L",s.level]}),e.jsx("span",{className:"text-sm",children:s.nickname}),e.jsxs("span",{className:"text-slate-400 text-xs",children:["(",s.username,")"]})]})},s.id)})})]})})]}),o&&e.jsxs("div",{className:"glass-card flex flex-col flex-1 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 border-b border-slate-700/50 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"h-4 w-4 text-emerald-400"}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-sm text-slate-200",children:[V?.nickname," 메뉴 노출 설정"]}),e.jsx("p",{className:"text-xs text-slate-400",children:"활성화된 메뉴만 사이드바에 표시"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(p,{variant:"outline",className:"border-emerald-400/30 text-emerald-300 text-xs h-5",children:[e.jsx(b,{className:"h-3 w-3 mr-1"}),g.filter(s=>s.is_enabled).length,"/",g.length]}),e.jsxs(C,{onClick:()=>P(o),variant:"outline",size:"sm",disabled:k,className:"border-blue-400/30 hover:bg-blue-500/10 h-7 text-xs px-2",children:[e.jsx(j,{className:`h-3 w-3 mr-1 ${k?"animate-spin":""}`}),"새로고침"]})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-3",children:k?e.jsxs("div",{className:"flex flex-col items-center justify-center py-8",children:[e.jsx("div",{className:"loading-premium mb-4"}),e.jsx("span",{className:"text-sm text-slate-300",children:"메뉴 권한을 불러오는 중..."})]}):g.length===0?e.jsxs("div",{className:"text-center py-8 border border-slate-700/50 rounded-lg bg-slate-900/30",children:[e.jsx(O,{className:"h-12 w-12 mx-auto mb-3 text-slate-500"}),e.jsx("p",{className:"text-sm text-slate-300 mb-2",children:"메뉴 데이터가 없습니다"}),e.jsx("p",{className:"text-xs text-slate-400 mb-3",children:u.length===0?"menu_permissions 테이블에 기본 메뉴 데이터가 없습니다.":"해당 파트너에게 할당 가능한 메뉴가 없거나 데이터를 불러올 수 ���습니다."}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsxs("div",{className:"text-xs text-slate-500",children:[e.jsxs("p",{children:["• 기본 메뉴: ",u.length,"개"]}),e.jsxs("p",{children:["• 파트너 메뉴: ",g.length,"개"]})]}),u.length===0&&e.jsxs("div",{className:"bg-amber-500/10 border border-amber-500/30 rounded-lg p-3 text-left",children:[e.jsx("p",{className:"text-xs text-amber-300 mb-1",children:"⚠️ 조치 필요"}),e.jsx("p",{className:"text-xs text-slate-400",children:"205_menu-management-schema.sql 실행 필요"})]})]}),e.jsxs(C,{onClick:()=>{D(),P(o)},variant:"outline",size:"sm",className:"btn-premium-primary",children:[e.jsx(j,{className:"h-3 w-3 mr-1"}),"다시 시도"]})]}):e.jsx("div",{className:"space-y-1.5",children:Object.entries(J).map(([s,r])=>{const t=r.filter(a=>a.is_enabled).length;return e.jsxs("div",{className:"glass-card border-slate-700/50",children:[e.jsxs("div",{className:"px-3 py-1.5 bg-slate-800/50 border-b border-slate-700/50 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-3 w-3 text-blue-400"}),e.jsx("h4",{className:"text-xs text-slate-200",children:s}),e.jsxs(p,{variant:"outline",className:"border-slate-600/50 text-slate-400 text-[10px] h-4 px-1",children:[r.length,"개"]})]}),e.jsxs(p,{className:`text-[10px] h-4 px-1 ${t===r.length?"badge-premium-success":t>0?"badge-premium-warning":"badge-premium-danger"}`,children:[t," / ",r.length," 활성"]})]}),e.jsx("div",{className:"grid grid-cols-2 lg:grid-cols-3 gap-2 p-2",children:r.sort((a,l)=>{const d=a.menu_permission?.display_order??999,M=l.menu_permission?.display_order??999;return d-M}).map(a=>{const l=a.menu_permission;return l?e.jsxs("div",{className:`
                                px-2 py-1.5 rounded-lg border transition-all
                                ${a.is_enabled?"bg-emerald-500/5 border-emerald-500/30 hover:bg-emerald-500/10":"bg-slate-800/20 border-slate-700/30 hover:bg-slate-800/40"}
                              `,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-1.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5 flex-1 min-w-0",children:[a.is_enabled?e.jsx(ne,{className:"h-3 w-3 text-emerald-400 flex-shrink-0 mt-0.5"}):e.jsx(le,{className:"h-3 w-3 text-slate-500 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-0.5",children:[e.jsx("span",{className:"text-xs text-slate-200 truncate",children:l.menu_name}),e.jsxs(p,{className:`text-[8px] px-1 py-0 h-3 flex-shrink-0 ${A(l.partner_level)}`,children:["L",l.partner_level]})]}),e.jsx("p",{className:"text-[9px] text-slate-400 truncate",children:l.menu_path})]})]}),e.jsx(re,{checked:a.is_enabled,disabled:Q,onCheckedChange:d=>H(a,d),className:"flex-shrink-0 scale-75"})]}),a.is_enabled&&e.jsx("div",{className:"flex items-center justify-end",children:e.jsx(p,{className:"badge-premium-success text-[9px] h-3.5 px-1",children:"활성"})})]},a.id):null})})]},s)})})})]}),!o&&e.jsx("div",{className:"glass-card flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center max-w-md px-4 space-y-3",children:[e.jsx("div",{className:"p-4 rounded-xl bg-gradient-to-br from-blue-500/10 to-blue-600/5 border border-blue-400/20 inline-block",children:e.jsx(z,{className:"h-12 w-12 text-blue-400"})}),e.jsx("h3",{className:"text-lg text-slate-200",children:m.level===1?"대본사를 선택하세요":"파트너를 선택하세요"}),e.jsxs("p",{className:"text-xs text-slate-400",children:["위에서 ",m.level===1?"대본사":"파트너","를 선택하면 해당 조직의 메뉴 노출 설정을 관리할 수 있습니다."]}),e.jsxs("div",{className:"pt-4 space-y-2 text-left",children:[e.jsxs("div",{className:"flex items-start gap-3 text-sm text-slate-400",children:[e.jsx(b,{className:"h-5 w-5 text-emerald-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:"활성화된 메뉴만 표시"})]}),e.jsxs("div",{className:"flex items-start gap-3 text-sm text-slate-400",children:[e.jsx(b,{className:"h-5 w-5 text-emerald-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:"메뉴별 활성화/비활성화 설정"})]}),e.jsxs("div",{className:"flex items-start gap-3 text-sm text-slate-400",children:[e.jsx(b,{className:"h-5 w-5 text-emerald-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:"레벨에 맞는 메뉴만 선택 가능"})]}),e.jsxs("div",{className:"flex items-start gap-3 text-sm text-slate-400",children:[e.jsx(b,{className:"h-5 w-5 text-emerald-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:"실시간 사이드바 반영"})]})]})]})})]})}export{pe as MenuManagement};
