import{r as u,s as m,j as s,Y as L,U as I,W as R,B as p}from"./index-DuEcnhwm.js";import{D as E}from"./DataTable-B36ocgWm.js";import{M as f}from"./MetricCard-C8dgoA9F.js";import{W}from"./wifi-CdkkBel8.js";import"./search-DyNhXeLR.js";function V({user:i}){const[h,_]=u.useState([]),[v,j]=u.useState({totalUsers:0,totalUserBalance:0}),[U,x]=u.useState(!0),o=u.useRef(null),[g,b]=u.useState([]),P=async e=>{const t=[],n=[e];for(;n.length>0;){const r=n.shift(),{data:l,error:c}=await m.from("partners").select("id").eq("parent_id",r);if(!c&&l)for(const d of l)t.push(d.id),n.push(d.id)}return t},y=async(e=!1)=>{try{e&&x(!0);let t=[];i.level!==1&&(t=await P(i.id));let n=m.from("partners").select(`
          id,
          username,
          nickname,
          level,
          partner_type,
          balance,
          last_login_at,
          status,
          parent_id
        `).order("last_login_at",{ascending:!1,nullsFirst:!1});if(i.level!==1&&t.length>0)n=n.in("id",t);else if(i.level!==1&&t.length===0){_([]),b([]),e&&x(!1);return}const{data:r,error:l}=await n;if(l)throw l;const c=[...new Set((r||[]).map(a=>a.parent_id).filter(Boolean))];let d={};if(c.length>0){const{data:a}=await m.from("partners").select("id, nickname").in("id",c);a&&(d=a.reduce((T,M)=>(T[M.id]=M.nickname,T),{}))}const N=(r||[]).map(a=>({id:a.id,username:a.username,nickname:a.nickname,level:a.level,partner_type:a.partner_type,balance:a.balance||0,last_login_at:a.last_login_at,status:a.status,parent_nickname:a.parent_id&&d[a.parent_id]||"-"}));_(N);const S=i.level===1?N.map(a=>a.id):[i.id,...t];b(S),await w(S)}catch(t){console.error("íŒŒíŠ¸ë„ˆ ì ‘ì† í˜„í™© ë¡œë“œ ì˜¤ë¥˜:",t)}finally{e&&x(!1)}},w=async e=>{try{if(e.length===0){j({totalUsers:0,totalUserBalance:0});return}const{data:t,error:n}=await m.from("users").select("id, balance").in("referrer_id",e);if(n)throw n;const r=t?.length||0,l=t?.reduce((c,d)=>c+(d.balance||0),0)||0;j({totalUsers:r,totalUserBalance:l})}catch(t){console.error("ì‚¬ìš©ì í†µê³„ ë¡œë“œ ì˜¤ë¥˜:",t)}};u.useEffect(()=>{y(!0)},[i.id]),u.useEffect(()=>{console.log("ğŸ”” Realtime êµ¬ë… ì‹œì‘: partners, users");const e=m.channel("partner-connections-realtime").on("postgres_changes",{event:"*",schema:"public",table:"partners"},t=>{console.log("ğŸ”” partners ë³€ê²½ ê°ì§€:",t),o.current&&clearTimeout(o.current),o.current=setTimeout(()=>{y()},500)}).on("postgres_changes",{event:"*",schema:"public",table:"users"},t=>{console.log("ğŸ”” users ë³€ê²½ ê°ì§€:",t),g.length>0&&(o.current&&clearTimeout(o.current),o.current=setTimeout(()=>{w(g)},500))}).subscribe();return()=>{m.removeChannel(e),o.current&&clearTimeout(o.current)}},[i.id,g]);const k=e=>({system_admin:"ì‹œìŠ¤í…œê´€ë¦¬ì",head_office:"ëŒ€ë³¸ì‚¬",main_office:"ë³¸ì‚¬",sub_office:"ë¶€ë³¸ì‚¬",distributor:"ì´íŒ",store:"ë§¤ì¥"})[e]||e,D=e=>{if(!e)return"-";const t=new Date(e).getTime(),n=Date.now(),r=Math.floor((n-t)/1e3/60);if(r<60)return`${r}ë¶„`;const l=Math.floor(r/60),c=r%60;return`${l}ì‹œê°„ ${c}ë¶„`},B=h.filter(e=>e.last_login_at?Math.floor((Date.now()-new Date(e.last_login_at).getTime())/1e3/60)<=30&&e.status==="active":!1),C=h.reduce((e,t)=>e+t.balance,0),$=[{header:"íŒŒíŠ¸ë„ˆ",cell:e=>s.jsxs("div",{className:"flex flex-col gap-1",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{children:e.username}),s.jsx(p,{variant:"outline",className:"text-xs",children:e.nickname})]}),s.jsxs("span",{className:"text-xs text-muted-foreground",children:["ìƒìœ„: ",e.parent_nickname]})]})},{header:"ë“±ê¸‰",cell:e=>s.jsxs("div",{className:"flex flex-col gap-1",children:[s.jsxs(p,{variant:"secondary",children:["LV.",e.level]}),s.jsx("span",{className:"text-xs text-muted-foreground",children:k(e.partner_type)})]})},{header:"ë³´ìœ ê¸ˆ",cell:e=>s.jsxs("span",{className:e.balance<0?"text-red-500":"",children:["â‚©",e.balance.toLocaleString()]})},{header:"ìƒíƒœ",cell:e=>{const t=e.last_login_at&&(Date.now()-new Date(e.last_login_at).getTime())/1e3/60<=30&&e.status==="active";return s.jsx(p,{variant:t?"default":"outline",children:t?"ì˜¨ë¼ì¸":"ì˜¤í”„ë¼ì¸"})}},{header:"ì ‘ì† ì¼ì‹œ",cell:e=>s.jsx("div",{className:"text-xs",children:e.last_login_at?new Date(e.last_login_at).toLocaleString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"ì ‘ì† ê¸°ë¡ ì—†ìŒ"})},{header:"ì„¸ì…˜ ì‹œê°„",cell:e=>s.jsx("div",{className:"text-xs",children:D(e.last_login_at)})}];return s.jsxs("div",{className:"space-y-6",children:[s.jsx("div",{className:"flex items-center justify-between",children:s.jsxs("div",{children:[s.jsx("h2",{className:"text-2xl",children:"íŒŒíŠ¸ë„ˆ ì ‘ì†í˜„í™©"}),s.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"í•˜ìœ„ íŒŒíŠ¸ë„ˆë“¤ì˜ ì‹¤ì‹œê°„ ì ‘ì† í˜„í™© ë° ë³´ìœ ê¸ˆ ì •ë³´"})]})}),s.jsxs("div",{className:"grid gap-5 md:grid-cols-2 lg:grid-cols-4",children:[s.jsx(f,{title:"ì˜¨ë¼ì¸ íŒŒíŠ¸ë„ˆ",value:`${B.length}ëª…`,subtitle:"ìµœê·¼ 30ë¶„ ì´ë‚´ ì ‘ì†",icon:W,color:"purple"}),s.jsx(f,{title:"ì´ íŒŒíŠ¸ë„ˆ ë³´ìœ ê¸ˆ",value:`â‚©${C.toLocaleString()}`,subtitle:"í•˜ìœ„ íŒŒíŠ¸ë„ˆ ë³´ìœ ê¸ˆ í•©ê³„",icon:L,color:"pink"}),s.jsx(f,{title:"ê´€ë¦¬ ì‚¬ìš©ì",value:`${v.totalUsers.toLocaleString()}ëª…`,subtitle:"í•˜ìœ„ íŒŒíŠ¸ë„ˆ ì‚¬ìš©ì ìˆ˜",icon:I,color:"cyan"}),s.jsx(f,{title:"ì´ ì‚¬ìš©ì ë³´ìœ ê¸ˆ",value:`â‚©${v.totalUserBalance.toLocaleString()}`,subtitle:"ì‚¬ìš©ì ë³´ìœ ê¸ˆ í•©ê³„",icon:R,color:"amber"})]}),U?s.jsx("div",{className:"flex items-center justify-center py-12",children:s.jsxs("div",{className:"text-center space-y-2",children:[s.jsx("div",{className:"w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:"ë¡œë”© ì¤‘..."})]})}):s.jsx(E,{data:h,columns:$,emptyMessage:"ì¡°íšŒëœ íŒŒíŠ¸ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤",rowKey:"id"})]})}export{V as PartnerConnectionStatus};
