import{r as u,s as m,j as s,Y as L,U as I,W as R,B as p}from"./index-DuEcnhwm.js";import{D as E}from"./DataTable-B36ocgWm.js";import{M as f}from"./MetricCard-C8dgoA9F.js";import{W}from"./wifi-CdkkBel8.js";import"./search-DyNhXeLR.js";function V({user:i}){const[h,_]=u.useState([]),[v,j]=u.useState({totalUsers:0,totalUserBalance:0}),[U,x]=u.useState(!0),o=u.useRef(null),[g,b]=u.useState([]),P=async e=>{const t=[],n=[e];for(;n.length>0;){const r=n.shift(),{data:l,error:c}=await m.from("partners").select("id").eq("parent_id",r);if(!c&&l)for(const d of l)t.push(d.id),n.push(d.id)}return t},y=async(e=!1)=>{try{e&&x(!0);let t=[];i.level!==1&&(t=await P(i.id));let n=m.from("partners").select(`
          id,
          username,
          nickname,
          level,
          partner_type,
          balance,
          last_login_at,
          status,
          parent_id
        `).order("last_login_at",{ascending:!1,nullsFirst:!1});if(i.level!==1&&t.length>0)n=n.in("id",t);else if(i.level!==1&&t.length===0){_([]),b([]),e&&x(!1);return}const{data:r,error:l}=await n;if(l)throw l;const c=[...new Set((r||[]).map(a=>a.parent_id).filter(Boolean))];let d={};if(c.length>0){const{data:a}=await m.from("partners").select("id, nickname").in("id",c);a&&(d=a.reduce((T,M)=>(T[M.id]=M.nickname,T),{}))}const N=(r||[]).map(a=>({id:a.id,username:a.username,nickname:a.nickname,level:a.level,partner_type:a.partner_type,balance:a.balance||0,last_login_at:a.last_login_at,status:a.status,parent_nickname:a.parent_id&&d[a.parent_id]||"-"}));_(N);const S=i.level===1?N.map(a=>a.id):[i.id,...t];b(S),await w(S)}catch(t){console.error("파트너 접속 현황 로드 오류:",t)}finally{e&&x(!1)}},w=async e=>{try{if(e.length===0){j({totalUsers:0,totalUserBalance:0});return}const{data:t,error:n}=await m.from("users").select("id, balance").in("referrer_id",e);if(n)throw n;const r=t?.length||0,l=t?.reduce((c,d)=>c+(d.balance||0),0)||0;j({totalUsers:r,totalUserBalance:l})}catch(t){console.error("사용자 통계 로드 오류:",t)}};u.useEffect(()=>{y(!0)},[i.id]),u.useEffect(()=>{console.log("🔔 Realtime 구독 시작: partners, users");const e=m.channel("partner-connections-realtime").on("postgres_changes",{event:"*",schema:"public",table:"partners"},t=>{console.log("🔔 partners 변경 감지:",t),o.current&&clearTimeout(o.current),o.current=setTimeout(()=>{y()},500)}).on("postgres_changes",{event:"*",schema:"public",table:"users"},t=>{console.log("🔔 users 변경 감지:",t),g.length>0&&(o.current&&clearTimeout(o.current),o.current=setTimeout(()=>{w(g)},500))}).subscribe();return()=>{m.removeChannel(e),o.current&&clearTimeout(o.current)}},[i.id,g]);const k=e=>({system_admin:"시스템관리자",head_office:"대본사",main_office:"본사",sub_office:"부본사",distributor:"총판",store:"매장"})[e]||e,D=e=>{if(!e)return"-";const t=new Date(e).getTime(),n=Date.now(),r=Math.floor((n-t)/1e3/60);if(r<60)return`${r}분`;const l=Math.floor(r/60),c=r%60;return`${l}시간 ${c}분`},B=h.filter(e=>e.last_login_at?Math.floor((Date.now()-new Date(e.last_login_at).getTime())/1e3/60)<=30&&e.status==="active":!1),C=h.reduce((e,t)=>e+t.balance,0),$=[{header:"파트너",cell:e=>s.jsxs("div",{className:"flex flex-col gap-1",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{children:e.username}),s.jsx(p,{variant:"outline",className:"text-xs",children:e.nickname})]}),s.jsxs("span",{className:"text-xs text-muted-foreground",children:["상위: ",e.parent_nickname]})]})},{header:"등급",cell:e=>s.jsxs("div",{className:"flex flex-col gap-1",children:[s.jsxs(p,{variant:"secondary",children:["LV.",e.level]}),s.jsx("span",{className:"text-xs text-muted-foreground",children:k(e.partner_type)})]})},{header:"보유금",cell:e=>s.jsxs("span",{className:e.balance<0?"text-red-500":"",children:["₩",e.balance.toLocaleString()]})},{header:"상태",cell:e=>{const t=e.last_login_at&&(Date.now()-new Date(e.last_login_at).getTime())/1e3/60<=30&&e.status==="active";return s.jsx(p,{variant:t?"default":"outline",children:t?"온라인":"오프라인"})}},{header:"접속 일시",cell:e=>s.jsx("div",{className:"text-xs",children:e.last_login_at?new Date(e.last_login_at).toLocaleString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"접속 기록 없음"})},{header:"세션 시간",cell:e=>s.jsx("div",{className:"text-xs",children:D(e.last_login_at)})}];return s.jsxs("div",{className:"space-y-6",children:[s.jsx("div",{className:"flex items-center justify-between",children:s.jsxs("div",{children:[s.jsx("h2",{className:"text-2xl",children:"파트너 접속현황"}),s.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"하위 파트너들의 실시간 접속 현황 및 보유금 정보"})]})}),s.jsxs("div",{className:"grid gap-5 md:grid-cols-2 lg:grid-cols-4",children:[s.jsx(f,{title:"온라인 파트너",value:`${B.length}명`,subtitle:"최근 30분 이내 접속",icon:W,color:"purple"}),s.jsx(f,{title:"총 파트너 보유금",value:`₩${C.toLocaleString()}`,subtitle:"하위 파트너 보유금 합계",icon:L,color:"pink"}),s.jsx(f,{title:"관리 사용자",value:`${v.totalUsers.toLocaleString()}명`,subtitle:"하위 파트너 사용자 수",icon:I,color:"cyan"}),s.jsx(f,{title:"총 사용자 보유금",value:`₩${v.totalUserBalance.toLocaleString()}`,subtitle:"사용자 보유금 합계",icon:R,color:"amber"})]}),U?s.jsx("div",{className:"flex items-center justify-center py-12",children:s.jsxs("div",{className:"text-center space-y-2",children:[s.jsx("div",{className:"w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:"로딩 중..."})]})}):s.jsx(E,{data:h,columns:$,emptyMessage:"조회된 파트너가 없습니다",rowKey:"id"})]})}export{V as PartnerConnectionStatus};
