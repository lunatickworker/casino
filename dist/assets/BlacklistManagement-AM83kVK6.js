import{r as l,j as e}from"./react-core-CwM-CeLv.js";import{n as y,s as n,m as L,i as g,I as S,B as R}from"./index-Cn1S8-JW.js";import{k as i}from"./vendor-CQn7sZ7L.js";import{M as b}from"./MetricCard-CBRAhT7E.js";import{S as h,R as N,K as v,V as B}from"./lucide-icons-wLPRtdhM.js";import"./radix-ui-SX2QAG6c.js";import"./supabase-r6ABpEO8.js";function z(){const{authState:x}=y(),[a,u]=l.useState([]),[o,j]=l.useState(!0),[p,f]=l.useState(null),[r,w]=l.useState(""),d=async()=>{try{j(!0),console.log("📋 블랙리스트 사용자 조회 시작");const{data:s,error:t}=await n.from("blacklist_users_view").select("*").order("blocked_at",{ascending:!1});if(t)throw console.error("❌ 블랙리스트 조회 오류:",t),t;console.log("📊 블랙리스트 데이터:",s),console.log(`📈 블랙리스트 사용자 수: ${s?.length||0}명`),u(s||[])}catch(s){console.error("❌ 블랙리스트 조회 실패:",s),i.error("블랙리스트를 불러오는데 실패했습니다.")}finally{j(!1)}},_=async s=>{if(!x.user?.id){i.error("관리자 인증 정보가 없습니다.");return}try{f(s.user_id),console.log("🔓 블랙리스트 해제 시작:",s.user_id);const{data:t,error:m}=await n.rpc("remove_user_from_blacklist_simple",{p_user_id:s.user_id,p_admin_id:x.user.id});if(m)throw console.error("❌ 블랙리스트 해제 오류:",m),m;if(console.log("✅ RPC 응답:",t),!t.success)throw new Error(t.error||"블랙리스트 해제 실패");i.success(`${s.username}님이 회원관리로 복원되었습니다.`),u(k=>k.filter(C=>C.user_id!==s.user_id))}catch(t){console.error("❌ 블랙리스트 해제 실패:",t),i.error(t.message||"블랙리스트 해제 중 오류가 발생했습니다.")}finally{f(null)}},c=a.filter(s=>s.username?.toLowerCase().includes(r.toLowerCase())||s.nickname?.toLowerCase().includes(r.toLowerCase())||s.blocked_reason?.toLowerCase().includes(r.toLowerCase()));return l.useEffect(()=>{d();const s=n.channel("blacklist-users-changes").on("postgres_changes",{event:"*",schema:"public",table:"users"},t=>{console.log("🔔 사용자 테이블 변경 감지:",t),(t.new?.status==="blocked"||t.old?.status==="blocked")&&d()}).subscribe();return()=>{n.removeChannel(s)}},[]),o&&a.length===0?e.jsx(L,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("h1",{className:"text-2xl font-bold text-slate-100 flex items-center gap-2",children:[e.jsx(h,{className:"h-6 w-6 text-rose-400"}),"블랙리스트 관리"]}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"차단된 회원들을 관리하고 복원할 수 있습니다."})]}),e.jsxs(g,{onClick:d,variant:"outline",disabled:o,children:[e.jsx(N,{className:`h-4 w-4 mr-2 ${o?"animate-spin":""}`}),"새로고침"]})]}),e.jsxs("div",{className:"grid gap-5 md:grid-cols-2",children:[e.jsx(b,{title:"블랙리스트 회원",value:a.length.toLocaleString(),subtitle:"차단된 회원 수",icon:h,color:"red"}),e.jsx(b,{title:"검색 결과",value:c.length.toLocaleString(),subtitle:"필터링된 결과",icon:v,color:"blue"})]}),e.jsxs("div",{className:"glass-card rounded-xl p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6 pb-4 border-b border-slate-700/50",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-slate-100 mb-1",children:"블랙리스트 목록"}),e.jsxs("p",{className:"text-sm text-slate-400",children:["총 ",c.length.toLocaleString(),"명의 차단된 사용자"]})]}),e.jsxs("div",{className:"relative w-96",children:[e.jsx(v,{className:"absolute left-3 top-2.5 h-4 w-4 text-slate-400"}),e.jsx(S,{placeholder:"아이디, 닉네임, 차단 사유 검색",className:"pl-10 input-premium",value:r,onChange:s=>w(s.target.value)})]})]}),e.jsx("div",{className:"space-y-4",children:c.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(h,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500",children:a.length===0?"등록된 블랙리스트가 없습니다.":"검색 조건에 맞는 블랙리스트가 없습니다."}),a.length===0&&e.jsx("p",{className:"text-sm text-gray-400 mt-2",children:"회원관리에서 블랙 버튼을 클릭하면 여기에 표시됩니다."})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"text-left p-3",children:"아이디"}),e.jsx("th",{className:"text-left p-3",children:"닉네임"}),e.jsx("th",{className:"text-left p-3",children:"차단 사유"}),e.jsx("th",{className:"text-left p-3",children:"처리자"}),e.jsx("th",{className:"text-left p-3",children:"차단일시"}),e.jsx("th",{className:"text-left p-3",children:"상태"}),e.jsx("th",{className:"text-left p-3",children:"관리"})]})}),e.jsx("tbody",{children:c.map(s=>e.jsxs("tr",{className:"border-b hover:bg-muted/50",children:[e.jsx("td",{className:"p-3 font-medium",children:s.username}),e.jsx("td",{className:"p-3",children:s.nickname}),e.jsx("td",{className:"p-3",children:e.jsx("div",{className:"max-w-[200px] truncate",title:s.blocked_reason||"",children:s.blocked_reason||"사유 없음"})}),e.jsx("td",{className:"p-3",children:s.admin_nickname||"시스템"}),e.jsx("td",{className:"p-3",children:s.blocked_at?new Date(s.blocked_at).toLocaleString("ko-KR"):"-"}),e.jsx("td",{className:"p-3",children:e.jsx(R,{variant:"destructive",children:"차단중"})}),e.jsx("td",{className:"p-3",children:e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>_(s),disabled:p===s.user_id,className:"text-green-600 hover:bg-green-50",children:[p===s.user_id?e.jsx(N,{className:"h-3 w-3 animate-spin mr-1"}):e.jsx(B,{className:"h-3 w-3 mr-1"}),"복원"]})})]},s.user_id))})]})})})]})]})}export{z as BlacklistManagement,z as default};
