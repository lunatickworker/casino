import{r as b,s as c,j as a,Q as I,w as z,E as G,S as te,x as ae,y as re,z as se,D as k,I as ne,L as oe,t as w,aF as W,B as H}from"./index-DBZ0Cn5g.js";import{D as ie}from"./DataTable-uFCT-Q5Q.js";import{M as F}from"./MetricCard-Cj1Etvsa.js";import{C as le}from"./cloud-download-BBNPVUte.js";import{D as ce}from"./download-Xx-IS9zz.js";import{C as de}from"./circle-alert-Sb-Y6Jzy.js";import"./search-DBLVvwNz.js";function Se({user:N}){const[U,O]=b.useState(!1),[q,L]=b.useState(!1),[B,R]=b.useState([]),[A,V]=b.useState("all"),[D,X]=b.useState(""),[v,E]=b.useState({totalBets:0,totalBetAmount:0,totalWinAmount:0,netProfit:0}),P=t=>{if(!t)return"-";const r=new Date(t),i=r.getUTCFullYear(),u=String(r.getUTCMonth()+1).padStart(2,"0"),s=String(r.getUTCDate()).padStart(2,"0"),h=String(r.getUTCHours()).padStart(2,"0"),l=String(r.getUTCMinutes()).padStart(2,"0"),o=String(r.getUTCSeconds()).padStart(2,"0");return`${i}년${u}월${s}일 ${h}:${l}:${o}`},J=t=>{const r=new Date,i=new Date(r.getFullYear(),r.getMonth(),r.getDate());switch(t){case"today":return{start:i.toISOString(),end:r.toISOString()};case"week":const u=new Date(i);return u.setDate(i.getDate()-7),{start:u.toISOString(),end:r.toISOString()};case"month":const s=new Date(i);return s.setMonth(i.getMonth()-1),{start:s.toISOString(),end:r.toISOString()};default:return null}},T=async()=>{try{console.log("🔄 베팅 데이터 로드 시작"),O(!0);const t=J(A);let r=[];if(N.level===1){const{data:l}=await c.from("partners").select("id");r=l?.map(o=>o.id)||[]}else{r=[N.id];const{data:l}=await c.from("partners").select("id").eq("parent_id",N.id),o=l?.map(d=>d.id)||[];if(r.push(...o),o.length>0){const{data:d}=await c.from("partners").select("id").in("parent_id",o),_=d?.map(S=>S.id)||[];if(r.push(..._),_.length>0){const{data:S}=await c.from("partners").select("id").in("parent_id",_),y=S?.map(e=>e.id)||[];if(r.push(...y),y.length>0){const{data:e}=await c.from("partners").select("id").in("parent_id",y),m=e?.map(g=>g.id)||[];if(r.push(...m),m.length>0){const{data:g}=await c.from("partners").select("id").in("parent_id",m),p=g?.map(n=>n.id)||[];r.push(...p)}}}}}console.log("👥 하위 파트너 ID 개수:",r.length);let i=[];if(r.length>0){const{data:l}=await c.from("users").select("id").in("referrer_id",r);i=l?.map(o=>o.id)||[],console.log("👤 하위 회원 ID 개수:",i.length)}let u=c.from("game_records").select("*");if(i.length>0)u=u.in("user_id",i);else{R([]),E({totalBets:0,totalBetAmount:0,totalWinAmount:0,netProfit:0}),O(!1);return}t&&(u=u.gte("played_at",t.start).lte("played_at",t.end)),u=u.order("played_at",{ascending:!1}).limit(1e3);const{data:s,error:h}=await u;if(h)throw console.error("❌ 베팅 데이터 로드 실패:",h),h;if(console.log("✅ 베팅 데이터 로드 성공:",s?.length||0,"건"),console.log("📊 첫 번째 레코드:",s?.[0]),R(s||[]),s&&s.length>0){const l=s.reduce((d,_)=>d+parseFloat(_.bet_amount?.toString()||"0"),0),o=s.reduce((d,_)=>d+parseFloat(_.win_amount?.toString()||"0"),0);E({totalBets:s.length,totalBetAmount:l,totalWinAmount:o,netProfit:o-l})}else E({totalBets:0,totalBetAmount:0,totalWinAmount:0,netProfit:0})}catch(t){console.error("❌ 베팅 데이터 로드 오류:",t),w.error("베팅 데이터를 불러오는데 실패했습니다.")}finally{O(!1)}},K=async()=>{try{L(!0),w.info("베팅 기록 API를 호출하여 업데이트합니다...");const t=new Date,r=t.getFullYear().toString(),i=(t.getMonth()+1).toString();console.log("🎲 베팅 데이터 수동 동기화 시작",{year:r,month:i});const{data:u,error:s}=await c.from("partners").select("id, opcode, secret_key, api_token").not("opcode","is",null).not("secret_key","is",null);if(s||!u||u.length===0){w.warning("API 설정이 있는 파트너가 없습니다.");return}w.info(`${u.length}개 파트너의 베팅 데이터를 동기화 중...`);let h=0;for(const l of u)try{console.log(`📊 파트너 ${l.id} (${l.opcode}) 베팅 데이터 조회 시작`);const o=await W(l.opcode,r,i,0,4e3,l.secret_key);if(o.error){console.error(`❌ 파트너 ${l.id} 베팅 데이터 조회 실패:`,o.error);continue}let d=[];if(o.data){if(!o.data.is_text)o.data.RESULT===!0&&Array.isArray(o.data.DATA)||Array.isArray(o.data.DATA)?d=o.data.DATA:Array.isArray(o.data)&&(d=o.data);else if(o.data.is_text&&o.data.text_response)try{const e=JSON.parse(o.data.text_response);Array.isArray(e.DATA)?d=e.DATA:Array.isArray(e)&&(d=e)}catch(e){console.warn("텍스트 응답 파싱 실패:",e)}}if(d.length===0){console.log(`⏭️ 파트너 ${l.id}: 베팅 데이터 없음`);continue}console.log(`✅ 파트너 ${l.id}: ${d.length}건 베팅 데이터 조회`),h+=d.length;const _=new Map,S=new Set;d.forEach(e=>{e.username&&e.balance!==void 0&&(_.set(e.username,e.balance),S.add(e.username))}),console.log(`📊 고유 사용자 수: ${S.size}명 (${Array.from(S).join(", ")})`),console.log(`🔍 ${S.size}명의 사용자 보유금 업데이트 시작...`);for(const[e,m]of _){const{data:g,error:p}=await c.from("users").select("id, referrer_id").eq("username",e).maybeSingle();if(p){console.error(`❌ 사용자 ${e} 조회 오류:`,p);continue}if(!g){const{data:f}=await c.from("users").select("id, referrer_id, username").eq("username",e).maybeSingle();console.debug(f?`ℹ️ 사용자 ${e}는 다른 파트너(${f.referrer_id}) 소속 (건너뜀)`:`ℹ️ 사용자 ${e}는 DB에 미등록 (건너뜀)`);continue}if(g.referrer_id!==l.id){console.debug(`ℹ️ 사용자 ${e}는 다른 파트너 소속 (건너뜀)`);continue}const{data:n,error:x}=await c.from("game_launch_sessions").select("id").eq("user_id",g.id).eq("status","active").limit(1).single();if(x&&x.code!=="PGRST116"){console.error(`❌ 세션 조회 오류 (${e}):`,x);continue}if(n){const{error:f}=await c.from("users").update({balance:m}).eq("id",g.id);f?console.error(`❌ 사용자 ${e} 잔고 업데이트 실패:`,f):console.log(`💰 [Active Session] 사용자 ${e} 잔고 업데이트: ${m}`)}else console.log(`⛔ [No Active Session] 사용자 ${e} 잔고 업데이트 스킵 (session 없음 또는 ended)`)}console.log(`💾 파트너 ${l.id}: DB 저장 시작 (${d.length}건)`);let y=0;for(const e of d)try{const{data:m,error:g}=await c.from("users").select("id, referrer_id").eq("username",e.username).maybeSingle();if(g){console.error(`❌ 사용자 조회 오류 (${e.username}):`,g),skippedCount++;continue}if(!m){console.debug(`ℹ️ 사용자 ${e.username}는 DB에 미등록 (건너뜀)`),skippedCount++;continue}if(m.referrer_id!==l.id){console.debug(`ℹ️ 사용자 ${e.username}는 다른 파트너 소속 (건너뜀)`),skippedCount++;continue}const p=(e.id||e.txid)?.toString();if(!p){console.warn("⚠️ external_txid 없음:",e);continue}const{data:n,error:x}=await c.from("game_records").select("id").eq("external_txid",p).eq("partner_id",l.id).maybeSingle();if(x){console.error(`❌ 중복 체크 오류 (${p}):`,x);continue}if(n)continue;const f=parseFloat(e.bet||e.bet_amount||"0"),$=parseFloat(e.win||e.win_amount||"0"),C=parseFloat(e.balance||e.balance_after||"0"),ee=C-($-f),Y={partner_id:l.id,external_txid:p,username:e.username,user_id:m.id,game_id:e.game||e.game_id,provider_id:Math.floor((e.game||e.game_id)/1e3),game_title:e.game_title||null,provider_name:e.provider_name||null,bet_amount:f,win_amount:$,balance_before:ee,balance_after:C,played_at:e.create_at||e.played_at||e.created_at||new Date().toISOString()};console.log(`💾 INSERT 시도: txid=${p}, user=${e.username}`);const{data:me,error:M}=await c.from("game_records").insert(Y).select();M?(console.error(`❌ INSERT 실패 (${p}):`,M),console.error("실패한 데이터:",Y)):(console.log(`✅ INSERT 성공: ${p} (${e.username})`),y++)}catch(m){console.error("❌ 레코드 처리 예외:",m,e)}console.log(`📊 파트너 ${l.id}: DB 저장 완료 (성공: ${y}, 건너뜀: ${skippedCount}, 전체: ${d.length})`)}catch(o){console.error(`❌ 파트너 ${l.id} 처리 중 오류:`,o)}await T(),w.success(`베팅 기록 업데이트 완료 (${h}건 처리)`)}catch(t){console.error("❌ 베팅 기록 업데이트 오류:",t),w.error("베팅 기록 업데이트에 실패했습니다.")}finally{L(!1)}},Q=()=>{try{const t=[["TX ID","사용자","게임명","제공사","베팅액","당첨액","베팅전금액","베팅후금액","손익","플레이 시간"].join(","),...j.map(s=>{const h=parseFloat(s.win_amount?.toString()||"0")-parseFloat(s.bet_amount?.toString()||"0");return[s.external_txid,s.username,s.game_title||`Game ${s.game_id}`,s.provider_name||`Provider ${s.provider_id}`,s.bet_amount,s.win_amount,s.balance_before,s.balance_after,h,P(s.played_at)].join(",")})].join(`
`),r=new Blob(["\uFEFF"+t],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a"),u=URL.createObjectURL(r);i.setAttribute("href",u),i.setAttribute("download",`betting_history_${A}_${new Date().toISOString().split("T")[0]}.csv`),i.style.visibility="hidden",document.body.appendChild(i),i.click(),document.body.removeChild(i),w.success("베팅 내역 다운로드 완료")}catch(t){console.error("다운로드 오류:",t),w.error("다운로드 실패")}};b.useEffect(()=>{T()},[A]),b.useEffect(()=>{console.log("🔌 Realtime 구독 시작");const t=c.channel("betting-realtime").on("postgres_changes",{event:"*",schema:"public",table:"game_records"},r=>{console.log("🎲 베팅 데이터 변경 감지:",r),T()}).subscribe(r=>{console.log("📡 Realtime 구독 상태:",r)});return()=>{console.log("🔌 Realtime 구독 해제"),c.removeChannel(t)}},[A]),b.useEffect(()=>{console.log("🎯 [AUTO-SYNC] 자동 베팅 동기화 시작");let t=!1;const r=async()=>{if(t){console.log("⏭️ [AUTO-SYNC] 이미 처리 중, 건너뜀");return}try{const{data:s,error:h}=await c.from("game_launch_sessions").select("id").eq("status","active").limit(1);if(h){console.error("❌ [AUTO-SYNC] 세션 조회 실패:",h);return}if(!s||s.length===0){console.log("ℹ️ [AUTO-SYNC] Active 세션 없음, 동기화 건너뜀");return}console.log("✅ [AUTO-SYNC] Active 세션 발견, 동기화 시작"),t=!0;const l=new Date,o=l.getFullYear().toString(),d=(l.getMonth()+1).toString(),{data:_,error:S}=await c.from("partners").select("id, opcode, secret_key").not("opcode","is",null).not("secret_key","is",null);if(S||!_||_.length===0){console.log("⚠️ [AUTO-SYNC] API 설정이 있는 파트너가 없음");return}let y=0;for(const e of _)try{const m=await W(e.opcode,o,d,0,1e3,e.secret_key);if(m.error||!m.data){console.log(`⚠️ [AUTO-SYNC] 파트너 ${e.id} API 호출 실패`);continue}let g=[];if(m.data.DATA&&Array.isArray(m.data.DATA)?g=m.data.DATA:Array.isArray(m.data)&&(g=m.data),g.length===0){console.log(`ℹ️ [AUTO-SYNC] 파트너 ${e.id} 베팅 데이터 없음`);continue}console.log(`📊 [AUTO-SYNC] 파트너 ${e.id}: ${g.length}건 처리`);for(const n of g)try{const{data:x}=await c.from("users").select("id").eq("username",n.username).eq("referrer_id",e.id).maybeSingle();if(!x)continue;const f=(n.id||n.txid)?.toString();if(!f)continue;const{data:$}=await c.from("game_records").select("id").eq("external_txid",f).eq("partner_id",e.id).maybeSingle();if($)continue;const{error:C}=await c.from("game_records").insert({partner_id:e.id,external_txid:f,username:n.username,user_id:x.id,game_id:n.game||n.game_id,provider_id:Math.floor((n.game||n.game_id)/1e3),game_title:n.game_title||null,provider_name:n.provider_name||null,bet_amount:parseFloat(n.bet||n.bet_amount||"0"),win_amount:parseFloat(n.win||n.win_amount||"0"),balance_before:parseFloat(n.balance_before||"0"),balance_after:parseFloat(n.balance||n.balance_after||"0"),played_at:n.create_at||n.played_at||n.created_at||new Date().toISOString()});C||y++}catch{}const p=new Map;g.forEach(n=>{n.username&&n.balance!==void 0&&p.set(n.username,n.balance)});for(const[n,x]of p){const{data:f}=await c.from("users").select("id").eq("username",n).eq("referrer_id",e.id).maybeSingle();if(!f)continue;const{data:$}=await c.from("game_launch_sessions").select("id").eq("user_id",f.id).eq("status","active").limit(1).maybeSingle();$&&await c.from("users").update({balance:x}).eq("id",f.id)}}catch(m){console.error(`❌ [AUTO-SYNC] 파트너 ${e.id} 처리 오류:`,m)}y>0&&(console.log(`✅ [AUTO-SYNC] 완료: ${y}건 저장`),await T())}catch(s){console.error("❌ [AUTO-SYNC] 자동 동기화 실패:",s)}finally{t=!1}},i=setInterval(()=>{console.log("⏰ [AUTO-SYNC] 30초 타이머 실행"),r()},3e4),u=setTimeout(()=>{console.log("⏰ [AUTO-SYNC] 초기 15초 타이머 실행"),r()},15e3);return()=>{console.log("🔌 [AUTO-SYNC] 타이머 정리"),clearInterval(i),clearTimeout(u)}},[]);const j=D?B.filter(t=>t.username?.toLowerCase().includes(D.toLowerCase())):B,Z=[{key:"external_txid",title:"TX ID",render:t=>a.jsx(H,{variant:"outline",className:"border-slate-600 text-slate-300",children:t||"-"})},{key:"username",title:"사용자",render:t=>a.jsx("span",{className:"text-slate-300",children:t||"Unknown"})},{key:"game_title",title:"게임명",render:(t,r)=>a.jsx("span",{className:"max-w-[200px] truncate text-slate-300",title:t||`Game ${r.game_id}`,children:t||`Game ${r.game_id}`})},{key:"provider_name",title:"제공사",render:(t,r)=>a.jsx(H,{variant:"secondary",className:"bg-slate-700 text-slate-300",children:t||`Provider ${r.provider_id}`})},{key:"bet_amount",title:"베팅액",render:t=>a.jsxs("span",{className:"font-mono text-cyan-400",children:["₩",parseFloat(t?.toString()||"0").toLocaleString()]})},{key:"win_amount",title:"당첨액",render:t=>{const r=parseFloat(t?.toString()||"0");return a.jsxs("span",{className:`font-mono ${r>0?"text-emerald-400":"text-slate-500"}`,children:["₩",r.toLocaleString()]})}},{key:"balance_before",title:"베팅전금액",render:t=>a.jsxs("span",{className:"font-mono text-purple-400",children:["₩",parseFloat(t?.toString()||"0").toLocaleString()]})},{key:"balance_after",title:"베팅후금액",render:t=>a.jsxs("span",{className:"font-mono text-indigo-400",children:["₩",parseFloat(t?.toString()||"0").toLocaleString()]})},{key:"played_at",title:"손익",render:(t,r)=>{const i=parseFloat(r.win_amount?.toString()||"0")-parseFloat(r.bet_amount?.toString()||"0");return a.jsxs("span",{className:`font-mono ${i>0?"text-emerald-400":"text-rose-400"}`,children:[i>0?"+":"","₩",i.toLocaleString()]})}},{key:"played_at",title:"플레이 시간",render:t=>P(t)}];return a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5",children:[a.jsx(F,{title:"총 베팅 수",value:`${v.totalBets.toLocaleString()}건`,subtitle:"전체 게임 수",icon:I,color:"purple"}),a.jsx(F,{title:"총 베팅액",value:`₩${v.totalBetAmount.toLocaleString()}`,subtitle:"누적 베팅 금액",icon:I,color:"cyan"}),a.jsx(F,{title:"총 당첨액",value:`₩${v.totalWinAmount.toLocaleString()}`,subtitle:"누적 당첨 금액",icon:I,color:"green"}),a.jsx(F,{title:"순손익",value:`${v.netProfit>0?"+":""}₩${v.netProfit.toLocaleString()}`,subtitle:v.netProfit>0?"↑ 수익":"↓ 손실",icon:I,color:v.netProfit>0?"green":"rose"})]}),a.jsxs("div",{className:"glass-card rounded-xl p-6",children:[a.jsxs("div",{className:"mb-6",children:[a.jsxs("div",{className:"flex justify-between items-center mb-2",children:[a.jsxs("div",{children:[a.jsx("h3",{className:"font-semibold text-slate-100",children:"베팅 내역"}),a.jsx("p",{className:"text-sm text-slate-400 mt-1",children:N.nickname})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs(z,{onClick:K,disabled:U||q,size:"sm",variant:"outline",className:"border-amber-600/50 text-amber-400 hover:bg-amber-600/20",children:[a.jsx(le,{className:"h-4 w-4 mr-2"}),q?"업데이트 중...":"베팅기록업데이트"]}),a.jsxs(z,{onClick:Q,disabled:U||j.length===0,size:"sm",className:"border-slate-700 text-slate-300 hover:bg-slate-700/50",children:[a.jsx(ce,{className:"h-4 w-4 mr-2"}),"다운로드"]})]})]}),a.jsxs("p",{className:"text-sm text-slate-400",children:["조회: ",j.length,"건 / 전체: ",B.length,"건"]})]}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(G,{className:"text-slate-300",children:"기간"}),a.jsxs(te,{value:A,onValueChange:V,children:[a.jsx(ae,{className:"input-premium",children:a.jsx(re,{})}),a.jsxs(se,{className:"bg-slate-800 border-slate-700",children:[a.jsx(k,{value:"today",children:"오늘"}),a.jsx(k,{value:"week",children:"최근 7일"}),a.jsx(k,{value:"month",children:"최근 30일"}),a.jsx(k,{value:"all",children:"전체"})]})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(G,{className:"text-slate-300",children:"사용자명 검색"}),a.jsx(ne,{placeholder:"사용자명 입력...",value:D,onChange:t=>X(t.target.value),className:"input-premium"})]})]}),U?a.jsx("div",{className:"flex justify-center py-12",children:a.jsx(oe,{})}):j.length>0?a.jsx(ie,{columns:Z,data:j}):a.jsxs("div",{className:"text-center py-12 text-slate-400",children:[a.jsx(de,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),a.jsx("p",{children:"조회된 베팅 내역이 없습니다."}),a.jsx("p",{className:"text-sm mt-2",children:D?"검색 조건을 변경해보세요.":A!=="all"?'날짜 범위를 변경하거나 "전체"를 선택해보세요.':"DB에 베팅 데이터가 없습니다. 비상 동기화 버튼을 눌러보세요."})]})]})]})]})}export{Se as BettingHistory};
