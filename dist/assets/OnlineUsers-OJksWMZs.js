import{r as i,j as t}from"./react-core-CwM-CeLv.js";import{m as x,D as Z,s as d,B as P,E as L,F as q}from"./index-B_UTQDGv.js";import{D as ee}from"./DataTable-CkrjkuPp.js";import{k as m}from"./vendor-CQn7sZ7L.js";import{A as ae,a as te,b as se,c as re,d as ne,e as oe}from"./AdminDialog-B3Ze75jm.js";import{M as S}from"./MetricCard-CAttVRRt.js";import{R,U as ie,u as ce,i as le,t as de,a1 as me,a2 as ue,a3 as fe}from"./lucide-icons-wLPRtdhM.js";import"./radix-ui-SX2QAG6c.js";import"./supabase-r6ABpEO8.js";const ge={1:"ë§ˆì´í¬ë¡œê²Œì´ë°",17:"í”Œë ˆì´ì•¤ê³ ",20:"CQ9 ê²Œì´ë°",21:"ì œë„¤ì‹œìŠ¤ ê²Œì´ë°",22:"í•˜ë°”ë„¤ë¡œ",23:"ê²Œìž„ì•„íŠ¸",27:"í”Œë ˆì´í…",38:"ë¸”ë£¨í”„ë¦°íŠ¸",39:"ë¶€ìš´ê³ ",40:"ë“œë¼êµ°ì†Œí”„íŠ¸",41:"ì—˜í¬ ìŠ¤íŠœë””ì˜¤",47:"ë“œë¦¼í…Œí¬",51:"ì¹¼ëžŒë°” ê²Œìž„ì¦ˆ",52:"ëª¨ë¹Œë¡¯",53:"ë…¸ë¦¬ë°‹ ì‹œí‹°",55:"OMI ê²Œì´ë°",56:"ì›í„°ì¹˜",59:"í”Œë ˆì´ìŠ¨",60:"í‘¸ì‰¬ ê²Œì´ë°",61:"í€µìŠ¤í•€",62:"RTG ìŠ¬ë¡¯",63:"ë¦¬ë³¼ë²„ ê²Œì´ë°",65:"ìŠ¬ë¡¯ë°€",66:"ìŠ¤í”¼ì–´í—¤ë“œ",70:"ì¬ë”í‚¥",72:"ìš°í›„ ê²Œìž„ì¦ˆ",74:"ë¦´ë ‰ìŠ¤ ê²Œì´ë°",75:"ë„·ì—”íŠ¸",76:"ë ˆë“œíƒ€ì´ê±°",87:"PGì†Œí”„íŠ¸",88:"í”Œë ˆì´ìŠ¤íƒ€",90:"ë¹…íƒ€ìž„ê²Œì´ë°",300:"í”„ë¼ê·¸ë§ˆí‹± í”Œë ˆì´",410:"ì—ë³¼ë£¨ì…˜ ê²Œì´ë°",77:"ë§ˆì´í¬ë¡œê²Œì´ë° ë¼ì´ë¸Œ",2:"Vivo ê²Œì´ë°",30:"ì•„ì‹œì•„ ê²Œì´ë°",78:"í”„ë¼ê·¸ë§ˆí‹± í”Œë ˆì´ ë¼ì´ë¸Œ",86:"ì„¹ì‹œê²Œì´ë°",11:"ë¹„ë¹„ì•„ì´ì—”",28:"ë“œë¦¼ê²Œìž„",89:"ì˜¤ë¦¬ì—”íƒˆê²Œìž„",91:"ë³´íƒ€",44:"ì´ì£¼ê¸°",85:"í”Œë ˆì´í… ë¼ì´ë¸Œ",0:"ì œë„¤ëŸ´ ì¹´ì§€ë…¸"},he={41e4:"ì—ë³¼ë£¨ì…˜ ë¼ì´ë¸Œì¹´ì§€ë…¸",77060:"ë§ˆì´í¬ë¡œê²Œì´ë° ë¼ì´ë¸Œì¹´ì§€ë…¸",2029:"Vivo ë¼ì´ë¸Œì¹´ì§€ë…¸",3e4:"ì•„ì‹œì•„ê²Œì´ë° ë¼ì´ë¸Œì¹´ì§€ë…¸",78001:"í”„ë¼ê·¸ë§ˆí‹± ë¼ì´ë¸Œì¹´ì§€ë…¸",86001:"ì„¹ì‹œê²Œì´ë° ë¼ì´ë¸Œì¹´ì§€ë…¸",11e3:"ë¹„ë¹„ì•„ì´ì—” ë¼ì´ë¸Œì¹´ì§€ë…¸",28e3:"ë“œë¦¼ê²Œìž„ ë¼ì´ë¸Œì¹´ì§€ë…¸",89e3:"ì˜¤ë¦¬ì—”íƒˆê²Œìž„ ë¼ì´ë¸Œì¹´ì§€ë…¸",91e3:"ë³´íƒ€ ë¼ì´ë¸Œì¹´ì§€ë…¸",44006:"ì´ì£¼ê¸° ë¼ì´ë¸Œì¹´ì§€ë…¸",85036:"í”Œë ˆì´í… ë¼ì´ë¸Œì¹´ì§€ë…¸",0:"ì œë„¤ëŸ´ ë¼ì´ë¸Œì¹´ì§€ë…¸"};function ke({user:l}){const[u,U]=i.useState([]),[j,k]=i.useState(!0),[D,M]=i.useState(!1),[b,I]=i.useState(null),[G,v]=i.useState(!1),[C,A]=i.useState(null),[_e,K]=i.useState(0);i.useEffect(()=>{const e=setInterval(()=>K(a=>a+1),1e3);return()=>clearInterval(e)},[]);const p=async(e=!1)=>{try{!e&&j?k(!0):M(!0);const a=new Date,r=new Date(a.getTime()-6e4);console.log("ðŸ• ì„¸ì…˜ ìžë™ ì¢…ë£Œ ì²´í¬:",{í˜„ìž¬ì‹œê°„:a.toISOString(),ê¸°ì¤€ì‹œê°„_60ì´ˆì „:r.toISOString()});const{data:n,error:o}=await Z.from("game_launch_sessions").update({status:"auto_ended",ended_at:a.toISOString()}).eq("status","active").lt("last_activity_at",r.toISOString()).select("id, user_id, last_activity_at");if(o)console.error("âŒ ì„¸ì…˜ ìžë™ ì¢…ë£Œ ì˜¤ë¥˜:",o);else if(n&&n.length>0){console.log(`âœ… ${n.length}ê°œ ì„¸ì…˜ ìžë™ ì¢…ë£Œ:`,n.map(s=>({id:s.id,user_id:s.user_id,ë§ˆì§€ë§‰í™œë™:s.last_activity_at,ê²½ê³¼ì‹œê°„_ì´ˆ:Math.floor((a.getTime()-new Date(s.last_activity_at).getTime())/1e3)})));for(const s of n)await F(s.user_id)}let f=d.from("game_launch_sessions").select(`
          id,
          session_id,
          user_id,
          game_id,
          balance_before,
          launched_at,
          last_activity_at,
          users!inner(
            id,
            username,
            nickname,
            balance,
            ip_address,
            device_info,
            referrer_id
          )
        `).eq("status","active").order("last_activity_at",{ascending:!1});if(l.partner_type!=="ì‹œìŠ¤í…œê´€ë¦¬ìž"){const{data:s}=await d.from("partners").select("id").or(`parent_id.eq.${l.id},id.eq.${l.id}`),h=s?.map(_=>_.id)||[l.id];f=f.in("users.referrer_id",h)}const{data:y,error:O}=await f;if(O)throw O;const T=[...new Set((y||[]).map(s=>s.game_id).filter(Boolean))];let B={};if(T.length>0){const{data:s}=await d.from("games").select("id, name, provider_id, game_providers(name)").in("id",T);s&&(B=Object.fromEntries(s.map(h=>[h.id,h])))}const J=(y||[]).map(s=>{const h=s.users.ip_address||"-";let _="PC";if(s.users.device_info){const g=s.users.device_info;if(g.device==="Mobile"||g.device==="mobile")_="Mobile";else if(g.platform){const c=String(g.platform).toLowerCase();(c.includes("android")||c.includes("iphone")||c.includes("ipad")||c.includes("mobile"))&&(_="Mobile")}else if(g.userAgent){const c=String(g.userAgent).toLowerCase();(c.includes("mobile")||c.includes("android")||c.includes("iphone")||c.includes("ipad"))&&(_="Mobile")}}const E=Math.floor(s.game_id/1e3),X=ge[E]||`Provider ${E}`;let N=he[s.game_id];return N||(N=B[s.game_id]?.name||`Game ${s.game_id}`),{id:s.id,session_id:s.session_id,user_id:s.users.id,username:s.users.username,nickname:s.users.nickname||s.users.username,game_name:N,provider_name:X,balance_before:Number(s.balance_before)||0,current_balance:Number(s.users.balance)||0,device_type:_,ip_address:h,launched_at:s.launched_at,last_activity_at:s.last_activity_at}});U(J)}catch(a){console.error("ì„¸ì…˜ ë¡œë“œ ì˜¤ë¥˜:",a),m.error("ì„¸ì…˜ ë¡œë“œ ì‹¤íŒ¨")}finally{k(!1),M(!1)}};i.useEffect(()=>{console.log("ðŸ”„ OnlineUsers 30ì´ˆ íƒ€ì´ë¨¸ ì‹œìž‘"),p();const e=setInterval(()=>{console.log("â° 30ì´ˆ ê²½ê³¼ - ì„¸ì…˜ ìžë™ ì¢…ë£Œ ì²´í¬ ì‹¤í–‰"),p()},3e4);return()=>{console.log("ðŸ›‘ OnlineUsers 30ì´ˆ íƒ€ì´ë¨¸ ì¢…ë£Œ"),clearInterval(e)}},[l.id,l.partner_type]),i.useEffect(()=>{const e=async()=>{try{const r=new Date(Date.now()-144e5).toISOString(),{data:n,error:o}=await d.from("game_launch_sessions").delete().in("status",["auto_ended","ended","force_ended"]).lt("ended_at",r).select("id");o?console.error("ì„¸ì…˜ ì •ë¦¬ ì˜¤ë¥˜:",o):n&&n.length>0&&console.log(`ðŸ—‘ï¸ ${n.length}ê°œ ì˜¤ëž˜ëœ ì„¸ì…˜ ì‚­ì œ (4ì‹œê°„ ê²½ê³¼)`)}catch(r){console.error("ì„¸ì…˜ ì •ë¦¬ ì‹¤í–‰ ì˜¤ë¥˜:",r)}};e();const a=setInterval(e,3600*1e3);return()=>clearInterval(a)},[]);const V=e=>{const a=new Date(e).getTime(),r=Date.now(),n=Math.max(0,r-a);if(isNaN(n))return"0ë¶„";const o=Math.floor(n/1e3/60);if(o<60)return`${o}ë¶„`;const f=Math.floor(o/60),y=o%60;return`${f}ì‹œê°„ ${y}ë¶„`},z=async e=>{try{A(e.user_id);const a=await L(l.id);if(!a){m.error("API ì„¤ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");return}const r=await q(a.opcode,e.username,a.token,a.secret_key);r&&r.success&&typeof r.balance=="number"?(await d.from("users").update({balance:r.balance}).eq("id",e.user_id),m.success("ë³´ìœ ê¸ˆ ë™ê¸°í™” ì™„ë£Œ"),p()):m.error(r?.error||"ë³´ìœ ê¸ˆ ì¡°íšŒ ì‹¤íŒ¨")}catch(a){console.error("ë³´ìœ ê¸ˆ ë™ê¸°í™” ì˜¤ë¥˜:",a),m.error("ë³´ìœ ê¸ˆ ë™ê¸°í™” ì‹¤íŒ¨")}finally{A(null)}},F=async e=>{try{const a=await L(l.id);if(!a){console.error("ì„¸ì…˜ ì¢…ë£Œ ì‹œ API ì„¤ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");return}const r=await d.from("users").select("username").eq("id",e).single();if(!r.data){console.error("ì„¸ì…˜ ì¢…ë£Œ ì‹œ ì‚¬ìš©ìž ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");return}const n=await q(a.opcode,r.data.username,a.token,a.secret_key);n&&n.success&&typeof n.balance=="number"?(await d.from("users").update({balance:n.balance}).eq("id",e),console.log(`ì„¸ì…˜ ì¢…ë£Œ ì‹œ ë³´ìœ ê¸ˆ ë™ê¸°í™” ì™„ë£Œ: ${e}`)):console.error(n?.error||"ì„¸ì…˜ ì¢…ë£Œ ì‹œ ë³´ìœ ê¸ˆ ì¡°íšŒ ì‹¤íŒ¨")}catch(a){console.error("ì„¸ì…˜ ì¢…ë£Œ ì‹œ ë³´ìœ ê¸ˆ ë™ê¸°í™” ì˜¤ë¥˜:",a)}},H=async()=>{if(b)try{const{error:e}=await d.from("game_launch_sessions").update({status:"force_ended",ended_at:new Date().toISOString()}).eq("id",b.id);if(e){console.error("ì„¸ì…˜ ì¢…ë£Œ ì˜¤ë¥˜:",e),m.error(`ì„¸ì…˜ ì¢…ë£Œ ì‹¤íŒ¨: ${e.message}`);return}m.success("ì„¸ì…˜ ê°•ì œ ì¢…ë£Œ ì™„ë£Œ"),v(!1),I(null),await p()}catch(e){console.error("ê°•ì œ ì¢…ë£Œ ì˜¤ë¥˜:",e),m.error("ê°•ì œ ì¢…ë£Œ ì‹¤íŒ¨")}},Q=u.length,W=u.reduce((e,a)=>e+a.current_balance,0),w=u.reduce((e,a)=>e+(a.current_balance-a.balance_before),0);let $=0;if(u.length>0){const e=Date.now(),a=u.reduce((r,n)=>{const o=new Date(n.launched_at).getTime(),f=Math.max(0,e-o);return r+f/1e3/60},0);$=Math.floor(a/u.length)}const Y=[{key:"username",header:"ì‚¬ìš©ìž",sortable:!0},{key:"nickname",header:"ë‹‰ë„¤ìž„",sortable:!0},{key:"game_name",header:"ê²Œìž„",sortable:!0,render:(e,a)=>t.jsxs("div",{className:"space-y-1",children:[t.jsx("div",{className:"text-slate-200",children:e}),t.jsx(P,{variant:"outline",className:"bg-emerald-500/10 text-emerald-400 border-emerald-500/30",children:a.provider_name})]})},{key:"balance_before",header:"ê²Œìž„ ì‹œìž‘ê¸ˆ",sortable:!0,render:e=>t.jsxs("span",{className:"font-mono text-slate-300",children:["â‚©",e.toLocaleString()]})},{key:"current_balance",header:"ë³€ê²½ ë³´ìœ ê¸ˆ",sortable:!0,render:(e,a)=>{const r=e-a.balance_before,n=r>=0?"text-emerald-400":"text-red-400",o=r>=0?"+":"";return t.jsxs("div",{className:"space-y-1",children:[t.jsxs("div",{className:"font-mono text-slate-200",children:["â‚©",e.toLocaleString()]}),r!==0&&t.jsxs("div",{className:`text-xs font-mono ${n}`,children:[o,"â‚©",r.toLocaleString()]})]})}},{key:"device_type",header:"ì ‘ì†ê²½ë¡œ",render:e=>t.jsxs(P,{variant:e==="Mobile"?"default":"secondary",className:"gap-1",children:[e==="Mobile"?t.jsx(me,{className:"w-3 h-3"}):t.jsx(ue,{className:"w-3 h-3"}),e]})},{key:"ip_address",header:"IP ì£¼ì†Œ",sortable:!0,render:e=>t.jsx("span",{className:"text-slate-300 font-mono text-xs",children:e})},{key:"launched_at",header:"ì ‘ì† ì‹œê°„",render:e=>t.jsx("span",{className:"text-slate-300",children:V(e)})},{key:"actions",header:"ê´€ë¦¬",render:(e,a)=>t.jsxs("div",{className:"flex items-center gap-2 justify-center",children:[t.jsx(x,{variant:"ghost",size:"sm",onClick:()=>z(a),disabled:C===a.user_id,className:"text-slate-400 hover:text-slate-200",children:t.jsx(R,{className:`w-3 h-3 ${C===a.user_id?"animate-spin":""}`})}),t.jsx(x,{variant:"ghost",size:"sm",onClick:()=>{I(a),v(!0)},className:"bg-red-500/10 text-red-400 hover:bg-red-500/20 hover:text-red-300",children:t.jsx(fe,{className:"w-3 h-3"})})]})}];return t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"text-2xl font-bold text-slate-100",children:"ì˜¨ë¼ì¸ í˜„í™©"}),t.jsx("p",{className:"text-sm text-slate-400 mt-1",children:"ì‹¤ì‹œê°„ ê²Œìž„ ì‚¬ìš©ìž ê´€ë¦¬"})]}),t.jsxs(x,{onClick:()=>p(!0),disabled:j||D,children:[t.jsx(R,{className:`w-4 h-4 mr-2 ${D?"animate-spin":""}`}),"ìƒˆë¡œê³ ì¹¨"]})]}),t.jsxs("div",{className:"grid gap-5 md:grid-cols-2 lg:grid-cols-4",children:[t.jsx(S,{title:"ì˜¨ë¼ì¸ ì‚¬ìš©ìž",value:`${Q}ëª…`,subtitle:"ì‹¤ì‹œê°„ ì ‘ì†ìž",icon:ie,color:"purple"}),t.jsx(S,{title:"ì´ ê²Œìž„ ë³´ìœ ê¸ˆ",value:`â‚©${W.toLocaleString()}`,subtitle:"ê²Œìž„ ë‚´ ì´ ìž”ê³ ",icon:ce,color:"amber"}),t.jsx(S,{title:"ì´ ì†ìµ",value:`â‚©${w.toLocaleString()}`,subtitle:w>=0?"â†‘ ì‚¬ìš©ìž ì´ìµ":"â†“ ì‚¬ìš©ìž ì†ì‹¤",icon:le,color:w>=0?"green":"red"}),t.jsx(S,{title:"í‰ê·  ì„¸ì…˜",value:`${$}ë¶„`,subtitle:"í‰ê·  ì ‘ì† ì‹œê°„",icon:de,color:"cyan"})]}),t.jsx(ee,{data:u,columns:Y,loading:j,emptyMessage:"í˜„ìž¬ ì˜¨ë¼ì¸ ì‚¬ìš©ìžê°€ ì—†ìŠµë‹ˆë‹¤"}),t.jsx(ae,{open:G,onOpenChange:v,children:t.jsxs(te,{children:[t.jsxs(se,{children:[t.jsx(re,{children:"ì„¸ì…˜ ê°•ì œ ì¢…ë£Œ"}),t.jsxs(ne,{children:[b?.username,"(",b?.nickname,") ë‹˜ì˜ ì„¸ì…˜ì„ ê°•ì œ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"]})]}),t.jsxs(oe,{children:[t.jsx(x,{variant:"outline",onClick:()=>v(!1),children:"ì·¨ì†Œ"}),t.jsx(x,{variant:"destructive",onClick:H,children:"ê°•ì œ ì¢…ë£Œ"})]})]})})]})}export{ke as OnlineUsers};
