import{r as i,j as t}from"./react-core-CwM-CeLv.js";import{m as x,D as Z,s as d,B as P,E as L,F as q}from"./index-B_UTQDGv.js";import{D as ee}from"./DataTable-CkrjkuPp.js";import{k as m}from"./vendor-CQn7sZ7L.js";import{A as ae,a as te,b as se,c as re,d as ne,e as oe}from"./AdminDialog-B3Ze75jm.js";import{M as S}from"./MetricCard-CAttVRRt.js";import{R,U as ie,u as ce,i as le,t as de,a1 as me,a2 as ue,a3 as fe}from"./lucide-icons-wLPRtdhM.js";import"./radix-ui-SX2QAG6c.js";import"./supabase-r6ABpEO8.js";const ge={1:"마이크로게이밍",17:"플레이앤고",20:"CQ9 게이밍",21:"제네시스 게이밍",22:"하바네로",23:"게임아트",27:"플레이텍",38:"블루프린트",39:"부운고",40:"드라군소프트",41:"엘크 스튜디오",47:"드림테크",51:"칼람바 게임즈",52:"모빌롯",53:"노리밋 시티",55:"OMI 게이밍",56:"원터치",59:"플레이슨",60:"푸쉬 게이밍",61:"퀵스핀",62:"RTG 슬롯",63:"리볼버 게이밍",65:"슬롯밀",66:"스피어헤드",70:"썬더킥",72:"우후 게임즈",74:"릴렉스 게이밍",75:"넷엔트",76:"레드타이거",87:"PG소프트",88:"플레이스타",90:"빅타임게이밍",300:"프라그마틱 플레이",410:"에볼루션 게이밍",77:"마이크로게이밍 라이브",2:"Vivo 게이밍",30:"아시아 게이밍",78:"프라그마틱 플레이 라이브",86:"섹시게이밍",11:"비비아이엔",28:"드림게임",89:"오리엔탈게임",91:"보타",44:"이주기",85:"플레이텍 라이브",0:"제네럴 카지노"},he={41e4:"에볼루션 라이브카지노",77060:"마이크로게이밍 라이브카지노",2029:"Vivo 라이브카지노",3e4:"아시아게이밍 라이브카지노",78001:"프라그마틱 라이브카지노",86001:"섹시게이밍 라이브카지노",11e3:"비비아이엔 라이브카지노",28e3:"드림게임 라이브카지노",89e3:"오리엔탈게임 라이브카지노",91e3:"보타 라이브카지노",44006:"이주기 라이브카지노",85036:"플레이텍 라이브카지노",0:"제네럴 라이브카지노"};function ke({user:l}){const[u,U]=i.useState([]),[j,k]=i.useState(!0),[D,M]=i.useState(!1),[b,I]=i.useState(null),[G,v]=i.useState(!1),[C,A]=i.useState(null),[_e,K]=i.useState(0);i.useEffect(()=>{const e=setInterval(()=>K(a=>a+1),1e3);return()=>clearInterval(e)},[]);const p=async(e=!1)=>{try{!e&&j?k(!0):M(!0);const a=new Date,r=new Date(a.getTime()-6e4);console.log("🕐 세션 자동 종료 체크:",{현재시간:a.toISOString(),기준시간_60초전:r.toISOString()});const{data:n,error:o}=await Z.from("game_launch_sessions").update({status:"auto_ended",ended_at:a.toISOString()}).eq("status","active").lt("last_activity_at",r.toISOString()).select("id, user_id, last_activity_at");if(o)console.error("❌ 세션 자동 종료 오류:",o);else if(n&&n.length>0){console.log(`✅ ${n.length}개 세션 자동 종료:`,n.map(s=>({id:s.id,user_id:s.user_id,마지막활동:s.last_activity_at,경과시간_초:Math.floor((a.getTime()-new Date(s.last_activity_at).getTime())/1e3)})));for(const s of n)await F(s.user_id)}let f=d.from("game_launch_sessions").select(`
          id,
          session_id,
          user_id,
          game_id,
          balance_before,
          launched_at,
          last_activity_at,
          users!inner(
            id,
            username,
            nickname,
            balance,
            ip_address,
            device_info,
            referrer_id
          )
        `).eq("status","active").order("last_activity_at",{ascending:!1});if(l.partner_type!=="시스템관리자"){const{data:s}=await d.from("partners").select("id").or(`parent_id.eq.${l.id},id.eq.${l.id}`),h=s?.map(_=>_.id)||[l.id];f=f.in("users.referrer_id",h)}const{data:y,error:O}=await f;if(O)throw O;const T=[...new Set((y||[]).map(s=>s.game_id).filter(Boolean))];let B={};if(T.length>0){const{data:s}=await d.from("games").select("id, name, provider_id, game_providers(name)").in("id",T);s&&(B=Object.fromEntries(s.map(h=>[h.id,h])))}const J=(y||[]).map(s=>{const h=s.users.ip_address||"-";let _="PC";if(s.users.device_info){const g=s.users.device_info;if(g.device==="Mobile"||g.device==="mobile")_="Mobile";else if(g.platform){const c=String(g.platform).toLowerCase();(c.includes("android")||c.includes("iphone")||c.includes("ipad")||c.includes("mobile"))&&(_="Mobile")}else if(g.userAgent){const c=String(g.userAgent).toLowerCase();(c.includes("mobile")||c.includes("android")||c.includes("iphone")||c.includes("ipad"))&&(_="Mobile")}}const E=Math.floor(s.game_id/1e3),X=ge[E]||`Provider ${E}`;let N=he[s.game_id];return N||(N=B[s.game_id]?.name||`Game ${s.game_id}`),{id:s.id,session_id:s.session_id,user_id:s.users.id,username:s.users.username,nickname:s.users.nickname||s.users.username,game_name:N,provider_name:X,balance_before:Number(s.balance_before)||0,current_balance:Number(s.users.balance)||0,device_type:_,ip_address:h,launched_at:s.launched_at,last_activity_at:s.last_activity_at}});U(J)}catch(a){console.error("세션 로드 오류:",a),m.error("세션 로드 실패")}finally{k(!1),M(!1)}};i.useEffect(()=>{console.log("🔄 OnlineUsers 30초 타이머 시작"),p();const e=setInterval(()=>{console.log("⏰ 30초 경과 - 세션 자동 종료 체크 실행"),p()},3e4);return()=>{console.log("🛑 OnlineUsers 30초 타이머 종료"),clearInterval(e)}},[l.id,l.partner_type]),i.useEffect(()=>{const e=async()=>{try{const r=new Date(Date.now()-144e5).toISOString(),{data:n,error:o}=await d.from("game_launch_sessions").delete().in("status",["auto_ended","ended","force_ended"]).lt("ended_at",r).select("id");o?console.error("세션 정리 오류:",o):n&&n.length>0&&console.log(`🗑️ ${n.length}개 오래된 세션 삭제 (4시간 경과)`)}catch(r){console.error("세션 정리 실행 오류:",r)}};e();const a=setInterval(e,3600*1e3);return()=>clearInterval(a)},[]);const V=e=>{const a=new Date(e).getTime(),r=Date.now(),n=Math.max(0,r-a);if(isNaN(n))return"0분";const o=Math.floor(n/1e3/60);if(o<60)return`${o}분`;const f=Math.floor(o/60),y=o%60;return`${f}시간 ${y}분`},z=async e=>{try{A(e.user_id);const a=await L(l.id);if(!a){m.error("API 설정을 찾을 수 없습니다");return}const r=await q(a.opcode,e.username,a.token,a.secret_key);r&&r.success&&typeof r.balance=="number"?(await d.from("users").update({balance:r.balance}).eq("id",e.user_id),m.success("보유금 동기화 완료"),p()):m.error(r?.error||"보유금 조회 실패")}catch(a){console.error("보유금 동기화 오류:",a),m.error("보유금 동기화 실패")}finally{A(null)}},F=async e=>{try{const a=await L(l.id);if(!a){console.error("세션 종료 시 API 설정을 찾을 수 없습니다");return}const r=await d.from("users").select("username").eq("id",e).single();if(!r.data){console.error("세션 종료 시 사용자 정보를 찾을 수 없습니다");return}const n=await q(a.opcode,r.data.username,a.token,a.secret_key);n&&n.success&&typeof n.balance=="number"?(await d.from("users").update({balance:n.balance}).eq("id",e),console.log(`세션 종료 시 보유금 동기화 완료: ${e}`)):console.error(n?.error||"세션 종료 시 보유금 조회 실패")}catch(a){console.error("세션 종료 시 보유금 동기화 오류:",a)}},H=async()=>{if(b)try{const{error:e}=await d.from("game_launch_sessions").update({status:"force_ended",ended_at:new Date().toISOString()}).eq("id",b.id);if(e){console.error("세션 종료 오류:",e),m.error(`세션 종료 실패: ${e.message}`);return}m.success("세션 강제 종료 완료"),v(!1),I(null),await p()}catch(e){console.error("강제 종료 오류:",e),m.error("강제 종료 실패")}},Q=u.length,W=u.reduce((e,a)=>e+a.current_balance,0),w=u.reduce((e,a)=>e+(a.current_balance-a.balance_before),0);let $=0;if(u.length>0){const e=Date.now(),a=u.reduce((r,n)=>{const o=new Date(n.launched_at).getTime(),f=Math.max(0,e-o);return r+f/1e3/60},0);$=Math.floor(a/u.length)}const Y=[{key:"username",header:"사용자",sortable:!0},{key:"nickname",header:"닉네임",sortable:!0},{key:"game_name",header:"게임",sortable:!0,render:(e,a)=>t.jsxs("div",{className:"space-y-1",children:[t.jsx("div",{className:"text-slate-200",children:e}),t.jsx(P,{variant:"outline",className:"bg-emerald-500/10 text-emerald-400 border-emerald-500/30",children:a.provider_name})]})},{key:"balance_before",header:"게임 시작금",sortable:!0,render:e=>t.jsxs("span",{className:"font-mono text-slate-300",children:["₩",e.toLocaleString()]})},{key:"current_balance",header:"변경 보유금",sortable:!0,render:(e,a)=>{const r=e-a.balance_before,n=r>=0?"text-emerald-400":"text-red-400",o=r>=0?"+":"";return t.jsxs("div",{className:"space-y-1",children:[t.jsxs("div",{className:"font-mono text-slate-200",children:["₩",e.toLocaleString()]}),r!==0&&t.jsxs("div",{className:`text-xs font-mono ${n}`,children:[o,"₩",r.toLocaleString()]})]})}},{key:"device_type",header:"접속경로",render:e=>t.jsxs(P,{variant:e==="Mobile"?"default":"secondary",className:"gap-1",children:[e==="Mobile"?t.jsx(me,{className:"w-3 h-3"}):t.jsx(ue,{className:"w-3 h-3"}),e]})},{key:"ip_address",header:"IP 주소",sortable:!0,render:e=>t.jsx("span",{className:"text-slate-300 font-mono text-xs",children:e})},{key:"launched_at",header:"접속 시간",render:e=>t.jsx("span",{className:"text-slate-300",children:V(e)})},{key:"actions",header:"관리",render:(e,a)=>t.jsxs("div",{className:"flex items-center gap-2 justify-center",children:[t.jsx(x,{variant:"ghost",size:"sm",onClick:()=>z(a),disabled:C===a.user_id,className:"text-slate-400 hover:text-slate-200",children:t.jsx(R,{className:`w-3 h-3 ${C===a.user_id?"animate-spin":""}`})}),t.jsx(x,{variant:"ghost",size:"sm",onClick:()=>{I(a),v(!0)},className:"bg-red-500/10 text-red-400 hover:bg-red-500/20 hover:text-red-300",children:t.jsx(fe,{className:"w-3 h-3"})})]})}];return t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"text-2xl font-bold text-slate-100",children:"온라인 현황"}),t.jsx("p",{className:"text-sm text-slate-400 mt-1",children:"실시간 게임 사용자 관리"})]}),t.jsxs(x,{onClick:()=>p(!0),disabled:j||D,children:[t.jsx(R,{className:`w-4 h-4 mr-2 ${D?"animate-spin":""}`}),"새로고침"]})]}),t.jsxs("div",{className:"grid gap-5 md:grid-cols-2 lg:grid-cols-4",children:[t.jsx(S,{title:"온라인 사용자",value:`${Q}명`,subtitle:"실시간 접속자",icon:ie,color:"purple"}),t.jsx(S,{title:"총 게임 보유금",value:`₩${W.toLocaleString()}`,subtitle:"게임 내 총 잔고",icon:ce,color:"amber"}),t.jsx(S,{title:"총 손익",value:`₩${w.toLocaleString()}`,subtitle:w>=0?"↑ 사용자 이익":"↓ 사용자 손실",icon:le,color:w>=0?"green":"red"}),t.jsx(S,{title:"평균 세션",value:`${$}분`,subtitle:"평균 접속 시간",icon:de,color:"cyan"})]}),t.jsx(ee,{data:u,columns:Y,loading:j,emptyMessage:"현재 온라인 사용자가 없습니다"}),t.jsx(ae,{open:G,onOpenChange:v,children:t.jsxs(te,{children:[t.jsxs(se,{children:[t.jsx(re,{children:"세션 강제 종료"}),t.jsxs(ne,{children:[b?.username,"(",b?.nickname,") 님의 세션을 강제 종료하시겠습니까?"]})]}),t.jsxs(oe,{children:[t.jsx(x,{variant:"outline",onClick:()=>v(!1),children:"취소"}),t.jsx(x,{variant:"destructive",onClick:H,children:"강제 종료"})]})]})})]})}export{ke as OnlineUsers};
