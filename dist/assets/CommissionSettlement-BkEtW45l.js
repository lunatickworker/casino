import{r as i,j as t}from"./react-core-CwM-CeLv.js";import{s as M,L as W,m as g,c as F,C as $,a as B,b as E,d as q,S as z,p as V,q as Y,r as A,t as l,e as H,B as U}from"./index-B_UTQDGv.js";import{P as G,a as J,b as K}from"./popover-DF4XoxDI.js";import{C as Q}from"./calendar-DZkILWA1.js";import{k as b,m as j,n as d}from"./vendor-CQn7sZ7L.js";import{M as x}from"./MetricCard-CAttVRRt.js";import{calculateChildPartnersCommission as X}from"./settlementCalculator-j0yo2kjG.js";import{R as Z,a5 as tt,T as et,ac as st,W as at,e as nt,ab as it,ad as ot}from"./lucide-icons-wLPRtdhM.js";import"./radix-ui-SX2QAG6c.js";import"./supabase-r6ABpEO8.js";function St({user:u}){const[y,p]=i.useState(!0),[h,S]=i.useState(!1),[rt,L]=i.useState("direct_subordinate"),[c,_]=i.useState("today"),[a,D]=i.useState(),[f,C]=i.useState([]),[n,w]=i.useState({totalRollingCommission:0,totalLosingCommission:0,totalWithdrawalCommission:0,totalCommission:0,partnerCount:0});i.useEffect(()=>{I(),N()},[u.id,c,a]);const I=async()=>{try{const{data:e,error:s}=await M.from("system_settings").select("setting_value").eq("setting_key","settlement_method").single();if(s)throw s;e&&L(e.setting_value)}catch(e){console.error("정산 방식 로드 실패:",e)}},O=()=>{const e=new Date,s=new Date(e.getFullYear(),e.getMonth(),e.getDate());switch(c){case"today":return{start:s.toISOString(),end:new Date(s.getTime()+1440*60*1e3).toISOString()};case"yesterday":return{start:new Date(s.getTime()-1440*60*1e3).toISOString(),end:s.toISOString()};case"week":return{start:new Date(s.getTime()-10080*60*1e3).toISOString(),end:new Date(s.getTime()+1440*60*1e3).toISOString()};case"month":return{start:new Date(e.getFullYear(),e.getMonth(),1).toISOString(),end:new Date(s.getTime()+1440*60*1e3).toISOString()};case"custom":if(a?.from){const r=new Date(a.from),k=a.to?new Date(a.to):new Date(a.from);return{start:r.toISOString(),end:new Date(k.getTime()+1440*60*1e3).toISOString()}}return{start:s.toISOString(),end:new Date(s.getTime()+1440*60*1e3).toISOString()};default:return{start:s.toISOString(),end:new Date(s.getTime()+1440*60*1e3).toISOString()}}},N=async()=>{try{h||p(!0);const{start:e,end:s}=O(),m=await X(u.id,e,s);if(m.length===0){C([]),w({totalRollingCommission:0,totalLosingCommission:0,totalWithdrawalCommission:0,totalCommission:0,partnerCount:0});return}C(m);const v=m.reduce((o,r)=>({totalRollingCommission:o.totalRollingCommission+r.rolling_commission,totalLosingCommission:o.totalLosingCommission+r.losing_commission,totalWithdrawalCommission:o.totalWithdrawalCommission+r.withdrawal_commission,totalCommission:o.totalCommission+r.total_commission,partnerCount:o.partnerCount+1}),{totalRollingCommission:0,totalLosingCommission:0,totalWithdrawalCommission:0,totalCommission:0,partnerCount:0});w(v)}catch(e){console.error("수수료 계산 실패:",e),b.error("수수료 데이터를 불러오는데 실패했습니다.")}finally{p(!1),S(!1)}},P=()=>{S(!0),N()},R=()=>{b.info("엑셀 내보내기 기능은 준비중입니다.")},T=e=>{switch(e){case 2:return"대본사";case 3:return"본사";case 4:return"부본사";case 5:return"총판";case 6:return"매장";default:return"알 수 없음"}};return y?t.jsx("div",{className:"flex items-center justify-center h-96",children:t.jsx(W,{})}):t.jsxs("div",{className:"space-y-6 p-6",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl text-white mb-2",children:"파트너별 수수료 정산"}),t.jsx("p",{className:"text-slate-400",children:"직속 하위 파트너들에게 지급할 수수료를 확인합니다."})]}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs(g,{variant:"outline",size:"sm",onClick:P,disabled:h,children:[t.jsx(Z,{className:F("h-4 w-4 mr-2",h&&"animate-spin")}),"새로고침"]}),t.jsxs(g,{variant:"outline",size:"sm",onClick:R,children:[t.jsx(tt,{className:"h-4 w-4 mr-2"}),"엑셀 내보내기"]})]})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-5",children:[t.jsx(x,{title:"롤링 수수료",value:`₩${n.totalRollingCommission.toLocaleString()}`,subtitle:"↑ 베팅 기반 수수료",icon:et,color:"blue"}),t.jsx(x,{title:"죽장 수수료",value:`₩${n.totalLosingCommission.toLocaleString()}`,subtitle:"↑ 손실 기반 수수료",icon:st,color:"purple"}),t.jsx(x,{title:"이체 수수료",value:`₩${n.totalWithdrawalCommission.toLocaleString()}`,subtitle:"↑ 출금 기반 수수료",icon:at,color:"emerald"}),t.jsx(x,{title:"총 수수료",value:`₩${n.totalCommission.toLocaleString()}`,subtitle:"↑ 전체 수수료 합계",icon:nt,color:"orange"})]}),t.jsxs($,{children:[t.jsx(B,{children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx(E,{children:"하위 파트너별 수수료 상세"}),t.jsxs(q,{children:["총 ",n.partnerCount,"명의 하위 파트너 수수료 내역"]})]}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs(z,{value:c,onValueChange:_,children:[t.jsx(V,{className:"w-[180px]",children:t.jsx(Y,{})}),t.jsxs(A,{children:[t.jsx(l,{value:"today",children:"오늘"}),t.jsx(l,{value:"yesterday",children:"어제"}),t.jsx(l,{value:"week",children:"최근 7일"}),t.jsx(l,{value:"month",children:"이번 달"}),t.jsx(l,{value:"custom",children:"직접 선택"})]})]}),c==="custom"&&t.jsxs(G,{children:[t.jsx(J,{asChild:!0,children:t.jsxs(g,{variant:"outline",className:"w-[280px] justify-start text-left",children:[t.jsx(it,{className:"mr-2 h-4 w-4"}),a?.from?a.to?t.jsxs(t.Fragment,{children:[j(a.from,"PPP",{locale:d})," -"," ",j(a.to,"PPP",{locale:d})]}):j(a.from,"PPP",{locale:d}):t.jsx("span",{children:"날짜를 선택하세요"})]})}),t.jsx(K,{className:"w-auto p-0",align:"end",children:t.jsx(Q,{initialFocus:!0,mode:"range",defaultMonth:a?.from,selected:a,onSelect:D,numberOfMonths:2,locale:d})})]})]})]})}),t.jsx(H,{children:f.length===0?t.jsxs("div",{className:"text-center py-12 text-slate-400",children:[t.jsx(ot,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),t.jsx("p",{children:"조회된 하위 파트너가 없습니다."})]}):t.jsx("div",{className:"overflow-x-auto",children:t.jsxs("table",{className:"w-full",children:[t.jsx("thead",{children:t.jsxs("tr",{className:"border-b border-slate-700",children:[t.jsx("th",{className:"text-left p-3 text-slate-400",children:"파트너"}),t.jsx("th",{className:"text-left p-3 text-slate-400",children:"등급"}),t.jsx("th",{className:"text-right p-3 text-slate-400",children:"베팅액"}),t.jsx("th",{className:"text-right p-3 text-slate-400",children:"롤링 수수료"}),t.jsx("th",{className:"text-right p-3 text-slate-400",children:"죽장 수수료"}),t.jsx("th",{className:"text-right p-3 text-slate-400",children:"이체 수수료"}),t.jsx("th",{className:"text-right p-3 text-slate-400",children:"총 수수료"})]})}),t.jsx("tbody",{children:f.map(e=>t.jsxs("tr",{className:"border-b border-slate-800 hover:bg-slate-800/30",children:[t.jsx("td",{className:"p-3",children:t.jsxs("div",{children:[t.jsx("p",{className:"text-white",children:e.partner_nickname}),t.jsx("p",{className:"text-xs text-slate-400",children:e.partner_username})]})}),t.jsx("td",{className:"p-3",children:t.jsx(U,{variant:"outline",children:T(e.partner_level)})}),t.jsxs("td",{className:"p-3 text-right text-slate-300",children:["₩",e.total_bet_amount.toLocaleString()]}),t.jsx("td",{className:"p-3 text-right",children:t.jsxs("div",{children:[t.jsxs("p",{className:"text-blue-400",children:["₩",e.rolling_commission.toLocaleString()]}),t.jsxs("p",{className:"text-xs text-slate-500",children:[e.commission_rolling,"%"]})]})}),t.jsx("td",{className:"p-3 text-right",children:t.jsxs("div",{children:[t.jsxs("p",{className:"text-purple-400",children:["₩",e.losing_commission.toLocaleString()]}),t.jsxs("p",{className:"text-xs text-slate-500",children:[e.commission_losing,"%"]})]})}),t.jsx("td",{className:"p-3 text-right",children:t.jsxs("div",{children:[t.jsxs("p",{className:"text-green-400",children:["₩",e.withdrawal_commission.toLocaleString()]}),t.jsxs("p",{className:"text-xs text-slate-500",children:[e.withdrawal_fee,"%"]})]})}),t.jsx("td",{className:"p-3 text-right",children:t.jsxs("p",{className:"text-orange-400 font-mono",children:["₩",e.total_commission.toLocaleString()]})})]},e.partner_id))}),t.jsx("tfoot",{children:t.jsxs("tr",{className:"bg-slate-800/50 border-t-2 border-slate-600",children:[t.jsx("td",{colSpan:3,className:"p-3 text-white",children:"총합"}),t.jsxs("td",{className:"p-3 text-right text-blue-400 font-mono",children:["₩",n.totalRollingCommission.toLocaleString()]}),t.jsxs("td",{className:"p-3 text-right text-purple-400 font-mono",children:["₩",n.totalLosingCommission.toLocaleString()]}),t.jsxs("td",{className:"p-3 text-right text-green-400 font-mono",children:["₩",n.totalWithdrawalCommission.toLocaleString()]}),t.jsxs("td",{className:"p-3 text-right text-orange-400 font-mono",children:["₩",n.totalCommission.toLocaleString()]})]})})]})})})]})]})}export{St as CommissionSettlement};
