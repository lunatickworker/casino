import{k as X,r as c,j as e,aJ as R,a1 as Y,R as j,B as p,w as $,S as Z,x as ee,y as se,z as te,D as re,aS as ae,aA as b,H as ne,a2 as le,s as x,t as i}from"./index-DuEcnhwm.js";import{S as ie}from"./switch-BV-TSL-p.js";import{C as G}from"./circle-alert-CFD2xi-a.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=[["path",{d:"M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z",key:"zw3jo"}],["path",{d:"M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12",key:"1wduqc"}],["path",{d:"M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17",key:"kqbvx6"}]],O=X("layers",ce);function ue({user:d}){const[g,_]=c.useState([]),[o,T]=c.useState(""),[V,w]=c.useState(null),[u,y]=c.useState([]),[f,N]=c.useState([]),[k,q]=c.useState(!1),[S,E]=c.useState(!1),[H,L]=c.useState(!1),[de,J]=c.useState(new Set),B=async()=>{try{if(q(!0),d.level===1){const{data:s,error:t}=await x.from("partners").select("id, username, nickname, level, status").eq("status","active").order("level",{ascending:!0}).order("nickname",{ascending:!0});if(t)throw t;_(s||[]),(!s||s.length===0)&&i.warning("활성화된 파트너가 없습니다.")}else{const{data:s,error:t}=await x.rpc("get_hierarchical_partners",{p_partner_id:d.id});if(t){console.error("하위 파트너 조회 실패:",t);const{data:r,error:a}=await x.from("partners").select("id, username, nickname, level, status").eq("status","active").eq("parent_id",d.id).order("level",{ascending:!0}).order("nickname",{ascending:!0});a?(console.error("직접 하위 조회도 실패:",a),_([])):(_(r||[]),(!r||r.length===0)&&i.warning("관리할 수 있는 파트너가 없습니다."))}else{const r=(s||[]).filter(a=>a.status==="active");_(r),console.log("✅ 계층 파트너 조회 완료:",{total:r.length,by_level:r.reduce((a,l)=>(a[l.level]=(a[l.level]||0)+1,a),{})}),r.length===0&&i.warning("관리할 수 있는 파트너가 없습니다.")}}}catch(s){console.error("파트너 목록 로드 실패:",s),i.error("파트너 목록을 불러오는데 실패했습니다.")}finally{q(!1)}},A=async()=>{try{const{data:s,error:t,count:r}=await x.from("menu_permissions").select("*",{count:"exact"}).eq("is_visible",!0).order("display_order",{ascending:!0}).order("menu_name",{ascending:!0});if(console.log("메뉴 권한 조회 결과:",{success:!t,count:r,dataLength:s?.length,error:t}),t){console.error("메뉴 권한 목록 로드 에러:",t),t.code==="PGRST116"||t.message?.includes("permission")?i.error("메뉴 데이터 접근 권한이 없습니다."):i.error(`메뉴 권한 목록을 불러오는데 실패했습니다: ${t.message}`),y([]);return}y(s||[]),!s||s.length===0?i.warning("메뉴 권한 데이터가 없습니다. DB 스키마(205번)를 실행해주세요.",{description:"Supabase SQL Editor에서 database/205_menu-management-schema.sql 파일을 실행하세요."}):console.log(`✅ 메뉴 권한 ${s.length}개 로드 성공`)}catch(s){console.error("메뉴 권한 목록 로드 실패:",s),i.error("메뉴 권한 목록을 불러오는데 실패했습니다."),y([])}},P=async s=>{if(!s){N([]),w(null);return}try{E(!0);const t=g.find(n=>n.id===s);if(w(t||null),!t){i.error("선택된 파트너 정보를 찾을 수 없습니다.");return}let r=u;if(d.level!==1&&t.parent_id){const{data:n,error:h}=await x.from("partner_menu_permissions").select(`
            menu_permission_id,
            is_enabled,
            menu_permission:menu_permissions(*)
          `).eq("partner_id",t.parent_id).eq("is_enabled",!0);if(h)console.error("상위 파트너 메뉴 조회 오류:",h);else if(n&&n.length>0){const v=new Set(n.map(C=>C.menu_permission_id));r=u.filter(C=>v.has(C.id))}}const{data:a,error:l}=await x.from("partner_menu_permissions").select(`
          *,
          menu_permission:menu_permissions(*)
        `).eq("partner_id",s);if(l)throw l;const m=r.filter(n=>!a?.some(h=>h.menu_permission_id===n.id));if(m.length>0){const n=m.map(v=>({partner_id:s,menu_permission_id:v.id,is_enabled:t.level<=v.partner_level})),{error:h}=await x.from("partner_menu_permissions").insert(n);h&&console.error("기본 메뉴 권한 생성 실패:",h)}const{data:M,error:z}=await x.from("partner_menu_permissions").select(`
          *,
          menu_permission:menu_permissions(*)
        `).eq("partner_id",s);if(z)throw z;const K=(M||[]).map(n=>({...n,menu_permission:Array.isArray(n.menu_permission)?n.menu_permission[0]:n.menu_permission})),U=new Set(r.map(n=>n.id)),I=K.filter(n=>U.has(n.menu_permission_id));N(I);const W=new Set(I.map(n=>n.menu_permission?.parent_menu||"기본 메뉴").filter(Boolean));J(W)}catch(t){console.error("파트너 메뉴 권한 로드 실패:",t),i.error("파트너 메뉴 권한을 불러오는데 실패했습니다."),N([])}finally{E(!1)}},Q=async(s,t)=>{try{L(!0);const r=s.menu_permission?.menu_name||"메뉴";if(console.log("🔧 메뉴 권한 업데이트 시작:",{menu_name:r,pmp_id:s.id,menu_permission_id:s.menu_permission_id,current_enabled:s.is_enabled,new_enabled:t,has_menu_permission:!!s.menu_permission}),!s.id){console.error("❌ PMP ID가 없습니다:",s),i.error(`${r}: ID가 없어 업데이트할 수 없습니다.`);return}if(!s.menu_permission_id){console.error("❌ menu_permission_id가 없습니다:",s),i.error(`${r}: menu_permission_id가 없어 업데이트할 수 없습니다.`);return}const{error:a}=await x.from("partner_menu_permissions").update({is_enabled:t,updated_at:new Date().toISOString()}).eq("id",s.id);if(a)throw console.error("❌ DB 업데이트 실패:",{menu_name:r,error_code:a.code,error_message:a.message,error_details:a.details}),a;console.log("✅ DB 업데이트 성공:",{menu_name:r,new_enabled:t}),N(l=>l.map(m=>m.id===s.id?{...m,is_enabled:t}:m)),i.success(`${r} ${t?"활성화":"비활성화"} 완료`,{description:`메뉴 권한이 성공적으로 ${t?"활성화":"비활성화"}되었습니다.`})}catch(r){const a=s.menu_permission?.menu_name||"메뉴";console.error("❌ 메뉴 권한 업데이트 실패:",r),i.error(`${a} 업데이트 실패: ${r.message||"알 수 없는 오류"}`)}finally{L(!1)}};c.useEffect(()=>{B(),A()},[d.id]),c.useEffect(()=>{if(o&&u.length>0){const s=g.find(t=>t.id===o);w(s||null),P(o)}},[o,u,g]);const F=f.reduce((s,t)=>{const r=t.menu_permission?.parent_menu||"기본 메뉴";return s[r]||(s[r]=[]),s[r].push(t),s},{}),D=s=>{switch(s){case 1:return"badge-premium-danger";case 2:return"badge-premium-primary";case 3:return"badge-premium-success";default:return"badge-premium-warning"}};return e.jsxs("div",{className:"h-full flex flex-col overflow-hidden p-4 space-y-3",children:[e.jsx("div",{className:"flex items-center justify-between px-4 py-2 rounded-lg bg-slate-900/50 border border-blue-500/30 flex-shrink-0",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-gradient-to-br from-blue-500/20 to-blue-600/20 border border-blue-400/30",children:e.jsx(R,{className:"h-5 w-5 text-blue-400"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-slate-100",children:"메뉴 관리"}),e.jsx("p",{className:"text-xs text-slate-400",children:d.nickname})]})]})}),e.jsxs("div",{className:"glass-card p-3 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"h-4 w-4 text-blue-400"}),e.jsx("span",{className:"text-sm text-slate-200",children:d.level===1?"대본사 선택":"파트너 선택"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[k&&e.jsx(j,{className:"h-3 w-3 animate-spin text-blue-400"}),e.jsxs(p,{variant:"outline",className:"border-blue-400/30 text-blue-300 text-xs h-5",children:[e.jsx(O,{className:"h-3 w-3 mr-1"}),g.length,"개"]})]})]}),e.jsx("div",{children:k?e.jsxs("div",{className:"flex items-center justify-center py-4 border border-slate-700/50 rounded-lg bg-slate-900/30",children:[e.jsx(j,{className:"h-4 w-4 animate-spin mr-2 text-blue-400"}),e.jsx("span",{className:"text-sm text-slate-300",children:"로딩 중..."})]}):g.length===0?e.jsxs("div",{className:"text-center py-6 border border-slate-700/50 rounded-lg bg-slate-900/30",children:[e.jsx(G,{className:"h-8 w-8 mx-auto mb-2 text-slate-500"}),e.jsx("p",{className:"text-sm text-slate-300 mb-2",children:"활성화된 조직이 없습니다"}),e.jsxs($,{onClick:B,variant:"outline",size:"sm",children:[e.jsx(j,{className:"h-3 w-3 mr-1"}),"다시 시도"]})]}):e.jsxs(Z,{value:o,onValueChange:T,disabled:k,children:[e.jsx(ee,{className:"w-full input-premium h-9 text-sm",children:e.jsx(se,{placeholder:d.level===1?"메뉴를 관리할 대본사를 선택하세요":"메뉴를 관리할 파트너를 선택하세요"})}),e.jsx(te,{className:"bg-slate-900 border-slate-700",children:g.sort((s,t)=>s.level!==t.level?s.level-t.level:s.nickname.localeCompare(t.nickname)).map(s=>{const t=Math.max(0,s.level-2),r=t>0?`${t*1.5}rem`:"0";return e.jsx(re,{value:s.id,className:"text-slate-200 focus:bg-slate-800 py-1",style:{paddingLeft:`calc(0.5rem + ${r})`},children:e.jsxs("div",{className:"flex items-center gap-2",children:[t>0&&e.jsx("span",{className:"text-slate-600 text-xs",children:"└─".repeat(1)}),e.jsxs(p,{className:`${D(s.level)} text-xs h-4`,children:["L",s.level]}),e.jsx("span",{className:"text-sm",children:s.nickname}),e.jsxs("span",{className:"text-slate-400 text-xs",children:["(",s.username,")"]})]})},s.id)})})]})})]}),o&&e.jsxs("div",{className:"glass-card flex flex-col flex-1 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 border-b border-slate-700/50 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"h-4 w-4 text-emerald-400"}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-sm text-slate-200",children:[V?.nickname," 메뉴 노출 설정"]}),e.jsx("p",{className:"text-xs text-slate-400",children:"활성화된 메뉴만 사이드바에 표시"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(p,{variant:"outline",className:"border-emerald-400/30 text-emerald-300 text-xs h-5",children:[e.jsx(b,{className:"h-3 w-3 mr-1"}),f.filter(s=>s.is_enabled).length,"/",f.length]}),e.jsxs($,{onClick:()=>P(o),variant:"outline",size:"sm",disabled:S,className:"border-blue-400/30 hover:bg-blue-500/10 h-7 text-xs px-2",children:[e.jsx(j,{className:`h-3 w-3 mr-1 ${S?"animate-spin":""}`}),"새로고침"]})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-3",children:S?e.jsxs("div",{className:"flex flex-col items-center justify-center py-8",children:[e.jsx("div",{className:"loading-premium mb-4"}),e.jsx("span",{className:"text-sm text-slate-300",children:"메뉴 권한을 불러오는 중..."})]}):f.length===0?e.jsxs("div",{className:"text-center py-8 border border-slate-700/50 rounded-lg bg-slate-900/30",children:[e.jsx(G,{className:"h-12 w-12 mx-auto mb-3 text-slate-500"}),e.jsx("p",{className:"text-sm text-slate-300 mb-2",children:"메뉴 데이터가 없습니다"}),e.jsx("p",{className:"text-xs text-slate-400 mb-3",children:u.length===0?"menu_permissions 테이블에 기본 메뉴 데이터가 없습니다.":"해당 파트너에게 할당 가능한 메뉴가 없거나 데이터를 불러올 수 ���습니다."}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsxs("div",{className:"text-xs text-slate-500",children:[e.jsxs("p",{children:["• 기본 메뉴: ",u.length,"개"]}),e.jsxs("p",{children:["• 파트너 메뉴: ",f.length,"개"]})]}),u.length===0&&e.jsxs("div",{className:"bg-amber-500/10 border border-amber-500/30 rounded-lg p-3 text-left",children:[e.jsx("p",{className:"text-xs text-amber-300 mb-1",children:"⚠️ 조치 필요"}),e.jsx("p",{className:"text-xs text-slate-400",children:"205_menu-management-schema.sql 실행 필요"})]})]}),e.jsxs($,{onClick:()=>{A(),P(o)},variant:"outline",size:"sm",className:"btn-premium-primary",children:[e.jsx(j,{className:"h-3 w-3 mr-1"}),"다시 시도"]})]}):e.jsx("div",{className:"space-y-1.5",children:Object.entries(F).map(([s,t])=>{const r=t.filter(a=>a.is_enabled).length;return e.jsxs("div",{className:"glass-card border-slate-700/50",children:[e.jsxs("div",{className:"px-3 py-1.5 bg-slate-800/50 border-b border-slate-700/50 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{className:"h-3 w-3 text-blue-400"}),e.jsx("h4",{className:"text-xs text-slate-200",children:s}),e.jsxs(p,{variant:"outline",className:"border-slate-600/50 text-slate-400 text-[10px] h-4 px-1",children:[t.length,"개"]})]}),e.jsxs(p,{className:`text-[10px] h-4 px-1 ${r===t.length?"badge-premium-success":r>0?"badge-premium-warning":"badge-premium-danger"}`,children:[r," / ",t.length," 활성"]})]}),e.jsx("div",{className:"grid grid-cols-2 lg:grid-cols-3 gap-2 p-2",children:t.sort((a,l)=>{const m=a.menu_permission?.display_order??999,M=l.menu_permission?.display_order??999;return m-M}).map(a=>{const l=a.menu_permission;return l?e.jsxs("div",{className:`
                                px-2 py-1.5 rounded-lg border transition-all
                                ${a.is_enabled?"bg-emerald-500/5 border-emerald-500/30 hover:bg-emerald-500/10":"bg-slate-800/20 border-slate-700/30 hover:bg-slate-800/40"}
                              `,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-1.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5 flex-1 min-w-0",children:[a.is_enabled?e.jsx(ne,{className:"h-3 w-3 text-emerald-400 flex-shrink-0 mt-0.5"}):e.jsx(le,{className:"h-3 w-3 text-slate-500 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-0.5",children:[e.jsx("span",{className:"text-xs text-slate-200 truncate",children:l.menu_name}),e.jsxs(p,{className:`text-[8px] px-1 py-0 h-3 flex-shrink-0 ${D(l.partner_level)}`,children:["L",l.partner_level]})]}),e.jsx("p",{className:"text-[9px] text-slate-400 truncate",children:l.menu_path})]})]}),e.jsx(ie,{checked:a.is_enabled,disabled:H,onCheckedChange:m=>Q(a,m),className:"flex-shrink-0 scale-75"})]}),a.is_enabled&&e.jsx("div",{className:"flex items-center justify-end",children:e.jsx(p,{className:"badge-premium-success text-[9px] h-3.5 px-1",children:"활성"})})]},a.id):null})})]},s)})})})]}),!o&&e.jsx("div",{className:"glass-card flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center max-w-md px-4 space-y-3",children:[e.jsx("div",{className:"p-4 rounded-xl bg-gradient-to-br from-blue-500/10 to-blue-600/5 border border-blue-400/20 inline-block",children:e.jsx(R,{className:"h-12 w-12 text-blue-400"})}),e.jsx("h3",{className:"text-lg text-slate-200",children:d.level===1?"대본사를 선택하세요":"파트너를 선택하세요"}),e.jsxs("p",{className:"text-xs text-slate-400",children:["위에서 ",d.level===1?"대본사":"파트너","를 선택하면 해당 조직의 메뉴 노출 설정을 관리할 수 있습니다."]}),e.jsxs("div",{className:"pt-4 space-y-2 text-left",children:[e.jsxs("div",{className:"flex items-start gap-3 text-sm text-slate-400",children:[e.jsx(b,{className:"h-5 w-5 text-emerald-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:"활성화된 메뉴만 표시"})]}),e.jsxs("div",{className:"flex items-start gap-3 text-sm text-slate-400",children:[e.jsx(b,{className:"h-5 w-5 text-emerald-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:"메뉴별 활성화/비활성화 설정"})]}),e.jsxs("div",{className:"flex items-start gap-3 text-sm text-slate-400",children:[e.jsx(b,{className:"h-5 w-5 text-emerald-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:"레벨에 맞는 메뉴만 선택 가능"})]}),e.jsxs("div",{className:"flex items-start gap-3 text-sm text-slate-400",children:[e.jsx(b,{className:"h-5 w-5 text-emerald-400 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:"실시간 사이드바 반영"})]})]})]})})]})}export{ue as MenuManagement};
