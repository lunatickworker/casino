import{r as n,j as e}from"./react-core-CwM-CeLv.js";import{s as O,m as R,i as u,c as _,C as $,a as k,b as M,d as F,S as A,p as W,q as B,r as E,t as l,e as q}from"./index-Bjfbt2Z0.js";import{P as V,a as Y,b as z}from"./popover-BUEAF9m7.js";import{C as H}from"./calendar-DfPS5pKM.js";import{k as U,m as g,n as c}from"./vendor-CQn7sZ7L.js";import{M as h}from"./MetricCard-CsJTrd1U.js";import{calculateIntegratedSettlement as G,calculatePartnerPayments as J}from"./settlementCalculator-DRi6b7kQ.js";import{R as K,ae as Q,af as X,u as Z,ab as ee,ag as te}from"./lucide-icons-D2Y5yybo.js";import"./radix-ui-SX2QAG6c.js";import"./supabase-r6ABpEO8.js";function xe({user:o}){const[w,x]=n.useState(!0),[d,j]=n.useState(!1),[se,y]=n.useState("direct_subordinate"),[i,N]=n.useState("today"),[a,P]=n.useState(),[r,b]=n.useState({myRollingIncome:0,myLosingIncome:0,myWithdrawalIncome:0,myTotalIncome:0,partnerRollingPayments:0,partnerLosingPayments:0,partnerWithdrawalPayments:0,partnerTotalPayments:0,netRollingProfit:0,netLosingProfit:0,netWithdrawalProfit:0,netTotalProfit:0}),[m,v]=n.useState([]);n.useEffect(()=>{I(),S()},[o.id,i,a]);const I=async()=>{try{const{data:t,error:s}=await O.from("system_settings").select("setting_value").eq("setting_key","settlement_method").single();if(s)throw s;t&&y(t.setting_value)}catch(t){console.error("정산 방식 로드 실패:",t)}},L=()=>{const t=new Date,s=new Date(t.getFullYear(),t.getMonth(),t.getDate());switch(i){case"today":return{start:s.toISOString(),end:new Date(s.getTime()+1440*60*1e3).toISOString()};case"yesterday":return{start:new Date(s.getTime()-1440*60*1e3).toISOString(),end:s.toISOString()};case"week":return{start:new Date(s.getTime()-10080*60*1e3).toISOString(),end:new Date(s.getTime()+1440*60*1e3).toISOString()};case"month":return{start:new Date(t.getFullYear(),t.getMonth(),1).toISOString(),end:new Date(s.getTime()+1440*60*1e3).toISOString()};case"custom":if(a?.from){const C=new Date(a.from),T=a.to?new Date(a.to):new Date(a.from);return{start:C.toISOString(),end:new Date(T.getTime()+1440*60*1e3).toISOString()}}return{start:s.toISOString(),end:new Date(s.getTime()+1440*60*1e3).toISOString()};default:return{start:s.toISOString(),end:new Date(s.getTime()+1440*60*1e3).toISOString()}}},S=async()=>{try{d||x(!0);const{start:t,end:s}=L(),p=await G(o.id,{rolling:o.commission_rolling,losing:o.commission_losing,withdrawal:o.withdrawal_fee},t,s);b(p);const f=await J(o.id,t,s);v(f.details)}catch(t){console.error("통합 정산 계산 실패:",t),U.error("정산 데이터를 불러오는데 실패했습니다.")}finally{x(!1),j(!1)}},D=()=>{j(!0),S()};return w?e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx(R,{})}):e.jsxs("div",{className:"space-y-6 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl text-white mb-2",children:"통합 정산 현황"}),e.jsx("p",{className:"text-slate-400",children:"내 총 수익에서 하위 파트너 지급액을 제외한 순수익을 확인합니다."})]}),e.jsxs(u,{variant:"outline",size:"sm",onClick:D,disabled:d,children:[e.jsx(K,{className:_("h-4 w-4 mr-2",d&&"animate-spin")}),"새로고침"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-5",children:[e.jsx(h,{title:"내 총 수입 (A)",value:`₩${r.myTotalIncome.toLocaleString()}`,subtitle:`롤링: ₩${r.myRollingIncome.toLocaleString()} | 죽장: ₩${r.myLosingIncome.toLocaleString()}`,icon:Q,color:"emerald"}),e.jsx(h,{title:"하위 파트너 지급 (B)",value:`₩${r.partnerTotalPayments.toLocaleString()}`,subtitle:`롤링: ₩${r.partnerRollingPayments.toLocaleString()} | 죽장: ₩${r.partnerLosingPayments.toLocaleString()}`,icon:X,color:"red"}),e.jsx(h,{title:"순수익 (A - B)",value:`₩${r.netTotalProfit.toLocaleString()}`,subtitle:`롤링: ₩${r.netRollingProfit.toLocaleString()} | 죽장: ₩${r.netLosingProfit.toLocaleString()}`,icon:Z,color:"blue"})]}),e.jsxs($,{children:[e.jsx(k,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(M,{children:"하위 파트너 지급 상세"}),e.jsxs(F,{children:["총 ",m.length,"명의 직속 하위 파트너 지급 내역"]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(A,{value:i,onValueChange:N,children:[e.jsx(W,{className:"w-[180px]",children:e.jsx(B,{})}),e.jsxs(E,{children:[e.jsx(l,{value:"today",children:"오늘"}),e.jsx(l,{value:"yesterday",children:"어제"}),e.jsx(l,{value:"week",children:"최근 7일"}),e.jsx(l,{value:"month",children:"이번 달"}),e.jsx(l,{value:"custom",children:"직접 선택"})]})]}),i==="custom"&&e.jsxs(V,{children:[e.jsx(Y,{asChild:!0,children:e.jsxs(u,{variant:"outline",className:"w-[280px] justify-start text-left",children:[e.jsx(ee,{className:"mr-2 h-4 w-4"}),a?.from?a.to?e.jsxs(e.Fragment,{children:[g(a.from,"PPP",{locale:c})," -"," ",g(a.to,"PPP",{locale:c})]}):g(a.from,"PPP",{locale:c}):e.jsx("span",{children:"날짜를 선택하세요"})]})}),e.jsx(z,{className:"w-auto p-0",align:"end",children:e.jsx(H,{initialFocus:!0,mode:"range",defaultMonth:a?.from,selected:a,onSelect:P,numberOfMonths:2,locale:c})})]})]})]})}),e.jsx(q,{children:m.length===0?e.jsxs("div",{className:"text-center py-12 text-slate-400",children:[e.jsx(te,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"지급할 하위 파트너가 없습니다."})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-slate-700",children:[e.jsx("th",{className:"text-left p-3 text-slate-400",children:"파트너"}),e.jsx("th",{className:"text-right p-3 text-slate-400",children:"롤링 지급"}),e.jsx("th",{className:"text-right p-3 text-slate-400",children:"죽장 지급"}),e.jsx("th",{className:"text-right p-3 text-slate-400",children:"이체 지급"}),e.jsx("th",{className:"text-right p-3 text-slate-400",children:"총 지급액"})]})}),e.jsx("tbody",{children:m.map(t=>e.jsxs("tr",{className:"border-b border-slate-800 hover:bg-slate-800/30",children:[e.jsx("td",{className:"p-3",children:e.jsx("p",{className:"text-white",children:t.partner_nickname})}),e.jsxs("td",{className:"p-3 text-right text-blue-400 font-mono",children:["₩",t.rolling_payment.toLocaleString()]}),e.jsxs("td",{className:"p-3 text-right text-purple-400 font-mono",children:["₩",t.losing_payment.toLocaleString()]}),e.jsxs("td",{className:"p-3 text-right text-green-400 font-mono",children:["₩",t.withdrawal_payment.toLocaleString()]}),e.jsxs("td",{className:"p-3 text-right text-orange-400 font-mono",children:["₩",t.total_payment.toLocaleString()]})]},t.partner_id))}),e.jsx("tfoot",{children:e.jsxs("tr",{className:"bg-slate-800/50 border-t-2 border-slate-600",children:[e.jsx("td",{className:"p-3 text-white",children:"총합"}),e.jsxs("td",{className:"p-3 text-right text-blue-400 font-mono",children:["₩",r.partnerRollingPayments.toLocaleString()]}),e.jsxs("td",{className:"p-3 text-right text-purple-400 font-mono",children:["₩",r.partnerLosingPayments.toLocaleString()]}),e.jsxs("td",{className:"p-3 text-right text-green-400 font-mono",children:["₩",r.partnerWithdrawalPayments.toLocaleString()]}),e.jsxs("td",{className:"p-3 text-right text-orange-400 font-mono",children:["₩",r.partnerTotalPayments.toLocaleString()]})]})})]})})})]})]})}export{xe as IntegratedSettlement};
