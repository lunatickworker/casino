import{c as N,j as e,C as ge,a as xe,b as be,d as he,e as fe,u as _e,r as x,s as n,g as ve,B as we,U as ye,f as je,W as Ne,h as c,A as Ce,T as M,i as ne,t as De}from"./index-BWgbPZ4l.js";import{M as O}from"./MetricCard-CsQsoRGz.js";import{C as Se}from"./clock-BQI8X08V.js";import{D as $}from"./dollar-sign-DTrUq9JA.js";import{Z as W}from"./zap-D_qKtgKG.js";import{T as oe}from"./target-DWFO45Tt.js";import{C as le}from"./chart-column-BeQZ38ke.js";function H({title:l,description:g,children:f,className:C,headerAction:r,action:p,variant:d="modern",icon:_,iconColor:S="text-cyan-400"}){const U=N("transition-all duration-300 border-0",{"glass-card":d==="default"||d==="glass","admin-card-modern":d==="modern","glass-card rounded-2xl border border-slate-700/50":d==="premium"},C);return d==="premium"&&_?e.jsxs("div",{className:U,children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6 pb-4 border-b border-slate-700/50 px-6 pt-6",children:[e.jsx("div",{className:N("p-2 rounded-lg bg-slate-800/50",S.replace("text-","bg-")+"/20"),children:e.jsx(_,{className:N("h-5 w-5",S)})}),e.jsx("h3",{className:"font-semibold text-slate-100",children:l}),(r||p)&&e.jsxs("div",{className:"ml-auto flex items-center gap-3",children:[r,p]})]}),e.jsx("div",{className:"space-y-3 px-6 pb-6",children:f})]}):e.jsxs(ge,{className:U,children:[(l||g||r||p||_)&&e.jsx(xe,{className:"pb-5",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[_&&e.jsx("div",{className:N("p-2 rounded-lg bg-slate-800/50",S.replace("text-","bg-")+"/20"),children:e.jsx(_,{className:N("h-5 w-5",S)})}),e.jsxs("div",{className:"space-y-1.5",children:[l&&e.jsx(be,{className:"text-xl font-bold text-slate-100",children:l}),g&&e.jsx(he,{className:"text-base text-slate-400",children:g})]})]}),(r||p)&&e.jsxs("div",{className:"flex items-center gap-3",children:[r,p]})]})}),e.jsx(fe,{className:l||g||r||p||_?"pt-0":"pt-7",children:f})]})}function u({label:l,value:g,valueColor:f="text-cyan-400",badge:C,badgeColor:r="bg-cyan-500/20 text-cyan-400",icon:p,iconColor:d="text-slate-400"}){return e.jsxs("div",{className:"flex items-center justify-between py-3 px-4 rounded-lg bg-slate-800/30 hover:bg-slate-800/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[p&&e.jsx("div",{className:N("p-1.5 rounded-lg bg-slate-700/50",d),children:e.jsx(p,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-slate-300 font-medium",children:l})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[C&&e.jsx("span",{className:N("px-2.5 py-1 rounded-full text-xs font-semibold",r),children:C}),e.jsx("span",{className:N("font-bold text-lg",f),children:g})]})]})}function ke({user:l}){const{balance:g}=_e(),[f,C]=x.useState({total_users:0,total_balance:0,daily_deposit:0,daily_withdrawal:0,daily_net_deposit:0,casino_betting:0,slot_betting:0,total_betting:0,online_users:0,pending_approvals:0,pending_messages:0,pending_deposits:0,pending_withdrawals:0}),[r,p]=x.useState({deposit:0,withdrawal:0,netDeposit:0,casinoBetting:0,slotBetting:0,totalBetting:0}),[d,_]=x.useState({deposit:0,withdrawal:0,netDeposit:0,casinoBetting:0,slotBetting:0,totalBetting:0}),[S,U]=x.useState(0),[Be,z]=x.useState(!0),[re,ie]=x.useState(new Date);if(x.useEffect(()=>{C(i=>({...i,total_balance:g}))},[g]),!l||typeof l.level!="number")return e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"loading-premium mx-auto"}),e.jsx("p",{className:"text-muted-foreground",children:"대시보드를 불러오는 중..."})]})});const B=async()=>{try{z(!0),console.log("============================================"),console.log("📊 대시보드 통계 조회 시작"),console.log("Partner ID:",l.id),console.log("Partner Level:",l.level),console.log("Partner Type:",l.partner_type),console.log("============================================");const i=new Date;i.setHours(0,0,0,0),console.log("🔍 직접 DB 조회 시작...");const{data:v,error:A}=await n.from("transactions").select("transaction_type, status, amount, created_at").gte("created_at",i.toISOString());if(console.log("📊 오늘 transactions:",v?.length||0,"건"),v&&v.length>0){console.log("상세:",v);const a=v.filter(t=>t.transaction_type==="deposit"&&["approved","completed"].includes(t.status)||t.transaction_type==="admin_adjustment"&&t.amount>0&&["approved","completed"].includes(t.status)).reduce((t,o)=>t+Number(o.amount),0),s=v.filter(t=>t.transaction_type==="withdrawal"&&["approved","completed"].includes(t.status)||t.transaction_type==="admin_adjustment"&&t.amount<0&&["approved","completed"].includes(t.status)).reduce((t,o)=>t+Math.abs(Number(o.amount)),0);console.log("💰 직접 계산 입금:",a),console.log("💸 직접 계산 출금:",s)}const{data:w,error:y}=await n.from("game_records").select("provider_id, bet_amount, played_at").gte("played_at",i.toISOString());if(console.log("🎮 오늘 game_records:",w?.length||0,"건"),w&&w.length>0){console.log("상세:",w);const a=[410,77,2,30,78,86,11,28,89,91,44,85,0],s=w.filter(o=>a.includes(Number(o.provider_id))).reduce((o,D)=>o+Number(D.bet_amount),0),t=w.filter(o=>!a.includes(Number(o.provider_id))).reduce((o,D)=>o+Number(D.bet_amount),0);console.log("🎰 직접 계산 카지노:",s),console.log("🎲 직접 계산 슬롯:",t)}console.log(""),console.log("🔧 직접 SELECT 쿼리 시작 (RPC 제거)...");const ce=new Date,J=540*60*1e3,Z=new Date(ce.getTime()+J),de=new Date(Z.getFullYear(),Z.getMonth(),Z.getDate()),j=new Date(de.getTime()-J).toISOString();console.log("📅 오늘 시작 시각:",j);let m=[];if(l.level===1){const{data:a}=await n.from("partners").select("id");m=a?.map(s=>s.id)||[]}else{m=[l.id];const{data:a}=await n.from("partners").select("id").eq("parent_id",l.id),s=a?.map(t=>t.id)||[];if(m.push(...s),s.length>0){const{data:t}=await n.from("partners").select("id").in("parent_id",s),o=t?.map(D=>D.id)||[];if(m.push(...o),o.length>0){const{data:D}=await n.from("partners").select("id").in("parent_id",o),F=D?.map(G=>G.id)||[];if(m.push(...F),F.length>0){const{data:G}=await n.from("partners").select("id").in("parent_id",F),K=G?.map(Y=>Y.id)||[];if(m.push(...K),K.length>0){const{data:Y}=await n.from("partners").select("id").in("parent_id",K),ue=Y?.map(pe=>pe.id)||[];m.push(...ue)}}}}}console.log("👥 하위 파트너 ID 개수:",m.length);let b=[];const{data:me}=await n.from("users").select("id").eq("referrer_id",l.id);b=me?.map(a=>a.id)||[],console.log("👤 직속 회원 ID 개수:",b.length);let h=[];const Q=m.filter(a=>a!==l.id);if(Q.length>0){const{data:a}=await n.from("users").select("id").in("referrer_id",Q);h=a?.map(s=>s.id)||[],console.log("👥 하위 파트너 회원 ID 개수:",h.length)}let q=0;if(b.length>0){const{data:a}=await n.from("transactions").select("amount").in("transaction_type",["deposit","admin_deposit"]).eq("status","completed").in("user_id",b).gte("created_at",j);q=a?.reduce((s,t)=>s+Number(t.amount),0)||0}let R=0;if(b.length>0){const{data:a}=await n.from("transactions").select("amount").in("transaction_type",["withdrawal","admin_withdrawal"]).eq("status","completed").in("user_id",b).gte("created_at",j);R=a?.reduce((s,t)=>s+Number(t.amount),0)||0}let k=0;if(h.length>0){const{data:a}=await n.from("transactions").select("amount").in("transaction_type",["deposit","admin_deposit"]).eq("status","completed").in("user_id",h).gte("created_at",j);k=a?.reduce((s,t)=>s+Number(t.amount),0)||0}let L=0;if(h.length>0){const{data:a}=await n.from("transactions").select("amount").in("transaction_type",["withdrawal","admin_withdrawal"]).eq("status","completed").in("user_id",h).gte("created_at",j);L=a?.reduce((s,t)=>s+Number(t.amount),0)||0}let V=0;if(m.length>0){const{count:a}=await n.from("users").select("id",{count:"exact",head:!0}).in("referrer_id",m);V=a||0}let X=0;if(m.length>0){const{count:a}=await n.from("users").select("id",{count:"exact",head:!0}).in("referrer_id",m).eq("is_online",!0);X=a||0}let ee=0;const te=[...b,...h];if(te.length>0){const{data:a,error:s}=await n.from("transactions").select("amount").eq("transaction_type","deposit").eq("status","pending").in("user_id",te).gte("created_at",j);s&&console.error("❌ 만충금 조회 실패:",s),ee=a?.reduce((t,o)=>t+Number(o.amount),0)||0}let P=0,T=0;if(b.length>0){const{data:a}=await n.from("game_records").select("provider_id, bet_amount").in("user_id",b).gte("played_at",j);if(a&&a.length>0){const s=[410,77,2,30,78,86,11,28,89,91,44,85,0];P=a.filter(t=>s.includes(Number(t.provider_id))).reduce((t,o)=>t+Number(o.bet_amount||0),0),T=a.filter(t=>!s.includes(Number(t.provider_id))).reduce((t,o)=>t+Number(o.bet_amount||0),0)}}let E=0,I=0;if(h.length>0){const{data:a}=await n.from("game_records").select("provider_id, bet_amount").in("user_id",h).gte("played_at",j);if(a&&a.length>0){const s=[410,77,2,30,78,86,11,28,89,91,44,85,0];E=a.filter(t=>s.includes(Number(t.provider_id))).reduce((t,o)=>t+Number(o.bet_amount||0),0),I=a.filter(t=>!s.includes(Number(t.provider_id))).reduce((t,o)=>t+Number(o.bet_amount||0),0)}}const ae=q+k,se=R+L;C(a=>({...a,total_users:V||0,daily_deposit:ae,daily_withdrawal:se,daily_net_deposit:ae-se,online_users:X||0,casino_betting:P+E,slot_betting:T+I,total_betting:P+T+E+I,pending_approvals:0,pending_messages:0,pending_deposits:0,pending_withdrawals:0})),p({deposit:q,withdrawal:R,netDeposit:q-R,casinoBetting:P,slotBetting:T,totalBetting:P+T}),_({deposit:k,withdrawal:L,netDeposit:k-L,casinoBetting:E,slotBetting:I,totalBetting:E+I}),U(ee),console.log(""),console.log("✅ 대시보드 통계 업데이트 완료 (RPC 없음)"),console.log("============================================")}catch(i){console.error(""),console.error("============================================"),console.error("❌ 대시보드 통계 로딩 오류"),console.error("Error:",i),console.error("Message:",i?.message),console.error("Details:",i?.details),console.error("Hint:",i?.hint),console.error("============================================"),De.error("대시보드 통계를 불러올 수 없습니다: "+(i?.message||"알 수 없는 오류"))}finally{z(!1)}};return x.useEffect(()=>{B()},[]),x.useEffect(()=>{const i=setInterval(()=>{ie(new Date)},1e3);return()=>clearInterval(i)},[]),x.useEffect(()=>{console.log("🔔 대시보드 Realtime 구독 시작:",l.id);const i=n.channel("dashboard_transactions").on("postgres_changes",{event:"*",schema:"public",table:"transactions"},y=>{console.log("💰 [대시보드] transactions 변경 감지:",y.eventType),B()}).subscribe(),v=n.channel("dashboard_partners").on("postgres_changes",{event:"UPDATE",schema:"public",table:"partners",filter:`id=eq.${l.id}`},y=>{console.log("💰 [대시보드] partners 보유금 변경 감지:",y.new),B()}).subscribe(),A=n.channel("dashboard_game_records").on("postgres_changes",{event:"INSERT",schema:"public",table:"game_records"},y=>{console.log("🎮 [대시보드] game_records 변경 감지:",y.eventType),B()}).subscribe(),w=n.channel("dashboard_users").on("postgres_changes",{event:"UPDATE",schema:"public",table:"users"},y=>{console.log("👤 [대시보드] users 변경 감지:",y.eventType),B()}).subscribe();return()=>{console.log("🔕 대시보드 Realtime 구독 해제"),n.removeChannel(i),n.removeChannel(v),n.removeChannel(A),n.removeChannel(w)}},[l.id]),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-8",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-100",children:"관리자 대시보드"}),e.jsxs("p",{className:"text-sm text-slate-400",children:[ve(l.level)," · ",l.nickname,"님의 실시간 현황"]})]}),e.jsxs(we,{variant:"outline",className:"flex items-center gap-2 px-3 py-1.5 text-xs badge-premium-primary",children:[e.jsx(Se,{className:"h-3.5 w-3.5"}),re.toLocaleString("ko-KR")]})]}),e.jsxs("div",{className:"grid gap-5 md:grid-cols-2 lg:grid-cols-4",children:[e.jsx(O,{title:"총 회원수",value:je(f.total_users),subtitle:"↑ 등록 회원 수",icon:ye,color:"blue"}),e.jsx(O,{title:"보유금",value:c(g),subtitle:l.level<=2?"↑ GET /api/info 응답":"↑ 충전금 (내부계산)",icon:Ne,color:"green"}),e.jsx(O,{title:"만충금",value:c(S),subtitle:"↑ 거래중 - 충전 금액",icon:$,color:"orange"}),e.jsx(O,{title:"오늘 수익",value:c(f.daily_net_deposit),subtitle:f.daily_net_deposit>=0?"↑ +5.0%":"↓ -5.0%",icon:Ce,color:"pink"})]}),e.jsxs("div",{className:"grid gap-5 md:grid-cols-2",children:[e.jsxs(H,{title:"자신의 사용자 입출금",icon:M,iconColor:"text-cyan-400",children:[e.jsx(u,{label:"일일 입금 금액",value:c(r.deposit),valueColor:"text-cyan-400",icon:M,iconColor:"text-cyan-400"}),e.jsx(u,{label:"일일 출금 금액",value:c(r.withdrawal),valueColor:"text-rose-400",icon:ne,iconColor:"text-rose-400"}),e.jsx(u,{label:"일일 순입출금 금액",value:c(r.netDeposit),valueColor:"text-cyan-400",icon:$,iconColor:"text-cyan-400"})]}),e.jsxs(H,{title:"자신의 사용자 베팅",icon:W,iconColor:"text-amber-400",children:[e.jsx(u,{label:"카지노 총 배팅",value:c(r.casinoBetting),valueColor:"text-cyan-400",icon:oe,iconColor:"text-cyan-400"}),e.jsx(u,{label:"슬롯 총 배팅",value:c(r.slotBetting),valueColor:"text-amber-400",icon:W,iconColor:"text-amber-400"}),e.jsx(u,{label:"전체 배팅 금액",value:c(r.totalBetting),valueColor:"text-cyan-400",icon:le,iconColor:"text-cyan-400"})]}),e.jsxs(H,{title:"하위파트너 사용자 입출금",icon:M,iconColor:"text-purple-400",children:[e.jsx(u,{label:"일일 입금 금액",value:c(d.deposit),valueColor:"text-cyan-400",icon:M,iconColor:"text-cyan-400"}),e.jsx(u,{label:"일일 출금 금액",value:c(d.withdrawal),valueColor:"text-rose-400",icon:ne,iconColor:"text-rose-400"}),e.jsx(u,{label:"일일 순입출금 금액",value:c(d.netDeposit),valueColor:"text-cyan-400",icon:$,iconColor:"text-cyan-400"})]}),e.jsxs(H,{title:"하위파트너 사용자 베팅",icon:W,iconColor:"text-green-400",children:[e.jsx(u,{label:"카지노 총 배팅",value:c(d.casinoBetting),valueColor:"text-cyan-400",icon:oe,iconColor:"text-cyan-400"}),e.jsx(u,{label:"슬롯 총 배팅",value:c(d.slotBetting),valueColor:"text-amber-400",icon:W,iconColor:"text-amber-400"}),e.jsx(u,{label:"전체 배팅 금액",value:c(d.totalBetting),valueColor:"text-cyan-400",icon:le,iconColor:"text-cyan-400"})]})]})]})}export{ke as Dashboard,ke as default};
