import{k as _e,j as e,aI as z,r as l,v as ye,s as c,t as d,w as p,U as ge,E as x,S as C,x as S,y as k,z as D,D as o,I as E,ay as J,L as Ne,l as be,B as Q}from"./index-BWgbPZ4l.js";import{T as X}from"./textarea-tGH4Q6hM.js";import{D as we}from"./DataTable-CvK3ZY2w.js";import{A as Y,f as Z,a as ee,b as se,c as te,d as re}from"./AdminDialog-CYGxI-kp.js";import{S as ae}from"./send-DaTp4Y3o.js";import{S as ne}from"./search-BHxVGLMF.js";import{F as Ce}from"./funnel-CJDqaBaX.js";import{C as le}from"./circle-alert-CD25byVy.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=[["polyline",{points:"9 17 4 12 9 7",key:"hvgpf2"}],["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}]],ke=_e("reply",Se);function Le({user:b}){if(b.level>6)return e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx(z,{className:"h-12 w-12 text-yellow-500 mx-auto"}),e.jsx("p",{className:"text-muted-foreground",children:"메시지 센터는 매장 이상만 접근 가능합니다."})]})});const[ie,B]=l.useState(!0),[ce,K]=l.useState([]),[i,H]=l.useState("received"),[T,de]=l.useState("all"),[q,oe]=l.useState("all"),[y,me]=l.useState(""),[W,g]=l.useState(!1),[v,L]=l.useState(null),[xe,U]=l.useState(!1),[h,I]=l.useState([]),[F,A]=l.useState([]),[w,M]=l.useState(""),[ue,P]=l.useState(!1),[r,u]=l.useState({recipient_type:"user",recipient_username:"",broadcast_type:"single",selected_users:[],title:"",content:"",message_type:"normal"}),[R,$]=l.useState(""),{lastMessage:O,sendMessage:G}=ye();l.useEffect(()=>{const s=c.channel("messages-changes").on("postgres_changes",{event:"*",schema:"public",table:"messages"},t=>{console.log("🔔 메시지 테이블 변경 감지:",t),N()}).subscribe();return()=>{c.removeChannel(s)}},[]),l.useEffect(()=>{if(!w.trim())A(h);else{const s=h.filter(t=>t.username.toLowerCase().includes(w.toLowerCase()));A(s)}},[w,h]);const pe=async()=>{try{P(!0);const s=r.recipient_type==="user"?"users":"partners",{data:t,error:n}=await c.from(s).select("id, username").order("username");if(n)throw n;I(t||[]),A(t||[]),M("")}catch(s){console.error("사용자 목록 조회 오류:",s),d.error("사용자 목록을 불러오는데 실패했습니다.")}finally{P(!1)}},N=async()=>{try{B(!0);let s=c.from("messages").select("*").order("created_at",{ascending:!1});if(i==="received"?s=s.eq("receiver_type","partner").eq("receiver_id",b.id):s=s.eq("sender_type","partner").eq("sender_id",b.id),T!=="all"&&(s=s.eq("message_type",T)),q!=="all"){const a=q==="read";s=s.eq("status",a?"read":"unread")}y&&(s=s.or(`subject.ilike.%${y}%,content.ilike.%${y}%`));const{data:t,error:n}=await s;if(n)throw n;const m=await Promise.all((t||[]).map(async a=>{const{count:f}=await c.from("messages").select("*",{count:"exact"}).eq("parent_id",a.id);let j="알 수 없음";if(a.sender_type==="user"){const{data:_}=await c.from("users").select("username").eq("id",a.sender_id).single();j=_?.username||"사용자"}else if(a.sender_type==="partner"){const{data:_}=await c.from("partners").select("username").eq("id",a.sender_id).single();j=_?.username||"관리자"}let V="알 수 없음";if(a.receiver_type==="user"){const{data:_}=await c.from("users").select("username").eq("id",a.receiver_id).single();V=_?.username||"사용자"}else if(a.receiver_type==="partner"){const{data:_}=await c.from("partners").select("username").eq("id",a.receiver_id).single();V=_?.username||"관리자"}return{id:a.id,sender_type:a.sender_type,sender_id:a.sender_id,sender_username:j,recipient_type:a.receiver_type,recipient_id:a.receiver_id,recipient_username:V,title:a.subject,content:a.content,message_type:a.message_type,is_read:a.status==="read",read_at:a.read_at,parent_message_id:a.parent_id,created_at:a.created_at,reply_count:f||0}}));K(m)}catch(s){console.error("메시지 조회 오류:",s),d.error("메시지를 불러오는데 실패했습니다.")}finally{B(!1)}},he=async s=>{try{const{error:t}=await c.from("messages").update({status:"read",read_at:new Date().toISOString()}).eq("id",s).eq("status","unread");if(t)throw t;K(n=>n.map(m=>m.id===s?{...m,is_read:!0,read_at:new Date().toISOString()}:m))}catch(t){console.error("메시지 읽음 처리 오류:",t)}},je=async()=>{if(!r.content.trim()){d.error("메시지 내용을 입력해주세요.");return}if(r.broadcast_type==="single"&&!r.recipient_username.trim()){d.error("수신자를 입력해주세요.");return}if(r.broadcast_type==="selected"&&r.selected_users.length===0){d.error("수신자를 선택해주세요.");return}try{let s=[];if(r.broadcast_type==="single"){const a=r.recipient_type==="user"?"users":"partners",{data:f,error:j}=await c.from(a).select("id, username").eq("username",r.recipient_username.trim()).single();if(j||!f){d.error("수신자를 찾을 수 없습니다.");return}s=[f]}else if(r.broadcast_type==="selected"){const a=r.recipient_type==="user"?"users":"partners",{data:f,error:j}=await c.from(a).select("id, username").in("username",r.selected_users);if(j){d.error("수신자 조회에 실패했습니다.");return}s=f||[]}else if(r.broadcast_type==="all"){const a=r.recipient_type==="user"?"users":"partners",{data:f,error:j}=await c.from(a).select("id, username");if(j){d.error("전체 사용자 조회에 실패했습니다.");return}s=f||[]}if(s.length===0){d.error("전송할 수신자가 없습니다.");return}const t=s.map(a=>({sender_type:"partner",sender_id:b.id,receiver_type:r.recipient_type,receiver_id:a.id,subject:r.title||null,content:r.content.trim(),message_type:r.message_type})),{error:n}=await c.from("messages").insert(t);if(n)throw n;const m=s.length;d.success(`메시지가 ${m}명에게 전송되었습니다.`),G&&s.forEach(a=>{G("new_message",{recipient_type:r.recipient_type,recipient_id:a.id,title:r.title,content:r.content})}),u({recipient_type:"user",recipient_username:"",broadcast_type:"single",selected_users:[],title:"",content:"",message_type:"normal"}),U(!1),g(!1),N()}catch(s){console.error("메시지 전송 오류:",s),d.error("메시지 전송에 실패했습니다.")}},fe=async()=>{if(!v||!R.trim()){d.error("답장 내용을 입력해주세요.");return}try{const s={sender_type:"partner",sender_id:b.id,receiver_type:v.sender_type,receiver_id:v.sender_id,subject:v.title?`Re: ${v.title}`:null,content:R.trim(),message_type:"normal",parent_id:v.id},{error:t}=await c.from("messages").insert([s]);if(t)throw t;d.success("답장이 전송되었습니다."),$(""),g(!1),N()}catch(s){console.error("답장 전송 오류:",s),d.error("답장 전송에 실패했습니다.")}};l.useEffect(()=>{O&&O.type==="new_message"&&(d.info("새로운 메시지가 도착했습니다."),N())},[O]),l.useEffect(()=>{N()},[i,T,q]),l.useEffect(()=>{const s=setTimeout(()=>{y!==void 0&&N()},300);return()=>clearTimeout(s)},[y]);const ve=[{key:"sender_username",title:i==="received"?"발신자":"수신자",render:(s,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(be,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:i==="received"?t.sender_username:t.recipient_username}),e.jsx("div",{className:"text-xs text-muted-foreground",children:i==="received"?t.sender_type:t.recipient_type})]})]})},{key:"title",title:"제목/내용",render:(s,t)=>e.jsxs("div",{className:`${!t.is_read&&i==="received"?"font-semibold":""}`,children:[e.jsx("div",{className:"text-sm",children:s||"(제목 없음)"}),e.jsx("div",{className:"text-xs text-muted-foreground truncate max-w-[300px]",children:t.content}),t.reply_count>0&&e.jsxs(Q,{variant:"outline",className:"text-xs mt-1",children:["답글 ",t.reply_count,"개"]})]})},{key:"message_type",title:"유형",render:s=>{const t={normal:{label:"일반",variant:"secondary"},system:{label:"시스템",variant:"outline"},urgent:{label:"긴급",variant:"destructive"}},n=t[s]||t.normal;return e.jsx(Q,{variant:n.variant,children:n.label})}},{key:"is_read",title:"읽음",render:(s,t)=>e.jsxs("div",{className:"flex items-center gap-1",children:[s?e.jsx(J,{className:"h-4 w-4 text-green-600"}):e.jsx(le,{className:"h-4 w-4 text-red-600"}),e.jsx("span",{className:"text-xs",children:s?"읽음":"안읽음"})]})},{key:"created_at",title:"날짜",render:s=>e.jsxs("div",{className:"text-sm",children:[new Date(s).toLocaleDateString("ko-KR"),e.jsx("div",{className:"text-xs text-muted-foreground",children:new Date(s).toLocaleTimeString("ko-KR")})]})},{key:"actions",title:"관리",render:(s,t)=>e.jsxs(Y,{open:W&&v?.id===t.id,onOpenChange:n=>{g(n),n?(L(t),$(""),U(!1),!t.is_read&&i==="received"&&he(t.id)):L(null)},children:[e.jsx(Z,{asChild:!0,children:e.jsxs(p,{size:"sm",variant:"outline",className:"h-8 px-3 flex items-center gap-1",children:[e.jsx(z,{className:"h-4 w-4"}),"보기"]})}),e.jsxs(ee,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsxs(se,{children:[e.jsxs(te,{children:[i==="received"?"받은 메시지":"보낸 메시지"," - ",t.title||"(제목 없음)"]}),e.jsxs(re,{children:["메시지 내용을 확인하고 ",i==="received"?"답장을 작성할 수 있습니다":"전송된 메시지의 상세 정보를 확인할 수 있습니다","."]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(x,{children:"발신자"}),e.jsx("p",{className:"text-sm font-medium",children:t.sender_username})]}),e.jsxs("div",{children:[e.jsx(x,{children:"수신자"}),e.jsx("p",{className:"text-sm font-medium",children:t.recipient_username})]}),e.jsxs("div",{children:[e.jsx(x,{children:"전송일시"}),e.jsx("p",{className:"text-sm",children:new Date(t.created_at).toLocaleString("ko-KR")})]}),e.jsxs("div",{children:[e.jsx(x,{children:"메시지 유형"}),e.jsx("p",{className:"text-sm",children:t.message_type})]})]}),e.jsxs("div",{children:[e.jsx(x,{children:"메시지 내용"}),e.jsx("div",{className:"p-3 bg-muted rounded-md mt-1",children:e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:t.content})})]}),i==="received"&&e.jsxs("div",{children:[e.jsx(x,{htmlFor:"reply",children:"답장 작성"}),e.jsx(X,{id:"reply",placeholder:"답장 내용을 입력하세요...",value:R,onChange:n=>$(n.target.value),rows:4,className:"mt-1"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(p,{variant:"outline",onClick:()=>g(!1),children:"닫기"}),i==="received"&&e.jsxs(p,{onClick:fe,disabled:!R.trim(),children:[e.jsx(ke,{className:"h-4 w-4 mr-2"}),"답장 보내기"]})]})]})]})]})}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-100",children:"메시지 센터"}),e.jsx("p",{className:"text-sm text-slate-400",children:"사용자와 관리자 간 1:1 메시지를 주고받습니다. (개별, 선택, 전체 전송 지원)"})]}),e.jsxs(Y,{open:W&&xe,onOpenChange:s=>{g(s),s?(U(!0),L(null),M("")):(M(""),I([]),A([]))},children:[e.jsx(Z,{asChild:!0,children:e.jsxs(p,{className:"btn-premium-primary",children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"새 메시지"]})}),e.jsxs(ee,{className:"max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(se,{children:[e.jsxs(te,{className:"flex items-center gap-2",children:[e.jsx(ge,{className:"h-5 w-5"}),"새 메시지 작성"]}),e.jsx(re,{children:"개별, 선택, 또는 전체 사용자에게 메시지를 전송할 수 있습니다. 전송 방식을 선택하고 메시지 내용을 작성해주세요."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(x,{htmlFor:"recipient_type",children:"수신자 유형"}),e.jsxs(C,{value:r.recipient_type,onValueChange:s=>{u(t=>({...t,recipient_type:s,recipient_username:"",selected_users:[]})),I([])},children:[e.jsx(S,{children:e.jsx(k,{})}),e.jsxs(D,{children:[e.jsx(o,{value:"user",children:"사용자"}),e.jsx(o,{value:"partner",children:"관리자"})]})]})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"broadcast_type",children:"전송 방식"}),e.jsxs(C,{value:r.broadcast_type,onValueChange:s=>{u(t=>({...t,broadcast_type:s,recipient_username:"",selected_users:[]})),(s==="selected"||s==="all")&&pe()},children:[e.jsx(S,{children:e.jsx(k,{})}),e.jsxs(D,{children:[e.jsx(o,{value:"single",children:"개별 전송"}),e.jsx(o,{value:"selected",children:"선택 전송"}),e.jsx(o,{value:"all",children:"전체 전송"})]})]})]})]}),r.broadcast_type==="single"&&e.jsxs("div",{children:[e.jsx(x,{htmlFor:"recipient_username",children:"수신자 검색"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ne,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 h-4 w-4"}),e.jsx(E,{id:"recipient_username",value:r.recipient_username,onChange:s=>u(t=>({...t,recipient_username:s.target.value})),placeholder:"수신자 ID를 입력하세요 (예: smcdev111)",className:"pl-9 input-premium"})]}),e.jsx("p",{className:"text-xs text-slate-500",children:'💡 Tip: 사용자가 많은 경우 "선택 전송"을 이용하시면 검색하여 선택할 수 있습니다.'})]})]}),r.broadcast_type==="selected"&&e.jsxs("div",{children:[e.jsx(x,{children:"수신자 선택"}),ue?e.jsxs("div",{className:"flex items-center justify-center p-8 text-slate-400",children:[e.jsx("div",{className:"loading-premium w-8 h-8"}),e.jsx("span",{className:"ml-3",children:"사용자 목록 로딩 중..."})]}):e.jsxs("div",{className:"mt-2 space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Ce,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 h-4 w-4"}),e.jsx(E,{value:w,onChange:s=>M(s.target.value),placeholder:"사용자 ID로 검색...",className:"pl-9 input-premium"})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"text-sm text-slate-300",children:[F.length,"명 표시 중 / 총 ",h.length,"명"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(p,{size:"sm",variant:"outline",onClick:()=>{const s=F.map(t=>t.username);u(t=>({...t,selected_users:Array.from(new Set([...t.selected_users,...s]))}))},className:"btn-premium-success text-xs px-2 py-1 h-7",children:"현재 페이지 전체 선택"}),e.jsx(p,{size:"sm",variant:"outline",onClick:()=>{u(s=>({...s,selected_users:[]}))},className:"text-xs px-2 py-1 h-7",children:"전체 해제"})]})]}),e.jsxs("div",{className:"max-h-64 overflow-y-auto border border-slate-600 rounded-lg bg-slate-900/50 p-3 space-y-1",children:[F.map(s=>e.jsxs("label",{className:"flex items-center space-x-3 cursor-pointer hover:bg-slate-800/50 p-2 rounded transition-colors",children:[e.jsx("input",{type:"checkbox",checked:r.selected_users.includes(s.username),onChange:t=>{const n=s.username;t.target.checked?u(m=>({...m,selected_users:[...m.selected_users,n]})):u(m=>({...m,selected_users:m.selected_users.filter(a=>a!==n)}))},className:"rounded w-4 h-4"}),e.jsx("span",{className:"text-sm text-slate-200",children:s.username})]},s.id)),F.length===0&&e.jsx("div",{className:"text-center text-sm text-slate-500 py-8",children:w?"검색 결과가 없습니다.":"사용자가 없습니다."})]})]}),r.selected_users.length>0&&e.jsxs("div",{className:"mt-3 p-3 bg-blue-900/30 border border-blue-600/30 rounded-lg",children:[e.jsxs("div",{className:"text-sm text-blue-300 flex items-center gap-2",children:[e.jsx(J,{className:"h-4 w-4"}),e.jsx("strong",{children:"선택된 사용자:"})," ",r.selected_users.length,"명"]}),e.jsx("div",{className:"text-xs text-blue-400 mt-2 max-h-24 overflow-y-auto",children:r.selected_users.join(", ")})]})]}),r.broadcast_type==="all"&&e.jsxs("div",{className:"p-4 bg-yellow-50 border border-yellow-200 rounded-md",children:[e.jsxs("div",{className:"flex items-center gap-2 text-yellow-800 mb-2",children:[e.jsx(le,{className:"h-5 w-5"}),e.jsx("span",{className:"font-medium",children:"전체 전송 확인"})]}),e.jsxs("p",{className:"text-sm text-yellow-700",children:["모든 ",r.recipient_type==="user"?"사용자":"관리자","에게 메시지가 전송됩니다.",h.length>0&&e.jsxs("span",{className:"font-medium",children:[" (총 ",h.length,"명)"]})]}),h.length>0&&e.jsxs("div",{className:"mt-2 text-xs text-yellow-600",children:["대상: ",h.map(s=>s.username).join(", ")]})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"new_title",children:"제목 (선택)"}),e.jsx(E,{id:"new_title",value:r.title,onChange:s=>u(t=>({...t,title:s.target.value})),placeholder:"메시지 제목을 입력하세요"})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"new_content",children:"내용 *"}),e.jsx(X,{id:"new_content",value:r.content,onChange:s=>u(t=>({...t,content:s.target.value})),placeholder:"메시지 내용을 입력하세요",rows:6})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"message_type",children:"메시지 유형"}),e.jsxs(C,{value:r.message_type,onValueChange:s=>u(t=>({...t,message_type:s})),children:[e.jsx(S,{children:e.jsx(k,{})}),e.jsxs(D,{children:[e.jsx(o,{value:"normal",children:"일반"}),e.jsx(o,{value:"system",children:"시스템"}),e.jsx(o,{value:"urgent",children:"긴급"})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx(p,{variant:"outline",onClick:()=>g(!1),children:"취소"}),e.jsxs(p,{onClick:je,disabled:!r.content.trim()||r.broadcast_type==="single"&&!r.recipient_username.trim()||r.broadcast_type==="selected"&&r.selected_users.length===0,children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"전송",r.broadcast_type==="single"&&" (1명)",r.broadcast_type==="selected"&&` (${r.selected_users.length}명)`,r.broadcast_type==="all"&&` (${h.length}명)`]})]})]})]})]})]}),e.jsxs("div",{className:"glass-card rounded-xl p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-6 pb-4 border-b border-slate-700/50",children:e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-semibold text-slate-100 flex items-center gap-2",children:[e.jsx(z,{className:"h-5 w-5 text-blue-400"}),"메시지 목록"]}),e.jsx("p",{className:"text-sm text-slate-400 mt-1",children:"사용자와 관리자 간 메시지를 주고받고 관리합니다. 개별, 선택, 전체 전송을 지원합니다."})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(p,{variant:i==="received"?"default":"outline",onClick:()=>H("received"),className:i==="received"?"btn-premium-primary":"",children:"받은 메시지"}),e.jsx(p,{variant:i==="sent"?"default":"outline",onClick:()=>H("sent"),className:i==="sent"?"btn-premium-primary":"",children:"보낸 메시지"})]}),e.jsx("div",{className:"flex-1 min-w-[200px]",children:e.jsxs("div",{className:"relative",children:[e.jsx(ne,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 h-4 w-4"}),e.jsx(E,{placeholder:"제목, 내용으로 검색...",value:y,onChange:s=>me(s.target.value),className:"pl-9 input-premium"})]})}),e.jsxs(C,{value:T,onValueChange:de,children:[e.jsx(S,{className:"w-[120px] bg-slate-800/50 border-slate-600",children:e.jsx(k,{})}),e.jsxs(D,{children:[e.jsx(o,{value:"all",children:"전체 유형"}),e.jsx(o,{value:"normal",children:"일반"}),e.jsx(o,{value:"system",children:"시스템"}),e.jsx(o,{value:"urgent",children:"긴급"})]})]}),i==="received"&&e.jsxs(C,{value:q,onValueChange:oe,children:[e.jsx(S,{className:"w-[120px] bg-slate-800/50 border-slate-600",children:e.jsx(k,{})}),e.jsxs(D,{children:[e.jsx(o,{value:"all",children:"전체"}),e.jsx(o,{value:"unread",children:"안읽음"}),e.jsx(o,{value:"read",children:"읽음"})]})]})]}),ie?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(Ne,{})}):e.jsx(we,{data:ce,columns:ve,enableSearch:!1})]})]})]})}export{Le as MessageCenter,Le as default};
