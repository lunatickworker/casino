import{r as i,j as e}from"./react-core-CwM-CeLv.js";import{M as ne,i as b,C as ie,a as ce,b as oe,e as de,T as me,j as ue,k as F,I as xe,S as H,p as K,q as Q,r as W,t as v,B as G,N as he,O as fe,P as pe,Q as $}from"./index-XNFiaZD4.js";import{D as je}from"./DataTable-CpNEyjEM.js";import{k as m}from"./vendor-CQn7sZ7L.js";import{g as N}from"./gameApi-3VMNuz_n.js";import{M as k}from"./MetricCard-gDtl4jB5.js";import{Z as ge,R as P,m as T,E as A,z as D,ai as z,G as J,K as be,N as ve,aj as Ne}from"./lucide-icons-wLPRtdhM.js";import"./radix-ui-SX2QAG6c.js";import"./supabase-r6ABpEO8.js";function Ee({user:f}){const[u,X]=i.useState("casino"),[x,R]=i.useState([]),[h,Y]=i.useState([]),[y,w]=i.useState(!1),[d,E]=i.useState(""),[l,S]=i.useState("all"),[c,M]=i.useState("all"),[p,I]=i.useState(new Set),[g,B]=i.useState(!1),[ee,V]=i.useState([]),[se,U]=i.useState(!1),{sendMessage:q,isConnected:O}=ne(),L=i.useMemo(()=>x.filter(s=>!(s.type!==u||d&&!s.name.toLowerCase().includes(d.toLowerCase())&&!s.provider_name?.toLowerCase().includes(d.toLowerCase())||l!=="all"&&s.provider_id.toString()!==l||c!=="all"&&s.status!==c)),[x,u,d,l,c]);i.useEffect(()=>{ae()},[]),i.useEffect(()=>{O&&q({type:"subscribe",channel:"game_status_updates",userId:f.id})},[O,f.id]);const ae=async()=>{try{w(!0);const s=await N.getProviders();Y(s),await N.initializeCasinoLobbyGames(),await j("casino")}catch(s){console.error("초기 데이터 로드 실패:",s),m.error("데이터를 불러오는데 실패했습니다.")}finally{w(!1)}},j=async s=>{try{w(!0);const t=s||u,a={type:t==="casino"?"casino":"slot"};l!=="all"&&(a.provider_id=parseInt(l),console.log("🔍 제공사 필터 적용:",l,"→",a.provider_id)),c!=="all"&&(a.status=c,console.log("🔍 상태 필터 적용:",c)),d.trim()&&(a.search=d.trim(),console.log("🔍 검색어 필터 적용:",d.trim())),console.log("🎮 EnhancedGameManagement - loadGames 호출:",{gameType:t,partnerId:f.id,filters:a});const r=await N.getGames(f.id,a);console.log("🎮 EnhancedGameManagement - 로드된 게임:",{전체개수:r.length,탭:t,제공사필터:l!=="all"?l:"전체",샘플:r.slice(0,5).map(n=>({id:n.id,name:n.name,provider_id:n.provider_id,provider_name:n.provider_name,type:n.type}))}),R(r);const o=r.filter(n=>!(l!=="all"&&n.provider_id.toString()!==l||c!=="all"&&n.status!==c||d&&!n.name.toLowerCase().includes(d.toLowerCase()))).length;console.log("✅ 필터링 후 표시될 게임 수:",o)}catch(t){console.error("게임 데이터 로드 실패:",t),m.error("게임 데이터를 불러오는데 실패했습니다.")}finally{w(!1)}},te=async s=>{X(s),S("all"),M("all"),E(""),await j(s)};i.useEffect(()=>{const s=setTimeout(()=>{h.length>0&&!g&&p.size===0&&j()},300);return()=>clearTimeout(s)},[d,c]),i.useEffect(()=>{h.length>0&&!g&&p.size===0&&j()},[l]);const C=async(s,t,a,r)=>{try{await N.updateGameStatusForPartner(f.id,s,t,a,r),q({type:"game_status_update",partnerId:f.id,gameId:s,status:t,priority:a,isFeatured:r,updatedBy:f.id}),R(o=>o.map(n=>n.id===s?{...n,status:t,priority:a||n.priority,is_featured:r||n.is_featured}:n)),m.success("게임 상태가 업데이트되었습니다.")}catch(o){console.error("게임 상태 업데이트 실패:",o),m.error("게임 상태 업데이트에 실패했습니다.")}},Z=async s=>{const t=h.find(a=>a.id===s);if(!t){m.error("제공사를 찾을 수 없습니다.");return}if(t.type==="casino"){m.info("카지노는 로비 진입 방식으로 게임 목록이 없습니다.");return}if(p.has(s)){m.warning("이미 동기화가 진행 중입니다.");return}I(a=>new Set([...a,s]));try{console.log(`🔄 ${t.name} (ID: ${s}) 동기화 시작`);const a=await N.syncGamesFromAPI(s);a.newGames===0&&a.updatedGames===0&&a.totalGames===0?m.info(`${t.name}: 게임 리스트가 없거나 지원하지 않는 제공사입니다.`,{description:"카지노 제공사는 로비 진입 방식을 사용하거나, 일부 슬롯 제공사는 게임 목록을 제공하지 않을 수 있습니다."}):(m.success(`${t.name} 동기화 완료: 신규 ${a.newGames}개, 업데이트 ${a.updatedGames}개`,{description:`총 ${a.totalGames}개 게임 처리됨`}),console.log(`✅ 동기화 완료, 제공사 필터 자동 설정: ${s}`),S(s.toString())),await j()}catch(a){console.error(`${t.name} 동기화 실패:`,a);const r=a instanceof Error?a.message:"알 수 없는 오류";m.error(`${t.name} 동기화 실패`,{description:r})}finally{I(a=>{const r=new Set(a);return r.delete(s),r})}},le=async()=>{if(g){m.warning("이미 전체 동기화가 진행 중입니다.");return}B(!0),V([]),U(!0);try{const s=await N.syncAllProviderGames();V(s.results);const t=s.results.reduce((o,n)=>o+n.gamesAdded,0),a=s.results.reduce((o,n)=>o+n.gamesUpdated,0),r=s.results.filter(o=>o.error).length;s.success?m.success(`전체 동기화 완료: 신규 ${t}개, 업데이트 ${a}개`):m.warning(`동기화 완료 (일부 실패): 신규 ${t}개, 업데이트 ${a}개, 실패 ${r}개`),await j()}catch(s){console.error("전체 동기화 실패:",s),m.error("전체 동기화에 실패했습니다.")}finally{B(!1)}},_=i.useMemo(()=>({visible:x.filter(s=>s.status==="visible"&&s.type===u).length,hidden:x.filter(s=>s.status==="hidden"&&s.type===u).length,maintenance:x.filter(s=>s.status==="maintenance"&&s.type===u).length,featured:x.filter(s=>s.is_featured&&s.type===u).length}),[x,u]),re=[{header:"게임 정보",accessor:"name",cell:s=>e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("div",{className:"relative w-12 h-12 flex-shrink-0",children:[s.image_url?e.jsx("img",{src:s.image_url,alt:s.name,className:"w-full h-full rounded-lg object-cover bg-slate-100 dark:bg-slate-800",onError:t=>{const a=t.target;a.style.display="none";const r=a.parentElement;if(r&&!r.querySelector(".game-image-placeholder")){const o=document.createElement("div");o.className="game-image-placeholder w-full h-full rounded-lg text-xs",o.textContent="🎮",r.appendChild(o)}}}):e.jsx("div",{className:"game-image-placeholder w-full h-full rounded-lg text-xs",children:"🎮"}),s.is_featured&&e.jsx(z,{className:"absolute -top-1 -right-1 w-4 h-4 text-yellow-500 fill-current"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium truncate",children:s.name}),e.jsxs("div",{className:"text-sm text-muted-foreground truncate",children:[s.provider_name," ",s.rtp&&`• RTP ${s.rtp}%`]})]})]})},{header:"상태",accessor:"status",cell:s=>{const a={visible:{label:"노출",variant:"default",icon:T},hidden:{label:"비노출",variant:"secondary",icon:A},maintenance:{label:"점검중",variant:"destructive",icon:D}}[s.status],r=a?.icon||T;return e.jsxs(G,{variant:a?.variant||"default",className:"gap-1",children:[e.jsx(r,{className:"w-3 h-3"}),a?.label||s.status]})}},{header:"우선순위",accessor:"priority",cell:s=>e.jsx("div",{className:"text-center font-mono",children:s.priority||0})},{header:"플레이 수",accessor:"play_count",cell:s=>e.jsx("div",{className:"text-center",children:s.play_count?.toLocaleString()||0})},{header:"액션",accessor:"actions",cell:s=>e.jsxs(he,{children:[e.jsx(fe,{asChild:!0,children:e.jsx(b,{variant:"ghost",size:"sm",children:e.jsx(Ne,{className:"w-4 h-4"})})}),e.jsxs(pe,{align:"end",children:[e.jsxs($,{onClick:()=>C(s.id,"visible"),children:[e.jsx(T,{className:"w-4 h-4 mr-2"}),"노출하기"]}),e.jsxs($,{onClick:()=>C(s.id,"hidden"),children:[e.jsx(A,{className:"w-4 h-4 mr-2"}),"숨기기"]}),e.jsxs($,{onClick:()=>C(s.id,"maintenance"),children:[e.jsx(D,{className:"w-4 h-4 mr-2"}),"점검중으로 설정"]}),e.jsxs($,{onClick:()=>C(s.id,s.status,s.priority,!s.is_featured),children:[e.jsx(z,{className:"w-4 h-4 mr-2"}),s.is_featured?"추천 해제":"추천 설정"]})]})]})}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-100",children:"게임 관리"}),e.jsx("p",{className:"text-sm text-slate-400",children:"게임 목록 동기화 및 상태 관리"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(b,{onClick:le,disabled:g,className:"btn-premium-primary",children:[e.jsx(ge,{className:"w-4 h-4 mr-2"}),g?"동기화 중...":"전체 동기화"]}),e.jsx(b,{onClick:()=>j(),disabled:y,variant:"outline",className:"border-slate-600 hover:bg-slate-700",children:e.jsx(P,{className:`w-4 h-4 ${y?"animate-spin":""}`})})]})]}),e.jsxs("div",{className:"grid gap-5 md:grid-cols-2 lg:grid-cols-4",children:[e.jsx(k,{title:"노출 게임",value:_.visible.toLocaleString(),subtitle:"활성화된 게임",icon:T,color:"green"}),e.jsx(k,{title:"비노출 게임",value:_.hidden.toLocaleString(),subtitle:"숨김 처리됨",icon:A,color:"platinum"}),e.jsx(k,{title:"점검중",value:_.maintenance.toLocaleString(),subtitle:"점검 상태",icon:D,color:"red"}),e.jsx(k,{title:"추천 게임",value:_.featured.toLocaleString(),subtitle:"추천 설정됨",icon:z,color:"amber"})]}),se&&e.jsxs(ie,{children:[e.jsx(ce,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(oe,{children:"동기화 결과"}),e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>U(!1),children:"✕"})]})}),e.jsx(de,{children:e.jsx("div",{className:"space-y-2",children:ee.map(s=>e.jsxs("div",{className:`flex items-center justify-between p-3 rounded-lg border ${s.error?"bg-red-50 border-red-200":"bg-green-50 border-green-200"}`,children:[e.jsx("span",{className:"font-medium",children:s.providerName}),e.jsx("div",{className:"text-sm",children:s.error?e.jsxs("span",{className:"text-red-600",children:["실패: ",s.error]}):e.jsxs("span",{className:"text-green-600",children:["신규 ",s.gamesAdded,"개, 업데이트 ",s.gamesUpdated,"개"]})})]},s.providerId))})})]}),e.jsxs("div",{className:"glass-card rounded-xl p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-6 pb-4 border-b border-slate-700/50",children:e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-semibold text-slate-100 flex items-center gap-2",children:[e.jsx(J,{className:"h-5 w-5 text-blue-400"}),"게임 목록"]}),e.jsx("p",{className:"text-sm text-slate-400 mt-1",children:"게임 제공사별 게임 목록 관리 및 상태 설정"})]})}),e.jsxs(me,{value:u,onValueChange:te,children:[e.jsxs(ue,{className:"grid w-full grid-cols-2 bg-slate-800/50 p-1 rounded-xl mb-6 border border-slate-700/50",children:[e.jsx(F,{value:"casino",className:"data-[state=active]:bg-gradient-to-r data-[state=active]:from-purple-600 data-[state=active]:to-pink-600 data-[state=active]:text-white data-[state=active]:shadow-[0_0_20px_rgba(168,85,247,0.5)] rounded-lg transition-all duration-300 font-semibold",children:"🎰 카지노"}),e.jsx(F,{value:"slot",className:"data-[state=active]:bg-gradient-to-r data-[state=active]:from-blue-600 data-[state=active]:to-cyan-600 data-[state=active]:text-white data-[state=active]:shadow-[0_0_20px_rgba(59,130,246,0.5)] rounded-lg transition-all duration-300 font-semibold",children:"🎲 슬롯"})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(be,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4"}),e.jsx(xe,{placeholder:"게임명 또는 제공사명으로 검색...",value:d,onChange:s=>E(s.target.value),className:"pl-10 input-premium"})]})}),e.jsxs(H,{value:l,onValueChange:S,children:[e.jsx(K,{className:"w-full sm:w-56 bg-slate-800/50 border-slate-600 text-slate-200",children:e.jsx(Q,{placeholder:"제공사 선택",children:l==="all"?"모든 제공사":h.find(s=>s.id.toString()===l)?.name||"제공사 선택"})}),e.jsxs(W,{children:[e.jsx(v,{value:"all",children:e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{children:"🌐 모든 제공사"})})}),h.filter(s=>s.type===(u==="casino"?"casino":"slot")).map(s=>{const t=x.filter(a=>a.provider_id===s.id&&a.type===u).length;return e.jsx(v,{value:s.id.toString(),children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{children:s.name}),t>0&&e.jsxs("span",{className:"text-xs text-slate-500",children:["(",t,"개)"]})]})},s.id)})]})]}),e.jsxs(H,{value:c,onValueChange:M,children:[e.jsx(K,{className:"w-full sm:w-32 bg-slate-800/50 border-slate-600",children:e.jsx(Q,{placeholder:"상태"})}),e.jsxs(W,{children:[e.jsx(v,{value:"all",children:"모든 상태"}),e.jsx(v,{value:"visible",children:"노출"}),e.jsx(v,{value:"hidden",children:"비노출"}),e.jsx(v,{value:"maintenance",children:"점검중"})]})]})]}),(l!=="all"||c!=="all"||d)&&e.jsxs("div",{className:"flex flex-wrap items-center gap-2 p-3 bg-gradient-to-r from-blue-500/10 to-purple-500/10 rounded-lg border border-blue-500/30",children:[e.jsx("span",{className:"text-sm font-medium text-slate-300",children:"🔍 현재 필터:"}),l!=="all"&&e.jsxs(G,{variant:"default",className:"gap-1 bg-blue-600 hover:bg-blue-700",children:[e.jsx(ve,{className:"w-3 h-3"}),h.find(s=>s.id.toString()===l)?.name||"제공사",e.jsx("button",{onClick:()=>S("all"),className:"ml-1 hover:text-white",children:"✕"})]}),c!=="all"&&e.jsxs(G,{variant:"secondary",className:"gap-1",children:[c==="visible"&&"노출",c==="hidden"&&"비노출",c==="maintenance"&&"점검중",e.jsx("button",{onClick:()=>M("all"),className:"ml-1 hover:text-white",children:"✕"})]}),d&&e.jsxs(G,{variant:"outline",className:"gap-1 border-slate-500",children:["검색: ",d,e.jsx("button",{onClick:()=>E(""),className:"ml-1 hover:text-white",children:"✕"})]}),e.jsxs("span",{className:"text-xs text-slate-400",children:[L.length,"개 게임 표시 중"]})]}),u==="slot"&&e.jsxs("div",{className:"flex flex-wrap gap-2 p-4 bg-slate-800/30 rounded-lg border border-slate-700/50",children:[e.jsx("div",{className:"text-sm text-slate-400 mb-2 w-full",children:"제공사별 게임 동기화:"}),h.filter(s=>s.type==="slot").map(s=>{const t=x.filter(a=>a.provider_id===s.id&&a.type==="slot").length;return e.jsxs(b,{size:"sm",variant:"outline",onClick:()=>Z(s.id),disabled:p.has(s.id)||g,className:"gap-1 border-slate-600 hover:bg-slate-700",children:[e.jsx(P,{className:`w-3 h-3 ${p.has(s.id)?"animate-spin":""}`}),s.name,t>0&&e.jsxs("span",{className:"text-xs text-slate-400",children:["(",t,")"]})]},s.id)})]}),L.length===0&&!y&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-4 bg-slate-800/30 rounded-lg border border-slate-700/50",children:[e.jsx(J,{className:"w-16 h-16 text-slate-600 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-slate-300 mb-2",children:l!=="all"?`${h.find(s=>s.id.toString()===l)?.name||"선택한 제공사"} 게임이 없습니다`:"게임이 없습니다"}),e.jsx("p",{className:"text-sm text-slate-400 text-center max-w-md mb-6",children:l!=="all"?"해당 제공사의 게임을 동기화하려면 위의 동기화 버튼을 클릭하세요.":"제공사를 선택하고 동기화 버튼을 클릭하여 게임을 불러오세요."}),l!=="all"&&u==="slot"&&e.jsxs(b,{onClick:()=>Z(parseInt(l)),disabled:p.has(parseInt(l)),className:"btn-premium-primary",children:[e.jsx(P,{className:`w-4 h-4 mr-2 ${p.has(parseInt(l))?"animate-spin":""}`}),h.find(s=>s.id.toString()===l)?.name," 동기화"]})]}),e.jsx(je,{data:L,columns:re,loading:y,enableSearch:!1,emptyMessage:""})]})]})]})]})}export{Ee as EnhancedGameManagement,Ee as default};
