import{r as i,j as t}from"./react-core-CwM-CeLv.js";import{B as q,i as h,D as fe,s as m,E as R,F as U}from"./index-VqnjmEt7.js";import{D as he}from"./DataTable-DkJxkcdT.js";import{k as l}from"./vendor-CQn7sZ7L.js";import{A as K,a as G,b as V,c as F,d as H,e as Q}from"./AdminDialog-B_rGWUmq.js";import{M as k}from"./MetricCard-DjZht7CW.js";import{a1 as ge,a2 as _e,R as W,a3 as Y,U as pe,u as xe,i as be,t as ve}from"./lucide-icons-D2Y5yybo.js";import"./radix-ui-SX2QAG6c.js";import"./supabase-r6ABpEO8.js";const Se={1:"ë§ˆì´í¬ë¡œê²Œì´ë°",17:"í”Œë ˆì´ì•¤ê³ ",20:"CQ9 ê²Œì´ë°",21:"ì œë„¤ì‹œìŠ¤ ê²Œì´ë°",22:"í•˜ë°”ë„¤ë¡œ",23:"ê²Œìž„ì•„íŠ¸",27:"í”Œë ˆì´í…",38:"ë¸”ë£¨í”„ë¦°íŠ¸",39:"ë¶€ìš´ê³ ",40:"ë“œë¼êµ°ì†Œí”„íŠ¸",41:"ì—˜í¬ ìŠ¤íŠœë””ì˜¤",47:"ë“œë¦¼í…Œí¬",51:"ì¹¼ëžŒë°” ê²Œìž„ì¦ˆ",52:"ëª¨ë¹Œë¡¯",53:"ë…¸ë¦¬ë°‹ ì‹œí‹°",55:"OMI ê²Œì´ë°",56:"ì›í„°ì¹˜",59:"í”Œë ˆì´ìŠ¨",60:"í‘¸ì‰¬ ê²Œì´ë°",61:"í€µìŠ¤í•€",62:"RTG ìŠ¬ë¡¯",63:"ë¦¬ë³¼ë²„ ê²Œì´ë°",65:"ìŠ¬ë¡¯ë°€",66:"ìŠ¤í”¼ì–´í—¤ë“œ",70:"ì¬ë”í‚¥",72:"ìš°í›„ ê²Œìž„ì¦ˆ",74:"ë¦´ë ‰ìŠ¤ ê²Œì´ë°",75:"ë„·ì—”íŠ¸",76:"ë ˆë“œíƒ€ì´ê±°",87:"PGì†Œí”„íŠ¸",88:"í”Œë ˆì´ìŠ¤íƒ€",90:"ë¹…íƒ€ìž„ê²Œì´ë°",300:"í”„ë¼ê·¸ë§ˆí‹± í”Œë ˆì´",410:"ì—ë³¼ë£¨ì…˜ ê²Œì´ë°",77:"ë§ˆì´í¬ë¡œê²Œì´ë° ë¼ì´ë¸Œ",2:"Vivo ê²Œì´ë°",30:"ì•„ì‹œì•„ ê²Œì´ë°",78:"í”„ë¼ê·¸ë§ˆí‹± í”Œë ˆì´ ë¼ì´ë¸Œ",86:"ì„¹ì‹œê²Œì´ë°",11:"ë¹„ë¹„ì•„ì´ì—”",28:"ë“œë¦¼ê²Œìž„",89:"ì˜¤ë¦¬ì—”íƒˆê²Œìž„",91:"ë³´íƒ€",44:"ì´ì£¼ê¸°",85:"í”Œë ˆì´í… ë¼ì´ë¸Œ",0:"ì œë„¤ëŸ´ ì¹´ì§€ë…¸"},ye={41e4:"ì—ë³¼ë£¨ì…˜ ë¼ì´ë¸Œì¹´ì§€ë…¸",77060:"ë§ˆì´í¬ë¡œê²Œì´ë° ë¼ì´ë¸Œì¹´ì§€ë…¸",2029:"Vivo ë¼ì´ë¸Œì¹´ì§€ë…¸",3e4:"ì•„ì‹œì•„ê²Œì´ë° ë¼ì´ë¸Œì¹´ì§€ë…¸",78001:"í”„ë¼ê·¸ë§ˆí‹± ë¼ì´ë¸Œì¹´ì§€ë…¸",86001:"ì„¹ì‹œê²Œì´ë° ë¼ì´ë¸Œì¹´ì§€ë…¸",11e3:"ë¹„ë¹„ì•„ì´ì—” ë¼ì´ë¸Œì¹´ì§€ë…¸",28e3:"ë“œë¦¼ê²Œìž„ ë¼ì´ë¸Œì¹´ì§€ë…¸",89e3:"ì˜¤ë¦¬ì—”íƒˆê²Œìž„ ë¼ì´ë¸Œì¹´ì§€ë…¸",91e3:"ë³´íƒ€ ë¼ì´ë¸Œì¹´ì§€ë…¸",44006:"ì´ì£¼ê¸° ë¼ì´ë¸Œì¹´ì§€ë…¸",85036:"í”Œë ˆì´í… ë¼ì´ë¸Œì¹´ì§€ë…¸",0:"ì œë„¤ëŸ´ ë¼ì´ë¸Œì¹´ì§€ë…¸"};function Oe({user:f}){const[c,J]=i.useState([]),[N,M]=i.useState(!0),[I,A]=i.useState(!1),[v,$]=i.useState(null),[X,S]=i.useState(!1),[O,B]=i.useState(null),[je,Z]=i.useState(0),[d,y]=i.useState(new Set),[ee,j]=i.useState(!1);i.useEffect(()=>{const e=setInterval(()=>Z(s=>s+1),1e3);return()=>clearInterval(e)},[]);const p=async(e=!1)=>{try{!e&&N?M(!0):A(!0);const s=new Date,r=new Date(s.getTime()-6e4);console.log("ðŸ• ì„¸ì…˜ ìžë™ ì¢…ë£Œ ì²´í¬:",{í˜„ìž¬ì‹œê°„:s.toISOString(),ê¸°ì¤€ì‹œê°„_60ì´ˆì „:r.toISOString()});const{data:n,error:o}=await fe.from("game_launch_sessions").update({status:"auto_ended",ended_at:s.toISOString()}).eq("status","active").lt("last_activity_at",r.toISOString()).select("id, user_id, last_activity_at");if(o)console.error("âŒ ì„¸ì…˜ ìžë™ ì¢…ë£Œ ì˜¤ë¥˜:",o);else if(n&&n.length>0){console.log(`âœ… ${n.length}ê°œ ì„¸ì…˜ ìžë™ ì¢…ë£Œ:`,n.map(a=>({id:a.id,user_id:a.user_id,ë§ˆì§€ë§‰í™œë™:a.last_activity_at,ê²½ê³¼ì‹œê°„_ì´ˆ:Math.floor((s.getTime()-new Date(a.last_activity_at).getTime())/1e3)})));for(const a of n)await ae(a.user_id)}let g=m.from("game_launch_sessions").select(`
          id,
          session_id,
          user_id,
          game_id,
          balance_before,
          launched_at,
          last_activity_at,
          users!inner(
            id,
            username,
            nickname,
            balance,
            ip_address,
            device_info,
            referrer_id
          )
        `).eq("status","active").order("last_activity_at",{ascending:!1});if(f.partner_type!=="ì‹œìŠ¤í…œê´€ë¦¬ìž"){const{data:a}=await m.from("partners").select("id").or(`parent_id.eq.${f.id},id.eq.${f.id}`),x=a?.map(b=>b.id)||[f.id];g=g.in("users.referrer_id",x)}const{data:w,error:E}=await g;if(E)throw E;const P=[...new Set((w||[]).map(a=>a.game_id).filter(Boolean))];let z={};if(P.length>0){const{data:a}=await m.from("games").select("id, name, provider_id, game_providers(name)").in("id",P);a&&(z=Object.fromEntries(a.map(x=>[x.id,x])))}const ue=(w||[]).map(a=>{const x=a.users.ip_address||"-";let b="PC";if(a.users.device_info){const _=a.users.device_info;if(_.device==="Mobile"||_.device==="mobile")b="Mobile";else if(_.platform){const u=String(_.platform).toLowerCase();(u.includes("android")||u.includes("iphone")||u.includes("ipad")||u.includes("mobile"))&&(b="Mobile")}else if(_.userAgent){const u=String(_.userAgent).toLowerCase();(u.includes("mobile")||u.includes("android")||u.includes("iphone")||u.includes("ipad"))&&(b="Mobile")}}const L=Math.floor(a.game_id/1e3),me=Se[L]||`Provider ${L}`;let C=ye[a.game_id];return C||(C=z[a.game_id]?.name||`Game ${a.game_id}`),{id:a.id,session_id:a.session_id,user_id:a.users.id,username:a.users.username,nickname:a.users.nickname||a.users.username,game_name:C,provider_name:me,balance_before:Number(a.balance_before)||0,current_balance:Number(a.users.balance)||0,device_type:b,ip_address:x,launched_at:a.launched_at,last_activity_at:a.last_activity_at}});J(ue)}catch(s){console.error("ì„¸ì…˜ ë¡œë“œ ì˜¤ë¥˜:",s),l.error("ì„¸ì…˜ ë¡œë“œ ì‹¤íŒ¨")}finally{M(!1),A(!1)}};i.useEffect(()=>{console.log("ðŸ”„ OnlineUsers 30ì´ˆ íƒ€ì´ë¨¸ ì‹œìž‘"),p();const e=setInterval(()=>{console.log("â° 30ì´ˆ ê²½ê³¼ - ì„¸ì…˜ ìžë™ ì¢…ë£Œ ì²´í¬ ì‹¤í–‰"),p()},3e4);return()=>{console.log("ðŸ›‘ OnlineUsers 30ì´ˆ íƒ€ì´ë¨¸ ì¢…ë£Œ"),clearInterval(e)}},[f.id,f.partner_type]),i.useEffect(()=>{const e=async()=>{try{const r=new Date(Date.now()-144e5).toISOString(),{data:n,error:o}=await m.from("game_launch_sessions").delete().in("status",["auto_ended","ended","force_ended"]).lt("ended_at",r).select("id");o?console.error("ì„¸ì…˜ ì •ë¦¬ ì˜¤ë¥˜:",o):n&&n.length>0&&console.log(`ðŸ—‘ï¸ ${n.length}ê°œ ì˜¤ëž˜ëœ ì„¸ì…˜ ì‚­ì œ (4ì‹œê°„ ê²½ê³¼)`)}catch(r){console.error("ì„¸ì…˜ ì •ë¦¬ ì‹¤í–‰ ì˜¤ë¥˜:",r)}};e();const s=setInterval(e,3600*1e3);return()=>clearInterval(s)},[]);const se=e=>{const s=new Date(e).getTime(),r=Date.now(),n=Math.max(0,r-s);if(isNaN(n))return"0ë¶„";const o=Math.floor(n/1e3/60);if(o<60)return`${o}ë¶„`;const g=Math.floor(o/60),w=o%60;return`${g}ì‹œê°„ ${w}ë¶„`},te=async e=>{try{B(e.user_id);const s=await R(f.id);if(!s){l.error("API ì„¤ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");return}const r=await U(s.opcode,e.username,s.token,s.secret_key);r&&r.success&&typeof r.balance=="number"?(await m.from("users").update({balance:r.balance}).eq("id",e.user_id),l.success("ë³´ìœ ê¸ˆ ë™ê¸°í™” ì™„ë£Œ"),p()):l.error(r?.error||"ë³´ìœ ê¸ˆ ì¡°íšŒ ì‹¤íŒ¨")}catch(s){console.error("ë³´ìœ ê¸ˆ ë™ê¸°í™” ì˜¤ë¥˜:",s),l.error("ë³´ìœ ê¸ˆ ë™ê¸°í™” ì‹¤íŒ¨")}finally{B(null)}},ae=async e=>{try{const s=await R(f.id);if(!s){console.error("ì„¸ì…˜ ì¢…ë£Œ ì‹œ API ì„¤ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");return}const r=await m.from("users").select("username").eq("id",e).single();if(!r.data){console.error("ì„¸ì…˜ ì¢…ë£Œ ì‹œ ì‚¬ìš©ìž ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");return}const n=await U(s.opcode,r.data.username,s.token,s.secret_key);n&&n.success&&typeof n.balance=="number"?(await m.from("users").update({balance:n.balance}).eq("id",e),console.log(`ì„¸ì…˜ ì¢…ë£Œ ì‹œ ë³´ìœ ê¸ˆ ë™ê¸°í™” ì™„ë£Œ: ${e}`)):console.error(n?.error||"ì„¸ì…˜ ì¢…ë£Œ ì‹œ ë³´ìœ ê¸ˆ ì¡°íšŒ ì‹¤íŒ¨")}catch(s){console.error("ì„¸ì…˜ ì¢…ë£Œ ì‹œ ë³´ìœ ê¸ˆ ë™ê¸°í™” ì˜¤ë¥˜:",s)}},re=async()=>{if(v)try{const{error:e}=await m.from("game_launch_sessions").update({status:"force_ended",ended_at:new Date().toISOString()}).eq("id",v.id);if(e){console.error("ì„¸ì…˜ ì¢…ë£Œ ì˜¤ë¥˜:",e),l.error(`ì„¸ì…˜ ì¢…ë£Œ ì‹¤íŒ¨: ${e.message}`);return}l.success("ì„¸ì…˜ ê°•ì œ ì¢…ë£Œ ì™„ë£Œ"),S(!1),$(null),await p()}catch(e){console.error("ê°•ì œ ì¢…ë£Œ ì˜¤ë¥˜:",e),l.error("ê°•ì œ ì¢…ë£Œ ì‹¤íŒ¨")}},ne=async()=>{if(d.size!==0)try{const e=Array.from(d),{error:s}=await m.from("game_launch_sessions").update({status:"force_ended",ended_at:new Date().toISOString()}).in("id",e);if(s){console.error("ì¼ê´„ ì¢…ë£Œ ì˜¤ë¥˜:",s),l.error(`ì¼ê´„ ì¢…ë£Œ ì‹¤íŒ¨: ${s.message}`);return}l.success(`${d.size}ê°œ ì„¸ì…˜ ê°•ì œ ì¢…ë£Œ ì™„ë£Œ`),j(!1),y(new Set),await p()}catch(e){console.error("ì¼ê´„ ê°•ì œ ì¢…ë£Œ ì˜¤ë¥˜:",e),l.error("ì¼ê´„ ê°•ì œ ì¢…ë£Œ ì‹¤íŒ¨")}},oe=e=>{y(s=>{const r=new Set(s);return r.has(e)?r.delete(e):r.add(e),r})},ie=()=>{d.size===c.length?y(new Set):y(new Set(c.map(e=>e.id)))},ce=c.length,le=c.reduce((e,s)=>e+s.current_balance,0),D=c.reduce((e,s)=>e+(s.current_balance-s.balance_before),0);let T=0;if(c.length>0){const e=Date.now(),s=c.reduce((r,n)=>{const o=new Date(n.launched_at).getTime(),g=Math.max(0,e-o);return r+g/1e3/60},0);T=Math.floor(s/c.length)}const de=[{key:"checkbox",header:t.jsx("input",{type:"checkbox",checked:d.size===c.length&&c.length>0,onChange:ie,className:"w-4 h-4 rounded border-slate-600 bg-slate-700 text-purple-500 focus:ring-purple-500 focus:ring-offset-slate-900"}),render:(e,s)=>t.jsx("input",{type:"checkbox",checked:d.has(s.id),onChange:()=>oe(s.id),className:"w-4 h-4 rounded border-slate-600 bg-slate-700 text-purple-500 focus:ring-purple-500 focus:ring-offset-slate-900"})},{key:"username",header:"ì‚¬ìš©ìž",sortable:!0},{key:"nickname",header:"ë‹‰ë„¤ìž„",sortable:!0},{key:"game_name",header:"ê²Œìž„",sortable:!0,render:(e,s)=>t.jsxs("div",{className:"space-y-1",children:[t.jsx("div",{className:"text-slate-200",children:e}),t.jsx(q,{variant:"outline",className:"bg-emerald-500/10 text-emerald-400 border-emerald-500/30",children:s.provider_name})]})},{key:"balance_before",header:"ê²Œìž„ ì‹œìž‘ê¸ˆ",sortable:!0,render:e=>t.jsxs("span",{className:"font-mono text-slate-300",children:["â‚©",e.toLocaleString()]})},{key:"current_balance",header:"ë³€ê²½ ë³´ìœ ê¸ˆ",sortable:!0,render:(e,s)=>{const r=e-s.balance_before,n=r>=0?"text-emerald-400":"text-red-400",o=r>=0?"+":"";return t.jsxs("div",{className:"space-y-1",children:[t.jsxs("div",{className:"font-mono text-slate-200",children:["â‚©",e.toLocaleString()]}),r!==0&&t.jsxs("div",{className:`text-xs font-mono ${n}`,children:[o,"â‚©",r.toLocaleString()]})]})}},{key:"device_type",header:"ì ‘ì†ê²½ë¡œ",render:e=>t.jsxs(q,{variant:e==="Mobile"?"default":"secondary",className:"gap-1",children:[e==="Mobile"?t.jsx(ge,{className:"w-3 h-3"}):t.jsx(_e,{className:"w-3 h-3"}),e]})},{key:"ip_address",header:"IP ì£¼ì†Œ",sortable:!0,render:e=>t.jsx("span",{className:"text-slate-300 font-mono text-xs",children:e})},{key:"launched_at",header:"ì ‘ì† ì‹œê°„",render:e=>t.jsx("span",{className:"text-slate-300",children:se(e)})},{key:"actions",header:"ê´€ë¦¬",render:(e,s)=>t.jsxs("div",{className:"flex items-center gap-2 justify-center",children:[t.jsx(h,{variant:"ghost",size:"sm",onClick:()=>te(s),disabled:O===s.user_id,className:"text-slate-400 hover:text-slate-200",children:t.jsx(W,{className:`w-3 h-3 ${O===s.user_id?"animate-spin":""}`})}),t.jsx(h,{variant:"ghost",size:"sm",onClick:()=>{$(s),S(!0)},className:"bg-red-500/10 text-red-400 hover:bg-red-500/20 hover:text-red-300",children:t.jsx(Y,{className:"w-3 h-3"})})]})}];return t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"text-2xl font-bold text-slate-100",children:"ì˜¨ë¼ì¸ í˜„í™©"}),t.jsx("p",{className:"text-sm text-slate-400 mt-1",children:"ì‹¤ì‹œê°„ ê²Œìž„ ì‚¬ìš©ìž ê´€ë¦¬"})]}),t.jsxs("div",{className:"flex items-center gap-3",children:[d.size>0&&t.jsxs(h,{variant:"destructive",onClick:()=>j(!0),className:"bg-red-500/10 text-red-400 hover:bg-red-500/20 hover:text-red-300 border border-red-500/30",children:[t.jsx(Y,{className:"w-4 h-4 mr-2"}),"ì„ íƒí•œ ê²Œìž„ ì¢…ë£Œ (",d.size,")"]}),t.jsxs(h,{onClick:()=>p(!0),disabled:N||I,children:[t.jsx(W,{className:`w-4 h-4 mr-2 ${I?"animate-spin":""}`}),"ìƒˆë¡œê³ ì¹¨"]})]})]}),t.jsxs("div",{className:"grid gap-5 md:grid-cols-2 lg:grid-cols-4",children:[t.jsx(k,{title:"ì˜¨ë¼ì¸ ì‚¬ìš©ìž",value:`${ce}ëª…`,subtitle:"ì‹¤ì‹œê°„ ì ‘ì†ìž",icon:pe,color:"purple"}),t.jsx(k,{title:"ì´ ê²Œìž„ ë³´ìœ ê¸ˆ",value:`â‚©${le.toLocaleString()}`,subtitle:"ê²Œìž„ ë‚´ ì´ ìž”ê³ ",icon:xe,color:"amber"}),t.jsx(k,{title:"ì´ ì†ìµ",value:`â‚©${D.toLocaleString()}`,subtitle:D>=0?"â†‘ ì‚¬ìš©ìž ì´ìµ":"â†“ ì‚¬ìš©ìž ì†ì‹¤",icon:be,color:D>=0?"green":"red"}),t.jsx(k,{title:"í‰ê·  ì„¸ì…˜",value:`${T}ë¶„`,subtitle:"í‰ê·  ì ‘ì† ì‹œê°„",icon:ve,color:"cyan"})]}),t.jsx(he,{data:c,columns:de,loading:N,emptyMessage:"í˜„ìž¬ ì˜¨ë¼ì¸ ì‚¬ìš©ìžê°€ ì—†ìŠµë‹ˆë‹¤"}),t.jsx(K,{open:X,onOpenChange:S,children:t.jsxs(G,{children:[t.jsxs(V,{children:[t.jsx(F,{children:"ì„¸ì…˜ ê°•ì œ ì¢…ë£Œ"}),t.jsxs(H,{children:[v?.username,"(",v?.nickname,") ë‹˜ì˜ ì„¸ì…˜ì„ ê°•ì œ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"]})]}),t.jsxs(Q,{children:[t.jsx(h,{variant:"outline",onClick:()=>S(!1),children:"ì·¨ì†Œ"}),t.jsx(h,{variant:"destructive",onClick:re,children:"ê°•ì œ ì¢…ë£Œ"})]})]})}),t.jsx(K,{open:ee,onOpenChange:j,children:t.jsxs(G,{children:[t.jsxs(V,{children:[t.jsx(F,{children:"ì„ íƒí•œ ê²Œìž„ ì¼ê´„ ì¢…ë£Œ"}),t.jsxs(H,{children:["ì„ íƒí•œ ",d.size,"ê°œì˜ ê²Œìž„ ì„¸ì…˜ì„ ëª¨ë‘ ê°•ì œ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"]})]}),t.jsxs(Q,{children:[t.jsx(h,{variant:"outline",onClick:()=>j(!1),children:"ì·¨ì†Œ"}),t.jsxs(h,{variant:"destructive",onClick:ne,children:[d.size,"ê°œ ê°•ì œ ì¢…ë£Œ"]})]})]})})]})}export{Oe as OnlineUsers};
