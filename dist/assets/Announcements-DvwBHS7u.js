import{j as e,r as c}from"./react-core-CwM-CeLv.js";import{o as Z,s as x,i as j,L as u,I as h,S as f,p as y,q as k,r as N,t as l,m as ee,B as D}from"./index-XNFiaZD4.js";import{T as te}from"./textarea-jEH6QWba.js";import{D as se}from"./DataTable-CpNEyjEM.js";import{A as ae,f as re,a as le,b as ie,c as ne,d as ce}from"./AdminDialog-UTlf4p9n.js";import{S as de}from"./switch-CFNmvNEw.js";import{k as d}from"./vendor-CQn7sZ7L.js";import{B,P as oe,X as ue,K as xe,m as me,a8 as he,O as pe}from"./lucide-icons-wLPRtdhM.js";import"./radix-ui-SX2QAG6c.js";import"./supabase-r6ABpEO8.js";function Se({user:v}){if(v.level>5)return e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx(B,{className:"h-12 w-12 text-yellow-500 mx-auto"}),e.jsx("p",{className:"text-muted-foreground",children:"공지사항 관리는 총판 이상만 접근 가능합니다."})]})});const[P,A]=c.useState(!0),[F,T]=c.useState(!1),[V,I]=c.useState([]),[b,O]=c.useState("all"),[w,U]=c.useState("all"),[p,z]=c.useState(""),[G,C]=c.useState(!1),[m,q]=c.useState(null),[r,n]=c.useState({title:"",content:"",image_url:"",is_popup:!1,target_audience:"users",target_level:"",status:"active",display_order:0,start_date:"",end_date:""}),[L,S]=c.useState(null),{sendMessage:E}=Z();c.useEffect(()=>{const t=x.channel("announcements-changes").on("postgres_changes",{event:"*",schema:"public",table:"announcements"},s=>{console.log("🔔 공지사항 테이블 변경 감지:",s),_()}).subscribe();return()=>{x.removeChannel(t)}},[]);const M=async t=>{if(!t)return null;const s=t.name.split(".").pop(),o=`announcements/${`${v.id}_${Date.now()}.${s}`}`;try{T(!0);const{data:a,error:g}=await x.storage.from("public").upload(o,t,{cacheControl:"3600",upsert:!1});if(g)throw g;const{data:{publicUrl:Y}}=x.storage.from("public").getPublicUrl(o);return Y}catch(a){return console.error("이미지 업로드 오류:",a),d.error("이미지 업로드에 실패했습니다."),null}finally{T(!1)}},K=async t=>{const s=t.target.files?.[0];if(!s)return;if(s.size>5*1024*1024){d.error("이미지 크기는 5MB 이하여야 합니다.");return}if(!s.type.startsWith("image/")){d.error("이미지 파일만 업로드 가능합니다.");return}const i=await M(s);i&&(S(i),n(o=>({...o,image_url:i})),d.success("이미지가 업로드되었습니다."))},R=()=>{S(null),n(t=>({...t,image_url:""}))},_=async()=>{try{A(!0);let t=x.from("announcements").select(`
          *,
          partners!announcements_partner_id_fkey(username)
        `);v.level>1&&(t=t.eq("partner_id",v.id)),b!=="all"&&(t=t.eq("status",b)),w!=="all"&&(t=t.eq("target_audience",w)),p&&(t=t.or(`title.ilike.%${p}%,content.ilike.%${p}%`));const{data:s,error:i}=await t.order("display_order",{ascending:!1}).order("created_at",{ascending:!1});if(i)throw i;const o=(s||[]).map(a=>({id:a.id,partner_id:a.partner_id,partner_username:a.partners?.username||"알 수 없음",title:a.title,content:a.content,image_url:a.image_url,is_popup:a.is_popup,target_audience:a.target_audience,target_level:a.target_level,status:a.status,display_order:a.display_order,view_count:a.view_count,start_date:a.start_date,end_date:a.end_date,created_at:a.created_at,updated_at:a.updated_at}));I(o)}catch(t){console.error("공지사항 조회 오류:",t),d.error("공지사항을 불러오는데 실패했습니다.")}finally{A(!1)}},W=async()=>{if(!r.title.trim()||!r.content.trim()){d.error("제목과 내용을 입력해주세요.");return}try{const t={...r,partner_id:v.id,target_level:r.target_level?parseInt(r.target_level):null,start_date:r.start_date||new Date().toISOString(),end_date:r.end_date||null};let s;if(m?s=await x.from("announcements").update(t).eq("id",m.id).select():s=await x.from("announcements").insert([t]).select(),s.error)throw s.error;d.success(m?"공지사항이 수정되었습니다.":"공지사항이 등록되었습니다."),!m&&E&&E("new_announcement",{title:r.title,target_audience:r.target_audience,is_popup:r.is_popup}),$(),C(!1),_()}catch(t){console.error("공지사항 저장 오류:",t),d.error("공지사항 저장에 실패했습니다.")}},H=async t=>{if(confirm("정말 삭제하시겠습니까?"))try{const{error:s}=await x.from("announcements").delete().eq("id",t);if(s)throw s;d.success("공지사항이 삭제되었습니다."),_()}catch(s){console.error("공지사항 삭제 오류:",s),d.error("공지사항 삭제에 실패했습니다.")}},J=async(t,s)=>{try{const{error:i}=await x.from("announcements").update({status:s}).eq("id",t);if(i)throw i;I(a=>a.map(g=>g.id===t?{...g,status:s}:g));const o={active:"활성",inactive:"비활성",draft:"임시저장"}[s]||s;d.success(`공지사항 상태가 "${o}"로 변경되었습니다.`)}catch(i){console.error("공지사항 상태 변경 오류:",i),d.error("공지사항 상태 변경에 실패했습니다.")}},$=()=>{n({title:"",content:"",image_url:"",is_popup:!1,target_audience:"users",target_level:"",status:"active",display_order:0,start_date:"",end_date:""}),S(null),q(null)},X=t=>{n({title:t.title,content:t.content,image_url:t.image_url||"",is_popup:t.is_popup,target_audience:t.target_audience,target_level:t.target_level?.toString()||"",status:t.status,display_order:t.display_order,start_date:t.start_date?t.start_date.split("T")[0]:"",end_date:t.end_date?t.end_date.split("T")[0]:""}),S(t.image_url||null),q(t),C(!0)};c.useEffect(()=>{_()},[b,w]),c.useEffect(()=>{const t=setTimeout(()=>{p!==void 0&&_()},300);return()=>clearTimeout(t)},[p]);const Q=[{key:"title",title:"제목",render:(t,s)=>e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t}),e.jsxs("div",{className:"flex gap-1 mt-1",children:[s.is_popup&&e.jsx(D,{variant:"destructive",className:"text-xs",children:"팝업"}),s.target_audience==="partners"&&e.jsx(D,{variant:"secondary",className:"text-xs",children:"관리자"}),s.target_level&&e.jsxs(D,{variant:"outline",className:"text-xs",children:["Level ",s.target_level]})]})]})},{key:"target_audience",title:"대상",render:t=>{const s={all:"전체",users:"사용자",partners:"관리자"};return e.jsx(D,{variant:"outline",children:s[t]||t})}},{key:"status",title:"상태",render:(t,s)=>{const i={active:{label:"활성",color:"bg-green-100 text-green-800"},inactive:{label:"비활성",color:"bg-gray-100 text-gray-800"},draft:{label:"임시저장",color:"bg-yellow-100 text-yellow-800"}},o=i[t]||i.draft;return e.jsxs(f,{value:t,onValueChange:a=>J(s.id,a),children:[e.jsx(y,{className:`w-auto h-7 ${o.color}`,children:e.jsx("span",{children:o.label})}),e.jsxs(N,{children:[e.jsx(l,{value:"active",children:"활성"}),e.jsx(l,{value:"inactive",children:"비활성"}),e.jsx(l,{value:"draft",children:"임시저장"})]})]})}},{key:"view_count",title:"조회수",render:t=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(me,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:t.toLocaleString()})]})},{key:"partner_username",title:"작성자",render:t=>e.jsx("span",{className:"text-sm",children:t})},{key:"created_at",title:"작성일",render:t=>new Date(t).toLocaleDateString("ko-KR")},{key:"actions",title:"관리",render:(t,s)=>e.jsxs("div",{className:"flex gap-1",children:[e.jsx(j,{size:"sm",variant:"outline",onClick:()=>X(s),className:"h-8 px-2",children:e.jsx(he,{className:"h-4 w-4"})}),e.jsx(j,{size:"sm",variant:"outline",onClick:()=>H(s.id),className:"h-8 px-2 text-red-600 hover:text-red-700",children:e.jsx(pe,{className:"h-4 w-4"})})]})}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-100",children:"공지사항"}),e.jsx("p",{className:"text-sm text-slate-400",children:"사용자 및 관리자 대상 공지사항을 작성하고 관리합니다."})]}),e.jsxs(ae,{open:G,onOpenChange:t=>{C(t),t||$()},children:[e.jsx(re,{asChild:!0,children:e.jsxs(j,{className:"btn-premium-primary",children:[e.jsx(oe,{className:"h-4 w-4 mr-2"}),"공지사항 작성"]})}),e.jsxs(le,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsxs(ie,{children:[e.jsx(ne,{children:m?"공지사항 수정":"새 공지사항 작성"}),e.jsx(ce,{children:m?"공지사항 내용을 수정합니다.":"새로운 공지사항을 작성하고 사용자에게 전달합니다."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(u,{htmlFor:"title",children:"제목 *"}),e.jsx(h,{id:"title",value:r.title,onChange:t=>n(s=>({...s,title:t.target.value})),placeholder:"공지사항 제목을 입력하세요"})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"status",children:"상태"}),e.jsxs(f,{value:r.status,onValueChange:t=>n(s=>({...s,status:t})),children:[e.jsx(y,{children:e.jsx(k,{})}),e.jsxs(N,{children:[e.jsx(l,{value:"active",children:"활성"}),e.jsx(l,{value:"inactive",children:"비활성"}),e.jsx(l,{value:"draft",children:"임시저장"})]})]})]})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"content",children:"내용 *"}),e.jsx(te,{id:"content",value:r.content,onChange:t=>n(s=>({...s,content:t.target.value})),placeholder:`공지사항 내용을 입력하세요

• 공지사항 내용을 상세히 작성하세요
• 필요시 이미지를 첨부할 수 있습니다`,rows:10,className:"input-premium"})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"image",children:"이미지 첨부"}),e.jsxs("div",{className:"space-y-2",children:[L?e.jsxs("div",{className:"relative inline-block",children:[e.jsx("img",{src:L,alt:"업로드된 이미지",className:"max-w-sm max-h-48 rounded-lg border border-slate-600"}),e.jsx(j,{type:"button",size:"sm",variant:"destructive",className:"absolute top-2 right-2",onClick:R,children:e.jsx(ue,{className:"h-4 w-4"})})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{id:"image",type:"file",accept:"image/*",onChange:K,disabled:F,className:"input-premium"}),F&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-slate-400",children:[e.jsx("div",{className:"loading-premium w-4 h-4"}),"업로드 중..."]})]}),e.jsx("p",{className:"text-xs text-slate-500",children:"최대 5MB, JPG/PNG/GIF 형식"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(u,{htmlFor:"target_audience",children:"대상"}),e.jsxs(f,{value:r.target_audience,onValueChange:t=>n(s=>({...s,target_audience:t})),children:[e.jsx(y,{children:e.jsx(k,{})}),e.jsxs(N,{children:[e.jsx(l,{value:"all",children:"전체"}),e.jsx(l,{value:"users",children:"사용자"}),e.jsx(l,{value:"partners",children:"관리자"})]})]})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"target_level",children:"대상 레벨 (선택)"}),e.jsx(h,{id:"target_level",type:"number",min:"1",max:"6",value:r.target_level,onChange:t=>n(s=>({...s,target_level:t.target.value})),placeholder:"특정 레벨만 (1-6)"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(u,{htmlFor:"display_order",children:"표시 순서"}),e.jsx(h,{id:"display_order",type:"number",value:r.display_order,onChange:t=>n(s=>({...s,display_order:parseInt(t.target.value)||0}))})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"start_date",children:"시작일"}),e.jsx(h,{id:"start_date",type:"date",value:r.start_date,onChange:t=>n(s=>({...s,start_date:t.target.value}))})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"end_date",children:"종료일 (선택)"}),e.jsx(h,{id:"end_date",type:"date",value:r.end_date,onChange:t=>n(s=>({...s,end_date:t.target.value}))})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(de,{id:"is_popup",checked:r.is_popup,onCheckedChange:t=>n(s=>({...s,is_popup:t}))}),e.jsx(u,{htmlFor:"is_popup",children:"팝업으로 표시"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(j,{variant:"outline",onClick:()=>C(!1),children:"취소"}),e.jsx(j,{onClick:W,disabled:!r.title.trim()||!r.content.trim(),children:m?"수정":"등록"})]})]})]})]})]}),e.jsxs("div",{className:"glass-card rounded-xl p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-6 pb-4 border-b border-slate-700/50",children:e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-semibold text-slate-100 flex items-center gap-2",children:[e.jsx(B,{className:"h-5 w-5 text-blue-400"}),"공지사항 목록"]}),e.jsx("p",{className:"text-sm text-slate-400 mt-1",children:"작성된 공지사항을 관리하고 대상별로 분류할 수 있습니다."})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsx("div",{className:"flex-1 min-w-[200px]",children:e.jsxs("div",{className:"relative",children:[e.jsx(xe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 h-4 w-4"}),e.jsx(h,{placeholder:"제목, 내용으로 검색...",value:p,onChange:t=>z(t.target.value),className:"pl-9 input-premium"})]})}),e.jsxs(f,{value:b,onValueChange:O,children:[e.jsx(y,{className:"w-[120px] bg-slate-800/50 border-slate-600",children:e.jsx(k,{})}),e.jsxs(N,{children:[e.jsx(l,{value:"all",children:"전체 상태"}),e.jsx(l,{value:"active",children:"활성"}),e.jsx(l,{value:"inactive",children:"비활성"}),e.jsx(l,{value:"draft",children:"임시저장"})]})]}),e.jsxs(f,{value:w,onValueChange:U,children:[e.jsx(y,{className:"w-[120px] bg-slate-800/50 border-slate-600",children:e.jsx(k,{})}),e.jsxs(N,{children:[e.jsx(l,{value:"all",children:"전체 대상"}),e.jsx(l,{value:"users",children:"사용자"}),e.jsx(l,{value:"partners",children:"관리자"})]})]})]}),P?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(ee,{})}):e.jsx(se,{data:V,columns:Q,enableSearch:!1})]})]})]})}export{Se as Announcements,Se as default};
