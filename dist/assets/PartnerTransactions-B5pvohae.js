import{r as n,j as t}from"./react-core-CwM-CeLv.js";import{n as z,s as h,S as $,p as E,q as I,r as P,t as l,I as j,B as W}from"./index-Cjgf7-0D.js";import{D as G}from"./DataTable-Cv2AQ19s.js";import{k as J}from"./vendor-CQn7sZ7L.js";import{M as N}from"./MetricCard-BPAAhMVT.js";import{d as Q,r as q,u as X,ab as Z,K as ee}from"./lucide-icons-D2Y5yybo.js";import"./radix-ui-SX2QAG6c.js";import"./supabase-r6ABpEO8.js";function de(){const{authState:m}=z(),[v,p]=n.useState([]),[A,S]=n.useState(!0),[b,w]=n.useState({todayDeposits:0,todayWithdrawals:0,netTransfer:0}),[g,B]=n.useState("latest"),[u,F]=n.useState(""),[x,O]=n.useState(""),[_,V]=n.useState("all"),[f,K]=n.useState(""),T=async()=>{try{if(S(!0),!m.isAuthenticated||!m.user){p([]);return}let e=h.from("partner_balance_logs").select("*").not("from_partner_id","is",null).not("to_partner_id","is",null).in("transaction_type",["deposit","withdrawal"]);if(m.user.level!==1){const a=m.user.id;e=e.or(`from_partner_id.eq.${a},to_partner_id.eq.${a}`)}u&&(e=e.gte("created_at",`${u}T00:00:00`)),x&&(e=e.lte("created_at",`${x}T23:59:59`));const{data:r,error:s}=await e.order("created_at",{ascending:g==="oldest"}).limit(1e3);if(s)throw console.error("partner_balance_logs 조회 오류:",s),s;if(!r||r.length===0){p([]),w({todayDeposits:0,todayWithdrawals:0,netTransfer:0});return}const o=new Set;r.forEach(a=>{a.from_partner_id&&o.add(a.from_partner_id),a.to_partner_id&&o.add(a.to_partner_id)});const{data:i,error:c}=await h.from("partners").select("id, username, nickname, partner_type").in("id",Array.from(o));c&&console.error("partners 조회 오류:",c);const d=new Map((i||[]).map(a=>[a.id,a])),k=r.map(a=>({id:a.id,partner_id:a.partner_id,transaction_type:a.transaction_type||"",amount:a.amount||0,balance_before:a.balance_before||0,balance_after:a.balance_after||0,from_partner_id:a.from_partner_id||null,to_partner_id:a.to_partner_id||null,processed_by:a.processed_by||null,memo:a.memo||null,created_at:a.created_at,from_partner:a.from_partner_id?d.get(a.from_partner_id):void 0,to_partner:a.to_partner_id?d.get(a.to_partner_id):void 0}));p(k);const Y=new Date().toISOString().split("T")[0],C=k.filter(a=>a.created_at.startsWith(Y)),M=C.filter(a=>a.transaction_type==="deposit").reduce((a,y)=>a+Math.abs(Number(y.amount)),0),L=C.filter(a=>a.transaction_type==="withdrawal").reduce((a,y)=>a+Math.abs(Number(y.amount)),0);w({todayDeposits:M,todayWithdrawals:L,netTransfer:M-L})}catch(e){console.error("파트너 거래 내역 조회 오류:",e),J.error("거래 내역을 불러오는데 실패했습니다."),p([])}finally{S(!1)}};n.useEffect(()=>{T()},[g,u,x]),n.useEffect(()=>{const e=h.channel("partner_balance_logs_changes").on("postgres_changes",{event:"*",schema:"public",table:"partner_balance_logs"},()=>{console.log("파트너 보유금 변경 감지 - 목록 새로고침"),T()}).subscribe();return()=>{h.removeChannel(e)}},[]);const H=e=>{const s={deposit:{text:"입금",className:"px-3 py-1 bg-gradient-to-r from-emerald-500/20 to-teal-500/20 text-emerald-400 border border-emerald-500/50 rounded-full shadow-[0_0_10px_rgba(16,185,129,0.5)]"},withdrawal:{text:"출금",className:"px-3 py-1 bg-gradient-to-r from-rose-500/20 to-red-500/20 text-rose-400 border border-rose-500/50 rounded-full shadow-[0_0_10px_rgba(244,63,94,0.5)]"},admin_adjustment:{text:"관리자조정",className:"px-3 py-1 bg-gradient-to-r from-amber-500/20 to-orange-500/20 text-amber-400 border border-amber-500/50 rounded-full shadow-[0_0_10px_rgba(251,146,60,0.5)]"},commission:{text:"수수료",className:"px-3 py-1 bg-gradient-to-r from-blue-500/20 to-cyan-500/20 text-blue-400 border border-blue-500/50 rounded-full shadow-[0_0_10px_rgba(59,130,246,0.5)]"},refund:{text:"환불",className:"px-3 py-1 bg-gradient-to-r from-purple-500/20 to-violet-500/20 text-purple-400 border border-purple-500/50 rounded-full shadow-[0_0_10px_rgba(168,85,247,0.5)]"}}[e]||{text:e,className:"px-3 py-1 bg-slate-500/20 text-slate-400 border border-slate-500/50 rounded-full"};return t.jsx(W,{className:s.className,children:s.text})},D=e=>{const s={system_admin:{text:"시스템관리자",className:"bg-purple-500/20 text-purple-400 border-purple-500/50"},head_office:{text:"대본사",className:"bg-red-500/20 text-red-400 border-red-500/50"},main_office:{text:"본사",className:"bg-orange-500/20 text-orange-400 border-orange-500/50"},sub_office:{text:"부본사",className:"bg-yellow-500/20 text-yellow-400 border-yellow-500/50"},distributor:{text:"총판",className:"bg-blue-500/20 text-blue-400 border-blue-500/50"},store:{text:"매장",className:"bg-green-500/20 text-green-400 border-green-500/50"}}[e]||{text:e,className:"bg-slate-500/20 text-slate-400 border-slate-500/50"};return t.jsx(W,{className:`${s.className} border text-xs`,children:s.text})},R=[{key:"created_at",header:"일시",cell:e=>{const r=new Date(e.created_at),s=r.getFullYear(),o=r.getMonth()+1,i=r.getDate(),c=r.getHours().toString().padStart(2,"0"),d=r.getMinutes().toString().padStart(2,"0");return t.jsxs("div",{className:"text-slate-400 text-sm whitespace-nowrap",children:[s,". ",o.toString().padStart(2,"0"),". ",i.toString().padStart(2,"0"),". ",c,":",d]})}},{key:"transaction_type",header:"거래구분",cell:e=>H(e.transaction_type)},{key:"from_partner",header:"보낸이",cell:e=>e.from_partner?t.jsxs("div",{className:"flex flex-col gap-1",children:[t.jsx("div",{className:"text-sm text-slate-200",children:e.from_partner.nickname||e.from_partner.username}),e.from_partner.partner_type&&D(e.from_partner.partner_type)]}):t.jsx("span",{className:"text-slate-600",children:"-"})},{key:"arrow",header:"",cell:()=>t.jsx("span",{className:"text-slate-500 text-lg",children:"→"})},{key:"to_partner",header:"받는이",cell:e=>e.to_partner?t.jsxs("div",{className:"flex flex-col gap-1",children:[t.jsx("div",{className:"text-sm text-slate-200",children:e.to_partner.nickname||e.to_partner.username}),e.to_partner.partner_type&&D(e.to_partner.partner_type)]}):t.jsx("span",{className:"text-slate-600",children:"-"})},{key:"amount",header:"금액",cell:e=>{const r=e.transaction_type==="deposit";return t.jsxs("div",{className:`font-mono ${r?"text-emerald-400":"text-rose-400"}`,children:[r?"+":"",Math.abs(e.amount).toLocaleString(),"원"]})}},{key:"balance_before",header:"이전잔고",cell:e=>t.jsxs("div",{className:"font-mono text-slate-400",children:[e.balance_before.toLocaleString(),"원"]})},{key:"balance_after",header:"잔고",cell:e=>t.jsxs("div",{className:"font-mono text-cyan-400",children:[e.balance_after.toLocaleString(),"원"]})},{key:"memo",header:"메모",cell:e=>t.jsx("div",{className:"max-w-[250px] text-sm text-slate-400 truncate",title:e.memo||"",children:e.memo||"-"})}],U=n.useMemo(()=>{let e=v;if(_!=="all"&&(e=e.filter(r=>r.transaction_type===_)),f){const r=f.toLowerCase();e=e.filter(s=>{const o=s.from_partner?.nickname||s.from_partner?.username||"",i=s.to_partner?.nickname||s.to_partner?.username||"",c=s.memo||"",d=s.amount.toString();return o.toLowerCase().includes(r)||i.toLowerCase().includes(r)||c.toLowerCase().includes(r)||d.includes(r)})}return e},[v,f,_]);return t.jsxs("div",{className:"space-y-6",children:[t.jsx("div",{className:"flex items-center justify-between",children:t.jsxs("div",{className:"space-y-1",children:[t.jsxs("h1",{className:"text-2xl font-bold text-slate-100 flex items-center gap-2",children:[t.jsx(Q,{className:"h-6 w-6 text-cyan-400"}),"파트너 입출금 내역"]}),t.jsx("p",{className:"text-muted-foreground",children:"자기자신과 하위 조직 간의 입출금 내역을 확인합니다."})]})}),t.jsxs("div",{className:"grid gap-5 md:grid-cols-3",children:[t.jsx(N,{title:"오늘 입금",value:`${b.todayDeposits.toLocaleString()}원`,subtitle:"입금 총액",icon:q,color:"green"}),t.jsx(N,{title:"오늘 출금",value:`${b.todayWithdrawals.toLocaleString()}원`,subtitle:"출금 총액",icon:q,color:"red"}),t.jsx(N,{title:"순 입출금",value:`${b.netTransfer.toLocaleString()}원`,subtitle:"입금 - 출금",icon:X,color:"cyan"})]}),t.jsxs("div",{className:"glass-card rounded-xl p-6",children:[t.jsx("div",{className:"flex items-center justify-between mb-6 pb-4 border-b border-slate-700/50",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Z,{className:"h-5 w-5 text-slate-400"}),t.jsx("h3",{className:"font-semibold text-slate-100",children:"파트너 입출금 내역"})]})}),t.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[t.jsxs($,{value:g,onValueChange:B,children:[t.jsx(E,{className:"w-[140px] input-premium",children:t.jsx(I,{placeholder:"기간"})}),t.jsxs(P,{className:"bg-slate-800 border-slate-700",children:[t.jsx(l,{value:"latest",children:"최신순"}),t.jsx(l,{value:"oldest",children:"오래된순"})]})]}),t.jsx(j,{type:"date",value:u,onChange:e=>F(e.target.value),className:"w-[160px] input-premium",placeholder:"시작일"}),t.jsx("span",{className:"text-slate-500",children:"-"}),t.jsx(j,{type:"date",value:x,onChange:e=>O(e.target.value),className:"w-[160px] input-premium",placeholder:"종료일"}),t.jsxs($,{value:_,onValueChange:V,children:[t.jsx(E,{className:"w-[140px] input-premium",children:t.jsx(I,{placeholder:"구분"})}),t.jsxs(P,{className:"bg-slate-800 border-slate-700",children:[t.jsx(l,{value:"all",children:"전체"}),t.jsx(l,{value:"deposit",children:"입금"}),t.jsx(l,{value:"withdrawal",children:"출금"}),t.jsx(l,{value:"admin_adjustment",children:"관리자조정"}),t.jsx(l,{value:"commission",children:"수수료"}),t.jsx(l,{value:"refund",children:"환불"})]})]}),t.jsxs("div",{className:"flex-1 relative",children:[t.jsx(ee,{className:"absolute left-3 top-2.5 h-4 w-4 text-slate-400"}),t.jsx(j,{placeholder:"파트너 검색...",className:"pl-10 input-premium",value:f,onChange:e=>K(e.target.value)})]})]}),t.jsx(G,{columns:R,data:U,searchable:!1,loading:A,emptyMessage:"데이터가 없습니다.",rowKey:"id"})]})]})}export{de as PartnerTransactions};
