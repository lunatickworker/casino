import{r as c,j as t}from"./react-core-CwM-CeLv.js";import{s as x,I as F,B as _}from"./index-Cjgf7-0D.js";import{D as K}from"./DataTable-Cv2AQ19s.js";import{M as j}from"./MetricCard-BPAAhMVT.js";import{K as W,a4 as Q,d as A,U as O,W as V}from"./lucide-icons-D2Y5yybo.js";import"./vendor-CQn7sZ7L.js";import"./radix-ui-SX2QAG6c.js";import"./supabase-r6ABpEO8.js";function te({user:o}){const[h,w]=c.useState([]),[S,b]=c.useState([]),[p,D]=c.useState(""),[T,C]=c.useState({totalUsers:0,totalUserBalance:0}),[$,v]=c.useState(!0),d=c.useRef(null),[y,L]=c.useState([]),B=async e=>{const s=[],r=[e];for(;r.length>0;){const n=r.shift(),{data:i,error:m}=await x.from("partners").select("id").eq("parent_id",n);if(!m&&i)for(const f of i)s.push(f.id),r.push(f.id)}return s},P=async(e=!1)=>{try{e&&v(!0);let s=[];o.level!==1&&(s=await B(o.id));let r=x.from("partners").select(`
          id,
          username,
          nickname,
          level,
          partner_type,
          balance,
          last_login_at,
          status,
          parent_id
        `).order("last_login_at",{ascending:!1,nullsFirst:!1});if(o.level!==1&&s.length>0)r=r.in("id",s);else if(o.level!==1&&s.length===0){w([]),L([]),e&&v(!1);return}const{data:n,error:i}=await r;if(i)throw i;const m=[...new Set((n||[]).map(a=>a.parent_id).filter(Boolean))];let f={};if(m.length>0){const{data:a}=await x.from("partners").select("id, nickname").in("id",m);a&&(f=a.reduce((u,l)=>(u[l.id]=l.nickname,u),{}))}const g={};if(n&&n.length>0){const a=n.map(l=>l.id),{data:u}=await x.from("users").select("referrer_id, balance").in("referrer_id",a);u&&u.forEach(l=>{g[l.referrer_id]||(g[l.referrer_id]={count:0,balance:0}),g[l.referrer_id].count+=1,g[l.referrer_id].balance+=l.balance||0})}const N=(n||[]).map(a=>{const u=g[a.id]||{count:0,balance:0};return{id:a.id,username:a.username,nickname:a.nickname,level:a.level,partner_type:a.partner_type,balance:a.balance||0,last_login_at:a.last_login_at,status:a.status,parent_nickname:a.parent_id&&f[a.parent_id]||"-",user_count:u.count,users_balance:u.balance}});w(N),b(N);const M=o.level===1?N.map(a=>a.id):[o.id,...s];L(M),await U(M)}catch(s){console.error("íŒŒíŠ¸ë„ˆ ì ‘ì† í˜„í™© ë¡œë“œ ì˜¤ë¥˜:",s)}finally{e&&v(!1)}},U=async e=>{try{if(e.length===0){C({totalUsers:0,totalUserBalance:0});return}const{data:s,error:r}=await x.from("users").select("id, balance").in("referrer_id",e);if(r)throw r;const n=s?.length||0,i=s?.reduce((m,f)=>m+(f.balance||0),0)||0;C({totalUsers:n,totalUserBalance:i})}catch(s){console.error("ì‚¬ìš©ì í†µê³„ ë¡œë“œ ì˜¤ë¥˜:",s)}};c.useEffect(()=>{if(!p.trim()){b(h);return}const e=p.toLowerCase(),s=h.filter(r=>r.username.toLowerCase().includes(e)||r.nickname.toLowerCase().includes(e)||r.parent_nickname.toLowerCase().includes(e)||k(r.partner_type).toLowerCase().includes(e));b(s)},[p,h]),c.useEffect(()=>{P(!0)},[o.id]),c.useEffect(()=>{console.log("ğŸ”” Realtime êµ¬ë… ì‹œì‘: partners, users");const e=x.channel("partner-connections-realtime").on("postgres_changes",{event:"*",schema:"public",table:"partners"},s=>{console.log("ğŸ”” partners ë³€ê²½ ê°ì§€:",s),d.current&&clearTimeout(d.current),d.current=setTimeout(()=>{P()},500)}).on("postgres_changes",{event:"*",schema:"public",table:"users"},s=>{console.log("ğŸ”” users ë³€ê²½ ê°ì§€:",s),y.length>0&&(d.current&&clearTimeout(d.current),d.current=setTimeout(()=>{U(y)},500))}).subscribe();return()=>{x.removeChannel(e),d.current&&clearTimeout(d.current)}},[o.id,y]);const k=e=>({system_admin:"ì‹œìŠ¤í…œê´€ë¦¬ì",head_office:"ëŒ€ë³¸ì‚¬",main_office:"ë³¸ì‚¬",sub_office:"ë¶€ë³¸ì‚¬",distributor:"ì´íŒ",store:"ë§¤ì¥"})[e]||e,I=e=>{if(!e)return"-";const s=new Date(e).getTime(),r=Date.now(),n=Math.floor((r-s)/1e3/60);if(n<60)return`${n}ë¶„`;const i=Math.floor(n/60),m=n%60;return`${i}ì‹œê°„ ${m}ë¶„`},E=h.filter(e=>e.last_login_at?Math.floor((Date.now()-new Date(e.last_login_at).getTime())/1e3/60)<=30&&e.status==="active":!1),R=h.reduce((e,s)=>e+s.balance,0),q=[{header:"íŒŒíŠ¸ë„ˆ ì •ë³´",cell:e=>t.jsxs("div",{className:"flex flex-col gap-2 py-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"font-medium",children:e.username}),t.jsx(_,{variant:"outline",className:"text-xs px-2 py-0.5",children:e.nickname})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs(_,{variant:"secondary",className:"text-xs px-2 py-0.5",children:["LV.",e.level]}),t.jsx("span",{className:"text-xs text-muted-foreground",children:k(e.partner_type)})]}),t.jsxs("span",{className:"text-xs text-muted-foreground",children:["ìƒìœ„: ",e.parent_nickname]})]})},{header:"íŒŒíŠ¸ë„ˆ ë³´ìœ ê¸ˆ",cell:e=>t.jsx("div",{className:"flex flex-col gap-1 py-2",children:t.jsxs("span",{className:`font-medium ${e.balance<0?"text-red-400":"text-emerald-400"}`,children:["â‚©",e.balance.toLocaleString()]})})},{header:"ì‚¬ìš©ì ìˆ˜",cell:e=>t.jsx("div",{className:"flex flex-col gap-1 py-2",children:t.jsxs("span",{className:"font-medium text-cyan-400",children:[e.user_count.toLocaleString(),"ëª…"]})})},{header:"ì‚¬ìš©ì ë³´ìœ ê¸ˆ í•©ê³„",cell:e=>t.jsx("div",{className:"flex flex-col gap-1 py-2",children:t.jsxs("span",{className:`font-medium ${e.users_balance<0?"text-red-400":"text-blue-400"}`,children:["â‚©",e.users_balance.toLocaleString()]})})},{header:"ì ‘ì† ìƒíƒœ",cell:e=>{const s=e.last_login_at&&(Date.now()-new Date(e.last_login_at).getTime())/1e3/60<=30&&e.status==="active";return t.jsxs("div",{className:"flex flex-col gap-2 py-2",children:[t.jsx(_,{variant:s?"default":"outline",className:s?"bg-emerald-500/20 text-emerald-400 border-emerald-500/50":"",children:s?"ğŸŸ¢ ì˜¨ë¼ì¸":"âš« ì˜¤í”„ë¼ì¸"}),e.status==="suspended"&&t.jsx(_,{variant:"destructive",className:"text-xs",children:"ì •ì§€ë¨"})]})}},{header:"ìµœê·¼ ì ‘ì† ì¼ì‹œ",cell:e=>t.jsxs("div",{className:"flex flex-col gap-1 py-2",children:[t.jsx("span",{className:"text-sm",children:e.last_login_at?new Date(e.last_login_at).toLocaleString("ko-KR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).replace(/\. /g,".").replace(/\.$/,""):"-"}),e.last_login_at&&t.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",I(e.last_login_at)," ê²½ê³¼)"]})]})}];return t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex flex-col gap-4",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"text-3xl",children:"íŒŒíŠ¸ë„ˆ ì ‘ì†í˜„í™©"}),t.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"í•˜ìœ„ íŒŒíŠ¸ë„ˆë“¤ì˜ ì‹¤ì‹œê°„ ì ‘ì† í˜„í™©, ë³´ìœ ê¸ˆ ë° ì‚¬ìš©ì ê´€ë¦¬ ì •ë³´"})]}),t.jsxs("div",{className:"relative max-w-md",children:[t.jsx(W,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),t.jsx(F,{placeholder:"íŒŒíŠ¸ë„ˆëª…, ë‹‰ë„¤ì„, ìƒìœ„ íŒŒíŠ¸ë„ˆ, ë“±ê¸‰ìœ¼ë¡œ ê²€ìƒ‰...",value:p,onChange:e=>D(e.target.value),className:"pl-9 bg-card/50 border-border/50"})]})]}),t.jsxs("div",{className:"grid gap-5 md:grid-cols-2 lg:grid-cols-4",children:[t.jsx(j,{title:"ì˜¨ë¼ì¸ íŒŒíŠ¸ë„ˆ",value:`${E.length}ëª…`,subtitle:"ìµœê·¼ 30ë¶„ ì´ë‚´ ì ‘ì† ì¤‘",icon:Q,color:"purple"}),t.jsx(j,{title:"íŒŒíŠ¸ë„ˆ ë³´ìœ ê¸ˆ í•©ê³„",value:`â‚©${R.toLocaleString()}`,subtitle:"ì „ì²´ í•˜ìœ„ íŒŒíŠ¸ë„ˆ ë³´ìœ ê¸ˆ",icon:A,color:"pink"}),t.jsx(j,{title:"ê´€ë¦¬ ì‚¬ìš©ì ìˆ˜",value:`${T.totalUsers.toLocaleString()}ëª…`,subtitle:"ì „ì²´ í•˜ìœ„ ì‚¬ìš©ì ìˆ˜",icon:O,color:"cyan"}),t.jsx(j,{title:"ì‚¬ìš©ì ë³´ìœ ê¸ˆ í•©ê³„",value:`â‚©${T.totalUserBalance.toLocaleString()}`,subtitle:"ì „ì²´ ì‚¬ìš©ì ë³´ìœ ê¸ˆ",icon:V,color:"amber"})]}),$?t.jsx("div",{className:"flex items-center justify-center py-16",children:t.jsxs("div",{className:"text-center space-y-3",children:[t.jsx("div",{className:"w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto"}),t.jsx("p",{className:"text-sm text-muted-foreground",children:"ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."})]})}):t.jsxs("div",{className:"space-y-3",children:[t.jsx("div",{className:"flex items-center justify-between px-1",children:t.jsxs("p",{className:"text-sm text-muted-foreground",children:["ì´ ",t.jsx("span",{className:"text-primary font-medium",children:S.length}),"ê°œì˜ íŒŒíŠ¸ë„ˆ",p&&` (ì „ì²´ ${h.length}ê°œ ì¤‘ ê²€ìƒ‰ë¨)`]})}),t.jsx(K,{data:S,columns:q,emptyMessage:p?"ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤":"ì¡°íšŒëœ íŒŒíŠ¸ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤",rowKey:"id"})]})]})}export{te as PartnerConnectionStatus};
