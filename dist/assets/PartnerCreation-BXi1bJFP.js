import{r as p,j as e}from"./react-core-CwM-CeLv.js";import{s as u,i as h,C as I,a as S,b as O,d as A,e as F,L as n,I as d,S as D,p as T,q as $,r as E,t as q,G as Y,v as Z,B as K}from"./index-Cn1S8-JW.js";import{T as ee}from"./textarea-DcWc96jr.js";import{D as ae}from"./DataTable-CjdfiZ7Q.js";import{k as o}from"./vendor-CQn7sZ7L.js";import{R,a9 as se,E as re,m as te,a6 as le,D as ne,f as ce,S as ie,aa as oe,U as de,O as me,a8 as pe}from"./lucide-icons-wLPRtdhM.js";import"./radix-ui-SX2QAG6c.js";import"./supabase-r6ABpEO8.js";function ye({user:m}){const[L,U]=p.useState([]),[y,z]=p.useState([]),[B,k]=p.useState(!1),[w,v]=p.useState(!1),[j,H]=p.useState(!1),[N,b]=p.useState({}),[s,g]=p.useState({username:"",nickname:"",password:"",partner_type:"head_office",parent_id:m.id,level:2,opcode:"",secret_key:"",api_token:"",commission_rolling:.5,commission_losing:5,withdrawal_fee:1,bank_name:"",bank_account:"",bank_holder:"",contact_info:""}),C=[{value:"head_office",label:"ëŒ€ë³¸ì‚¬",level:2},{value:"main_office",label:"ë³¸ì‚¬",level:3},{value:"sub_office",label:"ë¶€ë³¸ì‚¬",level:4},{value:"distributor",label:"ì´íŒ",level:5},{value:"store",label:"ë§¤ì¥",level:6}];p.useEffect(()=>{f(),m.partner_type==="system_admin"&&V()},[]);const f=async()=>{k(!0);try{let a=u.from("partners").select("*").order("created_at",{ascending:!1});m.level>1&&(a=a.or(`parent_id.eq.${m.id},id.eq.${m.id}`));const{data:r,error:i}=await a;if(i)throw i;U(r||[])}catch(a){console.error("íŒŒíŠ¸ë„ˆ ë¡œë“œ ì‹¤íŒ¨:",a),o.error("íŒŒíŠ¸ë„ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}finally{k(!1)}},V=async()=>{try{const{data:a,error:r}=await u.from("partners").select("id, username, nickname, opcode, secret_key, api_token").eq("partner_type","head_office").eq("status","active").not("opcode","is",null).not("secret_key","is",null).not("api_token","is",null).order("created_at",{ascending:!0});if(r)throw r;z(a||[])}catch(a){console.error("ëŒ€ë³¸ì‚¬ ë¡œë“œ ì‹¤íŒ¨:",a)}},c=(a,r)=>{if(g(i=>({...i,[a]:r})),a==="partner_type"){const i=C.find(t=>t.value===r);i&&g(t=>({...t,level:i.level}))}},P=async(a,r)=>{const i=`${a}_${r}`;b(t=>({...t,[i]:!0}));try{const t=await Y.getInfo(a,r);return t.data&&!t.error?(o.success("API ì—°ê²° í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤."),!0):(o.error(`API ì—°ê²° ì‹¤íŒ¨: ${t.error||"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}`),!1)}catch(t){return console.error("API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:",t),o.error(`API ì—°ê²° ì‹¤íŒ¨: ${t.message}`),!1}finally{b(t=>({...t,[i]:!1}))}},M=()=>s.username.trim()?s.nickname.trim()?!s.password.trim()||s.password.length<6?(o.error("ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”."),!1):s.partner_type==="head_office"&&(!s.opcode.trim()||!s.secret_key.trim())?(o.error("ëŒ€ë³¸ì‚¬ëŠ” OPCODEì™€ Secret Keyê°€ í•„ìˆ˜ì…ë‹ˆë‹¤."),!1):!0:(o.error("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."),!1):(o.error("ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."),!1),G=async a=>{let r=a,i=0;const t=10;for(;r&&i<t;){const{data:l,error:_}=await u.from("partners").select("id, partner_type, opcode, secret_key, api_token, parent_id").eq("id",r).single();if(_||!l)break;if(l.partner_type==="head_office"&&l.opcode&&l.secret_key&&l.api_token)return{opcode:l.opcode,secretKey:l.secret_key,token:l.api_token};r=l.parent_id,i++}return null},J=async()=>{if(M()){v(!0);try{if(s.partner_type==="head_office"&&!await P(s.opcode,s.secret_key)){v(!1);return}let a=s.parent_id;m.partner_type==="system_admin"&&s.selected_head_office_id&&(a=s.selected_head_office_id);const r={username:s.username,nickname:s.nickname,password:s.password,partner_type:s.partner_type,parent_id:a,level:s.level,opcode:s.partner_type==="head_office"?s.opcode:null,secret_key:s.partner_type==="head_office"?s.secret_key:null,api_token:s.partner_type==="head_office"?s.api_token:null,commission_rolling:s.commission_rolling,commission_losing:s.commission_losing,withdrawal_fee:s.withdrawal_fee,bank_name:s.bank_name,bank_account:s.bank_account,bank_holder:s.bank_holder,contact_info:s.contact_info?JSON.parse(`{"memo": "${s.contact_info}"}`):null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{data:i,error:t}=await u.from("partners").insert([r]).select().single();if(t)throw t;let l=null;if(s.partner_type==="head_office"&&s.opcode&&s.secret_key?(l={opcode:s.opcode,secretKey:s.secret_key,token:s.api_token||""},console.log("ğŸ¢ ëŒ€ë³¸ì‚¬ ìƒì„± - formDataì˜ opcode ì‚¬ìš©:",l.opcode)):(l=await G(a),console.log("ğŸ‘¥ í•˜ìœ„ íŒŒíŠ¸ë„ˆ ìƒì„± - ìƒìœ„ opcode ì¡°íšŒ ê²°ê³¼:",l?l.opcode:"null")),l){const _=s.username.replace(/^btn_/,"");console.log("ğŸ“¡ ì™¸ë¶€ API ê³„ì • ìƒì„± ì‹œì‘:",{opcode:l.opcode,username:_,originalUsername:s.username});const x=await Z(l.opcode,_,l.secretKey);x.error?(console.warn("âŒ ì™¸ë¶€ API ê³„ì • ìƒì„± ì‹¤íŒ¨:",x.error),o.warning(`íŒŒíŠ¸ë„ˆëŠ” ìƒì„±ë˜ì—ˆìœ¼ë‚˜ ì™¸ë¶€ API ì—°ë™ ì‹¤íŒ¨: ${x.error}`)):(console.log("âœ… ì™¸ë¶€ API ê³„ì • ìƒì„± ì„±ê³µ:",x.data),o.success("íŒŒíŠ¸ë„ˆì™€ ì™¸ë¶€ API ê³„ì •ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."))}else console.warn("âš ï¸ ìƒìœ„ OPCODEë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ì™¸ë¶€ API ê³„ì • ìƒì„±ì„ ê±´ë„ˆëœë‹ˆë‹¤."),o.success("íŒŒíŠ¸ë„ˆê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. (ì™¸ë¶€ API ì—°ë™ ì—†ìŒ)");g({username:"",nickname:"",password:"",partner_type:"head_office",parent_id:m.id,level:2,opcode:"",secret_key:"",api_token:"",commission_rolling:.5,commission_losing:5,withdrawal_fee:1,bank_name:"",bank_account:"",bank_holder:"",contact_info:"",selected_head_office_id:void 0}),await f()}catch(a){console.error("íŒŒíŠ¸ë„ˆ ìƒì„± ì‹¤íŒ¨:",a),o.error(`íŒŒíŠ¸ë„ˆ ìƒì„± ì‹¤íŒ¨: ${a.message}`)}finally{v(!1)}}},Q=async a=>{if(confirm("ì •ë§ë¡œ ì´ íŒŒíŠ¸ë„ˆë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"))try{const{error:r}=await u.from("partners").delete().eq("id",a);if(r)throw r;o.success("íŒŒíŠ¸ë„ˆê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."),await f()}catch(r){console.error("íŒŒíŠ¸ë„ˆ ì‚­ì œ ì‹¤íŒ¨:",r),o.error(`íŒŒíŠ¸ë„ˆ ì‚­ì œ ì‹¤íŒ¨: ${r.message}`)}},W=a=>({1:"ì‹œìŠ¤í…œê´€ë¦¬ì",2:"ëŒ€ë³¸ì‚¬",3:"ë³¸ì‚¬",4:"ë¶€ë³¸ì‚¬",5:"ì´íŒ",6:"ë§¤ì¥"})[a]||"ì•Œ ìˆ˜ ì—†ìŒ",X=[{key:"username",title:"ì•„ì´ë””",sortable:!0},{key:"nickname",title:"ë‹‰ë„¤ì„",sortable:!0},{key:"level",title:"ë“±ê¸‰",cell:a=>e.jsx(K,{variant:a.level===2?"default":"secondary",children:W(a.level)})},{key:"opcode",title:"OPCODE",cell:a=>e.jsx("div",{className:"font-mono text-sm",children:a.opcode||"-"})},{key:"status",title:"ìƒíƒœ",cell:a=>e.jsx(K,{variant:a.status==="active"?"default":"secondary",children:a.status==="active"?"í™œì„±":"ë¹„í™œì„±"})},{key:"balance",title:"ë³´ìœ ê¸ˆ",cell:a=>e.jsxs("div",{className:"text-right font-mono",children:[new Intl.NumberFormat("ko-KR").format(a.balance||0),"ì›"]})},{key:"created_at",title:"ìƒì„±ì¼",cell:a=>e.jsx("div",{className:"text-sm text-muted-foreground",children:new Date(a.created_at).toLocaleDateString("ko-KR")})},{key:"actions",title:"ê´€ë¦¬",cell:a=>e.jsxs("div",{className:"flex gap-1",children:[e.jsx(h,{size:"sm",variant:"outline",onClick:()=>Q(a.id),className:"h-8 w-8 p-0 text-red-600 hover:text-red-700",disabled:a.id===m.id,children:e.jsx(me,{className:"h-4 w-4"})}),e.jsx(h,{size:"sm",variant:"outline",className:"h-8 w-8 p-0",children:e.jsx(pe,{className:"h-4 w-4"})})]})}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-100",children:"ëŒ€ë³¸ì‚¬ ìƒì„±"}),e.jsx("p",{className:"text-sm text-slate-400",children:"ìƒˆë¡œìš´ íŒŒíŠ¸ë„ˆë¥¼ ìƒì„±í•˜ê³  OPCODEë¥¼ ì„¤ì •í•˜ì—¬ ì™¸ë¶€ APIì™€ ì—°ë™í•©ë‹ˆë‹¤."})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(h,{onClick:f,variant:"outline",size:"sm",children:[e.jsx(R,{className:"h-4 w-4 mr-2"}),"ìƒˆë¡œê³ ì¹¨"]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(I,{children:[e.jsxs(S,{children:[e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-5 w-5"}),"ìƒˆ íŒŒíŠ¸ë„ˆ ìƒì„±"]}),e.jsx(A,{children:"íŒŒíŠ¸ë„ˆ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ê¶Œí•œì„ ì„¤ì •í•©ë‹ˆë‹¤."})]}),e.jsxs(F,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"username",children:"ì•„ì´ë””"}),e.jsx(d,{id:"username",value:s.username,onChange:a=>c("username",a.target.value),placeholder:"íŒŒíŠ¸ë„ˆ ì•„ì´ë””"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"nickname",children:"ë‹‰ë„¤ì„"}),e.jsx(d,{id:"nickname",value:s.nickname,onChange:a=>c("nickname",a.target.value),placeholder:"í‘œì‹œë  ë‹‰ë„¤ì„"})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(n,{htmlFor:"password",children:"ë¹„ë°€ë²ˆí˜¸"}),e.jsxs("div",{className:"relative",children:[e.jsx(d,{id:"password",type:j?"text":"password",value:s.password,onChange:a=>c("password",a.target.value),placeholder:"ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>H(!j),children:j?e.jsx(re,{className:"h-4 w-4"}):e.jsx(te,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"partner_type",children:"íŒŒíŠ¸ë„ˆ ë“±ê¸‰"}),e.jsxs(D,{value:s.partner_type,onValueChange:a=>c("partner_type",a),children:[e.jsx(T,{children:e.jsx($,{placeholder:"ë“±ê¸‰ ì„ íƒ"})}),e.jsx(E,{children:C.filter(a=>m.level===1?!0:a.level>m.level).map(a=>e.jsxs(q,{value:a.value,children:[a.label," (Level ",a.level,")"]},a.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"ë ˆë²¨"}),e.jsx(d,{value:`Level ${s.level}`,readOnly:!0,className:"bg-muted"})]})]}),m.partner_type==="system_admin"&&s.partner_type!=="head_office"&&y.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"selected_head_office",children:"ì†Œì† ëŒ€ë³¸ì‚¬ ì„ íƒ"}),e.jsxs(D,{value:s.selected_head_office_id||"",onValueChange:a=>c("selected_head_office_id",a),children:[e.jsx(T,{children:e.jsx($,{placeholder:"ëŒ€ë³¸ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”"})}),e.jsx(E,{children:y.map(a=>e.jsxs(q,{value:a.id,children:[a.nickname||a.username," (OPCODE: ",a.opcode,")"]},a.id))})]})]}),s.partner_type==="head_office"&&e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:"ì™¸ë¶€ API ì„¤ì •"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"opcode",children:"OPCODE"}),e.jsx(d,{id:"opcode",value:s.opcode,onChange:a=>c("opcode",a.target.value),placeholder:"ì™¸ë¶€ API OPCODE"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"secret_key",children:"Secret Key"}),e.jsx(d,{id:"secret_key",value:s.secret_key,onChange:a=>c("secret_key",a.target.value),placeholder:"ì™¸ë¶€ API Secret Key"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"api_token",children:"API Token"}),e.jsx(d,{id:"api_token",value:s.api_token,onChange:a=>c("api_token",a.target.value),placeholder:"API Token (ì„ íƒì‚¬í•­)"})]}),e.jsx("div",{className:"flex items-end",children:e.jsx(h,{variant:"outline",onClick:()=>P(s.opcode,s.secret_key),disabled:!s.opcode||!s.secret_key||N[`${s.opcode}_${s.secret_key}`],className:"w-full",children:N[`${s.opcode}_${s.secret_key}`]?e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"h-4 w-4 mr-2 animate-spin"}),"í…ŒìŠ¤íŠ¸ ì¤‘..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),"API ì—°ê²° í…ŒìŠ¤íŠ¸"]})})})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:"ì»¤ë¯¸ì…˜ ì„¤ì •"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"commission_rolling",children:"ë¡¤ë§ ì»¤ë¯¸ì…˜ (%)"}),e.jsx(d,{id:"commission_rolling",type:"number",step:"0.1",value:s.commission_rolling,onChange:a=>{const r=parseFloat(a.target.value);c("commission_rolling",isNaN(r)?0:r)},placeholder:"0.5"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"commission_losing",children:"ë£¨ì§• ì»¤ë¯¸ì…˜ (%)"}),e.jsx(d,{id:"commission_losing",type:"number",step:"0.1",value:s.commission_losing,onChange:a=>{const r=parseFloat(a.target.value);c("commission_losing",isNaN(r)?0:r)},placeholder:"5.0"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"withdrawal_fee",children:"í™˜ì „ ìˆ˜ìˆ˜ë£Œ (%)"}),e.jsx(d,{id:"withdrawal_fee",type:"number",step:"0.1",value:s.withdrawal_fee,onChange:a=>{const r=parseFloat(a.target.value);c("withdrawal_fee",isNaN(r)?0:r)},placeholder:"1.0"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:"ì€í–‰ ì •ë³´"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"bank_name",children:"ì€í–‰ëª…"}),e.jsx(d,{id:"bank_name",value:s.bank_name,onChange:a=>c("bank_name",a.target.value),placeholder:"ì€í–‰ëª…"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"bank_account",children:"ê³„ì¢Œë²ˆí˜¸"}),e.jsx(d,{id:"bank_account",value:s.bank_account,onChange:a=>c("bank_account",a.target.value),placeholder:"ê³„ì¢Œë²ˆí˜¸"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"bank_holder",children:"ì˜ˆê¸ˆì£¼"}),e.jsx(d,{id:"bank_holder",value:s.bank_holder,onChange:a=>c("bank_holder",a.target.value),placeholder:"ì˜ˆê¸ˆì£¼ëª…"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"contact_info",children:"ì—°ë½ì²˜ ì •ë³´"}),e.jsx(ee,{id:"contact_info",value:s.contact_info,onChange:a=>c("contact_info",a.target.value),placeholder:"ì—°ë½ì²˜, ì´ë©”ì¼ ë“± ì¶”ê°€ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”",rows:3})]}),e.jsx("div",{className:"flex justify-end pt-4",children:e.jsxs(h,{onClick:J,disabled:w,className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-4 w-4"}),w?"ìƒì„± ì¤‘...":"íŒŒíŠ¸ë„ˆ ìƒì„±"]})})]})]}),e.jsxs(I,{children:[e.jsxs(S,{children:[e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(de,{className:"h-5 w-5"}),"íŒŒíŠ¸ë„ˆ ëª©ë¡"]}),e.jsx(A,{children:"ìƒì„±ëœ íŒŒíŠ¸ë„ˆ ëª©ë¡ì„ í™•ì¸í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤."})]}),e.jsx(F,{children:e.jsx("div",{className:"rounded-md border",children:e.jsx(ae,{data:L,columns:X,loading:B,searchPlaceholder:"íŒŒíŠ¸ë„ˆë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”..."})})})]})]})]})}export{ye as PartnerCreation,ye as default};
