import{r as p,j as e}from"./react-core-CwM-CeLv.js";import{s as u,i as h,C as I,a as S,b as O,d as A,e as F,L as n,I as d,S as D,p as T,q as $,r as E,t as q,G as Y,v as Z,B as K}from"./index-Cn1S8-JW.js";import{T as ee}from"./textarea-DcWc96jr.js";import{D as ae}from"./DataTable-CjdfiZ7Q.js";import{k as o}from"./vendor-CQn7sZ7L.js";import{R,a9 as se,E as re,m as te,a6 as le,D as ne,f as ce,S as ie,aa as oe,U as de,O as me,a8 as pe}from"./lucide-icons-wLPRtdhM.js";import"./radix-ui-SX2QAG6c.js";import"./supabase-r6ABpEO8.js";function ye({user:m}){const[L,U]=p.useState([]),[y,z]=p.useState([]),[B,k]=p.useState(!1),[w,v]=p.useState(!1),[j,H]=p.useState(!1),[N,b]=p.useState({}),[s,g]=p.useState({username:"",nickname:"",password:"",partner_type:"head_office",parent_id:m.id,level:2,opcode:"",secret_key:"",api_token:"",commission_rolling:.5,commission_losing:5,withdrawal_fee:1,bank_name:"",bank_account:"",bank_holder:"",contact_info:""}),C=[{value:"head_office",label:"대본사",level:2},{value:"main_office",label:"본사",level:3},{value:"sub_office",label:"부본사",level:4},{value:"distributor",label:"총판",level:5},{value:"store",label:"매장",level:6}];p.useEffect(()=>{f(),m.partner_type==="system_admin"&&V()},[]);const f=async()=>{k(!0);try{let a=u.from("partners").select("*").order("created_at",{ascending:!1});m.level>1&&(a=a.or(`parent_id.eq.${m.id},id.eq.${m.id}`));const{data:r,error:i}=await a;if(i)throw i;U(r||[])}catch(a){console.error("파트너 로드 실패:",a),o.error("파트너 데이터를 불러오는데 실패했습니다.")}finally{k(!1)}},V=async()=>{try{const{data:a,error:r}=await u.from("partners").select("id, username, nickname, opcode, secret_key, api_token").eq("partner_type","head_office").eq("status","active").not("opcode","is",null).not("secret_key","is",null).not("api_token","is",null).order("created_at",{ascending:!0});if(r)throw r;z(a||[])}catch(a){console.error("대본사 로드 실패:",a)}},c=(a,r)=>{if(g(i=>({...i,[a]:r})),a==="partner_type"){const i=C.find(t=>t.value===r);i&&g(t=>({...t,level:i.level}))}},P=async(a,r)=>{const i=`${a}_${r}`;b(t=>({...t,[i]:!0}));try{const t=await Y.getInfo(a,r);return t.data&&!t.error?(o.success("API 연결 테스트가 성공했습니다."),!0):(o.error(`API 연결 실패: ${t.error||"알 수 없는 오류"}`),!1)}catch(t){return console.error("API 테스트 실패:",t),o.error(`API 연결 실패: ${t.message}`),!1}finally{b(t=>({...t,[i]:!1}))}},M=()=>s.username.trim()?s.nickname.trim()?!s.password.trim()||s.password.length<6?(o.error("비밀번호는 6자 이상 입력해주세요."),!1):s.partner_type==="head_office"&&(!s.opcode.trim()||!s.secret_key.trim())?(o.error("대본사는 OPCODE와 Secret Key가 필수입니다."),!1):!0:(o.error("닉네임을 입력해주세요."),!1):(o.error("아이디를 입력해주세요."),!1),G=async a=>{let r=a,i=0;const t=10;for(;r&&i<t;){const{data:l,error:_}=await u.from("partners").select("id, partner_type, opcode, secret_key, api_token, parent_id").eq("id",r).single();if(_||!l)break;if(l.partner_type==="head_office"&&l.opcode&&l.secret_key&&l.api_token)return{opcode:l.opcode,secretKey:l.secret_key,token:l.api_token};r=l.parent_id,i++}return null},J=async()=>{if(M()){v(!0);try{if(s.partner_type==="head_office"&&!await P(s.opcode,s.secret_key)){v(!1);return}let a=s.parent_id;m.partner_type==="system_admin"&&s.selected_head_office_id&&(a=s.selected_head_office_id);const r={username:s.username,nickname:s.nickname,password:s.password,partner_type:s.partner_type,parent_id:a,level:s.level,opcode:s.partner_type==="head_office"?s.opcode:null,secret_key:s.partner_type==="head_office"?s.secret_key:null,api_token:s.partner_type==="head_office"?s.api_token:null,commission_rolling:s.commission_rolling,commission_losing:s.commission_losing,withdrawal_fee:s.withdrawal_fee,bank_name:s.bank_name,bank_account:s.bank_account,bank_holder:s.bank_holder,contact_info:s.contact_info?JSON.parse(`{"memo": "${s.contact_info}"}`):null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{data:i,error:t}=await u.from("partners").insert([r]).select().single();if(t)throw t;let l=null;if(s.partner_type==="head_office"&&s.opcode&&s.secret_key?(l={opcode:s.opcode,secretKey:s.secret_key,token:s.api_token||""},console.log("🏢 대본사 생성 - formData의 opcode 사용:",l.opcode)):(l=await G(a),console.log("👥 하위 파트너 생성 - 상위 opcode 조회 결과:",l?l.opcode:"null")),l){const _=s.username.replace(/^btn_/,"");console.log("📡 외부 API 계정 생성 시작:",{opcode:l.opcode,username:_,originalUsername:s.username});const x=await Z(l.opcode,_,l.secretKey);x.error?(console.warn("❌ 외부 API 계정 생성 실패:",x.error),o.warning(`파트너는 생성되었으나 외부 API 연동 실패: ${x.error}`)):(console.log("✅ 외부 API 계정 생성 성공:",x.data),o.success("파트너와 외부 API 계정이 성공적으로 생성되었습니다."))}else console.warn("⚠️ 상위 OPCODE를 찾을 수 없어 외부 API 계정 생성을 건너뜁니다."),o.success("파트너가 성공적으로 생성되었습니다. (외부 API 연동 없음)");g({username:"",nickname:"",password:"",partner_type:"head_office",parent_id:m.id,level:2,opcode:"",secret_key:"",api_token:"",commission_rolling:.5,commission_losing:5,withdrawal_fee:1,bank_name:"",bank_account:"",bank_holder:"",contact_info:"",selected_head_office_id:void 0}),await f()}catch(a){console.error("파트너 생성 실패:",a),o.error(`파트너 생성 실패: ${a.message}`)}finally{v(!1)}}},Q=async a=>{if(confirm("정말로 이 파트너를 삭제하시겠습니까?"))try{const{error:r}=await u.from("partners").delete().eq("id",a);if(r)throw r;o.success("파트너가 성공적으로 삭제되었습니다."),await f()}catch(r){console.error("파트너 삭제 실패:",r),o.error(`파트너 삭제 실패: ${r.message}`)}},W=a=>({1:"시스템관리자",2:"대본사",3:"본사",4:"부본사",5:"총판",6:"매장"})[a]||"알 수 없음",X=[{key:"username",title:"아이디",sortable:!0},{key:"nickname",title:"닉네임",sortable:!0},{key:"level",title:"등급",cell:a=>e.jsx(K,{variant:a.level===2?"default":"secondary",children:W(a.level)})},{key:"opcode",title:"OPCODE",cell:a=>e.jsx("div",{className:"font-mono text-sm",children:a.opcode||"-"})},{key:"status",title:"상태",cell:a=>e.jsx(K,{variant:a.status==="active"?"default":"secondary",children:a.status==="active"?"활성":"비활성"})},{key:"balance",title:"보유금",cell:a=>e.jsxs("div",{className:"text-right font-mono",children:[new Intl.NumberFormat("ko-KR").format(a.balance||0),"원"]})},{key:"created_at",title:"생성일",cell:a=>e.jsx("div",{className:"text-sm text-muted-foreground",children:new Date(a.created_at).toLocaleDateString("ko-KR")})},{key:"actions",title:"관리",cell:a=>e.jsxs("div",{className:"flex gap-1",children:[e.jsx(h,{size:"sm",variant:"outline",onClick:()=>Q(a.id),className:"h-8 w-8 p-0 text-red-600 hover:text-red-700",disabled:a.id===m.id,children:e.jsx(me,{className:"h-4 w-4"})}),e.jsx(h,{size:"sm",variant:"outline",className:"h-8 w-8 p-0",children:e.jsx(pe,{className:"h-4 w-4"})})]})}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-100",children:"대본사 생성"}),e.jsx("p",{className:"text-sm text-slate-400",children:"새로운 파트너를 생성하고 OPCODE를 설정하여 외부 API와 연동합니다."})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(h,{onClick:f,variant:"outline",size:"sm",children:[e.jsx(R,{className:"h-4 w-4 mr-2"}),"새로고침"]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(I,{children:[e.jsxs(S,{children:[e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-5 w-5"}),"새 파트너 생성"]}),e.jsx(A,{children:"파트너 정보를 입력하고 권한을 설정합니다."})]}),e.jsxs(F,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"username",children:"아이디"}),e.jsx(d,{id:"username",value:s.username,onChange:a=>c("username",a.target.value),placeholder:"파트너 아이디"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"nickname",children:"닉네임"}),e.jsx(d,{id:"nickname",value:s.nickname,onChange:a=>c("nickname",a.target.value),placeholder:"표시될 닉네임"})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(n,{htmlFor:"password",children:"비밀번호"}),e.jsxs("div",{className:"relative",children:[e.jsx(d,{id:"password",type:j?"text":"password",value:s.password,onChange:a=>c("password",a.target.value),placeholder:"비밀번호 (6자 이상)"}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent",onClick:()=>H(!j),children:j?e.jsx(re,{className:"h-4 w-4"}):e.jsx(te,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"partner_type",children:"파트너 등급"}),e.jsxs(D,{value:s.partner_type,onValueChange:a=>c("partner_type",a),children:[e.jsx(T,{children:e.jsx($,{placeholder:"등급 선택"})}),e.jsx(E,{children:C.filter(a=>m.level===1?!0:a.level>m.level).map(a=>e.jsxs(q,{value:a.value,children:[a.label," (Level ",a.level,")"]},a.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{children:"레벨"}),e.jsx(d,{value:`Level ${s.level}`,readOnly:!0,className:"bg-muted"})]})]}),m.partner_type==="system_admin"&&s.partner_type!=="head_office"&&y.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"selected_head_office",children:"소속 대본사 선택"}),e.jsxs(D,{value:s.selected_head_office_id||"",onValueChange:a=>c("selected_head_office_id",a),children:[e.jsx(T,{children:e.jsx($,{placeholder:"대본사를 선택하세요"})}),e.jsx(E,{children:y.map(a=>e.jsxs(q,{value:a.id,children:[a.nickname||a.username," (OPCODE: ",a.opcode,")"]},a.id))})]})]}),s.partner_type==="head_office"&&e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:"외부 API 설정"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"opcode",children:"OPCODE"}),e.jsx(d,{id:"opcode",value:s.opcode,onChange:a=>c("opcode",a.target.value),placeholder:"외부 API OPCODE"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"secret_key",children:"Secret Key"}),e.jsx(d,{id:"secret_key",value:s.secret_key,onChange:a=>c("secret_key",a.target.value),placeholder:"외부 API Secret Key"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"api_token",children:"API Token"}),e.jsx(d,{id:"api_token",value:s.api_token,onChange:a=>c("api_token",a.target.value),placeholder:"API Token (선택사항)"})]}),e.jsx("div",{className:"flex items-end",children:e.jsx(h,{variant:"outline",onClick:()=>P(s.opcode,s.secret_key),disabled:!s.opcode||!s.secret_key||N[`${s.opcode}_${s.secret_key}`],className:"w-full",children:N[`${s.opcode}_${s.secret_key}`]?e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"h-4 w-4 mr-2 animate-spin"}),"테스트 중..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),"API 연결 테스트"]})})})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:"커미션 설정"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"commission_rolling",children:"롤링 커미션 (%)"}),e.jsx(d,{id:"commission_rolling",type:"number",step:"0.1",value:s.commission_rolling,onChange:a=>{const r=parseFloat(a.target.value);c("commission_rolling",isNaN(r)?0:r)},placeholder:"0.5"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"commission_losing",children:"루징 커미션 (%)"}),e.jsx(d,{id:"commission_losing",type:"number",step:"0.1",value:s.commission_losing,onChange:a=>{const r=parseFloat(a.target.value);c("commission_losing",isNaN(r)?0:r)},placeholder:"5.0"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"withdrawal_fee",children:"환전 수수료 (%)"}),e.jsx(d,{id:"withdrawal_fee",type:"number",step:"0.1",value:s.withdrawal_fee,onChange:a=>{const r=parseFloat(a.target.value);c("withdrawal_fee",isNaN(r)?0:r)},placeholder:"1.0"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"h-4 w-4"}),e.jsx("span",{className:"font-medium",children:"은행 정보"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"bank_name",children:"은행명"}),e.jsx(d,{id:"bank_name",value:s.bank_name,onChange:a=>c("bank_name",a.target.value),placeholder:"은행명"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"bank_account",children:"계좌번호"}),e.jsx(d,{id:"bank_account",value:s.bank_account,onChange:a=>c("bank_account",a.target.value),placeholder:"계좌번호"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"bank_holder",children:"예금주"}),e.jsx(d,{id:"bank_holder",value:s.bank_holder,onChange:a=>c("bank_holder",a.target.value),placeholder:"예금주명"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"contact_info",children:"연락처 정보"}),e.jsx(ee,{id:"contact_info",value:s.contact_info,onChange:a=>c("contact_info",a.target.value),placeholder:"연락처, 이메일 등 추가 정보를 입력하세요",rows:3})]}),e.jsx("div",{className:"flex justify-end pt-4",children:e.jsxs(h,{onClick:J,disabled:w,className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-4 w-4"}),w?"생성 중...":"파트너 생성"]})})]})]}),e.jsxs(I,{children:[e.jsxs(S,{children:[e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(de,{className:"h-5 w-5"}),"파트너 목록"]}),e.jsx(A,{children:"생성된 파트너 목록을 확인하고 관리합니다."})]}),e.jsx(F,{children:e.jsx("div",{className:"rounded-md border",children:e.jsx(ae,{data:L,columns:X,loading:B,searchPlaceholder:"파트너를 검색하세요..."})})})]})]})]})}export{ye as PartnerCreation,ye as default};
