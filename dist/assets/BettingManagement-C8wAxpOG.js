const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-B-OPgV84.js","assets/react-core-CwM-CeLv.js","assets/vendor-CQn7sZ7L.js","assets/radix-ui-SX2QAG6c.js","assets/lucide-icons-D2Y5yybo.js","assets/supabase-r6ABpEO8.js","assets/index-BjkDZjvS.css"])))=>i.map(i=>d[i]);
import{_ as U}from"./supabase-r6ABpEO8.js";import{r as c,j as s}from"./react-core-CwM-CeLv.js";import{s as g,i as O,L as G,I as H,m as V,R as W,B as E}from"./index-B-OPgV84.js";import{D as Y}from"./DataTable-Cfqx9Gu8.js";import{k as n}from"./vendor-CQn7sZ7L.js";import{ad as F,ak as q,a5 as z}from"./lucide-icons-D2Y5yybo.js";import"./radix-ui-SX2QAG6c.js";function ae({user:f}){const[y,b]=c.useState(!1),[w,j]=c.useState(!1),[v,N]=c.useState([]),[_,A]=c.useState(""),[C,R]=c.useState(0),[k,S]=c.useState(null);if(f.level>2)return s.jsx("div",{className:"flex items-center justify-center h-64",children:s.jsxs("div",{className:"text-center space-y-4",children:[s.jsx(F,{className:"h-12 w-12 text-yellow-500 mx-auto"}),s.jsx("p",{className:"text-muted-foreground",children:"베팅 내역 관리는 대본사 이상만 접근 가능합니다."})]})});c.useEffect(()=>{u()},[]),c.useEffect(()=>{const e=g.channel("game-records-changes").on("postgres_changes",{event:"*",schema:"public",table:"game_records"},i=>{console.log("🎮 game_records 테이블 변경 감지:",i),u()}).subscribe();return()=>{g.removeChannel(e)}},[]);const u=async()=>{try{b(!0),console.log("📊 전체 베팅 내역 조회 시작...");const{data:e,error:i,count:r}=await g.from("game_records").select(`
          id,
          external_txid,
          user_id,
          username,
          game_id,
          provider_id,
          bet_amount,
          win_amount,
          balance_before,
          balance_after,
          played_at,
          games(name),
          game_providers(name),
          users!game_records_user_id_fkey(
            referrer_id,
            referrer:partners!users_referrer_id_fkey(nickname)
          )
        `,{count:"exact"}).order("played_at",{ascending:!1}).limit(1e3);if(i)throw console.error("❌ 조회 오류:",i),n.error("베팅 내역 조회 오류",{description:`${i.message}`}),i;console.log("✅ 조회 결과:",{count:r,dataLength:e?.length,sampleData:e?.slice(0,2)});const l=(e||[]).map(a=>({id:a.id,external_txid:a.external_txid||0,user_id:a.user_id,username:a.username||"Unknown",referrer_nickname:a.users?.referrer?.nickname||"-",game_name:a.games?.name||`Game ${a.game_id}`,provider_name:a.game_providers?.name||`Provider ${a.provider_id}`,bet_amount:parseFloat(a.bet_amount||0),win_amount:parseFloat(a.win_amount||0),balance_before:parseFloat(a.balance_before||0),balance_after:parseFloat(a.balance_after||0),played_at:a.played_at,profit_loss:parseFloat(a.win_amount||0)-parseFloat(a.bet_amount||0)}));N(l),R(r||0),l.length===0?n.warning("⚠️ 베팅 내역이 없습니다",{description:'"베팅내역가져오기" 버튼을 클릭하여 데이터를 동기화하세요.'}):n.success(`✅ ${l.length}건 조회 완료 (전체 ${r}건)`)}catch(e){console.error("❌ 베팅 내역 조회 오류:",e),n.error("베팅 내역 조회 실패",{description:e instanceof Error?e.message:"알 수 없는 오류"}),N([])}finally{b(!1)}},I=async()=>{try{j(!0);const{getAdminOpcode:e,isMultipleOpcode:i}=await U(async()=>{const{getAdminOpcode:t,isMultipleOpcode:p}=await import("./index-B-OPgV84.js").then(M=>M.$);return{getAdminOpcode:t,isMultipleOpcode:p}},__vite__mapDeps([0,1,2,3,4,5,6]));let r,l;try{const t=await e(f);if(i(t)){if(t.opcodes.length===0){n.error("등록된 대본사가 없습니다.");return}const p=t.opcodes[0];r=p.opcode,l=p.secretKey,n.info(`${p.partnerName}의 OPCODE로 동기화를 시작합니다.`,{description:`총 ${t.opcodes.length}개의 대본사 중 첫 번째`})}else r=t.opcode,l=t.secretKey,console.log(`✅ ${f.partner_type} - ${t.partnerName} OPCODE 사용`)}catch(t){n.error("OPCODE 조회 실패",{description:t.message});return}const a=new Date,$=a.getFullYear().toString(),D=(a.getMonth()+1).toString();console.log("📥 베팅 내역 API 호출:",{year:$,month:D,opcode:r});const x=await W(r,$,D,0,4e3,l);if(x.error){n.error("API 호출 오류",{description:x.error});return}const d=x.data?.DATA||[];if(!Array.isArray(d)||d.length===0){n.info("가져올 베팅 데이터가 없습니다."),S(new Date().toISOString());return}console.log("✅ API 응답:",{레코드수:d.length,샘플:d[0]});const T=d.map(t=>({txid:t.txid?.toString()||t.id?.toString(),username:t.username||t.user_id,provider_id:t.provider_id||Math.floor((t.game_id||0)/1e3),game_id:t.game_id?.toString()||"0",game_name:t.game_name||"Unknown",bet_amount:parseFloat(t.bet_amount||t.bet||0),win_amount:parseFloat(t.win_amount||t.win||0),profit_loss:parseFloat(t.profit_loss||t.win_loss||(t.win_amount||t.win||0)-(t.bet_amount||t.bet||0)),currency:t.currency||"KRW",status:t.status||"completed",round_id:t.round_id,session_id:t.session_id,game_start_time:t.game_start_time||t.start_time,game_end_time:t.game_end_time||t.end_time||t.played_at||t.created_at})),{data:K,error:h}=await g.rpc("save_betting_records_from_api",{p_records:T});if(h){console.error("❌ 저장 함수 호출 실패:",h),n.error("베팅 내역 저장 실패",{description:h.message});return}const o=K?.[0]||{saved_count:0,skipped_count:0,error_count:0,errors:[]};console.log("✅ 저장 결과:",o);const L=new Date().toISOString();S(L),o.saved_count>0?(n.success(`베팅 내역 ${o.saved_count}건 저장 완료`,{description:`동기화 시간: ${L}${o.skipped_count>0?` (중복 ${o.skipped_count}건 스킵)`:""}`}),u()):o.skipped_count>0&&n.info(`모든 데이터가 이미 존재합니다 (${o.skipped_count}건)`),o.error_count>0&&o.errors&&o.errors.length>0&&(console.warn("⚠️ 일부 저장 오류:",o.errors),n.warning(`${o.error_count}건 저장 실패`,{description:`성공: ${o.saved_count}건, 스킵: ${o.skipped_count}건
첫 번째 에러: ${o.errors[0]}`}))}catch(e){console.error("❌ 베팅 동기화 오류:",e),n.error("베팅 내역 가져오기 실패",{description:e instanceof Error?e.message:"알 수 없는 오류"})}finally{j(!1)}},B=()=>{try{const e=[["사용자","소속","게임명","제공사","베팅액","당첨액","손익","플레이 시간"].join(","),...m.map(a=>[a.username,a.referrer_nickname,`"${a.game_name}"`,a.provider_name,a.bet_amount,a.win_amount,a.profit_loss,a.played_at].join(","))].join(`
`),i=new Blob(["\uFEFF"+e],{type:"text/csv;charset=utf-8;"}),r=document.createElement("a"),l=URL.createObjectURL(i);r.setAttribute("href",l),r.setAttribute("download",`betting_${new Date().toISOString().split("T")[0]}.csv`),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r),n.success("베팅 내역 다운로드 완료")}catch(e){console.error("다운로드 오류:",e),n.error("다운로드 실패")}};c.useEffect(()=>{u()},[]);const m=_?v.filter(e=>e.username.toLowerCase().includes(_.toLowerCase())):v,P=[{key:"username",title:"사용자"},{key:"referrer_nickname",title:"소속",render:e=>s.jsx(E,{variant:"outline",className:"bg-slate-800/50 border-slate-600",children:e})},{key:"game_name",title:"게임명",render:e=>s.jsx("span",{className:"max-w-[200px] truncate",title:e,children:e})},{key:"provider_name",title:"제공사",render:e=>s.jsx(E,{variant:"secondary",children:e})},{key:"bet_amount",title:"베팅액",render:e=>s.jsxs("span",{className:"font-mono text-blue-600",children:["₩",e.toLocaleString()]})},{key:"win_amount",title:"당첨액",render:e=>s.jsxs("span",{className:`font-mono ${e>0?"text-green-600":"text-gray-500"}`,children:["₩",e.toLocaleString()]})},{key:"profit_loss",title:"손익",render:e=>s.jsxs("span",{className:`font-mono ${e>0?"text-green-600":"text-red-600"}`,children:[e>0?"+":"","₩",e.toLocaleString()]})},{key:"played_at",title:"플레이 시간",render:e=>e?new Date(e).toISOString().replace("T"," ").substring(0,19):"-"}];return s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"space-y-1",children:[s.jsx("h1",{className:"text-2xl font-bold text-slate-100",children:"베팅 내역 관리"}),s.jsxs("p",{className:"text-sm text-slate-400",children:["조회: ",m.length,"건 / 전체: ",C,"건",k&&s.jsxs("span",{className:"ml-4 text-green-400",children:["마지막 동기화: ",new Date(k).toLocaleString("ko-KR")]})]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(O,{onClick:I,disabled:w,className:"btn-premium-primary",children:[s.jsx(q,{className:"h-4 w-4 mr-2"}),w?"가져오는 중...":"베팅내역가져오기"]}),s.jsxs(O,{onClick:B,disabled:y||m.length===0,variant:"outline",className:"border-slate-600 hover:bg-slate-700",children:[s.jsx(z,{className:"h-4 w-4 mr-2"}),"다운로드"]})]})]}),s.jsx("div",{className:"glass-card rounded-xl p-6",children:s.jsxs("div",{className:"space-y-4",children:[s.jsx("div",{className:"flex items-center justify-between mb-6 pb-4 border-b border-slate-700/50",children:s.jsxs("div",{children:[s.jsx(G,{htmlFor:"betting-user-search",className:"text-slate-300",children:"사용자명 검색"}),s.jsx(H,{id:"betting-user-search",name:"user_search",placeholder:"사용자명 입력...",value:_,onChange:e=>A(e.target.value),className:"input-premium max-w-xs"})]})}),y?s.jsx("div",{className:"flex justify-center py-12",children:s.jsx(V,{})}):m.length>0?s.jsx(Y,{columns:P,data:m,enableSearch:!1}):s.jsxs("div",{className:"text-center py-12 text-slate-400",children:[s.jsx(F,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),s.jsx("p",{children:"조회된 베팅 내역이 없습니다."}),s.jsx("p",{className:"text-sm mt-2",children:_?"검색 조건을 변경해보세요.":'"베팅내역가져오기" 버튼을 클릭하여 데이터를 동기화하세요.'})]})]})})]})}export{ae as BettingManagement};
