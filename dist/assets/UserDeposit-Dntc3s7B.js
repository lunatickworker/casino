import{r as l,j as e}from"./react-core-CwM-CeLv.js";import{K as M,s as i,C as v,a as C,b as S,e as k,L as b,I as E,i as m,V as G,W as K,m as P,B as U}from"./index-Zxf-w_JS.js";import{T as W}from"./textarea-CBBumD45.js";import{k as n}from"./vendor-CQn7sZ7L.js";import{W as z,d as D,ag as O,P as Q,aB as V,ad as X,o as J,n as Y,R as Z,t as ee}from"./lucide-icons-wLPRtdhM.js";import"./radix-ui-SX2QAG6c.js";import"./supabase-r6ABpEO8.js";function oe({user:a,onRouteChange:I}){const{sendMessage:A}=M(),[o,d]=l.useState(""),[x,f]=l.useState(""),[j,w]=l.useState(!1),[N,T]=l.useState([]),[B,y]=l.useState(!0),[$]=l.useState([1e3,3e3,5e3,1e4,3e4,5e4,1e5,3e5,5e5,1e6]),[u,q]=l.useState(0),h=async()=>{try{y(!0);const{data:t,error:s}=await i.from("transactions").select("*").eq("user_id",a.id).eq("transaction_type","deposit").order("created_at",{ascending:!1}).limit(10);if(s)throw s;T(t||[])}catch(t){console.error("입금 내역 조회 오류:",t),n.error("입금 내역을 불러오는데 실패했습니다.")}finally{y(!1)}},p=async()=>{try{const{data:t,error:s}=await i.from("users").select("balance").eq("id",a.id).single();if(s)throw s;q(parseFloat(t.balance)||0)}catch(t){console.error("잔고 조회 오류:",t)}},F=async t=>{if(t.preventDefault(),!o){n.error("모든 필수 항목을 입력해주세요.");return}const s=parseFloat(o);if(s<1e4){n.error("최소 입금 금액은 10,000원입니다.");return}if(s>1e7){n.error("최대 입금 금액은 10,000,000원입니다.");return}w(!0);try{await p();const r={user_id:a.id,partner_id:a.referrer_id||null,transaction_type:"deposit",amount:s,status:"pending",balance_before:u,balance_after:u,bank_name:"국민은행",bank_account:"123456-78-901234",bank_holder:"GMS카지노",memo:x.trim()||null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};console.log("💰 입금 신청 데이터:",{...r,user_info:{id:a.id,username:a.username,referrer_id:a.referrer_id}});const{data:g,error:_}=await i.from("transactions").insert([r]).select().single();if(_)throw _;await A("deposit_request",{transaction_id:g.id,user_id:a.id,username:a.username,nickname:a.nickname,amount:s,bank_name:"국민은행",bank_account:"123456-78-901234",depositor_name:"GMS카지노",memo:x.trim()||null,subject:`${a.nickname}님의 입금 신청`,reference_type:"transaction",reference_id:g.id},3)&&console.log("✅ 입금 요청 알림이 관리자에게 전송되었습니다."),await i.from("activity_logs").insert([{actor_type:"user",actor_id:a.id,action:"deposit_request",target_type:"transaction",target_id:g.id,details:{amount:s,bank_name:"국민은행",depositor_name:"GMS카지노"}}]),d(""),f(""),await h(),n.success(`입금 신청이 완료되었습니다.
관리자 승인 후 잔고에 반영됩니다.`,{duration:4e3})}catch(r){console.error("❌ 입금 신청 오류:",r),n.error(r.message||"입금 신청 중 오류가 발생했습니다.")}finally{w(!1)}},R=t=>{const s=parseInt(o)||0;d((s+t).toString())},H=t=>{switch(t){case"pending":return{color:"bg-yellow-500",textColor:"text-yellow-400",icon:ee,label:"승인대기"};case"approved":return{color:"bg-blue-500",textColor:"text-blue-400",icon:Z,label:"처리중"};case"completed":return{color:"bg-green-500",textColor:"text-green-400",icon:Y,label:"완료"};case"rejected":return{color:"bg-red-500",textColor:"text-red-400",icon:J,label:"거절"};default:return{color:"bg-slate-500",textColor:"text-slate-400",icon:X,label:"알 수 없음"}}},c=t=>new Intl.NumberFormat("ko-KR").format(t),L=t=>new Date(t).toLocaleString("ko-KR");return l.useEffect(()=>{h(),p();const t=i.channel(`deposit_updates_${a.id}`).on("postgres_changes",{event:"*",schema:"public",table:"transactions",filter:`user_id=eq.${a.id}`},s=>{if(console.log("🔄 입금 상태 업데이트 수신:",s),s.eventType==="UPDATE"||s.eventType==="INSERT"){const r=s.new;r.transaction_type==="deposit"&&(h(),r.status==="completed"?(p(),n.success(`입금이 완료되었습니다!
금액: ₩${c(r.amount)}`,{duration:5e3})):r.status==="rejected"?n.error(`입금 신청이 거절되었습니다.
금액: ₩${c(r.amount)}`,{duration:5e3}):r.status==="approved"&&n.info(`입금이 승인되었습니다. 처리 중입니다.
금액: ₩${c(r.amount)}`,{duration:4e3}))}}).subscribe();return()=>t.unsubscribe()},[a.id]),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"입금 신청"}),e.jsx("p",{className:"text-slate-400",children:"안전하고 빠른 입금 서비스를 이용하세요"})]}),e.jsxs("div",{className:"flex items-center gap-4 bg-slate-800/50 rounded-lg px-4 py-2",children:[e.jsx(z,{className:"w-5 h-5 text-green-400"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-slate-300",children:"현재 보유금"}),e.jsxs("div",{className:"text-lg font-bold text-green-400",children:["₩",c(u)]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsxs(v,{className:"bg-slate-800/50 border-slate-700",children:[e.jsx(C,{children:e.jsxs(S,{className:"flex items-center text-white",children:[e.jsx(D,{className:"w-5 h-5 mr-2 text-green-400"}),"입금 신청"]})}),e.jsx(k,{children:e.jsxs("form",{onSubmit:F,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"amount",className:"text-slate-300",children:"입금 금액 *"}),e.jsx(E,{id:"amount",type:"text",placeholder:"금액을 입력하세요",value:o,onChange:t=>{const s=t.target.value.replace(/[^0-9]/g,"");d(s)},className:"bg-slate-700/50 border-slate-600 text-white text-lg"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{className:"text-slate-300",children:"빠른 선택"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[$.map(t=>e.jsxs(m,{type:"button",variant:"outline",size:"sm",onClick:()=>R(t),className:"whitespace-nowrap",children:["+",c(t),"원"]},t)),e.jsx(m,{type:"button",variant:"outline",size:"sm",onClick:()=>d(""),className:"whitespace-nowrap border-red-600 text-red-400 hover:bg-red-900/20",children:"삭제"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"memo",className:"text-slate-300",children:"메모 (선택)"}),e.jsx(W,{id:"memo",placeholder:"추가 요청사항이 있으시면 입력하세요",value:x,onChange:t=>f(t.target.value),className:"bg-slate-700/50 border-slate-600 text-white",rows:3})]}),e.jsxs(G,{className:"border-yellow-600 bg-yellow-900/20",children:[e.jsx(O,{className:"h-4 w-4 text-yellow-400"}),e.jsx(K,{className:"text-yellow-300",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{children:"• 최소 입금액: 10,000원 | 최대 입금액: 10,000,000원"}),e.jsx("p",{children:"• 입금자명과 계좌 소유자명이 일치해야 합니다"}),e.jsx("p",{children:"• 승인까지 평균 5-10분 소요됩니다"}),e.jsx("p",{children:"• 문의사항은 고객센터를 이용해주세요"})]})})]}),e.jsx(m,{type:"submit",disabled:j,className:"w-full bg-green-600 hover:bg-green-700 text-white py-3",children:j?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"신청 처리 중..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Q,{className:"w-4 h-4 mr-2"}),"입금 신청하기"]})})]})})]})}),e.jsx("div",{children:e.jsxs(v,{className:"bg-slate-800/50 border-slate-700",children:[e.jsx(C,{children:e.jsxs(S,{className:"flex items-center text-white",children:[e.jsx(V,{className:"w-5 h-5 mr-2 text-blue-400"}),"최근 입금 내역"]})}),e.jsx(k,{children:B?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(P,{})}):N.length>0?e.jsxs("div",{className:"space-y-4",children:[N.map(t=>{const s=H(t.status),r=s.icon;return e.jsxs("div",{className:"p-4 bg-slate-700/30 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(r,{className:`w-4 h-4 ${s.textColor}`}),e.jsx(U,{className:`${s.color} text-white`,children:s.label})]}),e.jsxs("span",{className:"text-lg font-bold text-white",children:["₩",c(t.amount)]})]}),e.jsxs("div",{className:"space-y-1 text-sm text-slate-400",children:[e.jsxs("p",{children:[t.bank_name," ",t.bank_account]}),e.jsx("p",{children:L(t.created_at)}),t.memo&&e.jsxs("p",{className:"text-slate-300",children:["메모: ",t.memo]})]})]},t.id)}),e.jsx(m,{variant:"outline",onClick:()=>I("/user/profile"),className:"w-full",children:"전체 내역 보기"})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(D,{className:"w-12 h-12 text-slate-600 mx-auto mb-3"}),e.jsx("p",{className:"text-slate-400",children:"입금 내역이 없습니다"})]})})]})})]})]})}export{oe as UserDeposit};
