import{v as Y,ax as Z,r as i,s as T,t as d,j as e,w as o,R as k,C as f,e as b,a as ee,b as se,m as ae,n as re,o as _,L as ne,B as A,H as te,ay as q,az as O,E as le,I as ie,a2 as P}from"./index-BWgbPZ4l.js";import{D as ce,a as oe,b as de,c as me,d as ue,e as xe}from"./dialog-B-V90Y16.js";import{C as pe}from"./clock-BQI8X08V.js";import{D as F}from"./dollar-sign-DTrUq9JA.js";import{T as he}from"./triangle-alert-BO-46YC8.js";function Ne({user:S}){const{connected:C,sendMessage:E}=Y(),{sendMessage:M}=Z(),[x,K]=i.useState([]),[$,B]=i.useState(!0),[p,L]=i.useState(null),[s,N]=i.useState(null),[z,v]=i.useState(!1),[y,R]=i.useState(""),[h,H]=i.useState("pending"),[m,U]=i.useState(!0),u=i.useCallback(async()=>{try{B(!0);let a=T.from("transactions").select(`
          *,
          users:user_id (
            username,
            nickname,
            balance,
            bank_name,
            bank_account,
            bank_holder,
            referrer_id,
            partners:referrer_id (
              opcode,
              secret_key,
              token
            )
          )
        `).order("request_time",{ascending:!1});h!=="all"&&(a=a.eq("status",h));const{data:n,error:r}=await a.limit(100);if(r)throw r;const c=n?.map(t=>({...t,user_id:t.user_id,username:t.users?.username||"알 수 없음",nickname:t.users?.nickname||"알 수 없음",current_balance:t.users?.balance||0,bank_info:{bank_name:t.users?.bank_name||"",bank_account:t.users?.bank_account||"",bank_holder:t.users?.bank_holder||""}}))||[];K(c),console.log(`💰 [거래승인] ${h} 상태 거래 ${c.length}건 조회`),c.length>0&&console.log("📊 [거래 샘플]:",{transaction_id:c[0].id,user_id:c[0].user_id,username:c[0].username,has_user_id:!!c[0].user_id})}catch(a){console.error("거래 요청 조회 실패:",a),d.error("거래 요청을 불러오는데 실패했습니다.")}finally{B(!1)}},[h]),w=async a=>{if(s)try{L(s.id),console.log(`🔄 [거래처리] ${s.transaction_type} ${a} 시작:`,{transactionId:s.id,username:s.username,amount:s.amount,currentBalance:s.current_balance});let n=null,r=s.current_balance;if(a==="approve"){let l=s.users?.partners?.opcode||"",j=s.users?.partners?.token||"",g=s.users?.partners?.secret_key||"";if(console.log("🔐 [파트너 정보]:",{has_partners:!!s.users?.partners,has_opcode:!!l,has_token:!!j,has_secretKey:!!g,opcode_preview:l?`${l.substring(0,3)}...`:"NONE"}),!l||!j||!g){console.error("❌ [파트너 정보 누락]:",{opcode:!!l,token:!!j,secretKey:!!g,referrer_id:s.users?.referrer_id}),d.error("파트너 API 설정이 없습니다. 소속 파트너 설정을 확인하세요.");return}try{if(s.transaction_type==="deposit"?(console.log("💰 [API 입금] 외부 API 입금 처리 시작"),n=await P.depositBalance(s.username,s.amount,l,j,g)):(console.log("💸 [API 출금] 외부 API 출금 처리 시작"),n=await P.withdrawBalance(s.username,s.amount,l,j,g)),console.log("📡 [API 응답]:",n),n.data&&!n.error)r=P.extractBalanceFromResponse(n.data,s.username),console.log(`✅ [API 성공] 새로운 잔고: ${r}`),(r===0||isNaN(r))&&console.warn("⚠️ [잔고 추출 경고] 잔고가 0이거나 유효하지 않습니다:",{newBalance:r,apiData:n.data});else throw new Error(n.error||"API 호출 실패")}catch(D){console.error("❌ [API 실패]:",D),d.error(`외부 API ${s.transaction_type==="deposit"?"입금":"출금"} 처리 실패: ${D instanceof Error?D.message:"알 수 없는 오류"}`);return}}const c=a==="approve"?"completed":"rejected",t={status:c,processed_at:new Date().toISOString(),processed_by:S?.username||"system",processing_note:y||null,external_transaction_id:n?.data?.transaction_id||n?.data?.id||null,updated_at:new Date().toISOString()};a==="approve"&&(t.balance_after=r);const{error:I}=await T.from("transactions").update(t).eq("id",s.id).eq("status","pending");if(I)throw console.error("❌ [거래 업데이트 실패]:",I),I;if(console.log(`✅ [거래 업데이트 완료] ${s.id} -> ${c}`),a==="approve"){if(console.log("💰 [잔고 업데이트 준비]:",{user_id:s.user_id,username:s.username,old_balance:s.current_balance,new_balance:r,has_user_id:!!s.user_id}),!s.user_id)throw console.error("❌ [치명적 오류] user_id가 없습니다!",s),new Error("user_id가 없어 잔고를 업데이트할 수 없습니다.");const{error:l}=await T.from("users").update({balance:r,updated_at:new Date().toISOString()}).eq("id",s.user_id);if(l)throw console.error("❌ [잔고 업데이트 실패]:",l),l;console.log(`✅ [잔고 업데이트 완료] ${s.username}: ${s.current_balance} -> ${r}`)}await M("transaction_processed",{transaction_id:s.id,username:s.username,transaction_type:s.transaction_type,amount:s.amount,action:a,newBalance:r,processedBy:S?.username||"system",note:y||null,target_user_id:s.user_id},1),C&&E&&E("transaction_processed",{transaction_id:s.id,username:s.username,user_id:s.user_id,transaction_type:s.transaction_type,amount:s.amount,action:a,newBalance:r,processedBy:S?.username||"system",note:y||null,timestamp:new Date().toISOString()});const G=a==="approve"?"승인":"거절",J=s.transaction_type==="deposit"?"입금":"출금";d.success(`${s.username}님의 ${J} 요청이 ${G}되었습니다.`),v(!1),N(null),R(""),await u()}catch(n){console.error(`거래 ${a} 처리 실패:`,n);const r=n instanceof Error?n.message:String(n);r.includes("관리자 보유금")||r.includes("보유금이 부족")?d.error("❌ 관리자 보유금이 부족하여 처리할 수 없습니다.",{description:"상위 관리자에게 보유금을 요청하세요.",duration:6e3}):r.includes("보유금 검증")?d.error("❌ 보유금 검증 실패",{description:r,duration:6e3}):d.error(`거래 처리 중 오류가 발생했습니다: ${r}`)}finally{L(null)}};i.useEffect(()=>{if(!m)return;const a=setInterval(()=>{console.log("🔄 [자동새로고침] 거래 요청 목록 갱신"),u()},3e4);return()=>clearInterval(a)},[m,u]),i.useEffect(()=>{u()},[u]);const W=a=>{switch(a){case"pending":return"bg-yellow-500";case"processing":return"bg-blue-500";case"approved":return"bg-green-500";case"completed":return"bg-green-600";case"rejected":return"bg-red-500";case"failed":return"bg-red-600";default:return"bg-gray-500"}},Q=a=>{switch(a){case"pending":return"대기";case"processing":return"처리중";case"approved":return"승인";case"completed":return"완료";case"rejected":return"거절";case"failed":return"실패";default:return a}},V=x.filter(a=>a.status==="pending").length,X=x.filter(a=>a.status==="processing").length;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-100",children:"입출금 승인 관리"}),e.jsx("p",{className:"text-sm text-slate-400",children:"실시간 입출금 요청을 승인하거나 거절할 수 있습니다."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(o,{variant:"outline",onClick:()=>U(!m),className:m?"bg-green-50 border-green-200":"",children:[e.jsx(k,{className:`h-4 w-4 mr-2 ${m?"animate-spin":""}`}),"자동새로고침 ",m?"ON":"OFF"]}),e.jsxs(o,{onClick:u,disabled:$,children:[e.jsx(k,{className:`h-4 w-4 mr-2 ${$?"animate-spin":""}`}),"새로고침"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(f,{className:"border-yellow-200 bg-yellow-50",children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-yellow-700",children:"대기 중"}),e.jsx("p",{className:"text-2xl font-bold text-yellow-800",children:V})]}),e.jsx(pe,{className:"h-8 w-8 text-yellow-600"})]})})}),e.jsx(f,{className:"border-blue-200 bg-blue-50",children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-blue-700",children:"처리 중"}),e.jsx("p",{className:"text-2xl font-bold text-blue-800",children:X})]}),e.jsx(k,{className:"h-8 w-8 text-blue-600 animate-spin"})]})})}),e.jsx(f,{className:"border-green-200 bg-green-50",children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-green-700",children:"총 거래"}),e.jsx("p",{className:"text-2xl font-bold text-green-800",children:x.length})]}),e.jsx(F,{className:"h-8 w-8 text-green-600"})]})})}),e.jsx(f,{className:"border-gray-200 bg-gray-50",children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-700",children:"연결 상태"}),e.jsx("p",{className:"text-sm font-semibold text-gray-800",children:C?"🟢 연결됨":"🔴 연결끊김"})]}),e.jsx("div",{className:`h-4 w-4 rounded-full ${C?"bg-green-400":"bg-red-400"} animate-pulse`})]})})})]}),e.jsxs(f,{children:[e.jsx(ee,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(se,{children:"거래 요청 목록"}),e.jsx(ae,{value:h,onValueChange:H,children:e.jsxs(re,{children:[e.jsx(_,{value:"pending",children:"대기중"}),e.jsx(_,{value:"processing",children:"처리중"}),e.jsx(_,{value:"approved",children:"승인됨"}),e.jsx(_,{value:"rejected",children:"거절됨"}),e.jsx(_,{value:"all",children:"전체"})]})})]})}),e.jsx(b,{children:$?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(ne,{}),e.jsx("span",{className:"ml-2",children:"거래 요청을 불러오는 중..."})]}):e.jsx("div",{className:"space-y-4",children:x.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(F,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"거래 요청이 없습니다."})]}):x.map(a=>e.jsx("div",{className:"p-4 border rounded-lg hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:`h-3 w-3 rounded-full ${W(a.status)}`}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:a.nickname}),e.jsx(A,{variant:"outline",className:"text-xs",children:a.username}),e.jsx(A,{variant:a.transaction_type==="deposit"?"default":"destructive",children:a.transaction_type==="deposit"?"💰 입금":"💸 출금"})]}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[new Date(a.request_time).toLocaleString("ko-KR")," · 현재잔고: ",a.current_balance.toLocaleString(),"원"]}),a.bank_info?.bank_name&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[a.bank_info.bank_name," ",a.bank_info.bank_account," (",a.bank_info.bank_holder,")"]})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:`text-lg font-bold ${a.transaction_type==="deposit"?"text-green-600":"text-red-600"}`,children:[a.transaction_type==="deposit"?"+":"-",a.amount.toLocaleString(),"원"]}),e.jsx("div",{className:"text-sm text-gray-500",children:Q(a.status)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(o,{variant:"outline",size:"sm",onClick:()=>{N(a),v(!0)},children:e.jsx(te,{className:"h-4 w-4"})}),a.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsxs(o,{size:"sm",onClick:()=>{N(a),w("approve")},disabled:p===a.id,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(q,{className:"h-4 w-4 mr-1"}),"승인"]}),e.jsxs(o,{variant:"destructive",size:"sm",onClick:()=>{N(a),w("reject")},disabled:p===a.id,children:[e.jsx(O,{className:"h-4 w-4 mr-1"}),"거절"]})]}),p===a.id&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{className:"text-sm",children:"처리중..."})]})]})]})]})},a.id))})})]}),e.jsx(ce,{open:z,onOpenChange:v,children:e.jsxs(oe,{className:"sm:max-w-[600px]",children:[e.jsxs(de,{children:[e.jsx(me,{children:"거래 요청 처리"}),e.jsx(ue,{children:"선택한 거래 요청을 승인하거나 거절할 수 있습니다."})]}),s&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium",children:"요청자:"}),e.jsxs("span",{children:[s.nickname," (",s.username,")"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium",children:"거래 유형:"}),e.jsx(A,{variant:s.transaction_type==="deposit"?"default":"destructive",children:s.transaction_type==="deposit"?"입금":"출금"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium",children:"요청 금액:"}),e.jsxs("span",{className:`font-bold ${s.transaction_type==="deposit"?"text-green-600":"text-red-600"}`,children:[s.transaction_type==="deposit"?"+":"-",s.amount.toLocaleString(),"원"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium",children:"현재 잔고:"}),e.jsxs("span",{className:"font-mono",children:[s.current_balance.toLocaleString(),"원"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium",children:"요청 시간:"}),e.jsx("span",{children:new Date(s.request_time).toLocaleString("ko-KR")})]}),s.bank_info?.bank_name&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium",children:"은행 정보:"}),e.jsxs("span",{className:"text-sm",children:[s.bank_info.bank_name," ",s.bank_info.bank_account,e.jsx("br",{}),"(",s.bank_info.bank_holder,")"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(le,{htmlFor:"processing-note",children:"처리 메모 (선택사항)"}),e.jsx(ie,{id:"processing-note",value:y,onChange:a=>R(a.target.value),placeholder:"처리 사유나 메모를 입력하세요"})]}),e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:[e.jsx(he,{className:"h-5 w-5 text-yellow-600 mt-0.5"}),e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsx("p",{className:"font-medium",children:"처리 주의사항:"}),e.jsxs("ul",{className:"mt-1 space-y-1",children:[e.jsx("li",{children:"• 승인 시 외부 Invest API가 호출되어 실제 잔고가 변경됩니다."}),e.jsx("li",{children:"• 출금 승인 시 충분한 잔고가 있는지 확인해주세요."}),e.jsx("li",{children:"• 처리 후에는 취소할 수 없습니다."}),e.jsx("li",{children:"• 사용자에게 실시간 알림이 전송됩니다."})]})]})]})]}),e.jsxs(xe,{children:[e.jsx(o,{variant:"outline",onClick:()=>v(!1),children:"취소"}),e.jsxs(o,{variant:"destructive",onClick:()=>w("reject"),disabled:p===s?.id,children:[e.jsx(O,{className:"h-4 w-4 mr-2"}),"거절"]}),e.jsxs(o,{onClick:()=>w("approve"),disabled:p===s?.id,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(q,{className:"h-4 w-4 mr-2"}),"승인"]})]})]})})]})}export{Ne as TransactionApprovalManager,Ne as default};
