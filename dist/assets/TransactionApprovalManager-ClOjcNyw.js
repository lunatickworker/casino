import{v as Y,ax as Z,r as i,s as T,t as d,j as e,w as o,R as k,C as f,e as b,a as ee,b as se,m as ae,n as re,o as _,L as ne,B as A,H as te,ay as q,az as O,E as le,I as ie,a2 as P}from"./index-BWgbPZ4l.js";import{D as ce,a as oe,b as de,c as me,d as ue,e as xe}from"./dialog-B-V90Y16.js";import{C as pe}from"./clock-BQI8X08V.js";import{D as F}from"./dollar-sign-DTrUq9JA.js";import{T as he}from"./triangle-alert-BO-46YC8.js";function Ne({user:S}){const{connected:C,sendMessage:E}=Y(),{sendMessage:M}=Z(),[x,K]=i.useState([]),[$,B]=i.useState(!0),[p,L]=i.useState(null),[s,N]=i.useState(null),[z,v]=i.useState(!1),[y,R]=i.useState(""),[h,H]=i.useState("pending"),[m,U]=i.useState(!0),u=i.useCallback(async()=>{try{B(!0);let a=T.from("transactions").select(`
          *,
          users:user_id (
            username,
            nickname,
            balance,
            bank_name,
            bank_account,
            bank_holder,
            referrer_id,
            partners:referrer_id (
              opcode,
              secret_key,
              token
            )
          )
        `).order("request_time",{ascending:!1});h!=="all"&&(a=a.eq("status",h));const{data:n,error:r}=await a.limit(100);if(r)throw r;const c=n?.map(t=>({...t,user_id:t.user_id,username:t.users?.username||"ì•Œ ìˆ˜ ì—†ìŒ",nickname:t.users?.nickname||"ì•Œ ìˆ˜ ì—†ìŒ",current_balance:t.users?.balance||0,bank_info:{bank_name:t.users?.bank_name||"",bank_account:t.users?.bank_account||"",bank_holder:t.users?.bank_holder||""}}))||[];K(c),console.log(`ğŸ’° [ê±°ë˜ìŠ¹ì¸] ${h} ìƒíƒœ ê±°ë˜ ${c.length}ê±´ ì¡°íšŒ`),c.length>0&&console.log("ğŸ“Š [ê±°ë˜ ìƒ˜í”Œ]:",{transaction_id:c[0].id,user_id:c[0].user_id,username:c[0].username,has_user_id:!!c[0].user_id})}catch(a){console.error("ê±°ë˜ ìš”ì²­ ì¡°íšŒ ì‹¤íŒ¨:",a),d.error("ê±°ë˜ ìš”ì²­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")}finally{B(!1)}},[h]),w=async a=>{if(s)try{L(s.id),console.log(`ğŸ”„ [ê±°ë˜ì²˜ë¦¬] ${s.transaction_type} ${a} ì‹œì‘:`,{transactionId:s.id,username:s.username,amount:s.amount,currentBalance:s.current_balance});let n=null,r=s.current_balance;if(a==="approve"){let l=s.users?.partners?.opcode||"",j=s.users?.partners?.token||"",g=s.users?.partners?.secret_key||"";if(console.log("ğŸ” [íŒŒíŠ¸ë„ˆ ì •ë³´]:",{has_partners:!!s.users?.partners,has_opcode:!!l,has_token:!!j,has_secretKey:!!g,opcode_preview:l?`${l.substring(0,3)}...`:"NONE"}),!l||!j||!g){console.error("âŒ [íŒŒíŠ¸ë„ˆ ì •ë³´ ëˆ„ë½]:",{opcode:!!l,token:!!j,secretKey:!!g,referrer_id:s.users?.referrer_id}),d.error("íŒŒíŠ¸ë„ˆ API ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤. ì†Œì† íŒŒíŠ¸ë„ˆ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.");return}try{if(s.transaction_type==="deposit"?(console.log("ğŸ’° [API ì…ê¸ˆ] ì™¸ë¶€ API ì…ê¸ˆ ì²˜ë¦¬ ì‹œì‘"),n=await P.depositBalance(s.username,s.amount,l,j,g)):(console.log("ğŸ’¸ [API ì¶œê¸ˆ] ì™¸ë¶€ API ì¶œê¸ˆ ì²˜ë¦¬ ì‹œì‘"),n=await P.withdrawBalance(s.username,s.amount,l,j,g)),console.log("ğŸ“¡ [API ì‘ë‹µ]:",n),n.data&&!n.error)r=P.extractBalanceFromResponse(n.data,s.username),console.log(`âœ… [API ì„±ê³µ] ìƒˆë¡œìš´ ì”ê³ : ${r}`),(r===0||isNaN(r))&&console.warn("âš ï¸ [ì”ê³  ì¶”ì¶œ ê²½ê³ ] ì”ê³ ê°€ 0ì´ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:",{newBalance:r,apiData:n.data});else throw new Error(n.error||"API í˜¸ì¶œ ì‹¤íŒ¨")}catch(D){console.error("âŒ [API ì‹¤íŒ¨]:",D),d.error(`ì™¸ë¶€ API ${s.transaction_type==="deposit"?"ì…ê¸ˆ":"ì¶œê¸ˆ"} ì²˜ë¦¬ ì‹¤íŒ¨: ${D instanceof Error?D.message:"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}`);return}}const c=a==="approve"?"completed":"rejected",t={status:c,processed_at:new Date().toISOString(),processed_by:S?.username||"system",processing_note:y||null,external_transaction_id:n?.data?.transaction_id||n?.data?.id||null,updated_at:new Date().toISOString()};a==="approve"&&(t.balance_after=r);const{error:I}=await T.from("transactions").update(t).eq("id",s.id).eq("status","pending");if(I)throw console.error("âŒ [ê±°ë˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨]:",I),I;if(console.log(`âœ… [ê±°ë˜ ì—…ë°ì´íŠ¸ ì™„ë£Œ] ${s.id} -> ${c}`),a==="approve"){if(console.log("ğŸ’° [ì”ê³  ì—…ë°ì´íŠ¸ ì¤€ë¹„]:",{user_id:s.user_id,username:s.username,old_balance:s.current_balance,new_balance:r,has_user_id:!!s.user_id}),!s.user_id)throw console.error("âŒ [ì¹˜ëª…ì  ì˜¤ë¥˜] user_idê°€ ì—†ìŠµë‹ˆë‹¤!",s),new Error("user_idê°€ ì—†ì–´ ì”ê³ ë¥¼ ì—…ë°ì´íŠ¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");const{error:l}=await T.from("users").update({balance:r,updated_at:new Date().toISOString()}).eq("id",s.user_id);if(l)throw console.error("âŒ [ì”ê³  ì—…ë°ì´íŠ¸ ì‹¤íŒ¨]:",l),l;console.log(`âœ… [ì”ê³  ì—…ë°ì´íŠ¸ ì™„ë£Œ] ${s.username}: ${s.current_balance} -> ${r}`)}await M("transaction_processed",{transaction_id:s.id,username:s.username,transaction_type:s.transaction_type,amount:s.amount,action:a,newBalance:r,processedBy:S?.username||"system",note:y||null,target_user_id:s.user_id},1),C&&E&&E("transaction_processed",{transaction_id:s.id,username:s.username,user_id:s.user_id,transaction_type:s.transaction_type,amount:s.amount,action:a,newBalance:r,processedBy:S?.username||"system",note:y||null,timestamp:new Date().toISOString()});const G=a==="approve"?"ìŠ¹ì¸":"ê±°ì ˆ",J=s.transaction_type==="deposit"?"ì…ê¸ˆ":"ì¶œê¸ˆ";d.success(`${s.username}ë‹˜ì˜ ${J} ìš”ì²­ì´ ${G}ë˜ì—ˆìŠµë‹ˆë‹¤.`),v(!1),N(null),R(""),await u()}catch(n){console.error(`ê±°ë˜ ${a} ì²˜ë¦¬ ì‹¤íŒ¨:`,n);const r=n instanceof Error?n.message:String(n);r.includes("ê´€ë¦¬ì ë³´ìœ ê¸ˆ")||r.includes("ë³´ìœ ê¸ˆì´ ë¶€ì¡±")?d.error("âŒ ê´€ë¦¬ì ë³´ìœ ê¸ˆì´ ë¶€ì¡±í•˜ì—¬ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",{description:"ìƒìœ„ ê´€ë¦¬ìì—ê²Œ ë³´ìœ ê¸ˆì„ ìš”ì²­í•˜ì„¸ìš”.",duration:6e3}):r.includes("ë³´ìœ ê¸ˆ ê²€ì¦")?d.error("âŒ ë³´ìœ ê¸ˆ ê²€ì¦ ì‹¤íŒ¨",{description:r,duration:6e3}):d.error(`ê±°ë˜ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${r}`)}finally{L(null)}};i.useEffect(()=>{if(!m)return;const a=setInterval(()=>{console.log("ğŸ”„ [ìë™ìƒˆë¡œê³ ì¹¨] ê±°ë˜ ìš”ì²­ ëª©ë¡ ê°±ì‹ "),u()},3e4);return()=>clearInterval(a)},[m,u]),i.useEffect(()=>{u()},[u]);const W=a=>{switch(a){case"pending":return"bg-yellow-500";case"processing":return"bg-blue-500";case"approved":return"bg-green-500";case"completed":return"bg-green-600";case"rejected":return"bg-red-500";case"failed":return"bg-red-600";default:return"bg-gray-500"}},Q=a=>{switch(a){case"pending":return"ëŒ€ê¸°";case"processing":return"ì²˜ë¦¬ì¤‘";case"approved":return"ìŠ¹ì¸";case"completed":return"ì™„ë£Œ";case"rejected":return"ê±°ì ˆ";case"failed":return"ì‹¤íŒ¨";default:return a}},V=x.filter(a=>a.status==="pending").length,X=x.filter(a=>a.status==="processing").length;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-100",children:"ì…ì¶œê¸ˆ ìŠ¹ì¸ ê´€ë¦¬"}),e.jsx("p",{className:"text-sm text-slate-400",children:"ì‹¤ì‹œê°„ ì…ì¶œê¸ˆ ìš”ì²­ì„ ìŠ¹ì¸í•˜ê±°ë‚˜ ê±°ì ˆí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(o,{variant:"outline",onClick:()=>U(!m),className:m?"bg-green-50 border-green-200":"",children:[e.jsx(k,{className:`h-4 w-4 mr-2 ${m?"animate-spin":""}`}),"ìë™ìƒˆë¡œê³ ì¹¨ ",m?"ON":"OFF"]}),e.jsxs(o,{onClick:u,disabled:$,children:[e.jsx(k,{className:`h-4 w-4 mr-2 ${$?"animate-spin":""}`}),"ìƒˆë¡œê³ ì¹¨"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(f,{className:"border-yellow-200 bg-yellow-50",children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-yellow-700",children:"ëŒ€ê¸° ì¤‘"}),e.jsx("p",{className:"text-2xl font-bold text-yellow-800",children:V})]}),e.jsx(pe,{className:"h-8 w-8 text-yellow-600"})]})})}),e.jsx(f,{className:"border-blue-200 bg-blue-50",children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-blue-700",children:"ì²˜ë¦¬ ì¤‘"}),e.jsx("p",{className:"text-2xl font-bold text-blue-800",children:X})]}),e.jsx(k,{className:"h-8 w-8 text-blue-600 animate-spin"})]})})}),e.jsx(f,{className:"border-green-200 bg-green-50",children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-green-700",children:"ì´ ê±°ë˜"}),e.jsx("p",{className:"text-2xl font-bold text-green-800",children:x.length})]}),e.jsx(F,{className:"h-8 w-8 text-green-600"})]})})}),e.jsx(f,{className:"border-gray-200 bg-gray-50",children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-700",children:"ì—°ê²° ìƒíƒœ"}),e.jsx("p",{className:"text-sm font-semibold text-gray-800",children:C?"ğŸŸ¢ ì—°ê²°ë¨":"ğŸ”´ ì—°ê²°ëŠê¹€"})]}),e.jsx("div",{className:`h-4 w-4 rounded-full ${C?"bg-green-400":"bg-red-400"} animate-pulse`})]})})})]}),e.jsxs(f,{children:[e.jsx(ee,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(se,{children:"ê±°ë˜ ìš”ì²­ ëª©ë¡"}),e.jsx(ae,{value:h,onValueChange:H,children:e.jsxs(re,{children:[e.jsx(_,{value:"pending",children:"ëŒ€ê¸°ì¤‘"}),e.jsx(_,{value:"processing",children:"ì²˜ë¦¬ì¤‘"}),e.jsx(_,{value:"approved",children:"ìŠ¹ì¸ë¨"}),e.jsx(_,{value:"rejected",children:"ê±°ì ˆë¨"}),e.jsx(_,{value:"all",children:"ì „ì²´"})]})})]})}),e.jsx(b,{children:$?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(ne,{}),e.jsx("span",{className:"ml-2",children:"ê±°ë˜ ìš”ì²­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."})]}):e.jsx("div",{className:"space-y-4",children:x.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(F,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"ê±°ë˜ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤."})]}):x.map(a=>e.jsx("div",{className:"p-4 border rounded-lg hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:`h-3 w-3 rounded-full ${W(a.status)}`}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:a.nickname}),e.jsx(A,{variant:"outline",className:"text-xs",children:a.username}),e.jsx(A,{variant:a.transaction_type==="deposit"?"default":"destructive",children:a.transaction_type==="deposit"?"ğŸ’° ì…ê¸ˆ":"ğŸ’¸ ì¶œê¸ˆ"})]}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:[new Date(a.request_time).toLocaleString("ko-KR")," Â· í˜„ì¬ì”ê³ : ",a.current_balance.toLocaleString(),"ì›"]}),a.bank_info?.bank_name&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[a.bank_info.bank_name," ",a.bank_info.bank_account," (",a.bank_info.bank_holder,")"]})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:`text-lg font-bold ${a.transaction_type==="deposit"?"text-green-600":"text-red-600"}`,children:[a.transaction_type==="deposit"?"+":"-",a.amount.toLocaleString(),"ì›"]}),e.jsx("div",{className:"text-sm text-gray-500",children:Q(a.status)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(o,{variant:"outline",size:"sm",onClick:()=>{N(a),v(!0)},children:e.jsx(te,{className:"h-4 w-4"})}),a.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsxs(o,{size:"sm",onClick:()=>{N(a),w("approve")},disabled:p===a.id,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(q,{className:"h-4 w-4 mr-1"}),"ìŠ¹ì¸"]}),e.jsxs(o,{variant:"destructive",size:"sm",onClick:()=>{N(a),w("reject")},disabled:p===a.id,children:[e.jsx(O,{className:"h-4 w-4 mr-1"}),"ê±°ì ˆ"]})]}),p===a.id&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{className:"text-sm",children:"ì²˜ë¦¬ì¤‘..."})]})]})]})]})},a.id))})})]}),e.jsx(ce,{open:z,onOpenChange:v,children:e.jsxs(oe,{className:"sm:max-w-[600px]",children:[e.jsxs(de,{children:[e.jsx(me,{children:"ê±°ë˜ ìš”ì²­ ì²˜ë¦¬"}),e.jsx(ue,{children:"ì„ íƒí•œ ê±°ë˜ ìš”ì²­ì„ ìŠ¹ì¸í•˜ê±°ë‚˜ ê±°ì ˆí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."})]}),s&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium",children:"ìš”ì²­ì:"}),e.jsxs("span",{children:[s.nickname," (",s.username,")"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium",children:"ê±°ë˜ ìœ í˜•:"}),e.jsx(A,{variant:s.transaction_type==="deposit"?"default":"destructive",children:s.transaction_type==="deposit"?"ì…ê¸ˆ":"ì¶œê¸ˆ"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium",children:"ìš”ì²­ ê¸ˆì•¡:"}),e.jsxs("span",{className:`font-bold ${s.transaction_type==="deposit"?"text-green-600":"text-red-600"}`,children:[s.transaction_type==="deposit"?"+":"-",s.amount.toLocaleString(),"ì›"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium",children:"í˜„ì¬ ì”ê³ :"}),e.jsxs("span",{className:"font-mono",children:[s.current_balance.toLocaleString(),"ì›"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium",children:"ìš”ì²­ ì‹œê°„:"}),e.jsx("span",{children:new Date(s.request_time).toLocaleString("ko-KR")})]}),s.bank_info?.bank_name&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium",children:"ì€í–‰ ì •ë³´:"}),e.jsxs("span",{className:"text-sm",children:[s.bank_info.bank_name," ",s.bank_info.bank_account,e.jsx("br",{}),"(",s.bank_info.bank_holder,")"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(le,{htmlFor:"processing-note",children:"ì²˜ë¦¬ ë©”ëª¨ (ì„ íƒì‚¬í•­)"}),e.jsx(ie,{id:"processing-note",value:y,onChange:a=>R(a.target.value),placeholder:"ì²˜ë¦¬ ì‚¬ìœ ë‚˜ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"})]}),e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:[e.jsx(he,{className:"h-5 w-5 text-yellow-600 mt-0.5"}),e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsx("p",{className:"font-medium",children:"ì²˜ë¦¬ ì£¼ì˜ì‚¬í•­:"}),e.jsxs("ul",{className:"mt-1 space-y-1",children:[e.jsx("li",{children:"â€¢ ìŠ¹ì¸ ì‹œ ì™¸ë¶€ Invest APIê°€ í˜¸ì¶œë˜ì–´ ì‹¤ì œ ì”ê³ ê°€ ë³€ê²½ë©ë‹ˆë‹¤."}),e.jsx("li",{children:"â€¢ ì¶œê¸ˆ ìŠ¹ì¸ ì‹œ ì¶©ë¶„í•œ ì”ê³ ê°€ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”."}),e.jsx("li",{children:"â€¢ ì²˜ë¦¬ í›„ì—ëŠ” ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}),e.jsx("li",{children:"â€¢ ì‚¬ìš©ìì—ê²Œ ì‹¤ì‹œê°„ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤."})]})]})]})]}),e.jsxs(xe,{children:[e.jsx(o,{variant:"outline",onClick:()=>v(!1),children:"ì·¨ì†Œ"}),e.jsxs(o,{variant:"destructive",onClick:()=>w("reject"),disabled:p===s?.id,children:[e.jsx(O,{className:"h-4 w-4 mr-2"}),"ê±°ì ˆ"]}),e.jsxs(o,{onClick:()=>w("approve"),disabled:p===s?.id,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(q,{className:"h-4 w-4 mr-2"}),"ìŠ¹ì¸"]})]})]})})]})}export{Ne as TransactionApprovalManager,Ne as default};
