-- ============================================================================
-- 158. Ï¢ÖÌï© RLS Ï†êÍ≤Ä Î∞è ÏàòÏ†ï (Ï†ÑÏ≤¥ ÏãúÏä§ÌÖú - ÏïàÏ†Ñ Î≤ÑÏ†Ñ)
-- ============================================================================
-- ÏûëÏÑ±Ïùº: 2025-10-10
-- Î™©Ï†Å: Î™®Îì† ÏãúÏä§ÌÖú ÌÖåÏù¥Î∏îÏùò RLS Ï†ïÏ±Ö Ï†êÍ≤Ä Î∞è ÏàòÏ†ï
-- Í∑ºÍ±∞: Ïô∏Î∂Ä API Ïó∞Îèô Î∞è ÏãúÏä§ÌÖú ÏûêÎèô Ï≤òÎ¶¨ ÌÖåÏù¥Î∏îÏùÄ RLSÎ•º ÎπÑÌôúÏÑ±ÌôîÌï¥Ïïº Ìï®
-- ============================================================================

-- ============================================
-- 1Îã®Í≥Ñ: Î™®Îì† RLS Ï†ïÏ±Ö ÏÇ≠Ï†ú
-- ============================================
DO $$
DECLARE
    v_pol RECORD;
    v_total_deleted INTEGER := 0;
BEGIN
    RAISE NOTICE '';
    RAISE NOTICE '========================================';
    RAISE NOTICE 'üóëÔ∏è  Î™®Îì† RLS Ï†ïÏ±Ö ÏÇ≠Ï†ú ÏãúÏûë...';
    RAISE NOTICE '========================================';
    RAISE NOTICE '';
    
    -- Î™®Îì† ÌÖåÏù¥Î∏îÏùò Î™®Îì† Ï†ïÏ±Ö ÏÇ≠Ï†ú
    FOR v_pol IN 
        SELECT schemaname, tablename, policyname 
        FROM pg_policies 
        WHERE schemaname = 'public'
    LOOP
        EXECUTE format('DROP POLICY IF EXISTS %I ON %I.%I', 
            v_pol.policyname, v_pol.schemaname, v_pol.tablename);
        v_total_deleted := v_total_deleted + 1;
        RAISE NOTICE '   ÏÇ≠Ï†ú: %.%', v_pol.tablename, v_pol.policyname;
    END LOOP;
    
    RAISE NOTICE '';
    IF v_total_deleted > 0 THEN
        RAISE NOTICE '‚úÖ Ï¥ù %Í∞úÏùò Ï†ïÏ±Ö ÏÇ≠Ï†ú ÏôÑÎ£å', v_total_deleted;
    ELSE
        RAISE NOTICE '‚úÖ ÏÇ≠Ï†úÌï† Ï†ïÏ±ÖÏù¥ ÏóÜÏäµÎãàÎã§';
    END IF;
    RAISE NOTICE '';
END $$;

-- ============================================
-- 2Îã®Í≥Ñ: Î™®Îì† ÌÖåÏù¥Î∏î RLS ÎπÑÌôúÏÑ±Ìôî (Î∑∞ Ï†úÏô∏)
-- ============================================
DO $$
DECLARE
    v_table RECORD;
    v_disabled_count INTEGER := 0;
    v_skipped_count INTEGER := 0;
BEGIN
    RAISE NOTICE '========================================';
    RAISE NOTICE 'üîì RLS ÎπÑÌôúÏÑ±Ìôî ÏãúÏûë...';
    RAISE NOTICE '========================================';
    RAISE NOTICE '';
    
    -- Î™®Îì† ÌÖåÏù¥Î∏î Ï°∞Ìöå (Î∑∞ Ï†úÏô∏)
    FOR v_table IN
        SELECT tablename
        FROM pg_tables
        WHERE schemaname = 'public'
        ORDER BY tablename
    LOOP
        BEGIN
            EXECUTE format('ALTER TABLE %I DISABLE ROW LEVEL SECURITY', v_table.tablename);
            v_disabled_count := v_disabled_count + 1;
            RAISE NOTICE '   ‚úì %', v_table.tablename;
        EXCEPTION WHEN OTHERS THEN
            v_skipped_count := v_skipped_count + 1;
            RAISE NOTICE '   ‚äò % (Ïä§ÌÇµ: %)', v_table.tablename, SQLERRM;
        END;
    END LOOP;
    
    RAISE NOTICE '';
    RAISE NOTICE '‚úÖ %Í∞ú ÌÖåÏù¥Î∏î RLS ÎπÑÌôúÏÑ±Ìôî ÏôÑÎ£å', v_disabled_count;
    IF v_skipped_count > 0 THEN
        RAISE NOTICE '‚äò  %Í∞ú ÌÖåÏù¥Î∏î Ïä§ÌÇµ', v_skipped_count;
    END IF;
    RAISE NOTICE '';
END $$;

-- ============================================
-- 3Îã®Í≥Ñ: NOT NULL Ï†úÏïΩÏ°∞Í±¥ Ï†úÍ±∞
-- ============================================
DO $$
DECLARE
    v_constraint_removed INTEGER := 0;
BEGIN
    RAISE NOTICE '========================================';
    RAISE NOTICE 'üîß NOT NULL Ï†úÏïΩÏ°∞Í±¥ Ï†úÍ±∞...';
    RAISE NOTICE '========================================';
    RAISE NOTICE '';
    
    -- game_records
    BEGIN
        ALTER TABLE game_records ALTER COLUMN partner_id DROP NOT NULL;
        v_constraint_removed := v_constraint_removed + 1;
        RAISE NOTICE '   ‚úì game_records.partner_id ‚Üí nullable';
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    BEGIN
        ALTER TABLE game_records ALTER COLUMN user_id DROP NOT NULL;
        v_constraint_removed := v_constraint_removed + 1;
        RAISE NOTICE '   ‚úì game_records.user_id ‚Üí nullable';
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    -- game_launch_sessions
    BEGIN
        ALTER TABLE game_launch_sessions ALTER COLUMN user_id DROP NOT NULL;
        v_constraint_removed := v_constraint_removed + 1;
        RAISE NOTICE '   ‚úì game_launch_sessions.user_id ‚Üí nullable';
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    -- betting_sync_logs
    BEGIN
        ALTER TABLE betting_sync_logs ALTER COLUMN partner_id DROP NOT NULL;
        v_constraint_removed := v_constraint_removed + 1;
        RAISE NOTICE '   ‚úì betting_sync_logs.partner_id ‚Üí nullable';
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    -- transactions
    BEGIN
        ALTER TABLE transactions ALTER COLUMN user_id DROP NOT NULL;
        v_constraint_removed := v_constraint_removed + 1;
        RAISE NOTICE '   ‚úì transactions.user_id ‚Üí nullable';
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    BEGIN
        ALTER TABLE transactions ALTER COLUMN processed_by DROP NOT NULL;
        v_constraint_removed := v_constraint_removed + 1;
        RAISE NOTICE '   ‚úì transactions.processed_by ‚Üí nullable';
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    -- user_sessions
    BEGIN
        ALTER TABLE user_sessions ALTER COLUMN user_id DROP NOT NULL;
        v_constraint_removed := v_constraint_removed + 1;
        RAISE NOTICE '   ‚úì user_sessions.user_id ‚Üí nullable';
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    -- point_transactions
    BEGIN
        ALTER TABLE point_transactions ALTER COLUMN user_id DROP NOT NULL;
        v_constraint_removed := v_constraint_removed + 1;
        RAISE NOTICE '   ‚úì point_transactions.user_id ‚Üí nullable';
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    RAISE NOTICE '';
    RAISE NOTICE '‚úÖ %Í∞ú NOT NULL Ï†úÏïΩ Ï†úÍ±∞ ÏãúÎèÑ', v_constraint_removed;
    RAISE NOTICE '';
END $$;

-- ============================================
-- 4Îã®Í≥Ñ: ÏÑ±Îä• ÏµúÏ†ÅÌôî Ïù∏Îç±Ïä§ ÏÉùÏÑ±
-- ============================================
DO $$
DECLARE
    v_index_count INTEGER := 0;
BEGIN
    RAISE NOTICE '========================================';
    RAISE NOTICE '‚ö° ÏÑ±Îä• ÏµúÏ†ÅÌôî Ïù∏Îç±Ïä§ ÏÉùÏÑ±...';
    RAISE NOTICE '========================================';
    RAISE NOTICE '';
    
    -- game_records Ïù∏Îç±Ïä§
    BEGIN
        CREATE INDEX IF NOT EXISTS idx_game_records_external_txid 
        ON game_records(external_txid) WHERE external_txid IS NOT NULL;
        v_index_count := v_index_count + 1;
        RAISE NOTICE '   ‚úì game_records.external_txid';
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    BEGIN
        CREATE INDEX IF NOT EXISTS idx_game_records_user_id 
        ON game_records(user_id) WHERE user_id IS NOT NULL;
        v_index_count := v_index_count + 1;
        RAISE NOTICE '   ‚úì game_records.user_id';
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    BEGIN
        CREATE INDEX IF NOT EXISTS idx_game_records_created_at 
        ON game_records(created_at DESC);
        v_index_count := v_index_count + 1;
        RAISE NOTICE '   ‚úì game_records.created_at';
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    BEGIN
        CREATE INDEX IF NOT EXISTS idx_game_records_partner_id 
        ON game_records(partner_id) WHERE partner_id IS NOT NULL;
        v_index_count := v_index_count + 1;
        RAISE NOTICE '   ‚úì game_records.partner_id';
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    -- transactions Ïù∏Îç±Ïä§
    BEGIN
        CREATE INDEX IF NOT EXISTS idx_transactions_user_id 
        ON transactions(user_id) WHERE user_id IS NOT NULL;
        v_index_count := v_index_count + 1;
        RAISE NOTICE '   ‚úì transactions.user_id';
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    BEGIN
        CREATE INDEX IF NOT EXISTS idx_transactions_status 
        ON transactions(status) WHERE status IS NOT NULL;
        v_index_count := v_index_count + 1;
        RAISE NOTICE '   ‚úì transactions.status';
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    BEGIN
        CREATE INDEX IF NOT EXISTS idx_transactions_created_at 
        ON transactions(created_at DESC);
        v_index_count := v_index_count + 1;
        RAISE NOTICE '   ‚úì transactions.created_at';
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    -- users Ïù∏Îç±Ïä§
    BEGIN
        CREATE INDEX IF NOT EXISTS idx_users_username 
        ON users(username);
        v_index_count := v_index_count + 1;
        RAISE NOTICE '   ‚úì users.username';
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    BEGIN
        CREATE INDEX IF NOT EXISTS idx_users_referrer_id 
        ON users(referrer_id) WHERE referrer_id IS NOT NULL;
        v_index_count := v_index_count + 1;
        RAISE NOTICE '   ‚úì users.referrer_id';
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    -- partners Ïù∏Îç±Ïä§
    BEGIN
        CREATE INDEX IF NOT EXISTS idx_partners_parent_id 
        ON partners(parent_id) WHERE parent_id IS NOT NULL;
        v_index_count := v_index_count + 1;
        RAISE NOTICE '   ‚úì partners.parent_id';
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    BEGIN
        CREATE INDEX IF NOT EXISTS idx_partners_level 
        ON partners(level);
        v_index_count := v_index_count + 1;
        RAISE NOTICE '   ‚úì partners.level';
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    BEGIN
        CREATE INDEX IF NOT EXISTS idx_partners_opcode 
        ON partners(opcode) WHERE opcode IS NOT NULL;
        v_index_count := v_index_count + 1;
        RAISE NOTICE '   ‚úì partners.opcode';
    EXCEPTION WHEN OTHERS THEN
        NULL;
    END;
    
    RAISE NOTICE '';
    RAISE NOTICE '‚úÖ Ïù∏Îç±Ïä§ ÏÉùÏÑ± ÏôÑÎ£å (%Í∞ú)', v_index_count;
    RAISE NOTICE '';
END $$;

-- ============================================
-- 5Îã®Í≥Ñ: SECURITY DEFINER Ìï®Ïàò ÏÉùÏÑ±
-- ============================================

-- 5.1 save_betting_records_from_api
CREATE OR REPLACE FUNCTION save_betting_records_from_api(p_records JSONB)
RETURNS TABLE (
    success BOOLEAN,
    saved_count INTEGER,
    skipped_count INTEGER,
    error_count INTEGER,
    errors TEXT[]
) 
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_record JSONB;
    v_saved INTEGER := 0;
    v_skipped INTEGER := 0;
    v_error INTEGER := 0;
    v_errors TEXT[] := '{}';
    v_external_txid TEXT;
    v_user_id UUID;
    v_partner_id UUID;
    v_error_msg TEXT;
BEGIN
    FOR v_record IN SELECT * FROM jsonb_array_elements(p_records)
    LOOP
        BEGIN
            v_external_txid := v_record->>'txid';
            
            -- Ï§ëÎ≥µ Ï≤¥ÌÅ¨
            IF EXISTS (SELECT 1 FROM game_records WHERE external_txid = v_external_txid) THEN
                v_skipped := v_skipped + 1;
                CONTINUE;
            END IF;
            
            -- user_id, partner_idÎäî NULL ÌóàÏö©
            v_user_id := NULL;
            v_partner_id := NULL;
            
            -- Î≤†ÌåÖ Î†àÏΩîÎìú ÏÇΩÏûÖ
            INSERT INTO game_records (
                external_txid, user_id, partner_id,
                provider_id, game_id, game_name,
                bet_amount, win_amount, profit_loss,
                currency, status, round_id, session_id,
                game_start_time, game_end_time,
                created_at, updated_at
            ) VALUES (
                v_external_txid, v_user_id, v_partner_id,
                COALESCE((v_record->>'provider_id')::INTEGER, 0),
                COALESCE(v_record->>'game_id', 'unknown'),
                COALESCE(v_record->>'game_name', 'Unknown Game'),
                COALESCE((v_record->>'bet_amount')::DECIMAL, 0),
                COALESCE((v_record->>'win_amount')::DECIMAL, 0),
                COALESCE((v_record->>'profit_loss')::DECIMAL, 0),
                COALESCE(v_record->>'currency', 'KRW'),
                COALESCE(v_record->>'status', 'completed'),
                v_record->>'round_id',
                v_record->>'session_id',
                CASE WHEN v_record->>'game_start_time' IS NOT NULL 
                     THEN (v_record->>'game_start_time')::TIMESTAMPTZ ELSE NOW() END,
                CASE WHEN v_record->>'game_end_time' IS NOT NULL 
                     THEN (v_record->>'game_end_time')::TIMESTAMPTZ ELSE NOW() END,
                NOW(), NOW()
            );
            
            v_saved := v_saved + 1;
            
        EXCEPTION WHEN OTHERS THEN
            v_error := v_error + 1;
            v_error_msg := 'TX ' || COALESCE(v_external_txid, 'NULL') || ': ' || SQLERRM;
            v_errors := array_append(v_errors, v_error_msg);
        END;
    END LOOP;
    
    RETURN QUERY SELECT TRUE, v_saved, v_skipped, v_error, v_errors;
END;
$$;

-- 5.2 save_game_session
CREATE OR REPLACE FUNCTION save_game_session(
    p_session_id TEXT,
    p_user_id UUID,
    p_username TEXT,
    p_game_id TEXT,
    p_provider_id INTEGER,
    p_launch_url TEXT DEFAULT NULL
)
RETURNS UUID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_id UUID;
BEGIN
    INSERT INTO game_launch_sessions (
        session_id, user_id, username, game_id, provider_id,
        launch_url, status, created_at, updated_at
    ) VALUES (
        p_session_id, p_user_id, p_username, p_game_id, p_provider_id,
        p_launch_url, 'active', NOW(), NOW()
    )
    ON CONFLICT (session_id) DO UPDATE SET
        updated_at = NOW(),
        status = 'active'
    RETURNING id INTO v_id;
    
    RETURN v_id;
END;
$$;

-- 5.3 update_game_session_status
CREATE OR REPLACE FUNCTION update_game_session_status(
    p_session_id TEXT,
    p_status TEXT,
    p_ended_at TIMESTAMPTZ DEFAULT NULL
)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    UPDATE game_launch_sessions
    SET 
        status = p_status,
        ended_at = COALESCE(p_ended_at, NOW()),
        updated_at = NOW()
    WHERE session_id = p_session_id;
    
    RETURN FOUND;
END;
$$;

-- 5.4 log_game_sync
CREATE OR REPLACE FUNCTION log_game_sync(
    p_sync_type TEXT,
    p_provider_id INTEGER DEFAULT NULL,
    p_records_count INTEGER DEFAULT 0,
    p_success BOOLEAN DEFAULT TRUE,
    p_error_message TEXT DEFAULT NULL
)
RETURNS UUID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_id UUID;
BEGIN
    INSERT INTO game_sync_logs (
        sync_type, provider_id, records_count,
        success, error_message, created_at
    ) VALUES (
        p_sync_type, p_provider_id, p_records_count,
        p_success, p_error_message, NOW()
    )
    RETURNING id INTO v_id;
    
    RETURN v_id;
END;
$$;

-- Ìï®Ïàò Í∂åÌïú Î∂ÄÏó¨
GRANT EXECUTE ON FUNCTION save_betting_records_from_api(JSONB) TO authenticated, anon;
GRANT EXECUTE ON FUNCTION save_game_session(TEXT, UUID, TEXT, TEXT, INTEGER, TEXT) TO authenticated, anon;
GRANT EXECUTE ON FUNCTION update_game_session_status(TEXT, TEXT, TIMESTAMPTZ) TO authenticated, anon;
GRANT EXECUTE ON FUNCTION log_game_sync(TEXT, INTEGER, INTEGER, BOOLEAN, TEXT) TO authenticated, anon;

-- ============================================
-- ÏôÑÎ£å Î©îÏãúÏßÄ
-- ============================================
DO $$
BEGIN
    RAISE NOTICE '';
    RAISE NOTICE '========================================';
    RAISE NOTICE 'üéâ Ï¢ÖÌï© RLS Ï†êÍ≤Ä Î∞è ÏàòÏ†ï ÏôÑÎ£å!';
    RAISE NOTICE '========================================';
    RAISE NOTICE '';
    RAISE NOTICE 'Ï†ÅÏö©Îêú Î≥ÄÍ≤ΩÏÇ¨Ìï≠:';
    RAISE NOTICE '  ‚úì Î™®Îì† RLS Ï†ïÏ±Ö Ï†úÍ±∞';
    RAISE NOTICE '  ‚úì Î™®Îì† ÌÖåÏù¥Î∏î RLS ÎπÑÌôúÏÑ±Ìôî';
    RAISE NOTICE '  ‚úì NOT NULL Ï†úÏïΩ Ï†úÍ±∞';
    RAISE NOTICE '  ‚úì ÏÑ±Îä• Ïù∏Îç±Ïä§ ÏÉùÏÑ±';
    RAISE NOTICE '  ‚úì SECURITY DEFINER Ìï®Ïàò ÏÉùÏÑ±';
    RAISE NOTICE '';
    RAISE NOTICE 'Ïù¥Ï†ú Îã§Ïùå Í∏∞Îä•Ïù¥ Ï†ïÏÉÅ ÎèôÏûëÌï©ÎãàÎã§:';
    RAISE NOTICE '  ‚Ä¢ Î≤†ÌåÖÎÇ¥Ïó≠ Ï†ÄÏû• Î∞è Ï°∞Ìöå';
    RAISE NOTICE '  ‚Ä¢ Í≤åÏûÑ ÏÑ∏ÏÖò Ï∂îÏ†Å';
    RAISE NOTICE '  ‚Ä¢ API ÎèôÍ∏∞Ìôî Î°úÍ∑∏';
    RAISE NOTICE '  ‚Ä¢ ÏûÖÏ∂úÍ∏à Ìä∏ÎûúÏû≠ÏÖò Ï≤òÎ¶¨';
    RAISE NOTICE '  ‚Ä¢ ÏÇ¨Ïö©Ïûê/ÌååÌä∏ÎÑà Í¥ÄÎ¶¨';
    RAISE NOTICE '';
    RAISE NOTICE '========================================';
    RAISE NOTICE '';
END $$;
