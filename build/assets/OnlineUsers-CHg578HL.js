import{k as v,r as l,s as o,j as e,w as x,R as N,Y as S,t as d,B as I,Z as P}from"./index-DlK2WquE.js";import{D as E}from"./DataTable-DShsxcsG.js";import{A as K,a as O,b as U,c as z,d as W,e as G}from"./AdminDialog-e_e5blH4.js";import{M as g}from"./MetricCard-C4Jq9Aol.js";import{W as F}from"./wifi-DdiMjzIn.js";import{C}from"./clock-BsgtTRc8.js";import"./search-BrsHMGhG.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const H=[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]],Y=v("map-pin",H);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=[["path",{d:"M12 2v10",key:"mnfbl"}],["path",{d:"M18.4 6.6a9 9 0 1 1-12.77.04",key:"obofu9"}]],J=v("power",Z);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q=[["rect",{width:"14",height:"20",x:"5",y:"2",rx:"2",ry:"2",key:"1yt0o3"}],["path",{d:"M12 18h.01",key:"mhygvu"}]],V=v("smartphone",Q);function ce({user:t}){const[i,D]=l.useState([]),[$,b]=l.useState(!0),[f,y]=l.useState(null),[M,p]=l.useState(!1),[w,k]=l.useState(null),m=l.useRef(null),u=async(a=!1)=>{try{a&&b(!0);let s=[];t.level!==1&&(s=await B(t.id));let n=o.from("game_launch_sessions").select(`
          id,
          user_id,
          game_id,
          status,
          launched_at,
          last_activity_at,
          balance_before,
          users!inner (
            id,
            username,
            nickname,
            balance,
            vip_level,
            referrer_id,
            partners!users_referrer_id_fkey (
              id,
              nickname
            )
          ),
          games (
            name,
            game_providers (
              name
            )
          )
        `).eq("status","online").order("launched_at",{ascending:!1});if(t.level!==1)if(s.length===0)n=n.eq("users.referrer_id",t.id);else{const r=[t.id,...s];n=n.in("users.referrer_id",r)}const{data:c,error:h}=await n;if(h)throw h;const j=(c||[]).map(r=>({session_id:r.id,user_id:r.users.id,username:r.users.username,nickname:r.users.nickname||r.users.username,partner_nickname:r.users.partners?.nickname||"-",game_name:r.games?.name||"Unknown Game",provider_name:r.games?.game_providers?.name||"Unknown",balance_before:r.balance_before||0,current_balance:r.users.balance||0,vip_level:r.users.vip_level||0,device_type:"Web",ip_address:"-",location:"-",launched_at:r.launched_at,last_activity:r.last_activity_at||r.launched_at}));D(j)}catch(s){console.error("ì˜¨ë¼ì¸ ì„¸ì…˜ ë¡œë“œ ì˜¤ë¥˜:",s),a&&d.error("ì˜¨ë¼ì¸ í˜„í™©ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")}finally{a&&b(!1)}},B=async a=>{const s=[],n=[a];for(;n.length>0;){const c=n.shift(),{data:h,error:j}=await o.from("partners").select("id").eq("parent_id",c);if(!j&&h)for(const r of h)s.push(r.id),n.push(r.id)}return s},T=async a=>{try{k(a.user_id);const s=await(void 0)(t.id),n=await P(s.opcode,a.username,s.token,s.secret_key);if(n&&n.balance!==void 0){const{error:c}=await o.from("users").update({balance:n.balance}).eq("id",a.user_id);if(c)throw c;d.success(`${a.nickname}ì˜ ë³´ìœ ê¸ˆì´ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤`),u()}else d.error("ë³´ìœ ê¸ˆ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤")}catch(s){console.error("ë³´ìœ ê¸ˆ ë™ê¸°í™” ì˜¤ë¥˜:",s),d.error("ë³´ìœ ê¸ˆ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤")}finally{k(null)}},q=async()=>{if(f)try{const{error:a}=await o.from("game_launch_sessions").update({status:"ended",ended_at:new Date().toISOString()}).eq("id",f.session_id);if(a)throw a;d.success(`${f.nickname}ì˜ ì„¸ì…˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤`),p(!1),y(null),u()}catch(a){console.error("ì„¸ì…˜ ì¢…ë£Œ ì˜¤ë¥˜:",a),d.error("ì„¸ì…˜ ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤")}};l.useEffect(()=>{u(!0)},[t.id]),l.useEffect(()=>{console.log("ðŸ”” Realtime êµ¬ë… ì‹œìž‘: game_launch_sessions");const a=o.channel("online-users-realtime").on("postgres_changes",{event:"*",schema:"public",table:"game_launch_sessions"},s=>{console.log("ðŸ”” game_launch_sessions ë³€ê²½ ê°ì§€:",s),m.current&&clearTimeout(m.current),m.current=setTimeout(()=>{u()},500)}).subscribe();return()=>{o.removeChannel(a),m.current&&clearTimeout(m.current)}},[t.id]);const A=a=>{const s=Math.floor((Date.now()-new Date(a).getTime())/1e3/60);if(s<60)return`${s}ë¶„`;const n=Math.floor(s/60),c=s%60;return`${n}ì‹œê°„ ${c}ë¶„`},L=i.reduce((a,s)=>a+s.current_balance,0),_=i.reduce((a,s)=>a+(s.current_balance-s.balance_before),0),R=[{header:"ì‚¬ìš©ìž",cell:a=>e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:a.username}),e.jsx(I,{variant:"outline",className:"text-xs",children:a.nickname})]}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["ì†Œì†: ",a.partner_nickname]})]})},{header:"ê²Œìž„",cell:a=>e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-sm",children:a.game_name}),e.jsx("span",{className:"text-xs text-muted-foreground",children:a.provider_name})]})},{header:"ê²Œìž„ ì‹œìž‘ê¸ˆ",cell:a=>e.jsxs("span",{children:["â‚©",a.balance_before.toLocaleString()]})},{header:"í˜„ìž¬ ë³´ìœ ê¸ˆ",cell:a=>{const s=a.current_balance-a.balance_before;return e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("span",{children:["â‚©",a.current_balance.toLocaleString()]}),e.jsxs("span",{className:`text-xs ${s>=0?"text-green-500":"text-red-500"}`,children:[s>=0?"+":"",s.toLocaleString()]})]})}},{header:"ì ‘ì† ì •ë³´",cell:a=>e.jsxs("div",{className:"flex flex-col gap-1 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Y,{className:"h-3 w-3"}),e.jsx("span",{children:a.location})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(V,{className:"h-3 w-3"}),e.jsx("span",{children:a.ip_address})]})]})},{header:"ì„¸ì…˜ ì‹œê°„",cell:a=>e.jsxs("div",{className:"flex items-center gap-1 text-xs",children:[e.jsx(C,{className:"h-3 w-3"}),e.jsx("span",{children:A(a.launched_at)})]})},{header:"ê´€ë¦¬",cell:a=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(x,{size:"sm",variant:"outline",onClick:()=>T(a),disabled:w===a.user_id,children:e.jsx(N,{className:`h-3 w-3 ${w===a.user_id?"animate-spin":""}`})}),e.jsx(x,{size:"sm",variant:"destructive",onClick:()=>{y(a),p(!0)},children:e.jsx(J,{className:"h-3 w-3"})})]})}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl",children:"ì˜¨ë¼ì¸ í˜„í™©"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"ì‹¤ì‹œê°„ ê²Œìž„ ì¤‘ì¸ ì‚¬ìš©ìž í˜„í™©"})]}),e.jsxs(x,{onClick:()=>u(!0),variant:"outline",children:[e.jsx(N,{className:"h-4 w-4 mr-2"}),"ìƒˆë¡œê³ ì¹¨"]})]}),e.jsxs("div",{className:"grid gap-5 md:grid-cols-2 lg:grid-cols-4",children:[e.jsx(g,{title:"ì˜¨ë¼ì¸ ì‚¬ìš©ìž",value:`${i.length}ëª…`,subtitle:"í˜„ìž¬ ê²Œìž„ ì¤‘",icon:F,color:"purple"}),e.jsx(g,{title:"ì´ ê²Œìž„ ë³´ìœ ê¸ˆ",value:`â‚©${L.toLocaleString()}`,subtitle:"ì „ì²´ ê²Œìž„ ì¤‘ ë³´ìœ ê¸ˆ",icon:S,color:"pink"}),e.jsx(g,{title:"ì´ ì†ìµ",value:`${_>=0?"+":""}â‚©${_.toLocaleString()}`,subtitle:"ê²Œìž„ ì‹œìž‘ ëŒ€ë¹„",icon:S,color:_>=0?"green":"red"}),e.jsx(g,{title:"í‰ê·  ì„¸ì…˜",value:i.length>0?`${Math.floor(i.reduce((a,s)=>a+(Date.now()-new Date(s.launched_at).getTime()),0)/i.length/1e3/60)}ë¶„`:"0ë¶„",subtitle:"í‰ê·  ê²Œìž„ ì‹œê°„",icon:C,color:"cyan"})]}),$?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("div",{className:"w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"ë¡œë”© ì¤‘..."})]})}):e.jsx(E,{data:i,columns:R,emptyMessage:"í˜„ìž¬ ê²Œìž„ ì¤‘ì¸ ì‚¬ìš©ìžê°€ ì—†ìŠµë‹ˆë‹¤",rowKey:"session_id"}),e.jsx(K,{open:M,onOpenChange:p,children:e.jsxs(O,{children:[e.jsxs(U,{children:[e.jsx(z,{children:"ì„¸ì…˜ ê°•ì œ ì¢…ë£Œ"}),e.jsxs(W,{children:[f?.nickname,"ë‹˜ì˜ ê²Œìž„ ì„¸ì…˜ì„ ê°•ì œë¡œ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"]})]}),e.jsxs(G,{children:[e.jsx(x,{variant:"outline",onClick:()=>p(!1),children:"ì·¨ì†Œ"}),e.jsx(x,{variant:"destructive",onClick:q,children:"ì¢…ë£Œ"})]})]})})]})}export{ce as OnlineUsers};
